All SYN mumps routines for update
GT.M 05-MAR-2021 22:18:00
SYNBSTS1
SYNBSTS1 ;ven/gpl - fhir loader utilities ;2018-08-17  3:22 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
ICD9ROOT() ; returns the root of the snomed to icd9 graph
 n root s root=$$setroot^SYNWD("icd9tosnomed")
 q:root=""
 s root=$na(@root@("graph","icd9tosnomed.csv"))
 q root
 ;
ICD10ROOT() ; returns the root of the snomed to icd10 graph
 n root s root=$$setroot^SYNWD("sct2icd")
 s root=$na(@root@("graph","sct2icd"))
 q root
 ;
match ; try matching snomed codes between icd9 and icd10 graphs
 n zi,gicd9,gicd10
 s gicd9=$$ICD9ROOT
 s gicd10=$$ICD10ROOT
 s zi=0
 n cnt s cnt=0
 f  s zi=$o(@gicd9@(zi)) q:+zi=0  d  ;
 . q:'$d(@gicd9@(zi))
 . n sct,icd9,icd10
 . s sct=$g(@gicd9@(zi,"SNOMED"))
 . i sct="" d  q
 . . w !,"error, Snomed code not found ",zi," ",$g(@gicd9@(zi,"ICD9"))
 . s icd9=$g(@gicd9@(zi,"ICD9"))
 . i icd9="" d  q
 . . w !,"error, ICD9 code not found ",zi
 . n icd10dx
 . s icd10dx=$o(@gicd10@("ops",sct,"snomedCode",""))
 . i icd10dx="" d  q  ;
 . . w !,"error, snomed code not found in ICD10 graph ",zi," icd9= ",icd9
 . s icd10=$g(@gicd10@(icd10dx,"icd10code"))
 . i icd10="" d  q  ;
 . . w !,"error, icd10 code not found ",zi," icd9= ",icd9
 . i icd10["?" s icd10=$tr(icd10,"?","")
 . ;w !,"zi= ",zi," snomed= ",sct," icd10= ",icd10
 . s cnt=cnt+1
 w !,"count= ",cnt
 q
 ;
count ; count the unique snomed codes in the icd10 graph
 n sct,gicd9,gicd10
 s gicd9=$$ICD9ROOT
 s gicd10=$$ICD10ROOT
 s sct=""
 n cnt s cnt=0
 f  s sct=$o(@gicd10@("pos","snomedCode",sct)) q:sct=""  d  ;
 . s cnt=cnt+1
 w !,"count of snomed codes in icd10 graph= ",cnt
 q
 ;
matchbsts ; try matching snomed codes between icd9 and icd10 graphs and bsts
 n zi,gicd9,gicd10
 s gicd9=$$ICD9ROOT
 s gicd10=$$ICD10ROOT
 s zi=0
 n bsts9success,bsts10success,bstsSctSuccess,bstsSctError
 s (bsts9success,bsts10success,bstsSctSuccess,bstsSctError)=0
 n cnt s cnt=0
 f  s zi=$o(@gicd9@(zi)) q:+zi=0  d  ;
 . q:'$d(@gicd9@(zi))
 . n sct,icd9,icd10,bstsicd9,bstsicd10
 . s sct=$g(@gicd9@(zi,"SNOMED"))
 . i sct="" d  q
 . . w !,"error, Snomed code not found ",zi," ",$g(@gicd9@(zi,"ICD9"))
 . s icd9=$g(@gicd9@(zi,"ICD9"))
 . i icd9="" d  q
 . . w !,"error, ICD9 code not found ",zi
 . s bstsicd9=$$SCT2ICD9^C0TSUTL(sct)
 . i bstsicd9=-1 d  ;
 . . w !,"bsts_error, SCT code not found: ",sct
 . . s bstsSctError=bstsSctError+1
 . e  s bstsSctSuccess=bstsSctSuccess+1
 . i bstsicd9="" d  ;q
 . . w !,"bsts_error, ICD9 code not found ",zi," for SCT code ",sct
 . i bstsicd9>0 s bsts9success=bsts9success+1
 . n icd10dx
 . s icd10dx=$o(@gicd10@("ops",sct,"snomedCode",""))
 . i icd10dx="" d  q  ;
 . . w !,"error, snomed code not found in ICD10 graph ",zi," icd9= ",icd9
 . s icd10=$g(@gicd10@(icd10dx,"icd10code"))
 . i icd10="" d  ;q  ;
 . . w !,"error, icd10 code not found ",zi," icd9= ",icd9
 . i icd10["?" s icd10=$tr(icd10,"?","")
 . ;w !,"zi= ",zi," snomed= ",sct," icd10= ",icd10
 . s bstsicd10=$$SCT2ICD10^C0TSUTL(sct)
 . i bstsicd10=-1 d  ;
 . . w !,"bsts_error, SCT code not found: ",sct
 . . s bstsSctError=bstsSctError+1
 . i bstsicd10="" d  ;q
 . . w !,"bsts_error, ICD10 code not found ",zi," for SCT code ",sct," ",$$grsct2icd10(sct)
 . i $l(bstsicd10)>2 s bsts10success=bsts10success+1
 . s cnt=cnt+1
 w !,"count= ",cnt
 w !,"bsts ICD9 codes found: ",bsts9success
 w !,"bsts ICD10 codes found: ",bsts10success
 w !,"bsts SCT codes not found: ",bstsSctError
 w !,"bsts SCT codes found: ",bstsSctSuccess
 q
 ;
grsct2icd10(cde) ; extrinsic returns snomed to icd10 map from the graph
 ;
 q $$graphmap^SYNGRAPH("sct2icd",cde,"icd10code")
 ;
grsct2icd9(cde) ; extrinsic returns snomed to icd9 map from the graph
 ;
 q $$graphmap^SYNGRAPH("icd9tosnomed",cde,"ICD9")
 ;

SYNDHP01
SYNDHP01 ; HC/fjf/art - HealthConcourse - get patient vitals ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient vitals ------------------------------
 ;
PATVIT(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT,RETJSON) ; get vitals for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return patient vitals for name, SSN, DOB, and gender
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   FRDAT   - from date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
 ;   TODAT   - to date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists the vitals for a patient
 ;           - ICN^SCT code for vital|SCT description of vital|value of vital|date|resource id^...
 ;          or patient vitals in JSON format
 ;
 ;     note:resource identifier will be:
 ;             "V"_SITE ID_FILE #_FILE IEN   e.g. V_500_120.5_930
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 ;
 N ICNST
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 ; if we are here we are dealing with a valid patient
 N DHPIEN S DHPICN=$P(ICNST,U,3)
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 I PATIEN="" S RETSTA="-1^Patient ICN not found" QUIT
 ;
 N VARRAY
 S RETSTA=$$VITS(.VARRAY,PATIEN,DHPIEN,FRDAT,TODAT)
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.VARRAY,.RETSTA)
 ;
 QUIT
 ;
PATVITI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient vitals for ICN
 ;
 ; Return patient vitals for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
 ;   TODAT   - to date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists the vitals for a patient
 ;           - ICN^SCT code for vital|SCT description of vital|value of vital|date|resource id^...
 ;          or patient vitals in JSON format
 ;
 ;     note:resource identifier will be:
 ;             "V"_SITE ID_FILE #_FILE IEN   e.g. V_500_120.5_930
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N VARRAY
 S RETSTA=$$VITS(.VARRAY,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.VARRAY,.RETSTA)
 ;
 QUIT
 ;
VITS(PATVIT,PATIEN,DHPICN,FRDAT,TODAT) ; get vitals for a patient
 ; build the array of SNOMED CT codes that correspond to vitals
 ;
 N VITALS,VID,VTYPE,VOBS,VTIEN,VDATEFM,VDATE,SCT,SCTPT,VIT,ZARR
 N C S C=","
 N P S P="|"
 N S S S="_"
 N FN S FN=120.5
 ;
 ; scan vitals "C" index for IEN
 N VIEN S VIEN=""
 F  S VIEN=$O(^GMR(FN,"C",PATIEN,VIEN)) Q:VIEN=""  D
 . N VITALS
 . D GET1VITALS^SYNDHP16(.VITALS,VIEN,0)
 . I $D(VITALS("Vitals","ERROR")) M PATVIT("Vitals",VIEN)=VITALS QUIT
 . S VDATEFM=VITALS("Vitals","dateTimeVitalsTakenFM")
 . QUIT:((VDATEFM\1)<FRDAT)!((VDATEFM\1)>TODAT)  ;quit if outside of requested date range
 . QUIT:'$$RANGECK^SYNDHPUTL(VDATEFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . S VID=VITALS("Vitals","resourceId")
 . S VTYPE=VITALS("Vitals","vitalType")
 . S VOBS=VITALS("Vitals","rate")
 . S VTIEN=VITALS("Vitals","vitalTypeId")
 . S VDATE=VITALS("Vitals","dateTimeVitalsTakenHL7")
 . S SCT=VITALS("Vitals","vitalTypeSCT")
 . S SCTPT=$$SENTENCE^XLFSTR(VITALS("Vitals","vitalType"))
 . S ZARR(DHPICN,SCT,VIEN)=SCTPT_P_VOBS_P_VDATE_P_VID
 . M PATVIT("Vitals",VIEN)=VITALS ;
 ;
 ; serialize data
 S (SCT,VIEN)=""
 N VITALRTN S VITALRTN=DHPICN
 F  S SCT=$O(ZARR(DHPICN,SCT)) Q:SCT=""  D
 . F  S VIEN=$O(ZARR(DHPICN,SCT,VIEN)) Q:VIEN=""  D
 . . S VIT=ZARR(DHPICN,SCT,VIEN)
 . . S VITALRTN=VITALRTN_U_SCT_P_VIT
 ;
 Q VITALRTN
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="5000000211V385910"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATVITI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="5000000211V385910"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATVITI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="5000000211V385910"
 N FRDAT S FRDAT=20150220
 N TODAT S TODAT=20150223
 N JSON S JSON=""
 N RETSTA
 D PATVITI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT

SYNDHP02
SYNDHP02 ; HC/rbd/art - HealthConcourse - get patient immunization data ;07/26/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient immunizations information ------------------------------
 ;
PATIMMI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient immunizations for ICN
 ;
 ; Return patient immunizations for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists patient immunization information
 ;               Resource ID |Imm. Enc. Visit Dt | Imm. CVX Code | Imm. Description | Series Indicator ; Description |
 ;               Imm. Given Date  | Loc. of Enc. | Reaction Indicator ; Description | Imm. Provider
 ;          or patient immunizations in JSON format
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N IMMARR
 S RETSTA=$$IMMS(.IMMARR,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.IMMARR,.RETSTA)
 ;
 Q
 ;
IMMS(IMMARR,PATIEN,DHPICN,FRDAT,TODAT) ; get immunizations for a patient
 ;
 N C,P,S,HLFCTS,VSTDT,PTIMMIEN,IMMREC
 N PTIMMID,IMMDESC,LOCENC,SERIES,IMMGIVEN,REACTID,REACTION,IMMPROV,ZARR
 N SERIESID,VIEN
 S C=",",P="|",S="_"
 N FNUM S FNUM=9000010.11      ;  file
 ; scan PXRMINDX 9000010.11 "CVX" "PI" index for Immunizations
 ; Example of such an entry - ^PXRMINDX(9000010.11,"CVX","PI",69,109,3000425.113046,64)=""
 ;S DHPICN=PATIEN
 N IMCVXCOD S IMCVXCOD=""
 F  S IMCVXCOD=$O(^PXRMINDX(FNUM,"CVX","PI",PATIEN,IMCVXCOD)) Q:IMCVXCOD=""  D
 .S VSTDT=""
 .F  S VSTDT=$O(^PXRMINDX(FNUM,"CVX","PI",PATIEN,IMCVXCOD,VSTDT)) Q:VSTDT=""  D
 ..QUIT:'$$RANGECK^SYNDHPUTL(VSTDT,FRDAT,TODAT)  ;quit if outside of requested date range
 ..S PTIMMIEN=""
 ..F  S PTIMMIEN=$O(^PXRMINDX(FNUM,"CVX","PI",PATIEN,IMCVXCOD,VSTDT,PTIMMIEN)) Q:PTIMMIEN=""  D
 ...N IMMUNIZE
 ...D GET1IMMUN^SYNDHP12(.IMMUNIZE,PTIMMIEN,0)
 ...I $D(IMMUNIZE("Immunize","ERROR")) M IMMARR("Immunizations",PTIMMIEN)=IMMUNIZE QUIT
 ...S PTIMMID=IMMUNIZE("Immunize","resourceId")
 ...S IMMDESC=IMMUNIZE("Immunize","immunization")
 ...S VIEN=IMMUNIZE("Immunize","visitId")
 ...S LOCENC=IMMUNIZE("Immunize","location")
 ...S SERIES=IMMUNIZE("Immunize","series")
 ...S SERIESID=IMMUNIZE("Immunize","seriesCd")
 ...S IMMGIVEN=IMMUNIZE("Immunize","eventDateAndTimeHL7")
 ...S REACTID=IMMUNIZE("Immunize","reactionCd")
 ...S REACTION=IMMUNIZE("Immunize","reaction")
 ...S IMMPROV=IMMUNIZE("Immunize","encounterProvider")
 ...S IMMREC=PTIMMID_P_$$FMTHL7^XLFDT(VSTDT)_P_IMCVXCOD_P_IMMDESC_P_SERIESID_";"_SERIES_P_IMMGIVEN_P_LOCENC
 ...S IMMREC=IMMREC_P_REACTID_";"_REACTION_P_IMMPROV
 ...S ZARR(DHPICN,VSTDT,IMCVXCOD)=IMMREC
 ...M IMMARR("Immunizations",PTIMMIEN)=IMMUNIZE ;
 ;
 ; serialize data
 S VSTDT=""
 S HLFCTS=DHPICN
 F  S VSTDT=$O(ZARR(DHPICN,VSTDT)) Q:VSTDT=""  D
 .S IMCVXCOD="" F  S IMCVXCOD=$O(ZARR(DHPICN,VSTDT,IMCVXCOD)) Q:IMCVXCOD=""  D
 ..S IMMREC=ZARR(DHPICN,VSTDT,IMCVXCOD)
 ..S HLFCTS=HLFCTS_U_IMMREC
 ;
 Q HLFCTS
 ; for a given pt, returns Unique ID |Imm. Enc. Visit Dt | Imm. CVX Code | Imm. Description | Series Indicator ; Description |
 ;                            Imm. Given Date  | Loc. of Enc. | Reaction Indicator ; Description | Imm. Provider
 ;
 ;  Series can be:   'P' FOR PARTIALLY COMPLETE
 ;                   'C' FOR COMPLETE
 ;                   'B' FOR BOOSTER
 ;                   '1' FOR SERIES 1
 ;                   '2' FOR SERIES 2
 ;                   '3' FOR SERIES 3
 ;                   '4' FOR SERIES 4
 ;                   '5' FOR SERIES 5
 ;                   '6' FOR SERIES 6
 ;                   '7' FOR SERIES 7
 ;                   '8' FOR SERIES 8
 ;
 ;  Reactions can be:  '1' FOR FEVER
 ;                     '2' FOR IRRITABILITY;
 ;                     '3' FOR LOCAL REACTION OR SWELLING;
 ;                     '4' FOR VOMITING;
 ;                     '5' FOR RASH OR ITCHING;
 ;                     '6' FOR LETHARGY;
 ;                     '7' FOR CONVULSIONS;
 ;                     '8' FOR ARTHRITIS OR ARTHRALGIAS;
 ;                     '9' FOR ANAPHYLAXIS OR COLLAPSE;
 ;                     '10' FOR RESPIRATORY DISTRESS;
 ;                     '11' FOR OTHER;
 ;                     '0' FOR NONE;
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="10110V004877"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATIMMI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="10110V004877"
 N FRDAT S FRDAT=20130801
 N TODAT S TODAT=20140431
 N JSON S JSON=""
 N RETSTA
 D PATIMMI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="10110V004877"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATIMMI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP03
SYNDHP03 ; HC/rbd/art - HealthConcourse - get patient condition/problem data ;2019-11-04  5:54 PM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ; (c) 2017-2019 Perspecta
 ; (c) 2019 OSEHRA
 ; 
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 QUIT
 ;
 ;----------------  Get Patient Conditions  ----------------------
 ;
PATCONDS(RETSTA,NAME,SSN,DOB,GENDER) ; get condition SCT codes for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return list of active conditions (problems) for name, SSN, DOB, and gender
 ;   conditions without a SNOMED CT code are not be reported
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ; Output:
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for the patient conditions
 ;           - ICN^SCT code1^SCT code2^...^SCT coden
 ;
 N C,ACU,ICNST,DHPICN,PATIEN,SCT
 S C=","
 N SCTA
 ;
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST Q
 ; if we are here we are dealing with a valid patient
 S DHPICN=$P(ICNST,U,3)
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 S (ACU,SCT)=""
 F  S ACU=$O(^PXRMINDX(9000011,"SCT","PSPI",PATIEN,"A",ACU)) Q:ACU=""  D
 .F  S SCT=$O(^PXRMINDX(9000011,"SCT","PSPI",PATIEN,"A",ACU,SCT)) Q:SCT=""  D
 ..S SCTA(SCT)=""
 S RETSTA=DHPICN
 S SCT=""
 F  S SCT=$O(SCTA(SCT)) Q:SCT=""  S RETSTA=RETSTA_U_SCT
 Q
 ;
 ;
PATCONI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient conditions for ICN
 ;
 ; Return patient conditions (problems) for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDATE  - from date (inclusive), optional, compared to .13 DATE OF ONSET
 ;   TODATE  - to date (inclusive), optional, compared to .13 DATE OF ONSET
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists the following information
 ;      PatientICN ^ resourceId ^ DiagnosisCode ; DiagnosisName ; Coding System (ICD or 10D)^ DateOfOnset ^ SNOMED CT Code ; SNOMED CT Name ^ Status ^ Resolution Date ^ Condition Type (problem or encounter) |
 ;      and continue this for every diagnosis for a particular patient ICN
 ;    or patient conditions in JSON format
 ;
 ; ZEXCEPT: DEBUG,HTTPARGS,HTTPERR
 ;
 ; Filter validation
 ; Id (e.g. V-999-9000011-1805)
 N QID,QIDENC,QIDPROB
 I $D(HTTPARGS("_id")) D  I $G(HTTPERR) QUIT
 . S QID=HTTPARGS("_id")
 . N P2,P3,P4
 . S P2=$P(QID,"-",2)
 . S P3=$P(QID,"-",3)
 . S P4=$P(QID,"-",4)
 . N SITE S SITE=$$SITE^VASITE($$DT^XLFDT)
 . N STATION S STATION=$P(SITE,U,3)
 . I P2'=STATION D ERRMSG^SYNDHPUTL(400,"Condition not located at this site") QUIT
 . I P3'=9000011 D ERRMSG^SYNDHPUTL(400,"Only problems are now supported") QUIT
 . I '$D(^AUPNPROB(P4,0)) D ERRMSG^SYNDHPUTL(400,"No such problem exists in VistA") QUIT
 . S QIDPROB=P4
 . N DFN S DFN=$P(^AUPNPROB(P4,0),U,2)
 . S DHPICN=$$GETICN^MPIF001(DFN) ; ICR 2701
 ;
 ; ICN
 I $G(DHPICN)="",$D(HTTPARGS("patient")) S DHPICN=HTTPARGS("patient")
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 ; Category
 ; problem-list-item | encounter-diagnosis
 N QCATEGORY
 I $D(HTTPARGS("category")) D  I $G(HTTPERR) QUIT
 . S QCATEGORY=HTTPARGS("category")
 . I QCATEGORY["|" S QCATEGORY=$P(QCATEGORY,"|",2)
 . I QCATEGORY'["problem",QCATEGORY'["encounter" D ERRMSG^SYNDHPUTL(400,"Invalid Category") QUIT
 ;
 ; Clinical Status
 ; active | recurrence | inactive | remission | resolved
 N QCLINSTATUS
 I $D(HTTPARGS("clinical-status")) D  I $G(HTTPERR) QUIT
 . S QCLINSTATUS=HTTPARGS("clinical-status")
 . I QCLINSTATUS["|" S QCLINSTATUS=$P(QCLINSTATUS,"|",2)
 . I "^active^recurrence^inactive^remission^resolved^"'[(U_QCLINSTATUS_U) D ERRMSG^SYNDHPUTL(400,"Invalid Clinical Status") QUIT
 . ; VistA does not have recurrence and remission, so we will switch these to active and resolved.
 . I QCLINSTATUS="recurrence" S QCLINSTATUS="active"
 . I QCLINSTATUS="remission"  S QCLINSTATUS="resolved"
 . S QCLINSTATUS=$$UP^XLFSTR(QCLINSTATUS) ; Active and inactive are uppercased in VistA
 ;
 ; Code
 N QCODE,QCODETYPE
 I $D(HTTPARGS("code")) D
 . S QCODE=HTTPARGS("code")
 . I QCODE["|" D
 .. N TYPEURL S TYPEURL=$P(QCODE,"|"),QCODE=$P(QCODE,"|",2)
 .. I TYPEURL["sct" S QCODETYPE="SCT"
 .. I TYPEURL["icd" S QCODETYPE="ICD"
 ;
 ; Onset
 N QONSET
 N QONSETREV S QONSETREV=0 ; Reverse condition
 I $D(HTTPARGS("onset-date")) D  I $G(HTTPERR) QUIT
 . S QONSET=HTTPARGS("onset-date")
 . D SETFRTO^SYNDHPUTL(QONSET,.FRDAT,.TODAT,.QONSETREV)
 ;
 N C,P,S
 S C=",",P="|",S=";"
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I $G(DEBUG) W "PATIEN: ",PATIEN,!
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETSTA=DHPICN
 N RETDESC S RETDESC=""
 ;
 N CONDITION,DIAGC,DIAGN,DIGNCS,ONSET,DONSET,SNOMEDC,SNOMEDN,IDENT,CONTYPE
 N ENCONLY S ENCONLY=0         ; Encounter only conditions
 I $D(QCATEGORY),QCATEGORY'["problem" S ENCONLY=1  ; Don't go through problem list if we want only encounters
 ;
 N PROBIEN S PROBIEN=""
 ; QIDPROB: If we requested a problem by IEN, backtrack and loop to itself, then quit
 I $D(QIDPROB) S PROBIEN=QIDPROB-.0000001
 ; ENCONLY = Encounter only
 I 'ENCONLY F  S PROBIEN=$O(^AUPNPROB("AC",PATIEN,PROBIEN)) Q:PROBIEN=""  D  Q:$D(QIDPROB)
 . N PROBLEM
 . D GET1PROB^SYNDHP11(.PROBLEM,PROBIEN,0) ;get one Patient Problem (Condition) record
 . I $D(PROBLEM("Problem","ERROR")) M CONDITION("Conditions",PROBIEN)=PROBLEM QUIT
 . S ONSET=PROBLEM("Problem","dateOfOnsetFM")
 . S DIAGC=PROBLEM("Problem","diagnosis")
 . S DIAGN=PROBLEM("Problem","diagnosisText")
 . S DIGNCS=PROBLEM("Problem","codingSystem")
 . S DONSET=PROBLEM("Problem","dateOfOnsetHL7")  ;date of onset set to HL7 format
 . S SNOMEDC=PROBLEM("Problem","snomedCTconceptCode")
 . S SNOMEDN=PROBLEM("Problem","snomedCTconceptCodeText")
 . S IDENT=PROBLEM("Problem","resourceId")
 . N STATUS S STATUS=PROBLEM("Problem","status")
 . N RESDT  S RESDT=PROBLEM("Problem","dateResolvedHL7")
 . I RESDT  S STATUS="RESOLVED"
 . N CONTYPE S CONTYPE="problem" ; or (future enhancement) encounter
 . ;
 . ; Filters
 . I $G(SYNDEBUG),$D(QONSET) W QONSET," ",ONSET," ",FRDAT," ",TODAT
 . I $D(QONSET),'ONSET QUIT  ; Onset filter but no onset date
 . I $D(QONSET),'$$RANGECK^SYNDHPUTL(ONSET,FRDAT,TODAT,QONSETREV) QUIT  ;quit if outside of requested date range
 . I $D(QCLINSTATUS),QCLINSTATUS'=STATUS QUIT
 . I $D(QCODE) N QUIT S QUIT=0 D  QUIT:QUIT
 .. N SCTMATCH S SCTMATCH=QCODE=SNOMEDC
 .. N ICDMATCH S ICDMATCH=QCODE=DIAGC
 .. I $D(QCODETYPE),QCODETYPE="SCT",'SCTMATCH S QUIT=1
 .. I $D(QCODETYPE),QCODETYPE="ICD",'ICDMATCH S QUIT=1
 .. I 'SCTMATCH,'ICDMATCH S QUIT=1
 . ; End filters
 . ;
 . ; Output
 . S RETDESC=RETDESC_IDENT_U_DIAGC_S_DIAGN_S_DIGNCS_U_DONSET_U_SNOMEDC_S_SNOMEDN_U_STATUS_U_RESDT_U_CONTYPE_P
 . M CONDITION("Conditions",PROBIEN)=PROBLEM
 S RETSTA=RETSTA_U_RETDESC
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.CONDITION,.RETSTA)
 ;
 QUIT
 ;
 ;  ----------------  Patients for a given active condition  --------------
 ;
PATCONAL(RETSTA,DHPSCT,RETJSON) ; Patients for a given active condition
 ;
 ; Return list of all patients who have a particular active condition (problem)
 ;
 ; Input:
 ;   DHPSCT - SNOMED CT code  (mandatory)
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for active  patient conditions
 ;           - SCT^ICN 1|patient name 1^ICN 2|patient name 2^...^ICN n|patient name n
 ;           - -1 - error
 ;          or patients with a condition in JSON format
 ;
 ; validate SNOMED CT code
 I $G(DHPSCT)="" S RETSTA="-1^What code?" QUIT
 I +$$CODE^LEXTRAN(DHPSCT,"SCT")'=1 S RETSTA="-1^SNOMED CT code not recognised" Q
 ;
 S SCTPF=$$USCTPT^SYNDHPUTL(DHPSCT) ;lookup preferred term for code
 N C,ACU,P,PATA,PATIEN,PAT,PATSWCON
 S C=",",P="|"
 S ACU=""
 F  S ACU=$O(^PXRMINDX(9000011,"SCT","ISPP",DHPSCT,"A",ACU)) Q:ACU=""  D
 . S PATIEN=""
 . F  S PATIEN=$O(^PXRMINDX(9000011,"SCT","ISPP",DHPSCT,"A",ACU,PATIEN)) Q:PATIEN=""  D
 . . S PATA($$UICN^SYNDHPUTL(PATIEN))=$$GET1^DIQ(2,PATIEN_C,.01)
 . . I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . . . S PATSWCON("Patients",PATIEN,"patientName")=$$GET1^DIQ(2,PATIEN_C,.01)
 . . . S PATSWCON("Patients",PATIEN,"patientIcn")=$$UICN^SYNDHPUTL(PATIEN)
 . . . S PATSWCON("Patients",PATIEN,"patientId")=PATIEN
 . . . S PATSWCON("Patients",PATIEN,"conditionSCT")=DHPSCT
 . . . S PATSWCON("Patients",PATIEN,"conditionText")=SCTPF
 S RETSTA=DHPSCT
 S PAT=""
 F  S PAT=$O(PATA(PAT)) Q:PAT=""  D
 . S RETSTA=RETSTA_U_PAT_P_PATA(PAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.PATSWCON,.RETSTA)
 ;
 Q
 ;
 ; ----------- Unit Test -----------
TEST D EN^%ut($T(+0),3) QUIT
STARTUP ; [Constants]. Modify to suit your system so tests would pass.
 S ICN="2421492932V802082"
 S CODEICD="B00.2"
 S CODESCT="22298006"
 S YEAR1=2001
 S YEAR2=2000
 S YEAR3=2002
 S YEAR4=2011
 S YEARMO1="2012-05"
 S YEARMO2="2012-06"
 S YMD1="2012-01-12"
 S YMD2="1982-01-12"
 S ID1="V-999-9000011-1807"
 QUIT
SHUTDOWN K ICN,CODEICD,CODESCT QUIT
SETUP    K HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS QUIT
TEARDOWN K HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS QUIT
 ;
T1 ; @TEST Get All Problems for single patient
 D PATCONI(.RETSTA,ICN)
 N I F I=1:1:$L(RETSTA,"|") W $P(RETSTA,"|",I),!
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKTF^%ut($L(RETSTA,"|"))
 QUIT
 ;
T111 ; @TEST Get All Problems for single patient in category problem
 S HTTPARGS("category")="problem-list-item"
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I F I=1:1:$L(RETSTA,"|") W $P(RETSTA,"|",I),!
 D CHKTF^%ut($L(RETSTA,"|"))
 QUIT
 ;
T112 ; @TEST Get All Problems for single patient in category encounter
 S HTTPARGS("category")="encounter-diagnosis"
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKTF^%ut($L(RETSTA,"|")=1)
 QUIT
 ;
T113 ; @TEST Get All Problems for single patient in invalid category
 S HTTPARGS("category")="boo"
 D PATCONI(.RETSTA,ICN)
 D CHKTF^%ut(HTTPERR=400)
 QUIT
 ;
 ; "^active^recurrence^inactive^remission^resolved^"
T114 ; @TEST All Problem for single patient with clinical status active
 S HTTPARGS("clinical-status")="active"
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I F I=1:1:$L(RETSTA,"|") I $P(RETSTA,"|",I)'="" D CHKEQ^%ut($P($P(RETSTA,"|",I),U,5),"ACTIVE")
 D CHKTF^%ut($L(RETSTA,"|"))
 QUIT
 ;
T115 ; @TEST All Problem for single patient with clinical status inactive
 S HTTPARGS("clinical-status")="inactive"
 D PATCONI(.RETSTA,ICN)
 ; Adjust output so we can walk through it, as ICN is first piece, then the problem string
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I F I=1:1:$L(RETSTA,"|") I $P(RETSTA,"|",I)'="" D CHKEQ^%ut($P($P(RETSTA,"|",I),U,5),"INACTIVE")
 D CHKTF^%ut($L(RETSTA,"|"))
 QUIT
 ;
T116 ; @TEST All Problem for single patient with clinical status resolved
 S HTTPARGS("clinical-status")="resolved"
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I F I=1:1:$L(RETSTA,"|") I $P(RETSTA,"|",I)'="" D CHKEQ^%ut($P($P(RETSTA,"|",I),U,5),"RESOLVED")
 D CHKTF^%ut($L(RETSTA,"|"))
 QUIT
 ;
T117 ; @TEST All Problem for single patient with invalid clinical status
 S HTTPARGS("clinical-status")="boo"
 D PATCONI(.RETSTA,ICN)
 D CHKTF^%ut(HTTPERR=400)
 QUIT
 ;
T118 ; @TEST Single problem by Code - SCT
 S HTTPARGS("code")=CODESCT
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKTF^%ut(RETSTA[CODESCT)
 D CHKTF^%ut(RETSTA'[CODEICD)
 QUIT
 ;
T1181 ; @TEST Single problem by Coding Sytem | Code - SCT
 S HTTPARGS("code")="sct|"_CODESCT
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKTF^%ut(RETSTA[CODESCT)
 D CHKTF^%ut(RETSTA'[CODEICD)
 QUIT
 ;
T119 ; @TEST Single problem by Code - ICD
 S HTTPARGS("code")=CODEICD
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKTF^%ut(RETSTA[CODEICD)
 D CHKTF^%ut(RETSTA'[CODESCT)
 QUIT
 ;
T120 ; !TEST problem by inexact date - year
 S HTTPARGS("onset-date")=YEAR1
 N DATE
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(DATE[HTTPARGS("onset-date"))
 ;
 S HTTPARGS("onset-date")=YEAR2
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKEQ^%ut(RETSTA,"")
 ;
 S HTTPARGS("onset-date")=YEAR3
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKEQ^%ut(RETSTA,"")
 ;
 S HTTPARGS("onset-date")=YEAR4
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(DATE[HTTPARGS("onset-date"))
 QUIT
 ;
T121 ; @TEST problem by inexact date - year/month
 S HTTPARGS("onset-date")=YEARMO1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(DATE[$TR(HTTPARGS("onset-date"),"-"))
 S HTTPARGS("onset-date")=YEARMO2
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKEQ^%ut(RETSTA,"")
 QUIT
 ;
T122 ; @TEST problem by exact date
 S HTTPARGS("onset-date")=YMD1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(DATE[$TR(HTTPARGS("onset-date"),"-"))
 S HTTPARGS("onset-date")=YMD2
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKEQ^%ut(RETSTA,"")
 QUIT
 ;
T123 ; @TEST problem by eqdate
 S HTTPARGS("onset-date")="eq"_YMD1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(DATE[$tr(YMD1,"-"))
 QUIT
 ;
T124 ; @TEST problem by nedate
 S HTTPARGS("onset-date")="ne"_YMD1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(DATE'[$tr(YMD1,"-"))
 QUIT
 ;
T125 ; @TEST problem by ltdate
 S HTTPARGS("onset-date")="lt"_YMD1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(($e(DATE,1,8))<$tr(YMD1,"-"))
 QUIT
 ;
T126 ; @TEST problem by gtdate
 S HTTPARGS("onset-date")="gt"_YMD1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(($e(DATE,1,8))>$tr(YMD1,"-"))
 QUIT
 ;
T127 ; @TEST problem by ledate
 S HTTPARGS("onset-date")="le"_YMD1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(($e(DATE,1,8))'>$tr(YMD1,"-"))
 QUIT
 ;
T128 ; @TEST problem by gedate
 S HTTPARGS("onset-date")="ge"_YMD1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 N I,E F I=1:1:$L(RETSTA,"|") S E=$P(RETSTA,"|",I) I E'="" S DATE=$P(E,"^",3) d tf^%ut(($e(DATE,1,8))'<$tr(YMD1,"-"))
 QUIT
 ;
T131 ; @TEST problem by apdate
 S HTTPARGS("onset-date")="ap2012-01"
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKTF^%ut($L(RETSTA,"|"))
 QUIT
 ;
T132 ; @TEST problem by _id
 S HTTPARGS("_id")=ID1
 D PATCONI(.RETSTA,ICN)
 S RETSTA=$E(RETSTA,$F(RETSTA,U),$L(RETSTA))
 D CHKTF^%ut($L(RETSTA,"|"))
 QUIT
 ;
T2 ;
 N ICN S ICN="10112V399621"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATCONI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T6 ;
 N ICN S ICN="10112V399621"
 N FRDAT S FRDAT=20000101
 N TODAT S TODAT=20051231
 N RETSTA
 D PATCONI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T7 ;
 N ICN S ICN="10112V399621"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATCONI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N SNOMED S SNOMED=10509002
 N RETSTA
 D PATCONAL(.RETSTA,SNOMED)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T4 ;
 N SNOMED S SNOMED=47505003
 N RETSTA
 D PATCONAL(.RETSTA,SNOMED)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T5 ;
 N SNOMED S SNOMED=47505003
 N JSON S JSON="J"
 N RETSTA
 D PATCONAL(.RETSTA,SNOMED,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP04
SYNDHP04 ; HC/fjf/art - HealthConcourse - retrieve patient procedures ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient procedures ----------------------
 ;
PATPRC(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT) ; get procedures for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return patient procedures for name, SSN, DOB, and gender
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   FRDATE  - from date (inclusive), optional
 ;   TODATE  - to date (inclusive), optional
 ; Output:
 ;   RETSTA  - a delimited string that lists SNOMED CT codes for the patient procedures
 ;           - ICN^SCT code|description|CPT code|date|identifier^...
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 ;
 N C,P,S,ZARR,ICNST,DHPICN,PATIEN
 ;
 S C=",",P="|",S="_"
 N USER S USER=$$DUZ^SYNDHP69
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 ; if we are here we are dealing with a valid patient
 S DHPICN=$P(ICNST,U,3)
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Patient ICN not found" QUIT
 ;
 S RETSTA=DHPICN
 ;
 ;Surgical Procedures
 S RETSTA=RETSTA_$$SRPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
 ;
 ;Visit Procedures
 S RETSTA=RETSTA_$$VSTPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
 ;
 ;Radiology Procedures
 S RETSTA=RETSTA_$$RADPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
 ;
 QUIT
 ;
 ; ---------------- Get patient procedures ----------------------
 ;
PATPRCI(RETSTA,DHPICN,FRDAT,TODAT) ; Patient procedures for ICN
 ;
 ; Return patient procedures for a given patient ICN
 ;  currently returns:
 ;    -Surgical
 ;    -Visit (V CPT)
 ;    -Radiology
 ;
 ; Input:
 ;   DHPICN  - unique patient identifier across all VistA systems
 ;   FRDATE  - from date (inclusive), optional
 ;   TODATE  - to date (inclusive), optional
 ; Output:
 ;   RETSTA  - a delimited string that lists SNOMED CT codes for the patient procedures
 ;           - ICN^SCT code|description|CPT code|date|identifier^...
 ;
 ; bypass for CQM
 ;
 ; ***********
 ; *********** Important Note for open source community
 ; ***********
 ; *********** Perspecta - who developed this source code and have released it to the open source
 ; *********** need the following six lines to remain intact
 ;
 I DHPICN="1899632336V236254" D  QUIT
 .S RETSTA="1899632336V236254^71388002|Mammogram|77056|20170101|442_130_101"
 ;I DHPICN="2495309561V670720" D  QUIT
 ;.S RETSTA="2495309561V670720^24165007|Alcohol Counseling and Treatment||20170101|442_130_101"
 ;
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to
 ; *********** be determined by Perspecta
 ; ***********
 ; *********** End of Important Note for open source community
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 N C,P,S,PATIEN
 S C=",",P="|",S="_"
 N USER S USER=$$DUZ^SYNDHP69
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETSTA=DHPICN
 ;
 ;Surgical Procedures
 S RETSTA=RETSTA_$$SRPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
 ;
 ;Visit Procedures
 S RETSTA=RETSTA_$$VSTPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
 ;
 ;Radiology Procedures
 S RETSTA=RETSTA_$$RADPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
 ;
 QUIT
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="5000000107V310212"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATPRCI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="5000000107V310212"
 N FRDAT S FRDAT=19980101
 N TODAT S TODAT=19981231
 N RETSTA
 D PATPRCI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP05
SYNDHP05 ; HC/fjf/art - HealthConcourse - retrieve patient diagnostic reports ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Patient diagnostic reports ----------------------
 ;
PATDXRI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient diagnostic report for ICN
 ;
 ; Return patient diagnostic report for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional
 ;   TODAT   - to date (inclusive), optional
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return diagnostic report string (default)
 ; Output:
 ;   RETSTA  - ICN^"IMG"|status|dateTime|provider|identifier|CPT|SCT|desc|primary dx|dx SCT|conclusion^...
 ;                ^"MHDX"|status|dateTime|provider|identifier|diag code|SCT|decription^...
 ;                ^"VISIT"|status|dateTime|provider|identifier|ICD|SCT|diag desc^...
 ;          or patient diagnostic report data in JSON format
 ;
 ; bypass for CQM
 ;
 ; ***********
 ; *********** Important Note for open source community
 ; ***********
 ; *********** Perspecta - who developed this source code and have released it to the open source
 ; *********** need the following six lines to remain intact
 ;
 I DHPICN="2608649748V030771" D  QUIT
 . S RETSTA="2608649748V030771^IMG|final|20170101|PROVIDER,ONE|V_500_74_608|44388||Colon Endoscopy||| there are no previous colonoscopy."
 . S RETSTA=RETSTA_" Impression: There is no definite colonoscopic evidence of malignancy.2. Comparison to previous colonoscopy would be helpful to assure stability."
 ;
 I DHPICN="2627244030V292232" D  QUIT
 . S RETSTA="2627244030V292232^IMG|final|20170101|PROVIDER,ONE|V_500_74_608|88147||Cytopath C/V Automated||| there are no previous cervical cancer screening report."
 . S RETSTA=RETSTA_" Impression: There is no definite CCS evidence of malignancy.2. Comparison to previous CCS would be helpful to assure stability."
 ;
 I DHPICN="1686299845V246594" D  QUIT
 . S RETSTA="1686299845V246594^MHDX|final|20170101|PROVIDER,ONE|V_500_74_608|F32.0|70747007|Major depressive disorder, single episode, mild"
 ;
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to
 ; *********** be determined by Perspecta
 ; ***********
 ; *********** End of Important Note for open source community
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 N C,P,PATIEN
 ;
 N USER S USER=$$DUZ^SYNDHP69
 S C=",",P="|"
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETSTA=DHPICN
 ;
 N DXRPTS
 ;Radology Diagnosis
 N DXARRAY,RETVAL
 S RETVAL=$$DXRAD(.DXARRAY,PATIEN,FRDAT,TODAT)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . M DXRPTS=DXARRAY
 E  D
 . S RETSTA=RETSTA_RETVAL
 ;
 ;Mental Health Diagnosis
 N DXARRAY,RETVAL
 S RETVAL=$$DXMH(.DXARRAY,PATIEN,FRDAT,TODAT)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . M DXRPTS=DXARRAY
 E  D
 . S RETSTA=RETSTA_RETVAL
 ;
 ;Visit Diagnosis
 N DXARRAY,RETVAL
 S RETVAL=$$DXVISIT(.DXARRAY,PATIEN,FRDAT,TODAT)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . M DXRPTS=DXARRAY
 E  D
 . S RETSTA=RETSTA_RETVAL
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.DXRPTS,.RETSTA)
 ;
 QUIT
 ;
DXRAD(DXRPTRAD,PATIEN,FRDAT,TODAT) ; get radiology diagnostic report
 ;
 N SEQ S SEQ=0
 N DXRRAD S DXRRAD=""
 I $G(DEBUG) W !,"Radiology Diagnoses",!
 N RADEX
 D RADEXAM^SYNDHP55(.RADEX,PATIEN,1,FRDAT,TODAT)
 ;             1      2        3       4            5            6         7        8     9     10     11                 12      13        14        15       16          17
 ; RADEX(SEQ)=PID_U_PatDfn_U_CatEx_U_ExamDate_U_ExamDateHl7_U_caseNbr_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_primaryDiagnosis_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL_U_EnteringUser
 ;               1     2        3         4        5         6               7                        8
 ; RADEX(SEQ,1)=PID^dayCase^dateTime^dateTimeHL7^status id^status^verifying physician id^verifying physician name
 ; RADEX(SEQ,"REPORT")=report
 ; RADEX(SEQ,"IMPRESSION")=impression
 ;
 D BLDARRAY(.RADEX,.DXRPTRAD)
 ;
 N PRSTA,PDATE,PDATEHL,PPROV,PID,PRCPT,SCT,DESC,PRIMEDX,DXSCT,TEXT
 N IDX S IDX=""
 F  S IDX=$O(RADEX(IDX)) QUIT:IDX=""  D
 . QUIT:'$D(RADEX(IDX,1))  ;there is no rad diag rpt for this exam
 . S PRSTA="final" ;status
 . S PDATE=$P($G(RADEX(IDX,1)),U,3) ;exam date (FM)
 . QUIT:'$$RANGECK^SYNDHPUTL(PDATE,FRDAT,TODAT)  ;quit if outside of requested date range
 . S PDATEHL=$P($G(RADEX(IDX,1)),U,4) ;exam date (HL7)
 . S PPROV=$P($G(RADEX(IDX,1)),U,8) ;verifying provider
 . S PID=$P($G(RADEX(IDX,1)),U,1) ;resource id
 . S PRCPT=$P($G(RADEX(IDX)),U,9) ;procedure cpt
 . S SCT=$P($G(RADEX(IDX)),U,10) ;procedure sct
 . S DESC=$P($G(RADEX(IDX)),U,8) ;procedure desc
 . S PRIMEDX=$P($G(RADEX(IDX)),U,11) ;primary diagnosis
 . S DXSCT="" ;                              <<<<<<<<<<<<<<<< rad diagnoses are text, no associated SCT
 . S TEXT=$G(RADEX(IDX,"REPORT"))
 . S DXRRAD=DXRRAD_U_"IMG"_P_PRSTA_P_PDATEHL_P_PPROV_P_PID_P_PRCPT_P_SCT_P_DESC_P_PRIMEDX_P_DXSCT_P_TEXT
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("DXRRAD")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("DXRPTRAD")
 ;
 QUIT DXRRAD
 ;   RETSTA  - ICN^"IMG"|status|dateTime|provider|identifier|CPT|SCT|desc|primary dx|dx SCT|conclusion^...
 ;
BLDARRAY(RADEX,DXRPTRAD) ;Build an array from data returned by RADEXAM^SYNDHP55
 ;
 ;             1      2        3          4            5            6         7        8     9     10     11                 12      13        14        15       16           17
 ; RADEX(SEQ)=PID_U_PatDfn_U_Category_U_ExamDate_U_ExamDateHl7_U_caseNbr_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_primaryDiagnosis_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL_U_EnteringUser
 ;               1     2        3         4        5         6               7                        8
 ; RADEX(SEQ,1)=PID^dayCase^dateTime^dateTimeHL7^status id^status^verifying physician id^verifying physician name
 ; RADEX(SEQ,"REPORT")=report
 ; RADEX(SEQ,"IMPRESSION")=impression
 ;
 N IDX S IDX=""
 F  S IDX=$O(RADEX(IDX)) QUIT:IDX=""  D
 . QUIT:'$D(RADEX(IDX,1))  ;there is no rad diag rpt for this exam
 . S PDATE=$P($G(RADEX(IDX,1)),U,3) ;exam date (FM)
 . QUIT:'$$RANGECK^SYNDHPUTL(PDATE,FRDAT,TODAT)  ;quit if outside of requested date range
 . N RADEXAM S RADEXAM=$NA(DXRPTRAD("DxReportRad",IDX,"RadExam"))
 . S @RADEXAM@("resourceType")="DiagnosticReport"
 . S @RADEXAM@("resourceId")=$P($G(RADEX(IDX)),U,1)
 . S @RADEXAM@("status")="final"
 . S @RADEXAM@("patientId")=$P($G(RADEX(IDX)),U,2)
 . S @RADEXAM@("category")=$P($G(RADEX(IDX)),U,3)
 . S @RADEXAM@("ExamDateFM")=$P($G(RADEX(IDX)),U,4)
 . S @RADEXAM@("ExamDateHL7")=$P($G(RADEX(IDX)),U,5)
 . S @RADEXAM@("ExamDateFHIR")=$$FMTFHIR^SYNDHPUTL($P($G(RADEX(IDX)),U,4))
 . S @RADEXAM@("caseNbr")=$P($G(RADEX(IDX)),U,6)
 . S @RADEXAM@("procedureId")=$P($G(RADEX(IDX)),U,7)
 . S @RADEXAM@("procedure")=$P($G(RADEX(IDX)),U,8)
 . S @RADEXAM@("procedureCPT")=$P($G(RADEX(IDX)),U,9)
 . S @RADEXAM@("procedureSCT")=$P($G(RADEX(IDX)),U,10)
 . S @RADEXAM@("primaryDiagnosis")=$P($G(RADEX(IDX)),U,11)
 . S @RADEXAM@("primaryDiagnosisSCT")="" ;           <<<<<<<<<<<<<<<<<no icd to map
 . S @RADEXAM@("requestingPhysician")=$P($G(RADEX(IDX)),U,12)
 . S @RADEXAM@("primaryInterpretingResident")=$P($G(RADEX(IDX)),U,13)
 . S @RADEXAM@("primaryInterpretingStaff")=$P($G(RADEX(IDX)),U,14)
 . S @RADEXAM@("visitDateFM")=$P($G(RADEX(IDX)),U,15)
 . S @RADEXAM@("visitDateHL7")=$P($G(RADEX(IDX)),U,16)
 . S @RADEXAM@("visitDateFHIR")=$$FMTFHIR^SYNDHPUTL($P($G(RADEX(IDX)),U,15))
 . S @RADEXAM@("EnteringUser")=$P($G(RADEX(IDX)),U,17)
 . N RADRPT S RADRPT=$NA(DXRPTRAD("DxReportRad",IDX,"RadReport"))
 . S @RADRPT@("resourceId")=$P($G(RADEX(IDX,1)),U,1)
 . S @RADRPT@("dayCase")=$P($G(RADEX(IDX,1)),U,2)
 . S @RADRPT@("dateTimeFM")=$P($G(RADEX(IDX,1)),U,3)
 . S @RADRPT@("dateTimeHL7")=$P($G(RADEX(IDX,1)),U,4)
 . S @RADRPT@("dateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($P($G(RADEX(IDX,1)),U,3))
 . S @RADRPT@("statusId")=$P($G(RADEX(IDX,1)),U,5)
 . S @RADRPT@("status")=$P($G(RADEX(IDX,1)),U,6)
 . S @RADRPT@("verifyingPhysicianId")=$P($G(RADEX(IDX,1)),U,7)
 . S @RADRPT@("verifyingPhysicianName")=$P($G(RADEX(IDX,1)),U,8)
 . S @RADRPT@("conclusion")=$G(RADEX(IDX,"REPORT"))
 . S @RADRPT@("impression")=$G(RADEX(IDX,"IMPRESSION"))
 ;
 QUIT
 ;$$FMTFHIR^SYNDHPUTL(
DXMH(DXRPTMH,PATIEN,FRDAT,TODAT) ;get Mental Health Diagnosis
 ;
 N MHDXRS,SERMHDXRS,MHIEN,IENS,MAPPING
 N STATUS,DXDTFM,DXDTHL,DXBY,PID,STATUS,DXCODE,SDESC
 ;
 N SNOMED S SNOMED=""
 N S,P
 S S="_",P="|"
 ;
 I $G(DEBUG) W !,"Mental Health Diagnosis",!
 N MHDXRS S MHDXRS=""
 N FNBR1 S FNBR1=627.8 ;Diagnostic Results-Mental Health
 N SEQ S SEQ=0
 ;
 S MHIEN=""
 F  S MHIEN=$O(^YSD(627.8,"C",PATIEN,MHIEN)) QUIT:MHIEN=""  D
 . S IENS=MHIEN_","
 . S DXCODE=$$GET1^DIQ(FNBR1,IENS,1) ;diagnosis
 . QUIT:DXCODE=""
 . N DXMH
 . D GET1MHDX^SYNDHP17(.DXMH,MHIEN,0)
 . QUIT:$D(DXMH("Mhdiag","ERROR"))
 . I $D(DXMH("Mhdiag","ERROR")) M DXRPTMH("DxReportMH",MHIEN)=DXMH QUIT
 . I $G(DEBUG) W $$ZW^SYNDHPUTL("DXMH")
 . S DXDTFM=DXMH("Mhdiag","dateTimeOfDiagnosisFM") ;date/time of diagnosis fm format
 . QUIT:'$$RANGECK^SYNDHPUTL(DXDTFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . S DXDTHL=DXMH("Mhdiag","dateTimeOfDiagnosisHL7") ;hl7 format date/time of diagnosis
 . S DXBY=DXMH("Mhdiag","diagnosisBy") ;diagnosed by
 . S DXCODE=DXMH("Mhdiag","diagnosis") ;diagnosis
 . S SDESC=$P($$ICDDX^ICDEX(DXCODE),U,4)
 . S STATUS=$$LOW^XLFSTR(DXMH("Mhdiag","statusVPRINRu")) ;status
 . S PID=DXMH("Mhdiag","resourceId")
 . S SNOMED=DXMH("Mhdiag","diagnosisSCT")
 . ;
 . ;^category|status|dateTime|provider|identifier|diag code|SCT|diag desc^...
 . S SEQ=SEQ+1
 . S MHDXRS(SEQ)=U_"MHDX"_P_STATUS_P_DXDTHL_P_DXBY_P_PID_P_DXCODE_P_SNOMED_P_SDESC
 . M DXRPTMH("DxReportMH",MHIEN)=DXMH ;
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHDXRS")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("DXRPTMH")
 ;
 ;serialize data
 S SERMHDXRS=""
 S SEQ=""
 F  S SEQ=$O(MHDXRS(SEQ)) QUIT:SEQ=""  D
 . S SERMHDXRS=SERMHDXRS_MHDXRS(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SERMHDXRS")
 ;
 QUIT SERMHDXRS
 ;
DXVISIT(DXRPTV,PATIEN,FRDAT,TODAT) ; get visit diagnostic report
 ;
 N STATUS,DXDTHL,PROV,SERPOV,RESID,DXCODE,SNOMED,SDESC,MAPPING,SNOMED
 N SEQ S SEQ=0
 N DXVISIT S DXVISIT=""
 I $G(DEBUG) W !,"Visit Diagnosis",!
 ;patient - ^AUPNVPOV("C",
 N POVIEN S POVIEN=""
 F  S POVIEN=$O(^AUPNVPOV("C",PATIEN,POVIEN)) QUIT:POVIEN=""  D
 . N VPOV
 . D GET1VPOV^SYNDHP13(.VPOV,POVIEN,0)
 . I $D(VPOV("V POV","ERROR")) M DXRPTV("DxReportVisit",POVIEN)=VPOV QUIT
 . S VPOV("V POV","resourceType")="DiagnosticReport"
 . S STATUS="final"
 . S DXDTFM=VPOV("V POV","visitFM")
 . QUIT:'$$RANGECK^SYNDHPUTL(DXDTFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . S DXDTHL=VPOV("V POV","visitHL7")
 . S PROV=VPOV("V POV","encounterProvider")
 . S RESID=VPOV("V POV","resourceId")
 . S DXCODE=VPOV("V POV","pov")
 . S SDESC=$P($$ICDDX^ICDEX(DXCODE),U,4)
 . S SNOMED=VPOV("V POV","povSCT")
 . ;^category|status|dateTime|provider|identifier|ICD|SCT|diag desc^...
 . S SEQ=SEQ+1
 . S DXVISIT(SEQ)=U_"VISIT"_P_STATUS_P_DXDTHL_P_PROV_P_RESID_P_DXCODE_P_SNOMED_P_SDESC
 . M DXRPTV("DxReportVisit",POVIEN)=VPOV ;
 ;serialize data
 S SERPOV=""
 S SEQ=""
 F  S SEQ=$O(DXVISIT(SEQ)) QUIT:SEQ=""  D
 . S SERPOV=SERPOV_DXVISIT(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SERPOV")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("DXRPTV")
 ;
 QUIT SERPOV
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="10101V964144"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATDXRI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="10101V964144"
 N FRDAT S FRDAT=20000101
 N TODAT S TODAT=20100101
 N JSON S JSON=""
 N RETSTA
 D PATDXRI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="10101V964144"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATDXRI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP06
SYNDHP06 ; HC/rbd/art - HealthConcourse - get hospital location and institution data ;05/07/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get institution details for hospital location ------------------------------
 ;
HOSINSTI(RETSTA,HLOCNAME,RETJSON) ; takes Hospital Location name and returns Institution and Inst. details
 ;
 ; Return Institution and Inst. details for a given Hospital Location name
 ;
 ; Input:
 ;   HLOCNAME  - Hospital Location name
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return Location string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists institution details for hospital location name
 ;             LocName^LocIEN|institutionName|instIEN|instStreet1|instStreet2|instCity|instState|instZip|contactName1_Phone1*repeats|resourceId
 ;          or hospital location & institution data in JSON format
 ;
 ; validate Hospital Location name
 I $G(HLOCNAME)="" S RETSTA="-1^What location?" QUIT
 I '$D(^SC("B",HLOCNAME)) S RETSTA="-1^Hospital Location name not recognised^"_HLOCNAME Q
 ;
 N HLOCARR
 S RETSTA=$$INSTS(HLOCNAME,.HLOCARR)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.HLOCARR,.RETSTA)
 ;
 QUIT
 ;
INSTS(HLOCNAME,HLOCARR) ; get locations for encounters for a patient
 ;
 N C,P,S,A,ZARR
 N CONTNAM,CONTPH,CONTSTR,HSLOCID,INSTCITY,INSTIEN,INSTNAM,INSTST1,INSTST2,INSTSTAT,INSTZIP
 S C=",",P="|",S="_",A="*"
 N FNUM S FNUM=44        ; HOSPITAL LOCATION file
 ; scan hospital location "B" index for HLIEN
 N HLIEN S HLIEN=""
 F  S HLIEN=$O(^SC("B",HLOCNAME,HLIEN)) Q:HLIEN=""  D
 .N HOSPLOC
 .D GETHLOC^SYNDHP22(.HOSPLOC,HLIEN)
 .I $D(HOSPLOC("Hosploc","ERROR")) M HLOCARR("Location",HLIEN)=HOSPLOC QUIT
 .S INSTNAM=HOSPLOC("Hosploc","institution")
 .S INSTIEN=HOSPLOC("Hosploc","institutionId")
 .S HSLOCID=HOSPLOC("Hosploc","resourceId")
 .N SITE
 .D GET1SITE^SYNDHP10(.SITE,INSTIEN,0)
 .I $D(SITE("Site","ERROR")) M HLOCARR("Location",HLIEN)=SITE QUIT
 .S INSTST1=SITE("Site","streetAddr1")
 .S INSTST2=SITE("Site","streetAddr2")
 .S INSTCITY=SITE("Site","city")
 .S INSTZIP=SITE("Site","zip")
 .S INSTSTAT=SITE("Site","state")
 .S CONTSTR=""
 .N IENS2 S IENS2=""
 .F  S IENS2=$O(SITE("Site","contacts","contact",IENS2)) QUIT:IENS2=""  D
 ..N CONTACT S CONTACT=$NA(SITE("Site","contacts","contact",+IENS2))
 ..S CONTNAM=@CONTACT@("contact")
 ..S CONTPH=@CONTACT@("phone")
 ..S CONTSTR=CONTSTR_CONTNAM_S_CONTPH_A
 .S:CONTSTR]"" CONTSTR=$E(CONTSTR,1,$L(CONTSTR)-1)
 .I $G(DEBUG) W !,HLOCNAME,A,HLIEN,A,INSTNAM,A,INSTIEN,A,INSTST1,A,INSTST2,A,INSTCITY,A,INSTSTAT,A,INSTZIP,A,CONTSTR,A,HSLOCID,!!
 .S ZARR(HLOCNAME,HLIEN)=INSTNAM_P_INSTIEN_P_INSTST1_P_INSTST2_P_INSTCITY_P_INSTSTAT_P_INSTZIP_P_CONTSTR_P_HSLOCID
 .M HLOCARR("Location",HLIEN)=HOSPLOC
 .M HLOCARR("Location",HLIEN,"institution")=SITE("Site")
 ;
 ; serialize data
 N HLREC,VSTDT,VIEN
 N HLOC S HLOC=HLOCNAME
 S (VSTDT,VIEN)=""
 F  S HLIEN=$O(ZARR(HLOCNAME,HLIEN)) Q:HLIEN=""  D
 .S HLREC=ZARR(HLOCNAME,HLIEN)
 .S HLOC=HLOC_U_HLIEN_P_HLREC
 ;
 Q HLOC
 ;
 ; ----------- Unit Test -----------
T1 ;
 N LOCNAME S LOCNAME="GENERAL MEDICINE"
 N JSON S JSON=""
 N RETSTA
 D HOSINSTI(.RETSTA,LOCNAME,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N LOCNAME S LOCNAME="GENERAL MEDICINE"
 N JSON S JSON="J"
 N RETSTA
 D HOSINSTI(.RETSTA,LOCNAME,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP07
SYNDHP07 ; HC/rbd/art - HealthConcourse - get patient's nursing care plan data ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;
 ; ---------------- Get patient nursing care plan goals information ------------------------
 ;
PATGOLI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient goals for ICN
 ;
 ; Return patient nursing care plan goals for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compares to date/time entered
 ;   TODAT   - to date (inclusive), optional, compares to date/time entered
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return patient goals string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists patient goals information
 ;             ICN ^ Resource ID | Date/Time Entered | Goal/Expected Outcome | Target Date | User Who Entered | code ; Status of Goal ^ ...
 ;          or patient nursing care plans in JSON format
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 ; get patient IEN from ICN
 N NCPARR
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETSTA=$$GOALS(.NCPARR,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.NCPARR,.RETSTA)
 ;
 QUIT
 ;
GOALS(NCPARR,PATIEN,DHPICN,FRDAT,TODAT) ; get goals for a patient
 ;
 N FNUM S FNUM=216.8      ;  file
 N S S S="_"
 N P S P="|"
 ; scan PATIENT "TARG" index in Nursing Care Plan file for Goals
 N TARGNUM,PTGOLID,ENTRYDT,ENTRYDTFM,ENTRDISP,GOAL,TARGDISP,ENTUSER,GOALSTAT,ZARR,GOALREC
 N MRECIEN S MRECIEN=""
 F  S MRECIEN=$O(^GMR(124.3,"C",PATIEN,MRECIEN)) QUIT:MRECIEN=""  D
 . N NCP
 . D GET1NCP^SYNDHP15(.NCP,MRECIEN,0)
 . I $D(NCP("NurseCarePlan","ERROR")) M NCPARR("NCPS",MRECIEN)=NCP QUIT
 . S TARGNUM=""
 . F  S TARGNUM=$O(NCP("NurseCarePlan","targetDates","targetDate",TARGNUM)) QUIT:TARGNUM=""  D
 . . S PTGOLID=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"resourceId")
 . . S ENTRYDT=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"dateTimeEntered")
 . . S ENTRYDTFM=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"dateTimeEnteredFM")
 . . QUIT:'$$RANGECK^SYNDHPUTL(ENTRYDTFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . . S ENTRDISP=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"dateTimeEnteredHL7")
 . . S GOAL=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"goalExpectedOutcome")
 . . S TARGDISP=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"targetDateHL7")
 . . S ENTUSER=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"userWhoEntered")
 . . S GOALSTAT=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"goalMetDcdCd")_";"_NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"goalMetDcd")
 . . S ZARR(DHPICN,ENTRYDTFM,GOAL)=PTGOLID_P_ENTRDISP_P_GOAL_P_TARGDISP_P_ENTUSER_P_GOALSTAT
 . ;patient data is not included in the NCP record
 . S NCP("NurseCarePlan","patient")=$$GET1^DIQ(2,PATIEN_",",.01)
 . S NCP("NurseCarePlan","patientId")=PATIEN
 . S NCP("NurseCarePlan","patientICN")=DHPICN
 . M NCPARR("NCPS",MRECIEN)=NCP ;
 ;
 ; serialize data
 S ENTRYDT=""
 N GOALS S GOALS=DHPICN
 F  S ENTRYDT=$O(ZARR(DHPICN,ENTRYDT)) Q:ENTRYDT=""  D
 . S GOAL=""
 . F  S GOAL=$O(ZARR(DHPICN,ENTRYDT,GOAL)) Q:GOAL=""  D
 . . S GOALREC=ZARR(DHPICN,ENTRYDT,GOAL)
 . . S GOALS=GOALS_U_GOALREC
 ;
 QUIT GOALS
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="1967316818V742124"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATGOLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="1967316818V742124"
 N FRDAT S FRDAT=19930212
 N TODAT S TODAT=19930228
 N JSON S JSON=""
 N RETSTA
 D PATGOLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="1967316818V742124"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATGOLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP08
SYNDHP08 ; HC/rbd/art - HealthConcourse - get patient flag data ;06/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient flag information ------------------------------
 ;
PATFLGI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient flags for ICN
 ;
 ; Return patient flags for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, not used, no logical date to compare
 ;   TODAT   - to date (inclusive), optional, not used, no logical date to compare
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return patient flags string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists patient flag information
 ;             ICN^flag name|SNOMED CT code|flag record IEN|national or local|status|owner site|originating site|review date|resource id^...
 ;          or patient flags in JSON format
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"DHPICN: ",DHPICN,"   FRDAT: ",FRDAT,"   TODAT: ",TODAT,"   RETJSON: ",RETJSON,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;patient flag data does not contain a date to compare to TODAT or FRDAT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What Patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N FLAGARR
 S RETSTA=$$FLAGS(.FLAGARR,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.FLAGARR,.RETSTA)
 ;
 QUIT
 ;
FLAGS(FLAGARR,PATIEN,DHPICN,FRDAT,TODAT) ; get flags for a patient
 ;
 N FLAGREC,ZARR
 N PTFLGID,FLAGDESC,NATLOC,STATUS,OWNSITE,ORIGSITE,RVWDT,RVWDTDSP,FLAGSCT
 N C,P,S S C=",",P="|",S="_"
 ;
 N FNUM S FNUM=26.13      ;  file
 ; scan PATIENT "B" index for Flags
 ;S DHPICN=PATIEN
 N FLAGIEN S FLAGIEN=0
 F  S FLAGIEN=$O(^DGPF(26.13,"B",PATIEN,FLAGIEN)) QUIT:FLAGIEN=""  D
 . N FLAG
 . D GET1FLAG^SYNDHP17(.FLAG,FLAGIEN,0)
 . I $D(FLAG("Flag","ERROR")) M FLAGARR("Flags",FLAGIEN)=FLAG QUIT
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("FLAG")
 . S PTFLGID=FLAG("Flag","resourceId")
 . S FLAGDESC=FLAG("Flag","flagName") ;flag name
 . S NATLOC=$S(FLAG("Flag","flagNameId")["26.15":"National",1:"Local")
 . S STATUS=FLAG("Flag","status") ;status
 . S OWNSITE=FLAG("Flag","ownerSite") ;owner site
 . S ORIGSITE=FLAG("Flag","originatingSite") ;originating site
 . S RVWDT=FLAG("Flag","reviewDateFM") ;review date
 . S RVWDTDSP=FLAG("Flag","reviewDateHL7")
 . S FLAGSCT=FLAG("Flag","flagSCT")
 . ;S ASSNARR=FLAG("Flag","assignmentNarrative")
 . S ZARR(DHPICN,FLAGDESC)=FLAGSCT_P_FLAGIEN_P_NATLOC_P_STATUS_P_OWNSITE_P_ORIGSITE_P_RVWDTDSP_P_PTFLGID
 . M FLAGARR("Flags",FLAGIEN)=FLAG ;
 ;
 ; serialize data
 N FLAGDESC S FLAGDESC=""
 N FLAGS S FLAGS=DHPICN
 F  S FLAGDESC=$O(ZARR(DHPICN,FLAGDESC)) QUIT:FLAGDESC=""  D
 . S FLAGREC=ZARR(DHPICN,FLAGDESC)
 . S FLAGS=FLAGS_U_FLAGDESC_P_FLAGREC
 ;
 QUIT FLAGS
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="10189V514254"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATFLGI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="10189V514254"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATFLGI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP09
SYNDHP09 ; HC/fjf/art - HealthConcourse - get patient health factors ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient health factors ------------------------------
 ;
PATHLF(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT,RETJSON) ; get health factors for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ;
 ; Return patient health factors for name, SSN, DOB, and gender
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return health factors string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for the patient health factors
 ;           - ICN^SCT code|HF Name|Resource ID|HF Severity|Encounter Provider|Visit Date^SCT code...
 ;          or patient health factors in JSON format
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 ;
 N ICNST
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 N DHPICN S DHPICN=$P(ICNST,U,3)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 N HFARRAY
 S RETSTA=$$HLFS(.HFARRAY,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.HFARRAY,.RETSTA)
 ;
 QUIT
 ;
 ; ---------------- Get patient health factors ------------------------------
 ;
PATHLFI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient health factors for ICN
 ;
 ; Return patient vitals for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return health factors string (default)
 ; Output:
 ;   RETSTA  - a delimited string that list the health factors for the patient
 ;           - ICN^SCT code|HF Name|Resource ID|HF Severity|Encounter Provider|Visit Date^...
 ;          or patient health factors in JSON format
 ;
 ; bypass for CQM
 ;
 ; ***********
 ; *********** Important Note for open source community
 ; ***********
 ; *********** Perspecta - who developed this source code and have released it to the open source
 ; *********** need the following six lines to remain intact
 ;
 I DHPICN="2495309561V670720" D  QUIT
 . S RETSTA="2495309561V670720^75624-7|5 or more drinks|442_130_1014|9|9990000033|20170101^24165007|Alcohol Counseling and Treatment|442_130_101||9990000033|20170101"
 I DHPICN="1686299845V246594" D  QUIT
 . S RETSTA="1686299845V246594^44249-1|PHQ-9|442_130_1014|4.0|9990000033|20170101"
 ;I DHPICN="2495309561V670720" D  QUIT
 ;. S RETSTA="2495309561V670720^24165007|Alcohol Counseling and Treatment|442_130_101||9990000033|20170101"
 ;
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to
 ; *********** be determined by Perspecta
 ; ***********
 ; *********** End of Important Note for open source community
 ;
 ;HLFCTS_U_SCT_P_HLF
 ;SCTPT_P_HID_P_HFSEV_P_HFPROV_P_HFDATE=HLF
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N HFARRAY
 S RETSTA=$$HLFS(.HFARRAY,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.HFARRAY,.RETSTA)
 ;
 QUIT
 ;
HLFS(HFARRAY,PATIEN,DHPICN,FRDAT,TODAT) ; get health factors for a patient
 ; build the array of SNOMED CT codes that correspond to health factors
 ;
 N USER S USER=$$DUZ^SYNDHP69
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N P S P="|"
 N FNUM S FNUM=9000010.23
 N FNBR2 S FNBR2=9000010 ;visit
 I $G(DEBUG) W !,"Health Factors",!
 ;
 ; scan Health Factors C index for DFN
 N VISITID,VISITDT,VISITHL,HID,HFACT,HFACTOR,HFSEV,HFDATE,HFDATEHL
 N HFOPRVNM,HFEPRVNM,HFOPROV,HFEPROV,SCTPT,SCT,ZARR,HLFCTS
 N HIEN S HIEN=""
 F  S HIEN=$O(^AUPNVHF("C",PATIEN,HIEN)) QUIT:HIEN=""  D
 . N HLFACT
 . D GET1HLF^SYNDHP15(.HLFACT,HIEN,0)
 . I $D(HLFACT("HealthFactor","ERROR")) M HFARRAY("HealthFactors",HIEN)=HLFACT QUIT
 . S VISITID=HLFACT("HealthFactor","visitId") ;visit ien
 . S VISITDT=$$GET1^DIQ(FNBR2,VISITID_",",.01,"I") ;visit/admit date&time
 . QUIT:'$$RANGECK^SYNDHPUTL(VISITDT,FRDAT,TODAT)  ;quit if outside of requested date range
 . S VISITHL=$$FMTHL7^XLFDT(VISITDT) ;hl7 format visit/admit date&time
 . S HID=HLFACT("HealthFactor","resourceId")
 . S HFACT=HLFACT("HealthFactor","hlfNameId") ;health factor ien
 . S HFACTOR=HLFACT("HealthFactor","hlfName") ;health factor name
 . S HFSEV=HLFACT("HealthFactor","levelSeverity") ;level/severity
 . S HFDATE=HLFACT("HealthFactor","eventDateTime") ;event date and time
 . S HFDATEHL=$$FMTHL7^XLFDT(HFDATE) ;event date and time in HL7 format
 . S HFOPROV=HLFACT("HealthFactor","orderingProviderId") ;ordering provider ien
 . S HFOPRVNM=HLFACT("HealthFactor","orderingProvider") ;ordering provider
 . S HFEPROV=HLFACT("HealthFactor","encounterProviderId") ;encounter provider ien
 . S HFEPRVNM=HLFACT("HealthFactor","encounterProvider") ;encounter provider
 . S SCT=HLFACT("HealthFactor","hlfNameSCT")
 . S SCTPT=HFACTOR
 . M HFARRAY("HealthFactors",HIEN)=HLFACT ;
 . ;
 . ; if care plan HF, get SCT from name string
 . I $E(HLFACT("HealthFactor","hlfName"),1,4)="SYN " D
 . . S SCT=$P($P(HLFACT("HealthFactor","hlfName"),"SCT:",2),")",1)
 . ;
 . S ZARR(HIEN)=SCT_P_SCTPT_P_HID_P_HFSEV_P_HFEPRVNM_P_VISITHL
 . ;
 . I $G(DEBUG)=1 D
 . . W !,"Record IEN:",?21,HIEN,!
 . . W "Health Factor:",?21,HFACT,"     ",HFACTOR,!
 . . W "Visit IEN:",?21,VISITID,!
 . . W "Visit Date:",?21,VISITDT,"     ",VISITHL,!
 . . W "Level/Severity:",?21,HFSEV,!
 . . W "Event Date:",?21,HFDATE,"     ",HFDATEHL,!
 . . W "Ordering Provider: ",?21,HFOPROV,"     ",HFOPRVNM,!
 . . W "Encounter Provider:",?21,HFEPROV,"     ",HFEPRVNM,!
 . . W "SCT:",?21,SCT,"     ",SCTPT,!!
 ;
 ; serialize data
 S HIEN=""
 S HLFCTS=DHPICN
 F  S HIEN=$O(ZARR(HIEN)) QUIT:HIEN=""  D
 . S HLFCTS=HLFCTS_U_ZARR(HIEN)
 ;
 QUIT HLFCTS
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="5000001536V889384"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATHLFI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="5000001536V889384"
 N FRDAT S FRDAT=20150101
 N TODAT S TODAT=20151231
 N JSON S JSON=""
 N RETSTA
 D PATHLFI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="5000001536V889384"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATHLFI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
HLFTEST0 ; all pass ICN
 N ICN S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .D PATHLFI(.RETSTA,ICN) W $$ZW^SYNDHPUTL("RETSTA")
 Q
HLFTEST1 ; all pass ICN return those with data
 N ICN S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .D PATHLFI(.RETSTA,ICN)
 .I $L(RETSTA,"|")>1 W $$ZW^SYNDHPUTL("RETSTA")
 Q

SYNDHP10
SYNDHP10 ; HC/art - HealthConcourse - get institution data ;06/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1SITE(SITE,SITEIEN,RETJSON,SITEJ) ;get one Institution record
 ;inputs: SITEIEN - Institution IEN
 ;        RETJSON - J = Return JSON
 ;output: SITE  - array of Institution data, by reference
 ;        SITEJ - JSON structure of Institution data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Institution -----------------------------",!
 N S S S="_"
 N SITEID S SITEID=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=4 ;INSTITUTION
 N FNBR2 S FNBR2=4.03 ;CONTACT
 N FNBR3 S FNBR3=4.014 ;ASSOCIATIONS
 N FNBR4 S FNBR4=4.042 ;EFFECTIVE DATE/TIME
 N FNBR5 S FNBR5=4.043 ;TAXONOMY CODE
 N FNBR6 S FNBR6=4.999 ;HISTORY
 N FNBR7 S FNBR7=4.05 ;INSTITUTION ASSOCIATION TYPES
 N FNBR8 S FNBR8=4.9999 ;IDENTIFIER
 N IENS1 S IENS1=SITEIEN_","
 ;
 N SITEARR,SITEERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","SITEARR","SITEERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SITEARR")
 I $G(DEBUG),$D(SITEERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("SITEERR")
 I $D(SITEERR) D  QUIT
 . S SITE("Site","ERROR")=SITEIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.SITE,.SITEJ)
 S SITE("Site","siteIen")=SITEIEN
 S SITE("Site","resourceType")="Organization"
 S SITE("Site","resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN)
 S SITE("Site","siteName")=$G(SITEARR(FNBR1,IENS1,.01,"E"))
 S SITE("Site","state")=$G(SITEARR(FNBR1,IENS1,.02,"E"))
 S SITE("Site","stateId")=$G(SITEARR(FNBR1,IENS1,.02,"I"))
 S SITE("Site","district")=$G(SITEARR(FNBR1,IENS1,.03,"E"))
 S SITE("Site","shortName")=$G(SITEARR(FNBR1,IENS1,.05,"E"))
 S SITE("Site","vaTypeCode")=$G(SITEARR(FNBR1,IENS1,.06,"E"))
 S SITE("Site","vaTypeCodeCd")=$G(SITEARR(FNBR1,IENS1,.06,"I"))
 S SITE("Site","region")=$G(SITEARR(FNBR1,IENS1,.07,"E"))
 S SITE("Site","streetAddr1")=$G(SITEARR(FNBR1,IENS1,1.01,"E"))
 S SITE("Site","streetAddr2")=$G(SITEARR(FNBR1,IENS1,1.02,"E"))
 S SITE("Site","city")=$G(SITEARR(FNBR1,IENS1,1.03,"E"))
 S SITE("Site","zip")=$G(SITEARR(FNBR1,IENS1,1.04,"E"))
 S SITE("Site","stAddr1Mailing")=$G(SITEARR(FNBR1,IENS1,4.01,"E"))
 S SITE("Site","stAddr2Mailing")=$G(SITEARR(FNBR1,IENS1,4.02,"E"))
 S SITE("Site","cityMailing")=$G(SITEARR(FNBR1,IENS1,4.03,"E"))
 S SITE("Site","stateMailing")=$G(SITEARR(FNBR1,IENS1,4.04,"E"))
 S SITE("Site","stateMailingId")=$G(SITEARR(FNBR1,IENS1,4.04,"I"))
 S SITE("Site","zipMailing")=$G(SITEARR(FNBR1,IENS1,4.05,"E"))
 S SITE("Site","multiDivisionFacility")=$G(SITEARR(FNBR1,IENS1,5,"E"))
 S SITE("Site","multiDivisionFacilityCd")=$G(SITEARR(FNBR1,IENS1,5,"I"))
 S SITE("Site","status")=$G(SITEARR(FNBR1,IENS1,11,"E"))
 S SITE("Site","statusCd")=$G(SITEARR(FNBR1,IENS1,11,"I"))
 S SITE("Site","facilityType")=$G(SITEARR(FNBR1,IENS1,13,"E"))
 S SITE("Site","facilityTypeId")=$G(SITEARR(FNBR1,IENS1,13,"I"))
 S SITE("Site","npi")=$G(SITEARR(FNBR1,IENS1,41.99,"E"))
 S SITE("Site","acosHospitalId")=$G(SITEARR(FNBR1,IENS1,51,"E"))
 S SITE("Site","facilityDeaNumber")=$G(SITEARR(FNBR1,IENS1,52,"E"))
 S SITE("Site","facilityDeaExpirationDate")=$G(SITEARR(FNBR1,IENS1,52.1,"E"))
 S SITE("Site","facilityDeaExpirationDateFM")=$G(SITEARR(FNBR1,IENS1,52.1,"I"))
 S SITE("Site","facilityDeaExpirationDateHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR1,IENS1,52.1,"I")))
 S SITE("Site","facilityDeaExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR1,IENS1,52.1,"I")))
 S SITE("Site","domain")=$G(SITEARR(FNBR1,IENS1,60,"E"))
 S SITE("Site","domainId")=$G(SITEARR(FNBR1,IENS1,60,"I"))
 S SITE("Site","agencyCode")=$G(SITEARR(FNBR1,IENS1,95,"E"))
 S SITE("Site","agencyCodeCd")=$G(SITEARR(FNBR1,IENS1,95,"I"))
 S SITE("Site","reportingStation")=$G(SITEARR(FNBR1,IENS1,96,"E"))
 S SITE("Site","reportingStationId")=$G(SITEARR(FNBR1,IENS1,96,"I"))
 S SITE("Site","pointerToAgency")=$G(SITEARR(FNBR1,IENS1,97,"E"))
 S SITE("Site","pointerToAgencyId")=$G(SITEARR(FNBR1,IENS1,97,"I"))
 S SITE("Site","stationNumber")=$G(SITEARR(FNBR1,IENS1,99,"E"))
 S SITE("Site","officialVaName")=$G(SITEARR(FNBR1,IENS1,100,"E"))
 S SITE("Site","inactiveFacilityFlag")=$G(SITEARR(FNBR1,IENS1,101,"E"))
 S SITE("Site","inactiveFacilityFlagCd")=$G(SITEARR(FNBR1,IENS1,101,"I"))
 S SITE("Site","billingFacilityName")=$G(SITEARR(FNBR1,IENS1,200,"E"))
 S SITE("Site","currentLocation")=$G(SITEARR(FNBR1,IENS1,720,"E"))
 S SITE("Site","currentLocationCd")=$G(SITEARR(FNBR1,IENS1,720,"I"))
 S SITE("Site","locationTimezone")=$G(SITEARR(FNBR1,IENS1,800,"E"))
 S SITE("Site","locationTimezoneId")=$G(SITEARR(FNBR1,IENS1,800,"I"))
 S SITE("Site","country")=$G(SITEARR(FNBR1,IENS1,801,"E"))
 S SITE("Site","countryId")=$G(SITEARR(FNBR1,IENS1,801,"I"))
 S SITE("Site","timezoneException")=$G(SITEARR(FNBR1,IENS1,802,"E"))
 S SITE("Site","timezoneExceptionCd")=$G(SITEARR(FNBR1,IENS1,802,"I"))
 N IENS2 S IENS2=""
 F  S IENS2=$O(SITEARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N CONTACT S CONTACT=$NA(SITE("Site","contacts","contact",+IENS2))
 . S @CONTACT@("contact")=$G(SITEARR(FNBR2,IENS2,.01,"E"))
 . S @CONTACT@("area")=$G(SITEARR(FNBR2,IENS2,.02,"E"))
 . S @CONTACT@("areaId")=$G(SITEARR(FNBR2,IENS2,.02,"I"))
 . S @CONTACT@("phone")=$G(SITEARR(FNBR2,IENS2,.03,"E"))
 . S @CONTACT@("resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN,FNBR2_U_+IENS2)
 N IENS3 S IENS3=""
 F  S IENS3=$O(SITEARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N ASSOC S ASSOC=$NA(SITE("Site","associationss","associations",+IENS3))
 . S @ASSOC@("associations")=$G(SITEARR(FNBR3,IENS3,.01,"E"))
 . S @ASSOC@("associationsId")=$G(SITEARR(FNBR3,IENS3,.01,"I"))
 . S @ASSOC@("parentOfAssociation")=$G(SITEARR(FNBR3,IENS3,1,"E"))
 . S @ASSOC@("parentOfAssociationId")=$G(SITEARR(FNBR3,IENS3,1,"I"))
 . S @ASSOC@("resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN,FNBR3_U_+IENS3)
 N IENS4 S IENS4=""
 F  S IENS4=$O(SITEARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N EFFDATE S EFFDATE=$NA(SITE("Site","effectiveDateTimes","effectiveDateTime",+IENS4))
 . S @EFFDATE@("effectiveDateTime")=$G(SITEARR(FNBR4,IENS4,.01,"E"))
 . S @EFFDATE@("effectiveDateTimeFM")=$G(SITEARR(FNBR4,IENS4,.01,"I"))
 . S @EFFDATE@("effectiveDateTimeHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR4,IENS4,.01,"I")))
 . S @EFFDATE@("effectiveDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR4,IENS4,.01,"I")))
 . S @EFFDATE@("status")=$G(SITEARR(FNBR4,IENS4,.02,"E"))
 . S @EFFDATE@("statusCd")=$G(SITEARR(FNBR4,IENS4,.02,"I"))
 . S @EFFDATE@("npi")=$G(SITEARR(FNBR4,IENS4,.03,"E"))
 . S @EFFDATE@("resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN,FNBR4_U_+IENS4)
 N IENS5 S IENS5=""
 F  S IENS5=$O(SITEARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . N TAXON S TAXON=$NA(SITE("Site","taxonomyCodes","taxonomyCode",+IENS5))
 . S @TAXON@("taxonomyCode")=$G(SITEARR(FNBR5,IENS5,.01,"E"))
 . S @TAXON@("taxonomyCodeId")=$G(SITEARR(FNBR5,IENS5,.01,"I"))
 . S @TAXON@("primaryCode")=$G(SITEARR(FNBR5,IENS5,.02,"E"))
 . S @TAXON@("primaryCodeCd")=$G(SITEARR(FNBR5,IENS5,.02,"I"))
 . S @TAXON@("status")=$G(SITEARR(FNBR5,IENS5,.03,"E"))
 . S @TAXON@("statusCd")=$G(SITEARR(FNBR5,IENS5,.03,"I"))
 . S @TAXON@("resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN,FNBR5_U_+IENS5)
 N IENS6 S IENS6=""
 F  S IENS6=$O(SITEARR(FNBR6,IENS6)) QUIT:IENS6=""  D
 . N HISTORY S HISTORY=$NA(SITE("Site","historys","history",+IENS6))
 . S @HISTORY@("effectiveDate")=$G(SITEARR(FNBR6,IENS6,.01,"E"))
 . S @HISTORY@("effectiveDateFM")=$G(SITEARR(FNBR6,IENS6,.01,"I"))
 . S @HISTORY@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR6,IENS6,.01,"I")))
 . S @HISTORY@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR6,IENS6,.01,"I")))
 . S @HISTORY@("nameChangedFrom")=$G(SITEARR(FNBR6,IENS6,.02,"E"))
 . S @HISTORY@("officalVaNameChangedFrom")=$G(SITEARR(FNBR6,IENS6,.03,"E"))
 . S @HISTORY@("realignedTo")=$G(SITEARR(FNBR6,IENS6,.05,"E"))
 . S @HISTORY@("realignedToId")=$G(SITEARR(FNBR6,IENS6,.05,"I"))
 . S @HISTORY@("realignedFrom")=$G(SITEARR(FNBR6,IENS6,.06,"E"))
 . S @HISTORY@("realignedFromId")=$G(SITEARR(FNBR6,IENS6,.06,"I"))
 . S @HISTORY@("deactivatedFacilitySta")=$G(SITEARR(FNBR6,IENS6,.07,"E"))
 . S @HISTORY@("deactivatedFacilityStaCd")=$G(SITEARR(FNBR6,IENS6,.07,"I"))
 . S @HISTORY@("activatedFacility")=$G(SITEARR(FNBR6,IENS6,.08,"E"))
 . S @HISTORY@("activatedFacilityCd")=$G(SITEARR(FNBR6,IENS6,.08,"I"))
 . S @HISTORY@("resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN,FNBR6_U_+IENS6)
 N IENS7 S IENS7=""
 F  S IENS7=$O(SITEARR(FNBR7,IENS7)) QUIT:IENS7=""  D
 . N ASSTYPE S ASSTYPE=$NA(SITE("Site","institutionAssociationTypess","institutionAssociationTypes",+IENS7))
 . S @ASSTYPE@("number")=$G(SITEARR(FNBR7,IENS7,.001,"E"))
 . S @ASSTYPE@("name")=$G(SITEARR(FNBR7,IENS7,.01,"E"))
 . S @ASSTYPE@("resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN,FNBR7_U_+IENS7)
 N IENS8 S IENS8=""
 F  S IENS8=$O(SITEARR(FNBR8,IENS8)) QUIT:IENS8=""  D
 . N IDENT S IDENT=$NA(SITE("Site","identifiers","identifier",+IENS8))
 . S @IDENT@("codingSystem")=$G(SITEARR(FNBR8,IENS8,.01,"E"))
 . S @IDENT@("id")=$G(SITEARR(FNBR8,IENS8,.02,"E"))
 . S @IDENT@("effectiveDateTime")=$G(SITEARR(FNBR8,IENS8,.03,"E"))
 . S @IDENT@("effectiveDateTimeFM")=$G(SITEARR(FNBR8,IENS8,.03,"I"))
 . S @IDENT@("effectiveDateTimeHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR8,IENS8,.03,"I")))
 . S @IDENT@("effectiveDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR8,IENS8,.03,"I")))
 . S @IDENT@("status")=$G(SITEARR(FNBR8,IENS8,.04,"E"))
 . S @IDENT@("statusCd")=$G(SITEARR(FNBR8,IENS8,.04,"I"))
 . S @IDENT@("resourceId")=$$RESID^SYNDHP69("V",SITEID,FNBR1,SITEIEN,FNBR8_U_+IENS8)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SITE")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.SITE,.SITEJ)
 ;
 QUIT
 ;

SYNDHP11
SYNDHP11 ; HC/art - HealthConcourse - get problem record ;2019-10-25  12:21 PM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ; (c) 2017-2019 Perspecta
 ; (c) 2019 OSEHRA
 ; 
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1PROB(PROBLEM,PROBIEN,RETJSON,PROBLEMJ) ;get one Patient Problem (Condition) record
 ;inputs: PROBIEN - Problem IEN
 ;        RETJSON - J = Return JSON
 ;output: PROBLEM  - array of problem data, by reference
 ;        PROBLEMJ - JSON structure of problem data, by reference
 ;
 I $G(DEBUG) W !,"----------------------------- Problem -----------------------------",!
 N FNBR1 S FNBR1=9000011 ;PROBLEM
 N FNBR2 S FNBR2=9000011.11 ;PROBLEM:NOTE FACILITY
 N FNBR3 S FNBR3=9000011.1111 ;PROBLEM:NOTE FACILITY:NOTE
 N FNBR4 S FNBR4=9000011.803 ;PROBLEM:MAPPING TARGETS
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N IENS S IENS=PROBIEN_","
 N PROBARR,PROBERR
 D GETS^DIQ(FNBR1,IENS,"**","EI","PROBARR","PROBERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PROBARR")
 I $G(DEBUG),$D(PROBERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("PROBERR")
 I $D(PROBERR) D  QUIT
 . S PROBLEM("Problem","ERROR")=PROBIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PROBLEM,.PROBLEMJ)
 N PROBCOND S PROBCOND=$NA(PROBLEM("Problem"))
 S @PROBCOND@("problemIen")=PROBIEN
 S @PROBCOND@("resourceType")="Condition"
 S @PROBCOND@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PROBIEN)
 S @PROBCOND@("diagnosisId")=$G(PROBARR(FNBR1,IENS,.01,"I"))
 S @PROBCOND@("diagnosis")=$G(PROBARR(FNBR1,IENS,.01,"E"))
 S @PROBCOND@("diagnosisText")=$G(^ICD9(@PROBCOND@("diagnosisId"),68,1,1))
 S @PROBCOND@("patientNameId")=$G(PROBARR(FNBR1,IENS,.02,"I"))
 S @PROBCOND@("patientName")=$G(PROBARR(FNBR1,IENS,.02,"E"))
 S @PROBCOND@("patientICN")=$$GET1^DIQ(2,@PROBCOND@("patientNameId")_",",991.1)
 S @PROBCOND@("dateLastModified")=$G(PROBARR(FNBR1,IENS,.03,"E"))
 S @PROBCOND@("dateLastModifiedFM")=$G(PROBARR(FNBR1,IENS,.03,"I"))
 S @PROBCOND@("dateLastModifiedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,.03,"I")))
 S @PROBCOND@("dateLastModifiedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,.03,"I")))
 S @PROBCOND@("classCd")=$G(PROBARR(FNBR1,IENS,.04,"I"))
 S @PROBCOND@("class")=$G(PROBARR(FNBR1,IENS,.04,"E"))
 S @PROBCOND@("providerNarativeId")=$G(PROBARR(FNBR1,IENS,.05,"I"))
 S @PROBCOND@("providerNarative")=$G(PROBARR(FNBR1,IENS,.05,"E"))
 S @PROBCOND@("facilityId")=$G(PROBARR(FNBR1,IENS,.06,"I"))
 S @PROBCOND@("facility")=$G(PROBARR(FNBR1,IENS,.06,"E"))
 S @PROBCOND@("nmbr")=$G(PROBARR(FNBR1,IENS,.07,"E"))
 S @PROBCOND@("dateEntered")=$G(PROBARR(FNBR1,IENS,.08,"E"))
 S @PROBCOND@("dateEnteredFM")=$G(PROBARR(FNBR1,IENS,.08,"I"))
 S @PROBCOND@("dateEnteredHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,.08,"I")))
 S @PROBCOND@("dateEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,.08,"I")))
 S @PROBCOND@("statusCd")=$G(PROBARR(FNBR1,IENS,.12,"I"))
 S @PROBCOND@("status")=$G(PROBARR(FNBR1,IENS,.12,"E"))
 S @PROBCOND@("dateOfOnset")=$G(PROBARR(FNBR1,IENS,.13,"E"))
 S @PROBCOND@("dateOfOnsetFM")=$G(PROBARR(FNBR1,IENS,.13,"I")) ; date of onset may be imprecise
 N ADJDATE S ADJDATE=@PROBCOND@("dateOfOnsetFM")
 S:$E(@PROBCOND@("dateOfOnsetFM"),4,5)="00" $E(ADJDATE,4,5)="01"
 S:$E(@PROBCOND@("dateOfOnsetFM"),6,7)="00" $E(ADJDATE,6,7)="01"
 S @PROBCOND@("dateOfOnsetHL7")=$$FMTHL7^XLFDT(ADJDATE)
 S @PROBCOND@("dateOfOnsetFHIR")=$$FMTFHIR^SYNDHPUTL(ADJDATE)
 S @PROBCOND@("problemId")=$G(PROBARR(FNBR1,IENS,1.01,"I"))
 S @PROBCOND@("problem")=$G(PROBARR(FNBR1,IENS,1.01,"E"))
 S @PROBCOND@("conditionCd")=$G(PROBARR(FNBR1,IENS,1.02,"I"))
 S @PROBCOND@("condition")=$G(PROBARR(FNBR1,IENS,1.02,"E"))
 S @PROBCOND@("enteredById")=$G(PROBARR(FNBR1,IENS,1.03,"I"))
 S @PROBCOND@("enteredBy")=$G(PROBARR(FNBR1,IENS,1.03,"E"))
 S @PROBCOND@("recordingProviderId")=$G(PROBARR(FNBR1,IENS,1.04,"I"))
 S @PROBCOND@("recordingProvider")=$G(PROBARR(FNBR1,IENS,1.04,"E"))
 S @PROBCOND@("recordingProviderNPI")=$$GET1^DIQ(200,@PROBCOND@("recordingProviderId")_",",41.99) ;NPI
 S @PROBCOND@("recordingProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@PROBCOND@("recordingProviderId"))
 S @PROBCOND@("responsibleProviderId")=$G(PROBARR(FNBR1,IENS,1.05,"I"))
 S @PROBCOND@("responsibleProvider")=$G(PROBARR(FNBR1,IENS,1.05,"E"))
 S @PROBCOND@("responsibleProviderNPI")=$$GET1^DIQ(200,@PROBCOND@("responsibleProviderId")_",",41.99) ;NPI
 S @PROBCOND@("responsibleProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@PROBCOND@("responsibleProviderId"))
 S @PROBCOND@("serviceId")=$G(PROBARR(FNBR1,IENS,1.06,"I"))
 S @PROBCOND@("service")=$G(PROBARR(FNBR1,IENS,1.06,"E"))
 S @PROBCOND@("dateResolved")=$G(PROBARR(FNBR1,IENS,1.07,"E"))
 S @PROBCOND@("dateResolvedFM")=$G(PROBARR(FNBR1,IENS,1.07,"I"))
 ; If onset and resolution dates are the same, delete resolution dates
 I @PROBCOND@("dateResolvedFM")>@PROBCOND@("dateOfOnsetFM") D
 . S @PROBCOND@("dateResolvedHL7")=$$FMTHL7^XLFDT(@PROBCOND@("dateResolvedFM"))
 . S @PROBCOND@("dateResolvedFHIR")=$$FMTFHIR^SYNDHPUTL(@PROBCOND@("dateResolvedFM"))
 E  D
 . S @PROBCOND@("dateResolved")=""
 . S @PROBCOND@("dateResolvedFM")=""
 . S @PROBCOND@("dateResolvedHL7")=""
 . S @PROBCOND@("dateResolvedFHIR")=""
 S @PROBCOND@("clinicId")=$G(PROBARR(FNBR1,IENS,1.08,"I"))
 S @PROBCOND@("clinic")=$G(PROBARR(FNBR1,IENS,1.08,"E"))
 S @PROBCOND@("dateRecorded")=$G(PROBARR(FNBR1,IENS,1.09,"E"))
 S @PROBCOND@("dateRecordedFM")=$G(PROBARR(FNBR1,IENS,1.09,"I"))
 S @PROBCOND@("dateRecordedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,1.09,"I")))
 S @PROBCOND@("dateRecordedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,1.09,"I")))
 S @PROBCOND@("serviceConnectedCd")=$G(PROBARR(FNBR1,IENS,1.1,"I"))
 S @PROBCOND@("serviceConnected")=$G(PROBARR(FNBR1,IENS,1.1,"E"))
 S @PROBCOND@("agentOrangeExposureCd")=$G(PROBARR(FNBR1,IENS,1.11,"I"))
 S @PROBCOND@("agentOrangeExposure")=$G(PROBARR(FNBR1,IENS,1.11,"E"))
 S @PROBCOND@("ionizingRadiationExposureCd")=$G(PROBARR(FNBR1,IENS,1.12,"I"))
 S @PROBCOND@("ionizingRadiationExposure")=$G(PROBARR(FNBR1,IENS,1.12,"E"))
 S @PROBCOND@("persianGulfExposureCd")=$G(PROBARR(FNBR1,IENS,1.13,"I"))
 S @PROBCOND@("persianGulfExposure")=$G(PROBARR(FNBR1,IENS,1.13,"E"))
 S @PROBCOND@("priorityCd")=$G(PROBARR(FNBR1,IENS,1.14,"I"))
 S @PROBCOND@("priority")=$G(PROBARR(FNBR1,IENS,1.14,"E"))
 S @PROBCOND@("headAndOrNeckCancerCd")=$G(PROBARR(FNBR1,IENS,1.15,"I"))
 S @PROBCOND@("headAndOrNeckCancer")=$G(PROBARR(FNBR1,IENS,1.15,"E"))
 S @PROBCOND@("militarySexualTraumaCd")=$G(PROBARR(FNBR1,IENS,1.16,"I"))
 S @PROBCOND@("militarySexualTrauma")=$G(PROBARR(FNBR1,IENS,1.16,"E"))
 S @PROBCOND@("combatVeteranCd")=$G(PROBARR(FNBR1,IENS,1.17,"I"))
 S @PROBCOND@("combatVeteran")=$G(PROBARR(FNBR1,IENS,1.17,"E"))
 S @PROBCOND@("shipboardHazardDefenseCd")=$G(PROBARR(FNBR1,IENS,1.18,"I"))
 S @PROBCOND@("shipboardHazardDefense")=$G(PROBARR(FNBR1,IENS,1.18,"E"))
 S @PROBCOND@("snomedCTconceptCode")=$G(PROBARR(FNBR1,IENS,80001,"E"))
 S @PROBCOND@("snomedCTconceptCodeText")=""
 S:@PROBCOND@("snomedCTconceptCode")'="" @PROBCOND@("snomedCTconceptCodeText")=$$USCTPT^SYNDHPUTL(@PROBCOND@("snomedCTconceptCode"))
 S @PROBCOND@("snomedCTdesignationCode")=$G(PROBARR(FNBR1,IENS,80002,"E"))
 S @PROBCOND@("snomedCTdesignationCodeText")=""
 S:@PROBCOND@("snomedCTdesignationCode")'="" @PROBCOND@("snomedCTdesignationCodeText")=$$USCTPT^SYNDHPUTL(@PROBCOND@("snomedCTdesignationCode"))
 S @PROBCOND@("vhatConceptVuid")=$G(PROBARR(FNBR1,IENS,80003,"E"))
 S @PROBCOND@("vhatDesignationVuid")=$G(PROBARR(FNBR1,IENS,80004,"E"))
 S @PROBCOND@("snomedCtToIcdMapStatusCd")=$G(PROBARR(FNBR1,IENS,80005,"E"))
 S @PROBCOND@("snomedCtToIcdMapStatus")=$G(PROBARR(FNBR1,IENS,80005,"E"))
 S @PROBCOND@("uniqueNewTermRequestedCd")=$G(PROBARR(FNBR1,IENS,80101,"E"))
 S @PROBCOND@("uniqueNewTermRequested")=$G(PROBARR(FNBR1,IENS,80101,"E"))
 S @PROBCOND@("uniqueTermRequestComment")=$G(PROBARR(FNBR1,IENS,80102,"E"))
 S @PROBCOND@("dateOfInterest")=$G(PROBARR(FNBR1,IENS,80201,"E"))
 S @PROBCOND@("dateOfInterestFM")=$G(PROBARR(FNBR1,IENS,80201,"I"))
 S @PROBCOND@("dateOfInterestHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,80201,"I")))
 S @PROBCOND@("dateOfInterestFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,80201,"I")))
 S @PROBCOND@("codingSystem")=$G(PROBARR(FNBR1,IENS,80202,"E"))
 ;
 ;icd -> snomed
 N MAPPING S MAPPING=$S(@PROBCOND@("dateEnteredFM")>3150930:"sct2icd",1:"sct2icdnine")
 N SNOMED S SNOMED=$$MAP^SYNDHPMP(MAPPING,@PROBCOND@("diagnosis"),"I")
 S @PROBCOND@("diagnosisSCT")=$S(+SNOMED=-1:"",1:$P(SNOMED,U,2))
 ;
 N IENS2 S IENS2=""
 F  S IENS2=$O(PROBARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N FACNOTE S FACNOTE=$NA(PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2))
 . S @FACNOTE@("noteFacilityId")=$G(PROBARR(FNBR2,IENS2,.01,"I"))
 . S @FACNOTE@("noteFacility")=$G(PROBARR(FNBR2,IENS2,.01,"E"))
 . S @FACNOTE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PROBIEN,FNBR2_U_+IENS2)
 ;
 N IENS3 S IENS3=""
 F  S IENS3=$O(PROBARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N NOTE S NOTE=$NA(PROBLEM("Problem","noteFacilitys","noteFacility",$P(IENS3,C,2),"notes","note",+IENS3))
 . S @NOTE@("noteNmbr")=$G(PROBARR(FNBR3,IENS3,.01,"E"))
 . S @NOTE@("noteNarrative")=$G(PROBARR(FNBR3,IENS3,.03,"E"))
 . S @NOTE@("statusCd")=$G(PROBARR(FNBR3,IENS3,.04,"I"))
 . S @NOTE@("status")=$G(PROBARR(FNBR3,IENS3,.04,"E"))
 . S @NOTE@("dateNoteAdded")=$G(PROBARR(FNBR3,IENS3,.05,"E"))
 . S @NOTE@("dateNoteAddedFM")=$G(PROBARR(FNBR3,IENS3,.05,"I"))
 . S @NOTE@("dateNoteAddedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR3,IENS3,.05,"I")))
 . S @NOTE@("dateNoteAddedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR3,IENS3,.05,"I")))
 . S @NOTE@("authorId")=$G(PROBARR(FNBR3,IENS3,.06,"I"))
 . S @NOTE@("author")=$G(PROBARR(FNBR3,IENS3,.06,"E"))
 . S @NOTE@("authorNPI")=$$GET1^DIQ(200,@NOTE@("authorId")_",",41.99) ;NPI
 . S @NOTE@("authorResId")=$$RESID^SYNDHP69("V",SITE,200,@NOTE@("authorId"))
 . S @NOTE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PROBIEN,FNBR2_U_$P(IENS3,C,2)_U_FNBR3_U_+IENS3)
 ;
 N IENS4 S IENS4=""
 F  S IENS4=$O(PROBARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N MAPTARG S MAPTARG=$NA(PROBLEM("Problem","mappingTargets","mappingTarget",+IENS4))
 . S @MAPTARG@("code")=$G(PROBARR(FNBR4,IENS4,.01,"E"))
 . S @MAPTARG@("codingSystem")=$G(PROBARR(FNBR4,IENS4,.02,"E"))
 . S @MAPTARG@("codeDate")=$G(PROBARR(FNBR4,IENS4,.03,"E"))
 . S @MAPTARG@("codeDateFM")=$G(PROBARR(FNBR4,IENS4,.03,"I"))
 . S @MAPTARG@("codeDateHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR4,IENS4,.03,"I")))
 . S @MAPTARG@("codeDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR4,IENS4,.03,"I")))
 . S @MAPTARG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PROBIEN,FNBR4_U_+IENS4)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PROBLEM")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PROBLEM,.PROBLEMJ)
 ;
 QUIT
 ;

SYNDHP12
SYNDHP12 ; HC/art - HealthConcourse - get immunization record ;08/27/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1IMMUN(IMMUNIZE,IMMUNIEN,RETJSON,IMMUNIZEJ) ;get one Immunization record
 ;inputs: IMMUNIEN - Immunization IEN
 ;        RETJSON - J = Return JSON
 ;output: IMMUNIZE  - array of Immunization data, by reference
 ;        IMMUNIZEJ - JSON structure of Immunization data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Immunize -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=9000010.11 ;V IMMUNIZATION
 N FNBR2 S FNBR2=9000010.112 ;VIS OFFERED/GIVEN TO PATIENT
 N FNBR3 S FNBR3=9000010.113 ;OTHER DIAGNOSIS
 N FNBR4 S FNBR4=9000010.1182 ;DISCLOSED TO
 N FNBR5 S FNBR5=9000010.1111 ;REMARKS
 N FNBR6 S FNBR6=9000010.1126 ;SNOMED CT
 N FNBR7 S FNBR7=9000010.1127 ;LOINC CODES
 N IENS1 S IENS1=IMMUNIEN_","
 ;
 N IMMUNIZEARR,IMMUNIZEERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","IMMUNIZEARR","IMMUNIZEERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("IMMUNIZEARR")
 I $G(DEBUG),$D(IMMUNIZEERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("IMMUNIZEERR")
 I $D(IMMUNIZEERR) D  QUIT
 . S IMMUNIZE("Immunize","ERROR")=IMMUNIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.IMMUNIZE,.IMMUNIZEJ)
 N IMMUNE S IMMUNE=$NA(IMMUNIZE("Immunize"))
 S @IMMUNE@("immunizeIen")=IMMUNIEN
 S @IMMUNE@("resourceType")="Immunization"
 S @IMMUNE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,IMMUNIEN)
 S @IMMUNE@("immunization")=$G(IMMUNIZEARR(FNBR1,IENS1,.01,"E"))
 S @IMMUNE@("immunizationId")=$G(IMMUNIZEARR(FNBR1,IENS1,.01,"I"))
 S @IMMUNE@("patientName")=$G(IMMUNIZEARR(FNBR1,IENS1,.02,"E"))
 S @IMMUNE@("patientNameId")=$G(IMMUNIZEARR(FNBR1,IENS1,.02,"I"))
 S @IMMUNE@("patientICN")=$$GET1^DIQ(2,@IMMUNE@("patientNameId")_",",991.1)
 S @IMMUNE@("visit")=$G(IMMUNIZEARR(FNBR1,IENS1,.03,"E"))
 S @IMMUNE@("visitId")=$G(IMMUNIZEARR(FNBR1,IENS1,.03,"I"))
 S @IMMUNE@("visitFM")=$$GET1^DIQ(9000010,@IMMUNE@("visitId")_",",.01,"I")
 S @IMMUNE@("visitHL7")=$$FMTHL7^XLFDT(@IMMUNE@("visitFM"))
 S @IMMUNE@("visitFHIR")=$$FMTFHIR^SYNDHPUTL(@IMMUNE@("visitFM"))
 S @IMMUNE@("visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,@IMMUNE@("visitId"))
 S @IMMUNE@("location")=$$GET1^DIQ(9000010,@IMMUNE@("visitId"),.06)
 S @IMMUNE@("locationId")=$$GET1^DIQ(9000010,@IMMUNE@("visitId"),.06,"I")
 S @IMMUNE@("series")=$G(IMMUNIZEARR(FNBR1,IENS1,.04,"E"))
 S @IMMUNE@("seriesCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.04,"I"))
 S @IMMUNE@("lot")=$G(IMMUNIZEARR(FNBR1,IENS1,.05,"E"))
 S @IMMUNE@("lotId")=$G(IMMUNIZEARR(FNBR1,IENS1,.05,"I"))
 S @IMMUNE@("reaction")=$G(IMMUNIZEARR(FNBR1,IENS1,.06,"E"))
 S @IMMUNE@("reactionCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.06,"I"))
 S @IMMUNE@("contraindicated")=$G(IMMUNIZEARR(FNBR1,IENS1,.07,"E"))
 S @IMMUNE@("contraindicatedCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.07,"I"))
 S @IMMUNE@("doseOverride")=$G(IMMUNIZEARR(FNBR1,IENS1,.08,"E"))
 S @IMMUNE@("doseOverrideCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.08,"I"))
 S @IMMUNE@("injectionSite")=$G(IMMUNIZEARR(FNBR1,IENS1,.09,"E"))
 S @IMMUNE@("injectionSiteCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.09,"I"))
 S @IMMUNE@("volume")=$G(IMMUNIZEARR(FNBR1,IENS1,.11,"E"))
 S @IMMUNE@("dateOfVacInfoStatement")=$G(IMMUNIZEARR(FNBR1,IENS1,.12,"E"))
 S @IMMUNE@("dateOfVacInfoStatementFM")=$G(IMMUNIZEARR(FNBR1,IENS1,.12,"I"))
 S @IMMUNE@("dateOfVacInfoStatementHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,.12,"I")))
 S @IMMUNE@("dateOfVacInfoStatementFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,.12,"I")))
 S @IMMUNE@("createdByVCptEntry")=$G(IMMUNIZEARR(FNBR1,IENS1,.13,"E"))
 S @IMMUNE@("vacEligibility")=$G(IMMUNIZEARR(FNBR1,IENS1,.14,"E"))
 S @IMMUNE@("vacEligibilityId")=$G(IMMUNIZEARR(FNBR1,IENS1,.14,"I"))
 S @IMMUNE@("importFromOutsideRegistry")=$G(IMMUNIZEARR(FNBR1,IENS1,.15,"E"))
 S @IMMUNE@("importFromOutsideRegistryCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.15,"I"))
 S @IMMUNE@("ndc")=$G(IMMUNIZEARR(FNBR1,IENS1,.16,"E"))
 S @IMMUNE@("ndcId")=$G(IMMUNIZEARR(FNBR1,IENS1,.16,"I"))
 S @IMMUNE@("administrativeNotes")=$G(IMMUNIZEARR(FNBR1,IENS1,1,"E"))
 S @IMMUNE@("remarks")=""
 N Z S Z=""
 F  S Z=$O(IMMUNIZEARR(FNBR1,IENS1,1101,Z)) QUIT:'+Z  D
 . S @IMMUNE@("remarks")=@IMMUNE@("remarks")_$G(IMMUNIZEARR(FNBR1,IENS1,1101,Z))
 S @IMMUNE@("eventDateAndTime")=$G(IMMUNIZEARR(FNBR1,IENS1,1201,"E"))
 S @IMMUNE@("eventDateAndTimeFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1201,"I"))
 S @IMMUNE@("eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1201,"I")))
 S @IMMUNE@("eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1201,"I")))
 S @IMMUNE@("orderingProvider")=$G(IMMUNIZEARR(FNBR1,IENS1,1202,"E"))
 S @IMMUNE@("orderingProviderId")=$G(IMMUNIZEARR(FNBR1,IENS1,1202,"I"))
 S @IMMUNE@("orderingProviderNPI")=$$GET1^DIQ(200,@IMMUNE@("orderingProviderId")_",",41.99) ;NPI
 S @IMMUNE@("orderingProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@IMMUNE@("orderingProviderId"))
 S @IMMUNE@("clinic")=$G(IMMUNIZEARR(FNBR1,IENS1,1203,"E"))
 S @IMMUNE@("clinicId")=$G(IMMUNIZEARR(FNBR1,IENS1,1203,"I"))
 S @IMMUNE@("encounterProvider")=$G(IMMUNIZEARR(FNBR1,IENS1,1204,"E"))
 S @IMMUNE@("encounterProviderId")=$G(IMMUNIZEARR(FNBR1,IENS1,1204,"I"))
 S @IMMUNE@("encounterProviderNPI")=$$GET1^DIQ(200,@IMMUNE@("encounterProviderId")_",",41.99) ;NPI
 S @IMMUNE@("encounterProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@IMMUNE@("encounterProviderId"))
 S @IMMUNE@("dateTimeRecorded")=$G(IMMUNIZEARR(FNBR1,IENS1,1205,"E"))
 S @IMMUNE@("dateTimeRecordedFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1205,"I"))
 S @IMMUNE@("dateTimeRecordedHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1205,"I")))
 S @IMMUNE@("dateTimeRecordedFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1205,"I")))
 S @IMMUNE@("immunizationDocumenter")=$G(IMMUNIZEARR(FNBR1,IENS1,1206,"E"))
 S @IMMUNE@("immunizationDocumenterId")=$G(IMMUNIZEARR(FNBR1,IENS1,1206,"I"))
 S @IMMUNE@("lotNumber")=$G(IMMUNIZEARR(FNBR1,IENS1,1207,"E"))
 S @IMMUNE@("lotNumberId")=$G(IMMUNIZEARR(FNBR1,IENS1,1207,"I"))
 S @IMMUNE@("parent")=$G(IMMUNIZEARR(FNBR1,IENS1,1208,"E"))
 S @IMMUNE@("parentId")=$G(IMMUNIZEARR(FNBR1,IENS1,1208,"I"))
 S @IMMUNE@("externalKey")=$G(IMMUNIZEARR(FNBR1,IENS1,1209,"E"))
 S @IMMUNE@("outsideProviderName")=$G(IMMUNIZEARR(FNBR1,IENS1,1210,"E"))
 S @IMMUNE@("ancillaryPov")=$G(IMMUNIZEARR(FNBR1,IENS1,1213,"E"))
 S @IMMUNE@("ancillaryPovId")=$G(IMMUNIZEARR(FNBR1,IENS1,1213,"I"))
 S @IMMUNE@("userLastUpdate")=$G(IMMUNIZEARR(FNBR1,IENS1,1214,"E"))
 S @IMMUNE@("userLastUpdateId")=$G(IMMUNIZEARR(FNBR1,IENS1,1214,"I"))
 S @IMMUNE@("orderingLocation")=$G(IMMUNIZEARR(FNBR1,IENS1,1215,"E"))
 S @IMMUNE@("orderingLocationId")=$G(IMMUNIZEARR(FNBR1,IENS1,1215,"I"))
 S @IMMUNE@("dateTimeEntered")=$G(IMMUNIZEARR(FNBR1,IENS1,1216,"E"))
 S @IMMUNE@("dateTimeEnteredFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1216,"I"))
 S @IMMUNE@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1216,"I")))
 S @IMMUNE@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1216,"I")))
 S @IMMUNE@("enteredBy")=$G(IMMUNIZEARR(FNBR1,IENS1,1217,"E"))
 S @IMMUNE@("enteredById")=$G(IMMUNIZEARR(FNBR1,IENS1,1217,"I"))
 S @IMMUNE@("dateTimeLastModified")=$G(IMMUNIZEARR(FNBR1,IENS1,1218,"E"))
 S @IMMUNE@("dateTimeLastModifiedFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1218,"I"))
 S @IMMUNE@("dateTimeLastModifiedHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1218,"I")))
 S @IMMUNE@("dateTimeLastModifiedFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1218,"I")))
 S @IMMUNE@("lastModifiedBy")=$G(IMMUNIZEARR(FNBR1,IENS1,1219,"E"))
 S @IMMUNE@("lastModifiedById")=$G(IMMUNIZEARR(FNBR1,IENS1,1219,"I"))
 S @IMMUNE@("warningAcknowledged")=$G(IMMUNIZEARR(FNBR1,IENS1,1220,"E"))
 S @IMMUNE@("warningAcknowledgedCd")=$G(IMMUNIZEARR(FNBR1,IENS1,1220,"I"))
 S @IMMUNE@("timestamp")=$G(IMMUNIZEARR(FNBR1,IENS1,1221,"E"))
 S @IMMUNE@("timestampFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1221,"I"))
 S @IMMUNE@("timestampHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1221,"I")))
 S @IMMUNE@("timestampFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1221,"I")))
 S @IMMUNE@("eventInformationSource")=$G(IMMUNIZEARR(FNBR1,IENS1,1301,"E"))
 S @IMMUNE@("eventInformationSourceId")=$G(IMMUNIZEARR(FNBR1,IENS1,1301,"I"))
 S @IMMUNE@("routeOfAdministration")=$G(IMMUNIZEARR(FNBR1,IENS1,1302,"E"))
 S @IMMUNE@("routeOfAdministrationId")=$G(IMMUNIZEARR(FNBR1,IENS1,1302,"I"))
 S @IMMUNE@("siteOfAdministrationBody")=$G(IMMUNIZEARR(FNBR1,IENS1,1303,"E"))
 S @IMMUNE@("siteOfAdministrationBodyId")=$G(IMMUNIZEARR(FNBR1,IENS1,1303,"I"))
 S @IMMUNE@("primaryDiagnosis")=$G(IMMUNIZEARR(FNBR1,IENS1,1304,"E"))
 S @IMMUNE@("primaryDiagnosisId")=$G(IMMUNIZEARR(FNBR1,IENS1,1304,"I"))
 S @IMMUNE@("dose")=$G(IMMUNIZEARR(FNBR1,IENS1,1312,"E"))
 S @IMMUNE@("dosage")=$G(IMMUNIZEARR(FNBR1,IENS1,1312.5,"E"))
 S @IMMUNE@("doseUnits")=$G(IMMUNIZEARR(FNBR1,IENS1,1313,"E"))
 S @IMMUNE@("doseUnitsId")=$G(IMMUNIZEARR(FNBR1,IENS1,1313,"I"))
 S @IMMUNE@("results")=$G(IMMUNIZEARR(FNBR1,IENS1,1401,"E"))
 S @IMMUNE@("resultsCd")=$G(IMMUNIZEARR(FNBR1,IENS1,1401,"I"))
 S @IMMUNE@("reading")=$G(IMMUNIZEARR(FNBR1,IENS1,1402,"E"))
 S @IMMUNE@("dateTimeRead")=$G(IMMUNIZEARR(FNBR1,IENS1,1403,"E"))
 S @IMMUNE@("dateTimeReadFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1403,"I"))
 S @IMMUNE@("dateTimeReadHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1403,"I")))
 S @IMMUNE@("dateTimeReadFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1403,"I")))
 S @IMMUNE@("reader")=$G(IMMUNIZEARR(FNBR1,IENS1,1404,"E"))
 S @IMMUNE@("readerId")=$G(IMMUNIZEARR(FNBR1,IENS1,1404,"I"))
 S @IMMUNE@("readingRecorded")=$G(IMMUNIZEARR(FNBR1,IENS1,1405,"E"))
 S @IMMUNE@("readingRecordedFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1405,"I"))
 S @IMMUNE@("readingRecordedHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1405,"I")))
 S @IMMUNE@("readingRecordedFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1405,"I")))
 S @IMMUNE@("hoursReadPostInoculation")=$G(IMMUNIZEARR(FNBR1,IENS1,1406,"E"))
 S @IMMUNE@("readingComment")=$G(IMMUNIZEARR(FNBR1,IENS1,1501,"E"))
 S @IMMUNE@("warningOverrideReason")=$G(IMMUNIZEARR(FNBR1,IENS1,1601,"E"))
 S @IMMUNE@("editedFlag")=$G(IMMUNIZEARR(FNBR1,IENS1,80101,"E"))
 S @IMMUNE@("editedFlagCd")=$G(IMMUNIZEARR(FNBR1,IENS1,80101,"I"))
 S @IMMUNE@("auditTrail")=$G(IMMUNIZEARR(FNBR1,IENS1,80102,"E"))
 S @IMMUNE@("comments")=$G(IMMUNIZEARR(FNBR1,IENS1,81101,"E"))
 S @IMMUNE@("verified")=$G(IMMUNIZEARR(FNBR1,IENS1,81201,"E"))
 S @IMMUNE@("verifiedCd")=$G(IMMUNIZEARR(FNBR1,IENS1,81201,"I"))
 S @IMMUNE@("package")=$G(IMMUNIZEARR(FNBR1,IENS1,81202,"E"))
 S @IMMUNE@("packageId")=$G(IMMUNIZEARR(FNBR1,IENS1,81202,"I"))
 S @IMMUNE@("dataSource")=$G(IMMUNIZEARR(FNBR1,IENS1,81203,"E"))
 S @IMMUNE@("dataSourceId")=$G(IMMUNIZEARR(FNBR1,IENS1,81203,"I"))
 N OFFER
 N IENS2 S IENS2=""
 F  S IENS2=$O(IMMUNIZEARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . S OFFER=$NA(IMMUNIZE("Immunize","visOfferedGivenToPatients","visOfferedGivenToPatient",+IENS2))
 . S @OFFER@("visOfferedGivenToPatient")=$G(IMMUNIZEARR(FNBR2,IENS2,.01,"E"))
 . S @OFFER@("visOfferedGivenToPatientId")=$G(IMMUNIZEARR(FNBR2,IENS2,.01,"I"))
 . S @OFFER@("dateVisOfferedGiven")=$G(IMMUNIZEARR(FNBR2,IENS2,.02,"E"))
 . S @OFFER@("dateVisOfferedGivenFM")=$G(IMMUNIZEARR(FNBR2,IENS2,.02,"I"))
 . S @OFFER@("dateVisOfferedGivenHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR2,IENS2,.02,"I")))
 . S @OFFER@("dateVisOfferedGivenFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR2,IENS2,.02,"I")))
 . S @OFFER@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,IMMUNIEN,FNBR2_U_+IENS2)
 N OTHERDX
 N IENS3 S IENS3=""
 F  S IENS3=$O(IMMUNIZEARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . S OTHERDX=$NA(IMMUNIZE("Immunize","otherDiagnosiss","otherDiagnosis",+IENS3))
 . S @OTHERDX@("otherDiagnosis")=$G(IMMUNIZEARR(FNBR3,IENS3,.01,"E"))
 . S @OTHERDX@("otherDiagnosisId")=$G(IMMUNIZEARR(FNBR3,IENS3,.01,"I"))
 . S @OTHERDX@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,IMMUNIEN,FNBR3_U_+IENS3)
 N DISCLOSE
 N IENS4 S IENS4=""
 F  S IENS4=$O(IMMUNIZEARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . S DISCLOSE=$NA(IMMUNIZE("Immunize","disclosedTos","disclosedTo",+IENS4))
 . S @DISCLOSE@("agency")=$G(IMMUNIZEARR(FNBR4,IENS4,.01,"E"))
 . S @DISCLOSE@("agencyId")=$G(IMMUNIZEARR(FNBR4,IENS4,.01,"I"))
 . S @DISCLOSE@("disclosureDateTime")=$G(IMMUNIZEARR(FNBR4,IENS4,.02,"E"))
 . S @DISCLOSE@("disclosureDateTimeFM")=$G(IMMUNIZEARR(FNBR4,IENS4,.02,"I"))
 . S @DISCLOSE@("disclosureDateTimeHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR4,IENS4,.02,"I")))
 . S @DISCLOSE@("disclosureDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR4,IENS4,.02,"I")))
 . S @DISCLOSE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,IMMUNIEN,FNBR4_U_+IENS4)
 ;N IENS5 S IENS5="" ;Word processing field 1101 above
 ;F  S IENS5=$O(IMMUNIZEARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 ;. S IMMUNIZE("Immunize","remarkss","remarks",+IENS5,"remarks")=$G(IMMUNIZEARR(FNBR5,IENS5,.01,"E"))
 N SNOMED
 N IENS6 S IENS6=""
 F  S IENS6=$O(IMMUNIZEARR(FNBR6,IENS6)) QUIT:IENS6=""  D
 . S SNOMED=$NA(IMMUNIZE("Immunize","snomedCts","snomedCt",+IENS6))
 . S @SNOMED@("snomedCt")=$G(IMMUNIZEARR(FNBR6,IENS6,.01,"E"))
 . S @SNOMED@("snomedPreferredTerm")=$G(IMMUNIZEARR(FNBR6,IENS6,.019,"E"))
 . S @SNOMED@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,IMMUNIEN,FNBR6_U_+IENS6)
 N LOINC
 N IENS7 S IENS7=""
 F  S IENS7=$O(IMMUNIZEARR(FNBR7,IENS7)) QUIT:IENS7=""  D
 . S LOINC=$NA(IMMUNIZE("Immunize","loincCodess","loincCodes",+IENS7))
 . S @LOINC@("loincCodes")=$G(IMMUNIZEARR(FNBR7,IENS7,.01,"E"))
 . S @LOINC@("loincText")=$G(IMMUNIZEARR(FNBR7,IENS7,.019,"E"))
 . S @LOINC@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,IMMUNIEN,FNBR7_U_+IENS7)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("IMMUNIZE")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.IMMUNIZE,.IMMUNIZEJ)
 ;
 QUIT
 ;

SYNDHP13
SYNDHP13 ; HC/art - HealthConcourse - get visit and pov data ;08/27/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1VISIT(VISIT,VISITIEN,RETJSON,VISITJ) ;get one Visit record
 ;inputs: VISITIEN - Visit IEN
 ;        RETJSON - J = Return JSON
 ;output: VISIT  - array of Visit data, by reference
 ;        VISITJ - JSON structure of Visit data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Visit -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=9000010 ;VISIT
 N IENS1 S IENS1=VISITIEN_","
 N VISITARR,VISITERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VISITARR","VISITERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VISITARR")
 I $G(DEBUG),$D(VISITERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("VISITERR")
 I $D(VISITERR) D  QUIT
 . S VISIT("Visit","ERROR")=VISITIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VISIT,.VISITJ)
 S VISIT("Visit","visitIen")=VISITIEN
 S VISIT("Visit","resourceType")="Encounter"
 S VISIT("Visit","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VISITIEN)
 S VISIT("Visit","visitAdmitDateTime")=$G(VISITARR(FNBR1,IENS1,.01,"E"))
 S VISIT("Visit","visitAdmitDateTimeFM")=$G(VISITARR(FNBR1,IENS1,.01,"I"))
 S VISIT("Visit","visitAdmitDateTimeHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.01,"I")))
 S VISIT("Visit","visitAdmitDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.01,"I")))
 S VISIT("Visit","dateVisitCreated")=$G(VISITARR(FNBR1,IENS1,.02,"E"))
 S VISIT("Visit","dateVisitCreatedFM")=$G(VISITARR(FNBR1,IENS1,.02,"I"))
 S VISIT("Visit","dateVisitCreatedHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.02,"I")))
 S VISIT("Visit","dateVisitCreatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.02,"I")))
 S VISIT("Visit","type")=$G(VISITARR(FNBR1,IENS1,.03,"E"))
 S VISIT("Visit","typeCd")=$G(VISITARR(FNBR1,IENS1,.03,"I"))
 S VISIT("Visit","patientName")=$G(VISITARR(FNBR1,IENS1,.05,"E"))
 S VISIT("Visit","patientNameId")=$G(VISITARR(FNBR1,IENS1,.05,"I"))
 S VISIT("Visit","patientICN")=$$GET1^DIQ(2,VISIT("Visit","patientNameId")_",",991.1)
 S VISIT("Visit","locOfEncounter")=$G(VISITARR(FNBR1,IENS1,.06,"E"))
 S VISIT("Visit","locOfEncounterId")=$G(VISITARR(FNBR1,IENS1,.06,"I"))
 S VISIT("Visit","serviceCategory")=$G(VISITARR(FNBR1,IENS1,.07,"E"))
 S VISIT("Visit","serviceCategoryCd")=$G(VISITARR(FNBR1,IENS1,.07,"I"))
 S VISIT("Visit","dssId")=$G(VISITARR(FNBR1,IENS1,.08,"E"))
 S VISIT("Visit","dssIdId")=$G(VISITARR(FNBR1,IENS1,.08,"I"))
 S VISIT("Visit","dependentEntryCount")=$G(VISITARR(FNBR1,IENS1,.09,"E"))
 S VISIT("Visit","deleteFlag")=$G(VISITARR(FNBR1,IENS1,.11,"E"))
 S VISIT("Visit","deleteFlagCd")=$G(VISITARR(FNBR1,IENS1,.11,"I"))
 S VISIT("Visit","parentVisitLink")=$G(VISITARR(FNBR1,IENS1,.12,"E"))
 S VISIT("Visit","parentVisitLinkId")=$G(VISITARR(FNBR1,IENS1,.12,"I"))
 S VISIT("Visit","dateLastModified")=$G(VISITARR(FNBR1,IENS1,.13,"E"))
 S VISIT("Visit","dateLastModifiedFM")=$G(VISITARR(FNBR1,IENS1,.13,"I"))
 S VISIT("Visit","dateLastModifiedHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.13,"I")))
 S VISIT("Visit","dateLastModifiedFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.13,"I")))
 S VISIT("Visit","checkOutDateTime")=$G(VISITARR(FNBR1,IENS1,.18,"E"))
 S VISIT("Visit","checkOutDateTimeFM")=$G(VISITARR(FNBR1,IENS1,.18,"I"))
 S VISIT("Visit","checkOutDateTimeHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.18,"I")))
 S VISIT("Visit","checkOutDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.18,"I")))
 S VISIT("Visit","eligibility")=$G(VISITARR(FNBR1,IENS1,.21,"E"))
 S VISIT("Visit","eligibilityId")=$G(VISITARR(FNBR1,IENS1,.21,"I"))
 S VISIT("Visit","hospitalLocation")=$G(VISITARR(FNBR1,IENS1,.22,"E"))
 S VISIT("Visit","hospitalLocationId")=$G(VISITARR(FNBR1,IENS1,.22,"I"))
 S VISIT("Visit","createdByUser")=$G(VISITARR(FNBR1,IENS1,.23,"E"))
 S VISIT("Visit","createdByUserId")=$G(VISITARR(FNBR1,IENS1,.23,"I"))
 S VISIT("Visit","optionUsedToCreate")=$G(VISITARR(FNBR1,IENS1,.24,"E"))
 S VISIT("Visit","optionUsedToCreateId")=$G(VISITARR(FNBR1,IENS1,.24,"I"))
 S VISIT("Visit","protocol")=$G(VISITARR(FNBR1,IENS1,.25,"E"))
 S VISIT("Visit","protocolId")=$G(VISITARR(FNBR1,IENS1,.25,"I"))
 S VISIT("Visit","pfssAccountReference")=$G(VISITARR(FNBR1,IENS1,.26,"E"))
 S VISIT("Visit","pfssAccountReferenceId")=$G(VISITARR(FNBR1,IENS1,.26,"I"))
 S VISIT("Visit","outsideLocation")=$G(VISITARR(FNBR1,IENS1,2101,"E"))
 S VISIT("Visit","visitId")=$G(VISITARR(FNBR1,IENS1,15001,"E"))
 S VISIT("Visit","patientStatusInOut")=$G(VISITARR(FNBR1,IENS1,15002,"E"))
 S VISIT("Visit","patientStatusInOutCd")=$G(VISITARR(FNBR1,IENS1,15002,"I"))
 S VISIT("Visit","encounterType")=$G(VISITARR(FNBR1,IENS1,15003,"E"))
 S VISIT("Visit","encounterTypeCd")=$G(VISITARR(FNBR1,IENS1,15003,"I"))
 S VISIT("Visit","serviceConnected")=$G(VISITARR(FNBR1,IENS1,80001,"E"))
 S VISIT("Visit","serviceConnectedCd")=$G(VISITARR(FNBR1,IENS1,80001,"I"))
 S VISIT("Visit","agentOrangeExposure")=$G(VISITARR(FNBR1,IENS1,80002,"E"))
 S VISIT("Visit","agentOrangeExposureCd")=$G(VISITARR(FNBR1,IENS1,80002,"I"))
 S VISIT("Visit","ionizingRadiationExposure")=$G(VISITARR(FNBR1,IENS1,80003,"E"))
 S VISIT("Visit","ionizingRadiationExposureCd")=$G(VISITARR(FNBR1,IENS1,80003,"I"))
 S VISIT("Visit","swAsiaConditions")=$G(VISITARR(FNBR1,IENS1,80004,"E"))
 S VISIT("Visit","swAsiaConditionsCd")=$G(VISITARR(FNBR1,IENS1,80004,"I"))
 S VISIT("Visit","militarySexualTrauma")=$G(VISITARR(FNBR1,IENS1,80005,"E"))
 S VISIT("Visit","militarySexualTraumaCd")=$G(VISITARR(FNBR1,IENS1,80005,"I"))
 S VISIT("Visit","headAndOrNeckCancer")=$G(VISITARR(FNBR1,IENS1,80006,"E"))
 S VISIT("Visit","headAndOrNeckCancerCd")=$G(VISITARR(FNBR1,IENS1,80006,"I"))
 S VISIT("Visit","combatVeteran")=$G(VISITARR(FNBR1,IENS1,80007,"E"))
 S VISIT("Visit","combatVeteranCd")=$G(VISITARR(FNBR1,IENS1,80007,"I"))
 S VISIT("Visit","proj112Shad")=$G(VISITARR(FNBR1,IENS1,80008,"E"))
 S VISIT("Visit","proj112ShadCd")=$G(VISITARR(FNBR1,IENS1,80008,"I"))
 S VISIT("Visit","serviceConnectionEditFlag")=$G(VISITARR(FNBR1,IENS1,80011,"E"))
 S VISIT("Visit","serviceConnectionEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80011,"I"))
 S VISIT("Visit","agentOrangeEditFlag")=$G(VISITARR(FNBR1,IENS1,80012,"E"))
 S VISIT("Visit","agentOrangeEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80012,"I"))
 S VISIT("Visit","ionizingRadiationEditFlag")=$G(VISITARR(FNBR1,IENS1,80013,"E"))
 S VISIT("Visit","ionizingRadiationEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80013,"I"))
 S VISIT("Visit","swAsiaConditionsEditFlag")=$G(VISITARR(FNBR1,IENS1,80014,"E"))
 S VISIT("Visit","swAsiaConditionsEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80014,"I"))
 S VISIT("Visit","mstEditFlag")=$G(VISITARR(FNBR1,IENS1,80015,"E"))
 S VISIT("Visit","mstEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80015,"I"))
 S VISIT("Visit","headAndNeckCancerEditFlag")=$G(VISITARR(FNBR1,IENS1,80016,"E"))
 S VISIT("Visit","headAndNeckCancerEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80016,"I"))
 S VISIT("Visit","combatVeteranEditFlag")=$G(VISITARR(FNBR1,IENS1,80017,"E"))
 S VISIT("Visit","combatVeteranEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80017,"I"))
 S VISIT("Visit","proj112ShadEditFlag")=$G(VISITARR(FNBR1,IENS1,80018,"E"))
 S VISIT("Visit","proj112ShadEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80018,"I"))
 S VISIT("Visit","comments")=$G(VISITARR(FNBR1,IENS1,81101,"E"))
 S VISIT("Visit","package")=$G(VISITARR(FNBR1,IENS1,81202,"E"))
 S VISIT("Visit","packageId")=$G(VISITARR(FNBR1,IENS1,81202,"I"))
 S VISIT("Visit","dataSource")=$G(VISITARR(FNBR1,IENS1,81203,"E"))
 S VISIT("Visit","dataSourceId")=$G(VISITARR(FNBR1,IENS1,81203,"I"))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VISIT")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VISIT,.VISITJ)
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1VPOV(VPOV,VPOVIEN,RETJSON,VPOVJ) ;get one V POV record
 ;inputs: VPOVIEN - Vpov IEN
 ;        RETJSON - J = Return JSON
 ;output: VPOV  - array of V POV data, by reference
 ;        VPOVJ - JSON structure of V POV data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- V POV -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=9000010.07 ;V POV
 N IENS1 S IENS1=VPOVIEN_","
 N VPOVARR,VPOVERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VPOVARR","VPOVERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VPOVARR")
 I $G(DEBUG),$D(VPOVERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("VPOVERR")
 I $D(VPOVERR) D  QUIT
 . S VPOV("V POV","ERROR")=VPOVIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPOV,.VPOVJ)
 S VPOV("V POV","vpovIen")=VPOVIEN
 S VPOV("V POV","resourceType")="Encounter"
 S VPOV("V POV","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VPOVIEN)
 S VPOV("V POV","pov")=$G(VPOVARR(FNBR1,IENS1,.01,"E"))
 S VPOV("V POV","povId")=$G(VPOVARR(FNBR1,IENS1,.01,"I"))
 S VPOV("V POV","povDesc")=$P($$ICDDX^ICDEX(VPOV("V POV","pov")),U,4)
 S VPOV("V POV","icdNarrative")=$G(VPOVARR(FNBR1,IENS1,.019,"E"))
 S VPOV("V POV","patientName")=$G(VPOVARR(FNBR1,IENS1,.02,"E"))
 S VPOV("V POV","patientNameId")=$G(VPOVARR(FNBR1,IENS1,.02,"I"))
 S VPOV("V POV","patientICN")=$$GET1^DIQ(2,VPOV("V POV","patientNameId")_",",991.1)
 S VPOV("V POV","visit")=$G(VPOVARR(FNBR1,IENS1,.03,"E"))
 S VPOV("V POV","visitId")=$G(VPOVARR(FNBR1,IENS1,.03,"I"))
 S VPOV("V POV","visitFM")=$$GET1^DIQ(9000010,VPOV("V POV","visitId")_",",.01,"I")
 S VPOV("V POV","visitHL7")=$$FMTHL7^XLFDT(VPOV("V POV","visitFM"))
 S VPOV("V POV","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VPOV("V POV","visitFM"))
 S VPOV("V POV","visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,VPOV("V POV","visitId"))
 S VPOV("V POV","providerNarrative")=$G(VPOVARR(FNBR1,IENS1,.04,"E"))
 S VPOV("V POV","providerNarrativeId")=$G(VPOVARR(FNBR1,IENS1,.04,"I"))
 S VPOV("V POV","modifier")=$G(VPOVARR(FNBR1,IENS1,.06,"E"))
 S VPOV("V POV","modifierCd")=$G(VPOVARR(FNBR1,IENS1,.06,"I"))
 S VPOV("V POV","primarySecondary")=$G(VPOVARR(FNBR1,IENS1,.12,"E"))
 S VPOV("V POV","primarySecondaryCd")=$G(VPOVARR(FNBR1,IENS1,.12,"I"))
 S VPOV("V POV","dateOfInjury")=$G(VPOVARR(FNBR1,IENS1,.13,"E"))
 S VPOV("V POV","dateOfInjuryFM")=$G(VPOVARR(FNBR1,IENS1,.13,"I"))
 S VPOV("V POV","dateOfInjuryHL7")=$$FMTHL7^XLFDT($G(VPOVARR(FNBR1,IENS1,.13,"I")))
 S VPOV("V POV","dateOfInjuryFHIR")=$$FMTFHIR^SYNDHPUTL($G(VPOVARR(FNBR1,IENS1,.13,"I")))
 S VPOV("V POV","clinicalTerm")=$G(VPOVARR(FNBR1,IENS1,.15,"E"))
 S VPOV("V POV","clinicalTermId")=$G(VPOVARR(FNBR1,IENS1,.15,"I"))
 S VPOV("V POV","problemListEntry")=$G(VPOVARR(FNBR1,IENS1,.16,"E"))
 S VPOV("V POV","problemListEntryId")=$G(VPOVARR(FNBR1,IENS1,.16,"I"))
 S VPOV("V POV","orderingResulting")=$G(VPOVARR(FNBR1,IENS1,.17,"E"))
 S VPOV("V POV","orderingResultingCd")=$G(VPOVARR(FNBR1,IENS1,.17,"I"))
 S VPOV("V POV","mappedSource")=$G(VPOVARR(FNBR1,IENS1,300,"E"))
 S VPOV("V POV","eventDateAndTime")=$G(VPOVARR(FNBR1,IENS1,1201,"E"))
 S VPOV("V POV","eventDateAndTimeFM")=$G(VPOVARR(FNBR1,IENS1,1201,"I"))
 S VPOV("V POV","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VPOVARR(FNBR1,IENS1,1201,"I")))
 S VPOV("V POV","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VPOVARR(FNBR1,IENS1,1201,"I")))
 S VPOV("V POV","orderingProvider")=$G(VPOVARR(FNBR1,IENS1,1202,"E"))
 S VPOV("V POV","orderingProviderId")=$G(VPOVARR(FNBR1,IENS1,1202,"I"))
 S VPOV("V POV","orderingProviderNPI")=$$GET1^DIQ(200,VPOV("V POV","orderingProviderId")_",",41.99) ;NPI
 S VPOV("V POV","orderingProviderResId")=$$RESID^SYNDHP69("V",SITE,200,VPOV("V POV","orderingProviderId"))
 S VPOV("V POV","encounterProvider")=$G(VPOVARR(FNBR1,IENS1,1204,"E"))
 S VPOV("V POV","encounterProviderId")=$G(VPOVARR(FNBR1,IENS1,1204,"I"))
 S VPOV("V POV","encounterProviderNPI")=$$GET1^DIQ(200,VPOV("V POV","encounterProviderId")_",",41.99) ;NPI
 S VPOV("V POV","encounterProviderResId")=$$RESID^SYNDHP69("V",SITE,200,VPOV("V POV","encounterProviderId"))
 S VPOV("V POV","serviceConnected")=$G(VPOVARR(FNBR1,IENS1,80001,"E"))
 S VPOV("V POV","serviceConnectedCd")=$G(VPOVARR(FNBR1,IENS1,80001,"I"))
 S VPOV("V POV","agentOrangeExposure")=$G(VPOVARR(FNBR1,IENS1,80002,"E"))
 S VPOV("V POV","agentOrangeExposureCd")=$G(VPOVARR(FNBR1,IENS1,80002,"I"))
 S VPOV("V POV","ionizingRadiationExposure")=$G(VPOVARR(FNBR1,IENS1,80003,"E"))
 S VPOV("V POV","ionizingRadiationExposureCd")=$G(VPOVARR(FNBR1,IENS1,80003,"I"))
 S VPOV("V POV","swAsiaConditions")=$G(VPOVARR(FNBR1,IENS1,80004,"E"))
 S VPOV("V POV","swAsiaConditionsCd")=$G(VPOVARR(FNBR1,IENS1,80004,"I"))
 S VPOV("V POV","militarySexualTrauma")=$G(VPOVARR(FNBR1,IENS1,80005,"E"))
 S VPOV("V POV","militarySexualTraumaCd")=$G(VPOVARR(FNBR1,IENS1,80005,"I"))
 S VPOV("V POV","headAndOrNeckCancer")=$G(VPOVARR(FNBR1,IENS1,80006,"E"))
 S VPOV("V POV","headAndOrNeckCancerCd")=$G(VPOVARR(FNBR1,IENS1,80006,"I"))
 S VPOV("V POV","combatVeteran")=$G(VPOVARR(FNBR1,IENS1,80007,"E"))
 S VPOV("V POV","combatVeteranCd")=$G(VPOVARR(FNBR1,IENS1,80007,"I"))
 S VPOV("V POV","proj112Shad")=$G(VPOVARR(FNBR1,IENS1,80008,"E"))
 S VPOV("V POV","proj112ShadCd")=$G(VPOVARR(FNBR1,IENS1,80008,"I"))
 S VPOV("V POV","editedFlag")=$G(VPOVARR(FNBR1,IENS1,80101,"E"))
 S VPOV("V POV","editedFlagCd")=$G(VPOVARR(FNBR1,IENS1,80101,"I"))
 S VPOV("V POV","auditTrail")=$G(VPOVARR(FNBR1,IENS1,80102,"E"))
 S VPOV("V POV","providerNarrativeCategory")=$G(VPOVARR(FNBR1,IENS1,80201,"E"))
 S VPOV("V POV","providerNarrativeCategoryId")=$G(VPOVARR(FNBR1,IENS1,80201,"I"))
 S VPOV("V POV","comments")=$G(VPOVARR(FNBR1,IENS1,81101,"E"))
 S VPOV("V POV","verified")=$G(VPOVARR(FNBR1,IENS1,81201,"E"))
 S VPOV("V POV","verifiedCd")=$G(VPOVARR(FNBR1,IENS1,81201,"I"))
 S VPOV("V POV","package")=$G(VPOVARR(FNBR1,IENS1,81202,"E"))
 S VPOV("V POV","packageId")=$G(VPOVARR(FNBR1,IENS1,81202,"I"))
 S VPOV("V POV","dataSource")=$G(VPOVARR(FNBR1,IENS1,81203,"E"))
 S VPOV("V POV","dataSourceId")=$G(VPOVARR(FNBR1,IENS1,81203,"I"))
 ;
 ;get SCT code
 N MAPPING S MAPPING=$S(VPOV("V POV","visitFM")>3150930:"sct2icd",1:"sct2icdnine")
 N SNOMED S SNOMED=$$MAP^SYNDHPMP(MAPPING,VPOV("V POV","pov"),"I")
 S VPOV("V POV","povSCT")=$S(+SNOMED=-1:"",1:$P(SNOMED,U,2))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VPOV")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPOV,.VPOVJ)
 ;
 QUIT
 ;

SYNDHP14
SYNDHP14 ; HC/art - HealthConcourse - get visit data ;08/27/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1VSCODE(VSCODE,VSCODEIEN,RETJSON,VSCODEJ) ;get one V Standard Codes record
 ;inputs: VSCODEIEN - V Standard Codes IEN
 ;        RETJSON - J = Return JSON
 ;output: VSCODE  - array of V Standard Codes data, by reference
 ;        VSCODEJ - JSON structure of V Standard Codes data, by reference
 ;
 I $G(DEBUG) W !,"V Standard Codes",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=9000010.71 ;V STANDARD CODES
 N IENS1 S IENS1=VSCODEIEN_","
 ;
 N VSCODEARR,VSCODEERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VSCODEARR","VSCODEERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VSCODEARR")
 I $G(DEBUG),$D(VSCODEERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("VSCODEERR")
 I $D(VSCODEERR) S VSCODE("Vscode","ERROR")=VSCODEIEN QUIT
 I $D(VSCODEERR) D  QUIT
 . S VSCODE("Vscode","ERROR")=VSCODEIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VSCODE,.VSCODEJ)
 S VSCODE("Vscode","vscodeIen")=VSCODEIEN
 S VSCODE("Vscode","resourceType")="Procedure"
 S VSCODE("Vscode","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VSCODEIEN)
 S VSCODE("Vscode","code")=$G(VSCODEARR(FNBR1,IENS1,.01,"E"))
 S VSCODE("Vscode","patientName")=$G(VSCODEARR(FNBR1,IENS1,.02,"E"))
 S VSCODE("Vscode","patientNameId")=$G(VSCODEARR(FNBR1,IENS1,.02,"I"))
 S VSCODE("Vscode","patientICN")=$$GET1^DIQ(2,VSCODE("Vscode","patientNameId")_",",991.1)
 S VSCODE("Vscode","visit")=$G(VSCODEARR(FNBR1,IENS1,.03,"E"))
 S VSCODE("Vscode","visitId")=$G(VSCODEARR(FNBR1,IENS1,.03,"I"))
 S VSCODE("Vscode","visitFM")=$$GET1^DIQ(9000010,VSCODE("Vscode","visitId")_",",.01,"I")
 S VSCODE("Vscode","visitHL7")=$$FMTHL7^XLFDT(VSCODE("Vscode","visitFM"))
 S VSCODE("Vscode","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VSCODE("Vscode","visitFM"))
 S VSCODE("Vscode","visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,VSCODE("Vscode","visitId"))
 S VSCODE("Vscode","codingSystem")=$G(VSCODEARR(FNBR1,IENS1,.05,"E"))
 S VSCODE("Vscode","problemListEntry")=$G(VSCODEARR(FNBR1,IENS1,.06,"E"))
 S VSCODE("Vscode","problemListEntryId")=$G(VSCODEARR(FNBR1,IENS1,.06,"I"))
 S VSCODE("Vscode","magnitude")=$G(VSCODEARR(FNBR1,IENS1,220,"E"))
 S VSCODE("Vscode","ucumCode")=$G(VSCODEARR(FNBR1,IENS1,221,"E"))
 S VSCODE("Vscode","ucumCodeId")=$G(VSCODEARR(FNBR1,IENS1,221,"I"))
 S VSCODE("Vscode","mappedSource")=$G(VSCODEARR(FNBR1,IENS1,300,"E"))
 S VSCODE("Vscode","eventDateAndTime")=$G(VSCODEARR(FNBR1,IENS1,1201,"E"))
 S VSCODE("Vscode","eventDateAndTimeFM")=$G(VSCODEARR(FNBR1,IENS1,1201,"I"))
 S VSCODE("Vscode","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VSCODEARR(FNBR1,IENS1,1201,"I")))
 S VSCODE("Vscode","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VSCODEARR(FNBR1,IENS1,1201,"I")))
 S VSCODE("Vscode","orderingProvider")=$G(VSCODEARR(FNBR1,IENS1,1202,"E"))
 S VSCODE("Vscode","orderingProviderId")=$G(VSCODEARR(FNBR1,IENS1,1202,"I"))
 S VSCODE("Vscode","orderingProviderNPI")=$$GET1^DIQ(200,VSCODE("Vscode","orderingProviderId")_",",41.99) ;NPI
 S VSCODE("Vscode","orderingProviderResId")=$$RESID^SYNDHP69("V",SITE,200,VSCODE("Vscode","orderingProviderId"))
 S VSCODE("Vscode","encounterProvider")=$G(VSCODEARR(FNBR1,IENS1,1204,"E"))
 S VSCODE("Vscode","encounterProviderId")=$G(VSCODEARR(FNBR1,IENS1,1204,"I"))
 S VSCODE("Vscode","encounterProviderNPI")=$$GET1^DIQ(200,VSCODE("Vscode","encounterProviderId")_",",41.99) ;NPI
 S VSCODE("Vscode","encounterProviderResId")=$$RESID^SYNDHP69("V",SITE,200,VSCODE("Vscode","encounterProviderId"))
 S VSCODE("Vscode","editedFlag")=$G(VSCODEARR(FNBR1,IENS1,80101,"E"))
 S VSCODE("Vscode","editedFlagCd")=$G(VSCODEARR(FNBR1,IENS1,80101,"I"))
 S VSCODE("Vscode","auditTrail")=$G(VSCODEARR(FNBR1,IENS1,80102,"E"))
 S VSCODE("Vscode","comments")=$G(VSCODEARR(FNBR1,IENS1,81101,"E"))
 S VSCODE("Vscode","verified")=$G(VSCODEARR(FNBR1,IENS1,81201,"E"))
 S VSCODE("Vscode","verifiedCd")=$G(VSCODEARR(FNBR1,IENS1,81201,"I"))
 S VSCODE("Vscode","package")=$G(VSCODEARR(FNBR1,IENS1,81202,"E"))
 S VSCODE("Vscode","packageId")=$G(VSCODEARR(FNBR1,IENS1,81202,"I"))
 S VSCODE("Vscode","dataSource")=$G(VSCODEARR(FNBR1,IENS1,81203,"E"))
 S VSCODE("Vscode","dataSourceId")=$G(VSCODEARR(FNBR1,IENS1,81203,"I"))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VSCODE")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VSCODE,.VSCODEJ)
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1VCPT(VCPT,VCPTIEN,RETJSON,VCPTJ) ;get one V CPT record
 ;inputs: VCPTIEN - V CPT IEN
 ;        RETJSON - J = Return JSON
 ;output: VCPT  - array of V CPT data, by reference
 ;        VCPTJ - JSON structure of V CPT data, by reference
 ;
 I $G(DEBUG) W !,"V CPT",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=9000010.18 ;V CPT
 N FNBR2 S FNBR2=9000010.181 ;CPT MODIFIER
 N IENS1 S IENS1=VCPTIEN_","
 ;
 N VCPTARR,VCPTERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VCPTARR","VCPTERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VCPTARR")
 I $G(DEBUG),$D(VCPTERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("VCPTERR")
 I $D(VCPTERR) D  QUIT
 . S VCPT("Vcpt","ERROR")=VCPTIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VCPT,.VCPTJ)
 S VCPT("Vcpt","vcptIen")=VCPTIEN
 S VCPT("Vcpt","resourceType")="Procedure"
 S VCPT("Vcpt","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VCPTIEN)
 S VCPT("Vcpt","cpt")=$G(VCPTARR(FNBR1,IENS1,.01,"E"))
 S VCPT("Vcpt","cptId")=$G(VCPTARR(FNBR1,IENS1,.01,"I"))
 S VCPT("Vcpt","cptName")=$$GET1^DIQ(81,VCPT("Vcpt","cptId")_",",2)
 S VCPT("Vcpt","patientName")=$G(VCPTARR(FNBR1,IENS1,.02,"E"))
 S VCPT("Vcpt","patientNameId")=$G(VCPTARR(FNBR1,IENS1,.02,"I"))
 S VCPT("Vcpt","patientICN")=$$GET1^DIQ(2,VCPT("Vcpt","patientNameId")_",",991.1)
 S VCPT("Vcpt","visit")=$G(VCPTARR(FNBR1,IENS1,.03,"E"))
 S VCPT("Vcpt","visitId")=$G(VCPTARR(FNBR1,IENS1,.03,"I"))
 S VCPT("Vcpt","visitFM")=$$GET1^DIQ(9000010,VCPT("Vcpt","visitId")_",",.01,"I")
 S VCPT("Vcpt","visitHL7")=$$FMTHL7^XLFDT(VCPT("Vcpt","visitFM"))
 S VCPT("Vcpt","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VCPT("Vcpt","visitFM"))
 S VCPT("Vcpt","visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,VCPT("Vcpt","visitId"))
 S VCPT("Vcpt","providerNarrative")=$G(VCPTARR(FNBR1,IENS1,.04,"E"))
 S VCPT("Vcpt","providerNarrativeId")=$G(VCPTARR(FNBR1,IENS1,.04,"I"))
 S VCPT("Vcpt","diagnosis")=$G(VCPTARR(FNBR1,IENS1,.05,"E"))
 S VCPT("Vcpt","diagnosisId")=$G(VCPTARR(FNBR1,IENS1,.05,"I"))
 S VCPT("Vcpt","principalProcedure")=$G(VCPTARR(FNBR1,IENS1,.07,"E"))
 S VCPT("Vcpt","principalProcedureCd")=$G(VCPTARR(FNBR1,IENS1,.07,"I"))
 S VCPT("Vcpt","diagnosis2")=$G(VCPTARR(FNBR1,IENS1,.09,"E"))
 S VCPT("Vcpt","diagnosis2Id")=$G(VCPTARR(FNBR1,IENS1,.09,"I"))
 S VCPT("Vcpt","diagnosis3")=$G(VCPTARR(FNBR1,IENS1,.1,"E"))
 S VCPT("Vcpt","diagnosis3Id")=$G(VCPTARR(FNBR1,IENS1,.1,"I"))
 S VCPT("Vcpt","diagnosis4")=$G(VCPTARR(FNBR1,IENS1,.11,"E"))
 S VCPT("Vcpt","diagnosis4Id")=$G(VCPTARR(FNBR1,IENS1,.11,"I"))
 S VCPT("Vcpt","diagnosis5")=$G(VCPTARR(FNBR1,IENS1,.12,"E"))
 S VCPT("Vcpt","diagnosis5Id")=$G(VCPTARR(FNBR1,IENS1,.12,"I"))
 S VCPT("Vcpt","diagnosis6")=$G(VCPTARR(FNBR1,IENS1,.13,"E"))
 S VCPT("Vcpt","diagnosis6Id")=$G(VCPTARR(FNBR1,IENS1,.13,"I"))
 S VCPT("Vcpt","diagnosis7")=$G(VCPTARR(FNBR1,IENS1,.14,"E"))
 S VCPT("Vcpt","diagnosis7Id")=$G(VCPTARR(FNBR1,IENS1,.14,"I"))
 S VCPT("Vcpt","diagnosis8")=$G(VCPTARR(FNBR1,IENS1,.15,"E"))
 S VCPT("Vcpt","diagnosis8Id")=$G(VCPTARR(FNBR1,IENS1,.15,"I"))
 S VCPT("Vcpt","quantity")=$G(VCPTARR(FNBR1,IENS1,.16,"E"))
 S VCPT("Vcpt","orderReference")=$G(VCPTARR(FNBR1,IENS1,.17,"E"))
 S VCPT("Vcpt","orderReferenceId")=$G(VCPTARR(FNBR1,IENS1,.17,"I"))
 S VCPT("Vcpt","departmentCode")=$G(VCPTARR(FNBR1,IENS1,.19,"E"))
 S VCPT("Vcpt","pfssChargeId")=$G(VCPTARR(FNBR1,IENS1,.2,"E"))
 S VCPT("Vcpt","mappedSource")=$G(VCPTARR(FNBR1,IENS1,300,"E"))
 S VCPT("Vcpt","eventDateAndTime")=$G(VCPTARR(FNBR1,IENS1,1201,"E"))
 S VCPT("Vcpt","eventDateAndTimeFM")=$G(VCPTARR(FNBR1,IENS1,1201,"I"))
 S VCPT("Vcpt","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VCPTARR(FNBR1,IENS1,1201,"I")))
 S VCPT("Vcpt","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VCPTARR(FNBR1,IENS1,1201,"I")))
 S VCPT("Vcpt","orderingProvider")=$G(VCPTARR(FNBR1,IENS1,1202,"E"))
 S VCPT("Vcpt","orderingProviderId")=$G(VCPTARR(FNBR1,IENS1,1202,"I"))
 S VCPT("Vcpt","orderingProviderNPI")=$$GET1^DIQ(200,VCPT("Vcpt","orderingProviderId")_",",41.99) ;NPI
 S VCPT("Vcpt","orderingProviderResId")=$$RESID^SYNDHP69("V",SITE,200,VCPT("Vcpt","orderingProviderId"))
 S VCPT("Vcpt","encounterProvider")=$G(VCPTARR(FNBR1,IENS1,1204,"E"))
 S VCPT("Vcpt","encounterProviderId")=$G(VCPTARR(FNBR1,IENS1,1204,"I"))
 S VCPT("Vcpt","encounterProviderNPI")=$$GET1^DIQ(200,VCPT("Vcpt","encounterProviderId")_",",41.99) ;NPI
 S VCPT("Vcpt","encounterProviderResId")=$$RESID^SYNDHP69("V",SITE,200,VCPT("Vcpt","encounterProviderId"))
 S VCPT("Vcpt","editedFlag")=$G(VCPTARR(FNBR1,IENS1,80101,"E"))
 S VCPT("Vcpt","editedFlagCd")=$G(VCPTARR(FNBR1,IENS1,80101,"I"))
 S VCPT("Vcpt","auditTrail")=$G(VCPTARR(FNBR1,IENS1,80102,"E"))
 S VCPT("Vcpt","providerNarrativeCategory")=$G(VCPTARR(FNBR1,IENS1,80201,"E"))
 S VCPT("Vcpt","providerNarrativeCategoryId")=$G(VCPTARR(FNBR1,IENS1,80201,"I"))
 S VCPT("Vcpt","comments")=$G(VCPTARR(FNBR1,IENS1,81101,"E"))
 S VCPT("Vcpt","verified")=$G(VCPTARR(FNBR1,IENS1,81201,"E"))
 S VCPT("Vcpt","verifiedCd")=$G(VCPTARR(FNBR1,IENS1,81201,"I"))
 S VCPT("Vcpt","package")=$G(VCPTARR(FNBR1,IENS1,81202,"E"))
 S VCPT("Vcpt","packageId")=$G(VCPTARR(FNBR1,IENS1,81202,"I"))
 S VCPT("Vcpt","dataSource")=$G(VCPTARR(FNBR1,IENS1,81203,"E"))
 S VCPT("Vcpt","dataSourceId")=$G(VCPTARR(FNBR1,IENS1,81203,"I"))
 N CPTMOD
 N IENS2 S IENS2=""
 F  S IENS2=$O(VCPTARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . S CPTMOD=$NA(VCPT("Vcpt","cptModifiers","cptModifier",+IENS2))
 . S @CPTMOD@("cptModifier")=$G(VCPTARR(FNBR2,IENS2,.01,"E"))
 . S @CPTMOD@("cptModifierId")=$G(VCPTARR(FNBR2,IENS2,.01,"I"))
 . S @CPTMOD@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VCPTIEN,FNBR2_U_+IENS2)
 ;
 ;LOOKUP SNOMED(sct) - cpt, os5
 S SCT=""
 ;map cpt to snomed (currently uses very small map)
 I VCPT("Vcpt","cpt")'="" D
 . S SCT=$$MAP^SYNDHPMP("sct2cpt",VCPT("Vcpt","cpt"),"I")
 . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 ;if no cpt hit, map os5 to snomed
 I SCT="",VCPT("Vcpt","cpt")'="" D
 . S SCT=$$MAP^SYNDHPMP("sct2os5",VCPT("Vcpt","cpt"),"I")
 . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 S VCPT("Vcpt","sct")=SCT
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VCPT")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VCPT,.VCPTJ)
 ;
 QUIT
 ;

SYNDHP15
SYNDHP15 ; HC/art - HealthConcourse - get care plan data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1HLF(HLFACT,HLFIEN,CP,RETJSON,HLFACTJ) ;get one Health Factor
 ;inputs: HLFIEN - Health Factor IEN
 ;        CP     - 0=get all records
 ;                 1= + SYN care plan data elements
 ;        RETJSON - J or F = Return JSON
 ;output: HLFACT  - array of Health Factor data, by reference
 ;        HLFACTJ - JSON structure of Health Factor data, by reference
 ;
 I $G(DEBUG) W !,"----------------------------- Health Factor -----------------------------",!
 N FNBR1 S FNBR1=9000010.23 ;V HEALTH FACTORS
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N IENS S IENS=HLFIEN_","
 N HLFARR,HLFERR
 D GETS^DIQ(FNBR1,IENS,"**","EI","HLFARR","HLFERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HLFARR")
 I $G(DEBUG),$D(HLFERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("HLFERR")
 I $D(HLFERR) D  QUIT
 . S HLFACT("HealthFactor","ERROR")=HLFIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.HLFACT,.HLFACTJ)
 N HLFACTOR S HLFACTOR=$NA(HLFACT("HealthFactor"))
 S @HLFACTOR@("hlfIen")=HLFIEN
 S @HLFACTOR@("resourceType")="HealthFactor"
 S @HLFACTOR@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,HLFIEN)
 S @HLFACTOR@("visitId")=$G(HLFARR(FNBR1,IENS,.03,"I"))
 S @HLFACTOR@("visit")=$G(HLFARR(FNBR1,IENS,.03,"E"))
 S @HLFACTOR@("visitFM")=$$GET1^DIQ(9000010,@HLFACTOR@("visitId")_",",.01,"I")
 S @HLFACTOR@("visitHL7")=$$FMTHL7^XLFDT(@HLFACTOR@("visitFM"))
 S @HLFACTOR@("visitFHIR")=$$FMTFHIR^SYNDHPUTL(@HLFACTOR@("visitFM"))
 S @HLFACTOR@("visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,@HLFACTOR@("visitId"))
 S @HLFACTOR@("hlfNameId")=$G(HLFARR(FNBR1,IENS,.01,"I"))
 S @HLFACTOR@("hlfName")=$G(HLFARR(FNBR1,IENS,.01,"E"))
 QUIT:$G(CP)&($E(@HLFACTOR@("hlfName"),1,4)'="SYN ")
 S @HLFACTOR@("hlfCategory")=$$GET1^DIQ(9999999.64,@HLFACTOR@("hlfNameId")_",",.03,"E")
 S @HLFACTOR@("hlfCategoryId")=$$GET1^DIQ(9999999.64,@HLFACTOR@("hlfNameId")_",",.03,"I")
 S @HLFACTOR@("patientNameId")=$G(HLFARR(FNBR1,IENS,.02,"I"))
 S @HLFACTOR@("patientName")=$G(HLFARR(FNBR1,IENS,.02,"E"))
 S @HLFACTOR@("patientNameICN")=$$GET1^DIQ(2,@HLFACTOR@("patientNameId")_",",991.1)
 S @HLFACTOR@("levelSeverityCd")=$G(HLFARR(FNBR1,IENS,.04,"I"))
 S @HLFACTOR@("levelSeverity")=$G(HLFARR(FNBR1,IENS,.04,"E"))
 S @HLFACTOR@("magnitude")=$G(HLFARR(FNBR1,IENS,220,"E"))
 S @HLFACTOR@("ucumCode")=$G(HLFARR(FNBR1,IENS,221,"I"))
 S @HLFACTOR@("ucumCode")=$G(HLFARR(FNBR1,IENS,221,"E"))
 S @HLFACTOR@("eventDateTime")=$G(HLFARR(FNBR1,IENS,1201,"E"))
 S @HLFACTOR@("eventDateTimeFM")=$G(HLFARR(FNBR1,IENS,1201,"I"))
 S @HLFACTOR@("eventDateTimeHL7")=$$FMTHL7^XLFDT($G(HLFARR(FNBR1,IENS,1201,"I")))
 S @HLFACTOR@("eventDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(HLFARR(FNBR1,IENS,1201,"I")))
 S @HLFACTOR@("orderingProviderId")=$G(HLFARR(FNBR1,IENS,1202,"I"))
 S @HLFACTOR@("orderingProvider")=$G(HLFARR(FNBR1,IENS,1202,"E"))
 S @HLFACTOR@("orderingProviderNPI")=$$GET1^DIQ(200,@HLFACTOR@("orderingProviderId")_",",41.99) ;NPI
 S @HLFACTOR@("orderingProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@HLFACTOR@("orderingProviderId"))
 S @HLFACTOR@("encounterProviderId")=$G(HLFARR(FNBR1,IENS,1204,"I"))
 S @HLFACTOR@("encounterProvider")=$G(HLFARR(FNBR1,IENS,1204,"E"))
 S @HLFACTOR@("encounterProviderNPI")=$$GET1^DIQ(200,@HLFACTOR@("encounterProviderId")_",",41.99) ;NPI
 S @HLFACTOR@("encounterProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@HLFACTOR@("encounterProviderId"))
 S @HLFACTOR@("editedCd")=$G(HLFARR(FNBR1,IENS,80101,"I"))
 S @HLFACTOR@("edited")=$G(HLFARR(FNBR1,IENS,80101,"E"))
 S @HLFACTOR@("auditTrail")=$G(HLFARR(FNBR1,IENS,80102,"E"))
 S @HLFACTOR@("comments")=$G(HLFARR(FNBR1,IENS,81101,"E"))
 S @HLFACTOR@("verifiedCd")=$G(HLFARR(FNBR1,IENS,81201,"I"))
 S @HLFACTOR@("verified")=$G(HLFARR(FNBR1,IENS,81201,"E"))
 S @HLFACTOR@("packageId")=$G(HLFARR(FNBR1,IENS,81202,"I"))
 S @HLFACTOR@("package")=$G(HLFARR(FNBR1,IENS,81202,"E"))
 S @HLFACTOR@("dataSourceId")=$G(HLFARR(FNBR1,IENS,81203,"I"))
 S @HLFACTOR@("dataSource")=$G(HLFARR(FNBR1,IENS,81203,"E"))
 ;
 ;care plan record
 I $E(@HLFACTOR@("hlfName"),1,7)="SYN CP " D
 . S @HLFACTOR@("cpStart")=+($$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",2)," "))
 . I @HLFACTOR@("cpStart")=0 S @HLFACTOR@("cpStart")=""
 . S @HLFACTOR@("cpStartHL7")=$$FMTHL7^XLFDT(@HLFACTOR@("cpStart"))
 . S @HLFACTOR@("cpStartFHIR")=$$FMTFHIR^SYNDHPUTL(@HLFACTOR@("cpStart"))
 . S @HLFACTOR@("cpEnd")=+($$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",3)," "))
 . I @HLFACTOR@("cpEnd")=0 S @HLFACTOR@("cpEnd")=""
 . S @HLFACTOR@("cpEndHL7")=$$FMTHL7^XLFDT(@HLFACTOR@("cpEnd"))
 . S @HLFACTOR@("cpEndFHIR")=$$FMTFHIR^SYNDHPUTL(@HLFACTOR@("cpEnd"))
 . S @HLFACTOR@("cpState")=$$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",4)," ")
 . S @HLFACTOR@("cpIntent")="plan"
 ;
 I $G(CP) D
 . S @HLFACTOR@("cpType")=$$GETTYPE(@HLFACTOR@("hlfName"))
 . S @HLFACTOR@("hlfNameSCT")=$$GETSCT(@HLFACTOR@("hlfName"))
 . S @HLFACTOR@("cpState")=$$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",4)," ")
 . S @HLFACTOR@("cpResourceType")="CarePlan"
 ;
 I '$G(CP) D
 . ;get snomed
 . N SCT S SCT=""
 . I @HLFACTOR@("hlfNameId")'="" D
 . . S SCT=$$MAP^SYNDHPMP("sct2hf",@HLFACTOR@("hlfNameId"),"I")
 . . S @HLFACTOR@("hlfNameSCT")=$S(+SCT=-1:"",1:$P(SCT,U,2))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HLFACT")
 ;
 D:$G(RETJSON)="J"!($G(RETJSON)="F") TOJASON^SYNDHPUTL(.HLFACT,.HLFACTJ)
 ;
 QUIT
 ;
GETTYPE(HFNAME) ;
 ;
 QUIT $S($E(HFNAME,1,7)="SYN CP ":"careplan",$E(HFNAME,1,8)="SYN ADDR":"addresses",$E(HFNAME,1,8)="SYN ACT ":"activity",$E(HFNAME,1,9)="SYN GOAL ":"goal",1:"")
 ;
GETSCT(HFNAME) ;
 ;
 QUIT $P($P(HFNAME,"SCT:",2),")",1)
 ;
 ;-------------------------------------------------------------
 ;
GET1NCP(NCP,NCPIEN,RETJSON,NCPJ) ;get one nursing care plan
 ;inputs: HLFIEN - Health Factor IEN
 ;        RETJSON - J = Return JSON
 ;output: NCP  - array of nursing care plan, by reference
 ;        NCPJ - JSON structure of nursing care plan data, by reference
 ;
 I $G(DEBUG) W !,"----------------------------- Nursing Care Plan -----------------------------",!
 N FNBR1 S FNBR1=216.8 ;NURS CARE PLAN
 N FNBR2 S FNBR2=216.81 ;NURS CARE PLAN:NURSING PROBLEM LIST
 N FNBR3 S FNBR3=216.82 ;NURS CARE PLAN:EVALUATION DATE
 N FNBR4 S FNBR4=216.83 ;NURS CARE PLAN:TARGET DATE
 N FNBR5 S FNBR5=216.84 ;NURS CARE PLAN:ORDER INFO
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N IENS S IENS=NCPIEN_","
 N NCPARR,NCPERR
 D GETS^DIQ(FNBR1,IENS,"**","EI","NCPARR","NCPERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("NCPARR")
 I $G(DEBUG),$D(NCPERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("NCPERR")
 I $D(NCPERR) D  QUIT
 . S NCP("NurseCarePlan","ERROR")=NCPIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.NCP,.NCPJ)
 N CAREPLAN S CAREPLAN=$NA(NCP("NurseCarePlan"))
 S @CAREPLAN@("ncpIen")=NCPIEN
 S @CAREPLAN@("resourceType")="NurseCarePlan"
 S @CAREPLAN@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,NCPIEN)
 S @CAREPLAN@("textFileEntryId")=$G(NCPARR(FNBR1,IENS,.01,"I"))
 S @CAREPLAN@("textFileEntry")=$G(NCPARR(FNBR1,IENS,.01,"E"))
 ;
 N PROB S PROB=""
 F  S PROB=$O(NCPARR(FNBR2,PROB)) QUIT:PROB=""  D
 . N FIEN S FIEN=+PROB
 . N PROBLIST S PROBLIST=$NA(NCP("NurseCarePlan","problemLists","problemList",FIEN))
 . S @PROBLIST@("problemId")=$G(NCPARR(FNBR2,PROB,.01,"I"))
 . S @PROBLIST@("problem")=$G(NCPARR(FNBR2,PROB,.01,"E"))
 . S @PROBLIST@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,NCPIEN,FNBR2_U_FIEN)
 ;
 N EVAL S EVAL=""
 F  S EVAL=$O(NCPARR(FNBR3,EVAL)) QUIT:EVAL=""  D
 . N FIEN S FIEN=+EVAL
 . N EVALDATE S EVALDATE=$NA(NCP("NurseCarePlan","evaluationDates","evaluationDate",FIEN))
 . S @EVALDATE@("dateTimeEntered")=$G(NCPARR(FNBR3,EVAL,.01,"E"))
 . S @EVALDATE@("dateTimeEnteredFM")=$G(NCPARR(FNBR3,EVAL,.01,"I"))
 . S @EVALDATE@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR3,EVAL,.01,"I")))
 . S @EVALDATE@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR3,EVAL,.01,"I")))
 . S @EVALDATE@("problemId")=$G(NCPARR(FNBR3,EVAL,.02,"I"))
 . S @EVALDATE@("problem")=$G(NCPARR(FNBR3,EVAL,.02,"E"))
 . S @EVALDATE@("userWhoEvaluatedId")=$G(NCPARR(FNBR3,EVAL,1,"I"))
 . S @EVALDATE@("userWhoEvaluated")=$G(NCPARR(FNBR3,EVAL,1,"E"))
 . S @EVALDATE@("userWhoEvaluatedNPI")=$$GET1^DIQ(200,@EVALDATE@("userWhoEvaluatedId")_",",41.99) ;NPI
 . S @EVALDATE@("userWhoEvaluatedResId")=$$RESID^SYNDHP69("V",SITE,200,@EVALDATE@("userWhoEvaluatedId"))
 . S @EVALDATE@("problemStatusCd")=$G(NCPARR(FNBR3,EVAL,2,"I"))
 . S @EVALDATE@("problemStatus")=$G(NCPARR(FNBR3,EVAL,2,"E"))
 . S @EVALDATE@("evaluationDate")=$G(NCPARR(FNBR3,EVAL,3,"E"))
 . S @EVALDATE@("evaluationDateFM")=$G(NCPARR(FNBR3,EVAL,3,"I"))
 . S @EVALDATE@("evaluationDateHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR3,EVAL,3,"I")))
 . S @EVALDATE@("evaluationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR3,EVAL,3,"I")))
 . S @EVALDATE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,NCPIEN,FNBR3_U_FIEN)
 ;
 N TARG S TARG=""
 F  S TARG=$O(NCPARR(FNBR4,TARG)) QUIT:TARG=""  D
 . N FIEN S FIEN=+TARG
 . N TARGDATE S TARGDATE=$NA(NCP("NurseCarePlan","targetDates","targetDate",FIEN))
 . S @TARGDATE@("dateTimeEntered")=$G(NCPARR(FNBR4,TARG,.01,"E"))
 . S @TARGDATE@("dateTimeEnteredFM")=$G(NCPARR(FNBR4,TARG,.01,"I"))
 . S @TARGDATE@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR4,TARG,.01,"I")))
 . S @TARGDATE@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR4,TARG,.01,"I")))
 . S @TARGDATE@("goalExpectedOutcomeId")=$G(NCPARR(FNBR4,TARG,.03,"I"))
 . S @TARGDATE@("goalExpectedOutcome")=$G(NCPARR(FNBR4,TARG,.03,"E"))
 . S @TARGDATE@("userWhoEnteredId")=$G(NCPARR(FNBR4,TARG,1,"I"))
 . S @TARGDATE@("userWhoEntered")=$G(NCPARR(FNBR4,TARG,1,"E"))
 . S @TARGDATE@("userWhoEnteredNPI")=$$GET1^DIQ(200,@TARGDATE@("userWhoEnteredId")_",",41.99) ;NPI
 . S @TARGDATE@("userWhoEnteredResId")=$$RESID^SYNDHP69("V",SITE,200,@TARGDATE@("userWhoEnteredId"))
 . S @TARGDATE@("goalMetDcdCd")=$G(NCPARR(FNBR4,TARG,2,"I"))
 . S @TARGDATE@("goalMetDcd")=$G(NCPARR(FNBR4,TARG,2,"E"))
 . S @TARGDATE@("targetDate")=$G(NCPARR(FNBR4,TARG,3,"E"))
 . S @TARGDATE@("targetDateFM")=$G(NCPARR(FNBR4,TARG,3,"I"))
 . S @TARGDATE@("targetDateHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR4,TARG,3,"I")))
 . S @TARGDATE@("targetDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR4,TARG,3,"I")))
 . S @TARGDATE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,NCPIEN,FNBR4_U_FIEN)
 ;
 N ORD S ORD=""
 F  S ORD=$O(NCPARR(FNBR5,ORD)) QUIT:ORD=""  D
 . N FIEN S FIEN=+ORD
 . N ORDINFO S ORDINFO=$NA(NCP("NurseCarePlan","ordersInfo","orderInfo",FIEN))
 . S @ORDINFO@("statusCd")=$G(NCPARR(FNBR5,ORD,1,"I"))
 . S @ORDINFO@("status")=$G(NCPARR(FNBR5,ORD,1,"E"))
 . S @ORDINFO@("userModifyingId")=$G(NCPARR(FNBR5,ORD,2,"I"))
 . S @ORDINFO@("userModifying")=$G(NCPARR(FNBR5,ORD,2,"E"))
 . S @ORDINFO@("userModifyingNPI")=$$GET1^DIQ(200,@ORDINFO@("userModifyingId")_",",41.99) ;NPI
 . S @ORDINFO@("userModifyingResId")=$$RESID^SYNDHP69("V",SITE,200,@ORDINFO@("userModifyingId"))
 . S @ORDINFO@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,NCPIEN,FNBR5_U_FIEN)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("NCP")
 ;
 D:$G(RETJSON)="J"!($G(RETJSON)="F") TOJASON^SYNDHPUTL(.NCP,.NCPJ)
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1GMR(GMRTEXT,GMRIEN,RETJSON,GMRTEXTJ) ;get one GMR Text record
 ;inputs: GMRIEN - GMR Text IEN
 ;        RETJSON - J = Return JSON
 ;output: GMRTEXT  - array of GMR Text data, by reference
 ;        GMRTEXTJ - JSON structure of GMR Text data, by reference
 ;
 I $G(DEBUG) W !,"----------------------------- GMR Text -----------------------------",!
 N FNBR1 S FNBR1=124.3 ;GMR TEXT
 N FNBR2 S FNBR2=124.31 ;GMR TEXT:SELECTION
 N FNBR3 S FNBR3=124.313 ;GMR TEXT:SELECTION:AUDIT TRAIL
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N IENS S IENS=GMRIEN_","
 N GMRARR,GMRERR
 D GETS^DIQ(FNBR1,IENS,"**","EI","GMRARR","GMRERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("GMRARR")
 I $G(DEBUG),$D(GMRERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("GMRERR")
 I $D(GMRERR) D  QUIT
 . S GMRTEXT("GMRtext","ERROR")=GMRIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.GMRTEXT,.GMRTEXTJ)
 N GMRTXT S GMRTXT=$NA(GMRTEXT("GMRtext"))
 S @GMRTXT@("GMRIen")=GMRIEN
 S @GMRTXT@("resourceType")="GMRtext"
 S @GMRTXT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,GMRIEN)
 S @GMRTXT@("textBlockId")=$G(GMRARR(FNBR1,IENS,.01,"I"))
 S @GMRTXT@("textBlock")=$G(GMRARR(FNBR1,IENS,.01,"E"))
 S @GMRTXT@("patientId")=$G(GMRARR(FNBR1,IENS,.02,"I"))
 S @GMRTXT@("patient")=$G(GMRARR(FNBR1,IENS,.02,"E"))
 S @GMRTXT@("patientICN")=$$GET1^DIQ(2,@GMRTXT@("patientId")_",",991.1)
 S @GMRTXT@("dateCreated")=$G(GMRARR(FNBR1,IENS,.03,"E"))
 S @GMRTXT@("dateCreatedFM")=$G(GMRARR(FNBR1,IENS,.03,"I"))
 S @GMRTXT@("dateCreatedHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR1,IENS,.03,"I")))
 S @GMRTXT@("dateCreatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR1,IENS,.03,"I")))
 S @GMRTXT@("authorId")=$G(GMRARR(FNBR1,IENS,3,"I"))
 S @GMRTXT@("author")=$G(GMRARR(FNBR1,IENS,3,"E"))
 S @GMRTXT@("enteredInErrorCd")=$G(GMRARR(FNBR1,IENS,5,"I"))
 S @GMRTXT@("enteredInError")=$G(GMRARR(FNBR1,IENS,5,"E"))
 S @GMRTXT@("dateEnteredInError")=$G(GMRARR(FNBR1,IENS,5.1,"E"))
 S @GMRTXT@("dateEnteredInErrorFM")=$G(GMRARR(FNBR1,IENS,5.1,"I"))
 S @GMRTXT@("dateEnteredInErrorHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR1,IENS,5.1,"I")))
 S @GMRTXT@("dateEnteredInErrorFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR1,IENS,5.1,"I")))
 S @GMRTXT@("userEnteringInErrorId")=$G(GMRARR(FNBR1,IENS,5.2,"I"))
 S @GMRTXT@("userEnteringInError")=$G(GMRARR(FNBR1,IENS,5.2,"E"))
 S @GMRTXT@("dateLastUpdated")=$G(GMRARR(FNBR1,IENS,6,"E"))
 S @GMRTXT@("dateLastUpdatedFM")=$G(GMRARR(FNBR1,IENS,6,"I"))
 S @GMRTXT@("dateLastUpdatedHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR1,IENS,6,"I")))
 S @GMRTXT@("dateLastUpdatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR1,IENS,6,"I")))
 ;
 N IENS2 S IENS2=""
 F  S IENS2=$O(GMRARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N SELECTION S SELECTION=$NA(GMRTEXT("GMRtext","selections","selection",+IENS2))
 . S @SELECTION@("selectionId")=$G(GMRARR(FNBR2,IENS2,.01,"I"))
 . S @SELECTION@("selection")=$G(GMRARR(FNBR2,IENS2,.01,"E"))
 . S @SELECTION@("appendedInternalText")=$G(GMRARR(FNBR2,IENS2,1,"E"))
 . S @SELECTION@("additionalText")=$G(GMRARR(FNBR2,IENS2,2,"E"))
 . S @SELECTION@("added")=$G(GMRARR(FNBR2,IENS2,4,"E"))
 . S @SELECTION@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,GMRIEN,FNBR2_U_+IENS2)
 ;
 N IENS3 S IENS3=""
 F  S IENS3=$O(GMRARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N AUDIT S AUDIT=$NA(GMRTEXT("GMRtext","selections","selection",$P(IENS3,C,2),"auditTrails","auditTrail",+IENS3))
 . S @AUDIT@("auditTrailDateTime")=$G(GMRARR(FNBR3,IENS3,.01,"E"))
 . S @AUDIT@("auditTrailDateTimeFM")=$G(GMRARR(FNBR3,IENS3,.01,"I"))
 . S @AUDIT@("auditTrailDateTimeHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR3,IENS3,.01,"I")))
 . S @AUDIT@("auditTrailDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR3,IENS3,.01,"I")))
 . S @AUDIT@("modification")=$G(GMRARR(FNBR3,IENS3,1,"E"))
 . S @AUDIT@("userWhoModifiedId")=$G(GMRARR(FNBR3,IENS3,2,"I"))
 . S @AUDIT@("userWhoModified")=$G(GMRARR(FNBR3,IENS3,2,"E"))
 . S @AUDIT@("userWhoModifiedNPI")=$$GET1^DIQ(200,@AUDIT@("userWhoModifiedId")_",",41.99) ;NPI
 . S @AUDIT@("userWhoModifiedResId")=$$RESID^SYNDHP69("V",SITE,200,"userWhoModifiedId")
 . S @AUDIT@("appendedInternalText")=$G(GMRARR(FNBR3,IENS3,3,"E"))
 . S @AUDIT@("additionalText")=$G(GMRARR(FNBR3,IENS3,4,"E"))
 . S @AUDIT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,GMRIEN,FNBR2_U_$P(IENS3,C,2)_U_FNBR3_U_+IENS3)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("GMRTEXT")
 ;
 D:$G(RETJSON)="J"!($G(RETJSON)="F") TOJASON^SYNDHPUTL(.GMRTEXT,.GMRTEXTJ)
 ;
 QUIT
 ;

SYNDHP16
SYNDHP16 ; HC/art - HealthConcourse - get Allergy, Vitals, data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1ALLERGY(ALLERGY,ALLERGYIEN,RETJSON,ALLERGYJ) ;get one Allergy record
 ;inputs: ALLERGYIEN - Allergy IEN
 ;        RETJSON - J = Return JSON
 ;output: ALLERGY  - array of Allergy data, by reference
 ;        ALLERGYJ - JSON structure of Allergy data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Allergy -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=120.8 ;PATIENT ALLERGIES
 N FNBR2 S FNBR2=120.81 ;REACTIONS
 N FNBR3 S FNBR3=120.813 ;CHART MARKED
 N FNBR4 S FNBR4=120.814 ;ID BAND MARKED
 N FNBR5 S FNBR5=120.826 ;COMMENTS
 N IENS1 S IENS1=ALLERGYIEN_","
 ;
 N ALLERGYARR,ALLERGYERR,ALLERGYN
 D GETS^DIQ(FNBR1,IENS1,"**","EI","ALLERGYARR","ALLERGYERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("ALLERGYARR")
 I $G(DEBUG),$D(ALLERGYERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("ALLERGYERR")
 I $D(ALLERGYERR) D  QUIT
 . S ALLERGY("Allergy","ERROR")=ALLERGYIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.ALLERGY,.ALLERGYJ)
 S ALLERGYN=$NA(ALLERGY("Allergy"))
 S @ALLERGYN@("allergyIen")=ALLERGYIEN
 S @ALLERGYN@("resourceType")="AllergyIntolerance"
 S @ALLERGYN@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,ALLERGYIEN)
 S @ALLERGYN@("patient")=$G(ALLERGYARR(FNBR1,IENS1,.01,"E"))
 S @ALLERGYN@("patientId")=$G(ALLERGYARR(FNBR1,IENS1,.01,"I"))
 S @ALLERGYN@("patientICN")=$$GET1^DIQ(2,@ALLERGYN@("patientId")_",",991.1)
 S @ALLERGYN@("reactant")=$G(ALLERGYARR(FNBR1,IENS1,.02,"E"))
 S @ALLERGYN@("reactantSCT")=$$MAPR^SYNDHPMP(@ALLERGYN@("reactant"),"T","A")
 S @ALLERGYN@("gmrAllergy")=$G(ALLERGYARR(FNBR1,IENS1,1,"E"))
 S @ALLERGYN@("gmrAllergyId")=$G(ALLERGYARR(FNBR1,IENS1,1,"I"))
 S @ALLERGYN@("allergyType")=$G(ALLERGYARR(FNBR1,IENS1,3.1,"E"))
 S @ALLERGYN@("allergyTypeFHIR")=$$CNVTTYPE(@ALLERGYN@("allergyType"))
 S @ALLERGYN@("originationDateTime")=$G(ALLERGYARR(FNBR1,IENS1,4,"E"))
 S @ALLERGYN@("originationDateTimeFM")=$G(ALLERGYARR(FNBR1,IENS1,4,"I"))
 S @ALLERGYN@("originationDateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR1,IENS1,4,"I")))
 S @ALLERGYN@("originationDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR1,IENS1,4,"I")))
 S @ALLERGYN@("originator")=$G(ALLERGYARR(FNBR1,IENS1,5,"E"))
 S @ALLERGYN@("originatorId")=$G(ALLERGYARR(FNBR1,IENS1,5,"I"))
 S @ALLERGYN@("observedHistorical")=$G(ALLERGYARR(FNBR1,IENS1,6,"E"))
 S @ALLERGYN@("observedHistoricalCd")=$G(ALLERGYARR(FNBR1,IENS1,6,"I"))
 S @ALLERGYN@("reportable")=$G(ALLERGYARR(FNBR1,IENS1,7,"E"))
 S @ALLERGYN@("reportableCd")=$G(ALLERGYARR(FNBR1,IENS1,7,"I"))
 S @ALLERGYN@("originatorSignOff")=$G(ALLERGYARR(FNBR1,IENS1,15,"E"))
 S @ALLERGYN@("originatorSignOffCd")=$G(ALLERGYARR(FNBR1,IENS1,15,"I"))
 S @ALLERGYN@("mechanism")=$G(ALLERGYARR(FNBR1,IENS1,17,"E"))
 S @ALLERGYN@("mechanismCd")=$G(ALLERGYARR(FNBR1,IENS1,17,"I"))
 S @ALLERGYN@("verified")=$G(ALLERGYARR(FNBR1,IENS1,19,"E"))
 S @ALLERGYN@("verifiedCd")=$G(ALLERGYARR(FNBR1,IENS1,19,"I"))
 S @ALLERGYN@("verificationDateTime")=$G(ALLERGYARR(FNBR1,IENS1,20,"E"))
 S @ALLERGYN@("verificationDateTimeFM")=$G(ALLERGYARR(FNBR1,IENS1,20,"I"))
 S @ALLERGYN@("verificationDateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR1,IENS1,20,"I")))
 S @ALLERGYN@("verificationDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR1,IENS1,20,"I")))
 S @ALLERGYN@("verifier")=$G(ALLERGYARR(FNBR1,IENS1,21,"E"))
 S @ALLERGYN@("verifierId")=$G(ALLERGYARR(FNBR1,IENS1,21,"I"))
 S @ALLERGYN@("verifierNPI")=$$GET1^DIQ(200,@ALLERGYN@("verifierId")_",",41.99) ;NPI
 S @ALLERGYN@("enteredInError")=$G(ALLERGYARR(FNBR1,IENS1,22,"E"))
 S @ALLERGYN@("enteredInErrorCd")=$G(ALLERGYARR(FNBR1,IENS1,22,"I"))
 S @ALLERGYN@("dateTimeEnteredInError")=$G(ALLERGYARR(FNBR1,IENS1,23,"E"))
 S @ALLERGYN@("dateTimeEnteredInErrorFM")=$G(ALLERGYARR(FNBR1,IENS1,23,"I"))
 S @ALLERGYN@("dateTimeEnteredInErrorHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR1,IENS1,23,"I")))
 S @ALLERGYN@("dateTimeEnteredInErrorFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR1,IENS1,23,"I")))
 S @ALLERGYN@("userEnteringInError")=$G(ALLERGYARR(FNBR1,IENS1,24,"E"))
 S @ALLERGYN@("userEnteringInErrorId")=$G(ALLERGYARR(FNBR1,IENS1,24,"I"))
 S @ALLERGYN@("userEnteringInErrorNPI")=$$GET1^DIQ(200,@ALLERGYN@("userEnteringInErrorId")_",",41.99) ;NPI
 S @ALLERGYN@("userEnteringInErrorResId")=$$RESID^SYNDHP69("V",SITE,200,@ALLERGYN@("userEnteringInErrorId"))
 N REACTION
 N IENS2 S IENS2=""
 F  S IENS2=$O(ALLERGYARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . S REACTION=$NA(ALLERGY("Allergy","reactionss","reactions",+IENS2))
 . S @REACTION@("reaction")=$G(ALLERGYARR(FNBR2,IENS2,.01,"E"))
 . S @REACTION@("reactionId")=$G(ALLERGYARR(FNBR2,IENS2,.01,"I"))
 . S @REACTION@("reactionSCT")=$$MAPR^SYNDHPMP($G(ALLERGYARR(FNBR2,IENS2,.01,"E")),"T","R")
 . S @REACTION@("otherReaction")=$G(ALLERGYARR(FNBR2,IENS2,1,"E"))
 . S @REACTION@("enteredBy")=$G(ALLERGYARR(FNBR2,IENS2,2,"E"))
 . S @REACTION@("enteredById")=$G(ALLERGYARR(FNBR2,IENS2,2,"I"))
 . S @REACTION@("enteredByNPI")=$$GET1^DIQ(200,@REACTION@("enteredById")_",",41.99) ;NPI
 . S @REACTION@("enteredByResId")=$$RESID^SYNDHP69("V",SITE,200,@REACTION@("enteredById"))
 . S @REACTION@("dateEntered")=$G(ALLERGYARR(FNBR2,IENS2,3,"E"))
 . S @REACTION@("dateEnteredFM")=$G(ALLERGYARR(FNBR2,IENS2,3,"I"))
 . S @REACTION@("dateEnteredHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR2,IENS2,3,"I")))
 . S @REACTION@("dateEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR2,IENS2,3,"I")))
 . S @REACTION@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,ALLERGYIEN,FNBR2_U_+IENS2)
 N CHART
 N IENS3 S IENS3=""
 F  S IENS3=$O(ALLERGYARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . S CHART=$NA(ALLERGY("Allergy","chartMarkeds","chartMarked",+IENS3))
 . S @CHART@("dateTime")=$G(ALLERGYARR(FNBR3,IENS3,.01,"E"))
 . S @CHART@("dateTimeFM")=$G(ALLERGYARR(FNBR3,IENS3,.01,"I"))
 . S @CHART@("dateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR3,IENS3,.01,"I")))
 . S @CHART@("dateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR3,IENS3,.01,"I")))
 . S @CHART@("userEntering")=$G(ALLERGYARR(FNBR3,IENS3,1,"E"))
 . S @CHART@("userEnteringId")=$G(ALLERGYARR(FNBR3,IENS3,1,"I"))
 . S @CHART@("userEnteringNPI")=$$GET1^DIQ(200,@CHART@("userEnteringId")_",",41.99) ;NPI
 . S @CHART@("userEnteringResId")=$$RESID^SYNDHP69("V",SITE,200,@CHART@("userEnteringId"))
 . S @CHART@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,ALLERGYIEN,FNBR3_U_+IENS3)
 N IDBAND
 N IENS4 S IENS4=""
 F  S IENS4=$O(ALLERGYARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . S IDBAND=$NA(ALLERGY("Allergy","idBandMarkeds","idBandMarked",+IENS4))
 . S @IDBAND@("dateTime")=$G(ALLERGYARR(FNBR4,IENS4,.01,"E"))
 . S @IDBAND@("dateTimeFM")=$G(ALLERGYARR(FNBR4,IENS4,.01,"I"))
 . S @IDBAND@("dateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR4,IENS4,.01,"I")))
 . S @IDBAND@("dateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR4,IENS4,.01,"I")))
 . S @IDBAND@("userEntering")=$G(ALLERGYARR(FNBR4,IENS4,1,"E"))
 . S @IDBAND@("userEnteringId")=$G(ALLERGYARR(FNBR4,IENS4,1,"I"))
 . S @IDBAND@("userEnteringNPI")=$$GET1^DIQ(200,@IDBAND@("userEnteringId")_",",41.99) ;NPI
 . S @IDBAND@("userEnteringResId")=$$RESID^SYNDHP69("V",SITE,200,@IDBAND@("userEnteringId"))
 . S @IDBAND@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,ALLERGYIEN,FNBR4_U_+IENS4)
 N COMMENTS
 N IENS5 S IENS5=""
 F  S IENS5=$O(ALLERGYARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . S COMMENTS=$NA(ALLERGY("Allergy","commentss","comments",+IENS5))
 . S @COMMENTS@("dateTimeCommentEntered")=$G(ALLERGYARR(FNBR5,IENS5,.01,"E"))
 . S @COMMENTS@("dateTimeCommentEnteredFM")=$G(ALLERGYARR(FNBR5,IENS5,.01,"I"))
 . S @COMMENTS@("dateTimeCommentEnteredHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR5,IENS5,.01,"I")))
 . S @COMMENTS@("dateTimeCommentEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR5,IENS5,.01,"I")))
 . S @COMMENTS@("userEntering")=$G(ALLERGYARR(FNBR5,IENS5,1,"E"))
 . S @COMMENTS@("userEnteringId")=$G(ALLERGYARR(FNBR5,IENS5,1,"I"))
 . S @COMMENTS@("userEnteringNPI")=$$GET1^DIQ(200,@COMMENTS@("userEnteringId")_",",41.99) ;NPI
 . S @COMMENTS@("userEnteringResId")=$$RESID^SYNDHP69("V",SITE,200,@COMMENTS@("userEnteringId"))
 . S @COMMENTS@("commentType")=$G(ALLERGYARR(FNBR5,IENS5,1.5,"E"))
 . S @COMMENTS@("commentTypeCd")=$G(ALLERGYARR(FNBR5,IENS5,1.5,"I"))
 . S @COMMENTS@("comments")=$G(ALLERGYARR(FNBR5,IENS5,2,"E"))
 . S @COMMENTS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,ALLERGYIEN,FNBR5_U_+IENS5)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("ALLERGY") W !
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.ALLERGY,.ALLERGYJ)
 ;
 QUIT
 ;
CNVTTYPE(TYPE) ;convert allery type to fhir values
 ;input: TYPE - VistA allergy type
 ;returns: FHIR allery type
 ;
 N IDX,TYPES,ALLTYPES
 F IDX=1:1 S TYPES=$P($T(TYPES+IDX),";;",2) QUIT:TYPES="zzzzz"  D
 . S ALLTYPES($P(TYPES,U,1))=$P(TYPES,U,2)
 ;
 I $G(TYPE)="" QUIT ""
 I $D(ALLTYPES(TYPE)) QUIT ALLTYPES(TYPE)
 QUIT ""
 ;
TYPES ;
  ;;FOOD^food
  ;;DRUG^medication
  ;;OTHER^environment
  ;;FOOD, DRUG^food:medication
  ;;DRUG, FOOD^medication:food
  ;;FOOD, OTHER^food:environment
  ;;DRUG, OTHER^medication:environment
  ;;FOOD, DRUG, OTHER^food:medication:environment
  ;;DRUG, FOOD, OTHER^medication:food:environment
  ;;F^food
  ;;D^medication
  ;;O^environment
  ;;FD^food:medication
  ;;DF^medication:food
  ;;FO^food:environment
  ;;DO^medication:environment
  ;;FDO^food:medication:environment
  ;;DFO^medication:food:environment
  ;;zzzzz
 ;
GET1VITALS(VITALS,VITALSIEN,RETJSON,VITALSJ) ;get one Vitals record
 ;inputs: VITALSIEN - Vitals IEN
 ;        RETJSON - J = Return JSON
 ;output: VITALS  - array of Vitals data, by reference
 ;        VITALSJ - JSON structure of Vitals data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Vitals -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=120.5 ;GMRV VITAL MEASUREMENT
 N FNBR2 S FNBR2=120.506 ;REASON ENTERED IN ERROR
 N FNBR3 S FNBR3=120.505 ;QUALIFIER
 N IENS1 S IENS1=VITALSIEN_","
 ;
 N VITALSARR,VITALSERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VITALSARR","VITALSERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VITALSARR")
 I $G(DEBUG),$D(VITALSERR) W ">>ERROR<<" W $$ZW^SYNDHPUTL("VITALSERR")
 I $D(VITALSERR) D  QUIT
 . S VITALS("Vitals","ERROR")=VITALSIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VITALS,.VITALSJ)
 S VITALS("Vitals","vitalsIen")=VITALSIEN
 S VITALS("Vitals","resourceType")="Observation"
 S VITALS("Vitals","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VITALSIEN)
 S VITALS("Vitals","dateTimeVitalsTaken")=$G(VITALSARR(FNBR1,IENS1,.01,"E"))
 S VITALS("Vitals","dateTimeVitalsTakenFM")=$G(VITALSARR(FNBR1,IENS1,.01,"I"))
 S VITALS("Vitals","dateTimeVitalsTakenHL7")=$$FMTHL7^XLFDT($G(VITALSARR(FNBR1,IENS1,.01,"I")))
 S VITALS("Vitals","dateTimeVitalsTakenFHIR")=$$FMTFHIR^SYNDHPUTL($G(VITALSARR(FNBR1,IENS1,.01,"I")))
 S VITALS("Vitals","patient")=$G(VITALSARR(FNBR1,IENS1,.02,"E"))
 S VITALS("Vitals","patientId")=$G(VITALSARR(FNBR1,IENS1,.02,"I"))
 S VITALS("Vitals","patientICN")=$$GET1^DIQ(2,VITALS("Vitals","patientId")_",",991.1)
 S VITALS("Vitals","vitalType")=$G(VITALSARR(FNBR1,IENS1,.03,"E"))
 S VITALS("Vitals","vitalTypeSc")=$$SENTENCE^XLFSTR(VITALS("Vitals","vitalType"))
 S VITALS("Vitals","vitalTypeId")=$G(VITALSARR(FNBR1,IENS1,.03,"I"))
 S VITALS("Vitals","dateTimeVitalsEntered")=$G(VITALSARR(FNBR1,IENS1,.04,"E"))
 S VITALS("Vitals","dateTimeVitalsEnteredFM")=$G(VITALSARR(FNBR1,IENS1,.04,"I"))
 S VITALS("Vitals","dateTimeVitalsEnteredHL7")=$$FMTHL7^XLFDT($G(VITALSARR(FNBR1,IENS1,.04,"I")))
 S VITALS("Vitals","dateTimeVitalsEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(VITALSARR(FNBR1,IENS1,.04,"I")))
 S VITALS("Vitals","hospitalLocation")=$G(VITALSARR(FNBR1,IENS1,.05,"E"))
 S VITALS("Vitals","hospitalLocationId")=$G(VITALSARR(FNBR1,IENS1,.05,"I"))
 S VITALS("Vitals","enteredBy")=$G(VITALSARR(FNBR1,IENS1,.06,"E"))
 S VITALS("Vitals","enteredById")=$G(VITALSARR(FNBR1,IENS1,.06,"I"))
 S VITALS("Vitals","enteredByNPI")=$$GET1^DIQ(200,VITALS("Vitals","enteredById")_",",41.99) ;NPI
 S VITALS("Vitals","enteredByResId")=$$RESID^SYNDHP69("V",SITE,200,VITALS("Vitals","enteredById"))
 S VITALS("Vitals","rate")=$G(VITALSARR(FNBR1,IENS1,1.2,"E"))
 S VITALS("Vitals","supplementalO2")=$G(VITALSARR(FNBR1,IENS1,1.4,"E"))
 S VITALS("Vitals","enteredInError")=$G(VITALSARR(FNBR1,IENS1,2,"E"))
 S VITALS("Vitals","enteredInErrorCd")=$G(VITALSARR(FNBR1,IENS1,2,"I"))
 S VITALS("Vitals","errorEnteredBy")=$G(VITALSARR(FNBR1,IENS1,3,"E"))
 S VITALS("Vitals","errorEnteredById")=$G(VITALSARR(FNBR1,IENS1,3,"I"))
 S VITALS("Vitals","errorEnteredByNPI")=$$GET1^DIQ(200,VITALS("Vitals","errorEnteredById")_",",41.99) ;NPI
 N REASERR
 N IENS2 S IENS2=""
 F  S IENS2=$O(VITALSARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . S REASERR=$NA(VITALS("Vitals","reasonEnteredInErrors","reasonEnteredInError",+IENS2))
 . S @REASERR@("reasonEnteredInError")=$G(VITALSARR(FNBR2,IENS2,.01,"E"))
 . S @REASERR@("reasonEnteredInErrorCd")=$G(VITALSARR(FNBR2,IENS2,.01,"I"))
 . S @REASERR@("dateReasonEnteredInError")=$G(VITALSARR(FNBR2,IENS2,.02,"E"))
 . S @REASERR@("dateReasonEnteredInErrorFM")=$G(VITALSARR(FNBR2,IENS2,.02,"I"))
 . S @REASERR@("dateReasonEnteredInErrorHL7")=$$FMTHL7^XLFDT($G(VITALSARR(FNBR2,IENS2,.02,"I")))
 . S @REASERR@("dateReasonEnteredInErrorFHIR")=$$FMTFHIR^SYNDHPUTL($G(VITALSARR(FNBR2,IENS2,.02,"I")))
 . S @REASERR@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VITALSIEN,FNBR2_U_+IENS2)
 N QUALIFY
 N IENS3 S IENS3=""
 F  S IENS3=$O(VITALSARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . S QUALIFY=$NA(VITALS("Vitals","qualifiers","qualifier",+IENS3))
 . S @QUALIFY@("qualifier")=$G(VITALSARR(FNBR3,IENS3,.01,"E"))
 . S @QUALIFY@("qualifierId")=$G(VITALSARR(FNBR3,IENS3,.01,"I"))
 . S @QUALIFY@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VITALSIEN,FNBR3_U_+IENS3)
 ;
 ;get snomed
 N SCT S SCT=""
 S SCT=$$MAP^SYNDHPMP("sct2vit",VITALS("Vitals","vitalTypeId"),"I")
 S VITALS("Vitals","vitalTypeSCT")=$S(+SCT=-1:"",1:$P(SCT,U,2))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VITALS")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VITALS,.VITALSJ)
 ;
 QUIT
 ;

SYNDHP17
SYNDHP17 ; HC/art - HealthConcourse - get MH Diagnosis, Flags data ;08/27/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1MHDX(MHDX,MHDXIEN,RETJSON,MHDXJ) ;get one Mental Health Diagnosis record
 ;inputs: MHDXIEN - Mental Health Diagnosis IEN
 ;        RETJSON - J = Return JSON
 ;output: MHDX  - array of Mental Health Diagnosis data, by reference
 ;        MHDXJ - JSON structure of Mental Health Diagnosis data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Mental Health Diagnosis ----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=627.8 ;DIAGNOSTIC RESULTS - MENTAL HEALTH
 N FNBR2 S FNBR2=627.82 ;MODIFIERS
 N FNBR3 S FNBR3=627.81 ;COMMENT
 N IENS1 S IENS1=MHDXIEN_","
 ;
 N MHDXARR,MHDXERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","MHDXARR","MHDXERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHDXARR")
 I $G(DEBUG),$D(MHDXERR) W !,">>ERROR<<" W ! W $$ZW^SYNDHPUTL("MHDXERR")
 I $D(MHDXERR) D  QUIT
 . S MHDX("Mhdiag","ERROR")=MHDXIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHDX,.MHDXJ)
 S MHDX("Mhdiag","mhdiagIen")=MHDXIEN
 S MHDX("Mhdiag","resourceType")="Observation"
 S MHDX("Mhdiag","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHDXIEN)
 S MHDX("Mhdiag","fileEntryDate")=$G(MHDXARR(FNBR1,IENS1,.01,"E"))
 S MHDX("Mhdiag","fileEntryDateFM")=$G(MHDXARR(FNBR1,IENS1,.01,"I"))
 S MHDX("Mhdiag","fileEntryDateHL7")=$$FMTHL7^XLFDT($G(MHDXARR(FNBR1,IENS1,.01,"I")))
 S MHDX("Mhdiag","fileEntryDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHDXARR(FNBR1,IENS1,.01,"I")))
 S MHDX("Mhdiag","patientName")=$G(MHDXARR(FNBR1,IENS1,.02,"E"))
 S MHDX("Mhdiag","patientNameId")=$G(MHDXARR(FNBR1,IENS1,.02,"I"))
 S MHDX("Mhdiag","patientNameICN")=$$GET1^DIQ(2,MHDX("Mhdiag","patientNameId")_",",991.1)
 S MHDX("Mhdiag","dateTimeOfDiagnosis")=$G(MHDXARR(FNBR1,IENS1,.03,"E"))
 S MHDX("Mhdiag","dateTimeOfDiagnosisFM")=$G(MHDXARR(FNBR1,IENS1,.03,"I"))
 S MHDX("Mhdiag","dateTimeOfDiagnosisHL7")=$$FMTHL7^XLFDT($G(MHDXARR(FNBR1,IENS1,.03,"I")))
 S MHDX("Mhdiag","dateTimeOfDiagnosisFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHDXARR(FNBR1,IENS1,.03,"I")))
 S MHDX("Mhdiag","diagnosisBy")=$G(MHDXARR(FNBR1,IENS1,.04,"E"))
 S MHDX("Mhdiag","diagnosisById")=$G(MHDXARR(FNBR1,IENS1,.04,"I"))
 S MHDX("Mhdiag","diagnosisByNPI")=$$GET1^DIQ(200,MHDX("Mhdiag","diagnosisById")_",",41.99) ;NPI
 S MHDX("Mhdiag","diagnosisByResId")=$$RESID^SYNDHP69("V",SITE,200,MHDX("Mhdiag","diagnosisById"))
 S MHDX("Mhdiag","transcriber")=$G(MHDXARR(FNBR1,IENS1,.05,"E"))
 S MHDX("Mhdiag","transcriberId")=$G(MHDXARR(FNBR1,IENS1,.05,"I"))
 S MHDX("Mhdiag","diagnosis")=$G(MHDXARR(FNBR1,IENS1,1,"E"))
 S MHDX("Mhdiag","diagnosisId")=$G(MHDXARR(FNBR1,IENS1,1,"I"))
 S MHDX("Mhdiag","statusVPRINRu")=$G(MHDXARR(FNBR1,IENS1,5,"E"))
 S MHDX("Mhdiag","statusVPRINRuCd")=$G(MHDXARR(FNBR1,IENS1,5,"I"))
 S MHDX("Mhdiag","condition")=$G(MHDXARR(FNBR1,IENS1,7,"E"))
 S MHDX("Mhdiag","conditionCd")=$G(MHDXARR(FNBR1,IENS1,7,"I"))
 S MHDX("Mhdiag","inactivatedDate")=$G(MHDXARR(FNBR1,IENS1,8,"E"))
 S MHDX("Mhdiag","inactivatedDateFM")=$G(MHDXARR(FNBR1,IENS1,8,"I"))
 S MHDX("Mhdiag","inactivatedDateHL7")=$$FMTHL7^XLFDT($G(MHDXARR(FNBR1,IENS1,8,"I")))
 S MHDX("Mhdiag","inactivatedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHDXARR(FNBR1,IENS1,8,"I")))
 S MHDX("Mhdiag","statusChanged")=$G(MHDXARR(FNBR1,IENS1,9,"E"))
 S MHDX("Mhdiag","statusChangedCd")=$G(MHDXARR(FNBR1,IENS1,9,"I"))
 S MHDX("Mhdiag","dxls")=$G(MHDXARR(FNBR1,IENS1,10,"E"))
 S MHDX("Mhdiag","dxlsCd")=$G(MHDXARR(FNBR1,IENS1,10,"I"))
 S MHDX("Mhdiag","psychosocialStressor")=$G(MHDXARR(FNBR1,IENS1,60,"E"))
 S MHDX("Mhdiag","severityCode")=$G(MHDXARR(FNBR1,IENS1,61,"E"))
 S MHDX("Mhdiag","severityCodeCd")=$G(MHDXARR(FNBR1,IENS1,61,"I"))
 S MHDX("Mhdiag","axis5-GAF")=$G(MHDXARR(FNBR1,IENS1,65,"E"))
 S MHDX("Mhdiag","patientType")=$G(MHDXARR(FNBR1,IENS1,66,"E"))
 S MHDX("Mhdiag","patientTypeCd")=$G(MHDXARR(FNBR1,IENS1,66,"I"))
 N IENS2 S IENS2=""
 F  S IENS2=$O(MHDXARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N MOD S MOD=$NA(MHDX("Mhdiag","modifierss","modifiers",+IENS2))
 . S @MOD@("modifier")=$G(MHDXARR(FNBR2,IENS2,.01,"E"))
 . S @MOD@("modifierId")=$G(MHDXARR(FNBR2,IENS2,.01,"I"))
 . S @MOD@("numberOfAnswer")=$G(MHDXARR(FNBR2,IENS2,1,"E"))
 . S @MOD@("standsFor")=$G(MHDXARR(FNBR2,IENS2,2,"E"))
 . S @MOD@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHDXIEN,FNBR2_U_+IENS2)
 N IENS3 S IENS3=""
 F  S IENS3=$O(MHDXARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N COMMENT S COMMENT=$NA(MHDX("Mhdiag","comments","comment",+IENS3))
 . S @COMMENT@("comment")=$G(MHDXARR(FNBR3,IENS3,.01,"E"))
 . S @COMMENT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHDXIEN,FNBR3_U_+IENS3)
 ;
 ;get SCT code
 S MHDX("Mhdiag","diagnosisSCT")=""
 I MHDX("Mhdiag","diagnosis")'="" D
 . N DATE S DATE=$S(MHDX("Mhdiag","dateTimeOfDiagnosisFM")'="":MHDX("Mhdiag","dateTimeOfDiagnosisFM"),1:MHDX("Mhdiag","fileEntryDateFM"))
 . N MAPPING S MAPPING=$S(DATE>3150930:"sct2icd",1:"sct2icdnine")
 . N SNOMED S SNOMED=$$MAP^SYNDHPMP(MAPPING,MHDX("Mhdiag","diagnosis"),"I")
 . S MHDX("Mhdiag","diagnosisSCT")=$S(+SNOMED=-1:"",1:$P(SNOMED,U,2))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("DXMH")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHDX,.MHDXJ)
 ;
 QUIT
 ;
GET1FLAG(FLAG,FLAGIEN,RETJSON,FLAGJ) ;get one Flag record
 ;inputs: FLAGIEN - Flag IEN
 ;        RETJSON - J = Return JSON
 ;output: FLAG  - array of Flag data, by reference
 ;        FLAGJ - JSON structure of Flag data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Flag -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=26.13 ;PRF ASSIGNMENT
 N FNBR2 S FNBR2=26.132 ;ASSIGNMENT NARRATIVE
 N IENS1 S IENS1=FLAGIEN_","
 ;
 N FLAGARR,FLAGERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","FLAGARR","FLAGERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("FLAGARR")
 I $G(DEBUG),$D(FLAGERR) W ">>ERROR<<" W $$ZW^SYNDHPUTL("FLAGERR")
 I $D(FLAGERR) D  QUIT
 . S FLAG("Flag","ERROR")=FLAGIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.FLAG,.FLAGJ)
 S FLAG("Flag","flagIen")=FLAGIEN
 S FLAG("Flag","resourceType")="Flag"
 S FLAG("Flag","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,FLAGIEN)
 S FLAG("Flag","number")=$G(FLAGARR(FNBR1,IENS1,.001,"E"))
 S FLAG("Flag","patientName")=$G(FLAGARR(FNBR1,IENS1,.01,"E"))
 S FLAG("Flag","patientNameId")=$G(FLAGARR(FNBR1,IENS1,.01,"I"))
 S FLAG("Flag","patientNameICN")=$$GET1^DIQ(2,FLAG("Flag","patientNameId")_",",991.1)
 S FLAG("Flag","flagName")=$G(FLAGARR(FNBR1,IENS1,.02,"E"))
 S FLAG("Flag","flagNameId")=$G(FLAGARR(FNBR1,IENS1,.02,"I"))
 S FLAG("Flag","status")=$G(FLAGARR(FNBR1,IENS1,.03,"E"))
 S FLAG("Flag","statusCd")=$G(FLAGARR(FNBR1,IENS1,.03,"I"))
 S FLAG("Flag","ownerSite")=$G(FLAGARR(FNBR1,IENS1,.04,"E"))
 S FLAG("Flag","ownerSiteId")=$G(FLAGARR(FNBR1,IENS1,.04,"I"))
 S FLAG("Flag","originatingSite")=$G(FLAGARR(FNBR1,IENS1,.05,"E"))
 S FLAG("Flag","originatingSiteId")=$G(FLAGARR(FNBR1,IENS1,.05,"I"))
 S FLAG("Flag","reviewDate")=$G(FLAGARR(FNBR1,IENS1,.06,"E"))
 S FLAG("Flag","reviewDateFM")=$G(FLAGARR(FNBR1,IENS1,.06,"I"))
 S FLAG("Flag","reviewDateHL7")=$$FMTHL7^XLFDT($G(FLAGARR(FNBR1,IENS1,.06,"I")))
 S FLAG("Flag","reviewDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(FLAGARR(FNBR1,IENS1,.06,"I")))
 S FLAG("Flag","assignmentNarrative")=""
 N Z S Z=""
 F  S Z=$O(FLAGARR(FNBR1,IENS1,1,Z)) QUIT:'+Z  D
 . S FLAG("Flag","assignmentNarrative")=FLAG("Flag","assignmentNarrative")_$G(FLAGARR(FNBR1,IENS1,1,Z))_" "
 ;
 ;get snomed
 N SCT
 S SCT=$$MAP^SYNDHPMP("flag2sct",FLAG("Flag","flagName"),"D")
 S FLAG("Flag","flagSCT")=$S(+SCT=-1:"",1:$P(SCT,U,2))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("FLAG")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.FLAG,.FLAGJ)
 ;
 QUIT
 ;

SYNDHP18
SYNDHP18 ; HC/art - HealthConcourse - get care team data ;08/27/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ;The authoratative source for VA care team data is PCMM Web. (currently no connection is available.)
 ; PCMM Web updates VistA files on a regular basis.
 ;
 QUIT
 ;
GET1TEAM(TEAM,TEAMIEN,RETJSON,TEAMJ) ;get one care team
 ;inputs: TEAMIEN - team IEN
 ;        RETJSON - J = Return JSON
 ;                  null or any other value = Return array (default)
 ;output: TEAM    - array of team data, by reference
 ;        TEAMJ   - JSON structure of team data, by reference
 ;
 N FNBR1 S FNBR1=404.51 ;TEAM
 N FNBR2 S FNBR2=404.58 ;TEAM HISTORY
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N IENS S IENS=TEAMIEN_","
 N TMARR,TMERR
 D GETS^DIQ(FNBR1,IENS,"**","EI","TMARR","TMERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TMARR")
 I $G(DEBUG),$D(TMERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("TMERR")
 I $D(TMERR) D  QUIT
 . S TEAM("Team","ERROR")=TEAMIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.TEAM,.TEAMJ)
 S TEAM("Team","resourceType")="CareTeam"
 S TEAM("Team","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,TEAMIEN)
 S TEAM("Team","teamName")=$G(TMARR(FNBR1,IENS,.01,"E"))
 S TEAM("Team","fhirTeamType")="longitudinal"
 S TEAM("Team","teamPhone")=$G(TMARR(FNBR1,IENS,.02,"E"))
 S TEAM("Team","teamPurposeId")=$G(TMARR(FNBR1,IENS,.03,"I"))
 S TEAM("Team","teamPurpose")=$G(TMARR(FNBR1,IENS,.03,"E"))
 S TEAM("Team","teamPrinterId")=$G(TMARR(FNBR1,IENS,.04,"I"))
 S TEAM("Team","teamPrinter")=$G(TMARR(FNBR1,IENS,.04,"E"))
 S TEAM("Team","canBePcCd")=$G(TMARR(FNBR1,IENS,.05,"I"))
 S TEAM("Team","canBePC")=$G(TMARR(FNBR1,IENS,.05,"E"))
 S TEAM("Team","serviceDeptId")=$G(TMARR(FNBR1,IENS,.06,"I"))
 S TEAM("Team","serviceDept")=$G(TMARR(FNBR1,IENS,.06,"E"))
 S TEAM("Team","institutionId")=$G(TMARR(FNBR1,IENS,.07,"I"))
 S TEAM("Team","institution")=$G(TMARR(FNBR1,IENS,.07,"E"))
 S TEAM("Team","maxPatients")=$G(TMARR(FNBR1,IENS,.08,"E"))
 S TEAM("Team","max%PCPatients")=$G(TMARR(FNBR1,IENS,.09,"E"))
 S TEAM("Team","closeToFutureAssignId")=$G(TMARR(FNBR1,IENS,.1,"I"))
 S TEAM("Team","closeToFutureAssign")=$G(TMARR(FNBR1,IENS,.1,"E"))
 S TEAM("Team","autoAssignId")=$G(TMARR(FNBR1,IENS,.11,"I"))
 S TEAM("Team","autoAssign")=$G(TMARR(FNBR1,IENS,.11,"E"))
 S TEAM("Team","autoDischargeId")=$G(TMARR(FNBR1,IENS,.12,"I"))
 S TEAM("Team","autoDischarge")=$G(TMARR(FNBR1,IENS,.12,"E"))
 S TEAM("Team","restrictConsultsId")=$G(TMARR(FNBR1,IENS,.13,"I"))
 S TEAM("Team","restrictConsults")=$G(TMARR(FNBR1,IENS,.13,"E"))
 S TEAM("Team","description")=$G(TMARR(FNBR1,IENS,50,1))_$G(TMARR(FNBR1,IENS,50,2)) ;<<<
 S TEAM("Team","current#PatientsC")=$G(TMARR(FNBR1,IENS,201,"E"))
 S TEAM("Team","currentStatusC")=$G(TMARR(FNBR1,IENS,202,"E"))
 S TEAM("Team","currentEffectiveDateC")=$G(TMARR(FNBR1,IENS,203,"E"))
 S TEAM("Team","currentEffectiveDateCFM")=$$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,203,"E")))
 S TEAM("Team","currentEffectiveDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,203,"E"))))
 S TEAM("Team","currentEffectiveDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,203,"E"))))
 S TEAM("Team","currentActivationDateC")=$G(TMARR(FNBR1,IENS,204,"E"))
 S TEAM("Team","currentActivationDateCFM")=$$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,204,"E")))
 S TEAM("Team","currentActivationDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,204,"E"))))
 S TEAM("Team","currentActivationDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,204,"E"))))
 S TEAM("Team","currentInactivationDateC")=$G(TMARR(FNBR1,IENS,205,"E"))
 S TEAM("Team","currentInactivationDateCFM")=$$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,205,"E")))
 S TEAM("Team","currentInactivationDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,205,"E"))))
 S TEAM("Team","currentInactivationDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,205,"E"))))
 ;
 N STATIEN S STATIEN=0
 F  S STATIEN=$O(^SCTM(FNBR2,"B",TEAMIEN,STATIEN)) QUIT:+STATIEN=0  D
 . N IENS2 S IENS2=STATIEN_","
 . N STATARR,STATERR
 . D GETS^DIQ(FNBR2,IENS2,"**","EI","STATARR","STATERR")
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("STATARR")
 . I $G(DEBUG),$D(STATERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("STATERR")
 . I $D(STATERR) D  QUIT
 . . S TEAM("Team","teamStatus","status",STATIEN,"ERROR")=STATIEN
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.TEAM,.TEAMJ)
 . N TEAMSTAT S TEAMSTAT=$NA(TEAM("Team","teamStatus","status",STATIEN))
 . S @TEAMSTAT@("statusCd")=$G(STATARR(FNBR2,IENS2,.03,"I"))
 . S @TEAMSTAT@("status")=$G(STATARR(FNBR2,IENS2,.03,"E"))
 . S @TEAMSTAT@("effectiveDate")=$G(STATARR(FNBR2,IENS2,.02,"E"))
 . S @TEAMSTAT@("effectiveDateFM")=$G(STATARR(FNBR2,IENS2,.02,"I"))
 . S @TEAMSTAT@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(STATARR(FNBR2,IENS2,.02,"I")))
 . S @TEAMSTAT@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(STATARR(FNBR2,IENS2,.02,"I")))
 . S @TEAMSTAT@("statusReasonId")=$G(STATARR(FNBR2,IENS2,.04,"I"))
 . S @TEAMSTAT@("statusReason")=$G(STATARR(FNBR2,IENS2,.04,"E"))
 . S @TEAMSTAT@("statusRecordId")=$$RESID^SYNDHP69("V",SITE,FNBR2,STATIEN)
 ;
 N POSITION
 D TEAMPOS(.POSITION,TEAMIEN,0)
 M TEAM("Team","positions")=POSITION
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TEAM")
 ;
 I $G(RETJSON)="J" D
 . N TEAMS M TEAMS("Teams",TEAMIEN)=TEAM
 . D TOJASON^SYNDHPUTL(.TEAMS,.TEAMJ)
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TEAM")
 ;
 QUIT
 ;
TEAMPOS(POSITION,TEAMIEN,RETJSON,POSITIONJ) ;get team positions
 ;inputs: TEAMIEN - team IEN
 ;        RETJSON - J = Return JSON
 ;                  null or any other value = Return array (default)
 ;Output: POSITION - an array of position data, by reference
 ;        POSITIONJ - JSON structure, by reference
 ;
 N FNBR1 S FNBR1=404.57 ;TEAM POSITION
 N FNBR2 S FNBR2=404.575 ;TEAM POSITION:ASSOCIATED CLINICS
 N FNBR3 S FNBR3=404.59 ;TEAM POSITION HISTORY
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N POSIEN S POSIEN=0
 F  S POSIEN=$O(^SCTM(FNBR1,"C",TEAMIEN,POSIEN)) QUIT:+POSIEN=0  D
 . N IENS S IENS=POSIEN_","
 . N POSARR,POSERR
 . D GETS^DIQ(FNBR1,IENS,"**","EI","POSARR","POSERR")
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("POSARR")
 . I $G(DEBUG),$D(POSERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("POSERR")
 . I $D(POSERR) D  QUIT
 . . S POSITION("position",POSIEN,"ERROR")=POSIEN
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.POSITION,.POSITIONJ)
 . N TEAMPOS S TEAMPOS=$NA(POSITION("position",POSIEN))
 . S @TEAMPOS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,POSIEN)
 . S @TEAMPOS@("positionIen")=POSIEN
 . S @TEAMPOS@("positionName")=$G(POSARR(FNBR1,IENS,.01,"E"))
 . S @TEAMPOS@("teamId")=$G(POSARR(FNBR1,IENS,.02,"I"))
 . S @TEAMPOS@("team")=$G(POSARR(FNBR1,IENS,.02,"E"))
 . S @TEAMPOS@("standRoleNameId")=$G(POSARR(FNBR1,IENS,.03,"I"))
 . S @TEAMPOS@("standRoleName")=$G(POSARR(FNBR1,IENS,.03,"E"))
 . N SCT S SCT=$$MAP^SYNDHPMP("ctpos2sct",@TEAMPOS@("standRoleName"),"D")
 . S @TEAMPOS@("standRoleSct")=$S(+SCT=-1:"",1:$P(SCT,U,2))
 . S @TEAMPOS@("possPrimPractId")=$G(POSARR(FNBR1,IENS,.04,"I"))
 . S @TEAMPOS@("possPrimPract")=$G(POSARR(FNBR1,IENS,.04,"E"))
 . S @TEAMPOS@("max#patients")=$G(POSARR(FNBR1,IENS,.08,"E"))
 . ;S @TEAMPOS@("NAassocClinic")=$G(POSARR(FNBR1,IENS,.09,"E")) ;field is no longer used
 . S @TEAMPOS@("beeperNbr")=$G(POSARR(FNBR1,IENS,.11,"E"))
 . S @TEAMPOS@("canBePreceptor")=$G(POSARR(FNBR1,IENS,.12,"E"))
 . S @TEAMPOS@("userClass")=$G(POSARR(FNBR1,IENS,.13,"E"))
 . S @TEAMPOS@("description")=""
 . N Z S Z=""
 . F  S Z=$O(POSARR(FNBR1,IENS,1,Z)) QUIT:'+Z  D
 . . S @TEAMPOS@("description")=@TEAMPOS@("description")_$G(POSARR(FNBR1,IENS,1,Z))_" "
 . S @TEAMPOS@("deathMsg")=$G(POSARR(FNBR1,IENS,2.01,"E"))
 . S @TEAMPOS@("inpatientMsg")=$G(POSARR(FNBR1,IENS,2.02,"E"))
 . S @TEAMPOS@("teamMsg")=$G(POSARR(FNBR1,IENS,2.03,"E"))
 . S @TEAMPOS@("consultMsg")=$G(POSARR(FNBR1,IENS,2.04,"E"))
 . S @TEAMPOS@("precepDeathMsg")=$G(POSARR(FNBR1,IENS,2.05,"E"))
 . S @TEAMPOS@("precepInpatientMsg")=$G(POSARR(FNBR1,IENS,2.06,"E"))
 . S @TEAMPOS@("precepTeamMsg")=$G(POSARR(FNBR1,IENS,2.07,"E"))
 . S @TEAMPOS@("precepConsultMsg")=$G(POSARR(FNBR1,IENS,2.08,"E"))
 . S @TEAMPOS@("autoInactMsg")=$G(POSARR(FNBR1,IENS,2.09,"E"))
 . S @TEAMPOS@("precepInactMsg")=$G(POSARR(FNBR1,IENS,2.1,"E"))
 . S @TEAMPOS@("curr#PCpatsC")=$G(POSARR(FNBR1,IENS,200,"E"))
 . S @TEAMPOS@("curr#PatientsC")=$G(POSARR(FNBR1,IENS,201,"E"))
 . S @TEAMPOS@("future#PCpatsC")=$G(POSARR(FNBR1,IENS,202,"E"))
 . S @TEAMPOS@("future#PatientsC")=$G(POSARR(FNBR1,IENS,203,"E"))
 . S @TEAMPOS@("currStatusC")=$G(POSARR(FNBR1,IENS,300,"E"))
 . S @TEAMPOS@("currEffectDateC")=$G(POSARR(FNBR1,IENS,301,"E"))
 . S @TEAMPOS@("currEffectDateCFM")=$$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,301,"E")))
 . S @TEAMPOS@("currEffectDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,301,"E"))))
 . S @TEAMPOS@("currEffectDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,301,"E"))))
 . S @TEAMPOS@("currActDateC")=$G(POSARR(FNBR1,IENS,302,"E"))
 . S @TEAMPOS@("currActDateCFM")=$$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,302,"E")))
 . S @TEAMPOS@("currActDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,302,"E"))))
 . S @TEAMPOS@("currActDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,302,"E"))))
 . S @TEAMPOS@("currInactDateC")=$G(POSARR(FNBR1,IENS,303,"E"))
 . S @TEAMPOS@("currInactDateCFM")=$$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,303,"E")))
 . S @TEAMPOS@("currInactDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,303,"E"))))
 . S @TEAMPOS@("currInactDateFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,303,"E"))))
 . S @TEAMPOS@("currPractitionerC")=$G(POSARR(FNBR1,IENS,304,"E"))
 . S @TEAMPOS@("currPrecptorPosC")=$G(POSARR(FNBR1,IENS,305,"E"))
 . S @TEAMPOS@("currPreceptorC")=$G(POSARR(FNBR1,IENS,306,"E"))
 . S @TEAMPOS@("activePreceptsC")=$G(POSARR(FNBR1,IENS,307,"E"))
 . S @TEAMPOS@("allowPreceptedChngC")=$G(POSARR(FNBR1,IENS,400,"E"))
 . S @TEAMPOS@("allowPreceptorChngC")=$G(POSARR(FNBR1,IENS,401,"E"))
 . S @TEAMPOS@("inconsistentReasonC")=$G(POSARR(FNBR1,IENS,402,"E"))
 . ;
 . ;position assignment history
 . N ASGNHIST,ASGNHISTJ
 . ;D ASGNHIST^SYNDHP19(.ASGNHIST,TEAMIEN,0)
 . D ASGNHIST^SYNDHP19(.ASGNHIST,POSIEN,0)
 . M POSITION("position",POSIEN,"positionAssignmentHistory")=ASGNHIST
 . ;
 . ;preceptor assignment history
 . N PRECHIST,PRECHISTJ
 . D PRECHIST^SYNDHP19(.PRECHIST,POSIEN,0)
 . M POSITION("position",POSIEN,"preceptorAssignmentHistory")=PRECHIST
 . ;
 . N IENS2 S IENS2=""
 . F  S IENS2=$O(POSARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . . N TEAMCLIN S TEAMCLIN=$NA(POSITION("position",POSIEN,"associatedClinics","clinic",+IENS2))
 . . S @TEAMCLIN@("assocClincId")=$G(POSARR(FNBR2,IENS2,.01,"I"))
 . . S @TEAMCLIN@("assocClinc")=$G(POSARR(FNBR2,IENS2,.01,"E"))
 . . S @TEAMCLIN@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,POSIEN,FNBR2_U_+IENS2)
 . ;team position history
 . N STATIEN S STATIEN=0
 . F  S STATIEN=$O(^SCTM(FNBR3,"B",POSIEN,STATIEN)) QUIT:+STATIEN=0  D
 . . N IENS3 S IENS3=STATIEN_","
 . . N STATARR,STATERR
 . . D GETS^DIQ(FNBR3,IENS3,"**","EI","STATARR","STATERR")
 . . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("STATARR")
 . . I $G(DEBUG),$D(STATERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("STATERR")
 . . I $D(STATERR) S POSITION("position",POSIEN,"positionStatus","status",STATIEN,"ERROR")=STATIEN QUIT
 . . N POSSTAT S POSSTAT=$NA(POSITION("position",POSIEN,"positionStatus","status",STATIEN))
 . . S @POSSTAT@("statusCd")=$G(STATARR(FNBR3,IENS3,.03,"I"))
 . . S @POSSTAT@("status")=$G(STATARR(FNBR3,IENS3,.03,"E"))
 . . S @POSSTAT@("effectiveDate")=$G(STATARR(FNBR3,IENS3,.02,"E"))
 . . S @POSSTAT@("effectiveDateFM")=$G(STATARR(FNBR3,IENS3,.02,"I"))
 . . S @POSSTAT@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(STATARR(FNBR3,IENS3,.02,"I")))
 . . S @POSSTAT@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(STATARR(FNBR3,IENS3,.02,"I")))
 . . S @POSSTAT@("statusReasonId")=$G(STATARR(FNBR3,IENS3,.04,"I"))
 . . S @POSSTAT@("statusReason")=$G(STATARR(FNBR3,IENS3,.04,"E"))
 . . S @POSSTAT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR3,STATIEN)
 . . ;
 . . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("POSITION")
 ;
 I $G(RETJSON)="J" D
 . N POSITIONS M POSITIONS("TeamPositions")=POSITION
 . D TOJASON^SYNDHPUTL(.POSITIONS,.POSITIONJ)
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("POSITIONSJ")
 ;
 QUIT
 ;

SYNDHP19
SYNDHP19 ; HC/art - HealthConcourse - get care team data ;08/27/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ;The authoratative source for care team data is PCMM Web. (currently no connection is available.)
 ; PCMM Web updates VistA files on a regular basis.
 ;
 QUIT
 ;
ASGNHIST(ASGNHIST,POSIEN,RETJSON,ASGNHISTJ) ;get team position assignment history
 ;inputs: POSIEN - team position IEN
 ;        RETJSON - J = Return JSON
 ;                  null or any other value = Return array (default)
 ;Output: ASGNHIST - an array of position assignment history data, by reference
 ;        ASGNHISTJ - JSON structure, by reference
 ;
 N FNBR1 S FNBR1=404.52 ;POSITION ASSIGNMENT HISTORY
 N FNBR2 S FNBR2=404.521 ;POSITION ASSIGNMENT HISTORY:FTEE HISTORY
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N HISTIEN S HISTIEN=0
 F  S HISTIEN=$O(^SCTM(FNBR1,"B",POSIEN,HISTIEN)) QUIT:+HISTIEN=0  D
 . N IENS S IENS=HISTIEN_","
 . N HISTARR,HISTERR
 . D GETS^DIQ(FNBR1,IENS,"**","EI","HISTARR","HISTERR")
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HISTARR")
 . I $G(DEBUG),$D(HISTERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("HISTERR")
 . I $D(HISTERR) D  QUIT
 . . S ASGNHIST("posAssignHist",HISTIEN,"ERROR")=HISTIEN
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.ASGNHIST,.ASGNHISTJ)
 . N AHIST S AHIST=$NA(ASGNHIST("posAssignHist",HISTIEN))
 . S @AHIST@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,HISTIEN)
 . S @AHIST@("assignHistIen")=HISTIEN
 . S @AHIST@("teamPositionId")=$G(HISTARR(FNBR1,IENS,.01,"I"))
 . S @AHIST@("teamPositionName")=$G(HISTARR(FNBR1,IENS,.01,"E"))
 . S @AHIST@("effectiveDate")=$G(HISTARR(FNBR1,IENS,.02,"E"))
 . S @AHIST@("effectiveDateFM")=$G(HISTARR(FNBR1,IENS,.02,"I"))
 . S @AHIST@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.02,"I")))
 . S @AHIST@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.02,"I")))
 . S @AHIST@("practitionerId")=$G(HISTARR(FNBR1,IENS,.03,"I"))
 . S @AHIST@("practitioner")=$G(HISTARR(FNBR1,IENS,.03,"E"))
 . S @AHIST@("practitionerNPI")=$$GET1^DIQ(200,@AHIST@("practitionerId")_",",41.99) ;NPI
 . S @AHIST@("practitionerResId")=$$RESID^SYNDHP69("V",SITE,200,@AHIST@("practitionerId"))
 . S @AHIST@("statusCd")=$G(HISTARR(FNBR1,IENS,.04,"I"))
 . S @AHIST@("status")=$G(HISTARR(FNBR1,IENS,.04,"E"))
 . S @AHIST@("statusReasonId")=$G(HISTARR(FNBR1,IENS,.05,"I"))
 . S @AHIST@("statusReason")=$G(HISTARR(FNBR1,IENS,.05,"E"))
 . S @AHIST@("userEnteringId")=$G(HISTARR(FNBR1,IENS,.07,"I"))
 . S @AHIST@("userEntering")=$G(HISTARR(FNBR1,IENS,.07,"E"))
 . S @AHIST@("dateTimeEntered")=$G(HISTARR(FNBR1,IENS,.08,"E"))
 . S @AHIST@("dateTimeEnteredFM")=$G(HISTARR(FNBR1,IENS,.08,"I"))
 . S @AHIST@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.08,"I")))
 . S @AHIST@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.08,"I")))
 . S @AHIST@("fteeEquivalent")=$G(HISTARR(FNBR1,IENS,.09,"E"))
 . S @AHIST@("dateFlagedInactivation")=$G(HISTARR(FNBR1,IENS,.091,"E"))
 . S @AHIST@("dateFlagedInactivationFM")=$G(HISTARR(FNBR1,IENS,.091,"I"))
 . S @AHIST@("dateFlagedInactivationHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.091,"I")))
 . S @AHIST@("dateFlagedInactivationFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.091,"I")))
 . S @AHIST@("availablePositionsC")=$G(HISTARR(FNBR1,IENS,.096,"E"))
 . S @AHIST@("max#PatientsC")=$G(HISTARR(FNBR1,IENS,.097,"E"))
 . S @AHIST@("currActivePatientsC")=$G(HISTARR(FNBR1,IENS,.098,"E"))
 . S @AHIST@("adjustedPanelSizeC")=$G(HISTARR(FNBR1,IENS,.099,"E"))
 . S @AHIST@("inactivatedAutomaticlyCd")=$G(HISTARR(FNBR1,IENS,.011,"I"))
 . S @AHIST@("inactivatedAutomaticly")=$G(HISTARR(FNBR1,IENS,.011,"E"))
 . S @AHIST@("teamletPositionCd")=$G(HISTARR(FNBR1,IENS,.012,"I"))
 . S @AHIST@("teamletPosition")=$G(HISTARR(FNBR1,IENS,.012,"E"))
 . ;
 . N FTEE S FTEE=""
 . F  S FTEE=$O(HISTARR(FNBR2,FTEE)) QUIT:FTEE=""  D
 . . N FTEEHIST S FTEEHIST=$NA(ASGNHIST("posAssignHist",HISTIEN,"fteeHistory","fteeHist",+FTEE))
 . . S @FTEEHIST@("fteeHistoryDate")=$G(HISTARR(FNBR2,FTEE,.01,"E"))
 . . S @FTEEHIST@("fteeHistoryDateFM")=$G(HISTARR(FNBR2,FTEE,.01,"I"))
 . . S @FTEEHIST@("fteeHistoryDateHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR2,FTEE,.01,"I")))
 . . S @FTEEHIST@("fteeHistoryDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR2,FTEE,.01,"I")))
 . . S @FTEEHIST@("value")=$G(HISTARR(FNBR2,FTEE,.02,"I"))
 . . S @FTEEHIST@("userId")=$G(HISTARR(FNBR2,FTEE,.03,"I"))
 . . S @FTEEHIST@("user")=$G(HISTARR(FNBR2,FTEE,.03,"E"))
 . . S @FTEEHIST@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,HISTIEN,FNBR2_U_+FTEE)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("ASGNHIST")
 ;
 I $G(RETJSON)="J" D
 . ;N ASGNHISTS M ASGNHISTS("TeamPositionAssignmentHistory")=ASGNHIST
 . D TOJASON^SYNDHPUTL(.ASGNHIST,.ASGNHISTJ)
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("ASGNHISTJ")
 ;
 QUIT
 ;
PRECHIST(PRECHIST,POSIEN,RETJSON,PRECHISTJ) ;get preceptor assignment history
 ;inputs: POSIEN - team position IEN
 ;        RETJSON - J = Return JSON
 ;                  null or any other value = Return array (default)
 ;Output: PRECHIST - an array of preceptor history data, by reference
 ;        PRECHISTJ - JSON structure, by reference
 ;
 ;   >>>>>>>>>>>>>>>>>>>>>> UNTESTED, NO DATA IN OUR VISTA <<<<<<<<<<<<<<<<<<<<<<<<<<<<
 ;
 N FNBR1 S FNBR1=404.53 ;PRECEPTOR ASSIGNMENT HISTORY
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N PRECIEN S PRECIEN=0
 F  S PRECIEN=$O(^SCTM(FNBR1,"B",POSIEN,PRECIEN)) QUIT:+PRECIEN=0  D
 . N IENS S IENS=PRECIEN_","
 . N HISTARR,HISTERR
 . D GETS^DIQ(FNBR1,IENS,"**","EI","HISTARR","HISTERR")
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HISTARR")
 . I $G(DEBUG),$D(HISTERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("HISTERR")
 . I $D(HISTERR) D  QUIT
 . . S PRECHIST("preceptorAssignHist",PRECIEN,"ERROR")=PRECIEN
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PRECHIST,.PRECHISTJ)
 . N PHIST S PHIST=$NA(PRECHIST("preceptorAssignHist",PRECIEN))
 . S @PHIST@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PRECIEN)
 . S @PHIST@("preceptorHistoryIen")=PRECIEN
 . S @PHIST@("teamPositionId")=$G(HISTARR(FNBR1,IENS,.01,"I"))
 . S @PHIST@("teamPositionName")=$G(HISTARR(FNBR1,IENS,.01,"E"))
 . S @PHIST@("effectiveDate")=$G(HISTARR(FNBR1,IENS,.02,"E"))
 . S @PHIST@("effectiveDateFM")=$G(HISTARR(FNBR1,IENS,.02,"I"))
 . S @PHIST@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.02,"I")))
 . S @PHIST@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.02,"I")))
 . S @PHIST@("statusCd")=$G(HISTARR(FNBR1,IENS,.04,"I"))
 . S @PHIST@("statusReason")=$G(HISTARR(FNBR1,IENS,.05,"E"))
 . S @PHIST@("PreceptorTeamPositionId")=$G(HISTARR(FNBR1,IENS,.06,"I"))
 . S @PHIST@("PreceptorTeamPosition")=$G(HISTARR(FNBR1,IENS,.06,"E"))
 . S @PHIST@("userEnteringId")=$G(HISTARR(FNBR1,IENS,.07,"I"))
 . S @PHIST@("userEntering")=$G(HISTARR(FNBR1,IENS,.07,"E"))
 . S @PHIST@("dateTimeEntered")=$G(HISTARR(FNBR1,IENS,.08,"E"))
 . S @PHIST@("dateTimeEnteredFM")=$G(HISTARR(FNBR1,IENS,.08,"I"))
 . S @PHIST@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.08,"I")))
 . S @PHIST@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.08,"I")))
 . S @PHIST@("preceptorNameC")=$G(HISTARR(FNBR1,IENS,200,"E"))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PRECHIST")
 ;
 I $G(RETJSON)="J" D
 . N PRECHISTS M PRECHISTS("TeamPreceptorHistory")=PRECHIST
 . D TOJASON^SYNDHPUTL(.PRECHISTS,.PRECHISTJ)
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PRECHISTSJ")
 ;
 QUIT
 ;

SYNDHP20
SYNDHP20 ; HC/art - HealthConcourse - get patient demographic data ;07/08/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GETPATIENT(PATIENT,PATIENTIEN,RETJSON,PATIENTJ) ;get one Patient record
 ; This API does not include all data in the Patient file. Only select patient demographic data are included.
 ;inputs: PATIENTIEN - Patient IEN
 ;        RETJSON - J = Return JSON
 ;output: PATIENT  - array of Patient Demographic data, by reference
 ;        PATIENTJ - JSON structure of Patient Demographic data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Patient Demographic -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=2 ;PATIENT
 N FNBR2 S FNBR2=2.141 ;CONFIDENTIAL ADDRESS CATEGORY
 N FNBR3 S FNBR3=2.01 ;ALIAS
 N FNBR4 S FNBR4=2.02 ;RACE INFORMATION
 N FNBR5 S FNBR5=2.06 ;ETHNICITY INFORMATION
 N IENS1 S IENS1=PATIENTIEN_","
 ;
 N PATIENTARR,PATIENTERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","PATIENTARR","PATIENTERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PATIENTARR")
 I $G(DEBUG),$D(PATIENTERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("PATIENTERR")
 I $D(PATIENTERR) D  QUIT
 . S PATIENT("Patient","ERROR")=PATIENTIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATIENT,.PATIENTJ)
 S PATIENT("Patient","patientIen")=PATIENTIEN
 S PATIENT("Patient","resourceType")="Patient"
 S PATIENT("Patient","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIENTIEN)
 S PATIENT("Patient","name")=$G(PATIENTARR(FNBR1,IENS1,.01,"E"))
 S PATIENT("Patient","nameFirst")=$P($P(PATIENT("Patient","name"),",",2)," ",1)
 S PATIENT("Patient","nameLast")=$P(PATIENT("Patient","name"),",",1)
 S PATIENT("Patient","nameMiddle")=$P($P(PATIENT("Patient","name"),",",2)," ",2)
 S PATIENT("Patient","sex")=$G(PATIENTARR(FNBR1,IENS1,.02,"E"))
 S PATIENT("Patient","sexCd")=$G(PATIENTARR(FNBR1,IENS1,.02,"I"))
 S PATIENT("Patient","selfIdentifiedGender")=$G(PATIENTARR(FNBR1,IENS1,.024,"E"))
 S PATIENT("Patient","selfIdentifiedGenderCd")=$G(PATIENTARR(FNBR1,IENS1,.024,"I"))
 S PATIENT("Patient","dateOfBirth")=$G(PATIENTARR(FNBR1,IENS1,.03,"E"))
 S PATIENT("Patient","dateOfBirthFM")=$G(PATIENTARR(FNBR1,IENS1,.03,"I"))
 S PATIENT("Patient","dateOfBirthHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.03,"I")))
 S PATIENT("Patient","dateOfBirthFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.03,"I")))
 S PATIENT("Patient","age")=$G(PATIENTARR(FNBR1,IENS1,.033,"E"))
 S PATIENT("Patient","maritalStatus")=$G(PATIENTARR(FNBR1,IENS1,.05,"E"))
 S PATIENT("Patient","maritalStatusId")=$G(PATIENTARR(FNBR1,IENS1,.05,"I"))
 S PATIENT("Patient","race")=$G(PATIENTARR(FNBR1,IENS1,.06,"E"))
 S PATIENT("Patient","raceId")=$G(PATIENTARR(FNBR1,IENS1,.06,"I"))
 S PATIENT("Patient","occupation")=$G(PATIENTARR(FNBR1,IENS1,.07,"E"))
 S PATIENT("Patient","religiousPreference")=$G(PATIENTARR(FNBR1,IENS1,.08,"E"))
 S PATIENT("Patient","socialSecurityNumber")=$G(PATIENTARR(FNBR1,IENS1,.09,"E"))
 S PATIENT("Patient","terminalDigitOfSsn")=$G(PATIENTARR(FNBR1,IENS1,.0901,"E"))
 S PATIENT("Patient","initlast4")=$G(PATIENTARR(FNBR1,IENS1,.0905,"E"))
 S PATIENT("Patient","remarks")=$G(PATIENTARR(FNBR1,IENS1,.091,"E"))
 S PATIENT("Patient","placeOfBirthCity")=$G(PATIENTARR(FNBR1,IENS1,.092,"E"))
 S PATIENT("Patient","placeOfBirthState")=$G(PATIENTARR(FNBR1,IENS1,.093,"E"))
 S PATIENT("Patient","placeOfBirthStateId")=$G(PATIENTARR(FNBR1,IENS1,.093,"I"))
 S PATIENT("Patient","streetAddressLine1")=$G(PATIENTARR(FNBR1,IENS1,.111,"E"))
 S PATIENT("Patient","streetAddressLine2")=$G(PATIENTARR(FNBR1,IENS1,.112,"E"))
 S PATIENT("Patient","streetAddressLine3")=$G(PATIENTARR(FNBR1,IENS1,.113,"E"))
 S PATIENT("Patient","city")=$G(PATIENTARR(FNBR1,IENS1,.114,"E"))
 S PATIENT("Patient","state")=$G(PATIENTARR(FNBR1,IENS1,.115,"E"))
 S PATIENT("Patient","stateId")=$G(PATIENTARR(FNBR1,IENS1,.115,"I"))
 S PATIENT("Patient","zipCode")=$G(PATIENTARR(FNBR1,IENS1,.116,"E"))
 S PATIENT("Patient","zip4")=$G(PATIENTARR(FNBR1,IENS1,.1112,"E"))
 S PATIENT("Patient","county")=$G(PATIENTARR(FNBR1,IENS1,.117,"E"))
 S PATIENT("Patient","province")=$G(PATIENTARR(FNBR1,IENS1,.1171,"E"))
 S PATIENT("Patient","postalCode")=$G(PATIENTARR(FNBR1,IENS1,.1172,"E"))
 S PATIENT("Patient","country")=$G(PATIENTARR(FNBR1,IENS1,.1173,"E"))
 S PATIENT("Patient","countryId")=$G(PATIENTARR(FNBR1,IENS1,.1173,"I"))
 S PATIENT("Patient","phoneNumberResidence")=$G(PATIENTARR(FNBR1,IENS1,.131,"E"))
 S PATIENT("Patient","phoneNumberWork")=$G(PATIENTARR(FNBR1,IENS1,.132,"E"))
 S PATIENT("Patient","emailAddress")=$G(PATIENTARR(FNBR1,IENS1,.133,"E"))
 S PATIENT("Patient","phoneNumberCellular")=$G(PATIENTARR(FNBR1,IENS1,.134,"E"))
 S PATIENT("Patient","pagerNumber")=$G(PATIENTARR(FNBR1,IENS1,.135,"E"))
 S PATIENT("Patient","tempAddressActive")=$G(PATIENTARR(FNBR1,IENS1,.12105,"E"))
 S PATIENT("Patient","tempAddressActiveCd")=$G(PATIENTARR(FNBR1,IENS1,.12105,"I"))
 S PATIENT("Patient","tempStreetLine1")=$G(PATIENTARR(FNBR1,IENS1,.1211,"E"))
 S PATIENT("Patient","tempStreetLine2")=$G(PATIENTARR(FNBR1,IENS1,.1212,"E"))
 S PATIENT("Patient","tempStreetLine3")=$G(PATIENTARR(FNBR1,IENS1,.1213,"E"))
 S PATIENT("Patient","tempCity")=$G(PATIENTARR(FNBR1,IENS1,.1214,"E"))
 S PATIENT("Patient","tempState")=$G(PATIENTARR(FNBR1,IENS1,.1215,"E"))
 S PATIENT("Patient","tempStateId")=$G(PATIENTARR(FNBR1,IENS1,.1215,"I"))
 S PATIENT("Patient","tempZipCode")=$G(PATIENTARR(FNBR1,IENS1,.1216,"E"))
 S PATIENT("Patient","tempZip4")=$G(PATIENTARR(FNBR1,IENS1,.12112,"E"))
 S PATIENT("Patient","tempAddressCounty")=$G(PATIENTARR(FNBR1,IENS1,.12111,"E"))
 S PATIENT("Patient","tempAddressProvince")=$G(PATIENTARR(FNBR1,IENS1,.1221,"E"))
 S PATIENT("Patient","tempAddressPostalCode")=$G(PATIENTARR(FNBR1,IENS1,.1222,"E"))
 S PATIENT("Patient","tempAddressCountry")=$G(PATIENTARR(FNBR1,IENS1,.1223,"E"))
 S PATIENT("Patient","tempAddressCountryId")=$G(PATIENTARR(FNBR1,IENS1,.1223,"I"))
 S PATIENT("Patient","tempPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.1219,"E"))
 S PATIENT("Patient","tempAddressStartDate")=$G(PATIENTARR(FNBR1,IENS1,.1217,"E"))
 S PATIENT("Patient","tempAddressStartDateFM")=$G(PATIENTARR(FNBR1,IENS1,.1217,"I"))
 S PATIENT("Patient","tempAddressStartDateHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.1217,"I")))
 S PATIENT("Patient","tempAddressStartDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.1217,"I")))
 S PATIENT("Patient","tempAddressEndDate")=$G(PATIENTARR(FNBR1,IENS1,.1218,"E"))
 S PATIENT("Patient","tempAddressEndDateFM")=$G(PATIENTARR(FNBR1,IENS1,.1218,"I"))
 S PATIENT("Patient","tempAddressEndDateHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.1218,"I")))
 S PATIENT("Patient","tempAddressEndDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.1218,"I")))
 S PATIENT("Patient","emergencyResponseIndicator")=$G(PATIENTARR(FNBR1,IENS1,.181,"E"))
 S PATIENT("Patient","emergencyResponseIndicatorCd")=$G(PATIENTARR(FNBR1,IENS1,.181,"I"))
 S PATIENT("Patient","kNameOfPrimaryNok")=$G(PATIENTARR(FNBR1,IENS1,.211,"E"))
 S PATIENT("Patient","kRelationshipToPatient")=$G(PATIENTARR(FNBR1,IENS1,.212,"E"))
 S PATIENT("Patient","kAddressSameAsPatientS")=$G(PATIENTARR(FNBR1,IENS1,.2125,"E"))
 S PATIENT("Patient","kAddressSameAsPatientSCd")=$G(PATIENTARR(FNBR1,IENS1,.2125,"I"))
 S PATIENT("Patient","kStreetAddressLine1")=$G(PATIENTARR(FNBR1,IENS1,.213,"E"))
 S PATIENT("Patient","kStreetAddressLine2")=$G(PATIENTARR(FNBR1,IENS1,.214,"E"))
 S PATIENT("Patient","kStreetAddressLine3")=$G(PATIENTARR(FNBR1,IENS1,.215,"E"))
 S PATIENT("Patient","kCity")=$G(PATIENTARR(FNBR1,IENS1,.216,"E"))
 S PATIENT("Patient","kState")=$G(PATIENTARR(FNBR1,IENS1,.217,"E"))
 S PATIENT("Patient","kStateId")=$G(PATIENTARR(FNBR1,IENS1,.217,"I"))
 S PATIENT("Patient","kZipCode")=$G(PATIENTARR(FNBR1,IENS1,.218,"E"))
 S PATIENT("Patient","kZip4")=$G(PATIENTARR(FNBR1,IENS1,.2207,"E"))
 S PATIENT("Patient","kPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.219,"E"))
 S PATIENT("Patient","kWorkPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.21011,"E"))
 S PATIENT("Patient","fatherSName")=$G(PATIENTARR(FNBR1,IENS1,.2401,"E"))
 S PATIENT("Patient","motherSName")=$G(PATIENTARR(FNBR1,IENS1,.2402,"E"))
 S PATIENT("Patient","motherSMaidenName")=$G(PATIENTARR(FNBR1,IENS1,.2403,"E"))
 S PATIENT("Patient","employerName")=$G(PATIENTARR(FNBR1,IENS1,.3111,"E"))
 S PATIENT("Patient","employmentStatus")=$G(PATIENTARR(FNBR1,IENS1,.31115,"E"))
 S PATIENT("Patient","employmentStatusCd")=$G(PATIENTARR(FNBR1,IENS1,.31115,"I"))
 S PATIENT("Patient","governmentAgency")=$G(PATIENTARR(FNBR1,IENS1,.3112,"E"))
 S PATIENT("Patient","governmentAgencyCd")=$G(PATIENTARR(FNBR1,IENS1,.3112,"I"))
 S PATIENT("Patient","employerStreetLine1")=$G(PATIENTARR(FNBR1,IENS1,.3113,"E"))
 S PATIENT("Patient","employerStreetLine2")=$G(PATIENTARR(FNBR1,IENS1,.3114,"E"))
 S PATIENT("Patient","employerStreetLine3")=$G(PATIENTARR(FNBR1,IENS1,.3115,"E"))
 S PATIENT("Patient","employerCity")=$G(PATIENTARR(FNBR1,IENS1,.3116,"E"))
 S PATIENT("Patient","employerState")=$G(PATIENTARR(FNBR1,IENS1,.3117,"E"))
 S PATIENT("Patient","employerStateId")=$G(PATIENTARR(FNBR1,IENS1,.3117,"I"))
 S PATIENT("Patient","employerZipCode")=$G(PATIENTARR(FNBR1,IENS1,.3118,"E"))
 S PATIENT("Patient","employerZip4")=$G(PATIENTARR(FNBR1,IENS1,.2205,"E"))
 S PATIENT("Patient","employerPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.3119,"E"))
 S PATIENT("Patient","emrContactSameAsNok")=$G(PATIENTARR(FNBR1,IENS1,.3305,"E"))
 S PATIENT("Patient","emrContactSameAsNokCd")=$G(PATIENTARR(FNBR1,IENS1,.3305,"I"))
 S PATIENT("Patient","emrName")=$G(PATIENTARR(FNBR1,IENS1,.331,"E"))
 S PATIENT("Patient","emrRelationshipToPatient")=$G(PATIENTARR(FNBR1,IENS1,.332,"E"))
 S PATIENT("Patient","emrStreetAddressLine1")=$G(PATIENTARR(FNBR1,IENS1,.333,"E"))
 S PATIENT("Patient","emrStreetAddressLine2")=$G(PATIENTARR(FNBR1,IENS1,.334,"E"))
 S PATIENT("Patient","emrStreetAddressLine3")=$G(PATIENTARR(FNBR1,IENS1,.335,"E"))
 S PATIENT("Patient","emrCity")=$G(PATIENTARR(FNBR1,IENS1,.336,"E"))
 S PATIENT("Patient","emrState")=$G(PATIENTARR(FNBR1,IENS1,.337,"E"))
 S PATIENT("Patient","emrStateId")=$G(PATIENTARR(FNBR1,IENS1,.337,"I"))
 S PATIENT("Patient","emrZipCode")=$G(PATIENTARR(FNBR1,IENS1,.338,"E"))
 S PATIENT("Patient","emrZip4")=$G(PATIENTARR(FNBR1,IENS1,.2201,"E"))
 S PATIENT("Patient","emrPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.339,"E"))
 S PATIENT("Patient","emrWorkPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.33011,"E"))
 S PATIENT("Patient","dateOfDeath")=$G(PATIENTARR(FNBR1,IENS1,.351,"E"))
 S PATIENT("Patient","dateOfDeathFM")=$G(PATIENTARR(FNBR1,IENS1,.351,"I"))
 S PATIENT("Patient","dateOfDeathHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.351,"I")))
 S PATIENT("Patient","dateOfDeathFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.351,"I")))
 S PATIENT("Patient","deathEnteredBy")=$G(PATIENTARR(FNBR1,IENS1,.352,"E"))
 S PATIENT("Patient","deathEnteredById")=$G(PATIENTARR(FNBR1,IENS1,.352,"I"))
 S PATIENT("Patient","testPatientIndicator")=$G(PATIENTARR(FNBR1,IENS1,.6,"E"))
 S PATIENT("Patient","testPatientIndicatorCd")=$G(PATIENTARR(FNBR1,IENS1,.6,"I"))
 S PATIENT("Patient","preferredFacility")=$G(PATIENTARR(FNBR1,IENS1,27.02,"E"))
 S PATIENT("Patient","preferredFacilityId")=$G(PATIENTARR(FNBR1,IENS1,27.02,"I"))
 S PATIENT("Patient","integrationControlNumber")=$G(PATIENTARR(FNBR1,IENS1,991.01,"E"))
 S PATIENT("Patient","icnChecksum")=$G(PATIENTARR(FNBR1,IENS1,991.02,"E"))
 S PATIENT("Patient","fullICN")=$G(PATIENTARR(FNBR1,IENS1,991.1,"E"))
 S PATIENT("Patient","multipleBirthIndicator")=$G(PATIENTARR(FNBR1,IENS1,994,"E"))
 S PATIENT("Patient","multipleBirthIndicatorCd")=$G(PATIENTARR(FNBR1,IENS1,994,"I"))
 S PATIENT("Patient","veteranYN")=$G(PATIENTARR(FNBR1,IENS1,1901,"E"))
 S PATIENT("Patient","veteranYNCd")=$G(PATIENTARR(FNBR1,IENS1,1901,"I"))
 N IENS2 S IENS2=""
 F  S IENS2=$O(PATIENTARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N CONFADRS S CONFADRS=$NA(PATIENT("Patient","confidentialAddressCategorys","confidentialAddressCategory",+IENS2))
 . S @CONFADRS@("confidentialAddressCategory")=$G(PATIENTARR(FNBR2,IENS2,.01,"E"))
 . S @CONFADRS@("confidentialAddressCategoryCd")=$G(PATIENTARR(FNBR2,IENS2,.01,"I"))
 . S @CONFADRS@("confidentialCategoryActive")=$G(PATIENTARR(FNBR2,IENS2,1,"E"))
 . S @CONFADRS@("confidentialCategoryActiveCd")=$G(PATIENTARR(FNBR2,IENS2,1,"I"))
 . S @CONFADRS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIENTIEN,FNBR2_U_+IENS2)
 N IENS3 S IENS3=""
 F  S IENS3=$O(PATIENTARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N ALIAS S ALIAS=$NA(PATIENT("Patient","aliass","alias",+IENS3))
 . S @ALIAS@("alias")=$G(PATIENTARR(FNBR3,IENS3,.01,"E"))
 . S @ALIAS@("aliasSsn")=$G(PATIENTARR(FNBR3,IENS3,1,"E"))
 . S @ALIAS@("aliasComponents")=$G(PATIENTARR(FNBR3,IENS3,100.03,"E"))
 . S @ALIAS@("aliasComponentsId")=$G(PATIENTARR(FNBR3,IENS3,100.03,"I"))
 . S @ALIAS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIENTIEN,FNBR3_U_+IENS3)
 N IENS4 S IENS4=""
 F  S IENS4=$O(PATIENTARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N RACE S RACE=$NA(PATIENT("Patient","raceInformations","raceInformation",+IENS4))
 . S @RACE@("raceInformation")=$G(PATIENTARR(FNBR4,IENS4,.01,"E"))
 . S @RACE@("raceInformationId")=$G(PATIENTARR(FNBR4,IENS4,.01,"I"))
 . S @RACE@("methodOfCollection")=$G(PATIENTARR(FNBR4,IENS4,.02,"E"))
 . S @RACE@("methodOfCollectionId")=$G(PATIENTARR(FNBR4,IENS4,.02,"I"))
 . S @RACE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIENTIEN,FNBR4_U_+IENS4)
 N IENS5 S IENS5=""
 F  S IENS5=$O(PATIENTARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . N ETHNIC S ETHNIC=$NA(PATIENT("Patient","ethnicityInformations","ethnicityInformation",+IENS5))
 . S @ETHNIC@("ethnicityInformation")=$G(PATIENTARR(FNBR5,IENS5,.01,"E"))
 . S @ETHNIC@("ethnicityInformationId")=$G(PATIENTARR(FNBR5,IENS5,.01,"I"))
 . S @ETHNIC@("methodOfCollection")=$G(PATIENTARR(FNBR5,IENS5,.02,"E"))
 . S @ETHNIC@("methodOfCollectionId")=$G(PATIENTARR(FNBR5,IENS5,.02,"I"))
 . S @ETHNIC@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIENTIEN,FNBR5_U_+IENS5)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PATIENT")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATIENT,.PATIENTJ)
 ;
 QUIT
 ;

SYNDHP21
SYNDHP21 ; HC/art - HealthConcourse - get patient lab data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GETLABS(LABS,LABREF,RETJSON,LABSJ) ;get Patient Labs records
 ;inputs: LABREF - Labs IEN (patient LRDFN)
 ;        RETJSON - J = Return JSON
 ;output: LABS  - array of Labs data, by reference
 ;        LABSJ - JSON structure of Labs data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Labs -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=63 ;LAB DATA
 N FNBR2 S FNBR2=63.04 ;CHEM, HEM, TOX, RIA, SER, etc.
 N FNBR3 S FNBR3=63.07 ;ORDERED TEST
 N IENS1 S IENS1=LABREF_","
 ;
 N LABSARR,LABSERR,INVDT,RESULT,LOINC
 D GETS^DIQ(FNBR1,IENS1,"**","EI","LABSARR","LABSERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("LABSARR")
 I $G(DEBUG),$D(LABSERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("LABSERR")
 I $D(LABSERR) D  QUIT
 . S LABS("Lab","ERROR")=LABREF
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.LABS,.LABSJ)
 S LABS("Lab","labsIen")=LABREF
 S LABS("Lab","resourceType")="Laboratory"
 S LABS("Lab","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,LABREF)
 S LABS("Lab","lrDfn")=$G(LABSARR(FNBR1,IENS1,.01,"E"))
 S LABS("Lab","patientName")=$G(LABSARR(FNBR1,IENS1,.03,"E"))
 S LABS("Lab","patientNameId")=$G(LABSARR(FNBR1,IENS1,.03,"I"))
 S LABS("Lab","patientNameIcn")=$$ICN^SYNDHPUTL(LABS("Lab","patientNameId"))
 S LABS("Lab","doNotTransfuse")=$G(LABSARR(FNBR1,IENS1,.04,"E"))
 S LABS("Lab","doNotTransfuseCd")=$G(LABSARR(FNBR1,IENS1,.04,"I"))
 S LABS("Lab","aboGroup")=$G(LABSARR(FNBR1,IENS1,.05,"E"))
 S LABS("Lab","aboGroupCd")=$G(LABSARR(FNBR1,IENS1,.05,"I"))
 S LABS("Lab","rhType")=$G(LABSARR(FNBR1,IENS1,.06,"E"))
 S LABS("Lab","rhTypeCd")=$G(LABSARR(FNBR1,IENS1,.06,"I"))
 S LABS("Lab","hospitalId")=$G(LABSARR(FNBR1,IENS1,.09,"E"))
 N IENS2 S IENS2=""
 F  S IENS2=$O(LABSARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N CHEMLABS S CHEMLABS=$NA(LABS("Lab","chemHemToxRiaSerEtcs","chemHemToxRiaSerEtc",+IENS2))
 . S @CHEMLABS@("dateTimeSpecimenTaken")=$G(LABSARR(FNBR2,IENS2,.01,"E"))
 . S @CHEMLABS@("dateTimeSpecimenTakenFM")=$G(LABSARR(FNBR2,IENS2,.01,"I"))
 . S @CHEMLABS@("dateTimeSpecimenTakenHL7")=$$FMTHL7^XLFDT($G(LABSARR(FNBR2,IENS2,.01,"I")))
 . S @CHEMLABS@("dateTimeSpecimenTakenFHIR")=$$FMTFHIR^SYNDHPUTL($G(LABSARR(FNBR2,IENS2,.01,"I")))
 . S @CHEMLABS@("dateTimeObtainedInexact")=$G(LABSARR(FNBR2,IENS2,.02,"E"))
 . S @CHEMLABS@("dateTimeObtainedInexactCd")=$G(LABSARR(FNBR2,IENS2,.02,"I"))
 . S @CHEMLABS@("dateReportCompleted")=$G(LABSARR(FNBR2,IENS2,.03,"E"))
 . S @CHEMLABS@("dateReportCompletedFM")=$G(LABSARR(FNBR2,IENS2,.03,"I"))
 . S @CHEMLABS@("dateReportCompletedHL7")=$$FMTHL7^XLFDT($G(LABSARR(FNBR2,IENS2,.03,"I")))
 . S @CHEMLABS@("dateReportCompletedFHIR")=$$FMTFHIR^SYNDHPUTL($G(LABSARR(FNBR2,IENS2,.03,"I")))
 . S @CHEMLABS@("verifyPerson")=$G(LABSARR(FNBR2,IENS2,.04,"E"))
 . S @CHEMLABS@("verifyPersonId")=$G(LABSARR(FNBR2,IENS2,.04,"I"))
 . S @CHEMLABS@("verifyPersonNPI")=$$GET1^DIQ(200,@CHEMLABS@("verifyPersonId")_",",41.99) ;NPI
 . S @CHEMLABS@("verifyPersonResId")=$$RESID^SYNDHP69("V",SITE,200,@CHEMLABS@("verifyPersonId"))
 . S @CHEMLABS@("specimenType")=$G(LABSARR(FNBR2,IENS2,.05,"E"))
 . S @CHEMLABS@("specimenTypeId")=$G(LABSARR(FNBR2,IENS2,.05,"I"))
 . S @CHEMLABS@("accession")=$G(LABSARR(FNBR2,IENS2,.06,"E"))
 . S @CHEMLABS@("volume")=$G(LABSARR(FNBR2,IENS2,.07,"E"))
 . S @CHEMLABS@("methodOrSite")=$G(LABSARR(FNBR2,IENS2,.08,"E"))
 . S @CHEMLABS@("sumReportNum")=$G(LABSARR(FNBR2,IENS2,.09,"E"))
 . S @CHEMLABS@("requestingPerson")=$G(LABSARR(FNBR2,IENS2,.1,"E"))
 . S @CHEMLABS@("requestingPersonId")=$G(LABSARR(FNBR2,IENS2,.1,"I"))
 . S @CHEMLABS@("requestingPersonNPI")=$$GET1^DIQ(200,@CHEMLABS@("requestingPersonId")_",",41.99) ;NPI
 . S @CHEMLABS@("requestingPersonResId")=$$RESID^SYNDHP69("V",SITE,200,@CHEMLABS@("requestingPersonId"))
 . S @CHEMLABS@("requestingLocation")=$G(LABSARR(FNBR2,IENS2,.11,"E"))
 . S @CHEMLABS@("requestingLocDiv")=$G(LABSARR(FNBR2,IENS2,.111,"E"))
 . S @CHEMLABS@("requestingLocDivId")=$G(LABSARR(FNBR2,IENS2,.111,"I"))
 . S @CHEMLABS@("accessioningInstitution")=$G(LABSARR(FNBR2,IENS2,.112,"E"))
 . S @CHEMLABS@("accessioningInstitutionId")=$G(LABSARR(FNBR2,IENS2,.112,"I"))
 . S @CHEMLABS@("uid")=$G(LABSARR(FNBR2,IENS2,.31,"E"))
 . S @CHEMLABS@("orderingSite")=$G(LABSARR(FNBR2,IENS2,.32,"E"))
 . S @CHEMLABS@("orderingSiteId")=$G(LABSARR(FNBR2,IENS2,.32,"I"))
 . S @CHEMLABS@("collectingSite")=$G(LABSARR(FNBR2,IENS2,.33,"E"))
 . S @CHEMLABS@("collectingSiteId")=$G(LABSARR(FNBR2,IENS2,.33,"I"))
 . S @CHEMLABS@("hostUid")=$G(LABSARR(FNBR2,IENS2,.34,"E"))
 . S @CHEMLABS@("orderingSiteUid")=$G(LABSARR(FNBR2,IENS2,.342,"E"))
 . S @CHEMLABS@("releasingSite")=$G(LABSARR(FNBR2,IENS2,.345,"E"))
 . S @CHEMLABS@("releasingSiteId")=$G(LABSARR(FNBR2,IENS2,.345,"I"))
 . S @CHEMLABS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,LABREF,FNBR2_U_+IENS2)
 . ;"secret" data in the results field
 . S INVDT=9999999-@CHEMLABS@("dateTimeSpecimenTakenFM")
 . N RESULT
 . D GETRESLT(LABREF,INVDT,.RESULT)
 . S @CHEMLABS@("labTestId")=$G(RESULT("labTestId"))
 . S @CHEMLABS@("labTestName")=$G(RESULT("labTestName"))
 . S @CHEMLABS@("result")=$G(RESULT("result"))
 . S @CHEMLABS@("flag")=$G(RESULT("flag"))
 . S @CHEMLABS@("referenceHigh")=$G(RESULT("referenceHigh"))
 . S @CHEMLABS@("referenceLow")=$G(RESULT("referenceLow"))
 . S @CHEMLABS@("criticalHigh")=$G(RESULT("criticalHigh"))
 . S @CHEMLABS@("criticalLow")=$G(RESULT("criticalLow"))
 . S @CHEMLABS@("units")=$G(RESULT("units"))
 . S @CHEMLABS@("typographyId")=$G(RESULT("typographyId"))
 . S @CHEMLABS@("typography")=$G(RESULT("typography"))
 . S @CHEMLABS@("workloadCd")=$G(RESULT("workloadCd"))
 . S @CHEMLABS@("workloadProcedure")=$G(RESULT("workloadProcedure"))
 . ;get loinc
 . I @CHEMLABS@("labTestId")'="",@CHEMLABS@("labTestName")'="",@CHEMLABS@("typographyId")'="" D
 . . S LOINC=$$GETLOINC(@CHEMLABS@("labTestId"),@CHEMLABS@("labTestName"),@CHEMLABS@("typographyId"))
 . . S @CHEMLABS@("loincCode")=$P(LOINC,U,1)
 . . S @CHEMLABS@("loincName")=$P(LOINC,U,2)
 . E  D
 . . S @CHEMLABS@("loincCode")=""
 . . S @CHEMLABS@("loincName")=""
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("LABS")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.LABS,.LABSJ)
 ;
 QUIT
 ;
GETRESLT(lrDfn,invDate,ret) ;get chem lab test result
 quit:('$get(lrDfn))!('$get(invDate))
 ;
 new node
 new fieldnbr set fieldnbr=$order(^LR(lrDfn,"CH",invDate,1))
 if fieldnbr'="",$data(^LR(lrDfn,"CH",invDate,fieldnbr)) do
 . set ret("resultFor")=$piece($get(^DD(63.04,fieldnbr,0)),U,1)
 . set node=^LR(lrDfn,"CH",invDate,fieldnbr)
 . set ret("result")=$piece(node,U,1)
 . set ret("flag")=$piece(node,U,2)
 . set ret("workloadCd")=$piece($piece(node,U,3),"!",1)
 . if ret("workloadCd")'="" set ret("workloadProcedure")=$$GET1^DIQ(64,$order(^LAM("C",ret("workloadCd")_" ",""))_",",.01)
 . set ret("labTestId")=$piece($piece(node,U,3),"!",7)
 . set ret("labTestName")=$$GET1^DIQ(60,ret("labTestId")_",",.01)
 . set ret("verifyById")=$piece(node,U,4)
 . set ret("verifyBy")=$$GET1^DIQ(200,ret("verifyById")_",",.01)
 . set ret("typographyId")=$piece($piece(node,U,5),"!",1)
 . set ret("typography")=$$GET1^DIQ(61,ret("typographyId")_",",.01)
 . set ret("referenceLow")=$piece($piece(node,U,5),"!",2)
 . set ret("referenceHigh")=$piece($piece(node,U,5),"!",3)
 . set ret("criticalLow")=$piece($piece(node,U,5),"!",4)
 . set ret("criticalHigh")=$piece($piece(node,U,5),"!",5)
 . set ret("units")=$piece($piece(node,U,5),"!",7)
 . set ret("institutionId")=$piece(node,U,9)
 . set ret("institution")=$$GET1^DIQ(4,ret("institutionId")_",",.01)
 ;2)="110^^84330.0000!!!!!!175^1^72!60!110!50!300!!mg/dL!!!^^^^500"
 quit
 ;
GETLOINC(TESTIEN,TESTNAME,TYPE) ; get loinc code for test
 ;returns - loinc code ^ loinc code name (or test name)
 ;
 N IENS S IENS=TYPE_","_TESTIEN_","
 N LOINCCD S LOINCCD=$$GET1^DIQ(60.01,IENS,95.3) ;loinc code from laboratory test:site/specimen (60:100)
 N LOINCNM S LOINCNM=$$GET1^DIQ(95.3,+LOINCCD_",",80) ;loinc fully specified name
 ;if not found in Vista, then use SYNGRAPH below
 I LOINCCD="" D
 . S LOINCCD=$$graphmap^SYNGRAPH("loinc-lab-map",TESTNAME,"LOINC")
 . I +LOINCCD=-1 D
 . . S LOINCCD=""
 . . S LOINCNM=TESTNAME
 . E  D
 . . S LOINCNM=$$GET1^DIQ(95.3,+LOINCCD_",",80) ;loinc fully specified name
 ;
 QUIT LOINCCD_U_LOINCNM
 ;

SYNDHP22
SYNDHP22 ; HC/art - HealthConcourse - get hospital location data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GETHLOC(HOSPLOC,HLOCIEN,RETJSON,HOSPLOCJ) ;get one Hospital Location record
 ; This API does not return all Hospital Location fields. In general, fields related to appointments are omitted
 ;inputs: HLOCIEN - Hospital Location IEN
 ;        RETJSON - J = Return JSON
 ;output: HOSPLOC  - array of Hospital Location data, by reference
 ;        HOSPLOCJ - JSON structure of Hospital Location data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Hospital Location -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=44 ;HOSPITAL LOCATION
 N FNBR2 S FNBR2=44.01 ;SYNONYM
 N FNBR3 S FNBR3=44.101 ;ASSOCIATED LOCATION TYPES
 N FNBR4 S FNBR4=44.1 ;PROVIDER
 N IENS1 S IENS1=HLOCIEN_","
 N FIELDS S FIELDS=".01:4;7:10;13*;14:16;23;42;99;99.1;101*;1916;1920.9;2502;2503:2506;2600*"
 ;
 N HOSPLOCARR,HOSPLOCERR
 D GETS^DIQ(FNBR1,IENS1,FIELDS,"EI","HOSPLOCARR","HOSPLOCERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HOSPLOCARR")
 I $G(DEBUG),$D(HOSPLOCERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("HOSPLOCERR")
 I $D(HOSPLOCERR) D  QUIT
 . S HOSPLOC("Hosploc","ERROR")=HLOCIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.HOSPLOC,.HOSPLOCJ)
 N HLOC S HLOC=$NA(HOSPLOC("Hosploc"))
 S @HLOC@("hosplocIen")=HLOCIEN
 S @HLOC@("resourceType")="Organization"
 S @HLOC@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,HLOCIEN)
 S @HLOC@("name")=$G(HOSPLOCARR(FNBR1,IENS1,.01,"E"))
 S @HLOC@("abbreviation")=$G(HOSPLOCARR(FNBR1,IENS1,1,"E"))
 S @HLOC@("type")=$G(HOSPLOCARR(FNBR1,IENS1,2,"E"))
 S @HLOC@("typeCd")=$G(HOSPLOCARR(FNBR1,IENS1,2,"I"))
 S @HLOC@("typeExtension")=$G(HOSPLOCARR(FNBR1,IENS1,2.1,"E"))
 S @HLOC@("typeExtensionId")=$G(HOSPLOCARR(FNBR1,IENS1,2.1,"I"))
 S @HLOC@("institution")=$G(HOSPLOCARR(FNBR1,IENS1,3,"E"))
 S @HLOC@("institutionId")=$G(HOSPLOCARR(FNBR1,IENS1,3,"I"))
 S @HLOC@("division")=$G(HOSPLOCARR(FNBR1,IENS1,3.5,"E"))
 S @HLOC@("divisionId")=$G(HOSPLOCARR(FNBR1,IENS1,3.5,"I"))
 S @HLOC@("module")=$G(HOSPLOCARR(FNBR1,IENS1,4,"E"))
 S @HLOC@("moduleId")=$G(HOSPLOCARR(FNBR1,IENS1,4,"I"))
 S @HLOC@("visitLocation")=$G(HOSPLOCARR(FNBR1,IENS1,7,"E"))
 S @HLOC@("stopCodeNumber")=$G(HOSPLOCARR(FNBR1,IENS1,8,"E"))
 S @HLOC@("stopCodeNumberId")=$G(HOSPLOCARR(FNBR1,IENS1,8,"I"))
 S @HLOC@("prvYearStopCode")=$G(HOSPLOCARR(FNBR1,IENS1,8.1,"E"))
 S @HLOC@("prvYearStopCodeId")=$G(HOSPLOCARR(FNBR1,IENS1,8.1,"I"))
 S @HLOC@("service")=$G(HOSPLOCARR(FNBR1,IENS1,9,"E"))
 S @HLOC@("serviceCd")=$G(HOSPLOCARR(FNBR1,IENS1,9,"I"))
 S @HLOC@("treatingSpecialty")=$G(HOSPLOCARR(FNBR1,IENS1,9.5,"E"))
 S @HLOC@("treatingSpecialtyId")=$G(HOSPLOCARR(FNBR1,IENS1,9.5,"I"))
 S @HLOC@("physicalLocation")=$G(HOSPLOCARR(FNBR1,IENS1,10,"E"))
 S @HLOC@("specialAmisStop")=$G(HOSPLOCARR(FNBR1,IENS1,14,"E"))
 S @HLOC@("specialAmisStopCd")=$G(HOSPLOCARR(FNBR1,IENS1,14,"I"))
 S @HLOC@("categoryOfVisit")=$G(HOSPLOCARR(FNBR1,IENS1,15,"E"))
 S @HLOC@("defaultProvider")=$G(HOSPLOCARR(FNBR1,IENS1,16,"E"))
 S @HLOC@("defaultProviderId")=$G(HOSPLOCARR(FNBR1,IENS1,16,"I"))
 S @HLOC@("defaultProviderNPI")=$$GET1^DIQ(200,@HLOC@("defaultProviderId")_",",41.99) ;NPI
 S @HLOC@("agency")=$G(HOSPLOCARR(FNBR1,IENS1,23,"E"))
 S @HLOC@("agencyId")=$G(HOSPLOCARR(FNBR1,IENS1,23,"I"))
 S @HLOC@("wardLocationFilePointer")=$G(HOSPLOCARR(FNBR1,IENS1,42,"E"))
 S @HLOC@("wardLocationFilePointerId")=$G(HOSPLOCARR(FNBR1,IENS1,42,"I"))
 S @HLOC@("telephone")=$G(HOSPLOCARR(FNBR1,IENS1,99,"E"))
 S @HLOC@("telephoneExtension")=$G(HOSPLOCARR(FNBR1,IENS1,99.1,"E"))
 S @HLOC@("principalClinic")=$G(HOSPLOCARR(FNBR1,IENS1,1916,"E"))
 S @HLOC@("principalClinicId")=$G(HOSPLOCARR(FNBR1,IENS1,1916,"I"))
 S @HLOC@("availabilityFlag")=$G(HOSPLOCARR(FNBR1,IENS1,1920.9,"E"))
 S @HLOC@("availabilityFlagFM")=$G(HOSPLOCARR(FNBR1,IENS1,1920.9,"I"))
 S @HLOC@("availabilityFlagHL7")=$$FMTHL7^XLFDT($G(HOSPLOCARR(FNBR1,IENS1,1920.9,"I")))
 S @HLOC@("availabilityFlagFHIR")=$$FMTFHIR^SYNDHPUTL($G(HOSPLOCARR(FNBR1,IENS1,1920.9,"I")))
 S @HLOC@("nonCountClinicYOrN")=$G(HOSPLOCARR(FNBR1,IENS1,2502,"E"))
 S @HLOC@("nonCountClinicYOrNCd")=$G(HOSPLOCARR(FNBR1,IENS1,2502,"I"))
 S @HLOC@("creditStopCode")=$G(HOSPLOCARR(FNBR1,IENS1,2503,"E"))
 S @HLOC@("creditStopCodeId")=$G(HOSPLOCARR(FNBR1,IENS1,2503,"I"))
 S @HLOC@("prvYearCreditStopCode")=$G(HOSPLOCARR(FNBR1,IENS1,2503.1,"E"))
 S @HLOC@("prvYearCreditStopCodeId")=$G(HOSPLOCARR(FNBR1,IENS1,2503.1,"I"))
 S @HLOC@("clinicMeetsAtThisFacility")=$G(HOSPLOCARR(FNBR1,IENS1,2504,"E"))
 S @HLOC@("clinicMeetsAtThisFacilityCd")=$G(HOSPLOCARR(FNBR1,IENS1,2504,"I"))
 S @HLOC@("inactivateDate")=$G(HOSPLOCARR(FNBR1,IENS1,2505,"E"))
 S @HLOC@("inactivateDateFM")=$G(HOSPLOCARR(FNBR1,IENS1,2505,"I"))
 S @HLOC@("inactivateDateHL7")=$$FMTHL7^XLFDT($G(HOSPLOCARR(FNBR1,IENS1,2505,"I")))
 S @HLOC@("inactivateDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HOSPLOCARR(FNBR1,IENS1,2505,"I")))
 S @HLOC@("reactivateDate")=$G(HOSPLOCARR(FNBR1,IENS1,2506,"E"))
 S @HLOC@("reactivateDateFM")=$G(HOSPLOCARR(FNBR1,IENS1,2506,"I"))
 S @HLOC@("reactivateDateHL7")=$$FMTHL7^XLFDT($G(HOSPLOCARR(FNBR1,IENS1,2506,"I")))
 S @HLOC@("reactivateDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HOSPLOCARR(FNBR1,IENS1,2506,"I")))
 N IENS2 S IENS2=""
 F  S IENS2=$O(HOSPLOCARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N SYNONYM S SYNONYM=$NA(HOSPLOC("Hosploc","synonyms","synonym",+IENS2))
 . S @SYNONYM@("synonym")=$G(HOSPLOCARR(FNBR2,IENS2,.01,"E"))
 . S @SYNONYM@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,HLOCIEN,FNBR2_U_+IENS2)
 N IENS3 S IENS3=""
 F  S IENS3=$O(HOSPLOCARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N ASSLOCTP S ASSLOCTP=$NA(HOSPLOC("Hosploc","associatedLocationTypess","associatedLocationTypes",+IENS3))
 . S @ASSLOCTP@("associatedLocationTypes")=$G(HOSPLOCARR(FNBR3,IENS3,.01,"E"))
 . S @ASSLOCTP@("associatedLocationTypesId")=$G(HOSPLOCARR(FNBR3,IENS3,.01,"I"))
 . S @ASSLOCTP@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,HLOCIEN,FNBR3_U_+IENS3)
 N IENS4 S IENS4=""
 F  S IENS4=$O(HOSPLOCARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N PROVIDER S PROVIDER=$NA(HOSPLOC("Hosploc","providers","provider",+IENS4))
 . S @PROVIDER@("provider")=$G(HOSPLOCARR(FNBR4,IENS4,.01,"E"))
 . S @PROVIDER@("providerId")=$G(HOSPLOCARR(FNBR4,IENS4,.01,"I"))
 . S @PROVIDER@("providerNPI")=$$GET1^DIQ(200,@PROVIDER@("providerId")_",",41.99) ;NPI
 . S @PROVIDER@("providerResId")=$$RESID^SYNDHP69("V",SITE,200,@PROVIDER@("providerId"))
 . S @PROVIDER@("defaultProvider")=$G(HOSPLOCARR(FNBR4,IENS4,.02,"E"))
 . S @PROVIDER@("defaultProviderCd")=$G(HOSPLOCARR(FNBR4,IENS4,.02,"I"))
 . S @PROVIDER@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,HLOCIEN,FNBR4_U_+IENS4)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HOSPLOC")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.HOSPLOC,.HOSPLOCJ)
 ;
 QUIT
 ;

SYNDHP23
SYNDHP23 ; HC/art - HealthConcourse - get visit provider data ;08/30/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1VPROV(VPROV,VPROVIEN,RETJSON,VPROVJ) ;get one V Provider record
 ;inputs: VPROVIEN - V Provider IEN
 ;        RETJSON - J = Return JSON
 ;output: VPROV  - array of V Provider data, by reference
 ;        VPROVJ - JSON structure of V Provider data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- V Provider -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=9000010.06 ;V PROVIDER
 N IENS1 S IENS1=VPROVIEN_","
 ;
 N VPROVARR,VPROVERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VPROVARR","VPROVERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VPROVARR")
 I $G(DEBUG),$D(VPROVERR) W ">>ERROR<<",! W $$ZW^SYNDHPUTL("VPROVERR")
 I $D(VPROVERR) D  QUIT
 . S VPROV("Vprov","ERROR")=VPROVIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPROV,.VPROVJ)
 S VPROV("Vprov","vprovIen")=VPROVIEN
 S VPROV("Vprov","resourceType")="Encounter"
 S VPROV("Vprov","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,VPROVIEN)
 S VPROV("Vprov","provider")=$G(VPROVARR(FNBR1,IENS1,.01,"E"))
 S VPROV("Vprov","providerId")=$G(VPROVARR(FNBR1,IENS1,.01,"I"))
 S VPROV("Vprov","providerNPI")=$$GET1^DIQ(200,VPROV("Vprov","providerId")_",",41.99) ;NPI
 S VPROV("Vprov","providerResId")=$$RESID^SYNDHP69("V",SITE,200,VPROV("Vprov","providerId"))
 S VPROV("Vprov","patientName")=$G(VPROVARR(FNBR1,IENS1,.02,"E"))
 S VPROV("Vprov","patientNameId")=$G(VPROVARR(FNBR1,IENS1,.02,"I"))
 S VPROV("Vprov","patientICN")=$$GET1^DIQ(2,VPROV("Vprov","patientNameId")_",",991.1)
 S VPROV("Vprov","visit")=$G(VPROVARR(FNBR1,IENS1,.03,"E"))
 S VPROV("Vprov","visitId")=$G(VPROVARR(FNBR1,IENS1,.03,"I"))
 S VPROV("Vprov","visitFM")=$$GET1^DIQ(9000010,VPROV("Vprov","visitId")_",",.01,"I")
 S VPROV("Vprov","visitHL7")=$$FMTHL7^XLFDT(VPROV("Vprov","visitFM"))
 S VPROV("Vprov","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VPROV("Vprov","visitFM"))
 S VPROV("Vprov","visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,VPROV("Vprov","visitId"))
 S VPROV("Vprov","primarySecondary")=$G(VPROVARR(FNBR1,IENS1,.04,"E"))
 S VPROV("Vprov","primarySecondaryCd")=$G(VPROVARR(FNBR1,IENS1,.04,"I"))
 S VPROV("Vprov","primarySecondarySc")=$$SENTENCE^XLFSTR(VPROV("Vprov","primarySecondary"))
 S VPROV("Vprov","operatingAttending")=$G(VPROVARR(FNBR1,IENS1,.05,"E"))
 S VPROV("Vprov","operatingAttendingCd")=$G(VPROVARR(FNBR1,IENS1,.05,"I"))
 S VPROV("Vprov","personClass")=$G(VPROVARR(FNBR1,IENS1,.06,"E"))
 S VPROV("Vprov","personClassId")=$G(VPROVARR(FNBR1,IENS1,.06,"I"))
 S VPROV("Vprov","eventDateAndTime")=$G(VPROVARR(FNBR1,IENS1,1201,"E"))
 S VPROV("Vprov","eventDateAndTimeFM")=$G(VPROVARR(FNBR1,IENS1,1201,"I"))
 S VPROV("Vprov","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VPROVARR(FNBR1,IENS1,1201,"I")))
 S VPROV("Vprov","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VPROVARR(FNBR1,IENS1,1201,"I")))
 S VPROV("Vprov","editedFlag")=$G(VPROVARR(FNBR1,IENS1,80101,"E"))
 S VPROV("Vprov","editedFlagCd")=$G(VPROVARR(FNBR1,IENS1,80101,"I"))
 S VPROV("Vprov","auditTrail")=$G(VPROVARR(FNBR1,IENS1,80102,"E"))
 S VPROV("Vprov","comments")=$G(VPROVARR(FNBR1,IENS1,81101,"E"))
 S VPROV("Vprov","verified")=$G(VPROVARR(FNBR1,IENS1,81201,"E"))
 S VPROV("Vprov","verifiedCd")=$G(VPROVARR(FNBR1,IENS1,81201,"I"))
 S VPROV("Vprov","package")=$G(VPROVARR(FNBR1,IENS1,81202,"E"))
 S VPROV("Vprov","packageId")=$G(VPROVARR(FNBR1,IENS1,81202,"I"))
 S VPROV("Vprov","dataSource")=$G(VPROVARR(FNBR1,IENS1,81203,"E"))
 S VPROV("Vprov","dataSourceId")=$G(VPROVARR(FNBR1,IENS1,81203,"I"))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VPROV")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPROV,.VPROVJ)
 ;
 QUIT
 ;

SYNDHP24
SYNDHP24 ; HC/art - HealthConcourse - get TIU note data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1TIU(TIU,TIUIEN,RETJSON,TIUJ) ;get one TIU record
 ;inputs: TIUIEN - TIU IEN
 ;        RETJSON - J = Return JSON
 ;output: TIU  - array of TIU data, by reference
 ;        TIUJ - JSON structure of TIU data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- TIU -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=8925 ;TIU DOCUMENT
 N FNBR2 S FNBR2=8925.02 ;REPORT TEXT
 N IENS1 S IENS1=TIUIEN_","
 ;
 N TIUARR,TIUERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","TIUARR","TIUERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TIUARR")
 I $G(DEBUG),$D(TIUERR) W !,">>ERROR<<" W ! W $$ZW^SYNDHPUTL("TIUERR")
 I $D(TIUERR) D  QUIT
 . S TIU("Tiu","ERROR")=TIUIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.TIU,.TIUJ)
 S TIU("Tiu","tiuIen")=TIUIEN
 S TIU("Tiu","resourceType")="TiuNote"
 S TIU("Tiu","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,TIUIEN)
 S TIU("Tiu","documentType")=$G(TIUARR(FNBR1,IENS1,.01,"E"))
 S TIU("Tiu","documentTypeId")=$G(TIUARR(FNBR1,IENS1,.01,"I"))
 S TIU("Tiu","patient")=$G(TIUARR(FNBR1,IENS1,.02,"E"))
 S TIU("Tiu","patientId")=$G(TIUARR(FNBR1,IENS1,.02,"I"))
 S TIU("Tiu","patientICN")=$$GET1^DIQ(2,TIU("Tiu","patientId")_",",991.1)
 S TIU("Tiu","visit")=$G(TIUARR(FNBR1,IENS1,.03,"E"))
 S TIU("Tiu","visitId")=$G(TIUARR(FNBR1,IENS1,.03,"I"))
 S TIU("Tiu","visitFM")=$$GET1^DIQ(9000010,TIU("Tiu","visitId")_",",.01,"I")
 S TIU("Tiu","visitHL7")=$$FMTHL7^XLFDT(TIU("Tiu","visitFM"))
 S TIU("Tiu","visitFHIR")=$$FMTFHIR^SYNDHPUTL(TIU("Tiu","visitFM"))
 S TIU("Tiu","visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,TIU("Tiu","visitId"))
 S TIU("Tiu","parentDocumentType")=$G(TIUARR(FNBR1,IENS1,.04,"E"))
 S TIU("Tiu","parentDocumentTypeId")=$G(TIUARR(FNBR1,IENS1,.04,"I"))
 S TIU("Tiu","status")=$G(TIUARR(FNBR1,IENS1,.05,"E"))
 S TIU("Tiu","statusId")=$G(TIUARR(FNBR1,IENS1,.05,"I"))
 S TIU("Tiu","statusFHIR")=$$NOTSTAT($$LOW^XLFSTR(TIU("Tiu","status")))
 S TIU("Tiu","parent")=$G(TIUARR(FNBR1,IENS1,.06,"E"))
 S TIU("Tiu","parentId")=$G(TIUARR(FNBR1,IENS1,.06,"I"))
 S TIU("Tiu","episodeBeginDateTime")=$G(TIUARR(FNBR1,IENS1,.07,"E"))
 S TIU("Tiu","episodeBeginDateTimeFM")=$G(TIUARR(FNBR1,IENS1,.07,"I"))
 S TIU("Tiu","episodeBeginDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,.07,"I")))
 S TIU("Tiu","episodeBeginDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,.07,"I")))
 S TIU("Tiu","episodeEndDateTime")=$G(TIUARR(FNBR1,IENS1,.08,"E"))
 S TIU("Tiu","episodeEndDateTimeFM")=$G(TIUARR(FNBR1,IENS1,.08,"I"))
 S TIU("Tiu","episodeEndDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,.08,"I")))
 S TIU("Tiu","episodeEndDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,.08,"I")))
 S TIU("Tiu","urgency")=$G(TIUARR(FNBR1,IENS1,.09,"E"))
 S TIU("Tiu","urgencyCd")=$G(TIUARR(FNBR1,IENS1,.09,"I"))
 S TIU("Tiu","lineCount")=$G(TIUARR(FNBR1,IENS1,.1,"E"))
 S TIU("Tiu","creditStopCodeOnCompletion")=$G(TIUARR(FNBR1,IENS1,.11,"E"))
 S TIU("Tiu","creditStopCodeOnCompletionCd")=$G(TIUARR(FNBR1,IENS1,.11,"I"))
 S TIU("Tiu","markDischDtForCorrection")=$G(TIUARR(FNBR1,IENS1,.12,"E"))
 S TIU("Tiu","markDischDtForCorrectionCd")=$G(TIUARR(FNBR1,IENS1,.12,"I"))
 S TIU("Tiu","visitType")=$G(TIUARR(FNBR1,IENS1,.13,"E"))
 S TIU("Tiu","reportText")=""
 N Z S Z=""
 F  S Z=$O(TIUARR(FNBR1,IENS1,2,Z)) QUIT:'+Z  D
 . S TIU("Tiu","reportText")=TIU("Tiu","reportText")_$$ESC^XLFJSON($G(TIUARR(FNBR1,IENS1,2,Z)))_"\n"
 S TIU("Tiu","entryDateTime")=$G(TIUARR(FNBR1,IENS1,1201,"E"))
 S TIU("Tiu","entryDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1201,"I"))
 S TIU("Tiu","entryDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1201,"I")))
 S TIU("Tiu","entryDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1201,"I")))
 S TIU("Tiu","authorDictator")=$G(TIUARR(FNBR1,IENS1,1202,"E"))
 S TIU("Tiu","authorDictatorId")=$G(TIUARR(FNBR1,IENS1,1202,"I"))
 S TIU("Tiu","authorDictatorNPI")=$$GET1^DIQ(200,TIU("Tiu","authorDictatorId")_",",41.99) ;NPI
 S TIU("Tiu","authorDictatorResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","authorDictatorId"))
 S TIU("Tiu","clinic")=$G(TIUARR(FNBR1,IENS1,1203,"E"))
 S TIU("Tiu","clinicId")=$G(TIUARR(FNBR1,IENS1,1203,"I"))
 S TIU("Tiu","expectedSigner")=$G(TIUARR(FNBR1,IENS1,1204,"E"))
 S TIU("Tiu","expectedSignerId")=$G(TIUARR(FNBR1,IENS1,1204,"I"))
 S TIU("Tiu","expectedSignerNPI")=$$GET1^DIQ(200,TIU("Tiu","expectedSignerId")_",",41.99) ;NPI
 S TIU("Tiu","expectedSignerResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","expectedSignerId"))
 S TIU("Tiu","hospitalLocation")=$G(TIUARR(FNBR1,IENS1,1205,"E"))
 S TIU("Tiu","hospitalLocationId")=$G(TIUARR(FNBR1,IENS1,1205,"I"))
 S TIU("Tiu","serviceCreditStop")=$G(TIUARR(FNBR1,IENS1,1206,"E"))
 S TIU("Tiu","serviceCreditStopId")=$G(TIUARR(FNBR1,IENS1,1206,"I"))
 S TIU("Tiu","secondaryVisit")=$G(TIUARR(FNBR1,IENS1,1207,"E"))
 S TIU("Tiu","secondaryVisitId")=$G(TIUARR(FNBR1,IENS1,1207,"I"))
 S TIU("Tiu","expectedCosigner")=$G(TIUARR(FNBR1,IENS1,1208,"E"))
 S TIU("Tiu","expectedCosignerId")=$G(TIUARR(FNBR1,IENS1,1208,"I"))
 S TIU("Tiu","expectedCosignerNPI")=$$GET1^DIQ(200,TIU("Tiu","expectedCosignerId")_",",41.99) ;NPI
 S TIU("Tiu","expectedCosignerResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","expectedCosignerId"))
 S TIU("Tiu","attendingPhysician")=$G(TIUARR(FNBR1,IENS1,1209,"E"))
 S TIU("Tiu","attendingPhysicianId")=$G(TIUARR(FNBR1,IENS1,1209,"I"))
 S TIU("Tiu","attendingPhysicianNPI")=$$GET1^DIQ(200,TIU("Tiu","attendingPhysicianId")_",",41.99) ;NPI
 S TIU("Tiu","attendingPhysicianResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","attendingPhysicianId"))
 S TIU("Tiu","orderNumber")=$G(TIUARR(FNBR1,IENS1,1210,"E"))
 S TIU("Tiu","orderNumberId")=$G(TIUARR(FNBR1,IENS1,1210,"I"))
 S TIU("Tiu","visitLocation")=$G(TIUARR(FNBR1,IENS1,1211,"E"))
 S TIU("Tiu","visitLocationId")=$G(TIUARR(FNBR1,IENS1,1211,"I"))
 S TIU("Tiu","division")=$G(TIUARR(FNBR1,IENS1,1212,"E"))
 S TIU("Tiu","divisionId")=$G(TIUARR(FNBR1,IENS1,1212,"I"))
 S TIU("Tiu","referenceDate")=$G(TIUARR(FNBR1,IENS1,1301,"E"))
 S TIU("Tiu","referenceDateFM")=$G(TIUARR(FNBR1,IENS1,1301,"I"))
 S TIU("Tiu","referenceDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1301,"I")))
 S TIU("Tiu","referenceDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1301,"I")))
 S TIU("Tiu","enteredBy")=$G(TIUARR(FNBR1,IENS1,1302,"E"))
 S TIU("Tiu","enteredById")=$G(TIUARR(FNBR1,IENS1,1302,"I"))
 S TIU("Tiu","enteredByNPI")=$$GET1^DIQ(200,TIU("Tiu","enteredById")_",",41.99) ;NPI
 S TIU("Tiu","enteredByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","enteredById"))
 S TIU("Tiu","captureMethod")=$G(TIUARR(FNBR1,IENS1,1303,"E"))
 S TIU("Tiu","captureMethodCd")=$G(TIUARR(FNBR1,IENS1,1303,"I"))
 S TIU("Tiu","releaseDateTime")=$G(TIUARR(FNBR1,IENS1,1304,"E"))
 S TIU("Tiu","releaseDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1304,"I"))
 S TIU("Tiu","releaseDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1304,"I")))
 S TIU("Tiu","releaseDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1304,"I")))
 S TIU("Tiu","verificationDateTime")=$G(TIUARR(FNBR1,IENS1,1305,"E"))
 S TIU("Tiu","verificationDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1305,"I"))
 S TIU("Tiu","verificationDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1305,"I")))
 S TIU("Tiu","verificationDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1305,"I")))
 S TIU("Tiu","verifiedBy")=$G(TIUARR(FNBR1,IENS1,1306,"E"))
 S TIU("Tiu","verifiedById")=$G(TIUARR(FNBR1,IENS1,1306,"I"))
 S TIU("Tiu","verifiedByNPI")=$$GET1^DIQ(200,TIU("Tiu","verifiedById")_",",41.99) ;NPI
 S TIU("Tiu","verifiedByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","verifiedById"))
 S TIU("Tiu","dictationDate")=$G(TIUARR(FNBR1,IENS1,1307,"E"))
 S TIU("Tiu","dictationDateFM")=$G(TIUARR(FNBR1,IENS1,1307,"I"))
 S TIU("Tiu","dictationDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1307,"I")))
 S TIU("Tiu","dictationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1307,"I")))
 S TIU("Tiu","suspenseDateTime")=$G(TIUARR(FNBR1,IENS1,1308,"E"))
 S TIU("Tiu","suspenseDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1308,"I"))
 S TIU("Tiu","suspenseDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1308,"I")))
 S TIU("Tiu","suspenseDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1308,"I")))
 S TIU("Tiu","patientMovementRecord")=$G(TIUARR(FNBR1,IENS1,1401,"E"))
 S TIU("Tiu","patientMovementRecordId")=$G(TIUARR(FNBR1,IENS1,1401,"I"))
 S TIU("Tiu","treatingSpecialty")=$G(TIUARR(FNBR1,IENS1,1402,"E"))
 S TIU("Tiu","treatingSpecialtyId")=$G(TIUARR(FNBR1,IENS1,1402,"I"))
 S TIU("Tiu","irtRecord")=$G(TIUARR(FNBR1,IENS1,1403,"E"))
 S TIU("Tiu","irtRecordId")=$G(TIUARR(FNBR1,IENS1,1403,"I"))
 S TIU("Tiu","service")=$G(TIUARR(FNBR1,IENS1,1404,"E"))
 S TIU("Tiu","serviceId")=$G(TIUARR(FNBR1,IENS1,1404,"I"))
 S TIU("Tiu","requestingPackageReference")=$G(TIUARR(FNBR1,IENS1,1405,"E"))
 S TIU("Tiu","requestingPackageReferenceId")=$G(TIUARR(FNBR1,IENS1,1405,"I"))
 S TIU("Tiu","retractedOriginal")=$G(TIUARR(FNBR1,IENS1,1406,"E"))
 S TIU("Tiu","retractedOriginalId")=$G(TIUARR(FNBR1,IENS1,1406,"I"))
 S TIU("Tiu","prfFlagAction")=$G(TIUARR(FNBR1,IENS1,1407,"E"))
 S TIU("Tiu","signatureDateTime")=$G(TIUARR(FNBR1,IENS1,1501,"E"))
 S TIU("Tiu","signatureDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1501,"I"))
 S TIU("Tiu","signatureDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1501,"I")))
 S TIU("Tiu","signatureDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1501,"I")))
 S TIU("Tiu","signedBy")=$G(TIUARR(FNBR1,IENS1,1502,"E"))
 S TIU("Tiu","signedById")=$G(TIUARR(FNBR1,IENS1,1502,"I"))
 S TIU("Tiu","signedByNPI")=$$GET1^DIQ(200,TIU("Tiu","signedById")_",",41.99) ;NPI
 S TIU("Tiu","signedByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","signedById"))
 S TIU("Tiu","signatureBlockName")=$G(TIUARR(FNBR1,IENS1,1503,"E"))
 S TIU("Tiu","signatureBlockTitle")=$G(TIUARR(FNBR1,IENS1,1504,"E"))
 S TIU("Tiu","signatureMode")=$G(TIUARR(FNBR1,IENS1,1505,"E"))
 S TIU("Tiu","signatureModeCd")=$G(TIUARR(FNBR1,IENS1,1505,"I"))
 S TIU("Tiu","cosignatureNeeded")=$G(TIUARR(FNBR1,IENS1,1506,"E"))
 S TIU("Tiu","cosignatureNeededCd")=$G(TIUARR(FNBR1,IENS1,1506,"I"))
 S TIU("Tiu","cosignatureDateTime")=$G(TIUARR(FNBR1,IENS1,1507,"E"))
 S TIU("Tiu","cosignatureDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1507,"I"))
 S TIU("Tiu","cosignatureDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1507,"I")))
 S TIU("Tiu","cosignatureDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1507,"I")))
 S TIU("Tiu","cosignedBy")=$G(TIUARR(FNBR1,IENS1,1508,"E"))
 S TIU("Tiu","cosignedById")=$G(TIUARR(FNBR1,IENS1,1508,"I"))
 S TIU("Tiu","cosignedByNPI")=$$GET1^DIQ(200,TIU("Tiu","cosignedById")_",",41.99) ;NPI
 S TIU("Tiu","cosignedByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","cosignedById"))
 S TIU("Tiu","cosignatureBlockName")=$G(TIUARR(FNBR1,IENS1,1509,"E"))
 S TIU("Tiu","cosignatureBlockTitle")=$G(TIUARR(FNBR1,IENS1,1510,"E"))
 S TIU("Tiu","cosignatureMode")=$G(TIUARR(FNBR1,IENS1,1511,"E"))
 S TIU("Tiu","cosignatureModeCd")=$G(TIUARR(FNBR1,IENS1,1511,"I"))
 S TIU("Tiu","markedSignedOnChartBy")=$G(TIUARR(FNBR1,IENS1,1512,"E"))
 S TIU("Tiu","markedSignedOnChartById")=$G(TIUARR(FNBR1,IENS1,1512,"I"))
 S TIU("Tiu","markedSignedOnChartByNPI")=$$GET1^DIQ(200,TIU("Tiu","markedSignedOnChartById")_",",41.99) ;NPI
 S TIU("Tiu","markedSignedOnChartByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","markedSignedOnChartById"))
 S TIU("Tiu","markedCosignedOnChartBy")=$G(TIUARR(FNBR1,IENS1,1513,"E"))
 S TIU("Tiu","markedCosignedOnChartById")=$G(TIUARR(FNBR1,IENS1,1513,"I"))
 S TIU("Tiu","markedCosignedOnChartByNPI")=$$GET1^DIQ(200,TIU("Tiu","markedCosignedOnChartById")_",",41.99) ;NPI
 S TIU("Tiu","markedCosignedOnChartByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","markedCosignedOnChartById"))
 S TIU("Tiu","amendmentDateTime")=$G(TIUARR(FNBR1,IENS1,1601,"E"))
 S TIU("Tiu","amendmentDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1601,"I"))
 S TIU("Tiu","amendmentDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1601,"I")))
 S TIU("Tiu","amendmentDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1601,"I")))
 S TIU("Tiu","amendedBy")=$G(TIUARR(FNBR1,IENS1,1602,"E"))
 S TIU("Tiu","amendedById")=$G(TIUARR(FNBR1,IENS1,1602,"I"))
 S TIU("Tiu","amendedByNPI")=$$GET1^DIQ(200,TIU("Tiu","amendedById")_",",41.99) ;NPI
 S TIU("Tiu","amendedByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","amendedById"))
 S TIU("Tiu","amendmentSigned")=$G(TIUARR(FNBR1,IENS1,1603,"E"))
 S TIU("Tiu","amendmentSignedFM")=$G(TIUARR(FNBR1,IENS1,1603,"I"))
 S TIU("Tiu","amendmentSignedHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1603,"I")))
 S TIU("Tiu","amendmentSignedFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1603,"I")))
 S TIU("Tiu","amendmentSignBlockName")=$G(TIUARR(FNBR1,IENS1,1604,"E"))
 S TIU("Tiu","amendmentSignBlockTitle")=$G(TIUARR(FNBR1,IENS1,1605,"E"))
 S TIU("Tiu","administrativeClosureDate")=$G(TIUARR(FNBR1,IENS1,1606,"E"))
 S TIU("Tiu","administrativeClosureDateFM")=$G(TIUARR(FNBR1,IENS1,1606,"I"))
 S TIU("Tiu","administrativeClosureDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1606,"I")))
 S TIU("Tiu","administrativeClosureDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1606,"I")))
 S TIU("Tiu","adminClosureSigBlockName")=$G(TIUARR(FNBR1,IENS1,1607,"E"))
 S TIU("Tiu","adminClosureSigBlockTitle")=$G(TIUARR(FNBR1,IENS1,1608,"E"))
 S TIU("Tiu","archivePurgeDateTime")=$G(TIUARR(FNBR1,IENS1,1609,"E"))
 S TIU("Tiu","archivePurgeDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1609,"I"))
 S TIU("Tiu","archivePurgeDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1609,"I")))
 S TIU("Tiu","archivePurgeDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1609,"I")))
 S TIU("Tiu","deletedBy")=$G(TIUARR(FNBR1,IENS1,1610,"E"))
 S TIU("Tiu","deletedById")=$G(TIUARR(FNBR1,IENS1,1610,"I"))
 S TIU("Tiu","deletedByNPI")=$$GET1^DIQ(200,TIU("Tiu","deletedById")_",",41.99) ;NPI
 S TIU("Tiu","deletedByResId")=$$RESID^SYNDHP69("V",SITE,200,TIU("Tiu","deletedById"))
 S TIU("Tiu","deletionDate")=$G(TIUARR(FNBR1,IENS1,1611,"E"))
 S TIU("Tiu","deletionDateFM")=$G(TIUARR(FNBR1,IENS1,1611,"I"))
 S TIU("Tiu","deletionDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1611,"I")))
 S TIU("Tiu","deletionDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1611,"I")))
 S TIU("Tiu","reasonForDeletion")=$G(TIUARR(FNBR1,IENS1,1612,"E"))
 S TIU("Tiu","reasonForDeletionCd")=$G(TIUARR(FNBR1,IENS1,1612,"I"))
 S TIU("Tiu","administrativeClosureMode")=$G(TIUARR(FNBR1,IENS1,1613,"E"))
 S TIU("Tiu","administrativeClosureModeCd")=$G(TIUARR(FNBR1,IENS1,1613,"I"))
 S TIU("Tiu","subjectOptionalDescription")=$G(TIUARR(FNBR1,IENS1,1701,"E"))
 S TIU("Tiu","vbcLineCount")=$G(TIUARR(FNBR1,IENS1,1801,"E"))
 S TIU("Tiu","idParent")=$G(TIUARR(FNBR1,IENS1,2101,"E"))
 S TIU("Tiu","idParentId")=$G(TIUARR(FNBR1,IENS1,2101,"I"))
 S TIU("Tiu","visitId")=$G(TIUARR(FNBR1,IENS1,15001,"E"))
 S TIU("Tiu","procedureSummaryCode")=$G(TIUARR(FNBR1,IENS1,70201,"E"))
 S TIU("Tiu","procedureSummaryCodeCd")=$G(TIUARR(FNBR1,IENS1,70201,"I"))
 S TIU("Tiu","dateTimePerformed")=$G(TIUARR(FNBR1,IENS1,70202,"E"))
 S TIU("Tiu","dateTimePerformedFM")=$G(TIUARR(FNBR1,IENS1,70202,"I"))
 S TIU("Tiu","dateTimePerformedHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,70202,"I")))
 S TIU("Tiu","dateTimePerformedFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,70202,"I")))
 S TIU("Tiu","vhaEnterpriseStandardTitle")=$G(TIUARR(FNBR1,IENS1,89261,"E"))
 ;
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TIU")
 ;
 I $G(RETJSON)="J" D
 . D TOJASON^SYNDHPUTL(.TIU,.TIUJ)
 . S TIUJ=$$UES^XLFJSON(TIUJ) ;change \\n to \n
 ;
 QUIT
 ;
NOTSTAT(X) ; Note status mapping
 ; the VistA status must map to one of the following FHIR statii
 ;   preliminary | final | amended | entered-in-error
 ;
 ; X is External Status value (8925, .05) converted to lower case
 ;
 ;  statii from TIU(8925.6
 ;    1)="UNDICTATED^preliminary"
 ;    2)="UNTRANSCRIBED^preliminary"
 ;    3)="UNRELEASED^preliminary"
 ;    4)="UNVERIFIED^preliminary"
 ;    5)="UNSIGNED^preliminary"
 ;    6)="UNCOSIGNED^preliminary"
 ;    7)="COMPLETED^final"
 ;    8)="AMENDED^amended"
 ;    9)="PURGED^entered-in-error"
 ;    10)="TEST^entered-in-error"
 ;    11)="ACTIVE^preliminary"
 ;    13)="INACTIVE^preliminary"
 ;    14)="DELETED^enered-in-error"
 ;    15)="RETRACTED^entered-in-error"
 ;
 ; converted to values returned by TIU RPC
 ;
 N XNS
 S XNS("active")="preliminary"
 S XNS("amended")="amended"
 S XNS("completed")="final"
 S XNS("deleted")="enered-in-error"
 S XNS("inactive")="preliminary"
 S XNS("purged")="entered-in-error"
 S XNS("retracted")="entered-in-error"
 S XNS("test")="entered-in-error"
 S XNS("uncosigned")="preliminary"
 S XNS("undictated")="preliminary"
 S XNS("unreleased")="preliminary"
 S XNS("unsigned")="preliminary"
 S XNS("untranscribed")="preliminary"
 S XNS("unverified")="preliminary"
 ;
 QUIT:$D(XNS(X)) $P(XNS(X),U)
 QUIT "error - composition status not recognised"
 ;

SYNDHP25
SYNDHP25 ; HC/art - HealthConcourse - get patient appointment data ;06/25/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GETPATAPPT(PATAPPT,PATIEN,RETJSON,PATAPPTJ) ;get patient appointment records
 ;inputs: PATIEN - Patient IEN
 ;        RETJSON - J = Return JSON
 ;output: PATAPPT  - array of patient appointment data, by reference
 ;        PATAPPTJ - JSON structure of patient appointment data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- patient appointments -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=2 ;PATIENT
 N FNBR2 S FNBR2=2.98 ;APPOINTMENT
 N IENS1 S IENS1=PATIEN_","
 N FIELDS S FIELDS=".01:.03;.09;991.1;1900*"
 ;
 N PATAPPTARR,PATAPPTERR
 D GETS^DIQ(FNBR1,IENS1,FIELDS,"EI","PATAPPTARR","PATAPPTERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PATAPPTARR")
 I $G(DEBUG),$D(PATAPPTERR) W !,">>ERROR<<" W ! W $$ZW^SYNDHPUTL("PATAPPTERR")
 I $D(PATAPPTERR) D  QUIT
 . S PATAPPT("Patappt","ERROR")=PATIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATAPPT,.PATAPPTJ)
 S PATAPPT("Patappt","patIen")=PATIEN
 S PATAPPT("Patappt","resourceType")="Appointment"
 S PATAPPT("Patappt","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIEN)
 S PATAPPT("Patappt","name")=$G(PATAPPTARR(FNBR1,IENS1,.01,"E"))
 S PATAPPT("Patappt","sex")=$G(PATAPPTARR(FNBR1,IENS1,.02,"E"))
 S PATAPPT("Patappt","sexCd")=$G(PATAPPTARR(FNBR1,IENS1,.02,"I"))
 S PATAPPT("Patappt","genderFHIR")=$S(PATAPPT("Patappt","sexCd")="M":"male",PATAPPT("Patappt","sexCd")="F":"female",1:"unknown")
 S PATAPPT("Patappt","selfIdentifiedGender")=$G(PATAPPTARR(FNBR1,IENS1,.024,"E"))
 S PATAPPT("Patappt","selfIdentifiedGenderCd")=$G(PATAPPTARR(FNBR1,IENS1,.024,"I"))
 S PATAPPT("Patappt","dateOfBirth")=$G(PATAPPTARR(FNBR1,IENS1,.03,"E"))
 S PATAPPT("Patappt","dateOfBirthFM")=$G(PATAPPTARR(FNBR1,IENS1,.03,"I"))
 S PATAPPT("Patappt","dateOfBirthHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR1,IENS1,.03,"I")))
 S PATAPPT("Patappt","dateOfBirthFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR1,IENS1,.03,"I")))
 S PATAPPT("Patappt","socialSecurityNumber")=$G(PATAPPTARR(FNBR1,IENS1,.09,"E"))
 S PATAPPT("Patappt","fullIcn")=$G(PATAPPTARR(FNBR1,IENS1,991.1,"E"))
 N IENS2 S IENS2=""
 F  S IENS2=$O(PATAPPTARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N APPOINT S APPOINT=$NA(PATAPPT("Patappt","appointments","appointment",+IENS2))
 . S @APPOINT@("appointmentDateTime")=$G(PATAPPTARR(FNBR2,IENS2,.001,"E"))
 . S @APPOINT@("appointmentDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,.001,"I"))
 . S @APPOINT@("appointmentDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,.001,"I")))
 . S @APPOINT@("appointmentDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,.001,"I")))
 . S @APPOINT@("clinic")=$G(PATAPPTARR(FNBR2,IENS2,.01,"E"))
 . S @APPOINT@("clinicId")=$G(PATAPPTARR(FNBR2,IENS2,.01,"I"))
 . S @APPOINT@("telephoneOfClinic")=$G(PATAPPTARR(FNBR2,IENS2,.02,"E"))
 . S @APPOINT@("status")=$G(PATAPPTARR(FNBR2,IENS2,3,"E"))
 . S @APPOINT@("statusCd")=$G(PATAPPTARR(FNBR2,IENS2,3,"I"))
 . N STATUS S STATUS=$G(PATAPPTARR(FNBR2,IENS2,3,"I"))
 . S @APPOINT@("statusFHIR")=$S(STATUS="":"booked",STATUS["C":"cancelled",STATUS="I":"booked",STATUS="N":"noshow",STATUS="NA":"noshow",STATUS="NT":"booked",1:"entered-in-error")
 . S @APPOINT@("realAppointment")=$G(PATAPPTARR(FNBR2,IENS2,4,"E"))
 . S @APPOINT@("labDateTime")=$G(PATAPPTARR(FNBR2,IENS2,5,"E"))
 . S @APPOINT@("labDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,5,"I"))
 . S @APPOINT@("labDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,5,"I")))
 . S @APPOINT@("labDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,5,"I")))
 . S @APPOINT@("xRayDateTime")=$G(PATAPPTARR(FNBR2,IENS2,6,"E"))
 . S @APPOINT@("xRayDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,6,"I"))
 . S @APPOINT@("xRayDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,6,"I")))
 . S @APPOINT@("xRayDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,6,"I")))
 . S @APPOINT@("ekgDateTime")=$G(PATAPPTARR(FNBR2,IENS2,7,"E"))
 . S @APPOINT@("ekgDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,7,"I"))
 . S @APPOINT@("ekgDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,7,"I")))
 . S @APPOINT@("ekgDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,7,"I")))
 . S @APPOINT@("routingSlipPrinted")=$G(PATAPPTARR(FNBR2,IENS2,8,"E"))
 . S @APPOINT@("routingSlipPrintedCd")=$G(PATAPPTARR(FNBR2,IENS2,8,"I"))
 . S @APPOINT@("routingSlipPrintDate")=$G(PATAPPTARR(FNBR2,IENS2,8.5,"E"))
 . S @APPOINT@("routingSlipPrintDateFM")=$G(PATAPPTARR(FNBR2,IENS2,8.5,"I"))
 . S @APPOINT@("routingSlipPrintDateHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,8.5,"I")))
 . S @APPOINT@("routingSlipPrintDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,8.5,"I")))
 . S @APPOINT@("purposeOfVisit")=$G(PATAPPTARR(FNBR2,IENS2,9,"E"))
 . S @APPOINT@("purposeOfVisitCd")=$G(PATAPPTARR(FNBR2,IENS2,9,"I"))
 . N POV S POV=$G(PATAPPTARR(FNBR2,IENS2,9,"I"))
 . S @APPOINT@("appointmentTypeFHIR")=$S(POV="4":"WALKIN",1:"ROUTINE")
 . S @APPOINT@("appointmentType")=$G(PATAPPTARR(FNBR2,IENS2,9.5,"E"))
 . S @APPOINT@("appointmentTypeId")=$G(PATAPPTARR(FNBR2,IENS2,9.5,"I"))
 . S @APPOINT@("specialSurveyDisposition")=$G(PATAPPTARR(FNBR2,IENS2,10,"E"))
 . S @APPOINT@("numberOfCollateralSeen")=$G(PATAPPTARR(FNBR2,IENS2,11,"E"))
 . S @APPOINT@("autoRebookedApptDateTime")=$G(PATAPPTARR(FNBR2,IENS2,12,"E"))
 . S @APPOINT@("autoRebookedApptDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,12,"I"))
 . S @APPOINT@("autoRebookedApptDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,12,"I")))
 . S @APPOINT@("autoRebookedApptDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,12,"I")))
 . S @APPOINT@("collateralVisit")=$G(PATAPPTARR(FNBR2,IENS2,13,"E"))
 . S @APPOINT@("collateralVisitCd")=$G(PATAPPTARR(FNBR2,IENS2,13,"I"))
 . S @APPOINT@("noShowCancelledBy")=$G(PATAPPTARR(FNBR2,IENS2,14,"E"))
 . S @APPOINT@("noShowCancelledById")=$G(PATAPPTARR(FNBR2,IENS2,14,"I"))
 . S @APPOINT@("noShowCancelDateTime")=$G(PATAPPTARR(FNBR2,IENS2,15,"E"))
 . S @APPOINT@("noShowCancelDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,15,"I"))
 . S @APPOINT@("noShowCancelDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,15,"I")))
 . S @APPOINT@("noShowCancelDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,15,"I")))
 . S @APPOINT@("cancellationReason")=$G(PATAPPTARR(FNBR2,IENS2,16,"E"))
 . S @APPOINT@("cancellationReasonId")=$G(PATAPPTARR(FNBR2,IENS2,16,"I"))
 . S @APPOINT@("cancellationRemarks")=$G(PATAPPTARR(FNBR2,IENS2,17,"E"))
 . S @APPOINT@("apptCancelled")=$G(PATAPPTARR(FNBR2,IENS2,18,"E"))
 . S @APPOINT@("apptCancelledId")=$G(PATAPPTARR(FNBR2,IENS2,18,"I"))
 . S @APPOINT@("dataEntryClerk")=$G(PATAPPTARR(FNBR2,IENS2,19,"E"))
 . S @APPOINT@("dataEntryClerkId")=$G(PATAPPTARR(FNBR2,IENS2,19,"I"))
 . S @APPOINT@("dateApptMade")=$G(PATAPPTARR(FNBR2,IENS2,20,"E"))
 . S @APPOINT@("dateApptMadeFM")=$G(PATAPPTARR(FNBR2,IENS2,20,"I"))
 . S @APPOINT@("dateApptMadeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,20,"I")))
 . S @APPOINT@("dateApptMadeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,20,"I")))
 . S @APPOINT@("outpatientEncounter")=$G(PATAPPTARR(FNBR2,IENS2,21,"E"))
 . S @APPOINT@("outpatientEncounterId")=$G(PATAPPTARR(FNBR2,IENS2,21,"I"))
 . S @APPOINT@("encounterFormsPrinted")=$G(PATAPPTARR(FNBR2,IENS2,22,"E"))
 . S @APPOINT@("encounterFormsPrintedCd")=$G(PATAPPTARR(FNBR2,IENS2,22,"I"))
 . S @APPOINT@("encounterFormsAsAddOns")=$G(PATAPPTARR(FNBR2,IENS2,23,"E"))
 . S @APPOINT@("encounterFormsAsAddOnsCd")=$G(PATAPPTARR(FNBR2,IENS2,23,"I"))
 . S @APPOINT@("encounterConversionStatus")=$G(PATAPPTARR(FNBR2,IENS2,23.1,"E"))
 . S @APPOINT@("encounterConversionStatusCd")=$G(PATAPPTARR(FNBR2,IENS2,23.1,"I"))
 . S @APPOINT@("appointmentTypeSubCategory")=$G(PATAPPTARR(FNBR2,IENS2,24,"E"))
 . S @APPOINT@("appointmentTypeSubCategoryId")=$G(PATAPPTARR(FNBR2,IENS2,24,"I"))
 . S @APPOINT@("schedulingRequestType")=$G(PATAPPTARR(FNBR2,IENS2,25,"E"))
 . S @APPOINT@("schedulingRequestTypeCd")=$G(PATAPPTARR(FNBR2,IENS2,25,"I"))
 . S @APPOINT@("nextAvaApptIndicator")=$G(PATAPPTARR(FNBR2,IENS2,26,"E"))
 . S @APPOINT@("nextAvaApptIndicatorCd")=$G(PATAPPTARR(FNBR2,IENS2,26,"I"))
 . S @APPOINT@("desiredDateOfAppointment")=$G(PATAPPTARR(FNBR2,IENS2,27,"E"))
 . S @APPOINT@("desiredDateOfAppointmentFM")=$G(PATAPPTARR(FNBR2,IENS2,27,"I"))
 . S @APPOINT@("desiredDateOfAppointmentHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,27,"I")))
 . S @APPOINT@("desiredDateOfAppointmentFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,27,"I")))
 . S @APPOINT@("followUpVisit")=$G(PATAPPTARR(FNBR2,IENS2,28,"E"))
 . S @APPOINT@("followUpVisitCd")=$G(PATAPPTARR(FNBR2,IENS2,28,"I"))
 . S @APPOINT@("currentStatus")=$G(PATAPPTARR(FNBR2,IENS2,100,"E"))
 . S @APPOINT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIEN,FNBR2_U_+IENS2)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PATAPPT")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATAPPT,.PATAPPTJ)
 ;
 QUIT
 ;

SYNDHP26
SYNDHP26 ; HC/art - HealthConcourse - get MH Administrations record ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1MHADM(MHADM,MHADMIEN,RETJSON,MHADMJ) ;get one MH Administration record
 ;inputs: MHADMIEN - MH Administration IEN
 ;        RETJSON - J = Return JSON
 ;output: MHADM  - array of MH Administration data, by reference
 ;        MHADMJ - JSON structure of MH Administration data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- MH Administration -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=601.84 ;MH ADMINISTRATIONS
 N FNBR2 S FNBR2=601.841 ;COMMENTS
 N IENS1 S IENS1=MHADMIEN_","
 ;
 N MHADMARR,MHADMERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","MHADMARR","MHADMERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHADMARR")
 I $G(DEBUG),$D(MHADMERR) W !,">>ERROR<<" W ! W $$ZW^SYNDHPUTL("MHADMERR")
 I $D(MHADMERR) D  QUIT
 . S MHADM("Mhadm","ERROR")=MHADMIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHADM,.MHADMJ)
 S MHADM("Mhadm","mhadmIen")=MHADMIEN
 S MHADM("Mhadm","resourceType")="Observation"
 S MHADM("Mhadm","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHADMIEN)
 S MHADM("Mhadm","administrationNumber")=$G(MHADMARR(FNBR1,IENS1,.01,"E"))
 S MHADM("Mhadm","patient")=$G(MHADMARR(FNBR1,IENS1,1,"E"))
 S MHADM("Mhadm","patientId")=$G(MHADMARR(FNBR1,IENS1,1,"I"))
 S MHADM("Mhadm","patientICN")=$$GET1^DIQ(2,MHADM("Mhadm","patientId")_",",991.1)
 S MHADM("Mhadm","instrumentName")=$G(MHADMARR(FNBR1,IENS1,2,"E"))
 S MHADM("Mhadm","instrumentNameId")=$G(MHADMARR(FNBR1,IENS1,2,"I"))
 S MHADM("Mhadm","dateGiven")=$G(MHADMARR(FNBR1,IENS1,3,"E"))
 S MHADM("Mhadm","dateGivenFM")=$G(MHADMARR(FNBR1,IENS1,3,"I"))
 S MHADM("Mhadm","dateGivenHL7")=$$FMTHL7^XLFDT($G(MHADMARR(FNBR1,IENS1,3,"I")))
 S MHADM("Mhadm","dateGivenFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHADMARR(FNBR1,IENS1,3,"I")))
 S MHADM("Mhadm","dateSaved")=$G(MHADMARR(FNBR1,IENS1,4,"E"))
 S MHADM("Mhadm","dateSavedFM")=$G(MHADMARR(FNBR1,IENS1,4,"I"))
 S MHADM("Mhadm","dateSavedHL7")=$$FMTHL7^XLFDT($G(MHADMARR(FNBR1,IENS1,4,"I")))
 S MHADM("Mhadm","dateSavedFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHADMARR(FNBR1,IENS1,4,"I")))
 S MHADM("Mhadm","orderedBy")=$G(MHADMARR(FNBR1,IENS1,5,"E"))
 S MHADM("Mhadm","orderedById")=$G(MHADMARR(FNBR1,IENS1,5,"I"))
 S MHADM("Mhadm","orderedByNPI")=$$GET1^DIQ(200,MHADM("Mhadm","orderedById")_",",41.99) ;NPI
 S MHADM("Mhadm","orderedByResId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHADM("Mhadm","orderedById"))
 S MHADM("Mhadm","administeredBy")=$G(MHADMARR(FNBR1,IENS1,6,"E"))
 S MHADM("Mhadm","administeredById")=$G(MHADMARR(FNBR1,IENS1,6,"I"))
 S MHADM("Mhadm","administeredByNPI")=$$GET1^DIQ(200,MHADM("Mhadm","administeredById")_",",41.99) ;NPI
 S MHADM("Mhadm","administeredByResId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHADM("Mhadm","administeredById"))
 S MHADM("Mhadm","signed")=$G(MHADMARR(FNBR1,IENS1,7,"E"))
 S MHADM("Mhadm","signedCd")=$G(MHADMARR(FNBR1,IENS1,7,"I"))
 S MHADM("Mhadm","isComplete")=$G(MHADMARR(FNBR1,IENS1,8,"E"))
 S MHADM("Mhadm","isCompleteCd")=$G(MHADMARR(FNBR1,IENS1,8,"I"))
 S MHADM("Mhadm","numberOfQuestionsAnswered")=$G(MHADMARR(FNBR1,IENS1,9,"E"))
 S MHADM("Mhadm","comments")=""
 N Z S Z=""
 F  S Z=$O(MHADMARR(FNBR1,IENS1,10,Z)) QUIT:'+Z  D
 . S MHADM("Mhadm","comments")=MHADM("Mhadm","comments")_$G(MHADMARR(FNBR1,IENS1,10,Z))_" "
 S MHADM("Mhadm","transmissionStatus")=$G(MHADMARR(FNBR1,IENS1,11,"E"))
 S MHADM("Mhadm","transmissionStatusCd")=$G(MHADMARR(FNBR1,IENS1,11,"I"))
 S MHADM("Mhadm","transmissionTime")=$G(MHADMARR(FNBR1,IENS1,12,"E"))
 S MHADM("Mhadm","transmissionTimeFM")=$G(MHADMARR(FNBR1,IENS1,12,"I"))
 S MHADM("Mhadm","transmissionTimeHL7")=$$FMTHL7^XLFDT($G(MHADMARR(FNBR1,IENS1,12,"I")))
 S MHADM("Mhadm","transmissionTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHADMARR(FNBR1,IENS1,12,"I")))
 S MHADM("Mhadm","location")=$G(MHADMARR(FNBR1,IENS1,13,"E"))
 S MHADM("Mhadm","locationId")=$G(MHADMARR(FNBR1,IENS1,13,"I"))
 ;
 ; get LOINC and/or SNOMED
 N LOINC S LOINC=""
 I MHADM("Mhadm","instrumentNameId")'="" D
 . S LOINC=$$MAP^SYNDHPMP("mh2loinc",MHADM("Mhadm","instrumentNameId"),"D")
 . S LOINC=$S(+LOINC=-1:"",1:$P(LOINC,U,2))
 I LOINC="",MHADM("Mhadm","instrumentName")'="" D
 . S LOINC=$$MAP^SYNDHPMP("mh2loinc",MHADM("Mhadm","instrumentName"),"D")
 . S LOINC=$S(+LOINC=-1:"",1:$P(LOINC,U,2))
 N SCT S SCT=""
 I MHADM("Mhadm","instrumentNameId")'="" D
 . S SCT=$$MAP^SYNDHPMP("mh2sct",MHADM("Mhadm","instrumentNameId"),"D")
 . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 I SCT="",MHADM("Mhadm","instrumentName")'="" D
 . S SCT=$$MAP^SYNDHPMP("mh2sct",MHADM("Mhadm","instrumentName"),"D")
 . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 S MHADM("Mhadm","loincCode")=LOINC
 S MHADM("Mhadm","snomedCode")=SCT
 S MHADM("Mhadm","sctPreferredTerm")=$$USCTPT^SYNDHPUTL(SCT)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHADM")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHADM,.MHADMJ)
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1MHANS(MHANS,MHANSIEN,RETJSON,MHANSJ) ;get one MH Answers record
 ;inputs: MHANSIEN - MH Answers IEN
 ;        RETJSON - J = Return JSON
 ;output: MHANS  - array of MH Answers data, by reference
 ;        MHANSJ - JSON structure of MH Answers data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- MH Answers -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=601.85 ;MH ANSWERS
 N FNBR2 S FNBR2=601.853 ;ANSWERS
 N IENS1 S IENS1=MHANSIEN_","
 ;
 N MHANSARR,MHANSERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","MHANSARR","MHANSERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHANSARR")
 I $G(DEBUG),$D(MHANSERR) W !,">>ERROR<<" W ! W $$ZW^SYNDHPUTL("MHANSERR")
 I $D(MHANSERR) D  QUIT
 . S MHANS("Mhans","ERROR")=MHANSIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHANS,.MHANSJ)
 S MHANS("Mhans","mhansIen")=MHANSIEN
 S MHANS("Mhans","resourceType")="Observation"
 S MHANS("Mhans","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHANSIEN)
 S MHANS("Mhans","answerId")=$G(MHANSARR(FNBR1,IENS1,.01,"E"))
 S MHANS("Mhans","administrationId")=$G(MHANSARR(FNBR1,IENS1,1,"E"))
 S MHANS("Mhans","questionId")=$G(MHANSARR(FNBR1,IENS1,2,"E"))
 S MHANS("Mhans","question")=""
 N QUEST
 N Q S Q=$$GET1^DIQ(601.72,MHANS("Mhans","questionId")_",",1,"","QUEST")
 N Z S Z=""
 F  S Z=$O(QUEST(Z)) QUIT:Z=""  D
 . S MHANS("Mhans","question")=MHANS("Mhans","question")_QUEST(Z)
 S MHANS("Mhans","answers")=""
 N Z S Z=""
 F  S Z=$O(MHANSARR(FNBR1,IENS1,3,Z)) QUIT:Z=""  D
 . S MHANS("Mhans","answers")=MHANS("Mhans","answers")_$G(MHANSARR(FNBR1,IENS1,3,Z))
 S MHANS("Mhans","choiceId")=$G(MHANSARR(FNBR1,IENS1,4,"E"))
 S MHANS("Mhans","choice")=$$GET1^DIQ(601.75,MHANS("Mhans","choiceId")_",",3)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHANS")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHANS,.MHANSJ)
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1MHRES(MHRES,MHRESIEN,RETJSON,MHRESJ) ;get one MH Results record
 ;inputs: MHRESIEN - MH Results IEN
 ;        RETJSON - J = Return JSON
 ;output: MHRES  - array of MH Results data, by reference
 ;        MHRESJ - JSON structure of MH Results data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- MH Results -----------------------------",!
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=601.92 ;MH RESULTS
 N IENS1 S IENS1=MHRESIEN_","
 ;
 N MHRESARR,MHRESERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","MHRESARR","MHRESERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHRESARR")
 I $G(DEBUG),$D(MHRESERR) W !,">>ERROR<<" W ! W $$ZW^SYNDHPUTL("MHRESERR")
 I $D(MHRESERR) D  QUIT
 . S MHRES("Mhres","ERROR")=MHRESIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHRES,.MHRESJ)
 S MHRES("Mhres","mhresIen")=MHRESIEN
 S MHRES("Mhres","resourceType")="Observation"
 S MHRES("Mhres","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,MHRESIEN)
 S MHRES("Mhres","resultId")=$G(MHRESARR(FNBR1,IENS1,.01,"E"))
 S MHRES("Mhres","administration")=$G(MHRESARR(FNBR1,IENS1,1,"E"))
 S MHRES("Mhres","administrationId")=$G(MHRESARR(FNBR1,IENS1,1,"I"))
 S MHRES("Mhres","scale")=$G(MHRESARR(FNBR1,IENS1,2,"E"))
 S MHRES("Mhres","rawScore")=$G(MHRESARR(FNBR1,IENS1,3,"E"))
 S MHRES("Mhres","transformedScore1")=$G(MHRESARR(FNBR1,IENS1,4,"E"))
 S MHRES("Mhres","transformedScore2")=$G(MHRESARR(FNBR1,IENS1,5,"E"))
 S MHRES("Mhres","transformedScore3")=$G(MHRESARR(FNBR1,IENS1,6,"E"))
 S MHRES("Mhres","instrument")=$G(MHRESARR(FNBR1,IENS1,7,"E"))
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("MHRES")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHRES,.MHRESJ)
 ;
 QUIT
 ;
 

SYNDHP27
SYNDHP27 ; HC/art - HealthConcourse - get Rad/Nuc Med Patient data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1RADPAT(RADPAT,RADPATIEN,RETJSON,RADPATJ) ;get one Rad/Nuc Med Patient record
 ;inputs: RADPATIEN - Rad/Nuc Med Patient IEN
 ;        RETJSON - J = Return JSON
 ;output: RADPAT  - array of Rad/Nuc Med Patient data, by reference
 ;        RADPATJ - JSON structure of Rad/Nuc Med Patient data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Rad/Nuc Med Patient -----------------------------",!
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=70 ;RAD/NUC MED PATIENT
 N FNBR2 S FNBR2=70.02 ;REGISTERED EXAMS
 N FNBR3 S FNBR3=70.06 ;OUTSIDE FILMS REGISTRY
 N FNBR4 S FNBR4=70.03 ;EXAMINATIONS
 N FNBR5 S FNBR5=70.14 ;SECONDARY DIAGNOSTIC CODE
 N FNBR6 S FNBR6=70.346 ;REASON FOR NOT PURGING
 N FNBR7 S FNBR7=70.04 ;FILM SIZE
 N FNBR8 S FNBR8=70.11 ;SECONDARY INTERPRETING STAFF
 N FNBR9 S FNBR9=70.09 ;SECONDARY INTERPRET'G RESIDENT
 N FNBR10 S FNBR10=70.05 ;EXAM STATUS TIMES
 N FNBR11 S FNBR11=70.07 ;ACTIVITY LOG
 N FNBR12 S FNBR12=70.1 ;PROCEDURE MODIFIERS
 N FNBR13 S FNBR13=70.3135 ;CPT MODIFIERS
 N FNBR14 S FNBR14=70.12 ;TECHNOLOGIST
 N FNBR15 S FNBR15=70.15 ;MEDICATIONS
 N FNBR16 S FNBR16=70.3225 ;CONTRAST MEDIA
 N FNBR17 S FNBR17=70.16 ;CONTRAST MEDIA ACTIVITY LOG
 N FNBR18 S FNBR18=70.08 ;ACTIVITY LOG
 N IENS1 S IENS1=RADPATIEN_","
 ;
 N RADPATARR,RADPATERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","RADPATARR","RADPATERR")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("RADPATARR")
 I $G(DEBUG),$D(RADPATERR) W !,">>ERROR<<" W ! W $$ZW^SYNDHPUTL("RADPATERR")
 I $D(RADPATERR) D  QUIT
 . S RADPAT("Radpat","ERROR")=RADPATIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.RADPAT,.RADPATJ)
 ;70 ;RAD/NUC MED PATIENT
 S RADPAT("Radpat","radpatIen")=RADPATIEN
 S RADPAT("Radpat","resourceType")="Procedure"
 S RADPAT("Radpat","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN)
 S RADPAT("Radpat","patientName")=$G(RADPATARR(FNBR1,IENS1,.01,"E"))
 S RADPAT("Radpat","patientNameId")=$G(RADPATARR(FNBR1,IENS1,.01,"I"))
 S RADPAT("Radpat","patientNameICN")=$$GET1^DIQ(2,RADPAT("Radpat","patientNameId")_",",991.1)
 S RADPAT("Radpat","dateOfBirth")=$G(RADPATARR(FNBR1,IENS1,.03,"E"))
 S RADPAT("Radpat","dateOfBirthFM")=$G(RADPATARR(FNBR1,IENS1,.03,"I"))
 S RADPAT("Radpat","dateOfBirthHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR1,IENS1,.03,"I")))
 S RADPAT("Radpat","dateOfBirthFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR1,IENS1,.03,"I")))
 S RADPAT("Radpat","age")=$G(RADPATARR(FNBR1,IENS1,.033,"E"))
 S RADPAT("Radpat","usualCategory")=$G(RADPATARR(FNBR1,IENS1,.04,"E"))
 S RADPAT("Radpat","usualCategoryCd")=$G(RADPATARR(FNBR1,IENS1,.04,"I"))
 S RADPAT("Radpat","userWhoEnteredPatient")=$G(RADPATARR(FNBR1,IENS1,.06,"E"))
 S RADPAT("Radpat","userWhoEnteredPatientId")=$G(RADPATARR(FNBR1,IENS1,.06,"I"))
 S RADPAT("Radpat","userWhoEnteredPatientNPI")=$$GET1^DIQ(200,RADPAT("Radpat","userWhoEnteredPatientId")_",",41.99) ;NPI
 S RADPAT("Radpat","userWhoEnteredPatientResId")=$$RESID^SYNDHP69("V",SITE,200,RADPAT("Radpat","userWhoEnteredPatientId"))
 S RADPAT("Radpat","patientSSN")=$G(RADPATARR(FNBR1,IENS1,.09,"E"))
 S RADPAT("Radpat","eligibilityCode")=$G(RADPATARR(FNBR1,IENS1,.361,"E"))
 S RADPAT("Radpat","narrative")=$G(RADPATARR(FNBR1,IENS1,1,"E"))
 S RADPAT("Radpat","isPatientAVeteran")=$G(RADPATARR(FNBR1,IENS1,1901,"E"))
 S RADPAT("Radpat","isPatientDiabetic")=$G(RADPATARR(FNBR1,IENS1,500001,"E"))
 S RADPAT("Radpat","isPatientDiabeticCd")=$G(RADPATARR(FNBR1,IENS1,500001,"I"))
 ;70.02 ;REGISTERED EXAMS
 N IENS2 S IENS2=""
 F  S IENS2=$O(RADPATARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N REGEXAM S REGEXAM=$NA(RADPAT("Radpat","registeredExamss","registeredExams",+IENS2))
 . S @REGEXAM@("examDate")=$G(RADPATARR(FNBR2,IENS2,.01,"E"))
 . S @REGEXAM@("examDateFM")=$G(RADPATARR(FNBR2,IENS2,.01,"I"))
 . S @REGEXAM@("examDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR2,IENS2,.01,"I")))
 . S @REGEXAM@("examDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR2,IENS2,.01,"I")))
 . S @REGEXAM@("typeOfImaging")=$G(RADPATARR(FNBR2,IENS2,2,"E"))
 . S @REGEXAM@("typeOfImagingId")=$G(RADPATARR(FNBR2,IENS2,2,"I"))
 . S @REGEXAM@("hospitalDivision")=$G(RADPATARR(FNBR2,IENS2,3,"E"))
 . S @REGEXAM@("hospitalDivisionId")=$G(RADPATARR(FNBR2,IENS2,3,"I"))
 . S @REGEXAM@("imagingLocation")=$G(RADPATARR(FNBR2,IENS2,4,"E"))
 . S @REGEXAM@("imagingLocationId")=$G(RADPATARR(FNBR2,IENS2,4,"I"))
 . S @REGEXAM@("examSet")=$G(RADPATARR(FNBR2,IENS2,5,"E"))
 . S @REGEXAM@("examSetCd")=$G(RADPATARR(FNBR2,IENS2,5,"I"))
 . S @REGEXAM@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_+IENS2)
 ;70.03 ;EXAMINATIONS
 N IENS4 S IENS4=""
 F  S IENS4=$O(RADPATARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N EXAM S EXAM=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS4,C,2),"examinationss","examinations",+IENS4))
 . S @EXAM@("caseNumber")=$G(RADPATARR(FNBR4,IENS4,.01,"E"))
 . S @EXAM@("procedure")=$G(RADPATARR(FNBR4,IENS4,2,"E"))
 . S @EXAM@("procedureId")=$G(RADPATARR(FNBR4,IENS4,2,"I"))
 . S @EXAM@("examStatus")=$G(RADPATARR(FNBR4,IENS4,3,"E"))
 . S @EXAM@("examStatusId")=$G(RADPATARR(FNBR4,IENS4,3,"I"))
 . S @EXAM@("reasonForCancellation")=$G(RADPATARR(FNBR4,IENS4,3.5,"E"))
 . S @EXAM@("reasonForCancellationId")=$G(RADPATARR(FNBR4,IENS4,3.5,"I"))
 . S @EXAM@("categoryOfExam")=$G(RADPATARR(FNBR4,IENS4,4,"E"))
 . S @EXAM@("categoryOfExamCd")=$G(RADPATARR(FNBR4,IENS4,4,"I"))
 . S @EXAM@("ward")=$G(RADPATARR(FNBR4,IENS4,6,"E"))
 . S @EXAM@("wardId")=$G(RADPATARR(FNBR4,IENS4,6,"I"))
 . S @EXAM@("service")=$G(RADPATARR(FNBR4,IENS4,7,"E"))
 . S @EXAM@("serviceId")=$G(RADPATARR(FNBR4,IENS4,7,"I"))
 . S @EXAM@("principalClinic")=$G(RADPATARR(FNBR4,IENS4,8,"E"))
 . S @EXAM@("principalClinicId")=$G(RADPATARR(FNBR4,IENS4,8,"I"))
 . S @EXAM@("contractSharingSource")=$G(RADPATARR(FNBR4,IENS4,9,"E"))
 . S @EXAM@("contractSharingSourceId")=$G(RADPATARR(FNBR4,IENS4,9,"I"))
 . S @EXAM@("researchSource")=$G(RADPATARR(FNBR4,IENS4,9.5,"E"))
 . S @EXAM@("contrastMediaUsed")=$G(RADPATARR(FNBR4,IENS4,10,"E"))
 . S @EXAM@("contrastMediaUsedCd")=$G(RADPATARR(FNBR4,IENS4,10,"I"))
 . S @EXAM@("imagingOrder")=$G(RADPATARR(FNBR4,IENS4,11,"E"))
 . S @EXAM@("imagingOrderId")=$G(RADPATARR(FNBR4,IENS4,11,"I"))
 . S @EXAM@("primaryInterpretingResident")=$G(RADPATARR(FNBR4,IENS4,12,"E"))
 . S @EXAM@("primaryInterpretingResidentId")=$G(RADPATARR(FNBR4,IENS4,12,"I"))
 . S @EXAM@("primaryInterpretingResidentNPI")=$$GET1^DIQ(200,@EXAM@("primaryInterpretingResidentId")_",",41.99) ;NPI
 . S @EXAM@("primaryInterpretingResidentResId")=$$RESID^SYNDHP69("V",SITE,200,@EXAM@("primaryInterpretingResidentId"))
 . S @EXAM@("primaryDiagnosticCode")=$G(RADPATARR(FNBR4,IENS4,13,"E"))
 . S @EXAM@("primaryDiagnosticCodeId")=$G(RADPATARR(FNBR4,IENS4,13,"I"))
 . S @EXAM@("requestingPhysician")=$G(RADPATARR(FNBR4,IENS4,14,"E"))
 . S @EXAM@("requestingPhysicianId")=$G(RADPATARR(FNBR4,IENS4,14,"I"))
 . S @EXAM@("requestingPhysicianNPI")=$$GET1^DIQ(200,@EXAM@("requestingPhysicianId")_",",41.99) ;NPI
 . S @EXAM@("requestingPhysicianResId")=$$RESID^SYNDHP69("V",SITE,200,@EXAM@("requestingPhysicianId"))
 . S @EXAM@("primaryInterpretingStaff")=$G(RADPATARR(FNBR4,IENS4,15,"E"))
 . S @EXAM@("primaryInterpretingStaffId")=$G(RADPATARR(FNBR4,IENS4,15,"I"))
 . S @EXAM@("primaryInterpretingStaffNPI")=$$GET1^DIQ(200,@EXAM@("primaryInterpretingStaffId")_",",41.99) ;NPI
 . S @EXAM@("primaryInterpretingStaffResId")=$$RESID^SYNDHP69("V",SITE,200,@EXAM@("primaryInterpretingStaffId"))
 . S @EXAM@("complication")=$G(RADPATARR(FNBR4,IENS4,16,"E"))
 . S @EXAM@("complicationId")=$G(RADPATARR(FNBR4,IENS4,16,"I"))
 . S @EXAM@("complicationText")=$G(RADPATARR(FNBR4,IENS4,16.5,"E"))
 . S @EXAM@("reportText")=$G(RADPATARR(FNBR4,IENS4,17,"E"))
 . S @EXAM@("reportTextId")=$G(RADPATARR(FNBR4,IENS4,17,"I"))
 . S @EXAM@("primaryCameraEquipRm")=$G(RADPATARR(FNBR4,IENS4,18,"E"))
 . S @EXAM@("primaryCameraEquipRmId")=$G(RADPATARR(FNBR4,IENS4,18,"I"))
 . S @EXAM@("bedsection")=$G(RADPATARR(FNBR4,IENS4,19,"E"))
 . S @EXAM@("bedsectionId")=$G(RADPATARR(FNBR4,IENS4,19,"I"))
 . S @EXAM@("diagnosticPrintDate")=$G(RADPATARR(FNBR4,IENS4,20,"E"))
 . S @EXAM@("diagnosticPrintDateFM")=$G(RADPATARR(FNBR4,IENS4,20,"I"))
 . S @EXAM@("diagnosticPrintDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR4,IENS4,20,"I")))
 . S @EXAM@("diagnosticPrintDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR4,IENS4,20,"I")))
 . S @EXAM@("requestedDate")=$G(RADPATARR(FNBR4,IENS4,21,"E"))
 . S @EXAM@("requestedDateFM")=$G(RADPATARR(FNBR4,IENS4,21,"I"))
 . S @EXAM@("requestedDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR4,IENS4,21,"I")))
 . S @EXAM@("requestedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR4,IENS4,21,"I")))
 . S @EXAM@("requestingLocation")=$G(RADPATARR(FNBR4,IENS4,22,"E"))
 . S @EXAM@("requestingLocationId")=$G(RADPATARR(FNBR4,IENS4,22,"I"))
 . S @EXAM@("clinicStopRecorded")=$G(RADPATARR(FNBR4,IENS4,23,"E"))
 . S @EXAM@("clinicStopRecordedCd")=$G(RADPATARR(FNBR4,IENS4,23,"I"))
 . S @EXAM@("memberOfSet")=$G(RADPATARR(FNBR4,IENS4,25,"E"))
 . S @EXAM@("memberOfSetCd")=$G(RADPATARR(FNBR4,IENS4,25,"I"))
 . S @EXAM@("creditMethod")=$G(RADPATARR(FNBR4,IENS4,26,"E"))
 . S @EXAM@("creditMethodCd")=$G(RADPATARR(FNBR4,IENS4,26,"I"))
 . S @EXAM@("visit")=$G(RADPATARR(FNBR4,IENS4,27,"E"))
 . S @EXAM@("visitId")=$G(RADPATARR(FNBR4,IENS4,27,"I"))
 . S @EXAM@("visitFM")=$$GET1^DIQ(9000010,@EXAM@("visitId")_",",.01,"I")
 . S @EXAM@("visitHL7")=$$FMTHL7^XLFDT(@EXAM@("visitFM"))
 . S @EXAM@("visitFHIR")=$$FMTFHIR^SYNDHPUTL(@EXAM@("visitFM"))
 . S @EXAM@("visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,@EXAM@("visitId"))
 . S @EXAM@("dosageTicketPrinted")=$G(RADPATARR(FNBR4,IENS4,29,"E"))
 . S @EXAM@("dosageTicketPrintedCd")=$G(RADPATARR(FNBR4,IENS4,29,"I"))
 . S @EXAM@("hl7ExaminedMsgSent")=$G(RADPATARR(FNBR4,IENS4,30,"E"))
 . S @EXAM@("hl7ExaminedMsgSentCd")=$G(RADPATARR(FNBR4,IENS4,30,"I"))
 . S @EXAM@("siteAccessionNumber")=$G(RADPATARR(FNBR4,IENS4,31,"E"))
 . S @EXAM@("pregnancyScreen")=$G(RADPATARR(FNBR4,IENS4,32,"E"))
 . S @EXAM@("pregnancyScreenCd")=$G(RADPATARR(FNBR4,IENS4,32,"I"))
 . S @EXAM@("purgedDate")=$G(RADPATARR(FNBR4,IENS4,40,"E"))
 . S @EXAM@("purgedDateFM")=$G(RADPATARR(FNBR4,IENS4,40,"I"))
 . S @EXAM@("purgedDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR4,IENS4,40,"I")))
 . S @EXAM@("purgedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR4,IENS4,40,"I")))
 . S @EXAM@("preventPurge")=$G(RADPATARR(FNBR4,IENS4,45,"E"))
 . S @EXAM@("preventPurgeCd")=$G(RADPATARR(FNBR4,IENS4,45,"I"))
 . S @EXAM@("pregnancyScreenComment")=$G(RADPATARR(FNBR4,IENS4,80,"E"))
 . S @EXAM@("studyInstanceUid")=$G(RADPATARR(FNBR4,IENS4,81,"E"))
 . S @EXAM@("clinicalHistoryForExam")=""
 . N Z S Z=""
 . F  S Z=$O(RADPATARR(FNBR4,IENS4,400,Z)) QUIT:'+Z  D
 . . S @EXAM@("clinicalHistoryForExam")=@EXAM@("clinicalHistoryForExam")_$G(RADPATARR(FNBR4,IENS4,400,Z))
 . . W "IENS4: ",IENS4,"  text("_Z_"): ",$G(RADPATARR(FNBR4,IENS4,400,Z)),!
 . S @EXAM@("nuclearMedData")=$G(RADPATARR(FNBR4,IENS4,500,"E"))
 . S @EXAM@("nuclearMedDataId")=$G(RADPATARR(FNBR4,IENS4,500,"I"))
 . S @EXAM@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS4,C,2)_U_FNBR4_U_+IENS4)
 ;
 D RADCONT1^SYNDHP27A
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("RADPAT")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.RADPAT,.RADPATJ)
 ;
 QUIT
 ;

SYNDHP27A
SYNDHP27A ; HC/art - HealthConcourse - continuation of get Rad/Nuc Med Patient data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
RADCONT1 ;continuation of GET1RADPAT^SYNDHP27 - get Rad/Nuc Med Patient record
 ;
 ;70.14 ;SECONDARY DIAGNOSTIC CODE
 N IENS5 S IENS5=""
 F  S IENS5=$O(RADPATARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . N SECDX S SECDX=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS5,C,3),"examinationss","examinations",$P(IENS5,C,2),"secondaryDiagnosticCodes","secondaryDiagnosticCode",+IENS5))
 . S @SECDX@("secondaryDiagnosticCode")=$G(RADPATARR(FNBR5,IENS5,.01,"E"))
 . S @SECDX@("secondaryDiagnosticCodeId")=$G(RADPATARR(FNBR5,IENS5,.01,"I"))
 . S @SECDX@("secondaryDxPrintDate")=$G(RADPATARR(FNBR5,IENS5,1,"E"))
 . S @SECDX@("secondaryDxPrintDateFM")=$G(RADPATARR(FNBR5,IENS5,1,"I"))
 . S @SECDX@("secondaryDxPrintDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR5,IENS5,1,"I")))
 . S @SECDX@("secondaryDxPrintDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR5,IENS5,1,"I")))
 . S @SECDX@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS5,",",3)_U_FNBR4_U_$P(IENS5,C,2)_U_FNBR5_U_+IENS5)
 ;70.346 ;REASON FOR NOT PURGING
 N IENS6 S IENS6=""
 F  S IENS6=$O(RADPATARR(FNBR6,IENS6)) QUIT:IENS6=""  D
 . N NOTPURG S NOTPURG=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS6,C,3),"examinationss","examinations",$P(IENS6,C,2),"reasonForNotPurgings","reasonForNotPurging",+IENS6))
 . S @NOTPURG@("reasonForNotPurging")=$G(RADPATARR(FNBR6,IENS6,.01,"E"))
 . S @NOTPURG@("reasonForNotPurgingCd")=$G(RADPATARR(FNBR6,IENS6,.01,"I"))
 . S @NOTPURG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS6,C,3)_U_FNBR4_U_$P(IENS6,C,2)_U_FNBR6_U_+IENS6)
 ;70.04 ;FILM SIZE
 N IENS7 S IENS7=""
 F  S IENS7=$O(RADPATARR(FNBR7,IENS7)) QUIT:IENS7=""  D
 . N FILMSIZE S FILMSIZE=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS7,C,3),"examinationss","examinations",$P(IENS7,C,2),"filmSizes","filmSize",+IENS7))
 . S @FILMSIZE@("filmSize")=$G(RADPATARR(FNBR7,IENS7,.01,"E"))
 . S @FILMSIZE@("filmSizeId")=$G(RADPATARR(FNBR7,IENS7,.01,"I"))
 . S @FILMSIZE@("amountFilmsOrCineFt")=$G(RADPATARR(FNBR7,IENS7,2,"E"))
 . S @FILMSIZE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS7,C,3)_U_FNBR4_U_$P(IENS7,C,2)_U_FNBR7_U_+IENS7)
 ;70.11 ;SECONDARY INTERPRETING STAFF
 N IENS8 S IENS8=""
 F  S IENS8=$O(RADPATARR(FNBR8,IENS8)) QUIT:IENS8=""  D
 . N SECINTS S SECINTS=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS8,C,3),"examinationss","examinations",$P(IENS8,C,2),"secondaryInterpretingStaffs","secondaryInterpretingStaff",+IENS8))
 . S @SECINTS@("secondaryInterpretingStaff")=$G(RADPATARR(FNBR8,IENS8,.01,"E"))
 . S @SECINTS@("secondaryInterpretingStaffId")=$G(RADPATARR(FNBR8,IENS8,.01,"I"))
 . S @SECINTS@("secondaryInterpretingStaffNPI")=$$GET1^DIQ(200,@SECINTS@("secondaryInterpretingStaffId")_",",41.99) ;NPI
 . S @SECINTS@("secondaryInterpretingStaffResId")=$$RESID^SYNDHP69("V",SITE,200,@SECINTS@("secondaryInterpretingStaffId"))
 . S @SECINTS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS8,C,3)_U_FNBR4_U_$P(IENS8,C,2)_U_FNBR8_U_+IENS8)
 ;70.09 ;SECONDARY INTERPRET'G RESIDENT
 N IENS9 S IENS9=""
 F  S IENS9=$O(RADPATARR(FNBR9,IENS9)) QUIT:IENS9=""  D
 . N SECINTR S SECINTR=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS9,C,3),"examinationss","examinations",$P(IENS9,C,2),"secondaryInterpretGResidents","secondaryInterpretGResident",+IENS9))
 . S @SECINTR@("secondaryInterpretGResident")=$G(RADPATARR(FNBR9,IENS9,.01,"E"))
 . S @SECINTR@("secondaryInterpretGResidentId")=$G(RADPATARR(FNBR9,IENS9,.01,"I"))
 . S @SECINTR@("secondaryInterpretGResidentNPI")=$$GET1^DIQ(200,@SECINTR@("secondaryInterpretGResidentId")_",",41.99) ;NPI
 . S @SECINTR@("secondaryInterpretGResidentResId")=$$RESID^SYNDHP69("V",SITE,200,@SECINTR@("secondaryInterpretGResidentId"))
 . S @SECINTR@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS9,C,3)_U_FNBR4_U_$P(IENS9,C,2)_U_FNBR9_U_+IENS9)
 ;70.05 ;EXAM STATUS TIMES
 N IENS10 S IENS10=""
 F  S IENS10=$O(RADPATARR(FNBR10,IENS10)) QUIT:IENS10=""  D
 . N EXSTATTM S EXSTATTM=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS10,C,3),"examinationss","examinations",$P(IENS10,C,2),"examStatusTimess","examStatusTimes",+IENS10))
 . S @EXSTATTM@("statusChangeDateTime")=$G(RADPATARR(FNBR10,IENS10,.01,"E"))
 . S @EXSTATTM@("statusChangeDateTimeFM")=$G(RADPATARR(FNBR10,IENS10,.01,"I"))
 . S @EXSTATTM@("statusChangeDateTimeHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR10,IENS10,.01,"I")))
 . S @EXSTATTM@("statusChangeDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR10,IENS10,.01,"I")))
 . S @EXSTATTM@("newStatus")=$G(RADPATARR(FNBR10,IENS10,2,"E"))
 . S @EXSTATTM@("newStatusId")=$G(RADPATARR(FNBR10,IENS10,2,"I"))
 . S @EXSTATTM@("computerUser")=$G(RADPATARR(FNBR10,IENS10,3,"E"))
 . S @EXSTATTM@("computerUserId")=$G(RADPATARR(FNBR10,IENS10,3,"I"))
 . S @EXSTATTM@("computerUserNPI")=$$GET1^DIQ(200,@EXSTATTM@("computerUserId")_",",41.99) ;NPI
 . S @EXSTATTM@("computerUserResId")=$$RESID^SYNDHP69("V",SITE,200,@EXSTATTM@("computerUserId"))
 . S @EXSTATTM@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS10,C,3)_U_FNBR4_U_$P(IENS10,C,2)_U_FNBR10_U_+IENS10)
 ;70.07 ;ACTIVITY LOG
 N IENS11 S IENS11=""
 F  S IENS11=$O(RADPATARR(FNBR11,IENS11)) QUIT:IENS11=""  D
 . N EXACTLOG S EXACTLOG=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS11,C,3),"examinationss","examinations",$P(IENS11,C,2),"activityLogs","activityLog",+IENS11))
 . S @EXACTLOG@("logDate")=$G(RADPATARR(FNBR11,IENS11,.01,"E"))
 . S @EXACTLOG@("logDateFM")=$G(RADPATARR(FNBR11,IENS11,.01,"I"))
 . S @EXACTLOG@("logDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR11,IENS11,.01,"I")))
 . S @EXACTLOG@("logDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR11,IENS11,.01,"I")))
 . S @EXACTLOG@("typeOfAction")=$G(RADPATARR(FNBR11,IENS11,2,"E"))
 . S @EXACTLOG@("typeOfActionCd")=$G(RADPATARR(FNBR11,IENS11,2,"I"))
 . S @EXACTLOG@("computerUser")=$G(RADPATARR(FNBR11,IENS11,3,"E"))
 . S @EXACTLOG@("computerUserId")=$G(RADPATARR(FNBR11,IENS11,3,"I"))
 . S @EXACTLOG@("computerUserNPI")=$$GET1^DIQ(200,@EXACTLOG@("computerUserId")_",",41.99) ;NPI
 . S @EXACTLOG@("computerUserResId")=$$RESID^SYNDHP69("V",SITE,200,@EXACTLOG@("computerUserId"))
 . S @EXACTLOG@("technologistComment")=$G(RADPATARR(FNBR11,IENS11,4,"E"))
 . S @EXACTLOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS11,C,3)_U_FNBR4_U_$P(IENS11,C,2)_U_FNBR11_U_+IENS11)
 ;70.1 ;PROCEDURE MODIFIERS
 N IENS12 S IENS12=""
 F  S IENS12=$O(RADPATARR(FNBR12,IENS12)) QUIT:IENS12=""  D
 . N PROCMOD S PROCMOD=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS12,C,3),"examinationss","examinations",$P(IENS12,C,2),"procedureModifierss","procedureModifiers",+IENS12))
 . S @PROCMOD@("procedureModifiers")=$G(RADPATARR(FNBR12,IENS12,.01,"E"))
 . S @PROCMOD@("procedureModifiersId")=$G(RADPATARR(FNBR12,IENS12,.01,"I"))
 . S @PROCMOD@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS12,C,3)_U_FNBR4_U_$P(IENS12,C,2)_U_FNBR12_U_+IENS12)
 ;70.3135 ;CPT MODIFIERS
 N IENS13 S IENS13=""
 F  S IENS13=$O(RADPATARR(FNBR13,IENS13)) QUIT:IENS13=""  D
 . N CPTMOD S CPTMOD=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS13,C,3),"examinationss","examinations",$P(IENS13,C,2),"cptModifierss","cptModifiers",+IENS13))
 . S @CPTMOD@("cptModifiers")=$G(RADPATARR(FNBR13,IENS13,.01,"E"))
 . S @CPTMOD@("cptModifiersId")=$G(RADPATARR(FNBR13,IENS13,.01,"I"))
 . S @CPTMOD@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS13,C,3)_U_FNBR4_U_$P(IENS13,C,2)_U_FNBR13_U_+IENS13)
 ;70.12 ;TECHNOLOGIST
 N IENS14 S IENS14=""
 F  S IENS14=$O(RADPATARR(FNBR14,IENS14)) QUIT:IENS14=""  D
 . N TECH S TECH=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS14,C,3),"examinationss","examinations",$P(IENS14,C,2),"technologists","technologist",+IENS14))
 . S @TECH@("technologist")=$G(RADPATARR(FNBR14,IENS14,.01,"E"))
 . S @TECH@("technologistId")=$G(RADPATARR(FNBR14,IENS14,.01,"I"))
 . S @TECH@("technologistNPI")=$$GET1^DIQ(200,@TECH@("technologistId")_",",41.99) ;NPI
 . S @TECH@("technologistResId")=$$RESID^SYNDHP69("V",SITE,200,@TECH@("technologistId"))
 . S @TECH@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS14,C,3)_U_FNBR4_U_$P(IENS14,C,2)_U_FNBR14_U_+IENS14)
 ;70.15 ;MEDICATIONS
 N IENS15 S IENS15=""
 F  S IENS15=$O(RADPATARR(FNBR15,IENS15)) QUIT:IENS15=""  D
 . N MEDS S MEDS=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS15,C,3),"examinationss","examinations",$P(IENS15,C,2),"medicationss","medications",+IENS15))
 . S @MEDS@("medAdministered")=$G(RADPATARR(FNBR15,IENS15,.01,"E"))
 . S @MEDS@("medAdministeredId")=$G(RADPATARR(FNBR15,IENS15,.01,"I"))
 . S @MEDS@("medDose")=$G(RADPATARR(FNBR15,IENS15,2,"E"))
 . S @MEDS@("dateTimeMedAdministered")=$G(RADPATARR(FNBR15,IENS15,3,"E"))
 . S @MEDS@("dateTimeMedAdministeredFM")=$G(RADPATARR(FNBR15,IENS15,3,"I"))
 . S @MEDS@("dateTimeMedAdministeredHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR15,IENS15,3,"I")))
 . S @MEDS@("dateTimeMedAdministeredFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR15,IENS15,3,"I")))
 . S @MEDS@("personWhoAdministeredMed")=$G(RADPATARR(FNBR15,IENS15,4,"E"))
 . S @MEDS@("personWhoAdministeredMedId")=$G(RADPATARR(FNBR15,IENS15,4,"I"))
 . S @MEDS@("personWhoAdministeredMedNPI")=$$GET1^DIQ(200,@MEDS@("personWhoAdministeredMedId")_",",41.99) ;NPI
 . S @MEDS@("personWhoAdministeredMedResId")=$$RESID^SYNDHP69("V",SITE,200,@MEDS@("personWhoAdministeredMedId"))
 . S @MEDS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS15,C,3)_U_FNBR4_U_$P(IENS15,C,2)_U_FNBR15_U_+IENS15)
 ;70.3225 ;CONTRAST MEDIA
 N IENS16 S IENS16=""
 F  S IENS16=$O(RADPATARR(FNBR16,IENS16)) QUIT:IENS16=""  D
 . N CONTMED S CONTMED=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS16,C,3),"examinationss","examinations",$P(IENS16,C,2),"contrastMedias","contrastMedia",+IENS16))
 . S @CONTMED@("contrastMedia")=$G(RADPATARR(FNBR16,IENS16,.01,"E"))
 . S @CONTMED@("contrastMediaCd")=$G(RADPATARR(FNBR16,IENS16,.01,"I"))
 . S @CONTMED@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS16,C,3)_U_FNBR4_U_$P(IENS16,C,2)_U_FNBR16_U_+IENS16)
 ;70.16 ;CONTRAST MEDIA ACTIVITY LOG
 N IENS17 S IENS17=""
 F  S IENS17=$O(RADPATARR(FNBR17,IENS17)) QUIT:IENS17=""  D
 . N CONTLOG S CONTLOG=$NA(RADPAT("Radpat","registeredExamss","registeredExams",$P(IENS17,C,3),"examinationss","examinations",$P(IENS17,C,2),"contrastMediaActivityLogs","contrastMediaActivityLog",+IENS17))
 . S @CONTLOG@("dateTimeEdited")=$G(RADPATARR(FNBR17,IENS17,.01,"E"))
 . S @CONTLOG@("dateTimeEditedFM")=$G(RADPATARR(FNBR17,IENS17,.01,"I"))
 . S @CONTLOG@("dateTimeEditedHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR17,IENS17,.01,"I")))
 . S @CONTLOG@("dateTimeEditedFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR17,IENS17,.01,"I")))
 . S @CONTLOG@("priorContrastMediaValue")=$G(RADPATARR(FNBR17,IENS17,2,"E"))
 . S @CONTLOG@("userWhoEditedContrast")=$G(RADPATARR(FNBR17,IENS17,3,"E"))
 . S @CONTLOG@("userWhoEditedContrastId")=$G(RADPATARR(FNBR17,IENS17,3,"I"))
 . S @CONTLOG@("userWhoEditedContrastNPI")=$$GET1^DIQ(200,@CONTLOG@("userWhoEditedContrastId")_",",41.99) ;NPI
 . S @CONTLOG@("userWhoEditedContrastResId")=$$RESID^SYNDHP69("V",SITE,200,@CONTLOG@("userWhoEditedContrastId"))
 . S @CONTLOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR2_U_$P(IENS17,C,3)_U_FNBR4_U_$P(IENS17,C,2)_U_FNBR17_U_+IENS17)
 ;70.06 ;OUTSIDE FILMS REGISTRY
 N IENS3 S IENS3=""
 F  S IENS3=$O(RADPATARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N OUTREG S OUTREG=$NA(RADPAT("Radpat","outsideFilmsRegistrys","outsideFilmsRegistry",+IENS3))
 . S @OUTREG@("outsideFilmsRegisterDate")=$G(RADPATARR(FNBR3,IENS3,.01,"E"))
 . S @OUTREG@("outsideFilmsRegisterDateFM")=$G(RADPATARR(FNBR3,IENS3,.01,"I"))
 . S @OUTREG@("outsideFilmsRegisterDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR3,IENS3,.01,"I")))
 . S @OUTREG@("outsideFilmsRegisterDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR3,IENS3,.01,"I")))
 . S @OUTREG@("neededBackDate")=$G(RADPATARR(FNBR3,IENS3,2,"E"))
 . S @OUTREG@("neededBackDateFM")=$G(RADPATARR(FNBR3,IENS3,2,"I"))
 . S @OUTREG@("neededBackDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR3,IENS3,2,"I")))
 . S @OUTREG@("neededBackDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR3,IENS3,2,"I")))
 . S @OUTREG@("returnedDate")=$G(RADPATARR(FNBR3,IENS3,3,"E"))
 . S @OUTREG@("returnedDateFM")=$G(RADPATARR(FNBR3,IENS3,3,"I"))
 . S @OUTREG@("returnedDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR3,IENS3,3,"I")))
 . S @OUTREG@("returnedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR3,IENS3,3,"I")))
 . S @OUTREG@("sourceOfFilms")=$G(RADPATARR(FNBR3,IENS3,4,"E"))
 . S @OUTREG@("askForOkBeforeReturning")=$G(RADPATARR(FNBR3,IENS3,5,"E"))
 . S @OUTREG@("askForOkBeforeReturningCd")=$G(RADPATARR(FNBR3,IENS3,5,"I"))
 . S @OUTREG@("hasReturnBeenOkEd")=$G(RADPATARR(FNBR3,IENS3,6,"E"))
 . S @OUTREG@("hasReturnBeenOkEdCd")=$G(RADPATARR(FNBR3,IENS3,6,"I"))
 . S @OUTREG@("remarks")=$G(RADPATARR(FNBR3,IENS3,20,"E"))
 . S @OUTREG@("activityLog")=$G(RADPATARR(FNBR3,IENS3,100,"E"))
 . S @OUTREG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR3_U_+IENS3)
 ;70.08 ;ACTIVITY LOG
 N IENS18 S IENS18=""
 F  S IENS18=$O(RADPATARR(FNBR18,IENS18)) QUIT:IENS18=""  D
 . N ACTLOG S ACTLOG=$NA(RADPAT("Radpat","outsideFilmsRegistrys","outsideFilmsRegistry",$P(IENS18,C,2),"activityLogs","activityLog",+IENS18))
 . S @ACTLOG@("logDate")=$G(RADPATARR(FNBR18,IENS18,.01,"E"))
 . S @ACTLOG@("logDateFM")=$G(RADPATARR(FNBR18,IENS18,.01,"I"))
 . S @ACTLOG@("logDateHL7")=$$FMTHL7^XLFDT($G(RADPATARR(FNBR18,IENS18,.01,"I")))
 . S @ACTLOG@("logDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADPATARR(FNBR18,IENS18,.01,"I")))
 . S @ACTLOG@("typeOfAction")=$G(RADPATARR(FNBR18,IENS18,2,"E"))
 . S @ACTLOG@("typeOfActionCd")=$G(RADPATARR(FNBR18,IENS18,2,"I"))
 . S @ACTLOG@("computerUser")=$G(RADPATARR(FNBR18,IENS18,3,"E"))
 . S @ACTLOG@("computerUserId")=$G(RADPATARR(FNBR18,IENS18,3,"I"))
 . S @ACTLOG@("computerUserNPI")=$$GET1^DIQ(200,@ACTLOG@("computerUserId")_",",41.99) ;NPI
 . S @ACTLOG@("computerUserResId")=$$RESID^SYNDHP69("V",SITE,200,@ACTLOG@("computerUserId"))
 . S @ACTLOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADPATIEN,FNBR3_U_$P(IENS18,C,2)_U_FNBR18_U_+IENS18)
 ;
 QUIT
 ;

SYNDHP28
SYNDHP28 ; HC/art - HealthConcourse - get Patient Prescription data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1PATRX(PATRX,PATRXIEN,RETJSON,PATRXJ) ;get Patient Prescription record
 ;inputs: PATRXIEN - Patient Prescription IEN
 ;        RETJSON - J = Return JSON
 ;output: PATRX  - array of Patient Prescription data, by reference
 ;        PATRXJ - JSON structure of Patient Prescription data, by reference
 ;
 I $G(DEBUG) W !,"------------------------ Patient Prescription --------------------------",!
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=52 ;PRESCRIPTION
 N FNBR2 S FNBR2=52.4 ;RX VERIFY
 N FNBR3 S FNBR3=52.032 ;LABEL DATE/TIME
 N FNBR4 S FNBR4=52.03 ;DRUG ALLERGY INGREDIENTS
 N FNBR5 S FNBR5=52.037 ;MEDICATION ROUTES
 N FNBR6 S FNBR6=52.038 ;SCHEDULES
 N FNBR7 S FNBR7=52.3 ;ACTIVITY LOG
 N FNBR8 S FNBR8=52.1 ;REFILL
 N FNBR9 S FNBR9=52.25 ;REJECT INFO
 N FNBR10 S FNBR10=52.2 ;PARTIAL DATE
 N FNBR11 S FNBR11=52.07 ;RETURN TO STOCK LOG
 N FNBR12 S FNBR12=52.0107 ;COPAY ACTIVITY LOG
 N FNBR13 S FNBR13=52.0113 ;MEDICATION INSTRUCTIONS
 N FNBR14 S FNBR14=52.01 ;CMOP EVENT
 N FNBR15 S FNBR15=52.052311 ;ICD DIAGNOSIS
 N FNBR16 S FNBR16=52.34 ;ACTIVITY LOG:OTHER COMMENTS
 N FNBR17 S FNBR17=52.2551 ;REJECT INFO:COMMENTS
 N IENS1 S IENS1=PATRXIEN_","
 ;
 N PATRXARR,PATRXERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","PATRXARR","PATRXERR")
 I $G(DEBUG) W $$ZW^SYNDHPUTL("PATRXARR")
 I $G(DEBUG),$D(PATRXERR) W !,">>ERROR<<" W !,$$ZW^SYNDHPUTL("PATRXERR")
 I $D(PATRXERR) D  QUIT
 . S PATRX("Patrx","ERROR")=PATRXIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATRX,.PATRXJ)
 S PATRX("Patrx","patrxIen")=PATRXIEN
 S PATRX("Patrx","resourceType")="PatientPrescription"
 S PATRX("Patrx","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN)
 S PATRX("Patrx","rx")=$G(PATRXARR(FNBR1,IENS1,.01,"E"))
 S PATRX("Patrx","issueDate")=$G(PATRXARR(FNBR1,IENS1,1,"E"))
 S PATRX("Patrx","issueDateFM")=$G(PATRXARR(FNBR1,IENS1,1,"I"))
 S PATRX("Patrx","issueDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,1,"I")))
 S PATRX("Patrx","issueDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,1,"I")))
 S PATRX("Patrx","patient")=$G(PATRXARR(FNBR1,IENS1,2,"E"))
 S PATRX("Patrx","patientId")=$G(PATRXARR(FNBR1,IENS1,2,"I"))
 S PATRX("Patrx","patientICN")=$$GET1^DIQ(2,PATRX("Patrx","patientId")_",",991.1)
 S PATRX("Patrx","patientStatus")=$G(PATRXARR(FNBR1,IENS1,3,"E"))
 S PATRX("Patrx","patientStatusId")=$G(PATRXARR(FNBR1,IENS1,3,"I"))
 S PATRX("Patrx","provider")=$G(PATRXARR(FNBR1,IENS1,4,"E"))
 S PATRX("Patrx","providerId")=$G(PATRXARR(FNBR1,IENS1,4,"I"))
 S PATRX("Patrx","providerNPI")=$$GET1^DIQ(200,PATRX("Patrx","providerId")_",",41.99) ;NPI
 S PATRX("Patrx","providerResId")=$$RESID^SYNDHP69("V",SITE,200,PATRX("Patrx","providerId"))
 S PATRX("Patrx","clinic")=$G(PATRXARR(FNBR1,IENS1,5,"E"))
 S PATRX("Patrx","clinicId")=$G(PATRXARR(FNBR1,IENS1,5,"I"))
 S PATRX("Patrx","drug")=$G(PATRXARR(FNBR1,IENS1,6,"E"))
 S PATRX("Patrx","drugId")=$G(PATRXARR(FNBR1,IENS1,6,"I"))
 S PATRX("Patrx","rxnorm")=$$GETRXN^SYNDHPUTL(PATRX("Patrx","drugId"))
 S PATRX("Patrx","tradeName")=$G(PATRXARR(FNBR1,IENS1,6.5,"E"))
 S PATRX("Patrx","qty")=$G(PATRXARR(FNBR1,IENS1,7,"E"))
 S PATRX("Patrx","daysSupply")=$G(PATRXARR(FNBR1,IENS1,8,"E"))
 S PATRX("Patrx","nbrOfRefills")=$G(PATRXARR(FNBR1,IENS1,9,"E"))
 S PATRX("Patrx","sig")=$G(PATRXARR(FNBR1,IENS1,10,"E"))
 S PATRX("Patrx","oerrSig")=$G(PATRXARR(FNBR1,IENS1,10.1,"E"))
 S PATRX("Patrx","oerrSigCd")=$G(PATRXARR(FNBR1,IENS1,10.1,"I"))
 S PATRX("Patrx","orderConverted")=$G(PATRXARR(FNBR1,IENS1,10.3,"E"))
 S PATRX("Patrx","orderConvertedCd")=$G(PATRXARR(FNBR1,IENS1,10.3,"I"))
 S PATRX("Patrx","copies")=$G(PATRXARR(FNBR1,IENS1,10.6,"E"))
 S PATRX("Patrx","mailWindow")=$G(PATRXARR(FNBR1,IENS1,11,"E"))
 S PATRX("Patrx","mailWindowCd")=$G(PATRXARR(FNBR1,IENS1,11,"I"))
 S PATRX("Patrx","remarks")=$G(PATRXARR(FNBR1,IENS1,12,"E"))
 S PATRX("Patrx","administeredInClinic")=$G(PATRXARR(FNBR1,IENS1,14,"E"))
 S PATRX("Patrx","administeredInClinicCd")=$G(PATRXARR(FNBR1,IENS1,14,"I"))
 S PATRX("Patrx","enteredBy")=$G(PATRXARR(FNBR1,IENS1,16,"E"))
 S PATRX("Patrx","enteredById")=$G(PATRXARR(FNBR1,IENS1,16,"I"))
 S PATRX("Patrx","unitPriceOfDrug")=$G(PATRXARR(FNBR1,IENS1,17,"E"))
 S PATRX("Patrx","division")=$G(PATRXARR(FNBR1,IENS1,20,"E"))
 S PATRX("Patrx","divisionId")=$G(PATRXARR(FNBR1,IENS1,20,"I"))
 S PATRX("Patrx","loginDate")=$G(PATRXARR(FNBR1,IENS1,21,"E"))
 S PATRX("Patrx","loginDateFM")=$G(PATRXARR(FNBR1,IENS1,21,"I"))
 S PATRX("Patrx","loginDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,21,"I")))
 S PATRX("Patrx","loginDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,21,"I")))
 S PATRX("Patrx","fillDate")=$G(PATRXARR(FNBR1,IENS1,22,"E"))
 S PATRX("Patrx","fillDateFM")=$G(PATRXARR(FNBR1,IENS1,22,"I"))
 S PATRX("Patrx","fillDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,22,"I")))
 S PATRX("Patrx","fillDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,22,"I")))
 S PATRX("Patrx","pharmacist")=$G(PATRXARR(FNBR1,IENS1,23,"E"))
 S PATRX("Patrx","pharmacistId")=$G(PATRXARR(FNBR1,IENS1,23,"I"))
 S PATRX("Patrx","pharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,PATRX("Patrx","pharmacistId"))
 S PATRX("Patrx","lot")=$G(PATRXARR(FNBR1,IENS1,24,"E"))
 S PATRX("Patrx","dispensedDate")=$G(PATRXARR(FNBR1,IENS1,25,"E"))
 S PATRX("Patrx","dispensedDateFM")=$G(PATRXARR(FNBR1,IENS1,25,"I"))
 S PATRX("Patrx","dispensedDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,25,"I")))
 S PATRX("Patrx","dispensedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,25,"I")))
 S PATRX("Patrx","expirationDate")=$G(PATRXARR(FNBR1,IENS1,26,"E"))
 S PATRX("Patrx","expirationDateFM")=$G(PATRXARR(FNBR1,IENS1,26,"I"))
 S PATRX("Patrx","expirationDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,26,"I")))
 S PATRX("Patrx","expirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,26,"I")))
 S PATRX("Patrx","cancelDate")=$G(PATRXARR(FNBR1,IENS1,26.1,"E"))
 S PATRX("Patrx","cancelDateFM")=$G(PATRXARR(FNBR1,IENS1,26.1,"I"))
 S PATRX("Patrx","cancelDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,26.1,"I")))
 S PATRX("Patrx","cancelDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,26.1,"I")))
 S PATRX("Patrx","ndc")=$G(PATRXARR(FNBR1,IENS1,27,"E"))
 S PATRX("Patrx","manufacturer")=$G(PATRXARR(FNBR1,IENS1,28,"E"))
 S PATRX("Patrx","drugExpirationDate")=$G(PATRXARR(FNBR1,IENS1,29,"E"))
 S PATRX("Patrx","drugExpirationDateFM")=$G(PATRXARR(FNBR1,IENS1,29,"I"))
 S PATRX("Patrx","drugExpirationDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,29,"I")))
 S PATRX("Patrx","drugExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,29,"I")))
 S PATRX("Patrx","genericProvider")=$G(PATRXARR(FNBR1,IENS1,30,"E"))
 S PATRX("Patrx","releasedDateTime")=$G(PATRXARR(FNBR1,IENS1,31,"E"))
 S PATRX("Patrx","releasedDateTimeFM")=$G(PATRXARR(FNBR1,IENS1,31,"I"))
 S PATRX("Patrx","releasedDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,31,"I")))
 S PATRX("Patrx","releasedDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,31,"I")))
 S PATRX("Patrx","returnedToStock")=$G(PATRXARR(FNBR1,IENS1,32.1,"E"))
 S PATRX("Patrx","returnedToStockFM")=$G(PATRXARR(FNBR1,IENS1,32.1,"I"))
 S PATRX("Patrx","returnedToStockHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,32.1,"I")))
 S PATRX("Patrx","returnedToStockFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,32.1,"I")))
 S PATRX("Patrx","reprint")=$G(PATRXARR(FNBR1,IENS1,32.2,"E"))
 S PATRX("Patrx","reprintCd")=$G(PATRXARR(FNBR1,IENS1,32.2,"I"))
 S PATRX("Patrx","bingoWaitTime")=$G(PATRXARR(FNBR1,IENS1,32.3,"E"))
 S PATRX("Patrx","severity")=$G(PATRXARR(FNBR1,IENS1,33,"E"))
 S PATRX("Patrx","affectedMedication")=$G(PATRXARR(FNBR1,IENS1,34,"E"))
 S PATRX("Patrx","drugAllergyIndication")=$G(PATRXARR(FNBR1,IENS1,34.1,"E"))
 S PATRX("Patrx","drugAllergyIndicationCd")=$G(PATRXARR(FNBR1,IENS1,34.1,"I"))
 S PATRX("Patrx","methodOfPickUp")=$G(PATRXARR(FNBR1,IENS1,35,"E"))
 S PATRX("Patrx","archived")=$G(PATRXARR(FNBR1,IENS1,36,"E"))
 S PATRX("Patrx","archivedCd")=$G(PATRXARR(FNBR1,IENS1,36,"I"))
 S PATRX("Patrx","finishingPerson")=$G(PATRXARR(FNBR1,IENS1,38,"E"))
 S PATRX("Patrx","finishingPersonId")=$G(PATRXARR(FNBR1,IENS1,38,"I"))
 S PATRX("Patrx","fillingPerson")=$G(PATRXARR(FNBR1,IENS1,38.1,"E"))
 S PATRX("Patrx","fillingPersonId")=$G(PATRXARR(FNBR1,IENS1,38.1,"I"))
 S PATRX("Patrx","checkingPharmacist")=$G(PATRXARR(FNBR1,IENS1,38.2,"E"))
 S PATRX("Patrx","checkingPharmacistId")=$G(PATRXARR(FNBR1,IENS1,38.2,"I"))
 S PATRX("Patrx","checkingPharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,PATRX("Patrx","checkingPharmacistId"))
 S PATRX("Patrx","finishDateTime")=$G(PATRXARR(FNBR1,IENS1,38.3,"E"))
 S PATRX("Patrx","finishDateTimeFM")=$G(PATRXARR(FNBR1,IENS1,38.3,"I"))
 S PATRX("Patrx","finishDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,38.3,"I")))
 S PATRX("Patrx","finishDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,38.3,"I")))
 S PATRX("Patrx","providerComments")=""
 N Z S Z=""
 F  S Z=$O(PATRXARR(FNBR1,IENS1,39,Z)) QUIT:'+Z  D
 . S PATRX("Patrx","providerComments")=PATRX("Patrx","providerComments")_$G(PATRXARR(FNBR1,IENS1,39,Z))
 S PATRX("Patrx","pharmacyInstructions")=""
 N Z S Z=""
 F  S Z=$O(PATRXARR(FNBR1,IENS1,39.1,Z)) QUIT:'+Z  D
 . S PATRX("Patrx","pharmacyInstructions")=PATRX("Patrx","pharmacyInstructions")_$G(PATRXARR(FNBR1,IENS1,39.1,Z))
 ;
 D RXCONT1^SYNDHP28A
 D RXCONT2^SYNDHP28B
 D RXCONT3^SYNDHP28C
 D RXCONT4^SYNDHP28D
 ;
 I $G(DEBUG) W !,$$ZW^SYNDHPUTL("PATRX")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATRX,.PATRXJ)
 ;
 QUIT
 ;

SYNDHP28A
SYNDHP28A ; HC/art - HealthConcourse - continuation of get Patient Prescription data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
RXCONT1 ; continuation of GET1PATRX^SYNDHP28 - get Patient Prescription data
 ;
 S PATRX("Patrx","pharmacyOrderableItem")=$G(PATRXARR(FNBR1,IENS1,39.2,"E"))
 S PATRX("Patrx","pharmacyOrderableItemId")=$G(PATRXARR(FNBR1,IENS1,39.2,"I"))
 S PATRX("Patrx","placerOrder")=$G(PATRXARR(FNBR1,IENS1,39.3,"E"))
 S PATRX("Patrx","previousOrder")=$G(PATRXARR(FNBR1,IENS1,39.4,"E"))
 S PATRX("Patrx","previousOrderId")=$G(PATRXARR(FNBR1,IENS1,39.4,"I"))
 S PATRX("Patrx","forwardOrder")=$G(PATRXARR(FNBR1,IENS1,39.5,"E"))
 S PATRX("Patrx","forwardOrderId")=$G(PATRXARR(FNBR1,IENS1,39.5,"I"))
 S PATRX("Patrx","wasThePatientCounseled")=$G(PATRXARR(FNBR1,IENS1,41,"E"))
 S PATRX("Patrx","wasThePatientCounseledCd")=$G(PATRXARR(FNBR1,IENS1,41,"I"))
 S PATRX("Patrx","wasCounselingUnderstood")=$G(PATRXARR(FNBR1,IENS1,42,"E"))
 S PATRX("Patrx","wasCounselingUnderstoodCd")=$G(PATRXARR(FNBR1,IENS1,42,"I"))
 S PATRX("Patrx","titrationDoseRx")=$G(PATRXARR(FNBR1,IENS1,45.1,"E"))
 S PATRX("Patrx","titrationDoseRxId")=$G(PATRXARR(FNBR1,IENS1,45.1,"I"))
 S PATRX("Patrx","maintenanceDoseRx")=$G(PATRXARR(FNBR1,IENS1,45.2,"E"))
 S PATRX("Patrx","maintenanceDoseRxId")=$G(PATRXARR(FNBR1,IENS1,45.2,"I"))
 S PATRX("Patrx","titrationRxFlag")=$G(PATRXARR(FNBR1,IENS1,45.3,"E"))
 S PATRX("Patrx","titrationRxFlagCd")=$G(PATRXARR(FNBR1,IENS1,45.3,"I"))
 S PATRX("Patrx","dawCode")=$G(PATRXARR(FNBR1,IENS1,81,"E"))
 S PATRX("Patrx","reTransmitFlag")=$G(PATRXARR(FNBR1,IENS1,82,"E"))
 S PATRX("Patrx","reTransmitFlagCd")=$G(PATRXARR(FNBR1,IENS1,82,"I"))
 S PATRX("Patrx","dateNdcValidated")=$G(PATRXARR(FNBR1,IENS1,83,"E"))
 S PATRX("Patrx","dateNdcValidatedFM")=$G(PATRXARR(FNBR1,IENS1,83,"I"))
 S PATRX("Patrx","dateNdcValidatedHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,83,"I")))
 S PATRX("Patrx","dateNdcValidatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,83,"I")))
 S PATRX("Patrx","ndcValidatedBy")=$G(PATRXARR(FNBR1,IENS1,84,"E"))
 S PATRX("Patrx","ndcValidatedById")=$G(PATRXARR(FNBR1,IENS1,84,"I"))
 S PATRX("Patrx","billingEligibilityIndicator")=$G(PATRXARR(FNBR1,IENS1,85,"E"))
 S PATRX("Patrx","billingEligibilityIndicatorCd")=$G(PATRXARR(FNBR1,IENS1,85,"I"))
 S PATRX("Patrx","epharmacySuspenseHoldDate")=$G(PATRXARR(FNBR1,IENS1,86,"E"))
 S PATRX("Patrx","epharmacySuspenseHoldDateFM")=$G(PATRXARR(FNBR1,IENS1,86,"I"))
 S PATRX("Patrx","epharmacySuspenseHoldDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,86,"I")))
 S PATRX("Patrx","epharmacySuspenseHoldDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,86,"I")))
 S PATRX("Patrx","holdReason")=$G(PATRXARR(FNBR1,IENS1,99,"E"))
 S PATRX("Patrx","holdReasonCd")=$G(PATRXARR(FNBR1,IENS1,99,"I"))
 S PATRX("Patrx","holdComments")=$G(PATRXARR(FNBR1,IENS1,99.1,"E"))
 S PATRX("Patrx","holdDate")=$G(PATRXARR(FNBR1,IENS1,99.2,"E"))
 S PATRX("Patrx","holdDateFM")=$G(PATRXARR(FNBR1,IENS1,99.2,"I"))
 S PATRX("Patrx","holdDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,99.2,"I")))
 S PATRX("Patrx","holdDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,99.2,"I")))
 S PATRX("Patrx","status")=$G(PATRXARR(FNBR1,IENS1,100,"E"))
 S PATRX("Patrx","statusCd")=$G(PATRXARR(FNBR1,IENS1,100,"I"))
 S PATRX("Patrx","discontinueType")=$G(PATRXARR(FNBR1,IENS1,100.1,"E"))
 S PATRX("Patrx","discontinueTypeCd")=$G(PATRXARR(FNBR1,IENS1,100.1,"I"))
 S PATRX("Patrx","lastDispensedDate")=$G(PATRXARR(FNBR1,IENS1,101,"E"))
 S PATRX("Patrx","lastDispensedDateFM")=$G(PATRXARR(FNBR1,IENS1,101,"I"))
 S PATRX("Patrx","lastDispensedDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,101,"I")))
 S PATRX("Patrx","lastDispensedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,101,"I")))
 S PATRX("Patrx","nextPossibleFill")=$G(PATRXARR(FNBR1,IENS1,102,"E"))
 S PATRX("Patrx","nextPossibleFillFM")=$G(PATRXARR(FNBR1,IENS1,102,"I"))
 S PATRX("Patrx","nextPossibleFillHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,102,"I")))
 S PATRX("Patrx","nextPossibleFillFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,102,"I")))
 S PATRX("Patrx","priorFillDate")=$G(PATRXARR(FNBR1,IENS1,102.1,"E"))
 S PATRX("Patrx","priorFillDateFM")=$G(PATRXARR(FNBR1,IENS1,102.1,"I"))
 S PATRX("Patrx","priorFillDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,102.1,"I")))
 S PATRX("Patrx","priorFillDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,102.1,"I")))
 S PATRX("Patrx","pendingNextPossibleFilldate")=$G(PATRXARR(FNBR1,IENS1,102.2,"E"))
 S PATRX("Patrx","pendingNextPossibleFilldateFM")=$G(PATRXARR(FNBR1,IENS1,102.2,"I"))
 S PATRX("Patrx","pendingNextPossibleFilldateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,102.2,"I")))
 S PATRX("Patrx","pendingNextPossibleFilldateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,102.2,"I")))
 S PATRX("Patrx","newDrug")=$G(PATRXARR(FNBR1,IENS1,103,"E"))
 S PATRX("Patrx","verifyingPharmacist")=$G(PATRXARR(FNBR1,IENS1,104,"E"))
 S PATRX("Patrx","verifyingPharmacistId")=$G(PATRXARR(FNBR1,IENS1,104,"I"))
 S PATRX("Patrx","verifyingPharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,PATRX("Patrx","verifyingPharmacistId"))
 S PATRX("Patrx","copayTransactionType")=$G(PATRXARR(FNBR1,IENS1,105,"E"))
 S PATRX("Patrx","copayTransactionTypeId")=$G(PATRXARR(FNBR1,IENS1,105,"I"))
 S PATRX("Patrx","ibNumber")=$G(PATRXARR(FNBR1,IENS1,106,"E"))
 S PATRX("Patrx","ibNumberId")=$G(PATRXARR(FNBR1,IENS1,106,"I"))
 S PATRX("Patrx","copayTypeAudit")=$G(PATRXARR(FNBR1,IENS1,106.5,"E"))
 S PATRX("Patrx","copayExceedingCap")=$G(PATRXARR(FNBR1,IENS1,106.6,"E"))
 S PATRX("Patrx","copayExceedingCapId")=$G(PATRXARR(FNBR1,IENS1,106.6,"I"))
 S PATRX("Patrx","deletionComments")=$G(PATRXARR(FNBR1,IENS1,108,"E"))
 S PATRX("Patrx","cosigningPhysician")=$G(PATRXARR(FNBR1,IENS1,109,"E"))
 S PATRX("Patrx","cosigningPhysicianId")=$G(PATRXARR(FNBR1,IENS1,109,"I"))
 S PATRX("Patrx","cosigningPhysicianNPI")=$$GET1^DIQ(200,PATRX("Patrx","cosigningPhysicianId")_",",41.99) ;NPI
 S PATRX("Patrx","cosigningPhysicianResId")=$$RESID^SYNDHP69("V",SITE,200,PATRX("Patrx","cosigningPhysicianId"))
 S PATRX("Patrx","typeOfRx")=$G(PATRXARR(FNBR1,IENS1,110,"E"))
 S PATRX("Patrx","poeRx")=$G(PATRXARR(FNBR1,IENS1,111,"E"))
 S PATRX("Patrx","poeRxCd")=$G(PATRXARR(FNBR1,IENS1,111,"I"))
 S PATRX("Patrx","originalQty")=$G(PATRXARR(FNBR1,IENS1,112,"E"))
 S PATRX("Patrx","patientInstructions")=$G(PATRXARR(FNBR1,IENS1,114,"E"))
 S PATRX("Patrx","otherPatientInstructions")=$G(PATRXARR(FNBR1,IENS1,114.1,"E"))
 S PATRX("Patrx","expandedPatientInstructions")=""
 N Z S Z=""
 F  S Z=$O(PATRXARR(FNBR1,IENS1,115,Z)) QUIT:'+Z  D
 . S PATRX("Patrx","expandedPatientInstructions")=PATRX("Patrx","expandedPatientInstructions")_$G(PATRXARR(FNBR1,IENS1,115,Z))
 S PATRX("Patrx","serviceConnected")=$G(PATRXARR(FNBR1,IENS1,116,"E"))
 S PATRX("Patrx","serviceConnectedCd")=$G(PATRXARR(FNBR1,IENS1,116,"I"))
 S PATRX("Patrx","militarySexualTrauma")=$G(PATRXARR(FNBR1,IENS1,117,"E"))
 S PATRX("Patrx","militarySexualTraumaCd")=$G(PATRXARR(FNBR1,IENS1,117,"I"))
 S PATRX("Patrx","agentOrangeExposure")=$G(PATRXARR(FNBR1,IENS1,118,"E"))
 S PATRX("Patrx","agentOrangeExposureCd")=$G(PATRXARR(FNBR1,IENS1,118,"I"))
 S PATRX("Patrx","ionizingRadiationExposure")=$G(PATRXARR(FNBR1,IENS1,119,"E"))
 S PATRX("Patrx","ionizingRadiationExposureCd")=$G(PATRXARR(FNBR1,IENS1,119,"I"))
 S PATRX("Patrx","southwestAsiaConditions")=$G(PATRXARR(FNBR1,IENS1,120,"E"))
 S PATRX("Patrx","southwestAsiaConditionsCd")=$G(PATRXARR(FNBR1,IENS1,120,"I"))
 S PATRX("Patrx","ddstatus")=$G(PATRXARR(FNBR1,IENS1,120.01,"E"))
 S PATRX("Patrx","dateOfDeathHistory")=$G(PATRXARR(FNBR1,IENS1,120.02,"E"))
 S PATRX("Patrx","headAndOrNeckCancer")=$G(PATRXARR(FNBR1,IENS1,121,"E"))
 S PATRX("Patrx","headAndOrNeckCancerCd")=$G(PATRXARR(FNBR1,IENS1,121,"I"))
 S PATRX("Patrx","combatVeteran")=$G(PATRXARR(FNBR1,IENS1,122,"E"))
 S PATRX("Patrx","combatVeteranCd")=$G(PATRXARR(FNBR1,IENS1,122,"I"))
 S PATRX("Patrx","proj112Shad")=$G(PATRXARR(FNBR1,IENS1,122.01,"E"))
 S PATRX("Patrx","proj112ShadCd")=$G(PATRXARR(FNBR1,IENS1,122.01,"I"))
 S PATRX("Patrx","externalPlacerOrderNumber")=$G(PATRXARR(FNBR1,IENS1,123,"E"))
 S PATRX("Patrx","externalApplication")=$G(PATRXARR(FNBR1,IENS1,124,"E"))
 S PATRX("Patrx","pfssAccountReference")=$G(PATRXARR(FNBR1,IENS1,125,"E"))
 S PATRX("Patrx","pfssAccountReferenceId")=$G(PATRXARR(FNBR1,IENS1,125,"I"))
 S PATRX("Patrx","pfssChargeId")=$G(PATRXARR(FNBR1,IENS1,126,"E"))
 S PATRX("Patrx","lastDispensedDateHolder")=$G(PATRXARR(FNBR1,IENS1,127,"E"))
 S PATRX("Patrx","lastDispensedDateHolderFM")=$G(PATRXARR(FNBR1,IENS1,127,"I"))
 S PATRX("Patrx","lastDispensedDateHolderHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,127,"I")))
 S PATRX("Patrx","lastDispensedDateHolderFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,127,"I")))
 S PATRX("Patrx","tpbRx")=$G(PATRXARR(FNBR1,IENS1,201,"E"))
 S PATRX("Patrx","tpbRxCd")=$G(PATRXARR(FNBR1,IENS1,201,"I"))
 S PATRX("Patrx","clozapineDosageMgDay")=$G(PATRXARR(FNBR1,IENS1,301,"E"))
 S PATRX("Patrx","wbcResults")=$G(PATRXARR(FNBR1,IENS1,302,"E"))
 S PATRX("Patrx","dateOfWbcTest")=$G(PATRXARR(FNBR1,IENS1,303,"E"))
 S PATRX("Patrx","dateOfWbcTestFM")=$G(PATRXARR(FNBR1,IENS1,303,"I"))
 S PATRX("Patrx","dateOfWbcTestHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR1,IENS1,303,"I")))
 S PATRX("Patrx","dateOfWbcTestFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR1,IENS1,303,"I")))
 S PATRX("Patrx","ancResults")=$G(PATRXARR(FNBR1,IENS1,304,"E"))
 S PATRX("Patrx","signatureStatus")=$G(PATRXARR(FNBR1,IENS1,310,"E"))
 S PATRX("Patrx","signatureStatusCd")=$G(PATRXARR(FNBR1,IENS1,310,"I"))
 S PATRX("Patrx","backdoorSignatureStatus")=$G(PATRXARR(FNBR1,IENS1,311,"E"))
 S PATRX("Patrx","backdoorSignatureStatusCd")=$G(PATRXARR(FNBR1,IENS1,311,"I"))
 S PATRX("Patrx","hospitalCoverage")=$G(PATRXARR(FNBR1,IENS1,521011,"E"))
 ;
 N IENS2 S IENS2=""
 F  S IENS2=$O(PATRXARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N VERIFY S VERIFY=$NA(PATRX("Patrx","rxVerifys","rxVerify",+IENS2))
 . S @VERIFY@("rx")=$G(PATRXARR(FNBR2,IENS2,.01,"E"))
 . S @VERIFY@("rxId")=$G(PATRXARR(FNBR2,IENS2,.01,"I"))
 . S @VERIFY@("patientName")=$G(PATRXARR(FNBR2,IENS2,1,"E"))
 . S @VERIFY@("patientNameId")=$G(PATRXARR(FNBR2,IENS2,1,"I"))
 . S @VERIFY@("patientNameICN")=$$GET1^DIQ(2,@VERIFY@("patientNameId")_",",991.1)
 . S @VERIFY@("clerk")=$G(PATRXARR(FNBR2,IENS2,2,"E"))
 . S @VERIFY@("clerkId")=$G(PATRXARR(FNBR2,IENS2,2,"I"))
 . S @VERIFY@("renewedFromRx")=$G(PATRXARR(FNBR2,IENS2,3,"E"))
 . S @VERIFY@("renewedFromRxId")=$G(PATRXARR(FNBR2,IENS2,3,"I"))
 . S @VERIFY@("loginDate")=$G(PATRXARR(FNBR2,IENS2,4,"E"))
 . S @VERIFY@("loginDateFM")=$G(PATRXARR(FNBR2,IENS2,4,"I"))
 . S @VERIFY@("loginDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR2,IENS2,4,"I")))
 . S @VERIFY@("loginDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR2,IENS2,4,"I")))
 . S @VERIFY@("psorxd0")=$G(PATRXARR(FNBR2,IENS2,5,"E"))
 . S @VERIFY@("psorxexp")=$G(PATRXARR(FNBR2,IENS2,6,"E"))
 . S @VERIFY@("drugInteraction")=$G(PATRXARR(FNBR2,IENS2,7,"E"))
 . S @VERIFY@("drugInteractionCd")=$G(PATRXARR(FNBR2,IENS2,7,"I"))
 . S @VERIFY@("severity")=$G(PATRXARR(FNBR2,IENS2,7.1,"E"))
 . S @VERIFY@("affectedMedication")=$G(PATRXARR(FNBR2,IENS2,7.2,"E"))
 . S @VERIFY@("doseWarning")=$G(PATRXARR(FNBR2,IENS2,8,"E"))
 . S @VERIFY@("doseWarningCd")=$G(PATRXARR(FNBR2,IENS2,8,"I"))
 . S @VERIFY@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR2_U_+IENS2)
 ;
 N IENS3 S IENS3=""
 F  S IENS3=$O(PATRXARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N LABEL S LABEL=$NA(PATRX("Patrx","labelDateTimes","labelDateTime",+IENS3))
 . S @LABEL@("labelDateTime")=$G(PATRXARR(FNBR3,IENS3,.01,"E"))
 . S @LABEL@("labelDateTimeFM")=$G(PATRXARR(FNBR3,IENS3,.01,"I"))
 . S @LABEL@("labelDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR3,IENS3,.01,"I")))
 . S @LABEL@("labelDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR3,IENS3,.01,"I")))
 . S @LABEL@("rxReference")=$G(PATRXARR(FNBR3,IENS3,1,"E"))
 . S @LABEL@("labelComment")=$G(PATRXARR(FNBR3,IENS3,2,"E"))
 . S @LABEL@("printedBy")=$G(PATRXARR(FNBR3,IENS3,3,"E"))
 . S @LABEL@("printedById")=$G(PATRXARR(FNBR3,IENS3,3,"I"))
 . S @LABEL@("warningLabelType")=$G(PATRXARR(FNBR3,IENS3,4,"E"))
 . S @LABEL@("warningLabelTypeCd")=$G(PATRXARR(FNBR3,IENS3,4,"I"))
 . S @LABEL@("device")=$G(PATRXARR(FNBR3,IENS3,5,"E"))
 . S @LABEL@("fdaMedGuideFilename")=$G(PATRXARR(FNBR3,IENS3,35,"E"))
 . S @LABEL@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR3_U_+IENS3)
 ;
 N IENS4 S IENS4=""
 F  S IENS4=$O(PATRXARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N ALLERGY S ALLERGY=$NA(PATRX("Patrx","drugAllergyIngredientss","drugAllergyIngredients",+IENS4))
 . S @ALLERGY@("ingredients")=$G(PATRXARR(FNBR4,IENS4,.01,"E"))
 . S @ALLERGY@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR4_U_+IENS4)
 ;
 ;
 QUIT
 ;

SYNDHP28B
SYNDHP28B ; HC/art - HealthConcourse - continuation of get Patient Prescription data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
RXCONT2 ; continuation of GET1PATRX^SYNDHP28 - get Patient Prescription data
 ;
 N IENS5 S IENS5=""
 F  S IENS5=$O(PATRXARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . N ROUTES S ROUTES=$NA(PATRX("Patrx","medicationRoutess","medicationRoutes",+IENS5))
 . S @ROUTES@("medicationRoutes")=$G(PATRXARR(FNBR5,IENS5,.01,"E"))
 . S @ROUTES@("medicationRoutesId")=$G(PATRXARR(FNBR5,IENS5,.01,"I"))
 . S @ROUTES@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR5_U_+IENS5)
 ;
 N IENS6 S IENS6=""
 F  S IENS6=$O(PATRXARR(FNBR6,IENS6)) QUIT:IENS6=""  D
 . N SCHED S SCHED=$NA(PATRX("Patrx","scheduless","schedules",+IENS6))
 . S @SCHED@("schedules")=$G(PATRXARR(FNBR6,IENS6,.01,"E"))
 . S @SCHED@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR6_U_+IENS6)
 ;
 N IENS7 S IENS7=""
 F  S IENS7=$O(PATRXARR(FNBR7,IENS7)) QUIT:IENS7=""  D
 . N ACTLOG S ACTLOG=$NA(PATRX("Patrx","activityLogs","activityLog",+IENS7))
 . S @ACTLOG@("activityLog")=$G(PATRXARR(FNBR7,IENS7,.01,"E"))
 . S @ACTLOG@("activityLogFM")=$G(PATRXARR(FNBR7,IENS7,.01,"I"))
 . S @ACTLOG@("activityLogHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR7,IENS7,.01,"I")))
 . S @ACTLOG@("activityLogFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR7,IENS7,.01,"I")))
 . S @ACTLOG@("reason")=$G(PATRXARR(FNBR7,IENS7,.02,"E"))
 . S @ACTLOG@("reasonCd")=$G(PATRXARR(FNBR7,IENS7,.02,"I"))
 . S @ACTLOG@("initiatorOfActivity")=$G(PATRXARR(FNBR7,IENS7,.03,"E"))
 . S @ACTLOG@("initiatorOfActivityId")=$G(PATRXARR(FNBR7,IENS7,.03,"I"))
 . S @ACTLOG@("rxReference")=$G(PATRXARR(FNBR7,IENS7,.04,"E"))
 . S @ACTLOG@("comment")=$G(PATRXARR(FNBR7,IENS7,.05,"E"))
 . S @ACTLOG@("fieldEdited")=$G(PATRXARR(FNBR7,IENS7,1,"E"))
 . S @ACTLOG@("oldValue")=$G(PATRXARR(FNBR7,IENS7,2,"E"))
 . S @ACTLOG@("newValue")=$G(PATRXARR(FNBR7,IENS7,3,"E"))
 . S @ACTLOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR7_U_+IENS7)
 ;
 N IENS16 S IENS16=""
 F  S IENS16=$O(PATRXARR(FNBR16,IENS16)) QUIT:IENS16=""  D
 . N ACTLOGCOM S ACTLOGCOM=$NA(PATRX("Patrx","activityLogs","activityLog",$P(IENS16,C,2),"otherCommentss","otherComments",+IENS16))
 . S @ACTLOGCOM@("otherComments")=$G(PATRXARR(FNBR16,IENS16,.01,"E"))
 . S @ACTLOGCOM@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR7_U_$P(IENS16,C,2)_U_FNBR16_U_+IENS16)
 ;
 N IENS8 S IENS8=""
 F  S IENS8=$O(PATRXARR(FNBR8,IENS8)) QUIT:IENS8=""  D
 . N REFILLS S REFILLS=$NA(PATRX("Patrx","refills","refill",+IENS8))
 . S @REFILLS@("refillDate")=$G(PATRXARR(FNBR8,IENS8,.01,"E"))
 . S @REFILLS@("refillDateFM")=$G(PATRXARR(FNBR8,IENS8,.01,"I"))
 . S @REFILLS@("refillDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,.01,"I")))
 . S @REFILLS@("refillDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,.01,"I")))
 . S @REFILLS@("qty")=$G(PATRXARR(FNBR8,IENS8,1,"E"))
 . S @REFILLS@("daysSupply")=$G(PATRXARR(FNBR8,IENS8,1.1,"E"))
 . S @REFILLS@("currentUnitPriceOfDrug")=$G(PATRXARR(FNBR8,IENS8,1.2,"E"))
 . S @REFILLS@("mailWindow")=$G(PATRXARR(FNBR8,IENS8,2,"E"))
 . S @REFILLS@("mailWindowCd")=$G(PATRXARR(FNBR8,IENS8,2,"I"))
 . S @REFILLS@("remarks")=$G(PATRXARR(FNBR8,IENS8,3,"E"))
 . S @REFILLS@("pharmacistName")=$G(PATRXARR(FNBR8,IENS8,4,"E"))
 . S @REFILLS@("pharmacistNameId")=$G(PATRXARR(FNBR8,IENS8,4,"I"))
 . S @REFILLS@("lot")=$G(PATRXARR(FNBR8,IENS8,5,"E"))
 . S @REFILLS@("clerkCode")=$G(PATRXARR(FNBR8,IENS8,6,"E"))
 . S @REFILLS@("clerkCodeId")=$G(PATRXARR(FNBR8,IENS8,6,"I"))
 . S @REFILLS@("loginDate")=$G(PATRXARR(FNBR8,IENS8,7,"E"))
 . S @REFILLS@("loginDateFM")=$G(PATRXARR(FNBR8,IENS8,7,"I"))
 . S @REFILLS@("loginDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,7,"I")))
 . S @REFILLS@("loginDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,7,"I")))
 . S @REFILLS@("division")=$G(PATRXARR(FNBR8,IENS8,8,"E"))
 . S @REFILLS@("divisionId")=$G(PATRXARR(FNBR8,IENS8,8,"I"))
 . S @REFILLS@("ibNumber")=$G(PATRXARR(FNBR8,IENS8,9,"E"))
 . S @REFILLS@("ibNumberId")=$G(PATRXARR(FNBR8,IENS8,9,"I"))
 . S @REFILLS@("copayExceedingCap")=$G(PATRXARR(FNBR8,IENS8,9.1,"E"))
 . S @REFILLS@("copayExceedingCapId")=$G(PATRXARR(FNBR8,IENS8,9.1,"I"))
 . S @REFILLS@("dispensedDate")=$G(PATRXARR(FNBR8,IENS8,10.1,"E"))
 . S @REFILLS@("dispensedDateFM")=$G(PATRXARR(FNBR8,IENS8,10.1,"I"))
 . S @REFILLS@("dispensedDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,10.1,"I")))
 . S @REFILLS@("dispensedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,10.1,"I")))
 . S @REFILLS@("ndc")=$G(PATRXARR(FNBR8,IENS8,11,"E"))
 . S @REFILLS@("manufacturer")=$G(PATRXARR(FNBR8,IENS8,12,"E"))
 . S @REFILLS@("drugExpirationDate")=$G(PATRXARR(FNBR8,IENS8,13,"E"))
 . S @REFILLS@("drugExpirationDateFM")=$G(PATRXARR(FNBR8,IENS8,13,"I"))
 . S @REFILLS@("drugExpirationDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,13,"I")))
 . S @REFILLS@("drugExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,13,"I")))
 . S @REFILLS@("returnedToStock")=$G(PATRXARR(FNBR8,IENS8,14,"E"))
 . S @REFILLS@("returnedToStockFM")=$G(PATRXARR(FNBR8,IENS8,14,"I"))
 . S @REFILLS@("returnedToStockHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,14,"I")))
 . S @REFILLS@("returnedToStockFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,14,"I")))
 . S @REFILLS@("provider")=$G(PATRXARR(FNBR8,IENS8,15,"E"))
 . S @REFILLS@("providerId")=$G(PATRXARR(FNBR8,IENS8,15,"I"))
 . S @REFILLS@("providerNPI")=$$GET1^DIQ(200,@REFILLS@("providerId")_",",41.99) ;NPI
 . S @REFILLS@("providerResId")=$$RESID^SYNDHP69("V",SITE,200,@REFILLS@("providerId"))
 . S @REFILLS@("genericProvider")=$G(PATRXARR(FNBR8,IENS8,16,"E"))
 . S @REFILLS@("releasedDateTime")=$G(PATRXARR(FNBR8,IENS8,17,"E"))
 . S @REFILLS@("releasedDateTimeFM")=$G(PATRXARR(FNBR8,IENS8,17,"I"))
 . S @REFILLS@("releasedDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,17,"I")))
 . S @REFILLS@("releasedDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,17,"I")))
 . S @REFILLS@("bingoWaitTime")=$G(PATRXARR(FNBR8,IENS8,18,"E"))
 . S @REFILLS@("fillingPerson")=$G(PATRXARR(FNBR8,IENS8,19,"E"))
 . S @REFILLS@("fillingPersonId")=$G(PATRXARR(FNBR8,IENS8,19,"I"))
 . S @REFILLS@("checkingPharmacist")=$G(PATRXARR(FNBR8,IENS8,20,"E"))
 . S @REFILLS@("checkingPharmacistId")=$G(PATRXARR(FNBR8,IENS8,20,"I"))
 . S @REFILLS@("checkingPharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,@REFILLS@("checkingPharmacistId"))
 . S @REFILLS@("pfssAccountReference")=$G(PATRXARR(FNBR8,IENS8,21,"E"))
 . S @REFILLS@("pfssAccountReferenceId")=$G(PATRXARR(FNBR8,IENS8,21,"I"))
 . S @REFILLS@("pfssChargeId")=$G(PATRXARR(FNBR8,IENS8,22,"E"))
 . S @REFILLS@("administeredInClinic")=$G(PATRXARR(FNBR8,IENS8,23,"E"))
 . S @REFILLS@("administeredInClinicCd")=$G(PATRXARR(FNBR8,IENS8,23,"I"))
 . S @REFILLS@("dawCode")=$G(PATRXARR(FNBR8,IENS8,81,"E"))
 . S @REFILLS@("reTransmitFlag")=$G(PATRXARR(FNBR8,IENS8,82,"E"))
 . S @REFILLS@("reTransmitFlagCd")=$G(PATRXARR(FNBR8,IENS8,82,"I"))
 . S @REFILLS@("dateNdcValidated")=$G(PATRXARR(FNBR8,IENS8,83,"E"))
 . S @REFILLS@("dateNdcValidatedFM")=$G(PATRXARR(FNBR8,IENS8,83,"I"))
 . S @REFILLS@("dateNdcValidatedHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,83,"I")))
 . S @REFILLS@("dateNdcValidatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,83,"I")))
 . S @REFILLS@("ndcValidatedBy")=$G(PATRXARR(FNBR8,IENS8,84,"E"))
 . S @REFILLS@("ndcValidatedById")=$G(PATRXARR(FNBR8,IENS8,84,"I"))
 . S @REFILLS@("billingEligibilityIndicator")=$G(PATRXARR(FNBR8,IENS8,85,"E"))
 . S @REFILLS@("billingEligibilityIndicatorCd")=$G(PATRXARR(FNBR8,IENS8,85,"I"))
 . S @REFILLS@("epharmacySuspenseHoldDate")=$G(PATRXARR(FNBR8,IENS8,86,"E"))
 . S @REFILLS@("epharmacySuspenseHoldDateFM")=$G(PATRXARR(FNBR8,IENS8,86,"I"))
 . S @REFILLS@("epharmacySuspenseHoldDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR8,IENS8,86,"I")))
 . S @REFILLS@("epharmacySuspenseHoldDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR8,IENS8,86,"I")))
 . S @REFILLS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR8_U_+IENS8)
 ;
 N IENS9 S IENS9=""
 F  S IENS9=$O(PATRXARR(FNBR9,IENS9)) QUIT:IENS9=""  D
 . N REJECT S REJECT=$NA(PATRX("Patrx","rejectInfos","rejectInfo",+IENS9))
 . S @REJECT@("ncpdpRejectCode")=$G(PATRXARR(FNBR9,IENS9,.01,"E"))
 . S @REJECT@("dateTimeDetected")=$G(PATRXARR(FNBR9,IENS9,1,"E"))
 . S @REJECT@("dateTimeDetectedFM")=$G(PATRXARR(FNBR9,IENS9,1,"I"))
 . S @REJECT@("dateTimeDetectedHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR9,IENS9,1,"I")))
 . S @REJECT@("dateTimeDetectedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR9,IENS9,1,"I")))
 . S @REJECT@("payerMessage")=$G(PATRXARR(FNBR9,IENS9,2,"E"))
 . S @REJECT@("reason")=$G(PATRXARR(FNBR9,IENS9,3,"E"))
 . S @REJECT@("pharmacist")=$G(PATRXARR(FNBR9,IENS9,4,"E"))
 . S @REJECT@("pharmacistId")=$G(PATRXARR(FNBR9,IENS9,4,"I"))
 . S @REJECT@("pharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,@REJECT@("pharmacistId"))
 . S @REJECT@("fillNumber")=$G(PATRXARR(FNBR9,IENS9,5,"E"))
 . S @REJECT@("groupName")=$G(PATRXARR(FNBR9,IENS9,6,"E"))
 . S @REJECT@("planContact")=$G(PATRXARR(FNBR9,IENS9,7,"E"))
 . S @REJECT@("planPreviousFillDate")=$G(PATRXARR(FNBR9,IENS9,8,"E"))
 . S @REJECT@("planPreviousFillDateFM")=$G(PATRXARR(FNBR9,IENS9,8,"I"))
 . S @REJECT@("planPreviousFillDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR9,IENS9,8,"I")))
 . S @REJECT@("planPreviousFillDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR9,IENS9,8,"I")))
 . S @REJECT@("status")=$G(PATRXARR(FNBR9,IENS9,9,"E"))
 . S @REJECT@("statusCd")=$G(PATRXARR(FNBR9,IENS9,9,"I"))
 . S @REJECT@("closedDateTime")=$G(PATRXARR(FNBR9,IENS9,10,"E"))
 . S @REJECT@("closedDateTimeFM")=$G(PATRXARR(FNBR9,IENS9,10,"I"))
 . S @REJECT@("closedDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR9,IENS9,10,"I")))
 . S @REJECT@("closedDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR9,IENS9,10,"I")))
 . S @REJECT@("closedBy")=$G(PATRXARR(FNBR9,IENS9,11,"E"))
 . S @REJECT@("closedById")=$G(PATRXARR(FNBR9,IENS9,11,"I"))
 . S @REJECT@("closeReason")=$G(PATRXARR(FNBR9,IENS9,12,"E"))
 . S @REJECT@("closeReasonCd")=$G(PATRXARR(FNBR9,IENS9,12,"I"))
 . S @REJECT@("closeComments")=$G(PATRXARR(FNBR9,IENS9,13,"E"))
 . S @REJECT@("reasonForServiceCode")=$G(PATRXARR(FNBR9,IENS9,14,"E"))
 . S @REJECT@("professionalServiceCode")=$G(PATRXARR(FNBR9,IENS9,15,"E"))
 . S @REJECT@("responseId")=$G(PATRXARR(FNBR9,IENS9,16,"E"))
 . S @REJECT@("otherRejects")=$G(PATRXARR(FNBR9,IENS9,17,"E"))
 . S @REJECT@("durText")=$G(PATRXARR(FNBR9,IENS9,18,"E"))
 . S @REJECT@("resultOfServiceCode")=$G(PATRXARR(FNBR9,IENS9,19,"E"))
 . S @REJECT@("insuranceName")=$G(PATRXARR(FNBR9,IENS9,20,"E"))
 . S @REJECT@("groupNumber")=$G(PATRXARR(FNBR9,IENS9,21,"E"))
 . S @REJECT@("cardholderId")=$G(PATRXARR(FNBR9,IENS9,22,"E"))
 . S @REJECT@("reOpened")=$G(PATRXARR(FNBR9,IENS9,23,"E"))
 . S @REJECT@("reOpenedCd")=$G(PATRXARR(FNBR9,IENS9,23,"I"))
 . S @REJECT@("clarificationCode")=$G(PATRXARR(FNBR9,IENS9,24,"E"))
 . S @REJECT@("priorAuthorizationType")=$G(PATRXARR(FNBR9,IENS9,25,"E"))
 . S @REJECT@("priorAuthorizationNumber")=$G(PATRXARR(FNBR9,IENS9,26,"E"))
 . S @REJECT@("coordinationOfBenefits")=$G(PATRXARR(FNBR9,IENS9,27,"E"))
 . S @REJECT@("coordinationOfBenefitsCd")=$G(PATRXARR(FNBR9,IENS9,27,"I"))
 . S @REJECT@("durAddMsgText")=$G(PATRXARR(FNBR9,IENS9,28,"E"))
 . S @REJECT@("bin")=$G(PATRXARR(FNBR9,IENS9,29,"E"))
 . S @REJECT@("rrrFlag")=$G(PATRXARR(FNBR9,IENS9,30,"E"))
 . S @REJECT@("rrrFlagCd")=$G(PATRXARR(FNBR9,IENS9,30,"I"))
 . S @REJECT@("rrrDollarThreshold")=$G(PATRXARR(FNBR9,IENS9,31,"E"))
 . S @REJECT@("rrrGrossAmountDue")=$G(PATRXARR(FNBR9,IENS9,32,"E"))
 . S @REJECT@("insuranceCompany")=$G(PATRXARR(FNBR9,IENS9,33,"E"))
 . S @REJECT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR9_U_+IENS9)
 ;
 QUIT
 ;

SYNDHP28C
SYNDHP28C ; HC/art - HealthConcourse - continuation of get Patient Prescription data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
RXCONT3 ; continuation of GET1PATRX^SYNDHP28 - get Patient Prescription data
 ;
 N IENS17 S IENS17=""
 F  S IENS17=$O(PATRXARR(FNBR17,IENS17)) QUIT:IENS17=""  D
 . N REJECTCOM S REJECTCOM=$NA(PATRX("Patrx","rejectInfos","rejectInfo",$P(IENS17,C,2),"commentss","comments",+IENS17))
 . S @REJECTCOM@("dateTime")=$G(PATRXARR(FNBR17,IENS17,.01,"E"))
 . S @REJECTCOM@("dateTimeFM")=$G(PATRXARR(FNBR17,IENS17,.01,"I"))
 . S @REJECTCOM@("dateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR17,IENS17,.01,"I")))
 . S @REJECTCOM@("dateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR17,IENS17,.01,"I")))
 . S @REJECTCOM@("user")=$G(PATRXARR(FNBR17,IENS17,1,"E"))
 . S @REJECTCOM@("userId")=$G(PATRXARR(FNBR17,IENS17,1,"I"))
 . S @REJECTCOM@("comments")=$G(PATRXARR(FNBR17,IENS17,2,"E"))
 . S @REJECTCOM@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR7_U_$P(IENS17,C,2)_U_FNBR17_U_+IENS17)
 ;
 N IENS10 S IENS10=""
 F  S IENS10=$O(PATRXARR(FNBR10,IENS10)) QUIT:IENS10=""  D
 . N PARTIAL S PARTIAL=$NA(PATRX("Patrx","partialDates","partialDate",+IENS10))
 . S @PARTIAL@("partialDate")=$G(PATRXARR(FNBR10,IENS10,.01,"E"))
 . S @PARTIAL@("partialDateFM")=$G(PATRXARR(FNBR10,IENS10,.01,"I"))
 . S @PARTIAL@("partialDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR10,IENS10,.01,"I")))
 . S @PARTIAL@("partialDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR10,IENS10,.01,"I")))
 . S @PARTIAL@("mailWindow")=$G(PATRXARR(FNBR10,IENS10,.02,"E"))
 . S @PARTIAL@("mailWindowCd")=$G(PATRXARR(FNBR10,IENS10,.02,"I"))
 . S @PARTIAL@("remarks")=$G(PATRXARR(FNBR10,IENS10,.03,"E"))
 . S @PARTIAL@("qty")=$G(PATRXARR(FNBR10,IENS10,.04,"E"))
 . S @PARTIAL@("daysSupply")=$G(PATRXARR(FNBR10,IENS10,.041,"E"))
 . S @PARTIAL@("currentUnitPriceOfDrug")=$G(PATRXARR(FNBR10,IENS10,.042,"E"))
 . S @PARTIAL@("pharmacistName")=$G(PATRXARR(FNBR10,IENS10,.05,"E"))
 . S @PARTIAL@("pharmacistNameId")=$G(PATRXARR(FNBR10,IENS10,.05,"I"))
 . S @PARTIAL@("pharmacistNameResId")=$$RESID^SYNDHP69("V",SITE,200,@PARTIAL@("pharmacistNameId"))
 . S @PARTIAL@("lot")=$G(PATRXARR(FNBR10,IENS10,.06,"E"))
 . S @PARTIAL@("clerkCode")=$G(PATRXARR(FNBR10,IENS10,.07,"E"))
 . S @PARTIAL@("clerkCodeId")=$G(PATRXARR(FNBR10,IENS10,.07,"I"))
 . S @PARTIAL@("loginDate")=$G(PATRXARR(FNBR10,IENS10,.08,"E"))
 . S @PARTIAL@("loginDateFM")=$G(PATRXARR(FNBR10,IENS10,.08,"I"))
 . S @PARTIAL@("loginDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR10,IENS10,.08,"I")))
 . S @PARTIAL@("loginDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR10,IENS10,.08,"I")))
 . S @PARTIAL@("division")=$G(PATRXARR(FNBR10,IENS10,.09,"E"))
 . S @PARTIAL@("divisionId")=$G(PATRXARR(FNBR10,IENS10,.09,"I"))
 . S @PARTIAL@("ndc")=$G(PATRXARR(FNBR10,IENS10,1,"E"))
 . S @PARTIAL@("manufacturer")=$G(PATRXARR(FNBR10,IENS10,2,"E"))
 . S @PARTIAL@("returnedToStock")=$G(PATRXARR(FNBR10,IENS10,5,"E"))
 . S @PARTIAL@("returnedToStockFM")=$G(PATRXARR(FNBR10,IENS10,5,"I"))
 . S @PARTIAL@("returnedToStockHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR10,IENS10,5,"I")))
 . S @PARTIAL@("returnedToStockFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR10,IENS10,5,"I")))
 . S @PARTIAL@("provider")=$G(PATRXARR(FNBR10,IENS10,6,"E"))
 . S @PARTIAL@("providerId")=$G(PATRXARR(FNBR10,IENS10,6,"I"))
 . S @PARTIAL@("providerNPI")=$$GET1^DIQ(200,@PARTIAL@("providerId")_",",41.99) ;NPI
 . S @PARTIAL@("providerResId")=$$RESID^SYNDHP69("V",SITE,200,@PARTIAL@("providerId"))
 . S @PARTIAL@("genericProvider")=$G(PATRXARR(FNBR10,IENS10,7,"E"))
 . S @PARTIAL@("dispensedDate")=$G(PATRXARR(FNBR10,IENS10,7.5,"E"))
 . S @PARTIAL@("dispensedDateFM")=$G(PATRXARR(FNBR10,IENS10,7.5,"I"))
 . S @PARTIAL@("dispensedDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR10,IENS10,7.5,"I")))
 . S @PARTIAL@("dispensedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR10,IENS10,7.5,"I")))
 . S @PARTIAL@("releasedDateTime")=$G(PATRXARR(FNBR10,IENS10,8,"E"))
 . S @PARTIAL@("releasedDateTimeFM")=$G(PATRXARR(FNBR10,IENS10,8,"I"))
 . S @PARTIAL@("releasedDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR10,IENS10,8,"I")))
 . S @PARTIAL@("releasedDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR10,IENS10,8,"I")))
 . S @PARTIAL@("bingoWaitTime")=$G(PATRXARR(FNBR10,IENS10,9,"E"))
 . S @PARTIAL@("fillingPerson")=$G(PATRXARR(FNBR10,IENS10,10,"E"))
 . S @PARTIAL@("fillingPersonId")=$G(PATRXARR(FNBR10,IENS10,10,"I"))
 . S @PARTIAL@("fillingPersonResId")=$$RESID^SYNDHP69("V",SITE,200,@PARTIAL@("fillingPersonId"))
 . S @PARTIAL@("checkingPharmacist")=$G(PATRXARR(FNBR10,IENS10,11,"E"))
 . S @PARTIAL@("checkingPharmacistId")=$G(PATRXARR(FNBR10,IENS10,11,"I"))
 . S @PARTIAL@("checkingPharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,@PARTIAL@("checkingPharmacistId"))
 . S @PARTIAL@("drugExpirationDate")=$G(PATRXARR(FNBR10,IENS10,12,"E"))
 . S @PARTIAL@("drugExpirationDateFM")=$G(PATRXARR(FNBR10,IENS10,12,"I"))
 . S @PARTIAL@("drugExpirationDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR10,IENS10,12,"I")))
 . S @PARTIAL@("drugExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR10,IENS10,12,"I")))
 . S @PARTIAL@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR10_U_+IENS10)
 ;
 N IENS11 S IENS11=""
 F  S IENS11=$O(PATRXARR(FNBR11,IENS11)) QUIT:IENS11=""  D
 . N RETURN S RETURN=$NA(PATRX("Patrx","returnToStockLogs","returnToStockLog",+IENS11))
 . S @RETURN@("returnToStockDateTime")=$G(PATRXARR(FNBR11,IENS11,.01,"E"))
 . S @RETURN@("returnToStockDateTimeFM")=$G(PATRXARR(FNBR11,IENS11,.01,"I"))
 . S @RETURN@("returnToStockDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,.01,"I")))
 . S @RETURN@("returnToStockDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,.01,"I")))
 . S @RETURN@("fillNumber")=$G(PATRXARR(FNBR11,IENS11,1,"E"))
 . S @RETURN@("fillDate")=$G(PATRXARR(FNBR11,IENS11,2,"E"))
 . S @RETURN@("fillDateFM")=$G(PATRXARR(FNBR11,IENS11,2,"I"))
 . S @RETURN@("fillDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,2,"I")))
 . S @RETURN@("fillDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,2,"I")))
 . S @RETURN@("quantity")=$G(PATRXARR(FNBR11,IENS11,3,"E"))
 . S @RETURN@("daysSupply")=$G(PATRXARR(FNBR11,IENS11,4,"E"))
 . S @RETURN@("unitPriceOfDrug")=$G(PATRXARR(FNBR11,IENS11,5,"E"))
 . S @RETURN@("mailWindow")=$G(PATRXARR(FNBR11,IENS11,6,"E"))
 . S @RETURN@("mailWindowCd")=$G(PATRXARR(FNBR11,IENS11,6,"I"))
 . S @RETURN@("remarks")=$G(PATRXARR(FNBR11,IENS11,7,"E"))
 . S @RETURN@("pharmacist")=$G(PATRXARR(FNBR11,IENS11,8,"E"))
 . S @RETURN@("pharmacistId")=$G(PATRXARR(FNBR11,IENS11,8,"I"))
 . S @RETURN@("pharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,@RETURN@("pharmacistId"))
 . S @RETURN@("lot")=$G(PATRXARR(FNBR11,IENS11,9,"E"))
 . S @RETURN@("clerk")=$G(PATRXARR(FNBR11,IENS11,10,"E"))
 . S @RETURN@("clerkId")=$G(PATRXARR(FNBR11,IENS11,10,"I"))
 . S @RETURN@("clerkResId")=$$RESID^SYNDHP69("V",SITE,200,@RETURN@("clerkId"))
 . S @RETURN@("loginDate")=$G(PATRXARR(FNBR11,IENS11,11,"E"))
 . S @RETURN@("loginDateFM")=$G(PATRXARR(FNBR11,IENS11,11,"I"))
 . S @RETURN@("loginDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,11,"I")))
 . S @RETURN@("loginDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,11,"I")))
 . S @RETURN@("division")=$G(PATRXARR(FNBR11,IENS11,12,"E"))
 . S @RETURN@("divisionId")=$G(PATRXARR(FNBR11,IENS11,12,"I"))
 . S @RETURN@("ibNumber")=$G(PATRXARR(FNBR11,IENS11,13,"E"))
 . S @RETURN@("ibNumberId")=$G(PATRXARR(FNBR11,IENS11,13,"I"))
 . S @RETURN@("copayExceedingCap")=$G(PATRXARR(FNBR11,IENS11,14,"E"))
 . S @RETURN@("copayExceedingCapId")=$G(PATRXARR(FNBR11,IENS11,14,"I"))
 . S @RETURN@("dispensedDate")=$G(PATRXARR(FNBR11,IENS11,15,"E"))
 . S @RETURN@("dispensedDateFM")=$G(PATRXARR(FNBR11,IENS11,15,"I"))
 . S @RETURN@("dispensedDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,15,"I")))
 . S @RETURN@("dispensedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,15,"I")))
 . S @RETURN@("ndc")=$G(PATRXARR(FNBR11,IENS11,16,"E"))
 . S @RETURN@("manufacturer")=$G(PATRXARR(FNBR11,IENS11,17,"E"))
 . S @RETURN@("drugExpirationDate")=$G(PATRXARR(FNBR11,IENS11,18,"E"))
 . S @RETURN@("drugExpirationDateFM")=$G(PATRXARR(FNBR11,IENS11,18,"I"))
 . S @RETURN@("drugExpirationDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,18,"I")))
 . S @RETURN@("drugExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,18,"I")))
 . S @RETURN@("provider")=$G(PATRXARR(FNBR11,IENS11,19,"E"))
 . S @RETURN@("providerId")=$G(PATRXARR(FNBR11,IENS11,19,"I"))
 . S @RETURN@("providerNPI")=$$GET1^DIQ(200,@RETURN@("providerId")_",",41.99) ;NPI
 . S @RETURN@("providerResId")=$$RESID^SYNDHP69("V",SITE,200,@RETURN@("providerId"))
 . S @RETURN@("administeredInClinic")=$G(PATRXARR(FNBR11,IENS11,20,"E"))
 . S @RETURN@("administeredInClinicCd")=$G(PATRXARR(FNBR11,IENS11,20,"I"))
 . S @RETURN@("releasedDateTime")=$G(PATRXARR(FNBR11,IENS11,21,"E"))
 . S @RETURN@("releasedDateTimeFM")=$G(PATRXARR(FNBR11,IENS11,21,"I"))
 . S @RETURN@("releasedDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,21,"I")))
 . S @RETURN@("releasedDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,21,"I")))
 . S @RETURN@("genericProvider")=$G(PATRXARR(FNBR11,IENS11,22,"E"))
 . S @RETURN@("bingoBoardWaitTime")=$G(PATRXARR(FNBR11,IENS11,23,"E"))
 . S @RETURN@("fillingPerson")=$G(PATRXARR(FNBR11,IENS11,24,"E"))
 . S @RETURN@("fillingPersonId")=$G(PATRXARR(FNBR11,IENS11,24,"I"))
 . S @RETURN@("checkingPharmacist")=$G(PATRXARR(FNBR11,IENS11,25,"E"))
 . S @RETURN@("checkingPharmacistId")=$G(PATRXARR(FNBR11,IENS11,25,"I"))
 . S @RETURN@("checkingPharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,@RETURN@("checkingPharmacistId"))
 . S @RETURN@("pfssAccountReference")=$G(PATRXARR(FNBR11,IENS11,26,"E"))
 . S @RETURN@("pfssAccountReferenceId")=$G(PATRXARR(FNBR11,IENS11,26,"I"))
 . S @RETURN@("pfssChargeId")=$G(PATRXARR(FNBR11,IENS11,27,"E"))
 . S @RETURN@("dawCode")=$G(PATRXARR(FNBR11,IENS11,28,"E"))
 . S @RETURN@("dateTimeNdcValidated")=$G(PATRXARR(FNBR11,IENS11,29,"E"))
 . S @RETURN@("dateTimeNdcValidatedFM")=$G(PATRXARR(FNBR11,IENS11,29,"I"))
 . S @RETURN@("dateTimeNdcValidatedHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,29,"I")))
 . S @RETURN@("dateTimeNdcValidatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,29,"I")))
 . S @RETURN@("ndcValidatedBy")=$G(PATRXARR(FNBR11,IENS11,30,"E"))
 . S @RETURN@("ndcValidatedById")=$G(PATRXARR(FNBR11,IENS11,30,"I"))
 . S @RETURN@("billingEligibilityIndicator")=$G(PATRXARR(FNBR11,IENS11,31,"E"))
 . S @RETURN@("billingEligibilityIndicatorCd")=$G(PATRXARR(FNBR11,IENS11,31,"I"))
 . S @RETURN@("epharmacySuspenseHoldDate")=$G(PATRXARR(FNBR11,IENS11,32,"E"))
 . S @RETURN@("epharmacySuspenseHoldDateFM")=$G(PATRXARR(FNBR11,IENS11,32,"I"))
 . S @RETURN@("epharmacySuspenseHoldDateHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR11,IENS11,32,"I")))
 . S @RETURN@("epharmacySuspenseHoldDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR11,IENS11,32,"I")))
 . S @RETURN@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR11_U_+IENS11)
 ;
 ;
 QUIT
 ;

SYNDHP28D
SYNDHP28D ; HC/art - HealthConcourse - continuation of get Patient Prescription data ;08/19/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
RXCONT4 ; continuation of GET1PATRX^SYNDHP28 - get Patient Prescription data
 ;
 N IENS12 S IENS12=""
 F  S IENS12=$O(PATRXARR(FNBR12,IENS12)) QUIT:IENS12=""  D
 . N COPAY S COPAY=$NA(PATRX("Patrx","copayActivityLogs","copayActivityLog",+IENS12))
 . S @COPAY@("copayActivityLog")=$G(PATRXARR(FNBR12,IENS12,.01,"E"))
 . S @COPAY@("copayActivityLogFM")=$G(PATRXARR(FNBR12,IENS12,.01,"I"))
 . S @COPAY@("copayActivityLogHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR12,IENS12,.01,"I")))
 . S @COPAY@("copayActivityLogFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR12,IENS12,.01,"I")))
 . S @COPAY@("reason")=$G(PATRXARR(FNBR12,IENS12,1,"E"))
 . S @COPAY@("reasonCd")=$G(PATRXARR(FNBR12,IENS12,1,"I"))
 . S @COPAY@("initiatorOfCopayActivity")=$G(PATRXARR(FNBR12,IENS12,2,"E"))
 . S @COPAY@("initiatorOfCopayActivityId")=$G(PATRXARR(FNBR12,IENS12,2,"I"))
 . S @COPAY@("rxReference")=$G(PATRXARR(FNBR12,IENS12,3,"E"))
 . S @COPAY@("comment")=$G(PATRXARR(FNBR12,IENS12,4,"E"))
 . S @COPAY@("oldValue")=$G(PATRXARR(FNBR12,IENS12,5,"E"))
 . S @COPAY@("newValue")=$G(PATRXARR(FNBR12,IENS12,6,"E"))
 . S @COPAY@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR12_U_+IENS12)
 ;
 N IENS13 S IENS13=""
 F  S IENS13=$O(PATRXARR(FNBR13,IENS13)) QUIT:IENS13=""  D
 . N INSTRUCT S INSTRUCT=$NA(PATRX("Patrx","medicationInstructionss","medicationInstructions",+IENS13))
 . S @INSTRUCT@("dosageOrdered")=$G(PATRXARR(FNBR13,IENS13,.01,"E"))
 . S @INSTRUCT@("dispenseUnitsPerDose")=$G(PATRXARR(FNBR13,IENS13,1,"E"))
 . S @INSTRUCT@("units")=$G(PATRXARR(FNBR13,IENS13,2,"E"))
 . S @INSTRUCT@("unitsId")=$G(PATRXARR(FNBR13,IENS13,2,"I"))
 . S @INSTRUCT@("noun")=$G(PATRXARR(FNBR13,IENS13,3,"E"))
 . S @INSTRUCT@("duration")=$G(PATRXARR(FNBR13,IENS13,4,"E"))
 . S @INSTRUCT@("conjunction")=$G(PATRXARR(FNBR13,IENS13,5,"E"))
 . S @INSTRUCT@("conjunctionCd")=$G(PATRXARR(FNBR13,IENS13,5,"I"))
 . S @INSTRUCT@("route")=$G(PATRXARR(FNBR13,IENS13,6,"E"))
 . S @INSTRUCT@("routeId")=$G(PATRXARR(FNBR13,IENS13,6,"I"))
 . S @INSTRUCT@("schedule")=$G(PATRXARR(FNBR13,IENS13,7,"E"))
 . S @INSTRUCT@("verb")=$G(PATRXARR(FNBR13,IENS13,8,"E"))
 . S @INSTRUCT@("otherLanguageDosage")=$G(PATRXARR(FNBR13,IENS13,9,"E"))
 . S @INSTRUCT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR13_U_+IENS13)
 ;
 N IENS14 S IENS14=""
 F  S IENS14=$O(PATRXARR(FNBR14,IENS14)) QUIT:IENS14=""  D
 . N CMOP S CMOP=$NA(PATRX("Patrx","cmopEvents","cmopEvent",+IENS14))
 . S @CMOP@("transmissionNumber")=$G(PATRXARR(FNBR14,IENS14,.01,"E"))
 . S @CMOP@("transmissionNumberId")=$G(PATRXARR(FNBR14,IENS14,.01,"I"))
 . S @CMOP@("sequence")=$G(PATRXARR(FNBR14,IENS14,1,"E"))
 . S @CMOP@("rxIndicator")=$G(PATRXARR(FNBR14,IENS14,2,"E"))
 . S @CMOP@("status")=$G(PATRXARR(FNBR14,IENS14,3,"E"))
 . S @CMOP@("statusCd")=$G(PATRXARR(FNBR14,IENS14,3,"I"))
 . S @CMOP@("ndcReceived")=$G(PATRXARR(FNBR14,IENS14,4,"E"))
 . S @CMOP@("cancelledDateTime")=$G(PATRXARR(FNBR14,IENS14,5,"E"))
 . S @CMOP@("cancelledDateTimeFM")=$G(PATRXARR(FNBR14,IENS14,5,"I"))
 . S @CMOP@("cancelledDateTimeHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR14,IENS14,5,"I")))
 . S @CMOP@("cancelledDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR14,IENS14,5,"I")))
 . S @CMOP@("resubmitStatus")=$G(PATRXARR(FNBR14,IENS14,6,"E"))
 . S @CMOP@("resubmitStatusCd")=$G(PATRXARR(FNBR14,IENS14,6,"I"))
 . S @CMOP@("cancelledReason")=$G(PATRXARR(FNBR14,IENS14,8,"E"))
 . S @CMOP@("dateShipped")=$G(PATRXARR(FNBR14,IENS14,9,"E"))
 . S @CMOP@("dateShippedFM")=$G(PATRXARR(FNBR14,IENS14,9,"I"))
 . S @CMOP@("dateShippedHL7")=$$FMTHL7^XLFDT($G(PATRXARR(FNBR14,IENS14,9,"I")))
 . S @CMOP@("dateShippedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATRXARR(FNBR14,IENS14,9,"I")))
 . S @CMOP@("carrier")=$G(PATRXARR(FNBR14,IENS14,10,"E"))
 . S @CMOP@("packageId")=$G(PATRXARR(FNBR14,IENS14,11,"E"))
 . S @CMOP@("ndcSent")=$G(PATRXARR(FNBR14,IENS14,12,"E"))
 . S @CMOP@("fdaMedGuideFilename")=$G(PATRXARR(FNBR14,IENS14,35,"E"))
 . S @CMOP@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR14_U_+IENS14)
 ;
 N IENS15 S IENS15=""
 F  S IENS15=$O(PATRXARR(FNBR15,IENS15)) QUIT:IENS15=""  D
 . N ICD S ICD=$NA(PATRX("Patrx","icdDiagnosiss","icdDiagnosis",+IENS15))
 . S @ICD@("icdDiagnosis")=$G(PATRXARR(FNBR15,IENS15,.01,"E"))
 . S @ICD@("icdDiagnosisId")=$G(PATRXARR(FNBR15,IENS15,.01,"I"))
 . S @ICD@("icdDiagnosisDesc")=""
 . I @ICD@("icdDiagnosis")'="" S @ICD@("icdDiagnosisDesc")=$P($$ICDDX^ICDEX(@ICD@("icdDiagnosis")),U,4)
 . S @ICD@("agentOrange")=$G(PATRXARR(FNBR15,IENS15,1,"E"))
 . S @ICD@("agentOrangeCd")=$G(PATRXARR(FNBR15,IENS15,1,"I"))
 . S @ICD@("ionizingRadiation")=$G(PATRXARR(FNBR15,IENS15,2,"E"))
 . S @ICD@("ionizingRadiationCd")=$G(PATRXARR(FNBR15,IENS15,2,"I"))
 . S @ICD@("serviceConnection")=$G(PATRXARR(FNBR15,IENS15,3,"E"))
 . S @ICD@("serviceConnectionCd")=$G(PATRXARR(FNBR15,IENS15,3,"I"))
 . S @ICD@("southwestAsiaConditions")=$G(PATRXARR(FNBR15,IENS15,4,"E"))
 . S @ICD@("southwestAsiaConditionsCd")=$G(PATRXARR(FNBR15,IENS15,4,"I"))
 . S @ICD@("militarySexualTrauma")=$G(PATRXARR(FNBR15,IENS15,5,"E"))
 . S @ICD@("militarySexualTraumaCd")=$G(PATRXARR(FNBR15,IENS15,5,"I"))
 . S @ICD@("headAndOrNeckCancer")=$G(PATRXARR(FNBR15,IENS15,6,"E"))
 . S @ICD@("headAndOrNeckCancerCd")=$G(PATRXARR(FNBR15,IENS15,6,"I"))
 . S @ICD@("combatVeteran")=$G(PATRXARR(FNBR15,IENS15,7,"E"))
 . S @ICD@("combatVeteranCd")=$G(PATRXARR(FNBR15,IENS15,7,"I"))
 . S @ICD@("proj112Shad")=$G(PATRXARR(FNBR15,IENS15,8,"E"))
 . S @ICD@("proj112ShadCd")=$G(PATRXARR(FNBR15,IENS15,8,"I"))
 . S @ICD@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PATRXIEN,FNBR15_U_+IENS15)
 .;
 . ;get SCT code
 . S @ICD@("icdDiagnosisSCT")=""
 . I @ICD@("icdDiagnosis")'="" D
 . . N MAPPING S MAPPING=$S(PATRX("Patrx","issueDateFM")>3150930:"sct2icd",1:"sct2icdnine")
 . . N SNOMED S SNOMED=$$MAP^SYNDHPMP(MAPPING,@ICD@("icdDiagnosis"),"I")
 . . S @ICD@("icdDiagnosisSCT")=$S(+SNOMED=-1:"",1:$P(SNOMED,U,2))
 ;
 QUIT
 ;

SYNDHP29
SYNDHP29 ; HC/art - HealthConcourse - get radiology report record ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1RADRPT(RADRPT,RADRPTIEN,RETJSON,RADRPTJ) ;get one Patient Radiology Report record
 ;inputs: RADRPTIEN - Patient Radiology Report IEN
 ;        RETJSON - J = Return JSON
 ;output: RADRPT  - array of Patient Radiology Report data, by reference
 ;        RADRPTJ - JSON structure of Patient Radiology Report data, by reference
 ;
 I $G(DEBUG) W !,"----------------------- Patient Radiology Report -------------------------",!
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=74 ;RAD/NUC MED REPORTS
 N FNBR2 S FNBR2=74.05 ;OTHER CASE#
 N FNBR3 S FNBR3=74.01 ;ACTIVITY LOG
 N FNBR4 S FNBR4=74.06 ;ERROR REPORTS
 N FNBR5 S FNBR5=74.02005 ;IMAGE
 N FNBR6 S FNBR6=74.16 ;BEFORE DELETION SEC. DX CODE
 N FNBR7 S FNBR7=74.18 ;BEFORE DELETION SEC. STAFF
 N FNBR8 S FNBR8=74.19 ;BEFORE DELETION SEC. RESIDENT
 N IENS1 S IENS1=RADRPTIEN_","
 ;
 N RADRPTARR,RADRPTERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","RADRPTARR","RADRPTERR")
 I $G(DEBUG) W !,$$ZW^SYNDHPUTL("RADRPTARR")
 I $G(DEBUG),$D(RADRPTERR) W !,">>ERROR<<" W !,$$ZW^SYNDHPUTL("RADRPTERR")
 I $D(RADRPTERR) D  QUIT
 . S RADRPT("Radrpt","ERROR")=RADRPTIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.RADRPT,.RADRPTJ)
 S RADRPT("Radrpt","radrptIen")=RADRPTIEN
 S RADRPT("Radrpt","resourceType")="RadiologyReport"
 S RADRPT("Radrpt","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN)
 S RADRPT("Radrpt","dayCase")=$G(RADRPTARR(FNBR1,IENS1,.01,"E"))
 S RADRPT("Radrpt","patientName")=$G(RADRPTARR(FNBR1,IENS1,2,"E"))
 S RADRPT("Radrpt","patientNameId")=$G(RADRPTARR(FNBR1,IENS1,2,"I"))
 S RADRPT("Radrpt","patientICN")=$$GET1^DIQ(2,RADRPT("Radrpt","patientNameId")_",",991.1)
 S RADRPT("Radrpt","examDateTime")=$G(RADRPTARR(FNBR1,IENS1,3,"E"))
 S RADRPT("Radrpt","examDateTimeFM")=$G(RADRPTARR(FNBR1,IENS1,3,"I"))
 S RADRPT("Radrpt","examDateTimeHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,3,"I")))
 S RADRPT("Radrpt","examDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,3,"I")))
 S RADRPT("Radrpt","caseNumber")=$G(RADRPTARR(FNBR1,IENS1,4,"E"))
 S RADRPT("Radrpt","reportStatus")=$G(RADRPTARR(FNBR1,IENS1,5,"E"))
 S RADRPT("Radrpt","reportStatusCd")=$G(RADRPTARR(FNBR1,IENS1,5,"I"))
 S RADRPT("Radrpt","dateReportEntered")=$G(RADRPTARR(FNBR1,IENS1,6,"E"))
 S RADRPT("Radrpt","dateReportEnteredFM")=$G(RADRPTARR(FNBR1,IENS1,6,"I"))
 S RADRPT("Radrpt","dateReportEnteredHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,6,"I")))
 S RADRPT("Radrpt","dateReportEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,6,"I")))
 S RADRPT("Radrpt","verifiedDate")=$G(RADRPTARR(FNBR1,IENS1,7,"E"))
 S RADRPT("Radrpt","verifiedDateFM")=$G(RADRPTARR(FNBR1,IENS1,7,"I"))
 S RADRPT("Radrpt","verifiedDateHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,7,"I")))
 S RADRPT("Radrpt","verifiedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,7,"I")))
 S RADRPT("Radrpt","reportedDate")=$G(RADRPTARR(FNBR1,IENS1,8,"E"))
 S RADRPT("Radrpt","reportedDateFM")=$G(RADRPTARR(FNBR1,IENS1,8,"I"))
 S RADRPT("Radrpt","reportedDateHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,8,"I")))
 S RADRPT("Radrpt","reportedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,8,"I")))
 S RADRPT("Radrpt","verifyingPhysician")=$G(RADRPTARR(FNBR1,IENS1,9,"E"))
 S RADRPT("Radrpt","verifyingPhysicianId")=$G(RADRPTARR(FNBR1,IENS1,9,"I"))
 S RADRPT("Radrpt","verifyingPhysicianNPI")=$$GET1^DIQ(200,RADRPT("Radrpt","verifyingPhysicianId")_",",41.99) ;NPI
 S RADRPT("Radrpt","verifyingPhysicianResId")=$$RESID^SYNDHP69("V",SITE,200,RADRPT("Radrpt","verifyingPhysicianId"))
 S RADRPT("Radrpt","teleradiologyPhysicianName")=$G(RADRPTARR(FNBR1,IENS1,9.1,"E"))
 S RADRPT("Radrpt","teleradiologyPhysicianNPI")=$G(RADRPTARR(FNBR1,IENS1,9.2,"E"))
 S RADRPT("Radrpt","reportVerifiedByCotsApp")=$G(RADRPTARR(FNBR1,IENS1,9.3,"E"))
 S RADRPT("Radrpt","reportVerifiedByCotsAppId")=$G(RADRPTARR(FNBR1,IENS1,9.3,"I"))
 ;S RADRPT("Radrpt","electronicSignatureCodeId")=$G(RADRPTARR(FNBR1,IENS1,10,"I"))
 S RADRPT("Radrpt","electronicSignatureCode")=$G(RADRPTARR(FNBR1,IENS1,10,"E"))
 S RADRPT("Radrpt","transcriptionist")=$G(RADRPTARR(FNBR1,IENS1,11,"E"))
 S RADRPT("Radrpt","transcriptionistId")=$G(RADRPTARR(FNBR1,IENS1,11,"I"))
 S RADRPT("Radrpt","transcriptionistNPI")=$$GET1^DIQ(200,RADRPT("Radrpt","transcriptionistId")_",",41.99) ;NPI
 S RADRPT("Radrpt","transcriptionistResId")=$$RESID^SYNDHP69("V",SITE,200,RADRPT("Radrpt","transcriptionistId"))
 S RADRPT("Radrpt","dateReportPrinted")=$G(RADRPTARR(FNBR1,IENS1,13,"E"))
 S RADRPT("Radrpt","dateReportPrintedFM")=$G(RADRPTARR(FNBR1,IENS1,13,"I"))
 S RADRPT("Radrpt","dateReportPrintedHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,13,"I")))
 S RADRPT("Radrpt","dateReportPrintedFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,13,"I")))
 S RADRPT("Radrpt","preVerificationDateTime")=$G(RADRPTARR(FNBR1,IENS1,14,"E"))
 S RADRPT("Radrpt","preVerificationDateTimeFM")=$G(RADRPTARR(FNBR1,IENS1,14,"I"))
 S RADRPT("Radrpt","preVerificationDateTimeHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,14,"I")))
 S RADRPT("Radrpt","preVerificationDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,14,"I")))
 S RADRPT("Radrpt","preVerificationUser")=$G(RADRPTARR(FNBR1,IENS1,15,"E"))
 S RADRPT("Radrpt","preVerificationUserId")=$G(RADRPTARR(FNBR1,IENS1,15,"I"))
 S RADRPT("Radrpt","preVerificationUserResId")=$$RESID^SYNDHP69("V",SITE,200,RADRPT("Radrpt","preVerificationUserId"))
 S RADRPT("Radrpt","preVerificationESig")=$G(RADRPTARR(FNBR1,IENS1,16,"E"))
 S RADRPT("Radrpt","statusChangedToVerifiedBy")=$G(RADRPTARR(FNBR1,IENS1,17,"E"))
 S RADRPT("Radrpt","statusChangedToVerifiedById")=$G(RADRPTARR(FNBR1,IENS1,17,"I"))
 S RADRPT("Radrpt","dateInitialOutsideRptEntry")=$G(RADRPTARR(FNBR1,IENS1,18,"E"))
 S RADRPT("Radrpt","dateInitialOutsideRptEntryFM")=$G(RADRPTARR(FNBR1,IENS1,18,"I"))
 S RADRPT("Radrpt","dateInitialOutsideRptEntryHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,18,"I")))
 S RADRPT("Radrpt","dateInitialOutsideRptEntryFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,18,"I")))
 S RADRPT("Radrpt","problemStatement")=$G(RADRPTARR(FNBR1,IENS1,25,"E"))
 S RADRPT("Radrpt","purgedDate")=$G(RADRPTARR(FNBR1,IENS1,40,"E"))
 S RADRPT("Radrpt","purgedDateFM")=$G(RADRPTARR(FNBR1,IENS1,40,"I"))
 S RADRPT("Radrpt","purgedDateHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR1,IENS1,40,"I")))
 S RADRPT("Radrpt","purgedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR1,IENS1,40,"I")))
 S RADRPT("Radrpt","noPurgeIndicator")=$G(RADRPTARR(FNBR1,IENS1,45,"E"))
 S RADRPT("Radrpt","noPurgeIndicatorCd")=$G(RADRPTARR(FNBR1,IENS1,45,"I"))
 S RADRPT("Radrpt","hospitalDivisionC")=$G(RADRPTARR(FNBR1,IENS1,53,"E"))
 S RADRPT("Radrpt","imagingLocationC")=$G(RADRPTARR(FNBR1,IENS1,54,"E"))
 S RADRPT("Radrpt","interpretingImagingLocation")=$G(RADRPTARR(FNBR1,IENS1,86,"E"))
 S RADRPT("Radrpt","interpretingImagingLocationId")=$G(RADRPTARR(FNBR1,IENS1,86,"I"))
 S RADRPT("Radrpt","procedureC")=$G(RADRPTARR(FNBR1,IENS1,102,"E"))
 S RADRPT("Radrpt","examStatusC")=$G(RADRPTARR(FNBR1,IENS1,103,"E"))
 S RADRPT("Radrpt","categoryOfExamC")=$G(RADRPTARR(FNBR1,IENS1,104,"E"))
 S RADRPT("Radrpt","wardC")=$G(RADRPTARR(FNBR1,IENS1,106,"E"))
 S RADRPT("Radrpt","serviceC")=$G(RADRPTARR(FNBR1,IENS1,107,"E"))
 S RADRPT("Radrpt","principalClinicC")=$G(RADRPTARR(FNBR1,IENS1,108,"E"))
 S RADRPT("Radrpt","contractSharingSourceC")=$G(RADRPTARR(FNBR1,IENS1,109,"E"))
 S RADRPT("Radrpt","researchSourceC")=$G(RADRPTARR(FNBR1,IENS1,109.5,"E"))
 S RADRPT("Radrpt","primaryInterpretingResidentC")=$G(RADRPTARR(FNBR1,IENS1,112,"E"))
 S RADRPT("Radrpt","primaryDiagnosticCodeC")=$G(RADRPTARR(FNBR1,IENS1,113,"E"))
 S RADRPT("Radrpt","requestingPhysicianC")=$G(RADRPTARR(FNBR1,IENS1,114,"E"))
 S RADRPT("Radrpt","primaryInterpretingStaffC")=$G(RADRPTARR(FNBR1,IENS1,115,"E"))
 S RADRPT("Radrpt","complicationC")=$G(RADRPTARR(FNBR1,IENS1,116,"E"))
 S RADRPT("Radrpt","primaryCameraEquipRmC")=$G(RADRPTARR(FNBR1,IENS1,118,"E"))
 S RADRPT("Radrpt","bedsectionC")=$G(RADRPTARR(FNBR1,IENS1,119,"E"))
 ;
 S RADRPT("Radrpt","reportText")=""
 N Z S Z=""
 F  S Z=$O(RADRPTARR(FNBR1,IENS1,200,Z)) QUIT:'+Z  D
 . S RADRPT("Radrpt","reportText")=RADRPT("Radrpt","reportText")_$G(RADRPTARR(FNBR1,IENS1,200,Z))
 ;
 S RADRPT("Radrpt","impressionText")=""
 N Z S Z=""
 F  S Z=$O(RADRPTARR(FNBR1,IENS1,300,Z)) QUIT:'+Z  D
 . S RADRPT("Radrpt","impressionText")=RADRPT("Radrpt","impressionText")_$G(RADRPTARR(FNBR1,IENS1,300,Z))
 ;
 S RADRPT("Radrpt","additionalClinicalHistory")=""
 N Z S Z=""
 F  S Z=$O(RADRPTARR(FNBR1,IENS1,400,Z)) QUIT:'+Z  D
 . S RADRPT("Radrpt","additionalClinicalHistory")=RADRPT("Radrpt","additionalClinicalHistory")_$G(RADRPTARR(FNBR1,IENS1,400,Z))
 ;
 N IENS2 S IENS2=""
 F  S IENS2=$O(RADRPTARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N OTHER S OTHER=$NA(RADRPT("Radrpt","otherCases","otherCase",+IENS2))
 . S @OTHER@("otherCaseNbr")=$G(RADRPTARR(FNBR2,IENS2,.01,"E"))
 . S @OTHER@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN,FNBR2_U_+IENS2)
 ;
 N IENS3 S IENS3=""
 F  S IENS3=$O(RADRPTARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N ALOG S ALOG=$NA(RADRPT("Radrpt","activityLogs","activityLog",+IENS3))
 . S @ALOG@("logDate")=$G(RADRPTARR(FNBR3,IENS3,.01,"E"))
 . S @ALOG@("logDateFM")=$G(RADRPTARR(FNBR3,IENS3,.01,"I"))
 . S @ALOG@("logDateHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR3,IENS3,.01,"I")))
 . S @ALOG@("logDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR3,IENS3,.01,"I")))
 . S @ALOG@("typeOfAction")=$G(RADRPTARR(FNBR3,IENS3,2,"E"))
 . S @ALOG@("typeOfActionCd")=$G(RADRPTARR(FNBR3,IENS3,2,"I"))
 . S @ALOG@("computerUser")=$G(RADRPTARR(FNBR3,IENS3,3,"E"))
 . S @ALOG@("computerUserId")=$G(RADRPTARR(FNBR3,IENS3,3,"I"))
 . S @ALOG@("beforeDeletionReportStatus")=$G(RADRPTARR(FNBR3,IENS3,4,"E"))
 . S @ALOG@("beforeDeletionReportStatusCd")=$G(RADRPTARR(FNBR3,IENS3,4,"I"))
 . S @ALOG@("beforeDeletionPrimDxCode")=$G(RADRPTARR(FNBR3,IENS3,5,"E"))
 . S @ALOG@("beforeDeletionPrimDxCodeId")=$G(RADRPTARR(FNBR3,IENS3,5,"I"))
 . S @ALOG@("beforeDeletionSecDxCode")=$G(RADRPTARR(FNBR3,IENS3,6,"E"))
 . S @ALOG@("beforeDeletionPrimStaff")=$G(RADRPTARR(FNBR3,IENS3,7,"E"))
 . S @ALOG@("beforeDeletionPrimStaffId")=$G(RADRPTARR(FNBR3,IENS3,7,"I"))
 . S @ALOG@("beforeDeletionPrimStaffResId")=$$RESID^SYNDHP69("V",SITE,200,@ALOG@("beforeDeletionPrimStaffId"))
 . S @ALOG@("beforeDeletionSecStaff")=$G(RADRPTARR(FNBR3,IENS3,8,"E"))
 . S @ALOG@("beforeDeletionPrimResident")=$G(RADRPTARR(FNBR3,IENS3,9,"E"))
 . S @ALOG@("beforeDeletionPrimResidentId")=$G(RADRPTARR(FNBR3,IENS3,9,"I"))
 . S @ALOG@("beforeDeletionPrimResidentResId")=$$RESID^SYNDHP69("V",SITE,200,@ALOG@("beforeDeletionPrimResidentId"))
 . S @ALOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN,FNBR3_U_+IENS3)
 ;
 N IENS4 S IENS4=""
 F  S IENS4=$O(RADRPTARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N ERRRPT S ERRRPT=$NA(RADRPT("Radrpt","errorReportss","errorReports",+IENS4))
 . S @ERRRPT@("dateTimeOfRptSave")=$G(RADRPTARR(FNBR4,IENS4,.01,"E"))
 . S @ERRRPT@("dateTimeOfRptSaveFM")=$G(RADRPTARR(FNBR4,IENS4,.01,"I"))
 . S @ERRRPT@("dateTimeOfRptSaveHL7")=$$FMTHL7^XLFDT($G(RADRPTARR(FNBR4,IENS4,.01,"I")))
 . S @ERRRPT@("dateTimeOfRptSaveFHIR")=$$FMTFHIR^SYNDHPUTL($G(RADRPTARR(FNBR4,IENS4,.01,"I")))
 . S @ERRRPT@("erroneousReport")=""
 . N Z S Z=""
 . F  S Z=$O(RADRPTARR(FNBR4,IENS4,2,Z)) QUIT:'+Z  D
 . . S @ERRRPT@("erroneousReport")=@ERRRPT@("erroneousReport")_$$ESC^XLFJSON($G(RADRPTARR(FNBR4,IENS4,2,Z)))_"\n"
 . S @ERRRPT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN,FNBR4_U_+IENS4)
 ;
 N IENS5 S IENS5=""
 F  S IENS5=$O(RADRPTARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . N IMAGE S IMAGE=$NA(RADRPT("Radrpt","images","image",+IENS5))
 . S @IMAGE@("image")=$G(RADRPTARR(FNBR5,IENS5,.01,"E"))
 . S @IMAGE@("imageId")=$G(RADRPTARR(FNBR5,IENS5,.01,"I"))
 . S @IMAGE@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN,FNBR5_U_+IENS5)
 ;
 N IENS6 S IENS6=""
 F  S IENS6=$O(RADRPTARR(FNBR6,IENS6)) QUIT:IENS6=""  D
 . N DX S DX=$NA(RADRPT("Radrpt","activityLogs","activityLog",$P(IENS6,C,2),"beforeDeletionSecDxCodes","beforeDeletionSecDxCode",+IENS6))
 . S @DX@("beforeDeletionSecDxCode")=$G(RADRPTARR(FNBR6,IENS6,.01,"E"))
 . S @DX@("beforeDeletionSecDxCodeId")=$G(RADRPTARR(FNBR6,IENS6,.01,"I"))
 . S @DX@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN,FNBR3,$P(IENS6,C,2),FNBR6_U_+IENS6)
 ;
 N IENS7 S IENS7=""
 F  S IENS7=$O(RADRPTARR(FNBR7,IENS7)) QUIT:IENS7=""  D
 . N STAFF S STAFF=$NA(RADRPT("Radrpt","activityLogs","activityLog",$P(IENS7,C,2),"beforeDeletionSecStaffs","beforeDeletionSecStaff",+IENS7))
 . S @STAFF@("beforeDeletionSecStaff")=$G(RADRPTARR(FNBR7,IENS7,.01,"E"))
 . S @STAFF@("beforeDeletionSecStaffId")=$G(RADRPTARR(FNBR7,IENS7,.01,"I"))
 . S @STAFF@("beforeDeletionSecStaffResId")=$$RESID^SYNDHP69("V",SITE,200,@STAFF@("beforeDeletionSecStaffId"))
 . S @STAFF@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN,FNBR3,$P(IENS7,C,2),FNBR7_U_+IENS7)
 ;
 N IENS8 S IENS8=""
 F  S IENS8=$O(RADRPTARR(FNBR8,IENS8)) QUIT:IENS8=""  D
 . N RES S RES=$NA(RADRPT("Radrpt","activityLogs","activityLog",$P(IENS8,C,2),"beforeDeletionSecResidents","beforeDeletionSecResident",+IENS8))
 . S @RES@("beforeDeletionSecResident")=$G(RADRPTARR(FNBR8,IENS8,.01,"E"))
 . S @RES@("beforeDeletionSecResidentId")=$G(RADRPTARR(FNBR8,IENS8,.01,"I"))
 . S @RES@("beforeDeletionSecResidentResId")=$$RESID^SYNDHP69("V",SITE,200,@RES@("beforeDeletionSecResidentId"))
 . S @RES@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,RADRPTIEN,FNBR3,$P(IENS8,C,2),FNBR8_U_+IENS8)
 ;
 I $G(DEBUG) W !,$$ZW^SYNDHPUTL("RADRPT")
 ;
 I $G(RETJSON)="J" D
 . D TOJASON^SYNDHPUTL(.RADRPT,.RADRPTJ)
 . S RADRPTJ=$$UES^XLFJSON(RADRPTJ) ;change \\n to \n
 ;
 QUIT
 ;

SYNDHP30
SYNDHP30 ; HC/art - HealthConcourse - get Pharmacy Patient data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GETPHPAT(PHPAT,PHPATIEN,RETJSON,PHPATJ) ;get Pharmacy Patient record
 ;inputs: PHPATIEN - Pharmacy Patient IEN
 ;        RETJSON - J = Return JSON
 ;output: PHPAT  - array of Pharmacy Patient data, by reference
 ;        PHPATJ - JSON structure of Pharmacy Patient data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Pharmacy Patient -----------------------------",!
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=55 ;PHARMACY PATIENT
 N FNBR2 S FNBR2=55.03 ;PRESCRIPTION PROFILE
 N FNBR3 S FNBR3=55.05 ;NON-VA MEDS
 N FNBR4 S FNBR4=55.051 ;ORDER CHECKS
 N FNBR5 S FNBR5=55.06 ;UNIT DOSE
 N FNBR6 S FNBR6=55.07 ;DISPENSE DRUG
 N FNBR7 S FNBR7=55.09 ;ACTIVITY LOG
 N FNBR8 S FNBR8=55.0611 ;DISPENSE LOG
 N FNBR9 S FNBR9=55.6114 ;LAST RENEW
 N FNBR10 S FNBR10=55.6132 ;INTERVENTION
 N FNBR11 S FNBR11=55.01 ;IV
 N FNBR12 S FNBR12=55.02 ;ADDITIVE
 N FNBR13 S FNBR13=55.11 ;SOLUTION
 N FNBR14 S FNBR14=55.04 ;ACTIVITY LOG
 N FNBR16 S FNBR16=55.15 ;FIELD CHANGED
 N FNBR17 S FNBR17=55.1111 ;LABEL TRACKING
 N FNBR18 S FNBR18=55.1138 ;LAST RENEW
 N FNBR19 S FNBR19=55.1153 ;INTERVENTION
 N FNBR20 S FNBR20=55.13 ;ARCHIVE DATE
 N FNBR21 S FNBR21=55.14 ;RX LIST
 N FNBR22 S FNBR22=55.0105 ;BCMA ID
 N FNBR23 S FNBR23=55.1057 ;ADDITIVE
 N FNBR24 S FNBR24=55.1058 ;SOLUTION
 N FNBR25 S FNBR25=55.0108 ;SCRIPTALK ENROLLMENT ACTIVITY
 N IENS1 S IENS1=PHPATIEN_","
 ;
 N PHPATARR,PHPATERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","PHPATARR","PHPATERR")
 I $G(DEBUG) W !,$$ZW^SYNDHPUTL("PHPATARR")
 I $G(DEBUG),$D(PHPATERR) W !,">>ERROR<<" W !,$$ZW^SYNDHPUTL("PHPATERR")
 I $D(PHPATERR),PHPATERR("DIERR",1)=601 D  QUIT
 . S PHPAT("Phpat","ERROR")=PHPATIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PHPAT,.PHPATJ)
 S PHPAT("Phpat","phpatIen")=PHPATIEN
 S PHPAT("Phpat","resourceType")="Medication"
 S PHPAT("Phpat","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN)
 S PHPAT("Phpat","number")=$G(PHPATARR(FNBR1,IENS1,.001,"E"))
 S PHPAT("Phpat","name")=$G(PHPATARR(FNBR1,IENS1,.01,"E"))
 S PHPAT("Phpat","nameId")=$G(PHPATARR(FNBR1,IENS1,.01,"I"))
 S PHPAT("Phpat","nameICN")=$$GET1^DIQ(2,PHPAT("Phpat","nameId")_",",991.1)
 S PHPAT("Phpat","cap")=$G(PHPATARR(FNBR1,IENS1,.02,"E"))
 S PHPAT("Phpat","capCd")=$G(PHPATARR(FNBR1,IENS1,.02,"I"))
 S PHPAT("Phpat","mail")=$G(PHPATARR(FNBR1,IENS1,.03,"E"))
 S PHPAT("Phpat","mailCd")=$G(PHPATARR(FNBR1,IENS1,.03,"I"))
 S PHPAT("Phpat","dialysisPatient")=$G(PHPATARR(FNBR1,IENS1,.04,"E"))
 S PHPAT("Phpat","dialysisPatientCd")=$G(PHPATARR(FNBR1,IENS1,.04,"I"))
 S PHPAT("Phpat","mailStatusExpirationDate")=$G(PHPATARR(FNBR1,IENS1,.05,"E"))
 S PHPAT("Phpat","mailStatusExpirationDateFM")=$G(PHPATARR(FNBR1,IENS1,.05,"I"))
 S PHPAT("Phpat","mailStatusExpirationDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,.05,"I")))
 S PHPAT("Phpat","mailStatusExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,.05,"I")))
 S PHPAT("Phpat","firstServiceDate")=$G(PHPATARR(FNBR1,IENS1,.07,"E"))
 S PHPAT("Phpat","firstServiceDateFM")=$G(PHPATARR(FNBR1,IENS1,.07,"I"))
 S PHPAT("Phpat","firstServiceDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,.07,"I")))
 S PHPAT("Phpat","firstServiceDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,.07,"I")))
 S PHPAT("Phpat","actualHistoricalFlag")=$G(PHPATARR(FNBR1,IENS1,.08,"E"))
 S PHPAT("Phpat","actualHistoricalFlagCd")=$G(PHPATARR(FNBR1,IENS1,.08,"I"))
 S PHPAT("Phpat","narrative")=$G(PHPATARR(FNBR1,IENS1,1,"E"))
 S PHPAT("Phpat","patientStatus")=$G(PHPATARR(FNBR1,IENS1,3,"E"))
 S PHPAT("Phpat","patientStatusId")=$G(PHPATARR(FNBR1,IENS1,3,"I"))
 S PHPAT("Phpat","communityNursingHome")=$G(PHPATARR(FNBR1,IENS1,40,"E"))
 S PHPAT("Phpat","communityNursingHomeCd")=$G(PHPATARR(FNBR1,IENS1,40,"I"))
 S PHPAT("Phpat","nursingHomeContract")=$G(PHPATARR(FNBR1,IENS1,40.1,"E"))
 S PHPAT("Phpat","nursingHomeContractCd")=$G(PHPATARR(FNBR1,IENS1,40.1,"I"))
 S PHPAT("Phpat","lastDateOfContract")=$G(PHPATARR(FNBR1,IENS1,40.2,"E"))
 S PHPAT("Phpat","lastDateOfContractFM")=$G(PHPATARR(FNBR1,IENS1,40.2,"I"))
 S PHPAT("Phpat","lastDateOfContractHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,40.2,"I")))
 S PHPAT("Phpat","lastDateOfContractFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,40.2,"I")))
 S PHPAT("Phpat","respitePatientStartDate")=$G(PHPATARR(FNBR1,IENS1,41,"E"))
 S PHPAT("Phpat","respitePatientStartDateFM")=$G(PHPATARR(FNBR1,IENS1,41,"I"))
 S PHPAT("Phpat","respitePatientStartDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,41,"I")))
 S PHPAT("Phpat","respitePatientStartDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,41,"I")))
 S PHPAT("Phpat","respitePatientEndDate")=$G(PHPATARR(FNBR1,IENS1,41.1,"E"))
 S PHPAT("Phpat","respitePatientEndDateFM")=$G(PHPATARR(FNBR1,IENS1,41.1,"I"))
 S PHPAT("Phpat","respitePatientEndDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,41.1,"I")))
 S PHPAT("Phpat","respitePatientEndDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,41.1,"I")))
 S PHPAT("Phpat","activeScriptsC")=$G(PHPATARR(FNBR1,IENS1,50,"E"))
 S PHPAT("Phpat","rxUpdate")=$G(PHPATARR(FNBR1,IENS1,52.1,"E"))
 S PHPAT("Phpat","rxUpdateCd")=$G(PHPATARR(FNBR1,IENS1,52.1,"I"))
 S PHPAT("Phpat","clozapineRegistrationNumber")=$G(PHPATARR(FNBR1,IENS1,53,"E"))
 S PHPAT("Phpat","clozapineStatus")=$G(PHPATARR(FNBR1,IENS1,54,"E"))
 S PHPAT("Phpat","clozapineStatusCd")=$G(PHPATARR(FNBR1,IENS1,54,"I"))
 S PHPAT("Phpat","dateOfLastClozapineRx")=$G(PHPATARR(FNBR1,IENS1,55,"E"))
 S PHPAT("Phpat","dateOfLastClozapineRxFM")=$G(PHPATARR(FNBR1,IENS1,55,"I"))
 S PHPAT("Phpat","dateOfLastClozapineRxHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,55,"I")))
 S PHPAT("Phpat","dateOfLastClozapineRxFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,55,"I")))
 S PHPAT("Phpat","demographicsSent")=$G(PHPATARR(FNBR1,IENS1,56,"E"))
 S PHPAT("Phpat","demographicsSentCd")=$G(PHPATARR(FNBR1,IENS1,56,"I"))
 S PHPAT("Phpat","responsibleProvider")=$G(PHPATARR(FNBR1,IENS1,57,"E"))
 S PHPAT("Phpat","responsibleProviderId")=$G(PHPATARR(FNBR1,IENS1,57,"I"))
 S PHPAT("Phpat","responsibleProviderNPI")=$$GET1^DIQ(200,PHPAT("Phpat","responsibleProviderId")_",",41.99) ;NPI
 S PHPAT("Phpat","responsibleProviderResId")=$$RESID^SYNDHP69("V",SITE,200,PHPAT("Phpat","responsibleProviderId"))
 S PHPAT("Phpat","registrationDate")=$G(PHPATARR(FNBR1,IENS1,58,"E"))
 S PHPAT("Phpat","registrationDateFM")=$G(PHPATARR(FNBR1,IENS1,58,"I"))
 S PHPAT("Phpat","registrationDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,58,"I")))
 S PHPAT("Phpat","registrationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,58,"I")))
 S PHPAT("Phpat","udDefaultStopDateTime")=$G(PHPATARR(FNBR1,IENS1,62.01,"E"))
 S PHPAT("Phpat","udDefaultStopDateTimeFM")=$G(PHPATARR(FNBR1,IENS1,62.01,"I"))
 S PHPAT("Phpat","udDefaultStopDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,62.01,"I")))
 S PHPAT("Phpat","udDefaultStopDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,62.01,"I")))
 S PHPAT("Phpat","udProvider")=$G(PHPATARR(FNBR1,IENS1,62.02,"E"))
 S PHPAT("Phpat","udProviderId")=$G(PHPATARR(FNBR1,IENS1,62.02,"I"))
 S PHPAT("Phpat","udProviderNPI")=$$GET1^DIQ(200,PHPAT("Phpat","udProviderId")_",",41.99) ;NPI
 S PHPAT("Phpat","udLastAdmissionDate")=$G(PHPATARR(FNBR1,IENS1,62.03,"E"))
 S PHPAT("Phpat","udLastAdmissionDateFM")=$G(PHPATARR(FNBR1,IENS1,62.03,"I"))
 S PHPAT("Phpat","udLastAdmissionDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,62.03,"I")))
 S PHPAT("Phpat","udLastAdmissionDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,62.03,"I")))
 S PHPAT("Phpat","udLastTransferDate")=$G(PHPATARR(FNBR1,IENS1,62.04,"E"))
 S PHPAT("Phpat","udLastTransferDateFM")=$G(PHPATARR(FNBR1,IENS1,62.04,"I"))
 S PHPAT("Phpat","udLastTransferDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,62.04,"I")))
 S PHPAT("Phpat","udLastTransferDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,62.04,"I")))
 S PHPAT("Phpat","udLastDischargeDate")=$G(PHPATARR(FNBR1,IENS1,62.05,"E"))
 S PHPAT("Phpat","udLastDischargeDateFM")=$G(PHPATARR(FNBR1,IENS1,62.05,"I"))
 S PHPAT("Phpat","udLastDischargeDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,62.05,"I")))
 S PHPAT("Phpat","udLastDischargeDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,62.05,"I")))
 S PHPAT("Phpat","udExpUpDate")=$G(PHPATARR(FNBR1,IENS1,62.06,"E"))
 S PHPAT("Phpat","udExpUpDateFM")=$G(PHPATARR(FNBR1,IENS1,62.06,"I"))
 S PHPAT("Phpat","udExpUpDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR1,IENS1,62.06,"I")))
 S PHPAT("Phpat","udExpUpDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR1,IENS1,62.06,"I")))
 S PHPAT("Phpat","udHoldFlag")=$G(PHPATARR(FNBR1,IENS1,62.07,"E"))
 S PHPAT("Phpat","udHoldFlagCd")=$G(PHPATARR(FNBR1,IENS1,62.07,"I"))
 S PHPAT("Phpat","udDischargeFlag")=$G(PHPATARR(FNBR1,IENS1,62.08,"E"))
 S PHPAT("Phpat","udDischargeFlagCd")=$G(PHPATARR(FNBR1,IENS1,62.08,"I"))
 S PHPAT("Phpat","comments")=""
 N Z S Z=""
 F  S Z=$O(PHPATARR(FNBR1,IENS1,62.1,Z)) QUIT:'+Z  D
 . S PHPAT("Phpat","comments")=PHPAT("Phpat","comments")_$G(PHPATARR(FNBR1,IENS1,62.1,Z))
 S PHPAT("Phpat","holdReason")=$G(PHPATARR(FNBR1,IENS1,62.11,"E"))
 S PHPAT("Phpat","inpatientNarrative")=$G(PHPATARR(FNBR1,IENS1,62.2,"E"))
 S PHPAT("Phpat","ConversionCompleted")=$G(PHPATARR(FNBR1,IENS1,104,"E"))
 S PHPAT("Phpat","ConversionCompletedCd")=$G(PHPATARR(FNBR1,IENS1,104,"I"))
 S PHPAT("Phpat","otherLanguagePreference")=$G(PHPATARR(FNBR1,IENS1,106,"E"))
 S PHPAT("Phpat","otherLanguagePreferenceCd")=$G(PHPATARR(FNBR1,IENS1,106,"I"))
 S PHPAT("Phpat","pmiLanguagePreference")=$G(PHPATARR(FNBR1,IENS1,106.1,"E"))
 S PHPAT("Phpat","pmiLanguagePreferenceCd")=$G(PHPATARR(FNBR1,IENS1,106.1,"I"))
 ;
 N IENS2 S IENS2=""
 F  S IENS2=$O(PHPATARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N RXPROF S RXPROF=$NA(PHPAT("Phpat","prescriptionProfiles","prescriptionProfile",+IENS2))
 . S @RXPROF@("prescriptionProfile")=$G(PHPATARR(FNBR2,IENS2,.01,"E"))
 . S @RXPROF@("prescriptionProfileId")=$G(PHPATARR(FNBR2,IENS2,.01,"I"))
 . S @RXPROF@("drugC")=$G(PHPATARR(FNBR2,IENS2,1,"E"))
 . S @RXPROF@("statusC")=$G(PHPATARR(FNBR2,IENS2,2,"E"))
 . S @RXPROF@("activeC")=$G(PHPATARR(FNBR2,IENS2,3,"E"))
 . S @RXPROF@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR2_U_+IENS2)
 ;
 D PHCONT1^SYNDHP30A
 D PHCONT2^SYNDHP30B
 D PHCONT3^SYNDHP30C
 D PHCONT4^SYNDHP30D
 ;
 I $G(DEBUG) W !,$$ZW^SYNDHPUTL("PHPAT")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PHPAT,.PHPATJ)
 ;
 QUIT
 ;

SYNDHP30A
SYNDHP30A ; HC/art - HealthConcourse - continuation of get Pharmacy Patient data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
PHCONT1 ; continuation of get Pharmacy Patient data
 ;
 N IENS5 S IENS5=""
 F  S IENS5=$O(PHPATARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . N UNIT S UNIT=$NA(PHPAT("Phpat","unitDoses","unitDose",+IENS5))
 . S @UNIT@("orderNumber")=$G(PHPATARR(FNBR5,IENS5,.01,"E"))
 . S @UNIT@("priority")=$G(PHPATARR(FNBR5,IENS5,.24,"E"))
 . S @UNIT@("priorityCd")=$G(PHPATARR(FNBR5,IENS5,.24,"I"))
 . S @UNIT@("originalOrderNumber")=$G(PHPATARR(FNBR5,IENS5,.25,"E"))
 . S @UNIT@("patientName")=$G(PHPATARR(FNBR5,IENS5,.5,"E"))
 . S @UNIT@("patientNameId")=$G(PHPATARR(FNBR5,IENS5,.5,"I"))
 . S @UNIT@("patientNameICN")=$$GET1^DIQ(2,@UNIT@("patientNameId")_",",991.1)
 . S @UNIT@("provider")=$G(PHPATARR(FNBR5,IENS5,1,"E"))
 . S @UNIT@("providerId")=$G(PHPATARR(FNBR5,IENS5,1,"I"))
 . S @UNIT@("providerNPI")=$$GET1^DIQ(200,@UNIT@("providerId")_",",41.99) ;NPI
 . S @UNIT@("providerResId")=$$RESID^SYNDHP69("V",SITE,200,@UNIT@("providerId"))
 . S @UNIT@("medRoute")=$G(PHPATARR(FNBR5,IENS5,3,"E"))
 . S @UNIT@("medRouteId")=$G(PHPATARR(FNBR5,IENS5,3,"I"))
 . S @UNIT@("type")=$G(PHPATARR(FNBR5,IENS5,4,"E"))
 . S @UNIT@("typeCd")=$G(PHPATARR(FNBR5,IENS5,4,"I"))
 . S @UNIT@("selfMed")=$G(PHPATARR(FNBR5,IENS5,5,"E"))
 . S @UNIT@("selfMedCd")=$G(PHPATARR(FNBR5,IENS5,5,"I"))
 . S @UNIT@("hospitalSuppliedSelfMed")=$G(PHPATARR(FNBR5,IENS5,6,"E"))
 . S @UNIT@("hospitalSuppliedSelfMedCd")=$G(PHPATARR(FNBR5,IENS5,6,"I"))
 . S @UNIT@("scheduleType")=$G(PHPATARR(FNBR5,IENS5,7,"E"))
 . S @UNIT@("scheduleTypeCd")=$G(PHPATARR(FNBR5,IENS5,7,"I"))
 . S @UNIT@("specialInstructions")=$G(PHPATARR(FNBR5,IENS5,8,"E"))
 . S @UNIT@("originalWard")=$G(PHPATARR(FNBR5,IENS5,9,"E"))
 . S @UNIT@("originalWardId")=$G(PHPATARR(FNBR5,IENS5,9,"I"))
 . S @UNIT@("startDateTime")=$G(PHPATARR(FNBR5,IENS5,10,"E"))
 . S @UNIT@("startDateTimeFM")=$G(PHPATARR(FNBR5,IENS5,10,"I"))
 . S @UNIT@("startDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,10,"I")))
 . S @UNIT@("startDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,10,"I")))
 . S @UNIT@("dayLimit")=$G(PHPATARR(FNBR5,IENS5,11,"E"))
 . S @UNIT@("doseLimit")=$G(PHPATARR(FNBR5,IENS5,12,"E"))
 . S @UNIT@("comments")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR5,IENS5,15,Z)) QUIT:'+Z  D
 . . S @UNIT@("comments")=@UNIT@("comments")_$G(PHPATARR(FNBR5,IENS5,15,Z))
 . S @UNIT@("verifyingNurse")=$G(PHPATARR(FNBR5,IENS5,16,"E"))
 . S @UNIT@("verifyingNurseId")=$G(PHPATARR(FNBR5,IENS5,16,"I"))
 . S @UNIT@("verifyingNurseResId")=$$RESID^SYNDHP69("V",SITE,200,@UNIT@("verifyingNurseId"))
 . S @UNIT@("dateVerifiedByNurse")=$G(PHPATARR(FNBR5,IENS5,17,"E"))
 . S @UNIT@("dateVerifiedByNurseFM")=$G(PHPATARR(FNBR5,IENS5,17,"I"))
 . S @UNIT@("dateVerifiedByNurseHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,17,"I")))
 . S @UNIT@("dateVerifiedByNurseFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,17,"I")))
 . S @UNIT@("verifyingPharmacist")=$G(PHPATARR(FNBR5,IENS5,18,"E"))
 . S @UNIT@("verifyingPharmacistId")=$G(PHPATARR(FNBR5,IENS5,18,"I"))
 . S @UNIT@("verifyingPharmacistResId")=$$RESID^SYNDHP69("V",SITE,200,@UNIT@("verifyingPharmacistId"))
 . S @UNIT@("dateVerifiedByPharmacist")=$G(PHPATARR(FNBR5,IENS5,19,"E"))
 . S @UNIT@("dateVerifiedByPharmacistFM")=$G(PHPATARR(FNBR5,IENS5,19,"I"))
 . S @UNIT@("dateVerifiedByPharmacistHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,19,"I")))
 . S @UNIT@("dateVerifiedByPharmacistFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,19,"I")))
 . S @UNIT@("physician")=$G(PHPATARR(FNBR5,IENS5,20,"E"))
 . S @UNIT@("physicianId")=$G(PHPATARR(FNBR5,IENS5,20,"I"))
 . S @UNIT@("physicianNPI")=$$GET1^DIQ(200,@UNIT@("physicianId")_",",41.99) ;NPI
 . S @UNIT@("physicianResId")=$$RESID^SYNDHP69("V",SITE,200,@UNIT@("physicianId"))
 . S @UNIT@("dateVerifiedByPhysician")=$G(PHPATARR(FNBR5,IENS5,21,"E"))
 . S @UNIT@("dateVerifiedByPhysicianFM")=$G(PHPATARR(FNBR5,IENS5,21,"I"))
 . S @UNIT@("dateVerifiedByPhysicianHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,21,"I")))
 . S @UNIT@("dateVerifiedByPhysicianFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,21,"I")))
 . S @UNIT@("clerk")=$G(PHPATARR(FNBR5,IENS5,22,"E"))
 . S @UNIT@("clerkId")=$G(PHPATARR(FNBR5,IENS5,22,"I"))
 . S @UNIT@("clerkResId")=$$RESID^SYNDHP69("V",SITE,200,@UNIT@("clerkId"))
 . S @UNIT@("dateEnteredByClerk")=$G(PHPATARR(FNBR5,IENS5,23,"E"))
 . S @UNIT@("dateEnteredByClerkFM")=$G(PHPATARR(FNBR5,IENS5,23,"I"))
 . S @UNIT@("dateEnteredByClerkHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,23,"I")))
 . S @UNIT@("dateEnteredByClerkFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,23,"I")))
 . S @UNIT@("previousStopDateTime")=$G(PHPATARR(FNBR5,IENS5,25,"E"))
 . S @UNIT@("previousStopDateTimeFM")=$G(PHPATARR(FNBR5,IENS5,25,"I"))
 . S @UNIT@("previousStopDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,25,"I")))
 . S @UNIT@("previousStopDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,25,"I")))
 . S @UNIT@("schedule")=$G(PHPATARR(FNBR5,IENS5,26,"E"))
 . S @UNIT@("orderDate")=$G(PHPATARR(FNBR5,IENS5,27,"E"))
 . S @UNIT@("orderDateFM")=$G(PHPATARR(FNBR5,IENS5,27,"I"))
 . S @UNIT@("orderDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,27,"I")))
 . S @UNIT@("orderDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,27,"I")))
 . S @UNIT@("logInDate")=$G(PHPATARR(FNBR5,IENS5,27.1,"E"))
 . S @UNIT@("logInDateFM")=$G(PHPATARR(FNBR5,IENS5,27.1,"I"))
 . S @UNIT@("logInDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,27.1,"I")))
 . S @UNIT@("logInDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,27.1,"I")))
 . S @UNIT@("status")=$G(PHPATARR(FNBR5,IENS5,28,"E"))
 . S @UNIT@("statusCd")=$G(PHPATARR(FNBR5,IENS5,28,"I"))
 . S @UNIT@("stopDateTime")=$G(PHPATARR(FNBR5,IENS5,34,"E"))
 . S @UNIT@("stopDateTimeFM")=$G(PHPATARR(FNBR5,IENS5,34,"I"))
 . S @UNIT@("stopDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,34,"I")))
 . S @UNIT@("stopDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,34,"I")))
 . S @UNIT@("adminTimes")=$G(PHPATARR(FNBR5,IENS5,41,"E"))
 . S @UNIT@("frequencyInMinutes")=$G(PHPATARR(FNBR5,IENS5,42,"E"))
 . S @UNIT@("renewal")=$G(PHPATARR(FNBR5,IENS5,43,"E"))
 . S @UNIT@("renewalCd")=$G(PHPATARR(FNBR5,IENS5,43,"I"))
 . S @UNIT@("renewalUser")=$G(PHPATARR(FNBR5,IENS5,44,"E"))
 . S @UNIT@("renewalUserId")=$G(PHPATARR(FNBR5,IENS5,44,"I"))
 . S @UNIT@("dateRenewalMarked")=$G(PHPATARR(FNBR5,IENS5,45,"E"))
 . S @UNIT@("dateRenewalMarkedFM")=$G(PHPATARR(FNBR5,IENS5,45,"I"))
 . S @UNIT@("dateRenewalMarkedHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,45,"I")))
 . S @UNIT@("dateRenewalMarkedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,45,"I")))
 . S @UNIT@("markedCancelled")=$G(PHPATARR(FNBR5,IENS5,46,"E"))
 . S @UNIT@("markedCancelledCd")=$G(PHPATARR(FNBR5,IENS5,46,"I"))
 . S @UNIT@("markedCancelledUser")=$G(PHPATARR(FNBR5,IENS5,47,"E"))
 . S @UNIT@("markedCancelledUserId")=$G(PHPATARR(FNBR5,IENS5,47,"I"))
 . S @UNIT@("dateMarkedCancelled")=$G(PHPATARR(FNBR5,IENS5,48,"E"))
 . S @UNIT@("dateMarkedCancelledFM")=$G(PHPATARR(FNBR5,IENS5,48,"I"))
 . S @UNIT@("dateMarkedCancelledHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,48,"I")))
 . S @UNIT@("dateMarkedCancelledFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,48,"I")))
 . S @UNIT@("autoCancelledFlag")=$G(PHPATARR(FNBR5,IENS5,49,"E"))
 . S @UNIT@("autoCancelledFlagCd")=$G(PHPATARR(FNBR5,IENS5,49,"I"))
 . S @UNIT@("pvFlag")=$G(PHPATARR(FNBR5,IENS5,50,"E"))
 . S @UNIT@("pvFlagCd")=$G(PHPATARR(FNBR5,IENS5,50,"I"))
 . S @UNIT@("nvFlag")=$G(PHPATARR(FNBR5,IENS5,51,"E"))
 . S @UNIT@("nvFlagCd")=$G(PHPATARR(FNBR5,IENS5,51,"I"))
 . S @UNIT@("labelDate")=$G(PHPATARR(FNBR5,IENS5,52,"E"))
 . S @UNIT@("labelDateFM")=$G(PHPATARR(FNBR5,IENS5,52,"I"))
 . S @UNIT@("labelDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,52,"I")))
 . S @UNIT@("labelDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,52,"I")))
 . S @UNIT@("labelReason")=$G(PHPATARR(FNBR5,IENS5,53,"E"))
 . S @UNIT@("labelReasonCd")=$G(PHPATARR(FNBR5,IENS5,53,"I"))
 . S @UNIT@("holdFlag")=$G(PHPATARR(FNBR5,IENS5,56,"E"))
 . S @UNIT@("holdFlagCd")=$G(PHPATARR(FNBR5,IENS5,56,"I"))
 . S @UNIT@("holdUser")=$G(PHPATARR(FNBR5,IENS5,57,"E"))
 . S @UNIT@("holdUserId")=$G(PHPATARR(FNBR5,IENS5,57,"I"))
 . S @UNIT@("holdDate")=$G(PHPATARR(FNBR5,IENS5,58,"E"))
 . S @UNIT@("holdDateFM")=$G(PHPATARR(FNBR5,IENS5,58,"I"))
 . S @UNIT@("holdDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,58,"I")))
 . S @UNIT@("holdDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,58,"I")))
 . S @UNIT@("holdStatus")=$G(PHPATARR(FNBR5,IENS5,59,"E"))
 . S @UNIT@("holdStatusCd")=$G(PHPATARR(FNBR5,IENS5,59,"I"))
 . S @UNIT@("oerrHoldFlag")=$G(PHPATARR(FNBR5,IENS5,59.1,"E"))
 . S @UNIT@("oerrHoldFlagCd")=$G(PHPATARR(FNBR5,IENS5,59.1,"I"))
 . S @UNIT@("offHoldFlag")=$G(PHPATARR(FNBR5,IENS5,60,"E"))
 . S @UNIT@("offHoldFlagCd")=$G(PHPATARR(FNBR5,IENS5,60,"I"))
 . S @UNIT@("offHoldUser")=$G(PHPATARR(FNBR5,IENS5,61,"E"))
 . S @UNIT@("offHoldUserId")=$G(PHPATARR(FNBR5,IENS5,61,"I"))
 . S @UNIT@("offHoldDate")=$G(PHPATARR(FNBR5,IENS5,62,"E"))
 . S @UNIT@("offHoldDateFM")=$G(PHPATARR(FNBR5,IENS5,62,"I"))
 . S @UNIT@("offHoldDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,62,"I")))
 . S @UNIT@("offHoldDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,62,"I")))
 . S @UNIT@("purgeFlag")=$G(PHPATARR(FNBR5,IENS5,64,"E"))
 . S @UNIT@("purgeFlagFM")=$G(PHPATARR(FNBR5,IENS5,64,"I"))
 . S @UNIT@("purgeFlagHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,64,"I")))
 . S @UNIT@("purgeFlagFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,64,"I")))
 . S @UNIT@("ordersFileEntry")=$G(PHPATARR(FNBR5,IENS5,66,"E"))
 . S @UNIT@("mergedPatient")=$G(PHPATARR(FNBR5,IENS5,67,"E"))
 . S @UNIT@("lastWard")=$G(PHPATARR(FNBR5,IENS5,68,"E"))
 . S @UNIT@("lastWardId")=$G(PHPATARR(FNBR5,IENS5,68,"I"))
 . S @UNIT@("NotToBeGivenFlag")=$G(PHPATARR(FNBR5,IENS5,69,"E"))
 . S @UNIT@("NotToBeGivenFlagCd")=$G(PHPATARR(FNBR5,IENS5,69,"I"))
 . S @UNIT@("originalStartDateTime")=$G(PHPATARR(FNBR5,IENS5,70,"E"))
 . S @UNIT@("originalStartDateTimeFM")=$G(PHPATARR(FNBR5,IENS5,70,"I"))
 . S @UNIT@("originalStartDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,70,"I")))
 . S @UNIT@("originalStartDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,70,"I")))
 . S @UNIT@("providerComments")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR5,IENS5,72,Z)) QUIT:'+Z  D
 . . S @UNIT@("providerComments")=@UNIT@("providerComments")_$G(PHPATARR(FNBR5,IENS5,72,Z))
 . S @UNIT@("reasonOrderCreated")=$G(PHPATARR(FNBR5,IENS5,103,"E"))
 . S @UNIT@("reasonOrderCreatedCd")=$G(PHPATARR(FNBR5,IENS5,103,"I"))
 . S @UNIT@("previousOrder")=$G(PHPATARR(FNBR5,IENS5,104,"E"))
 . S @UNIT@("followingOrder")=$G(PHPATARR(FNBR5,IENS5,105,"E"))
 . S @UNIT@("reasonForFollowingOrder")=$G(PHPATARR(FNBR5,IENS5,107,"E"))
 . S @UNIT@("reasonForFollowingOrderCd")=$G(PHPATARR(FNBR5,IENS5,107,"I"))
 . S @UNIT@("orderableItem")=$G(PHPATARR(FNBR5,IENS5,108,"E"))
 . S @UNIT@("orderableItemId")=$G(PHPATARR(FNBR5,IENS5,108,"I"))
 . S @UNIT@("dosageOrdered")=$G(PHPATARR(FNBR5,IENS5,109,"E"))
 . S @UNIT@("natureOfOrder")=$G(PHPATARR(FNBR5,IENS5,110,"E"))
 . S @UNIT@("natureOfOrderCd")=$G(PHPATARR(FNBR5,IENS5,110,"I"))
 . S @UNIT@("instructions")=$G(PHPATARR(FNBR5,IENS5,111,"E"))
 . S @UNIT@("dose")=$G(PHPATARR(FNBR5,IENS5,120,"E"))
 . S @UNIT@("unit")=$G(PHPATARR(FNBR5,IENS5,121,"E"))
 . S @UNIT@("siOpiFlag")=$G(PHPATARR(FNBR5,IENS5,122,"E"))
 . S @UNIT@("siOpiFlagCd")=$G(PHPATARR(FNBR5,IENS5,122,"I"))
 . S @UNIT@("bcmaExpiredFlag")=$G(PHPATARR(FNBR5,IENS5,123,"E"))
 . S @UNIT@("bcmaExpiredFlagCd")=$G(PHPATARR(FNBR5,IENS5,123,"I"))
 . S @UNIT@("flagged")=$G(PHPATARR(FNBR5,IENS5,124,"E"))
 . S @UNIT@("flaggedCd")=$G(PHPATARR(FNBR5,IENS5,124,"I"))
 . S @UNIT@("ordersFileParentOrder")=$G(PHPATARR(FNBR5,IENS5,125,"E"))
 . S @UNIT@("requestedDuration")=$G(PHPATARR(FNBR5,IENS5,126,"E"))
 . S @UNIT@("mostRecentFlagComment")=$G(PHPATARR(FNBR5,IENS5,128,"E"))
 . S @UNIT@("clinic")=$G(PHPATARR(FNBR5,IENS5,130,"E"))
 . S @UNIT@("clinicId")=$G(PHPATARR(FNBR5,IENS5,130,"I"))
 . S @UNIT@("appointmentDateTime")=$G(PHPATARR(FNBR5,IENS5,131,"E"))
 . S @UNIT@("appointmentDateTimeFM")=$G(PHPATARR(FNBR5,IENS5,131,"I"))
 . S @UNIT@("appointmentDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR5,IENS5,131,"I")))
 . S @UNIT@("appointmentDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR5,IENS5,131,"I")))
 . S @UNIT@("specialInstructionsLong")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR5,IENS5,135,Z)) QUIT:'+Z  D
 . . S @UNIT@("specialInstructionsLong")=@UNIT@("specialInstructionsLong")_$G(PHPATARR(FNBR5,IENS5,135,Z))
 . S @UNIT@("displayStatus")=$G(PHPATARR(FNBR5,IENS5,136,"E"))
 . S @UNIT@("displayStatusCd")=$G(PHPATARR(FNBR5,IENS5,136,"I"))
 . S @UNIT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR5_U_+IENS5)
 ;
 QUIT
 ;

SYNDHP30B
SYNDHP30B ; HC/art - HealthConcourse - continuation of get Pharmacy Patient data ;08/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
PHCONT2 ;
 ;
 N IENS3 S IENS3=""
 F  S IENS3=$O(PHPATARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . N NONVA S NONVA=$NA(PHPAT("Phpat","nonVaMedss","nonVaMeds",+IENS3))
 . S @NONVA@("orderableItem")=$G(PHPATARR(FNBR3,IENS3,.01,"E"))
 . S @NONVA@("orderableItemId")=$G(PHPATARR(FNBR3,IENS3,.01,"I"))
 . S @NONVA@("dispenseDrug")=$G(PHPATARR(FNBR3,IENS3,1,"E"))
 . S @NONVA@("dispenseDrugId")=$G(PHPATARR(FNBR3,IENS3,1,"I"))
 . S @NONVA@("dispenseDrugName")=$$GET1^DIQ(50,@NONVA@("dispenseDrugId")_",",20)
 . S @NONVA@("dispenseDrugNameId")=$$GET1^DIQ(50,@NONVA@("dispenseDrugId")_",",20,"I")
 . S @NONVA@("dispenseDrugRxNorm")=$$GETRXN^SYNDHPUTL(@NONVA@("dispenseDrugId"))
 . S @NONVA@("dosage")=$G(PHPATARR(FNBR3,IENS3,2,"E"))
 . S @NONVA@("medicationRoute")=$G(PHPATARR(FNBR3,IENS3,3,"E"))
 . S @NONVA@("schedule")=$G(PHPATARR(FNBR3,IENS3,4,"E"))
 . S @NONVA@("status")=$G(PHPATARR(FNBR3,IENS3,5,"E"))
 . S @NONVA@("statusCd")=$G(PHPATARR(FNBR3,IENS3,5,"I"))
 . S @NONVA@("discontinuedDate")=$G(PHPATARR(FNBR3,IENS3,6,"E"))
 . S @NONVA@("discontinuedDateFM")=$G(PHPATARR(FNBR3,IENS3,6,"I"))
 . S @NONVA@("discontinuedDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR3,IENS3,6,"I")))
 . S @NONVA@("discontinuedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR3,IENS3,6,"I")))
 . S @NONVA@("orderNumber")=$G(PHPATARR(FNBR3,IENS3,7,"E"))
 . S @NONVA@("orderNumberId")=$G(PHPATARR(FNBR3,IENS3,7,"I"))
 . S @NONVA@("startDate")=$G(PHPATARR(FNBR3,IENS3,8,"E"))
 . S @NONVA@("startDateFM")=$G(PHPATARR(FNBR3,IENS3,8,"I"))
 . S @NONVA@("startDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR3,IENS3,8,"I")))
 . S @NONVA@("startDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR3,IENS3,8,"I")))
 . S @NONVA@("disclaimer")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR3,IENS3,10,Z)) QUIT:'+Z  D
 . . S @NONVA@("disclaimer")=@NONVA@("disclaimer")_$G(PHPATARR(FNBR3,IENS3,10,Z))
 . S @NONVA@("documentedDate")=$G(PHPATARR(FNBR3,IENS3,11,"E"))
 . S @NONVA@("documentedDateFM")=$G(PHPATARR(FNBR3,IENS3,11,"I"))
 . S @NONVA@("documentedDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR3,IENS3,11,"I")))
 . S @NONVA@("documentedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR3,IENS3,11,"I")))
 . S @NONVA@("documentedBy")=$G(PHPATARR(FNBR3,IENS3,12,"E"))
 . S @NONVA@("documentedById")=$G(PHPATARR(FNBR3,IENS3,12,"I"))
 . S @NONVA@("documentedByResId")=$$RESID^SYNDHP69("V",SITE,200,@NONVA@("documentedById"))
 . S @NONVA@("clinic")=$G(PHPATARR(FNBR3,IENS3,13,"E"))
 . S @NONVA@("clinicId")=$G(PHPATARR(FNBR3,IENS3,13,"I"))
 . S @NONVA@("comments")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR3,IENS3,14,Z)) QUIT:'+Z  D
 . . S @NONVA@("comments")=@NONVA@("comments")_$G(PHPATARR(FNBR3,IENS3,14,Z))
 . S @NONVA@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR3_U_+IENS3)
 ;
 N IENS4 S IENS4=""
 F  S IENS4=$O(PHPATARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N ORDCHK S ORDCHK=$NA(PHPAT("Phpat","nonVaMedss","nonVaMeds",$P(IENS4,C,2),"orderCheckss","orderChecks",+IENS4))
 . S @ORDCHK@("orderCheckNarrative")=$G(PHPATARR(FNBR4,IENS4,.01,"E"))
 . S @ORDCHK@("overridingProvider")=$G(PHPATARR(FNBR4,IENS4,1,"E"))
 . S @ORDCHK@("overridingProviderId")=$G(PHPATARR(FNBR4,IENS4,1,"I"))
 . S @ORDCHK@("overridingProviderNPI")=$$GET1^DIQ(200,@ORDCHK@("overridingProviderId")_",",41.99) ;NPI
 . S @ORDCHK@("overridingProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@ORDCHK@("overridingProviderId"))
 . S @ORDCHK@("overridingReason")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR4,IENS4,2,Z)) QUIT:'+Z  D
 . . S @ORDCHK@("overridingReason")=@ORDCHK@("overridingReason")_$G(PHPATARR(FNBR4,IENS4,2,Z))
 . S @ORDCHK@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR3_U_$P(IENS4,C,2)_U_FNBR4_U_+IENS4)
 ;
 N IENS6 S IENS6=""
 F  S IENS6=$O(PHPATARR(FNBR6,IENS6)) QUIT:IENS6=""  D
 . N DISPDR S DISPDR=$NA(PHPAT("Phpat","unitDoses","unitDose",$P(IENS6,C,2),"dispenseDrugs","dispenseDrug",+IENS6))
 . S @DISPDR@("dispenseDrug")=$G(PHPATARR(FNBR6,IENS6,.01,"E"))
 . S @DISPDR@("dispenseDrugId")=$G(PHPATARR(FNBR6,IENS6,.01,"I"))
 . S @DISPDR@("dispenseDrugName")=$$GET1^DIQ(50,@DISPDR@("dispenseDrugId")_",",20)
 . S @DISPDR@("dispenseDrugNameId")=$$GET1^DIQ(50,@DISPDR@("dispenseDrugId")_",",20,"I")
 . S @DISPDR@("dispenseDrugRxNorm")=$$GETRXN^SYNDHPUTL(@DISPDR@("dispenseDrugId"))
 . S @DISPDR@("unitsPerDose")=$G(PHPATARR(FNBR6,IENS6,.02,"E"))
 . S @DISPDR@("inactiveDate")=$G(PHPATARR(FNBR6,IENS6,.03,"E"))
 . S @DISPDR@("inactiveDateFM")=$G(PHPATARR(FNBR6,IENS6,.03,"I"))
 . S @DISPDR@("inactiveDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR6,IENS6,.03,"I")))
 . S @DISPDR@("inactiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR6,IENS6,.03,"I")))
 . S @DISPDR@("totalUnitsDispensedC")=$G(PHPATARR(FNBR6,IENS6,.04,"E"))
 . S @DISPDR@("unitsCalledFor")=$G(PHPATARR(FNBR6,IENS6,.05,"E"))
 . S @DISPDR@("unitsActuallyDispensed")=$G(PHPATARR(FNBR6,IENS6,.06,"E"))
 . S @DISPDR@("totalReturns")=$G(PHPATARR(FNBR6,IENS6,.07,"E"))
 . S @DISPDR@("returns")=$G(PHPATARR(FNBR6,IENS6,.08,"E"))
 . S @DISPDR@("preExchangeUnits")=$G(PHPATARR(FNBR6,IENS6,.09,"E"))
 . S @DISPDR@("totalExtraUnitsDispensed")=$G(PHPATARR(FNBR6,IENS6,.1,"E"))
 . S @DISPDR@("extraUnitsDispensed")=$G(PHPATARR(FNBR6,IENS6,.11,"E"))
 . S @DISPDR@("totalPreExchangeUnits")=$G(PHPATARR(FNBR6,IENS6,.12,"E"))
 . S @DISPDR@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR5_U_$P(IENS6,C,2)_U_FNBR6_U_+IENS6)
 ;
 N IENS7 S IENS7=""
 F  S IENS7=$O(PHPATARR(FNBR7,IENS7)) QUIT:IENS7=""  D
 . N UACTLOG S UACTLOG=$NA(PHPAT("Phpat","unitDoses","unitDose",$P(IENS7,C,2),"activityLogs","activityLog",+IENS7))
 . S @UACTLOG@("date")=$G(PHPATARR(FNBR7,IENS7,.01,"E"))
 . S @UACTLOG@("dateFM")=$G(PHPATARR(FNBR7,IENS7,.01,"I"))
 . S @UACTLOG@("dateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR7,IENS7,.01,"I")))
 . S @UACTLOG@("dateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR7,IENS7,.01,"I")))
 . S @UACTLOG@("user")=$G(PHPATARR(FNBR7,IENS7,1,"E"))
 . S @UACTLOG@("action")=$G(PHPATARR(FNBR7,IENS7,2,"E"))
 . S @UACTLOG@("actionId")=$G(PHPATARR(FNBR7,IENS7,2,"I"))
 . S @UACTLOG@("field")=$G(PHPATARR(FNBR7,IENS7,3,"E"))
 . S @UACTLOG@("oldData")=$G(PHPATARR(FNBR7,IENS7,4,"E"))
 . S @UACTLOG@("oldDataWordProcessing")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR7,IENS7,5,Z)) QUIT:'+Z  D
 . . S @UACTLOG@("oldDataWordProcessing")=@UACTLOG@("oldDataWordProcessing")_$G(PHPATARR(FNBR7,IENS7,5,Z))
 . S @UACTLOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR5_U_$P(IENS7,C,2)_U_FNBR7_U_+IENS7)
 ;
 N IENS8 S IENS8=""
 F  S IENS8=$O(PHPATARR(FNBR8,IENS8)) QUIT:IENS8=""  D
 . N UDSPLOG S UDSPLOG=$NA(PHPAT("Phpat","unitDoses","unitDose",$P(IENS8,C,2),"dispenseLogs","dispenseLog",+IENS8))
 . S @UDSPLOG@("dispenseDateTime")=$G(PHPATARR(FNBR8,IENS8,.01,"E"))
 . S @UDSPLOG@("dispenseDateTimeFM")=$G(PHPATARR(FNBR8,IENS8,.01,"I"))
 . S @UDSPLOG@("dispenseDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR8,IENS8,.01,"I")))
 . S @UDSPLOG@("dispenseDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR8,IENS8,.01,"I")))
 . S @UDSPLOG@("dispenseDrug")=$G(PHPATARR(FNBR8,IENS8,.02,"E"))
 . S @UDSPLOG@("dispenseDrugId")=$G(PHPATARR(FNBR8,IENS8,.02,"I"))
 . S @UDSPLOG@("amount")=$G(PHPATARR(FNBR8,IENS8,.03,"E"))
 . S @UDSPLOG@("cost")=$G(PHPATARR(FNBR8,IENS8,.04,"E"))
 . S @UDSPLOG@("how")=$G(PHPATARR(FNBR8,IENS8,.05,"E"))
 . S @UDSPLOG@("howCd")=$G(PHPATARR(FNBR8,IENS8,.05,"I"))
 . S @UDSPLOG@("user")=$G(PHPATARR(FNBR8,IENS8,.06,"E"))
 . S @UDSPLOG@("userId")=$G(PHPATARR(FNBR8,IENS8,.06,"I"))
 . S @UDSPLOG@("ward")=$G(PHPATARR(FNBR8,IENS8,.07,"E"))
 . S @UDSPLOG@("wardId")=$G(PHPATARR(FNBR8,IENS8,.07,"I"))
 . S @UDSPLOG@("provider")=$G(PHPATARR(FNBR8,IENS8,.08,"E"))
 . S @UDSPLOG@("providerId")=$G(PHPATARR(FNBR8,IENS8,.08,"I"))
 . S @UDSPLOG@("providerNPI")=$$GET1^DIQ(200,@UDSPLOG@("providerId")_",",41.99) ;NPI
 . S @UDSPLOG@("providerResId")=$$RESID^SYNDHP69("V",SITE,200,@UDSPLOG@("providerId"))
 . S @UDSPLOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR5_U_$P(IENS8,C,2)_U_FNBR8_U_+IENS8)
 ;
 N IENS9 S IENS9=""
 F  S IENS9=$O(PHPATARR(FNBR9,IENS9)) QUIT:IENS9=""  D
 . N ULAST S ULAST=$NA(PHPAT("Phpat","unitDoses","unitDose",$P(IENS9,C,2),"lastRenews","lastRenew",+IENS9))
 . S @ULAST@("lastRenew")=$G(PHPATARR(FNBR9,IENS9,.01,"E"))
 . S @ULAST@("lastRenewFM")=$G(PHPATARR(FNBR9,IENS9,.01,"I"))
 . S @ULAST@("lastRenewHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR9,IENS9,.01,"I")))
 . S @ULAST@("lastRenewFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR9,IENS9,.01,"I")))
 . S @ULAST@("renewedBy")=$G(PHPATARR(FNBR9,IENS9,1,"E"))
 . S @ULAST@("renewedById")=$G(PHPATARR(FNBR9,IENS9,1,"I"))
 . S @ULAST@("renewedByNPI")=$$GET1^DIQ(200,@ULAST@("renewedById")_",",41.99) ;NPI
 . S @ULAST@("renewedByResId")=$$RESID^SYNDHP69("V",SITE,200,@ULAST@("renewedById"))
 . S @ULAST@("previousProvider")=$G(PHPATARR(FNBR9,IENS9,2,"E"))
 . S @ULAST@("previousProviderId")=$G(PHPATARR(FNBR9,IENS9,2,"I"))
 . S @ULAST@("previousProviderNPI")=$$GET1^DIQ(200,@ULAST@("previousProviderId")_",",41.99) ;NPI
 . S @ULAST@("previousProviderResId")=$$RESID^SYNDHP69("V",SITE,200,@ULAST@("previousProviderId"))
 . S @ULAST@("previousStopDateTime")=$G(PHPATARR(FNBR9,IENS9,3,"E"))
 . S @ULAST@("previousStopDateTimeFM")=$G(PHPATARR(FNBR9,IENS9,3,"I"))
 . S @ULAST@("previousStopDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR9,IENS9,3,"I")))
 . S @ULAST@("previousStopDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR9,IENS9,3,"I")))
 . S @ULAST@("previousOrdersFileEntry")=$G(PHPATARR(FNBR9,IENS9,4,"E"))
 . S @ULAST@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR5_U_$P(IENS9,C,2)_U_FNBR9_U_+IENS9)
 ;
 N IENS10 S IENS10=""
 F  S IENS10=$O(PHPATARR(FNBR10,IENS10)) QUIT:IENS10=""  D
 . N UINTR S UINTR=$NA(PHPAT("Phpat","unitDoses","unitDose",$P(IENS10,C,2),"interventions","intervention",+IENS10))
 . S @UINTR@("intervention")=$G(PHPATARR(FNBR10,IENS10,.01,"E"))
 . S @UINTR@("interventionId")=$G(PHPATARR(FNBR10,IENS10,.01,"I"))
 . S @UINTR@("interventionDateTime")=$G(PHPATARR(FNBR10,IENS10,1,"E"))
 . S @UINTR@("interventionDateTimeFM")=$G(PHPATARR(FNBR10,IENS10,1,"I"))
 . S @UINTR@("interventionDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR10,IENS10,1,"I")))
 . S @UINTR@("interventionDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR10,IENS10,1,"I")))
 . S @UINTR@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR5_U_$P(IENS10,C,2)_U_FNBR10_U_+IENS10)
 ;
 QUIT
 ;

SYNDHP30C
SYNDHP30C ; HC/art - HealthConcourse - continuation of get Pharmacy Patient data ;08/29/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
PHCONT3 ;
 ;
 N IENS11 S IENS11=""
 F  S IENS11=$O(PHPATARR(FNBR11,IENS11)) QUIT:IENS11=""  D
 . N IVS S IVS=$NA(PHPAT("Phpat","ivs","iv",+IENS11))
 . S @IVS@("orderNumber")=$G(PHPATARR(FNBR11,IENS11,.01,"E"))
 . S @IVS@("startDateTime")=$G(PHPATARR(FNBR11,IENS11,.02,"E"))
 . S @IVS@("startDateTimeFM")=$G(PHPATARR(FNBR11,IENS11,.02,"I"))
 . S @IVS@("startDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,.02,"I")))
 . S @IVS@("startDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,.02,"I")))
 . S @IVS@("stopDateTime")=$G(PHPATARR(FNBR11,IENS11,.03,"E"))
 . S @IVS@("stopDateTimeFM")=$G(PHPATARR(FNBR11,IENS11,.03,"I"))
 . S @IVS@("stopDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,.03,"I")))
 . S @IVS@("stopDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,.03,"I")))
 . S @IVS@("type")=$G(PHPATARR(FNBR11,IENS11,.04,"E"))
 . S @IVS@("typeCd")=$G(PHPATARR(FNBR11,IENS11,.04,"I"))
 . S @IVS@("provider")=$G(PHPATARR(FNBR11,IENS11,.06,"E"))
 . S @IVS@("providerId")=$G(PHPATARR(FNBR11,IENS11,.06,"I"))
 . S @IVS@("providerNPI")=$$GET1^DIQ(200,@IVS@("providerId")_",",41.99) ;NPI
 . S @IVS@("providerResId")=$$RESID^SYNDHP69("V",SITE,200,@IVS@("providerId"))
 . S @IVS@("infusionRate")=$G(PHPATARR(FNBR11,IENS11,.08,"E"))
 . S @IVS@("schedule")=$G(PHPATARR(FNBR11,IENS11,.09,"E"))
 . S @IVS@("remarks")=$G(PHPATARR(FNBR11,IENS11,.1,"E"))
 . S @IVS@("administrationTimes")=$G(PHPATARR(FNBR11,IENS11,.12,"E"))
 . S @IVS@("lastFill")=$G(PHPATARR(FNBR11,IENS11,.15,"E"))
 . S @IVS@("lastFillFM")=$G(PHPATARR(FNBR11,IENS11,.15,"I"))
 . S @IVS@("lastFillHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,.15,"I")))
 . S @IVS@("lastFillFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,.15,"I")))
 . S @IVS@("lastQtyFilled")=$G(PHPATARR(FNBR11,IENS11,.16,"E"))
 . S @IVS@("scheduleInterval")=$G(PHPATARR(FNBR11,IENS11,.17,"E"))
 . S @IVS@("loginDateTime")=$G(PHPATARR(FNBR11,IENS11,.21,"E"))
 . S @IVS@("loginDateTimeFM")=$G(PHPATARR(FNBR11,IENS11,.21,"I"))
 . S @IVS@("loginDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,.21,"I")))
 . S @IVS@("loginDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,.21,"I")))
 . S @IVS@("ivRoom")=$G(PHPATARR(FNBR11,IENS11,.22,"E"))
 . S @IVS@("ivRoomId")=$G(PHPATARR(FNBR11,IENS11,.22,"I"))
 . S @IVS@("cumulativeDoses")=$G(PHPATARR(FNBR11,IENS11,.24,"E"))
 . S @IVS@("originalWard")=$G(PHPATARR(FNBR11,IENS11,9,"E"))
 . S @IVS@("originalWardId")=$G(PHPATARR(FNBR11,IENS11,9,"I"))
 . S @IVS@("verifyingNurse")=$G(PHPATARR(FNBR11,IENS11,16,"E"))
 . S @IVS@("verifyingNurseId")=$G(PHPATARR(FNBR11,IENS11,16,"I"))
 . S @IVS@("dateVerifiedByNurse")=$G(PHPATARR(FNBR11,IENS11,17,"E"))
 . S @IVS@("dateVerifiedByNurseFM")=$G(PHPATARR(FNBR11,IENS11,17,"I"))
 . S @IVS@("dateVerifiedByNurseHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,17,"I")))
 . S @IVS@("dateVerifiedByNurseFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,17,"I")))
 . S @IVS@("otherPrintInfo")=$G(PHPATARR(FNBR11,IENS11,31,"E"))
 . S @IVS@("status")=$G(PHPATARR(FNBR11,IENS11,100,"E"))
 . S @IVS@("statusCd")=$G(PHPATARR(FNBR11,IENS11,100,"I"))
 . S @IVS@("ward")=$G(PHPATARR(FNBR11,IENS11,104,"E"))
 . S @IVS@("totalIvSAdministered")=$G(PHPATARR(FNBR11,IENS11,105,"E"))
 . S @IVS@("chemotherapyType")=$G(PHPATARR(FNBR11,IENS11,106,"E"))
 . S @IVS@("chemotherapyTypeCd")=$G(PHPATARR(FNBR11,IENS11,106,"I"))
 . S @IVS@("syringeSize")=$G(PHPATARR(FNBR11,IENS11,107,"E"))
 . S @IVS@("intermittentSyringe")=$G(PHPATARR(FNBR11,IENS11,108,"E"))
 . S @IVS@("intermittentSyringeCd")=$G(PHPATARR(FNBR11,IENS11,108,"I"))
 . S @IVS@("dcDate")=$G(PHPATARR(FNBR11,IENS11,109,"E"))
 . S @IVS@("dcDateFM")=$G(PHPATARR(FNBR11,IENS11,109,"I"))
 . S @IVS@("dcDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,109,"I")))
 . S @IVS@("dcDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,109,"I")))
 . S @IVS@("ordersFileEntry")=$G(PHPATARR(FNBR11,IENS11,110,"E"))
 . S @IVS@("atzero")=$G(PHPATARR(FNBR11,IENS11,112,"E"))
 . S @IVS@("atzeroCd")=$G(PHPATARR(FNBR11,IENS11,112,"I"))
 . S @IVS@("previousOrder")=$G(PHPATARR(FNBR11,IENS11,113,"E"))
 . S @IVS@("followingOrder")=$G(PHPATARR(FNBR11,IENS11,114,"E"))
 . S @IVS@("providerComments")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR11,IENS11,115,Z)) QUIT:'+Z  D
 . . S @IVS@("providerComments")=@IVS@("providerComments")_$G(PHPATARR(FNBR11,IENS11,115,Z))
 . S @IVS@("originalStopDate")=$G(PHPATARR(FNBR11,IENS11,116,"E"))
 . S @IVS@("originalStopDateFM")=$G(PHPATARR(FNBR11,IENS11,116,"I"))
 . S @IVS@("originalStopDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,116,"I")))
 . S @IVS@("originalStopDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,116,"I")))
 . S @IVS@("oerrHoldFlag")=$G(PHPATARR(FNBR11,IENS11,120,"E"))
 . S @IVS@("oerrHoldFlagCd")=$G(PHPATARR(FNBR11,IENS11,120,"I"))
 . S @IVS@("autoDc")=$G(PHPATARR(FNBR11,IENS11,121,"E"))
 . S @IVS@("autoDcCd")=$G(PHPATARR(FNBR11,IENS11,121,"I"))
 . S @IVS@("reasonOrderCreated")=$G(PHPATARR(FNBR11,IENS11,122,"E"))
 . S @IVS@("reasonOrderCreatedCd")=$G(PHPATARR(FNBR11,IENS11,122,"I"))
 . S @IVS@("reasonForFollowingOrder")=$G(PHPATARR(FNBR11,IENS11,123,"E"))
 . S @IVS@("reasonForFollowingOrderCd")=$G(PHPATARR(FNBR11,IENS11,123,"I"))
 . S @IVS@("marLabelDate")=$G(PHPATARR(FNBR11,IENS11,128,"E"))
 . S @IVS@("marLabelDateFM")=$G(PHPATARR(FNBR11,IENS11,128,"I"))
 . S @IVS@("marLabelDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,128,"I")))
 . S @IVS@("marLabelDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,128,"I")))
 . S @IVS@("marLabelReason")=$G(PHPATARR(FNBR11,IENS11,129,"E"))
 . S @IVS@("marLabelReasonCd")=$G(PHPATARR(FNBR11,IENS11,129,"I"))
 . S @IVS@("orderableItem")=$G(PHPATARR(FNBR11,IENS11,130,"E"))
 . S @IVS@("orderableItemId")=$G(PHPATARR(FNBR11,IENS11,130,"I"))
 . S @IVS@("dosageOrdered")=$G(PHPATARR(FNBR11,IENS11,131,"E"))
 . S @IVS@("medRoute")=$G(PHPATARR(FNBR11,IENS11,132,"E"))
 . S @IVS@("medRouteId")=$G(PHPATARR(FNBR11,IENS11,132,"I"))
 . S @IVS@("instructions")=$G(PHPATARR(FNBR11,IENS11,133,"E"))
 . S @IVS@("priority")=$G(PHPATARR(FNBR11,IENS11,134,"E"))
 . S @IVS@("priorityCd")=$G(PHPATARR(FNBR11,IENS11,134,"I"))
 . S @IVS@("entryBy")=$G(PHPATARR(FNBR11,IENS11,135,"E"))
 . S @IVS@("entryById")=$G(PHPATARR(FNBR11,IENS11,135,"I"))
 . S @IVS@("entryByResId")=$$RESID^SYNDHP69("V",SITE,200,@IVS@("entryById"))
 . S @IVS@("clinic")=$G(PHPATARR(FNBR11,IENS11,136,"E"))
 . S @IVS@("clinicId")=$G(PHPATARR(FNBR11,IENS11,136,"I"))
 . S @IVS@("natureOfOrder")=$G(PHPATARR(FNBR11,IENS11,137,"E"))
 . S @IVS@("natureOfOrderCd")=$G(PHPATARR(FNBR11,IENS11,137,"I"))
 . S @IVS@("appointmentDateTime")=$G(PHPATARR(FNBR11,IENS11,139,"E"))
 . S @IVS@("appointmentDateTimeFM")=$G(PHPATARR(FNBR11,IENS11,139,"I"))
 . S @IVS@("appointmentDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,139,"I")))
 . S @IVS@("appointmentDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,139,"I")))
 . S @IVS@("verifyingPharmacist")=$G(PHPATARR(FNBR11,IENS11,140,"E"))
 . S @IVS@("verifyingPharmacistId")=$G(PHPATARR(FNBR11,IENS11,140,"I"))
 . S @IVS@("dateVerifiedByPharmacist")=$G(PHPATARR(FNBR11,IENS11,141,"E"))
 . S @IVS@("dateVerifiedByPharmacistFM")=$G(PHPATARR(FNBR11,IENS11,141,"I"))
 . S @IVS@("dateVerifiedByPharmacistHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR11,IENS11,141,"I")))
 . S @IVS@("dateVerifiedByPharmacistFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR11,IENS11,141,"I")))
 . S @IVS@("pvFlag")=$G(PHPATARR(FNBR11,IENS11,142,"E"))
 . S @IVS@("pvFlagCd")=$G(PHPATARR(FNBR11,IENS11,142,"I"))
 . S @IVS@("nvFlag")=$G(PHPATARR(FNBR11,IENS11,143,"E"))
 . S @IVS@("nvFlagCd")=$G(PHPATARR(FNBR11,IENS11,143,"I"))
 . S @IVS@("bcmaStatus")=$G(PHPATARR(FNBR11,IENS11,144,"E"))
 . S @IVS@("bcmaStatusCd")=$G(PHPATARR(FNBR11,IENS11,144,"I"))
 . S @IVS@("bcmaid")=$G(PHPATARR(FNBR11,IENS11,145,"E"))
 . S @IVS@("siOpiFlag")=$G(PHPATARR(FNBR11,IENS11,146,"E"))
 . S @IVS@("siOpiFlagCd")=$G(PHPATARR(FNBR11,IENS11,146,"I"))
 . S @IVS@("bcmaExpiredFlag")=$G(PHPATARR(FNBR11,IENS11,147,"E"))
 . S @IVS@("bcmaExpiredFlagCd")=$G(PHPATARR(FNBR11,IENS11,147,"I"))
 . S @IVS@("flagged")=$G(PHPATARR(FNBR11,IENS11,148,"E"))
 . S @IVS@("flaggedCd")=$G(PHPATARR(FNBR11,IENS11,148,"I"))
 . S @IVS@("holdFlag")=$G(PHPATARR(FNBR11,IENS11,149,"E"))
 . S @IVS@("holdFlagCd")=$G(PHPATARR(FNBR11,IENS11,149,"I"))
 . S @IVS@("ordersFileParentOrder")=$G(PHPATARR(FNBR11,IENS11,150,"E"))
 . S @IVS@("requestedDuration")=$G(PHPATARR(FNBR11,IENS11,151,"E"))
 . S @IVS@("requestedIvLimitation")=$G(PHPATARR(FNBR11,IENS11,152,"E"))
 . S @IVS@("otherPrintInfoLong")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR11,IENS11,154,Z)) QUIT:'+Z  D
 . . S @IVS@("otherPrintInfoLong")=@IVS@("otherPrintInfoLong")_$G(PHPATARR(FNBR11,IENS11,154,Z))
 . S @IVS@("labelsPerDay")=$G(PHPATARR(FNBR11,IENS11,155,"E"))
 . S @IVS@("displayStatus")=$G(PHPATARR(FNBR11,IENS11,157,"E"))
 . S @IVS@("displayStatusCd")=$G(PHPATARR(FNBR11,IENS11,157,"I"))
 . S @IVS@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_+IENS11)
 ;
 N IENS12 S IENS12=""
 F  S IENS12=$O(PHPATARR(FNBR12,IENS12)) QUIT:IENS12=""  D
 . N IADD S IADD=$NA(PHPAT("Phpat","ivs","iv",$P(IENS12,C,2),"additives","additive",+IENS12))
 . S @IADD@("additive")=$G(PHPATARR(FNBR12,IENS12,.01,"E"))
 . S @IADD@("additiveId")=$G(PHPATARR(FNBR12,IENS12,.01,"I"))
 . S @IADD@("additiveName")=$$GET1^DIQ(52.6,@IADD@("additiveId")_",",1)
 . S @IADD@("additiveNameId")=$$GET1^DIQ(52.6,@IADD@("additiveId")_",",1,"I")
 . S @IADD@("additiveRxNorm")=$$GETRXN^SYNDHPUTL(@IADD@("additiveNameId"))
 . S @IADD@("strength")=$G(PHPATARR(FNBR12,IENS12,.02,"E"))
 . S @IADD@("bottle")=$G(PHPATARR(FNBR12,IENS12,.03,"E"))
 . S @IADD@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_$P(IENS12,C,2)_U_FNBR12_U_+IENS12)
 ;
 N IENS13 S IENS13=""
 F  S IENS13=$O(PHPATARR(FNBR13,IENS13)) QUIT:IENS13=""  D
 . N ISOL S ISOL=$NA(PHPAT("Phpat","ivs","iv",$P(IENS13,C,2),"solutions","solution",+IENS13))
 . S @ISOL@("solution")=$G(PHPATARR(FNBR13,IENS13,.01,"E"))
 . S @ISOL@("solutionId")=$G(PHPATARR(FNBR13,IENS13,.01,"I"))
 . S @ISOL@("solutionGenericName")=$$GET1^DIQ(52.7,@ISOL@("solutionId")_",",1)
 . S @ISOL@("solutionGenericNameId")=$$GET1^DIQ(52.7,@ISOL@("solutionId")_",",1,"I")
 . S @ISOL@("solutionRxNorm")=$$GETRXN^SYNDHPUTL(@ISOL@("solutionGenericNameId"))
 . S @ISOL@("volume")=$G(PHPATARR(FNBR13,IENS13,1,"E"))
 . S @ISOL@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_$P(IENS13,C,2)_U_FNBR13_U_+IENS13)
 ;
 QUIT
 ;

SYNDHP30D
SYNDHP30D ; HC/art - HealthConcourse - continuation of get Pharmacy Patient data ;08/29/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
PHCONT4 ;
 ;
 N IENS14 S IENS14=""
 F  S IENS14=$O(PHPATARR(FNBR14,IENS14)) QUIT:IENS14=""  D
 . N IACTLOG S IACTLOG=$NA(PHPAT("Phpat","ivs","iv",$P(IENS14,C,2),"activityLogs","activityLog",+IENS14))
 . S @IACTLOG@("activityLog")=$G(PHPATARR(FNBR14,IENS14,.01,"E"))
 . S @IACTLOG@("typeOfActivity")=$G(PHPATARR(FNBR14,IENS14,.02,"E"))
 . S @IACTLOG@("typeOfActivityCd")=$G(PHPATARR(FNBR14,IENS14,.02,"I"))
 . S @IACTLOG@("entryCode")=$G(PHPATARR(FNBR14,IENS14,.03,"E"))
 . S @IACTLOG@("reasonForActivity")=$G(PHPATARR(FNBR14,IENS14,.04,"E"))
 . S @IACTLOG@("activityDate")=$G(PHPATARR(FNBR14,IENS14,.05,"E"))
 . S @IACTLOG@("activityDateFM")=$G(PHPATARR(FNBR14,IENS14,.05,"I"))
 . S @IACTLOG@("activityDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR14,IENS14,.05,"I")))
 . S @IACTLOG@("activityDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR14,IENS14,.05,"I")))
 . S @IACTLOG@("user")=$G(PHPATARR(FNBR14,IENS14,.06,"E"))
 . S @IACTLOG@("userId")=$G(PHPATARR(FNBR14,IENS14,.06,"I"))
 . S @IACTLOG@("fieldChanged")=$G(PHPATARR(FNBR14,IENS14,1,"E"))
 . S @IACTLOG@("otherPrintInfoOldValue")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR14,IENS14,2,Z)) QUIT:'+Z  D
 . . S @IACTLOG@("otherPrintInfoOldValue")=@IACTLOG@("otherPrintInfoOldValue")_$G(PHPATARR(FNBR14,IENS14,2,Z))
 . S @IACTLOG@("otherPrintInfoNewValue")=""
 . N Z S Z=""
 . F  S Z=$O(PHPATARR(FNBR14,IENS14,3,Z)) QUIT:'+Z  D
 . . S @IACTLOG@("otherPrintInfoNewValue")=@IACTLOG@("otherPrintInfoNewValue")_$G(PHPATARR(FNBR14,IENS14,3,Z))
 . S @IACTLOG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_$P(IENS14,C,2)_U_FNBR14_U_+IENS14)
 ;
 N IENS16 S IENS16=""
 F  S IENS16=$O(PHPATARR(FNBR16,IENS16)) QUIT:IENS16=""  D
 . N FLDCHG S FLDCHG=$NA(PHPAT("Phpat","ivs","iv",$P(IENS16,C,3),"activityLogs","activityLog",$P(IENS16,C,2),"fieldChangeds","fieldChanged",+IENS16))
 . S @FLDCHG@("fieldChanged")=$G(PHPATARR(FNBR16,IENS16,.01,"E"))
 . S @FLDCHG@("from")=$G(PHPATARR(FNBR16,IENS16,1,"E"))
 . S @FLDCHG@("to")=$G(PHPATARR(FNBR16,IENS16,2,"E"))
 . S @FLDCHG@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_$P(IENS16,C,3)_U_FNBR14_U_$P(IENS16,C,2)_U_FNBR16_U_+IENS16)
 ;
 N IENS17 S IENS17=""
 F  S IENS17=$O(PHPATARR(FNBR17,IENS17)) QUIT:IENS17=""  D
 . N ILABEL S ILABEL=$NA(PHPAT("Phpat","ivs","iv",$P(IENS17,C,2),"labelTrackings","labelTracking",+IENS17))
 . S @ILABEL@("labelTracking")=$G(PHPATARR(FNBR17,IENS17,.01,"E"))
 . S @ILABEL@("date")=$G(PHPATARR(FNBR17,IENS17,1,"E"))
 . S @ILABEL@("dateFM")=$G(PHPATARR(FNBR17,IENS17,1,"I"))
 . S @ILABEL@("dateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR17,IENS17,1,"I")))
 . S @ILABEL@("dateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR17,IENS17,1,"I")))
 . S @ILABEL@("action")=$G(PHPATARR(FNBR17,IENS17,2,"E"))
 . S @ILABEL@("actionCd")=$G(PHPATARR(FNBR17,IENS17,2,"I"))
 . S @ILABEL@("user")=$G(PHPATARR(FNBR17,IENS17,3,"E"))
 . S @ILABEL@("labels")=$G(PHPATARR(FNBR17,IENS17,4,"E"))
 . S @ILABEL@("track")=$G(PHPATARR(FNBR17,IENS17,5,"E"))
 . S @ILABEL@("trackCd")=$G(PHPATARR(FNBR17,IENS17,5,"I"))
 . S @ILABEL@("dailyUsage")=$G(PHPATARR(FNBR17,IENS17,6,"E"))
 . S @ILABEL@("dailyUsageCd")=$G(PHPATARR(FNBR17,IENS17,6,"I"))
 . S @ILABEL@("error")=$G(PHPATARR(FNBR17,IENS17,7,"E"))
 . S @ILABEL@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_$P(IENS17,C,2)_U_FNBR17_U_+IENS17)
 ;
 N IENS18 S IENS18=""
 F  S IENS18=$O(PHPATARR(FNBR18,IENS18)) QUIT:IENS18=""  D
 . N ILAST S ILAST=$NA(PHPAT("Phpat","ivs","iv",$P(IENS18,C,2),"lastRenews","lastRenew",+IENS18))
 . S @ILAST@("lastRenew")=$G(PHPATARR(FNBR18,IENS18,.01,"E"))
 . S @ILAST@("lastRenewFM")=$G(PHPATARR(FNBR18,IENS18,.01,"I"))
 . S @ILAST@("lastRenewHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR18,IENS18,.01,"I")))
 . S @ILAST@("lastRenewFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR18,IENS18,.01,"I")))
 . S @ILAST@("renewedBy")=$G(PHPATARR(FNBR18,IENS18,1,"E"))
 . S @ILAST@("renewedById")=$G(PHPATARR(FNBR18,IENS18,1,"I"))
 . S @ILAST@("renewedByNPI")=$$GET1^DIQ(200,@ILAST@("renewedById")_",",41.99) ;NPI
 . S @ILAST@("renewedByResId")=$$RESID^SYNDHP69("V",SITE,200,@ILAST@("renewedById"))
 . S @ILAST@("previousProvider")=$G(PHPATARR(FNBR18,IENS18,2,"E"))
 . S @ILAST@("previousProviderId")=$G(PHPATARR(FNBR18,IENS18,2,"I"))
 . S @ILAST@("previousProviderNPI")=$$GET1^DIQ(200,@ILAST@("previousProviderId")_",",41.99) ;NPI
 . S @ILAST@("previousStopDateTime")=$G(PHPATARR(FNBR18,IENS18,3,"E"))
 . S @ILAST@("previousStopDateTimeFM")=$G(PHPATARR(FNBR18,IENS18,3,"I"))
 . S @ILAST@("previousStopDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR18,IENS18,3,"I")))
 . S @ILAST@("previousStopDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR18,IENS18,3,"I")))
 . S @ILAST@("previousOrdersFileEntry")=$G(PHPATARR(FNBR18,IENS18,4,"E"))
 . S @ILAST@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_$P(IENS18,C,2)_U_FNBR18_U_+IENS18)
 ;
 N IENS19 S IENS19=""
 F  S IENS19=$O(PHPATARR(FNBR19,IENS19)) QUIT:IENS19=""  D
 . N IINTR S IINTR=$NA(PHPAT("Phpat","ivs","iv",$P(IENS19,C,2),"interventions","intervention",+IENS19))
 . S @IINTR@("intervention")=$G(PHPATARR(FNBR19,IENS19,.01,"E"))
 . S @IINTR@("interventionId")=$G(PHPATARR(FNBR19,IENS19,.01,"I"))
 . S @IINTR@("interventionDateTime")=$G(PHPATARR(FNBR19,IENS19,1,"E"))
 . S @IINTR@("interventionDateTimeFM")=$G(PHPATARR(FNBR19,IENS19,1,"I"))
 . S @IINTR@("interventionDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR19,IENS19,1,"I")))
 . S @IINTR@("interventionDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR19,IENS19,1,"I")))
 . S @IINTR@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR11_U_$P(IENS19,C,2)_U_FNBR19_U_+IENS19)
 ;
 N IENS20 S IENS20=""
 F  S IENS20=$O(PHPATARR(FNBR20,IENS20)) QUIT:IENS20=""  D
 . N ARCHDT S ARCHDT=$NA(PHPAT("Phpat","archiveDates","archiveDate",+IENS20))
 . S @ARCHDT@("archiveDate")=$G(PHPATARR(FNBR20,IENS20,.01,"E"))
 . S @ARCHDT@("archiveDateFM")=$G(PHPATARR(FNBR20,IENS20,.01,"I"))
 . S @ARCHDT@("archiveDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR20,IENS20,.01,"I")))
 . S @ARCHDT@("archiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR20,IENS20,.01,"I")))
 . S @ARCHDT@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR20_U_+IENS20)
 ;
 N IENS21 S IENS21=""
 F  S IENS21=$O(PHPATARR(FNBR21,IENS21)) QUIT:IENS21=""  D
 . N RXLIST S RXLIST=$NA(PHPAT("Phpat","archiveDates","archiveDate",$P(IENS21,C,2),"rxLists","rxList",+IENS21))
 . S @RXLIST@("rxList")=$G(PHPATARR(FNBR21,IENS21,.01,"E"))
 . S @RXLIST@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR20_U_$P(IENS21,C,2)_U_FNBR21_U_+IENS21)
 ;
 N IENS22 S IENS22=""
 F  S IENS22=$O(PHPATARR(FNBR22,IENS22)) QUIT:IENS22=""  D
 . N BCMA S BCMA=$NA(PHPAT("Phpat","bcmaIds","bcmaId",+IENS22))
 . S @BCMA@("bcmaId")=$G(PHPATARR(FNBR22,IENS22,.01,"E"))
 . S @BCMA@("on")=$G(PHPATARR(FNBR22,IENS22,.02,"E"))
 . S @BCMA@("bcmaStatusDateTime")=$G(PHPATARR(FNBR22,IENS22,1,"E"))
 . S @BCMA@("bcmaStatusDateTimeFM")=$G(PHPATARR(FNBR22,IENS22,1,"I"))
 . S @BCMA@("bcmaStatusDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR22,IENS22,1,"I")))
 . S @BCMA@("bcmaStatusDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR22,IENS22,1,"I")))
 . S @BCMA@("bcmaStatus")=$G(PHPATARR(FNBR22,IENS22,2,"E"))
 . S @BCMA@("bcmaStatusCd")=$G(PHPATARR(FNBR22,IENS22,2,"I"))
 . S @BCMA@("usageCount")=$G(PHPATARR(FNBR22,IENS22,3,"E"))
 . S @BCMA@("usageCountCd")=$G(PHPATARR(FNBR22,IENS22,3,"I"))
 . S @BCMA@("labelDate")=$G(PHPATARR(FNBR22,IENS22,4,"E"))
 . S @BCMA@("labelDateFM")=$G(PHPATARR(FNBR22,IENS22,4,"I"))
 . S @BCMA@("labelDateHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR22,IENS22,4,"I")))
 . S @BCMA@("labelDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR22,IENS22,4,"I")))
 . S @BCMA@("labelStatus")=$G(PHPATARR(FNBR22,IENS22,5,"E"))
 . S @BCMA@("labelStatusCd")=$G(PHPATARR(FNBR22,IENS22,5,"I"))
 . S @BCMA@("bag")=$G(PHPATARR(FNBR22,IENS22,6,"E"))
 . S @BCMA@("invalidDateTime")=$G(PHPATARR(FNBR22,IENS22,9,"E"))
 . S @BCMA@("invalidDateTimeFM")=$G(PHPATARR(FNBR22,IENS22,9,"I"))
 . S @BCMA@("invalidDateTimeHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR22,IENS22,9,"I")))
 . S @BCMA@("invalidDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR22,IENS22,9,"I")))
 . S @BCMA@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR22_U_+IENS22)
 ;
 N IENS23 S IENS23=""
 F  S IENS23=$O(PHPATARR(FNBR23,IENS23)) QUIT:IENS23=""  D
 . N BADD S BADD=$NA(PHPAT("Phpat","bcmaIds","bcmaId",$P(IENS23,C,2),"additives","additive",+IENS23))
 . S @BADD@("additive")=$G(PHPATARR(FNBR23,IENS23,.01,"E"))
 . S @BADD@("additiveId")=$G(PHPATARR(FNBR23,IENS23,.01,"I"))
 . S @BADD@("additiveGenericName")=$$GET1^DIQ(52.6,@BADD@("additiveId")_",",1)
 . S @BADD@("additiveGenericNameId")=$$GET1^DIQ(52.6,@BADD@("additiveId")_",",1,"I")
 . S @BADD@("additiveRxNorm")=$$GETRXN^SYNDHPUTL(@BADD@("additiveGenericNameId"))
 . S @BADD@("strength")=$G(PHPATARR(FNBR23,IENS23,1,"E"))
 . S @BADD@("bottle")=$G(PHPATARR(FNBR23,IENS23,2,"E"))
 . S @BADD@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR22_U_$P(IENS23,C,2)_U_FNBR23_U_+IENS23)
 ;
 N IENS24 S IENS24=""
 F  S IENS24=$O(PHPATARR(FNBR24,IENS24)) QUIT:IENS24=""  D
 . N BSOL S BSOL=$NA(PHPAT("Phpat","bcmaIds","bcmaId",$P(IENS24,C,2),"solutions","solution",+IENS24))
 . S @BSOL@("solution")=$G(PHPATARR(FNBR24,IENS24,.01,"E"))
 . S @BSOL@("solutionId")=$G(PHPATARR(FNBR24,IENS24,.01,"I"))
 . S @BSOL@("solutionGenericName")=$$GET1^DIQ(52.7,@BSOL@("solutionId")_",",1)
 . S @BSOL@("solutionGenericNameId")=$$GET1^DIQ(52.7,@BSOL@("solutionId")_",",1,"I")
 . S @BSOL@("solutionRxNorm")=$$GETRXN^SYNDHPUTL(@BSOL@("solutionGenericNameId"))
 . S @BSOL@("volume")=$G(PHPATARR(FNBR24,IENS24,1,"E"))
 . S @BSOL@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR22_U_$P(IENS24,C,2)_U_FNBR24_U_+IENS24)
 ;
 N IENS25 S IENS25=""
 F  S IENS25=$O(PHPATARR(FNBR25,IENS25)) QUIT:IENS25=""  D
 . N TALK S TALK=$NA(PHPAT("Phpat","scriptalkEnrollmentActivitys","scriptalkEnrollmentActivity",+IENS25))
 . S @TALK@("scriptalkEnrollmentActivity")=$G(PHPATARR(FNBR25,IENS25,.01,"E"))
 . S @TALK@("scriptalkEnrollmentActivityFM")=$G(PHPATARR(FNBR25,IENS25,.01,"I"))
 . S @TALK@("scriptalkEnrollmentActivityHL7")=$$FMTHL7^XLFDT($G(PHPATARR(FNBR25,IENS25,.01,"I")))
 . S @TALK@("scriptalkEnrollmentActivityFHIR")=$$FMTFHIR^SYNDHPUTL($G(PHPATARR(FNBR25,IENS25,.01,"I")))
 . S @TALK@("scriptalkPatient")=$G(PHPATARR(FNBR25,IENS25,1,"E"))
 . S @TALK@("scriptalkPatientCd")=$G(PHPATARR(FNBR25,IENS25,1,"I"))
 . S @TALK@("indication")=$G(PHPATARR(FNBR25,IENS25,2,"E"))
 . S @TALK@("indicationCd")=$G(PHPATARR(FNBR25,IENS25,2,"I"))
 . S @TALK@("user")=$G(PHPATARR(FNBR25,IENS25,3,"E"))
 . S @TALK@("userId")=$G(PHPATARR(FNBR25,IENS25,3,"I"))
 . S @TALK@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,PHPATIEN,FNBR25_U_+IENS25)
 ;
 QUIT
 ;

SYNDHP31
SYNDHP31 ; HC/art - HealthConcourse - get Patient Surgery data ;08/29/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;-------------------------------------------------------------
 ;
GET1SURG(SURG,SURGIEN,RETJSON,SURGJ) ;get one Patient Surgery record
 ;inputs: SURGIEN - Patient Surgery IEN
 ;        RETJSON - J = Return JSON
 ;output: SURG  - array of Patient Surgery data, by reference
 ;        SURGJ - JSON structure of Patient Surgery data, by reference
 ;
 I $G(DEBUG) W !,"--------------------------- Patient Surgery -----------------------------",!
 N S S S="_"
 N C S C=","
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=130 ;SURGERY
 N FNBR2 S FNBR2=130.28 ;OR CIRC SUPPORT
 N FNBR3 S FNBR3=130.29 ;TIME ON
 N FNBR4 S FNBR4=130.36 ;OR SCRUB SUPPORT
 N FNBR5 S FNBR5=130.37 ;TIME ON
 N FNBR6 S FNBR6=130.31 ;RESTR & POSITION AIDS
 N FNBR7 S FNBR7=130.213 ;ANES CARE TIME BLOCK
 N FNBR8 S FNBR8=130.04 ;REPLACEMENT FLUID TYPE
 N FNBR9 S FNBR9=130.41 ;MONITORS
 N FNBR10 S FNBR10=130.3513 ;ANES CONCURRENT CASES
 N FNBR11 S FNBR11=130.06 ;ANESTHESIA TECHNIQUE
 N FNBR12 S FNBR12=130.47 ;ANESTHESIA AGENTS
 N FNBR13 S FNBR13=130.48 ;TEST DOSE
 N FNBR14 S FNBR14=130.49 ;BLOCK SITE
 N FNBR15 S FNBR15=130.33 ;MEDICATIONS
 N FNBR16 S FNBR16=130.34 ;TIME ADM
 N FNBR17 S FNBR17=130.08 ;IRRIGATION
 N FNBR18 S FNBR18=130.39 ;TIME
 N FNBR19 S FNBR19=130.16 ;OTHER PROCEDURES
 N FNBR20 S FNBR20=130.164 ;OTHER PROCEDURE CPT MODIFIER
 N FNBR21 S FNBR21=130.165 ;OTHER ASSOC DIAGNOSIS
 N FNBR22 S FNBR22=130.01 ;PROSTHESIS INSTALLED
 N FNBR23 S FNBR23=130.02 ;TIME TOURNIQUET APPLIED
 N FNBR24 S FNBR24=130.17 ;OTHER PREOP DIAGNOSIS
 N FNBR25 S FNBR25=130.18 ;OTHER POSTOP DIAGS
 N FNBR26 S FNBR26=130.32 ;THERMAL UNIT
 N FNBR27 S FNBR27=130.14 ;REQ BLOOD KIND
 N FNBR28 S FNBR28=130.13 ;INTRAOPERATIVE OCCURRENCES
 N FNBR29 S FNBR29=130.43 ;RETURNED TO SURGERY
 N FNBR30 S FNBR30=130.22 ;POSTOP OCCURRENCE
 N FNBR31 S FNBR31=130.03 ;REFERRING PHYSICIAN
 N FNBR32 S FNBR32=130.275 ;PRIN ASSOC DIAGNOSIS
 N FNBR33 S FNBR33=130.028 ;PRIN. PROCEDURE CPT MODIFIER
 N FNBR34 S FNBR34=130.23 ;OTHER SCRUBBED ASSISTANTS
 N FNBR35 S FNBR35=130.24 ;OTHER PERSONS IN OR
 N FNBR36 S FNBR36=130.042 ;DELAY CAUSE
 N FNBR37 S FNBR37=130.053 ;NON-OPERATIVE OCCURRENCES
 N FNBR38 S FNBR38=130.065 ;SURGERY POSITION
 N FNBR39 S FNBR39=130.0126 ;PROCEDURE OCCURRENCE
 N FNBR40 S FNBR40=130.0129 ;LASER UNIT
 N FNBR41 S FNBR41=130.013 ;CELL SAVER
 N FNBR42 S FNBR42=130.0134 ;DISPOSABLES USED
 N FNBR43 S FNBR43=130.11 ;LASER PERFORMED
 N FNBR44 S FNBR44=130.1115 ;PATIENT PRECAUTIONS
 N FNBR45 S FNBR45=130.1118 ;PERSONNEL PRECAUTIONS
 N FNBR46 S FNBR46=130.0647 ;ORGANS TO BE TRANSPLANTED
 N FNBR47 S FNBR47=130.0664 ;DONOR VESSEL UNOS ID
 N FNBR48 S FNBR48=130.25 ;SPECIAL EQUIPMENT
 N FNBR49 S FNBR49=130.0681 ;PLANNED IMPLANTS
 N FNBR50 S FNBR50=130.0682 ;SPECIAL SUPPLIES
 N FNBR51 S FNBR51=130.0683 ;SPECIAL INSTRUMENTS
 N FNBR52 S FNBR52=130.0684 ;PHARMACY ITEMS
 N FNBR53 S FNBR53=130.02005 ;IMAGE
 N IENS1 S IENS1=SURGIEN_","
 ;
 N SURGARR,SURGERR
 D GETS^DIQ(FNBR1,IENS1,"**","EI","SURGARR","SURGERR")
 I $G(DEBUG) W !,$$ZW^SYNDHPUTL("SURGARR")
 I $G(DEBUG),$D(SURGERR) W !,">>ERROR<<" W !,$$ZW^SYNDHPUTL("SURGERR")
 I $D(SURGERR),SURGERR("DIERR",1)=601 D  QUIT
 . S SURG("Surg","ERROR")=SURGIEN
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.SURG,.SURGJ)
 S SURG("Surg","surgIen")=SURGIEN
 S SURG("Surg","resourceType")="Procedure"
 S SURG("Surg","resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN)
 S SURG("Surg","patient")=$G(SURGARR(FNBR1,IENS1,.01,"E"))
 S SURG("Surg","patientId")=$G(SURGARR(FNBR1,IENS1,.01,"I"))
 S SURG("Surg","patientICN")=$$GET1^DIQ(2,SURG("Surg","patientId")_",",991.1)
 S SURG("Surg","hospitalAdmissionStatus")=$G(SURGARR(FNBR1,IENS1,.011,"E"))
 S SURG("Surg","hospitalAdmissionStatusCd")=$G(SURGARR(FNBR1,IENS1,.011,"I"))
 S SURG("Surg","plannedAdmissionStatus")=$G(SURGARR(FNBR1,IENS1,.013,"E"))
 S SURG("Surg","plannedAdmissionStatusCd")=$G(SURGARR(FNBR1,IENS1,.013,"I"))
 S SURG("Surg","visit")=$G(SURGARR(FNBR1,IENS1,.015,"E"))
 S SURG("Surg","visitId")=$G(SURGARR(FNBR1,IENS1,.015,"I"))
 S SURG("Surg","visitFM")=$$GET1^DIQ(9000010,SURG("Surg","visitId")_",",.01,"I")
 S SURG("Surg","visitHL7")=$$FMTHL7^XLFDT(SURG("Surg","visitFM"))
 S SURG("Surg","visitFHIR")=$$FMTFHIR^SYNDHPUTL(SURG("Surg","visitFM"))
 S SURG("Surg","visitResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","visitId"))
 S SURG("Surg","classificationEnteredYN")=$G(SURGARR(FNBR1,IENS1,.0155,"E"))
 S SURG("Surg","classificationEnteredYNCd")=$G(SURGARR(FNBR1,IENS1,.0155,"I"))
 S SURG("Surg","serviceConnected")=$G(SURGARR(FNBR1,IENS1,.016,"E"))
 S SURG("Surg","serviceConnectedCd")=$G(SURGARR(FNBR1,IENS1,.016,"I"))
 S SURG("Surg","agentOrangeExposure")=$G(SURGARR(FNBR1,IENS1,.017,"E"))
 S SURG("Surg","agentOrangeExposureCd")=$G(SURGARR(FNBR1,IENS1,.017,"I"))
 S SURG("Surg","ionizingRadiationExposure")=$G(SURGARR(FNBR1,IENS1,.018,"E"))
 S SURG("Surg","ionizingRadiationExposureCd")=$G(SURGARR(FNBR1,IENS1,.018,"I"))
 S SURG("Surg","southwestAsiaConditions")=$G(SURGARR(FNBR1,IENS1,.019,"E"))
 S SURG("Surg","southwestAsiaConditionsCd")=$G(SURGARR(FNBR1,IENS1,.019,"I"))
 S SURG("Surg","opRoomProcedurePerformed")=$G(SURGARR(FNBR1,IENS1,.02,"E"))
 S SURG("Surg","opRoomProcedurePerformedId")=$G(SURGARR(FNBR1,IENS1,.02,"I"))
 S SURG("Surg","associatedClinic")=$G(SURGARR(FNBR1,IENS1,.021,"E"))
 S SURG("Surg","associatedClinicId")=$G(SURGARR(FNBR1,IENS1,.021,"I"))
 S SURG("Surg","militarySexualTrauma")=$G(SURGARR(FNBR1,IENS1,.022,"E"))
 S SURG("Surg","militarySexualTraumaCd")=$G(SURGARR(FNBR1,IENS1,.022,"I"))
 S SURG("Surg","headAndOrNeckCancer")=$G(SURGARR(FNBR1,IENS1,.023,"E"))
 S SURG("Surg","headAndOrNeckCancerCd")=$G(SURGARR(FNBR1,IENS1,.023,"I"))
 S SURG("Surg","combatVet")=$G(SURGARR(FNBR1,IENS1,.024,"E"))
 S SURG("Surg","combatVetCd")=$G(SURGARR(FNBR1,IENS1,.024,"I"))
 S SURG("Surg","proj112Shad")=$G(SURGARR(FNBR1,IENS1,.026,"E"))
 S SURG("Surg","proj112ShadCd")=$G(SURGARR(FNBR1,IENS1,.026,"I"))
 S SURG("Surg","majorMinor")=$G(SURGARR(FNBR1,IENS1,.03,"E"))
 S SURG("Surg","majorMinorCd")=$G(SURGARR(FNBR1,IENS1,.03,"I"))
 S SURG("Surg","caseScheduleType")=$G(SURGARR(FNBR1,IENS1,.035,"E"))
 S SURG("Surg","caseScheduleTypeCd")=$G(SURGARR(FNBR1,IENS1,.035,"I"))
 S SURG("Surg","caseScheduleOrder")=$G(SURGARR(FNBR1,IENS1,.037,"E"))
 S SURG("Surg","surgerySpecialty")=$G(SURGARR(FNBR1,IENS1,.04,"E"))
 S SURG("Surg","surgerySpecialtyId")=$G(SURGARR(FNBR1,IENS1,.04,"I"))
 S SURG("Surg","preoperativeInfection")=$G(SURGARR(FNBR1,IENS1,.05,"E"))
 S SURG("Surg","preoperativeInfectionCd")=$G(SURGARR(FNBR1,IENS1,.05,"I"))
 S SURG("Surg","preopSkinInteg")=$G(SURGARR(FNBR1,IENS1,.07,"E"))
 S SURG("Surg","preopSkinIntegId")=$G(SURGARR(FNBR1,IENS1,.07,"I"))
 S SURG("Surg","preopSkinColor")=$G(SURGARR(FNBR1,IENS1,.08,"E"))
 S SURG("Surg","preopSkinColorCd")=$G(SURGARR(FNBR1,IENS1,.08,"I"))
 S SURG("Surg","dateOfOperation")=$G(SURGARR(FNBR1,IENS1,.09,"E"))
 S SURG("Surg","dateOfOperationFM")=$G(SURGARR(FNBR1,IENS1,.09,"I"))
 S SURG("Surg","dateOfOperationHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.09,"I")))
 S SURG("Surg","dateOfOperationFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.09,"I")))
 S SURG("Surg","transToOrBy")=$G(SURGARR(FNBR1,IENS1,.11,"E"))
 S SURG("Surg","transToOrById")=$G(SURGARR(FNBR1,IENS1,.11,"I"))
 S SURG("Surg","hairRemovalBy")=$G(SURGARR(FNBR1,IENS1,.12,"E"))
 S SURG("Surg","hairRemovalById")=$G(SURGARR(FNBR1,IENS1,.12,"I"))
 S SURG("Surg","hairRemovalByResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","hairRemovalById"))
 S SURG("Surg","primarySurgeon")=$G(SURGARR(FNBR1,IENS1,.14,"E"))
 S SURG("Surg","primarySurgeonId")=$G(SURGARR(FNBR1,IENS1,.14,"I"))
 S SURG("Surg","primarySurgeonResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","primarySurgeonId"))
 S SURG("Surg","firstAsst")=$G(SURGARR(FNBR1,IENS1,.15,"E"))
 S SURG("Surg","firstAsstId")=$G(SURGARR(FNBR1,IENS1,.15,"I"))
 S SURG("Surg","firstAsstResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","firstAsstId"))
 S SURG("Surg","secondAsst")=$G(SURGARR(FNBR1,IENS1,.16,"E"))
 S SURG("Surg","secondAsstId")=$G(SURGARR(FNBR1,IENS1,.16,"I"))
 S SURG("Surg","secondAsstResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","secondAsstId"))
 S SURG("Surg","attendingSurgeon")=$G(SURGARR(FNBR1,IENS1,.164,"E"))
 S SURG("Surg","attendingSurgeonId")=$G(SURGARR(FNBR1,IENS1,.164,"I"))
 S SURG("Surg","attendingSurgeonResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","attendingSurgeonId"))
 S SURG("Surg","attendingResSupCode")=$G(SURGARR(FNBR1,IENS1,.166,"E"))
 S SURG("Surg","attendingResSupCodeId")=$G(SURGARR(FNBR1,IENS1,.166,"I"))
 S SURG("Surg","perfusionist")=$G(SURGARR(FNBR1,IENS1,.167,"E"))
 S SURG("Surg","perfusionistId")=$G(SURGARR(FNBR1,IENS1,.167,"I"))
 S SURG("Surg","asstPerfusionist")=$G(SURGARR(FNBR1,IENS1,.168,"E"))
 S SURG("Surg","asstPerfusionistId")=$G(SURGARR(FNBR1,IENS1,.168,"I"))
 S SURG("Surg","asstPerfusionistResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","asstPerfusionistId"))
 S SURG("Surg","skinPrepAgents")=$G(SURGARR(FNBR1,IENS1,.175,"E"))
 S SURG("Surg","skinPrepAgentsId")=$G(SURGARR(FNBR1,IENS1,.175,"I"))
 S SURG("Surg","skinPreppedBy1")=$G(SURGARR(FNBR1,IENS1,.18,"E"))
 S SURG("Surg","skinPreppedBy1Id")=$G(SURGARR(FNBR1,IENS1,.18,"I"))
 S SURG("Surg","skinPreppedBy1ResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","skinPreppedBy1Id"))
 S SURG("Surg","preopMood")=$G(SURGARR(FNBR1,IENS1,.19,"E"))
 S SURG("Surg","preopMoodId")=$G(SURGARR(FNBR1,IENS1,.19,"I"))
 S SURG("Surg","preopConverse")=$G(SURGARR(FNBR1,IENS1,.195,"E"))
 S SURG("Surg","preopConverseCd")=$G(SURGARR(FNBR1,IENS1,.195,"I"))
 S SURG("Surg","preopConscious")=$G(SURGARR(FNBR1,IENS1,.196,"E"))
 S SURG("Surg","preopConsciousId")=$G(SURGARR(FNBR1,IENS1,.196,"I"))
 S SURG("Surg","nursePresentTime")=$G(SURGARR(FNBR1,IENS1,.202,"E"))
 S SURG("Surg","nursePresentTimeFM")=$G(SURGARR(FNBR1,IENS1,.202,"I"))
 S SURG("Surg","nursePresentTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.202,"I")))
 S SURG("Surg","nursePresentTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.202,"I")))
 S SURG("Surg","timePatInHoldArea")=$G(SURGARR(FNBR1,IENS1,.203,"E"))
 S SURG("Surg","timePatInHoldAreaFM")=$G(SURGARR(FNBR1,IENS1,.203,"I"))
 S SURG("Surg","timePatInHoldAreaHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.203,"I")))
 S SURG("Surg","timePatInHoldAreaFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.203,"I")))
 S SURG("Surg","anesAvailTime")=$G(SURGARR(FNBR1,IENS1,.204,"E"))
 S SURG("Surg","anesAvailTimeFM")=$G(SURGARR(FNBR1,IENS1,.204,"I"))
 S SURG("Surg","anesAvailTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.204,"I")))
 S SURG("Surg","anesAvailTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.204,"I")))
 S SURG("Surg","timePatInOr")=$G(SURGARR(FNBR1,IENS1,.205,"E"))
 S SURG("Surg","timePatInOrFM")=$G(SURGARR(FNBR1,IENS1,.205,"I"))
 S SURG("Surg","timePatInOrHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.205,"I")))
 S SURG("Surg","timePatInOrFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.205,"I")))
 S SURG("Surg","surgPresentTime")=$G(SURGARR(FNBR1,IENS1,.206,"E"))
 S SURG("Surg","surgPresentTimeFM")=$G(SURGARR(FNBR1,IENS1,.206,"I"))
 S SURG("Surg","surgPresentTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.206,"I")))
 S SURG("Surg","surgPresentTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.206,"I")))
 S SURG("Surg","anesCareStartTime")=$G(SURGARR(FNBR1,IENS1,.21,"E"))
 S SURG("Surg","anesCareStartTimeFM")=$G(SURGARR(FNBR1,IENS1,.21,"I"))
 S SURG("Surg","anesCareStartTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.21,"I")))
 S SURG("Surg","anesCareStartTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.21,"I")))
 S SURG("Surg","anesCareBillableTimeFlag")=$G(SURGARR(FNBR1,IENS1,.214,"E"))
 S SURG("Surg","anesCareBillableTimeFlagCd")=$G(SURGARR(FNBR1,IENS1,.214,"I"))
 S SURG("Surg","inductionComplete")=$G(SURGARR(FNBR1,IENS1,.215,"E"))
 S SURG("Surg","inductionCompleteFM")=$G(SURGARR(FNBR1,IENS1,.215,"I"))
 S SURG("Surg","inductionCompleteHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.215,"I")))
 S SURG("Surg","inductionCompleteFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.215,"I")))
 S SURG("Surg","anesCareBillableTime")=$G(SURGARR(FNBR1,IENS1,.218,"E"))
 S SURG("Surg","timeOperationBegan")=$G(SURGARR(FNBR1,IENS1,.22,"E"))
 S SURG("Surg","timeOperationBeganFM")=$G(SURGARR(FNBR1,IENS1,.22,"I"))
 S SURG("Surg","timeOperationBeganHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.22,"I")))
 S SURG("Surg","timeOperationBeganFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.22,"I")))
 S SURG("Surg","timeOperationEnds")=$G(SURGARR(FNBR1,IENS1,.23,"E"))
 S SURG("Surg","timeOperationEndsFM")=$G(SURGARR(FNBR1,IENS1,.23,"I"))
 S SURG("Surg","timeOperationEndsHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.23,"I")))
 S SURG("Surg","timeOperationEndsFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.23,"I")))
 S SURG("Surg","timePatOutOr")=$G(SURGARR(FNBR1,IENS1,.232,"E"))
 S SURG("Surg","timePatOutOrFM")=$G(SURGARR(FNBR1,IENS1,.232,"I"))
 S SURG("Surg","timePatOutOrHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.232,"I")))
 S SURG("Surg","timePatOutOrFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.232,"I")))
 S SURG("Surg","orCleanStartTime")=$G(SURGARR(FNBR1,IENS1,.234,"E"))
 S SURG("Surg","orCleanStartTimeFM")=$G(SURGARR(FNBR1,IENS1,.234,"I"))
 S SURG("Surg","orCleanStartTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.234,"I")))
 S SURG("Surg","orCleanStartTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.234,"I")))
 S SURG("Surg","orCleanEndTime")=$G(SURGARR(FNBR1,IENS1,.236,"E"))
 S SURG("Surg","orCleanEndTimeFM")=$G(SURGARR(FNBR1,IENS1,.236,"I"))
 S SURG("Surg","orCleanEndTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.236,"I")))
 S SURG("Surg","orCleanEndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.236,"I")))
 S SURG("Surg","anesCareEndTime")=$G(SURGARR(FNBR1,IENS1,.24,"E"))
 S SURG("Surg","anesCareEndTimeFM")=$G(SURGARR(FNBR1,IENS1,.24,"I"))
 S SURG("Surg","anesCareEndTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,.24,"I")))
 S SURG("Surg","anesCareEndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,.24,"I")))
 S SURG("Surg","bloodLossMl")=$G(SURGARR(FNBR1,IENS1,.25,"E"))
 S SURG("Surg","totalUrineOutputMl")=$G(SURGARR(FNBR1,IENS1,.255,"E"))
 S SURG("Surg","generalComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,.28,Z)) QUIT:'+Z  D
 . S SURG("Surg","generalComments")=SURG("Surg","generalComments")_$G(SURGARR(FNBR1,IENS1,.28,Z))
 S SURG("Surg","nursingCareComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,.29,Z)) QUIT:'+Z  D
 . S SURG("Surg","nursingCareComments")=SURG("Surg","nursingCareComments")_$G(SURGARR(FNBR1,IENS1,.29,Z))
 S SURG("Surg","princAnesthetist")=$G(SURGARR(FNBR1,IENS1,.31,"E"))
 S SURG("Surg","princAnesthetistId")=$G(SURGARR(FNBR1,IENS1,.31,"I"))
 S SURG("Surg","princAnesthetistResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","princAnesthetistId"))
 S SURG("Surg","reliefAnesthetist")=$G(SURGARR(FNBR1,IENS1,.32,"E"))
 S SURG("Surg","reliefAnesthetistId")=$G(SURGARR(FNBR1,IENS1,.32,"I"))
 S SURG("Surg","reliefAnesthetistResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","reliefAnesthetistId"))
 S SURG("Surg","asstAnesthetist")=$G(SURGARR(FNBR1,IENS1,.33,"E"))
 S SURG("Surg","asstAnesthetistId")=$G(SURGARR(FNBR1,IENS1,.33,"I"))
 S SURG("Surg","asstAnesthetistResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","asstAnesthetistId"))
 S SURG("Surg","anesthesiologistSupvr")=$G(SURGARR(FNBR1,IENS1,.34,"E"))
 S SURG("Surg","anesthesiologistSupvrId")=$G(SURGARR(FNBR1,IENS1,.34,"I"))
 S SURG("Surg","anesthesiologistSupvrResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","anesthesiologistSupvrId"))
 S SURG("Surg","anesSuperviseCode")=$G(SURGARR(FNBR1,IENS1,.345,"E"))
 S SURG("Surg","anesSuperviseCodeId")=$G(SURGARR(FNBR1,IENS1,.345,"I"))
 S SURG("Surg","anesPersonallyPerformed")=$G(SURGARR(FNBR1,IENS1,.3511,"E"))
 S SURG("Surg","anesPersonallyPerformedCd")=$G(SURGARR(FNBR1,IENS1,.3511,"I"))
 S SURG("Surg","numOfConcurrentAnesCases")=$G(SURGARR(FNBR1,IENS1,.3512,"E"))
 S SURG("Surg","anesMedicallyDirected")=$G(SURGARR(FNBR1,IENS1,.3514,"E"))
 S SURG("Surg","anesMedicallyDirectedCd")=$G(SURGARR(FNBR1,IENS1,.3514,"I"))
 S SURG("Surg","anesPhysicianAvailable")=$G(SURGARR(FNBR1,IENS1,.3515,"E"))
 S SURG("Surg","anesPhysicianAvailableCd")=$G(SURGARR(FNBR1,IENS1,.3515,"I"))
 S SURG("Surg","minIntraopTemperatureC")=$G(SURGARR(FNBR1,IENS1,.36,"E"))
 S SURG("Surg","plannedPostopCare")=$G(SURGARR(FNBR1,IENS1,.43,"E"))
 S SURG("Surg","plannedPostopCareId")=$G(SURGARR(FNBR1,IENS1,.43,"I"))
 S SURG("Surg","orSetUpTime")=$G(SURGARR(FNBR1,IENS1,.44,"E"))
 S SURG("Surg","opDisposition")=$G(SURGARR(FNBR1,IENS1,.46,"E"))
 S SURG("Surg","opDispositionId")=$G(SURGARR(FNBR1,IENS1,.46,"I"))
 S SURG("Surg","finalCountsVerifyCorrect")=$G(SURGARR(FNBR1,IENS1,.52,"E"))
 S SURG("Surg","finalCountsVerifyCorrectCd")=$G(SURGARR(FNBR1,IENS1,.52,"I"))
 S SURG("Surg","verifier")=$G(SURGARR(FNBR1,IENS1,.522,"E"))
 S SURG("Surg","verifierId")=$G(SURGARR(FNBR1,IENS1,.522,"I"))
 S SURG("Surg","verifierResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","verifierId"))
 S SURG("Surg","InstCntCorrect")=$G(SURGARR(FNBR1,IENS1,.523,"E"))
 S SURG("Surg","InstCntCorrectCd")=$G(SURGARR(FNBR1,IENS1,.523,"I"))
 S SURG("Surg","instCntVerfBy")=$G(SURGARR(FNBR1,IENS1,.525,"E"))
 S SURG("Surg","instCntVerfById")=$G(SURGARR(FNBR1,IENS1,.525,"I"))
 S SURG("Surg","instCntVerfByResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","instCntVerfById"))
 S SURG("Surg","electrogroundPosition")=$G(SURGARR(FNBR1,IENS1,.55,"E"))
 S SURG("Surg","electrogroundPositionId")=$G(SURGARR(FNBR1,IENS1,.55,"I"))
 S SURG("Surg","foleyCatheterSize")=$G(SURGARR(FNBR1,IENS1,.56,"E"))
 S SURG("Surg","foleyCatheterInsertedBy")=$G(SURGARR(FNBR1,IENS1,.57,"E"))
 S SURG("Surg","foleyCatheterInsertedById")=$G(SURGARR(FNBR1,IENS1,.57,"I"))
 S SURG("Surg","foleyCatheterInsertedByResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","foleyCatheterInsertedById"))
 S SURG("Surg","preopTemperature")=$G(SURGARR(FNBR1,IENS1,.61,"E"))
 S SURG("Surg","preopWeightKg")=$G(SURGARR(FNBR1,IENS1,.615,"E"))
 S SURG("Surg","preoperativeHeartRate")=$G(SURGARR(FNBR1,IENS1,.62,"E"))
 S SURG("Surg","preopBloodPressure")=$G(SURGARR(FNBR1,IENS1,.63,"E"))
 S SURG("Surg","preopRespiratoryRate")=$G(SURGARR(FNBR1,IENS1,.64,"E"))
 S SURG("Surg","finalAnesthesiaTempC")=$G(SURGARR(FNBR1,IENS1,.65,"E"))
 S SURG("Surg","postopPulse")=$G(SURGARR(FNBR1,IENS1,.66,"E"))
 S SURG("Surg","postopBp")=$G(SURGARR(FNBR1,IENS1,.67,"E"))
 S SURG("Surg","postopResp")=$G(SURGARR(FNBR1,IENS1,.68,"E"))
 S SURG("Surg","timeOutDocumentCompletedBy")=$G(SURGARR(FNBR1,IENS1,.69,"E"))
 S SURG("Surg","timeOutDocumentCompletedById")=$G(SURGARR(FNBR1,IENS1,.69,"I"))
 S SURG("Surg","timeOutDocumentCompletedByResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","timeOutDocumentCompletedById"))
 S SURG("Surg","electrocauteryUnit")=$G(SURGARR(FNBR1,IENS1,.75,"E"))
 S SURG("Surg","postopSkinInteg")=$G(SURGARR(FNBR1,IENS1,.76,"E"))
 S SURG("Surg","postopSkinIntegId")=$G(SURGARR(FNBR1,IENS1,.76,"I"))
 S SURG("Surg","postopSkinColor")=$G(SURGARR(FNBR1,IENS1,.77,"E"))
 S SURG("Surg","postopSkinColorCd")=$G(SURGARR(FNBR1,IENS1,.77,"I"))
 S SURG("Surg","pacuDisposition")=$G(SURGARR(FNBR1,IENS1,.79,"E"))
 S SURG("Surg","pacuDispositionId")=$G(SURGARR(FNBR1,IENS1,.79,"I"))
 S SURG("Surg","postopMood")=$G(SURGARR(FNBR1,IENS1,.81,"E"))
 S SURG("Surg","postopMoodId")=$G(SURGARR(FNBR1,IENS1,.81,"I"))
 S SURG("Surg","postopConvers")=$G(SURGARR(FNBR1,IENS1,.82,"E"))
 S SURG("Surg","postopConversCd")=$G(SURGARR(FNBR1,IENS1,.82,"I"))
 S SURG("Surg","postopConscious")=$G(SURGARR(FNBR1,IENS1,.821,"E"))
 S SURG("Surg","postopConsciousId")=$G(SURGARR(FNBR1,IENS1,.821,"I"))
 S SURG("Surg","endPulse")=$G(SURGARR(FNBR1,IENS1,.84,"E"))
 S SURG("Surg","endBp")=$G(SURGARR(FNBR1,IENS1,.85,"E"))
 S SURG("Surg","endResp")=$G(SURGARR(FNBR1,IENS1,.86,"E"))
 S SURG("Surg","packing")=$G(SURGARR(FNBR1,IENS1,.875,"E"))
 S SURG("Surg","packingCd")=$G(SURGARR(FNBR1,IENS1,.875,"I"))
 S SURG("Surg","patientEducationAssessment")=$G(SURGARR(FNBR1,IENS1,.971,"E"))
 S SURG("Surg","patientEducationAssessmentCd")=$G(SURGARR(FNBR1,IENS1,.971,"I"))
 S SURG("Surg","consentSigWit")=$G(SURGARR(FNBR1,IENS1,.972,"E"))
 S SURG("Surg","consentSigWitCd")=$G(SURGARR(FNBR1,IENS1,.972,"I"))
 S SURG("Surg","bathShampoo")=$G(SURGARR(FNBR1,IENS1,.973,"E"))
 S SURG("Surg","bathShampooCd")=$G(SURGARR(FNBR1,IENS1,.973,"I"))
 S SURG("Surg","recXrayReady")=$G(SURGARR(FNBR1,IENS1,.974,"E"))
 S SURG("Surg","recXrayReadyCd")=$G(SURGARR(FNBR1,IENS1,.974,"I"))
 S SURG("Surg","enemaSIfOrd")=$G(SURGARR(FNBR1,IENS1,.975,"E"))
 S SURG("Surg","enemaSIfOrdCd")=$G(SURGARR(FNBR1,IENS1,.975,"I"))
 S SURG("Surg","npoAsOrdClinMid")=$G(SURGARR(FNBR1,IENS1,.976,"E"))
 S SURG("Surg","npoAsOrdClinMidCd")=$G(SURGARR(FNBR1,IENS1,.976,"I"))
 S SURG("Surg","VerfifyIdTagSsnCd")=$G(SURGARR(FNBR1,IENS1,.981,"I"))
 S SURG("Surg","carePlanInChart")=$G(SURGARR(FNBR1,IENS1,.9811,"E"))
 S SURG("Surg","carePlanInChartCd")=$G(SURGARR(FNBR1,IENS1,.9811,"I"))
 S SURG("Surg","addressPlate")=$G(SURGARR(FNBR1,IENS1,.9812,"E"))
 S SURG("Surg","addressPlateCd")=$G(SURGARR(FNBR1,IENS1,.9812,"I"))
 S SURG("Surg","patientVoided")=$G(SURGARR(FNBR1,IENS1,.9813,"E"))
 S SURG("Surg","patientVoidedCd")=$G(SURGARR(FNBR1,IENS1,.9813,"I"))
 S SURG("Surg","preopMedRailUp")=$G(SURGARR(FNBR1,IENS1,.9814,"E"))
 S SURG("Surg","preopMedRailUpCd")=$G(SURGARR(FNBR1,IENS1,.9814,"I"))
 S SURG("Surg","prosthesisRem")=$G(SURGARR(FNBR1,IENS1,.982,"E"))
 S SURG("Surg","prosthesisRemCd")=$G(SURGARR(FNBR1,IENS1,.982,"I"))
 S SURG("Surg","cigMatchValRem")=$G(SURGARR(FNBR1,IENS1,.983,"E"))
 S SURG("Surg","cigMatchValRemCd")=$G(SURGARR(FNBR1,IENS1,.983,"I"))
 S SURG("Surg","valuablesSecured")=$G(SURGARR(FNBR1,IENS1,.984,"E"))
 S SURG("Surg","valuablesSecuredCd")=$G(SURGARR(FNBR1,IENS1,.984,"I"))
 S SURG("Surg","oralHygiene")=$G(SURGARR(FNBR1,IENS1,.985,"E"))
 S SURG("Surg","oralHygieneCd")=$G(SURGARR(FNBR1,IENS1,.985,"I"))
 S SURG("Surg","freshlyShaved")=$G(SURGARR(FNBR1,IENS1,.986,"E"))
 S SURG("Surg","freshlyShavedCd")=$G(SURGARR(FNBR1,IENS1,.986,"I"))
 S SURG("Surg","cleanDressing")=$G(SURGARR(FNBR1,IENS1,.987,"E"))
 S SURG("Surg","cleanDressingCd")=$G(SURGARR(FNBR1,IENS1,.987,"I"))
 S SURG("Surg","cleanHospCloth")=$G(SURGARR(FNBR1,IENS1,.988,"E"))
 S SURG("Surg","cleanHospClothCd")=$G(SURGARR(FNBR1,IENS1,.988,"I"))
 S SURG("Surg","levinTubeCath")=$G(SURGARR(FNBR1,IENS1,.989,"E"))
 S SURG("Surg","levinTubeCathCd")=$G(SURGARR(FNBR1,IENS1,.989,"I"))
 S SURG("Surg","uAIn48Hrs")=$G(SURGARR(FNBR1,IENS1,.991,"E"))
 S SURG("Surg","uAIn48HrsCd")=$G(SURGARR(FNBR1,IENS1,.991,"I"))
 S SURG("Surg","cbcIn48Hrs")=$G(SURGARR(FNBR1,IENS1,.992,"E"))
 S SURG("Surg","cbcIn48HrsCd")=$G(SURGARR(FNBR1,IENS1,.992,"I"))
 S SURG("Surg","bloodTypeXmatch")=$G(SURGARR(FNBR1,IENS1,.993,"E"))
 S SURG("Surg","bloodTypeXmatchCd")=$G(SURGARR(FNBR1,IENS1,.993,"I"))
 S SURG("Surg","chestXrayIn7Days")=$G(SURGARR(FNBR1,IENS1,.998,"E"))
 S SURG("Surg","chestXrayIn7DaysCd")=$G(SURGARR(FNBR1,IENS1,.998,"I"))
 S SURG("Surg","ekgIn24Hrs")=$G(SURGARR(FNBR1,IENS1,.999,"E"))
 S SURG("Surg","ekgIn24HrsCd")=$G(SURGARR(FNBR1,IENS1,.999,"I"))
 S SURG("Surg","reqAnesthesiaTechnique")=$G(SURGARR(FNBR1,IENS1,1.01,"E"))
 S SURG("Surg","reqAnesthesiaTechniqueCd")=$G(SURGARR(FNBR1,IENS1,1.01,"I"))
 S SURG("Surg","reqFrozSect")=$G(SURGARR(FNBR1,IENS1,1.02,"E"))
 S SURG("Surg","reqFrozSectCd")=$G(SURGARR(FNBR1,IENS1,1.02,"I"))
 S SURG("Surg","reqPreopXRay")=$G(SURGARR(FNBR1,IENS1,1.03,"E"))
 S SURG("Surg","intraoperativeXRays")=$G(SURGARR(FNBR1,IENS1,1.035,"E"))
 S SURG("Surg","intraoperativeXRaysCd")=$G(SURGARR(FNBR1,IENS1,1.035,"I"))
 S SURG("Surg","reqPhoto")=$G(SURGARR(FNBR1,IENS1,1.04,"E"))
 S SURG("Surg","reqPhotoCd")=$G(SURGARR(FNBR1,IENS1,1.04,"I"))
 S SURG("Surg","reqBloodAvail")=$G(SURGARR(FNBR1,IENS1,1.052,"E"))
 S SURG("Surg","reqBloodAvailCd")=$G(SURGARR(FNBR1,IENS1,1.052,"I"))
 S SURG("Surg","woundClassification")=$G(SURGARR(FNBR1,IENS1,1.09,"E"))
 S SURG("Surg","woundClassificationCd")=$G(SURGARR(FNBR1,IENS1,1.09,"I"))
 S SURG("Surg","dateTimeOrRequestMade")=$G(SURGARR(FNBR1,IENS1,1.098,"E"))
 S SURG("Surg","dateTimeOrRequestMadeFM")=$G(SURGARR(FNBR1,IENS1,1.098,"I"))
 S SURG("Surg","dateTimeOrRequestMadeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,1.098,"I")))
 S SURG("Surg","dateTimeOrRequestMadeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,1.098,"I")))
 S SURG("Surg","surgSchedPerson")=$G(SURGARR(FNBR1,IENS1,1.099,"E"))
 S SURG("Surg","surgSchedPersonId")=$G(SURGARR(FNBR1,IENS1,1.099,"I"))
 S SURG("Surg","pacUAdmitScore")=$G(SURGARR(FNBR1,IENS1,1.11,"E"))
 S SURG("Surg","pacUDischScore")=$G(SURGARR(FNBR1,IENS1,1.12,"E"))
 S SURG("Surg","asaClass")=$G(SURGARR(FNBR1,IENS1,1.13,"E"))
 S SURG("Surg","asaClassId")=$G(SURGARR(FNBR1,IENS1,1.13,"I"))
 S SURG("Surg","sugeonsDictation")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,1.15,Z)) QUIT:'+Z  D
 . S SURG("Surg","sugeonsDictation")=SURG("Surg","sugeonsDictation")_$G(SURGARR(FNBR1,IENS1,1.15,Z))
 S SURG("Surg","admitPacUTime")=$G(SURGARR(FNBR1,IENS1,1.17,"E"))
 S SURG("Surg","admitPacUTimeFM")=$G(SURGARR(FNBR1,IENS1,1.17,"I"))
 S SURG("Surg","admitPacUTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,1.17,"I")))
 S SURG("Surg","admitPacUTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,1.17,"I")))
 S SURG("Surg","pacUDischTime")=$G(SURGARR(FNBR1,IENS1,1.18,"E"))
 S SURG("Surg","pacUDischTimeFM")=$G(SURGARR(FNBR1,IENS1,1.18,"I"))
 S SURG("Surg","pacUDischTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,1.18,"I")))
 S SURG("Surg","pacUDischTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,1.18,"I")))
 S SURG("Surg","postopAnesNoteDate")=$G(SURGARR(FNBR1,IENS1,1.19,"E"))
 S SURG("Surg","postopAnesNoteDateFM")=$G(SURGARR(FNBR1,IENS1,1.19,"I"))
 S SURG("Surg","postopAnesNoteDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,1.19,"I")))
 S SURG("Surg","postopAnesNoteDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,1.19,"I")))
 S SURG("Surg","postopAnesNote")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,1.2,Z)) QUIT:'+Z  D
 . S SURG("Surg","postopAnesNote")=SURG("Surg","postopAnesNote")_$G(SURGARR(FNBR1,IENS1,1.2,Z))
 S SURG("Surg","operationTime")=$G(SURGARR(FNBR1,IENS1,1.21,"E"))
 S SURG("Surg","anesthInductTime")=$G(SURGARR(FNBR1,IENS1,1.22,"E"))
 S SURG("Surg","anesCareTime")=$G(SURGARR(FNBR1,IENS1,1.23,"E"))
 S SURG("Surg","patientInOrTime")=$G(SURGARR(FNBR1,IENS1,1.24,"E"))
 S SURG("Surg","orCleanUpTime")=$G(SURGARR(FNBR1,IENS1,1.25,"E"))
 S SURG("Surg","pacUTime")=$G(SURGARR(FNBR1,IENS1,1.26,"E"))
 S SURG("Surg","skinPreppedBy2")=$G(SURGARR(FNBR1,IENS1,4,"E"))
 S SURG("Surg","skinPreppedBy2Id")=$G(SURGARR(FNBR1,IENS1,4,"I"))
 S SURG("Surg","skinPreppedBy2ResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","skinPreppedBy2Id"))
 S SURG("Surg","skinPreppedBy3")=$G(SURGARR(FNBR1,IENS1,5,"E"))
 S SURG("Surg","skinPreppedBy3Id")=$G(SURGARR(FNBR1,IENS1,5,"I"))
 S SURG("Surg","skinPreppedBy3ResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","skinPreppedBy3Id"))
 S SURG("Surg","electrogroundPosition2")=$G(SURGARR(FNBR1,IENS1,6,"E"))
 S SURG("Surg","electrogroundPosition2Id")=$G(SURGARR(FNBR1,IENS1,6,"I"))
 S SURG("Surg","dressingCondition")=$G(SURGARR(FNBR1,IENS1,7,"E"))
 S SURG("Surg","dressingConditionCd")=$G(SURGARR(FNBR1,IENS1,7,"I"))
 S SURG("Surg","secondSkinPrepAgent")=$G(SURGARR(FNBR1,IENS1,8,"E"))
 S SURG("Surg","secondSkinPrepAgentId")=$G(SURGARR(FNBR1,IENS1,8,"I"))
 S SURG("Surg","timeNurseOutOfOr")=$G(SURGARR(FNBR1,IENS1,9,"E"))
 S SURG("Surg","timeNurseOutOfOrFM")=$G(SURGARR(FNBR1,IENS1,9,"I"))
 S SURG("Surg","timeNurseOutOfOrHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,9,"I")))
 S SURG("Surg","timeNurseOutOfOrFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,9,"I")))
 S SURG("Surg","scheduledStartTime")=$G(SURGARR(FNBR1,IENS1,10,"E"))
 S SURG("Surg","scheduledStartTimeFM")=$G(SURGARR(FNBR1,IENS1,10,"I"))
 S SURG("Surg","scheduledStartTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,10,"I")))
 S SURG("Surg","scheduledStartTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,10,"I")))
 S SURG("Surg","scheduledEndTime")=$G(SURGARR(FNBR1,IENS1,11,"E"))
 S SURG("Surg","scheduledEndTimeFM")=$G(SURGARR(FNBR1,IENS1,11,"I"))
 S SURG("Surg","scheduledEndTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,11,"I")))
 S SURG("Surg","scheduledEndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,11,"I")))
 S SURG("Surg","inOrToAnesStart")=$G(SURGARR(FNBR1,IENS1,12,"E"))
 S SURG("Surg","anesStartToOpStart")=$G(SURGARR(FNBR1,IENS1,13,"E"))
 S SURG("Surg","inOrToOpStartTime")=$G(SURGARR(FNBR1,IENS1,14,"E"))
 S SURG("Surg","dateTimeOfDictation")=$G(SURGARR(FNBR1,IENS1,15,"E"))
 S SURG("Surg","dateTimeOfDictationFM")=$G(SURGARR(FNBR1,IENS1,15,"I"))
 S SURG("Surg","dateTimeOfDictationHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,15,"I")))
 S SURG("Surg","dateTimeOfDictationFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,15,"I")))
 S SURG("Surg","cancelDate")=$G(SURGARR(FNBR1,IENS1,17,"E"))
 S SURG("Surg","cancelDateFM")=$G(SURGARR(FNBR1,IENS1,17,"I"))
 S SURG("Surg","cancelDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,17,"I")))
 S SURG("Surg","cancelDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,17,"I")))
 S SURG("Surg","cancellationTimeframe")=$G(SURGARR(FNBR1,IENS1,17.5,"E"))
 S SURG("Surg","cancellationTimeframeCd")=$G(SURGARR(FNBR1,IENS1,17.5,"I"))
 S SURG("Surg","primaryCancelReason")=$G(SURGARR(FNBR1,IENS1,18,"E"))
 S SURG("Surg","primaryCancelReasonId")=$G(SURGARR(FNBR1,IENS1,18,"I"))
 S SURG("Surg","caseAborted")=$G(SURGARR(FNBR1,IENS1,18.5,"E"))
 S SURG("Surg","caseAbortedCd")=$G(SURGARR(FNBR1,IENS1,18.5,"I"))
 S SURG("Surg","cancellationComments")=$G(SURGARR(FNBR1,IENS1,19,"E"))
 S SURG("Surg","diagnosticTherapeuticYN")=$G(SURGARR(FNBR1,IENS1,20,"E"))
 S SURG("Surg","diagnosticTherapeuticYNCd")=$G(SURGARR(FNBR1,IENS1,20,"I"))
 S SURG("Surg","waitTimeStart")=$G(SURGARR(FNBR1,IENS1,21,"E"))
 S SURG("Surg","waitTimeStartFM")=$G(SURGARR(FNBR1,IENS1,21,"I"))
 S SURG("Surg","waitTimeStartHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,21,"I")))
 S SURG("Surg","waitTimeStartFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,21,"I")))
 S SURG("Surg","tubesAndDrains")=$G(SURGARR(FNBR1,IENS1,22,"E"))
 S SURG("Surg","lockCase")=$G(SURGARR(FNBR1,IENS1,24,"E"))
 S SURG("Surg","lockCaseCd")=$G(SURGARR(FNBR1,IENS1,24,"I"))
 S SURG("Surg","dischargedVia")=$G(SURGARR(FNBR1,IENS1,25,"E"))
 S SURG("Surg","dischargedViaId")=$G(SURGARR(FNBR1,IENS1,25,"I"))
 S SURG("Surg","principalProcedure")=$G(SURGARR(FNBR1,IENS1,26,"E"))
 S SURG("Surg","plannedPrinProcedureCode")=$G(SURGARR(FNBR1,IENS1,27,"E"))
 S SURG("Surg","plannedPrinProcedureCodeId")=$G(SURGARR(FNBR1,IENS1,27,"I"))
 S SURG("Surg","principalPreOpDiagnosis")=$G(SURGARR(FNBR1,IENS1,32,"E"))
 S SURG("Surg","prinPreOpIcdDiagnosisCode")=$G(SURGARR(FNBR1,IENS1,32.5,"E"))
 S SURG("Surg","prinPreOpIcdDiagnosisCodeId")=$G(SURGARR(FNBR1,IENS1,32.5,"I"))
 S SURG("Surg","principalDiagnosis")=$G(SURGARR(FNBR1,IENS1,33,"E"))
 S SURG("Surg","principalPostOpDiag")=$G(SURGARR(FNBR1,IENS1,34,"E"))
 S SURG("Surg","concurrentCase")=$G(SURGARR(FNBR1,IENS1,35,"E"))
 S SURG("Surg","concurrentCaseId")=$G(SURGARR(FNBR1,IENS1,35,"I"))
 S SURG("Surg","requested")=$G(SURGARR(FNBR1,IENS1,36,"E"))
 S SURG("Surg","estimatedCaseLength")=$G(SURGARR(FNBR1,IENS1,37,"E"))
 S SURG("Surg","requestBloodAvailability")=$G(SURGARR(FNBR1,IENS1,38,"E"))
 S SURG("Surg","requestBloodAvailabilityCd")=$G(SURGARR(FNBR1,IENS1,38,"I"))
 S SURG("Surg","dateOfTranscription")=$G(SURGARR(FNBR1,IENS1,39,"E"))
 S SURG("Surg","dateOfTranscriptionFM")=$G(SURGARR(FNBR1,IENS1,39,"I"))
 S SURG("Surg","dateOfTranscriptionHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,39,"I")))
 S SURG("Surg","dateOfTranscriptionFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,39,"I")))
 S SURG("Surg","crossmatchScreenAutologous")=$G(SURGARR(FNBR1,IENS1,40,"E"))
 S SURG("Surg","crossmatchScreenAutologousCd")=$G(SURGARR(FNBR1,IENS1,40,"I"))
 S SURG("Surg","dressing")=$G(SURGARR(FNBR1,IENS1,41,"E"))
 S SURG("Surg","caseVerification")=$G(SURGARR(FNBR1,IENS1,43,"E"))
 S SURG("Surg","caseVerificationCd")=$G(SURGARR(FNBR1,IENS1,43,"I"))
 S SURG("Surg","spongeFinalCountCorrect")=$G(SURGARR(FNBR1,IENS1,44,"E"))
 S SURG("Surg","spongeFinalCountCorrectCd")=$G(SURGARR(FNBR1,IENS1,44,"I"))
 S SURG("Surg","sharpsFinalCountCorrect")=$G(SURGARR(FNBR1,IENS1,45,"E"))
 S SURG("Surg","sharpsFinalCountCorrectCd")=$G(SURGARR(FNBR1,IENS1,45,"I"))
 S SURG("Surg","instrumentFinalCountCorrect")=$G(SURGARR(FNBR1,IENS1,46,"E"))
 S SURG("Surg","instrumentFinalCountCorrectCd")=$G(SURGARR(FNBR1,IENS1,46,"I"))
 S SURG("Surg","spongeSharpsInstCounter")=$G(SURGARR(FNBR1,IENS1,47,"E"))
 S SURG("Surg","spongeSharpsInstCounterId")=$G(SURGARR(FNBR1,IENS1,47,"I"))
 S SURG("Surg","spongeSharpsInstCounterResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","spongeSharpsInstCounterId"))
 S SURG("Surg","countVerifier")=$G(SURGARR(FNBR1,IENS1,48,"E"))
 S SURG("Surg","countVerifierId")=$G(SURGARR(FNBR1,IENS1,48,"I"))
 S SURG("Surg","countVerifierResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","countVerifierId"))
 S SURG("Surg","specimens")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,49,Z)) QUIT:'+Z  D
 . S SURG("Surg","specimens")=SURG("Surg","specimens")_$G(SURGARR(FNBR1,IENS1,49,Z))
 S SURG("Surg","division")=$G(SURGARR(FNBR1,IENS1,50,"E"))
 S SURG("Surg","divisionId")=$G(SURGARR(FNBR1,IENS1,50,"I"))
 S SURG("Surg","preopAttendingConcurrence")=$G(SURGARR(FNBR1,IENS1,51,"E"))
 S SURG("Surg","preopAttendingConcurrenceCd")=$G(SURGARR(FNBR1,IENS1,51,"I"))
 S SURG("Surg","postopAttendingConcurrence")=$G(SURGARR(FNBR1,IENS1,52,"E"))
 S SURG("Surg","postopAttendingConcurrenceCd")=$G(SURGARR(FNBR1,IENS1,52,"I"))
 S SURG("Surg","occurrenceNoProcedure")=$G(SURGARR(FNBR1,IENS1,54,"E"))
 S SURG("Surg","occurrenceNoProcedureCd")=$G(SURGARR(FNBR1,IENS1,54,"I"))
 S SURG("Surg","indicationsForOperations")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,55,Z)) QUIT:'+Z  D
 . S SURG("Surg","indicationsForOperations")=SURG("Surg","indicationsForOperations")_$G(SURGARR(FNBR1,IENS1,55,Z))
 S SURG("Surg","preAdmissionTesting")=$G(SURGARR(FNBR1,IENS1,56,"E"))
 S SURG("Surg","preAdmissionTestingCd")=$G(SURGARR(FNBR1,IENS1,56,"I"))
 S SURG("Surg","esuCoagRange")=$G(SURGARR(FNBR1,IENS1,57,"E"))
 S SURG("Surg","esuCuttingRange")=$G(SURGARR(FNBR1,IENS1,58,"E"))
 S SURG("Surg","operativeFindings")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,59,Z)) QUIT:'+Z  D
 . S SURG("Surg","operativeFindings")=SURG("Surg","operativeFindings")_$G(SURGARR(FNBR1,IENS1,59,Z))
 ; 60        BRIEF CLIN HISTORY
 S SURG("Surg","briefClinHistory")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,60,Z)) QUIT:'+Z  D
 . S SURG("Surg","briefClinHistory")=SURG("Surg","briefClinHistory")_$G(SURGARR(FNBR1,IENS1,60,Z))
 S SURG("Surg","diagnosticResultsConfirmBy")=$G(SURGARR(FNBR1,IENS1,61,"E"))
 S SURG("Surg","diagnosticResultsConfirmById")=$G(SURGARR(FNBR1,IENS1,61,"I"))
 S SURG("Surg","diagnosticResultsConfirmByResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","diagnosticResultsConfirmById"))
 S SURG("Surg","gastricOutput")=$G(SURGARR(FNBR1,IENS1,62,"E"))
 S SURG("Surg","ivStartedBy")=$G(SURGARR(FNBR1,IENS1,63,"E"))
 S SURG("Surg","ivStartedById")=$G(SURGARR(FNBR1,IENS1,63,"I"))
 S SURG("Surg","ivStartedByResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","ivStartedById"))
 S SURG("Surg","cultures")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,64,Z)) QUIT:'+Z  D
 . S SURG("Surg","cultures")=SURG("Surg","cultures")_$G(SURGARR(FNBR1,IENS1,64,Z))
 S SURG("Surg","plannedPrinDiagnosisCode")=$G(SURGARR(FNBR1,IENS1,66,"E"))
 S SURG("Surg","plannedPrinDiagnosisCodeId")=$G(SURGARR(FNBR1,IENS1,66,"I"))
 S SURG("Surg","cancellationAvoidable")=$G(SURGARR(FNBR1,IENS1,67,"E"))
 S SURG("Surg","cancellationAvoidableCd")=$G(SURGARR(FNBR1,IENS1,67,"I"))
 S SURG("Surg","scheduledProcedure")=$G(SURGARR(FNBR1,IENS1,68,"E"))
 S SURG("Surg","codingVerifier")=$G(SURGARR(FNBR1,IENS1,69,"E"))
 S SURG("Surg","codingVerifierId")=$G(SURGARR(FNBR1,IENS1,69,"I"))
 S SURG("Surg","codingVerifierResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","codingVerifierId"))
 S SURG("Surg","cancelledBy")=$G(SURGARR(FNBR1,IENS1,70,"E"))
 S SURG("Surg","cancelledById")=$G(SURGARR(FNBR1,IENS1,70,"I"))
 S SURG("Surg","timeOutVerified")=$G(SURGARR(FNBR1,IENS1,71,"E"))
 S SURG("Surg","timeOutVerifiedCd")=$G(SURGARR(FNBR1,IENS1,71,"I"))
 S SURG("Surg","preoperativeImagingConfirmed")=$G(SURGARR(FNBR1,IENS1,72,"E"))
 S SURG("Surg","preoperativeImagingConfirmedCd")=$G(SURGARR(FNBR1,IENS1,72,"I"))
 S SURG("Surg","markedSiteConfirmed")=$G(SURGARR(FNBR1,IENS1,73,"E"))
 S SURG("Surg","markedSiteConfirmedCd")=$G(SURGARR(FNBR1,IENS1,73,"I"))
 S SURG("Surg","timeOutCompleted")=$G(SURGARR(FNBR1,IENS1,74,"E"))
 S SURG("Surg","timeOutCompletedFM")=$G(SURGARR(FNBR1,IENS1,74,"I"))
 S SURG("Surg","timeOutCompletedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,74,"I")))
 S SURG("Surg","timeOutCompletedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,74,"I")))
 S SURG("Surg","tovTimestamp")=$G(SURGARR(FNBR1,IENS1,75,"E"))
 S SURG("Surg","tovTimestampFM")=$G(SURGARR(FNBR1,IENS1,75,"I"))
 S SURG("Surg","tovTimestampHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,75,"I")))
 S SURG("Surg","tovTimestampFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,75,"I")))
 S SURG("Surg","imagTimestamp")=$G(SURGARR(FNBR1,IENS1,76,"E"))
 S SURG("Surg","imagTimestampFM")=$G(SURGARR(FNBR1,IENS1,76,"I"))
 S SURG("Surg","imagTimestampHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,76,"I")))
 S SURG("Surg","imagTimestampFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,76,"I")))
 S SURG("Surg","siteMarkTimestamp")=$G(SURGARR(FNBR1,IENS1,77,"E"))
 S SURG("Surg","siteMarkTimestampFM")=$G(SURGARR(FNBR1,IENS1,77,"I"))
 S SURG("Surg","siteMarkTimestampHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,77,"I")))
 S SURG("Surg","siteMarkTimestampFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,77,"I")))
 S SURG("Surg","previouslyScheduledCase")=$G(SURGARR(FNBR1,IENS1,78,"E"))
 S SURG("Surg","previouslyScheduledCaseId")=$G(SURGARR(FNBR1,IENS1,78,"I"))
 S SURG("Surg","rescheduledCase")=$G(SURGARR(FNBR1,IENS1,79,"E"))
 S SURG("Surg","rescheduledCaseId")=$G(SURGARR(FNBR1,IENS1,79,"I"))
 S SURG("Surg","spdComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,80,Z)) QUIT:'+Z  D
 . S SURG("Surg","spdComments")=SURG("Surg","spdComments")_$G(SURGARR(FNBR1,IENS1,80,Z))
 S SURG("Surg","dynamedNotified")=$G(SURGARR(FNBR1,IENS1,81,"E"))
 S SURG("Surg","dynamedNotifiedCd")=$G(SURGARR(FNBR1,IENS1,81,"I"))
 S SURG("Surg","timeOutVerifiedComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,82,Z)) QUIT:'+Z  D
 . S SURG("Surg","timeOutVerifiedComments")=SURG("Surg","timeOutVerifiedComments")_$G(SURGARR(FNBR1,IENS1,82,Z))
 S SURG("Surg","imagingConfirmedComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,83,Z)) QUIT:'+Z  D
 . S SURG("Surg","imagingConfirmedComments")=SURG("Surg","imagingConfirmedComments")_$G(SURGARR(FNBR1,IENS1,83,Z))
 S SURG("Surg","markedSiteComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,84,Z)) QUIT:'+Z  D
 . S SURG("Surg","markedSiteComments")=SURG("Surg","markedSiteComments")_$G(SURGARR(FNBR1,IENS1,84,Z))
 S SURG("Surg","checklistComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,85,Z)) QUIT:'+Z  D
 . S SURG("Surg","checklistComments")=SURG("Surg","checklistComments")_$G(SURGARR(FNBR1,IENS1,85,Z))
 S SURG("Surg","orderNumber")=$G(SURGARR(FNBR1,IENS1,100,"E"))
 S SURG("Surg","orderNumberId")=$G(SURGARR(FNBR1,IENS1,100,"I"))
 S SURG("Surg","staffResident")=$G(SURGARR(FNBR1,IENS1,101,"E"))
 S SURG("Surg","staffResidentCd")=$G(SURGARR(FNBR1,IENS1,101,"I"))
 S SURG("Surg","reasonForNoAssessment")=$G(SURGARR(FNBR1,IENS1,102,"E"))
 S SURG("Surg","reasonForNoAssessmentCd")=$G(SURGARR(FNBR1,IENS1,102,"I"))
 S SURG("Surg","anesthetistCategory")=$G(SURGARR(FNBR1,IENS1,103,"E"))
 S SURG("Surg","anesthetistCategoryCd")=$G(SURGARR(FNBR1,IENS1,103,"I"))
 S SURG("Surg","nonOrProcedure")=$G(SURGARR(FNBR1,IENS1,118,"E"))
 S SURG("Surg","nonOrProcedureCd")=$G(SURGARR(FNBR1,IENS1,118,"I"))
 S SURG("Surg","nonOrLocation")=$G(SURGARR(FNBR1,IENS1,119,"E"))
 S SURG("Surg","nonOrLocationId")=$G(SURGARR(FNBR1,IENS1,119,"I"))
 S SURG("Surg","dateOfProcedure")=$G(SURGARR(FNBR1,IENS1,120,"E"))
 S SURG("Surg","dateOfProcedureFM")=$G(SURGARR(FNBR1,IENS1,120,"I"))
 S SURG("Surg","dateOfProcedureHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,120,"I")))
 S SURG("Surg","dateOfProcedureFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,120,"I")))
 S SURG("Surg","timeProcedureBegan")=$G(SURGARR(FNBR1,IENS1,121,"E"))
 S SURG("Surg","timeProcedureBeganFM")=$G(SURGARR(FNBR1,IENS1,121,"I"))
 S SURG("Surg","timeProcedureBeganHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,121,"I")))
 S SURG("Surg","timeProcedureBeganFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,121,"I")))
 S SURG("Surg","timeProcedureEnded")=$G(SURGARR(FNBR1,IENS1,122,"E"))
 S SURG("Surg","timeProcedureEndedFM")=$G(SURGARR(FNBR1,IENS1,122,"I"))
 S SURG("Surg","timeProcedureEndedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,122,"I")))
 S SURG("Surg","timeProcedureEndedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,122,"I")))
 S SURG("Surg","provider")=$G(SURGARR(FNBR1,IENS1,123,"E"))
 S SURG("Surg","providerId")=$G(SURGARR(FNBR1,IENS1,123,"I"))
 S SURG("Surg","providerResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","providerId"))
 S SURG("Surg","attendProvider")=$G(SURGARR(FNBR1,IENS1,124,"E"))
 S SURG("Surg","attendProviderId")=$G(SURGARR(FNBR1,IENS1,124,"I"))
 S SURG("Surg","attendProviderResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","attendProviderId"))
 S SURG("Surg","medicalSpecialty")=$G(SURGARR(FNBR1,IENS1,125,"E"))
 S SURG("Surg","medicalSpecialtyId")=$G(SURGARR(FNBR1,IENS1,125,"I"))
 S SURG("Surg","sequentialCompressionDevice")=$G(SURGARR(FNBR1,IENS1,127,"E"))
 S SURG("Surg","sequentialCompressionDeviceCd")=$G(SURGARR(FNBR1,IENS1,127,"I"))
 S SURG("Surg","laserType")=$G(SURGARR(FNBR1,IENS1,128,"E"))
 S SURG("Surg","deviceS")=$G(SURGARR(FNBR1,IENS1,131,"E"))
 S SURG("Surg","spinalLevel")=$G(SURGARR(FNBR1,IENS1,136,"E"))
 S SURG("Surg","operationsThisAdmission")=$G(SURGARR(FNBR1,IENS1,200,"E"))
 S SURG("Surg","redoProcedure")=$G(SURGARR(FNBR1,IENS1,201,"E"))
 S SURG("Surg","redoProcedureCd")=$G(SURGARR(FNBR1,IENS1,201,"I"))
 S SURG("Surg","packYears")=$G(SURGARR(FNBR1,IENS1,202.1,"E"))
 S SURG("Surg","historyOfCopd")=$G(SURGARR(FNBR1,IENS1,203,"E"))
 S SURG("Surg","historyOfCopdCd")=$G(SURGARR(FNBR1,IENS1,203,"I"))
 S SURG("Surg","ventilatorDependent")=$G(SURGARR(FNBR1,IENS1,204,"E"))
 S SURG("Surg","ventilatorDependentCd")=$G(SURGARR(FNBR1,IENS1,204,"I"))
 S SURG("Surg","priorMi")=$G(SURGARR(FNBR1,IENS1,205,"E"))
 S SURG("Surg","priorMiCd")=$G(SURGARR(FNBR1,IENS1,205,"I"))
 S SURG("Surg","vascularYN")=$G(SURGARR(FNBR1,IENS1,206,"E"))
 S SURG("Surg","vascularYNCd")=$G(SURGARR(FNBR1,IENS1,206,"I"))
 S SURG("Surg","cardiomegaly")=$G(SURGARR(FNBR1,IENS1,209,"E"))
 S SURG("Surg","cardiomegalyCd")=$G(SURGARR(FNBR1,IENS1,209,"I"))
 S SURG("Surg","centralNervousSystemYN")=$G(SURGARR(FNBR1,IENS1,210,"E"))
 S SURG("Surg","centralNervousSystemYNCd")=$G(SURGARR(FNBR1,IENS1,210,"I"))
 S SURG("Surg","currentlyOnDialysis")=$G(SURGARR(FNBR1,IENS1,211,"E"))
 S SURG("Surg","currentlyOnDialysisCd")=$G(SURGARR(FNBR1,IENS1,211,"I"))
 S SURG("Surg","ascites")=$G(SURGARR(FNBR1,IENS1,212,"E"))
 S SURG("Surg","ascitesCd")=$G(SURGARR(FNBR1,IENS1,212,"I"))
 S SURG("Surg","esophagealVarices")=$G(SURGARR(FNBR1,IENS1,213,"E"))
 S SURG("Surg","esophagealVaricesCd")=$G(SURGARR(FNBR1,IENS1,213,"I"))
 S SURG("Surg","pgyOfPrimarySurgeon")=$G(SURGARR(FNBR1,IENS1,214,"E"))
 S SURG("Surg","weightLoss10")=$G(SURGARR(FNBR1,IENS1,215,"E"))
 S SURG("Surg","weightLoss10Cd")=$G(SURGARR(FNBR1,IENS1,215,"I"))
 S SURG("Surg","bleedingDisorders")=$G(SURGARR(FNBR1,IENS1,216,"E"))
 S SURG("Surg","bleedingDisordersCd")=$G(SURGARR(FNBR1,IENS1,216,"I"))
 S SURG("Surg","transfusion4RbcUnits")=$G(SURGARR(FNBR1,IENS1,217,"E"))
 S SURG("Surg","transfusion4RbcUnitsCd")=$G(SURGARR(FNBR1,IENS1,217,"I"))
 S SURG("Surg","openWound")=$G(SURGARR(FNBR1,IENS1,218,"E"))
 S SURG("Surg","openWoundCd")=$G(SURGARR(FNBR1,IENS1,218,"I"))
 S SURG("Surg","preoperativeSepsis")=$G(SURGARR(FNBR1,IENS1,218.1,"E"))
 S SURG("Surg","preoperativeSepsisCd")=$G(SURGARR(FNBR1,IENS1,218.1,"I"))
 S SURG("Surg","preoperativeHemoglobin")=$G(SURGARR(FNBR1,IENS1,219,"E"))
 S SURG("Surg","preoperativeCpk")=$G(SURGARR(FNBR1,IENS1,221,"E"))
 S SURG("Surg","preoperativeMbBand")=$G(SURGARR(FNBR1,IENS1,222,"E"))
 S SURG("Surg","preoperativeSerumCreatinine")=$G(SURGARR(FNBR1,IENS1,223,"E"))
 S SURG("Surg","preoperativeBun")=$G(SURGARR(FNBR1,IENS1,224,"E"))
 S SURG("Surg","preoperativeSerumAlbumin")=$G(SURGARR(FNBR1,IENS1,225,"E"))
 S SURG("Surg","preoperativeSgpt")=$G(SURGARR(FNBR1,IENS1,226,"E"))
 S SURG("Surg","preoperativeSgot")=$G(SURGARR(FNBR1,IENS1,227,"E"))
 S SURG("Surg","preoperativeTotalBilirubin")=$G(SURGARR(FNBR1,IENS1,228,"E"))
 S SURG("Surg","preoperativeAlkPhosphatase")=$G(SURGARR(FNBR1,IENS1,229,"E"))
 S SURG("Surg","preoperativeWbc")=$G(SURGARR(FNBR1,IENS1,230,"E"))
 S SURG("Surg","preoperativePlateletCount")=$G(SURGARR(FNBR1,IENS1,231,"E"))
 S SURG("Surg","preoperativePt")=$G(SURGARR(FNBR1,IENS1,232,"E"))
 S SURG("Surg","preoperativePtt")=$G(SURGARR(FNBR1,IENS1,233,"E"))
 S SURG("Surg","preoperativeHematocrit")=$G(SURGARR(FNBR1,IENS1,234,"E"))
 S SURG("Surg","assessmentStatus")=$G(SURGARR(FNBR1,IENS1,235,"E"))
 S SURG("Surg","assessmentStatusCd")=$G(SURGARR(FNBR1,IENS1,235,"I"))
 S SURG("Surg","height")=$G(SURGARR(FNBR1,IENS1,236,"E"))
 S SURG("Surg","heightMeasurementDate")=$G(SURGARR(FNBR1,IENS1,236.1,"E"))
 S SURG("Surg","heightMeasurementDateFM")=$G(SURGARR(FNBR1,IENS1,236.1,"I"))
 S SURG("Surg","heightMeasurementDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,236.1,"I")))
 S SURG("Surg","heightMeasurementDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,236.1,"I")))
 S SURG("Surg","weight")=$G(SURGARR(FNBR1,IENS1,237,"E"))
 S SURG("Surg","preoperativeSleepApnea")=$G(SURGARR(FNBR1,IENS1,237.1,"E"))
 S SURG("Surg","preoperativeSleepApneaCd")=$G(SURGARR(FNBR1,IENS1,237.1,"I"))
 S SURG("Surg","dnrStatus")=$G(SURGARR(FNBR1,IENS1,238,"E"))
 S SURG("Surg","dnrStatusCd")=$G(SURGARR(FNBR1,IENS1,238,"I"))
 S SURG("Surg","preoperativeHemoglobinDate")=$G(SURGARR(FNBR1,IENS1,239,"E"))
 S SURG("Surg","preoperativeHemoglobinDateFM")=$G(SURGARR(FNBR1,IENS1,239,"I"))
 S SURG("Surg","preoperativeHemoglobinDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,239,"I")))
 S SURG("Surg","preoperativeHemoglobinDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,239,"I")))
 S SURG("Surg","pulmonaryYN")=$G(SURGARR(FNBR1,IENS1,241,"E"))
 S SURG("Surg","pulmonaryYNCd")=$G(SURGARR(FNBR1,IENS1,241,"I"))
 S SURG("Surg","cardiacYN")=$G(SURGARR(FNBR1,IENS1,242,"E"))
 S SURG("Surg","cardiacYNCd")=$G(SURGARR(FNBR1,IENS1,242,"I"))
 S SURG("Surg","renalYN")=$G(SURGARR(FNBR1,IENS1,243,"E"))
 S SURG("Surg","renalYNCd")=$G(SURGARR(FNBR1,IENS1,243,"I"))
 S SURG("Surg","hepatobiliaryYN")=$G(SURGARR(FNBR1,IENS1,244,"E"))
 S SURG("Surg","hepatobiliaryYNCd")=$G(SURGARR(FNBR1,IENS1,244,"I"))
 S SURG("Surg","nutritionalImmuneOther")=$G(SURGARR(FNBR1,IENS1,245,"E"))
 S SURG("Surg","nutritionalImmuneOtherCd")=$G(SURGARR(FNBR1,IENS1,245,"I"))
 S SURG("Surg","etoh2DrinksDay")=$G(SURGARR(FNBR1,IENS1,246,"E"))
 S SURG("Surg","etoh2DrinksDayCd")=$G(SURGARR(FNBR1,IENS1,246,"I"))
 S SURG("Surg","lengthOfPostOpStay")=$G(SURGARR(FNBR1,IENS1,247,"E"))
 S SURG("Surg","superficialIncisionalSsi")=$G(SURGARR(FNBR1,IENS1,248,"E"))
 S SURG("Surg","superficialIncisionalSsiCd")=$G(SURGARR(FNBR1,IENS1,248,"I"))
 S SURG("Surg","deepIncisionalSsi")=$G(SURGARR(FNBR1,IENS1,249,"E"))
 S SURG("Surg","deepIncisionalSsiCd")=$G(SURGARR(FNBR1,IENS1,249,"I"))
 S SURG("Surg","systemicSepsis")=$G(SURGARR(FNBR1,IENS1,250,"E"))
 S SURG("Surg","systemicSepsisCd")=$G(SURGARR(FNBR1,IENS1,250,"I"))
 S SURG("Surg","pneumonia")=$G(SURGARR(FNBR1,IENS1,251,"E"))
 S SURG("Surg","pneumoniaCd")=$G(SURGARR(FNBR1,IENS1,251,"I"))
 S SURG("Surg","pulmonaryEmbolism")=$G(SURGARR(FNBR1,IENS1,252,"E"))
 S SURG("Surg","pulmonaryEmbolismCd")=$G(SURGARR(FNBR1,IENS1,252,"I"))
 S SURG("Surg","otherRespiratoryOccurrence")=$G(SURGARR(FNBR1,IENS1,253,"E"))
 S SURG("Surg","otherRespiratoryOccurrenceId")=$G(SURGARR(FNBR1,IENS1,253,"I"))
 S SURG("Surg","acuteRenalFailure")=$G(SURGARR(FNBR1,IENS1,254,"E"))
 S SURG("Surg","acuteRenalFailureCd")=$G(SURGARR(FNBR1,IENS1,254,"I"))
 S SURG("Surg","urinaryTractInfection")=$G(SURGARR(FNBR1,IENS1,255,"E"))
 S SURG("Surg","urinaryTractInfectionCd")=$G(SURGARR(FNBR1,IENS1,255,"I"))
 S SURG("Surg","strokeCva")=$G(SURGARR(FNBR1,IENS1,256,"E"))
 S SURG("Surg","strokeCvaCd")=$G(SURGARR(FNBR1,IENS1,256,"I"))
 S SURG("Surg","postopBleedingTransfusions")=$G(SURGARR(FNBR1,IENS1,257,"E"))
 S SURG("Surg","postopBleedingTransfusionsCd")=$G(SURGARR(FNBR1,IENS1,257,"I"))
 S SURG("Surg","myocardialInfarction")=$G(SURGARR(FNBR1,IENS1,258,"E"))
 S SURG("Surg","myocardialInfarctionCd")=$G(SURGARR(FNBR1,IENS1,258,"I"))
 S SURG("Surg","pulmonaryEdema")=$G(SURGARR(FNBR1,IENS1,259,"E"))
 S SURG("Surg","pulmonaryEdemaCd")=$G(SURGARR(FNBR1,IENS1,259,"I"))
 S SURG("Surg","dateTransmitted")=$G(SURGARR(FNBR1,IENS1,260,"E"))
 S SURG("Surg","dateTransmittedFM")=$G(SURGARR(FNBR1,IENS1,260,"I"))
 S SURG("Surg","dateTransmittedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,260,"I")))
 S SURG("Surg","dateTransmittedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,260,"I")))
 S SURG("Surg","dateOfLastTransmission")=$G(SURGARR(FNBR1,IENS1,260.1,"E"))
 S SURG("Surg","dateOfLastTransmissionFM")=$G(SURGARR(FNBR1,IENS1,260.1,"I"))
 S SURG("Surg","dateOfLastTransmissionHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,260.1,"I")))
 S SURG("Surg","dateOfLastTransmissionFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,260.1,"I")))
 S SURG("Surg","graftProsthesisFlapFailure")=$G(SURGARR(FNBR1,IENS1,261,"E"))
 S SURG("Surg","graftProsthesisFlapFailureCd")=$G(SURGARR(FNBR1,IENS1,261,"I"))
 S SURG("Surg","returnToOrWithin30Days")=$G(SURGARR(FNBR1,IENS1,262,"E"))
 S SURG("Surg","returnToOrWithin30DaysCd")=$G(SURGARR(FNBR1,IENS1,262,"I"))
 S SURG("Surg","dvtThrombophlebitis")=$G(SURGARR(FNBR1,IENS1,263,"E"))
 S SURG("Surg","dvtThrombophlebitisCd")=$G(SURGARR(FNBR1,IENS1,263,"I"))
 S SURG("Surg","peripheralArterialDisease")=$G(SURGARR(FNBR1,IENS1,265,"E"))
 S SURG("Surg","peripheralArterialDiseaseCd")=$G(SURGARR(FNBR1,IENS1,265,"I"))
 S SURG("Surg","anginaSeverity")=$G(SURGARR(FNBR1,IENS1,267,"E"))
 S SURG("Surg","anginaSeverityCd")=$G(SURGARR(FNBR1,IENS1,267,"I"))
 S SURG("Surg","hepatomegaly")=$G(SURGARR(FNBR1,IENS1,268,"E"))
 S SURG("Surg","hepatomegalyCd")=$G(SURGARR(FNBR1,IENS1,268,"I"))
 S SURG("Surg","pregnancy")=$G(SURGARR(FNBR1,IENS1,269,"E"))
 S SURG("Surg","pregnancyCd")=$G(SURGARR(FNBR1,IENS1,269,"I"))
 S SURG("Surg","preoperativeSerumSodium")=$G(SURGARR(FNBR1,IENS1,270,"E"))
 S SURG("Surg","preoperativePotassium")=$G(SURGARR(FNBR1,IENS1,271,"E"))
 S SURG("Surg","dateAssessmentCompleted")=$G(SURGARR(FNBR1,IENS1,272,"E"))
 S SURG("Surg","dateAssessmentCompletedFM")=$G(SURGARR(FNBR1,IENS1,272,"I"))
 S SURG("Surg","dateAssessmentCompletedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,272,"I")))
 S SURG("Surg","dateAssessmentCompletedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,272,"I")))
 S SURG("Surg","assessmentCompletedBy")=$G(SURGARR(FNBR1,IENS1,272.1,"E"))
 S SURG("Surg","assessmentCompletedById")=$G(SURGARR(FNBR1,IENS1,272.1,"I"))
 S SURG("Surg","assessmentCompletedByResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","assessmentCompletedById"))
 S SURG("Surg","preoperativeGlucose")=$G(SURGARR(FNBR1,IENS1,273,"E"))
 S SURG("Surg","highestSerumSodium")=$G(SURGARR(FNBR1,IENS1,274,"E"))
 S SURG("Surg","highestPotassium")=$G(SURGARR(FNBR1,IENS1,275,"E"))
 S SURG("Surg","highestGlucose")=$G(SURGARR(FNBR1,IENS1,276,"E"))
 S SURG("Surg","highestSerumCreatinine")=$G(SURGARR(FNBR1,IENS1,277,"E"))
 S SURG("Surg","highestCpk")=$G(SURGARR(FNBR1,IENS1,278,"E"))
 S SURG("Surg","highestCpkMb")=$G(SURGARR(FNBR1,IENS1,279,"E"))
 S SURG("Surg","highestTotalBilirubin")=$G(SURGARR(FNBR1,IENS1,280,"E"))
 S SURG("Surg","highestWbc")=$G(SURGARR(FNBR1,IENS1,281,"E"))
 S SURG("Surg","lowestSerumAlbumin")=$G(SURGARR(FNBR1,IENS1,282,"E"))
 S SURG("Surg","lowestHematocrit")=$G(SURGARR(FNBR1,IENS1,283,"E"))
 S SURG("Surg","assessmentType")=$G(SURGARR(FNBR1,IENS1,284,"E"))
 S SURG("Surg","assessmentTypeCd")=$G(SURGARR(FNBR1,IENS1,284,"I"))
 S SURG("Surg","onVentilator48Hours")=$G(SURGARR(FNBR1,IENS1,285,"E"))
 S SURG("Surg","onVentilator48HoursCd")=$G(SURGARR(FNBR1,IENS1,285,"I"))
 S SURG("Surg","otherUrinaryTractOccurrence")=$G(SURGARR(FNBR1,IENS1,286,"E"))
 S SURG("Surg","otherUrinaryTractOccurrenceId")=$G(SURGARR(FNBR1,IENS1,286,"I"))
 S SURG("Surg","peripheralNerveInjury")=$G(SURGARR(FNBR1,IENS1,287,"E"))
 S SURG("Surg","peripheralNerveInjuryCd")=$G(SURGARR(FNBR1,IENS1,287,"I"))
 S SURG("Surg","preoperativeCpkDate")=$G(SURGARR(FNBR1,IENS1,288,"E"))
 S SURG("Surg","preoperativeCpkDateFM")=$G(SURGARR(FNBR1,IENS1,288,"I"))
 S SURG("Surg","preoperativeCpkDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,288,"I")))
 S SURG("Surg","preoperativeCpkDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,288,"I")))
 S SURG("Surg","preoperativeMbBandDate")=$G(SURGARR(FNBR1,IENS1,289,"E"))
 S SURG("Surg","preoperativeMbBandDateFM")=$G(SURGARR(FNBR1,IENS1,289,"I"))
 S SURG("Surg","preoperativeMbBandDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,289,"I")))
 S SURG("Surg","preoperativeMbBandDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,289,"I")))
 S SURG("Surg","preopSerumCreatinineDate")=$G(SURGARR(FNBR1,IENS1,290,"E"))
 S SURG("Surg","preopSerumCreatinineDateFM")=$G(SURGARR(FNBR1,IENS1,290,"I"))
 S SURG("Surg","preopSerumCreatinineDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,290,"I")))
 S SURG("Surg","preopSerumCreatinineDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,290,"I")))
 S SURG("Surg","preoperativeBunDate")=$G(SURGARR(FNBR1,IENS1,291,"E"))
 S SURG("Surg","preoperativeBunDateFM")=$G(SURGARR(FNBR1,IENS1,291,"I"))
 S SURG("Surg","preoperativeBunDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,291,"I")))
 S SURG("Surg","preoperativeBunDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,291,"I")))
 S SURG("Surg","preopSerumAlbuminDate")=$G(SURGARR(FNBR1,IENS1,292,"E"))
 S SURG("Surg","preopSerumAlbuminDateFM")=$G(SURGARR(FNBR1,IENS1,292,"I"))
 S SURG("Surg","preopSerumAlbuminDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,292,"I")))
 S SURG("Surg","preopSerumAlbuminDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,292,"I")))
 S SURG("Surg","sgptDatePerformed")=$G(SURGARR(FNBR1,IENS1,293,"E"))
 S SURG("Surg","sgptDatePerformedFM")=$G(SURGARR(FNBR1,IENS1,293,"I"))
 S SURG("Surg","sgptDatePerformedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,293,"I")))
 S SURG("Surg","sgptDatePerformedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,293,"I")))
 S SURG("Surg","sgotDatePerformed")=$G(SURGARR(FNBR1,IENS1,294,"E"))
 S SURG("Surg","sgotDatePerformedFM")=$G(SURGARR(FNBR1,IENS1,294,"I"))
 S SURG("Surg","sgotDatePerformedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,294,"I")))
 S SURG("Surg","sgotDatePerformedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,294,"I")))
 S SURG("Surg","preopTotalBilirubinDate")=$G(SURGARR(FNBR1,IENS1,295,"E"))
 S SURG("Surg","preopTotalBilirubinDateFM")=$G(SURGARR(FNBR1,IENS1,295,"I"))
 S SURG("Surg","preopTotalBilirubinDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,295,"I")))
 S SURG("Surg","preopTotalBilirubinDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,295,"I")))
 S SURG("Surg","preopAlkPhosphataseDate")=$G(SURGARR(FNBR1,IENS1,296,"E"))
 S SURG("Surg","preopAlkPhosphataseDateFM")=$G(SURGARR(FNBR1,IENS1,296,"I"))
 S SURG("Surg","preopAlkPhosphataseDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,296,"I")))
 S SURG("Surg","preopAlkPhosphataseDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,296,"I")))
 S SURG("Surg","preoperativeWbcDate")=$G(SURGARR(FNBR1,IENS1,297,"E"))
 S SURG("Surg","preoperativeWbcDateFM")=$G(SURGARR(FNBR1,IENS1,297,"I"))
 S SURG("Surg","preoperativeWbcDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,297,"I")))
 S SURG("Surg","preoperativeWbcDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,297,"I")))
 S SURG("Surg","preopPlateletCountDate")=$G(SURGARR(FNBR1,IENS1,298,"E"))
 S SURG("Surg","preopPlateletCountDateFM")=$G(SURGARR(FNBR1,IENS1,298,"I"))
 S SURG("Surg","preopPlateletCountDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,298,"I")))
 S SURG("Surg","preopPlateletCountDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,298,"I")))
 S SURG("Surg","preoperativePtDate")=$G(SURGARR(FNBR1,IENS1,299,"E"))
 S SURG("Surg","preoperativePtDateFM")=$G(SURGARR(FNBR1,IENS1,299,"I"))
 S SURG("Surg","preoperativePtDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,299,"I")))
 S SURG("Surg","preoperativePtDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,299,"I")))
 S SURG("Surg","preoperativePttDate")=$G(SURGARR(FNBR1,IENS1,300,"E"))
 S SURG("Surg","preoperativePttDateFM")=$G(SURGARR(FNBR1,IENS1,300,"I"))
 S SURG("Surg","preoperativePttDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,300,"I")))
 S SURG("Surg","preoperativePttDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,300,"I")))
 S SURG("Surg","preopHematocritDate")=$G(SURGARR(FNBR1,IENS1,301,"E"))
 S SURG("Surg","preopHematocritDateFM")=$G(SURGARR(FNBR1,IENS1,301,"I"))
 S SURG("Surg","preopHematocritDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,301,"I")))
 S SURG("Surg","preopHematocritDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,301,"I")))
 S SURG("Surg","preoperativeGlucoseDate")=$G(SURGARR(FNBR1,IENS1,302,"E"))
 S SURG("Surg","preoperativeGlucoseDateFM")=$G(SURGARR(FNBR1,IENS1,302,"I"))
 S SURG("Surg","preoperativeGlucoseDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,302,"I")))
 S SURG("Surg","preoperativeGlucoseDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,302,"I")))
 S SURG("Surg","preopPotassiumDate")=$G(SURGARR(FNBR1,IENS1,303,"E"))
 S SURG("Surg","preopPotassiumDateFM")=$G(SURGARR(FNBR1,IENS1,303,"I"))
 S SURG("Surg","preopPotassiumDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,303,"I")))
 S SURG("Surg","preopPotassiumDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,303,"I")))
 S SURG("Surg","preopSerumSodiumDate")=$G(SURGARR(FNBR1,IENS1,304,"E"))
 S SURG("Surg","preopSerumSodiumDateFM")=$G(SURGARR(FNBR1,IENS1,304,"I"))
 S SURG("Surg","preopSerumSodiumDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,304,"I")))
 S SURG("Surg","preopSerumSodiumDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,304,"I")))
 S SURG("Surg","highSerumSodiumDate")=$G(SURGARR(FNBR1,IENS1,305,"E"))
 S SURG("Surg","highSerumSodiumDateFM")=$G(SURGARR(FNBR1,IENS1,305,"I"))
 S SURG("Surg","highSerumSodiumDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,305,"I")))
 S SURG("Surg","highSerumSodiumDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,305,"I")))
 S SURG("Surg","highPotassiumDate")=$G(SURGARR(FNBR1,IENS1,306,"E"))
 S SURG("Surg","highPotassiumDateFM")=$G(SURGARR(FNBR1,IENS1,306,"I"))
 S SURG("Surg","highPotassiumDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,306,"I")))
 S SURG("Surg","highPotassiumDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,306,"I")))
 S SURG("Surg","highGlucoseDate")=$G(SURGARR(FNBR1,IENS1,307,"E"))
 S SURG("Surg","highGlucoseDateFM")=$G(SURGARR(FNBR1,IENS1,307,"I"))
 S SURG("Surg","highGlucoseDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,307,"I")))
 S SURG("Surg","highGlucoseDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,307,"I")))
 S SURG("Surg","highSerumCreatinineDate")=$G(SURGARR(FNBR1,IENS1,308,"E"))
 S SURG("Surg","highSerumCreatinineDateFM")=$G(SURGARR(FNBR1,IENS1,308,"I"))
 S SURG("Surg","highSerumCreatinineDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,308,"I")))
 S SURG("Surg","highSerumCreatinineDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,308,"I")))
 S SURG("Surg","highCpkDate")=$G(SURGARR(FNBR1,IENS1,309,"E"))
 S SURG("Surg","highCpkDateFM")=$G(SURGARR(FNBR1,IENS1,309,"I"))
 S SURG("Surg","highCpkDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,309,"I")))
 S SURG("Surg","highCpkDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,309,"I")))
 S SURG("Surg","highCpkMbDate")=$G(SURGARR(FNBR1,IENS1,310,"E"))
 S SURG("Surg","highCpkMbDateFM")=$G(SURGARR(FNBR1,IENS1,310,"I"))
 S SURG("Surg","highCpkMbDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,310,"I")))
 S SURG("Surg","highCpkMbDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,310,"I")))
 S SURG("Surg","highTotalBilirubinDate")=$G(SURGARR(FNBR1,IENS1,311,"E"))
 S SURG("Surg","highTotalBilirubinDateFM")=$G(SURGARR(FNBR1,IENS1,311,"I"))
 S SURG("Surg","highTotalBilirubinDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,311,"I")))
 S SURG("Surg","highTotalBilirubinDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,311,"I")))
 S SURG("Surg","highestWbcDate")=$G(SURGARR(FNBR1,IENS1,312,"E"))
 S SURG("Surg","highestWbcDateFM")=$G(SURGARR(FNBR1,IENS1,312,"I"))
 S SURG("Surg","highestWbcDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,312,"I")))
 S SURG("Surg","highestWbcDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,312,"I")))
 S SURG("Surg","lowSerumAlbuminDate")=$G(SURGARR(FNBR1,IENS1,313,"E"))
 S SURG("Surg","lowSerumAlbuminDateFM")=$G(SURGARR(FNBR1,IENS1,313,"I"))
 S SURG("Surg","lowSerumAlbuminDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,313,"I")))
 S SURG("Surg","lowSerumAlbuminDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,313,"I")))
 S SURG("Surg","lowHematocritDate")=$G(SURGARR(FNBR1,IENS1,314,"E"))
 S SURG("Surg","lowHematocritDateFM")=$G(SURGARR(FNBR1,IENS1,314,"I"))
 S SURG("Surg","lowHematocritDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,314,"I")))
 S SURG("Surg","lowHematocritDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,314,"I")))
 S SURG("Surg","preoperativePtControl")=$G(SURGARR(FNBR1,IENS1,315,"E"))
 S SURG("Surg","preoperativePttControl")=$G(SURGARR(FNBR1,IENS1,316,"E"))
 S SURG("Surg","respiratoryOccurrences")=$G(SURGARR(FNBR1,IENS1,318,"E"))
 S SURG("Surg","respiratoryOccurrencesCd")=$G(SURGARR(FNBR1,IENS1,318,"I"))
 S SURG("Surg","urinaryTractOccurrences")=$G(SURGARR(FNBR1,IENS1,319,"E"))
 S SURG("Surg","urinaryTractOccurrencesCd")=$G(SURGARR(FNBR1,IENS1,319,"I"))
 S SURG("Surg","cnsOccurrences")=$G(SURGARR(FNBR1,IENS1,320,"E"))
 S SURG("Surg","cnsOccurrencesCd")=$G(SURGARR(FNBR1,IENS1,320,"I"))
 S SURG("Surg","cardiacOccurrences")=$G(SURGARR(FNBR1,IENS1,321,"E"))
 S SURG("Surg","cardiacOccurrencesCd")=$G(SURGARR(FNBR1,IENS1,321,"I"))
 S SURG("Surg","otherOccurrences")=$G(SURGARR(FNBR1,IENS1,322,"E"))
 S SURG("Surg","otherOccurrencesCd")=$G(SURGARR(FNBR1,IENS1,322,"I"))
 S SURG("Surg","createRiskAssessment")=$G(SURGARR(FNBR1,IENS1,323,"E"))
 S SURG("Surg","createRiskAssessmentCd")=$G(SURGARR(FNBR1,IENS1,323,"I"))
 S SURG("Surg","drugAddiction")=$G(SURGARR(FNBR1,IENS1,324,"E"))
 S SURG("Surg","drugAddictionCd")=$G(SURGARR(FNBR1,IENS1,324,"I"))
 S SURG("Surg","dyspnea")=$G(SURGARR(FNBR1,IENS1,325,"E"))
 S SURG("Surg","dyspneaCd")=$G(SURGARR(FNBR1,IENS1,325,"I"))
 S SURG("Surg","currentPneumonia")=$G(SURGARR(FNBR1,IENS1,326,"E"))
 S SURG("Surg","currentPneumoniaCd")=$G(SURGARR(FNBR1,IENS1,326,"I"))
 S SURG("Surg","activeHepatitis")=$G(SURGARR(FNBR1,IENS1,327,"E"))
 S SURG("Surg","activeHepatitisCd")=$G(SURGARR(FNBR1,IENS1,327,"I"))
 S SURG("Surg","renalFailure")=$G(SURGARR(FNBR1,IENS1,328,"E"))
 S SURG("Surg","renalFailureCd")=$G(SURGARR(FNBR1,IENS1,328,"I"))
 S SURG("Surg","restPainGangreneYN")=$G(SURGARR(FNBR1,IENS1,330,"E"))
 S SURG("Surg","restPainGangreneYNCd")=$G(SURGARR(FNBR1,IENS1,330,"I"))
 S SURG("Surg","absentPeripheralPulses")=$G(SURGARR(FNBR1,IENS1,331,"E"))
 S SURG("Surg","absentPeripheralPulsesCd")=$G(SURGARR(FNBR1,IENS1,331,"I"))
 S SURG("Surg","impairedSensorium")=$G(SURGARR(FNBR1,IENS1,332,"E"))
 S SURG("Surg","impairedSensoriumCd")=$G(SURGARR(FNBR1,IENS1,332,"I"))
 S SURG("Surg","coma")=$G(SURGARR(FNBR1,IENS1,333,"E"))
 S SURG("Surg","comaCd")=$G(SURGARR(FNBR1,IENS1,333,"I"))
 S SURG("Surg","neuroDegenerativeDisease")=$G(SURGARR(FNBR1,IENS1,337,"E"))
 S SURG("Surg","neuroDegenerativeDiseaseCd")=$G(SURGARR(FNBR1,IENS1,337,"I"))
 S SURG("Surg","disseminatedCancerYN")=$G(SURGARR(FNBR1,IENS1,338,"E"))
 S SURG("Surg","disseminatedCancerYNCd")=$G(SURGARR(FNBR1,IENS1,338,"I"))
 S SURG("Surg","radiotherapyInLast90Days")=$G(SURGARR(FNBR1,IENS1,338.2,"E"))
 S SURG("Surg","radiotherapyInLast90DaysCd")=$G(SURGARR(FNBR1,IENS1,338.2,"I"))
 S SURG("Surg","chemoForMaligLast90Days")=$G(SURGARR(FNBR1,IENS1,338.3,"E"))
 S SURG("Surg","chemoForMaligLast90DaysCd")=$G(SURGARR(FNBR1,IENS1,338.3,"I"))
 S SURG("Surg","steroidUseForChronicCond")=$G(SURGARR(FNBR1,IENS1,339,"E"))
 S SURG("Surg","steroidUseForChronicCondCd")=$G(SURGARR(FNBR1,IENS1,339,"I"))
 S SURG("Surg","intraopRbcUnitsTransfused")=$G(SURGARR(FNBR1,IENS1,340,"E"))
 S SURG("Surg","30DayPostopStatus")=$G(SURGARR(FNBR1,IENS1,341,"E"))
 S SURG("Surg","30DayPostopStatusCd")=$G(SURGARR(FNBR1,IENS1,341,"I"))
 S SURG("Surg","dateOfDeath")=$G(SURGARR(FNBR1,IENS1,342,"E"))
 S SURG("Surg","30DayDeath")=$G(SURGARR(FNBR1,IENS1,342.1,"E"))
 S SURG("Surg","30DayDeathCd")=$G(SURGARR(FNBR1,IENS1,342.1,"I"))
 S SURG("Surg","otherCnsOccurrence")=$G(SURGARR(FNBR1,IENS1,343,"E"))
 S SURG("Surg","otherCnsOccurrenceId")=$G(SURGARR(FNBR1,IENS1,343,"I"))
 S SURG("Surg","otherCardiacOccurrence")=$G(SURGARR(FNBR1,IENS1,344,"E"))
 S SURG("Surg","otherCardiacOccurrenceId")=$G(SURGARR(FNBR1,IENS1,344,"I"))
 S SURG("Surg","ileusBowelObstruction")=$G(SURGARR(FNBR1,IENS1,345,"E"))
 S SURG("Surg","ileusBowelObstructionCd")=$G(SURGARR(FNBR1,IENS1,345,"I"))
 S SURG("Surg","fev1")=$G(SURGARR(FNBR1,IENS1,347,"E"))
 S SURG("Surg","activeEndocarditis")=$G(SURGARR(FNBR1,IENS1,349,"E"))
 S SURG("Surg","activeEndocarditisCd")=$G(SURGARR(FNBR1,IENS1,349,"I"))
 S SURG("Surg","numOfPriorHeartSurgeries")=$G(SURGARR(FNBR1,IENS1,352,"E"))
 S SURG("Surg","numOfPriorHeartSurgeriesCd")=$G(SURGARR(FNBR1,IENS1,352,"I"))
 S SURG("Surg","currentDiureticUse")=$G(SURGARR(FNBR1,IENS1,353,"E"))
 S SURG("Surg","currentDiureticUseCd")=$G(SURGARR(FNBR1,IENS1,353,"I"))
 S SURG("Surg","ivNtgWithin48Hours")=$G(SURGARR(FNBR1,IENS1,355,"E"))
 S SURG("Surg","ivNtgWithin48HoursCd")=$G(SURGARR(FNBR1,IENS1,355,"I"))
 S SURG("Surg","preoperativeUseOfIabp")=$G(SURGARR(FNBR1,IENS1,356,"E"))
 S SURG("Surg","preoperativeUseOfIabpCd")=$G(SURGARR(FNBR1,IENS1,356,"I"))
 S SURG("Surg","lvedp")=$G(SURGARR(FNBR1,IENS1,357,"E"))
 S SURG("Surg","aorticSystolicPressure")=$G(SURGARR(FNBR1,IENS1,358,"E"))
 S SURG("Surg","paSystolicPressure")=$G(SURGARR(FNBR1,IENS1,359,"E"))
 S SURG("Surg","pawMeanPressure")=$G(SURGARR(FNBR1,IENS1,360,"E"))
 S SURG("Surg","leftMainStenosis")=$G(SURGARR(FNBR1,IENS1,361,"E"))
 S SURG("Surg","coronariesWithStenosis")=$G(SURGARR(FNBR1,IENS1,362,"E"))
 S SURG("Surg","ladStenosis")=$G(SURGARR(FNBR1,IENS1,362.1,"E"))
 S SURG("Surg","rightCoronaryStenosis")=$G(SURGARR(FNBR1,IENS1,362.2,"E"))
 S SURG("Surg","circumflexStenosis")=$G(SURGARR(FNBR1,IENS1,362.3,"E"))
 S SURG("Surg","lvContractionScore")=$G(SURGARR(FNBR1,IENS1,363,"E"))
 S SURG("Surg","lvContractionScoreCd")=$G(SURGARR(FNBR1,IENS1,363,"I"))
 S SURG("Surg","estimateOfMortality")=$G(SURGARR(FNBR1,IENS1,364,"E"))
 S SURG("Surg","estimateOfMortalityDate")=$G(SURGARR(FNBR1,IENS1,364.1,"E"))
 S SURG("Surg","valveRepair")=$G(SURGARR(FNBR1,IENS1,370,"E"))
 S SURG("Surg","valveRepairCd")=$G(SURGARR(FNBR1,IENS1,370,"I"))
 S SURG("Surg","electrophysiologicProcedure")=$G(SURGARR(FNBR1,IENS1,374,"E"))
 S SURG("Surg","electrophysiologicProcedureCd")=$G(SURGARR(FNBR1,IENS1,374,"I"))
 S SURG("Surg","miscCardiacProcedures")=$G(SURGARR(FNBR1,IENS1,375,"E"))
 S SURG("Surg","miscCardiacProceduresCd")=$G(SURGARR(FNBR1,IENS1,375,"I"))
 S SURG("Surg","otherProceduresYN")=$G(SURGARR(FNBR1,IENS1,383,"E"))
 S SURG("Surg","otherProceduresYNCd")=$G(SURGARR(FNBR1,IENS1,383,"I"))
 S SURG("Surg","otherCardiacProcedures")=$G(SURGARR(FNBR1,IENS1,383.1,"E"))
 S SURG("Surg","operativeDeath")=$G(SURGARR(FNBR1,IENS1,384,"E"))
 S SURG("Surg","operativeDeathCd")=$G(SURGARR(FNBR1,IENS1,384,"I"))
 S SURG("Surg","endocarditis")=$G(SURGARR(FNBR1,IENS1,386,"E"))
 S SURG("Surg","endocarditisCd")=$G(SURGARR(FNBR1,IENS1,386,"I"))
 S SURG("Surg","lowCardiacOutput6Hours")=$G(SURGARR(FNBR1,IENS1,387,"E"))
 S SURG("Surg","lowCardiacOutput6HoursCd")=$G(SURGARR(FNBR1,IENS1,387,"I"))
 S SURG("Surg","mediastinitis")=$G(SURGARR(FNBR1,IENS1,388,"E"))
 S SURG("Surg","mediastinitisCd")=$G(SURGARR(FNBR1,IENS1,388,"I"))
 S SURG("Surg","reoperationForBleeding")=$G(SURGARR(FNBR1,IENS1,389,"E"))
 S SURG("Surg","reoperationForBleedingCd")=$G(SURGARR(FNBR1,IENS1,389,"I"))
 S SURG("Surg","repeatCardiacSurgProcedure")=$G(SURGARR(FNBR1,IENS1,391,"E"))
 S SURG("Surg","repeatCardiacSurgProcedureCd")=$G(SURGARR(FNBR1,IENS1,391,"I"))
 S SURG("Surg","otherOccurrencesIcd")=$G(SURGARR(FNBR1,IENS1,392,"E"))
 S SURG("Surg","otherOccurrencesIcdId")=$G(SURGARR(FNBR1,IENS1,392,"I"))
 S SURG("Surg","reTransmission")=$G(SURGARR(FNBR1,IENS1,393,"E"))
 S SURG("Surg","severeHeadTraumaYN")=$G(SURGARR(FNBR1,IENS1,397,"E"))
 S SURG("Surg","severeHeadTraumaYNCd")=$G(SURGARR(FNBR1,IENS1,397,"I"))
 S SURG("Surg","quadriplegiaYN")=$G(SURGARR(FNBR1,IENS1,398,"E"))
 S SURG("Surg","quadriplegiaYNCd")=$G(SURGARR(FNBR1,IENS1,398,"I"))
 S SURG("Surg","paraplegiaYN")=$G(SURGARR(FNBR1,IENS1,399,"E"))
 S SURG("Surg","paraplegiaYNCd")=$G(SURGARR(FNBR1,IENS1,399,"I"))
 S SURG("Surg","hemiplegiaHemiparesisYN")=$G(SURGARR(FNBR1,IENS1,400,"E"))
 S SURG("Surg","hemiplegiaHemiparesisYNCd")=$G(SURGARR(FNBR1,IENS1,400,"I"))
 S SURG("Surg","tumorInvolvingCnsYN")=$G(SURGARR(FNBR1,IENS1,401,"E"))
 S SURG("Surg","tumorInvolvingCnsYNCd")=$G(SURGARR(FNBR1,IENS1,401,"I"))
 S SURG("Surg","generalYN")=$G(SURGARR(FNBR1,IENS1,402,"E"))
 S SURG("Surg","generalYNCd")=$G(SURGARR(FNBR1,IENS1,402,"I"))
 S SURG("Surg","woundOccurrences")=$G(SURGARR(FNBR1,IENS1,403,"E"))
 S SURG("Surg","woundOccurrencesCd")=$G(SURGARR(FNBR1,IENS1,403,"I"))
 S SURG("Surg","woundDisruption")=$G(SURGARR(FNBR1,IENS1,404,"E"))
 S SURG("Surg","woundDisruptionCd")=$G(SURGARR(FNBR1,IENS1,404,"I"))
 S SURG("Surg","lowSerumSodium")=$G(SURGARR(FNBR1,IENS1,405,"E"))
 S SURG("Surg","lowPotassium")=$G(SURGARR(FNBR1,IENS1,406,"E"))
 S SURG("Surg","lowSodiumDate")=$G(SURGARR(FNBR1,IENS1,407,"E"))
 S SURG("Surg","lowSodiumDateFM")=$G(SURGARR(FNBR1,IENS1,407,"I"))
 S SURG("Surg","lowSodiumDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,407,"I")))
 S SURG("Surg","lowSodiumDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,407,"I")))
 S SURG("Surg","lowPotassiumDate")=$G(SURGARR(FNBR1,IENS1,408,"E"))
 S SURG("Surg","lowPotassiumDateFM")=$G(SURGARR(FNBR1,IENS1,408,"I"))
 S SURG("Surg","lowPotassiumDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,408,"I")))
 S SURG("Surg","lowPotassiumDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,408,"I")))
 S SURG("Surg","renalInsufficiency")=$G(SURGARR(FNBR1,IENS1,409,"E"))
 S SURG("Surg","renalInsufficiencyCd")=$G(SURGARR(FNBR1,IENS1,409,"I"))
 S SURG("Surg","coma24HoursPostop")=$G(SURGARR(FNBR1,IENS1,410,"E"))
 S SURG("Surg","coma24HoursPostopCd")=$G(SURGARR(FNBR1,IENS1,410,"I"))
 S SURG("Surg","cardiacArrestReqCpr")=$G(SURGARR(FNBR1,IENS1,411,"E"))
 S SURG("Surg","cardiacArrestReqCprCd")=$G(SURGARR(FNBR1,IENS1,411,"I"))
 S SURG("Surg","unplannedIntubationYN")=$G(SURGARR(FNBR1,IENS1,412,"E"))
 S SURG("Surg","unplannedIntubationYNCd")=$G(SURGARR(FNBR1,IENS1,412,"I"))
 S SURG("Surg","transferStatus")=$G(SURGARR(FNBR1,IENS1,413,"E"))
 S SURG("Surg","transferStatusCd")=$G(SURGARR(FNBR1,IENS1,413,"I"))
 S SURG("Surg","cardiacSurgicalPriority")=$G(SURGARR(FNBR1,IENS1,414,"E"))
 S SURG("Surg","cardiacSurgicalPriorityCd")=$G(SURGARR(FNBR1,IENS1,414,"I"))
 S SURG("Surg","surgicalPriorityDate")=$G(SURGARR(FNBR1,IENS1,414.1,"E"))
 S SURG("Surg","surgicalPriorityDateFM")=$G(SURGARR(FNBR1,IENS1,414.1,"I"))
 S SURG("Surg","surgicalPriorityDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,414.1,"I")))
 S SURG("Surg","surgicalPriorityDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,414.1,"I")))
 S SURG("Surg","mitralRegurgitation")=$G(SURGARR(FNBR1,IENS1,415,"E"))
 S SURG("Surg","mitralRegurgitationCd")=$G(SURGARR(FNBR1,IENS1,415,"I"))
 S SURG("Surg","race")=$G(SURGARR(FNBR1,IENS1,417,"E"))
 S SURG("Surg","raceCd")=$G(SURGARR(FNBR1,IENS1,417,"I"))
 S SURG("Surg","hospitalAdmissionDate")=$G(SURGARR(FNBR1,IENS1,418,"E"))
 S SURG("Surg","hospitalDischargeDate")=$G(SURGARR(FNBR1,IENS1,419,"E"))
 S SURG("Surg","admissionTransferDate")=$G(SURGARR(FNBR1,IENS1,420,"E"))
 S SURG("Surg","dischargeTransferDate")=$G(SURGARR(FNBR1,IENS1,421,"E"))
 S SURG("Surg","outOfOrUnplannedIntubation")=$G(SURGARR(FNBR1,IENS1,422,"E"))
 S SURG("Surg","outOfOrUnplannedIntubationCd")=$G(SURGARR(FNBR1,IENS1,422,"I"))
 S SURG("Surg","congestiveHeartFailurePreop")=$G(SURGARR(FNBR1,IENS1,423,"E"))
 S SURG("Surg","congestiveHeartFailurePreopCd")=$G(SURGARR(FNBR1,IENS1,423,"I"))
 S SURG("Surg","cardiacRiskPreopComments")=$G(SURGARR(FNBR1,IENS1,430,"E"))
 S SURG("Surg","cardiacResourceDataComments")=$G(SURGARR(FNBR1,IENS1,431,"E"))
 S SURG("Surg","batistaProcedureUsedYN")=$G(SURGARR(FNBR1,IENS1,439,"E"))
 S SURG("Surg","batistaProcedureUsedYNCd")=$G(SURGARR(FNBR1,IENS1,439,"I"))
 S SURG("Surg","cardiacCatheterizationDate")=$G(SURGARR(FNBR1,IENS1,440,"E"))
 S SURG("Surg","cardiacCatheterizationDateFM")=$G(SURGARR(FNBR1,IENS1,440,"I"))
 S SURG("Surg","cardiacCatheterizationDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,440,"I")))
 S SURG("Surg","cardiacCatheterizationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,440,"I")))
 S SURG("Surg","minimallyInvasiveProcYN")=$G(SURGARR(FNBR1,IENS1,441,"E"))
 S SURG("Surg","minimallyInvasiveProcYNCd")=$G(SURGARR(FNBR1,IENS1,441,"I"))
 S SURG("Surg","employmentStatusPreoperative")=$G(SURGARR(FNBR1,IENS1,442,"E"))
 S SURG("Surg","employmentStatusPreoperativeCd")=$G(SURGARR(FNBR1,IENS1,442,"I"))
 S SURG("Surg","intraopDisseminatedCancer")=$G(SURGARR(FNBR1,IENS1,443,"E"))
 S SURG("Surg","intraopDisseminatedCancerCd")=$G(SURGARR(FNBR1,IENS1,443,"I"))
 S SURG("Surg","preoperativeAnionGap")=$G(SURGARR(FNBR1,IENS1,444,"E"))
 S SURG("Surg","preopAnionGapDate")=$G(SURGARR(FNBR1,IENS1,444.1,"E"))
 S SURG("Surg","preopAnionGapDateFM")=$G(SURGARR(FNBR1,IENS1,444.1,"I"))
 S SURG("Surg","preopAnionGapDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,444.1,"I")))
 S SURG("Surg","preopAnionGapDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,444.1,"I")))
 S SURG("Surg","highestAnionGap")=$G(SURGARR(FNBR1,IENS1,445,"E"))
 S SURG("Surg","highAnionGapDate")=$G(SURGARR(FNBR1,IENS1,445.1,"E"))
 S SURG("Surg","highAnionGapDateFM")=$G(SURGARR(FNBR1,IENS1,445.1,"I"))
 S SURG("Surg","highAnionGapDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,445.1,"I")))
 S SURG("Surg","highAnionGapDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,445.1,"I")))
 S SURG("Surg","intraoperativeAscites")=$G(SURGARR(FNBR1,IENS1,446,"E"))
 S SURG("Surg","intraoperativeAscitesCd")=$G(SURGARR(FNBR1,IENS1,446,"I"))
 S SURG("Surg","clostridiumDifficileColitis")=$G(SURGARR(FNBR1,IENS1,447,"E"))
 S SURG("Surg","clostridiumDifficileColitisCd")=$G(SURGARR(FNBR1,IENS1,447,"I"))
 S SURG("Surg","postopAtrialFibrillation")=$G(SURGARR(FNBR1,IENS1,448,"E"))
 S SURG("Surg","postopAtrialFibrillationCd")=$G(SURGARR(FNBR1,IENS1,448,"I"))
 S SURG("Surg","totalIschemicTime")=$G(SURGARR(FNBR1,IENS1,450,"E"))
 S SURG("Surg","totalCpbTime")=$G(SURGARR(FNBR1,IENS1,451,"E"))
 S SURG("Surg","observationAdmissionDate")=$G(SURGARR(FNBR1,IENS1,452,"E"))
 S SURG("Surg","observationDischargeDate")=$G(SURGARR(FNBR1,IENS1,453,"E"))
 S SURG("Surg","observationTreatingSpecialty")=$G(SURGARR(FNBR1,IENS1,454,"E"))
 S SURG("Surg","observationTreatingSpecialtyId")=$G(SURGARR(FNBR1,IENS1,454,"I"))
 S SURG("Surg","highestSerumTroponinI")=$G(SURGARR(FNBR1,IENS1,455,"E"))
 S SURG("Surg","highSerumTroponinIDate")=$G(SURGARR(FNBR1,IENS1,455.1,"E"))
 S SURG("Surg","highSerumTroponinIDateFM")=$G(SURGARR(FNBR1,IENS1,455.1,"I"))
 S SURG("Surg","highSerumTroponinIDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,455.1,"I")))
 S SURG("Surg","highSerumTroponinIDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,455.1,"I")))
 S SURG("Surg","highestSerumTroponinT")=$G(SURGARR(FNBR1,IENS1,456,"E"))
 S SURG("Surg","highSerumTroponinTDate")=$G(SURGARR(FNBR1,IENS1,456.1,"E"))
 S SURG("Surg","highSerumTroponinTDateFM")=$G(SURGARR(FNBR1,IENS1,456.1,"I"))
 S SURG("Surg","highSerumTroponinTDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,456.1,"I")))
 S SURG("Surg","highSerumTroponinTDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,456.1,"I")))
 S SURG("Surg","hdlCardiac")=$G(SURGARR(FNBR1,IENS1,457,"E"))
 S SURG("Surg","hdlDate")=$G(SURGARR(FNBR1,IENS1,457.1,"E"))
 S SURG("Surg","serumTriglycerideCardiac")=$G(SURGARR(FNBR1,IENS1,458,"E"))
 S SURG("Surg","serumTriglycerideDateCar")=$G(SURGARR(FNBR1,IENS1,458.1,"E"))
 S SURG("Surg","serumPotassiumCardiac")=$G(SURGARR(FNBR1,IENS1,459,"E"))
 S SURG("Surg","serumPotassiumDateCardiac")=$G(SURGARR(FNBR1,IENS1,459.1,"E"))
 S SURG("Surg","serumBilirubinCardiac")=$G(SURGARR(FNBR1,IENS1,460,"E"))
 S SURG("Surg","serumBilirubinDateCard")=$G(SURGARR(FNBR1,IENS1,460.1,"E"))
 S SURG("Surg","ldlCardiac")=$G(SURGARR(FNBR1,IENS1,461,"E"))
 S SURG("Surg","ldlDateCardiac")=$G(SURGARR(FNBR1,IENS1,461.1,"E"))
 S SURG("Surg","totalCholesterolCardiac")=$G(SURGARR(FNBR1,IENS1,462,"E"))
 S SURG("Surg","totalCholesterolDate")=$G(SURGARR(FNBR1,IENS1,462.1,"E"))
 S SURG("Surg","tracheostomy")=$G(SURGARR(FNBR1,IENS1,466,"E"))
 S SURG("Surg","tracheostomyCd")=$G(SURGARR(FNBR1,IENS1,466,"I"))
 S SURG("Surg","newMechanicalCirculatory")=$G(SURGARR(FNBR1,IENS1,467,"E"))
 S SURG("Surg","newMechanicalCirculatoryCd")=$G(SURGARR(FNBR1,IENS1,467,"I"))
 S SURG("Surg","incisionType")=$G(SURGARR(FNBR1,IENS1,468,"E"))
 S SURG("Surg","incisionTypeCd")=$G(SURGARR(FNBR1,IENS1,468,"I"))
 S SURG("Surg","convertFromOffPumpToCpb")=$G(SURGARR(FNBR1,IENS1,469,"E"))
 S SURG("Surg","convertFromOffPumpToCpbCd")=$G(SURGARR(FNBR1,IENS1,469,"I"))
 S SURG("Surg","dTPatientExtubated")=$G(SURGARR(FNBR1,IENS1,470,"E"))
 S SURG("Surg","dTPatientDischFromIcu")=$G(SURGARR(FNBR1,IENS1,471,"E"))
 S SURG("Surg","homeless")=$G(SURGARR(FNBR1,IENS1,473,"E"))
 S SURG("Surg","homelessCd")=$G(SURGARR(FNBR1,IENS1,473,"I"))
 S SURG("Surg","preopCirculatoryDevice")=$G(SURGARR(FNBR1,IENS1,474,"E"))
 S SURG("Surg","preopCirculatoryDeviceCd")=$G(SURGARR(FNBR1,IENS1,474,"I"))
 S SURG("Surg","procedureType")=$G(SURGARR(FNBR1,IENS1,476,"E"))
 S SURG("Surg","procedureTypeCd")=$G(SURGARR(FNBR1,IENS1,476,"I"))
 S SURG("Surg","aorticStenosis")=$G(SURGARR(FNBR1,IENS1,477,"E"))
 S SURG("Surg","aorticStenosisCd")=$G(SURGARR(FNBR1,IENS1,477,"I"))
 S SURG("Surg","reDoLadStenosis")=$G(SURGARR(FNBR1,IENS1,478,"E"))
 S SURG("Surg","reDoRtCoronaryStenosis")=$G(SURGARR(FNBR1,IENS1,479,"E"))
 S SURG("Surg","reDoCircumflexStenosis")=$G(SURGARR(FNBR1,IENS1,480,"E"))
 S SURG("Surg","bridgeToTransplantDevice")=$G(SURGARR(FNBR1,IENS1,481,"E"))
 S SURG("Surg","bridgeToTransplantDeviceCd")=$G(SURGARR(FNBR1,IENS1,481,"I"))
 S SURG("Surg","priorHeartSurgery")=$G(SURGARR(FNBR1,IENS1,485,"E"))
 S SURG("Surg","gastrointestinalYN")=$G(SURGARR(FNBR1,IENS1,486,"E"))
 S SURG("Surg","gastrointestinalYNCd")=$G(SURGARR(FNBR1,IENS1,486,"I"))
 S SURG("Surg","preoperativeInr")=$G(SURGARR(FNBR1,IENS1,487,"E"))
 S SURG("Surg","preoperativeInrDate")=$G(SURGARR(FNBR1,IENS1,487.1,"E"))
 S SURG("Surg","preoperativeInrDateFM")=$G(SURGARR(FNBR1,IENS1,487.1,"I"))
 S SURG("Surg","preoperativeInrDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,487.1,"I")))
 S SURG("Surg","preoperativeInrDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,487.1,"I")))
 S SURG("Surg","organSpaceSsi")=$G(SURGARR(FNBR1,IENS1,488,"E"))
 S SURG("Surg","organSpaceSsiCd")=$G(SURGARR(FNBR1,IENS1,488,"I"))
 S SURG("Surg","otherWoundOccurrence")=$G(SURGARR(FNBR1,IENS1,489,"E"))
 S SURG("Surg","otherWoundOccurrenceId")=$G(SURGARR(FNBR1,IENS1,489,"I"))
 S SURG("Surg","otherNonCtProcedures")=$G(SURGARR(FNBR1,IENS1,491,"E"))
 S SURG("Surg","preopFunctHealthStatus")=$G(SURGARR(FNBR1,IENS1,492,"E"))
 S SURG("Surg","preopFunctHealthStatusCd")=$G(SURGARR(FNBR1,IENS1,492,"I"))
 S SURG("Surg","pfssAccountReference")=$G(SURGARR(FNBR1,IENS1,500,"E"))
 S SURG("Surg","pfssAccountReferenceId")=$G(SURGARR(FNBR1,IENS1,500,"I"))
 S SURG("Surg","hemoglobinA1c")=$G(SURGARR(FNBR1,IENS1,504,"E"))
 S SURG("Surg","hemoglobinA1cDate")=$G(SURGARR(FNBR1,IENS1,504.1,"E"))
 S SURG("Surg","hairRemovalMethod")=$G(SURGARR(FNBR1,IENS1,506,"E"))
 S SURG("Surg","hairRemovalMethodCd")=$G(SURGARR(FNBR1,IENS1,506,"I"))
 S SURG("Surg","bnp")=$G(SURGARR(FNBR1,IENS1,507,"E"))
 S SURG("Surg","bnpDate")=$G(SURGARR(FNBR1,IENS1,507.1,"E"))
 S SURG("Surg","hairRemovalComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,508,Z)) QUIT:'+Z  D
 . S SURG("Surg","hairRemovalComments")=SURG("Surg","hairRemovalComments")_$G(SURGARR(FNBR1,IENS1,508,Z))
 S SURG("Surg","preopAtrialFibrillation")=$G(SURGARR(FNBR1,IENS1,509,"E"))
 S SURG("Surg","preopAtrialFibrillationCd")=$G(SURGARR(FNBR1,IENS1,509,"I"))
 S SURG("Surg","surgeryConsultDate")=$G(SURGARR(FNBR1,IENS1,513,"E"))
 S SURG("Surg","primaryCauseForDelay")=$G(SURGARR(FNBR1,IENS1,515,"E"))
 S SURG("Surg","primaryCauseForDelayCd")=$G(SURGARR(FNBR1,IENS1,515,"I"))
 S SURG("Surg","surgeryConsultRequested")=$G(SURGARR(FNBR1,IENS1,516,"E"))
 S SURG("Surg","tobaccoUse")=$G(SURGARR(FNBR1,IENS1,517,"E"))
 S SURG("Surg","tobaccoUseCd")=$G(SURGARR(FNBR1,IENS1,517,"I"))
 S SURG("Surg","tobaccoUseTimeframe")=$G(SURGARR(FNBR1,IENS1,518,"E"))
 S SURG("Surg","tobaccoUseTimeframeCd")=$G(SURGARR(FNBR1,IENS1,518,"I"))
 S SURG("Surg","diabetesMellitusChronic")=$G(SURGARR(FNBR1,IENS1,519,"E"))
 S SURG("Surg","diabetesMellitusChronicCd")=$G(SURGARR(FNBR1,IENS1,519,"I"))
 S SURG("Surg","diabetesMellitusPreopMgmt")=$G(SURGARR(FNBR1,IENS1,520,"E"))
 S SURG("Surg","diabetesMellitusPreopMgmtCd")=$G(SURGARR(FNBR1,IENS1,520,"I"))
 S SURG("Surg","cvdRepairObstruction")=$G(SURGARR(FNBR1,IENS1,521,"E"))
 S SURG("Surg","cvdRepairObstructionCd")=$G(SURGARR(FNBR1,IENS1,521,"I"))
 S SURG("Surg","historyOfCvd")=$G(SURGARR(FNBR1,IENS1,522,"E"))
 S SURG("Surg","historyOfCvdCd")=$G(SURGARR(FNBR1,IENS1,522,"I"))
 S SURG("Surg","confirmPatientIdentity")=$G(SURGARR(FNBR1,IENS1,600,"E"))
 S SURG("Surg","confirmPatientIdentityCd")=$G(SURGARR(FNBR1,IENS1,600,"I"))
 S SURG("Surg","procedureToBePerformed")=$G(SURGARR(FNBR1,IENS1,601,"E"))
 S SURG("Surg","procedureToBePerformedCd")=$G(SURGARR(FNBR1,IENS1,601,"I"))
 S SURG("Surg","siteOfProcedure")=$G(SURGARR(FNBR1,IENS1,602,"E"))
 S SURG("Surg","siteOfProcedureCd")=$G(SURGARR(FNBR1,IENS1,602,"I"))
 S SURG("Surg","confirmValidConsent")=$G(SURGARR(FNBR1,IENS1,603,"E"))
 S SURG("Surg","confirmValidConsentCd")=$G(SURGARR(FNBR1,IENS1,603,"I"))
 S SURG("Surg","confirmPatientPosition")=$G(SURGARR(FNBR1,IENS1,604,"E"))
 S SURG("Surg","confirmPatientPositionCd")=$G(SURGARR(FNBR1,IENS1,604,"I"))
 S SURG("Surg","markedSiteConfirmed")=$G(SURGARR(FNBR1,IENS1,605,"E"))
 S SURG("Surg","markedSiteConfirmedCd")=$G(SURGARR(FNBR1,IENS1,605,"I"))
 S SURG("Surg","preoperativeImagesConfirmed")=$G(SURGARR(FNBR1,IENS1,606,"E"))
 S SURG("Surg","preoperativeImagesConfirmedCd")=$G(SURGARR(FNBR1,IENS1,606,"I"))
 S SURG("Surg","correctMedicalImplants")=$G(SURGARR(FNBR1,IENS1,607,"E"))
 S SURG("Surg","correctMedicalImplantsCd")=$G(SURGARR(FNBR1,IENS1,607,"I"))
 S SURG("Surg","antibioticProphylaxis")=$G(SURGARR(FNBR1,IENS1,608,"E"))
 S SURG("Surg","antibioticProphylaxisCd")=$G(SURGARR(FNBR1,IENS1,608,"I"))
 S SURG("Surg","appropriateDvtProphylaxis")=$G(SURGARR(FNBR1,IENS1,609,"E"))
 S SURG("Surg","appropriateDvtProphylaxisCd")=$G(SURGARR(FNBR1,IENS1,609,"I"))
 S SURG("Surg","bloodAvailability")=$G(SURGARR(FNBR1,IENS1,610,"E"))
 S SURG("Surg","bloodAvailabilityCd")=$G(SURGARR(FNBR1,IENS1,610,"I"))
 S SURG("Surg","availabilityOfSpecialEquip")=$G(SURGARR(FNBR1,IENS1,611,"E"))
 S SURG("Surg","availabilityOfSpecialEquipCd")=$G(SURGARR(FNBR1,IENS1,611,"I"))
 S SURG("Surg","originalDesiredDate")=$G(SURGARR(FNBR1,IENS1,612,"E"))
 S SURG("Surg","originalDesiredDateFM")=$G(SURGARR(FNBR1,IENS1,612,"I"))
 S SURG("Surg","originalDesiredDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,612,"I")))
 S SURG("Surg","originalDesiredDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,612,"I")))
 S SURG("Surg","dTOfDesiredProcedureDate")=$G(SURGARR(FNBR1,IENS1,613,"E"))
 S SURG("Surg","dTOfDesiredProcedureDateFM")=$G(SURGARR(FNBR1,IENS1,613,"I"))
 S SURG("Surg","dTOfDesiredProcedureDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,613,"I")))
 S SURG("Surg","dTOfDesiredProcedureDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,613,"I")))
 S SURG("Surg","originalScheduledDate")=$G(SURGARR(FNBR1,IENS1,614,"E"))
 S SURG("Surg","originalScheduledDateFM")=$G(SURGARR(FNBR1,IENS1,614,"I"))
 S SURG("Surg","originalScheduledDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,614,"I")))
 S SURG("Surg","originalScheduledDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,614,"I")))
 S SURG("Surg","dTOfScheduledDateEntry")=$G(SURGARR(FNBR1,IENS1,615,"E"))
 S SURG("Surg","dTOfScheduledDateEntryFM")=$G(SURGARR(FNBR1,IENS1,615,"I"))
 S SURG("Surg","dTOfScheduledDateEntryHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,615,"I")))
 S SURG("Surg","dTOfScheduledDateEntryFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,615,"I")))
 S SURG("Surg","desiredProcedureDate")=$G(SURGARR(FNBR1,IENS1,616,"E"))
 S SURG("Surg","desiredProcedureDateFM")=$G(SURGARR(FNBR1,IENS1,616,"I"))
 S SURG("Surg","desiredProcedureDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,616,"I")))
 S SURG("Surg","desiredProcedureDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,616,"I")))
 S SURG("Surg","scheduledDate")=$G(SURGARR(FNBR1,IENS1,617,"E"))
 S SURG("Surg","scheduledDateFM")=$G(SURGARR(FNBR1,IENS1,617,"I"))
 S SURG("Surg","scheduledDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,617,"I")))
 S SURG("Surg","scheduledDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,617,"I")))
 S SURG("Surg","positiveDrugScreening")=$G(SURGARR(FNBR1,IENS1,618,"E"))
 S SURG("Surg","positiveDrugScreeningCd")=$G(SURGARR(FNBR1,IENS1,618,"I"))
 S SURG("Surg","immedUseContamination")=$G(SURGARR(FNBR1,IENS1,619,"E"))
 S SURG("Surg","immedUseSpsOrMgtIssue")=$G(SURGARR(FNBR1,IENS1,620,"E"))
 S SURG("Surg","immedUseEmergencyCase")=$G(SURGARR(FNBR1,IENS1,621,"E"))
 S SURG("Surg","immedUseNoBetterOption")=$G(SURGARR(FNBR1,IENS1,622,"E"))
 S SURG("Surg","immedUseLoanerInstrument")=$G(SURGARR(FNBR1,IENS1,623,"E"))
 S SURG("Surg","immedUseDecontamination")=$G(SURGARR(FNBR1,IENS1,624,"E"))
 S SURG("Surg","possibleItemRetention")=$G(SURGARR(FNBR1,IENS1,630,"E"))
 S SURG("Surg","possibleItemRetentionCd")=$G(SURGARR(FNBR1,IENS1,630,"I"))
 S SURG("Surg","woundSweep")=$G(SURGARR(FNBR1,IENS1,633,"E"))
 S SURG("Surg","woundSweepCd")=$G(SURGARR(FNBR1,IENS1,633,"I"))
 S SURG("Surg","woundSweepComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,635,Z)) QUIT:'+Z  D
 . S SURG("Surg","woundSweepComments")=SURG("Surg","woundSweepComments")_$G(SURGARR(FNBR1,IENS1,635,Z))
 S SURG("Surg","intraOperativeXRay")=$G(SURGARR(FNBR1,IENS1,636,"E"))
 S SURG("Surg","intraOperativeXRayCd")=$G(SURGARR(FNBR1,IENS1,636,"I"))
 S SURG("Surg","intraOperativeXrayComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,637,Z)) QUIT:'+Z  D
 . S SURG("Surg","intraOperativeXrayComments")=SURG("Surg","intraOperativeXrayComments")_$G(SURGARR(FNBR1,IENS1,637,Z))
 S SURG("Surg","lateralityOfProcedure")=$G(SURGARR(FNBR1,IENS1,638,"E"))
 S SURG("Surg","lateralityOfProcedureCd")=$G(SURGARR(FNBR1,IENS1,638,"I"))
 S SURG("Surg","reportGivenTo")=$G(SURGARR(FNBR1,IENS1,639,"E"))
 S SURG("Surg","reportGivenToId")=$G(SURGARR(FNBR1,IENS1,639,"I"))
 S SURG("Surg","pci")=$G(SURGARR(FNBR1,IENS1,640,"E"))
 S SURG("Surg","pciCd")=$G(SURGARR(FNBR1,IENS1,640,"I"))
 S SURG("Surg","hypertension")=$G(SURGARR(FNBR1,IENS1,641,"E"))
 S SURG("Surg","hypertensionCd")=$G(SURGARR(FNBR1,IENS1,641,"I"))
 S SURG("Surg","bleedingRiskDueToMed")=$G(SURGARR(FNBR1,IENS1,642,"E"))
 S SURG("Surg","bleedingRiskDueToMedCd")=$G(SURGARR(FNBR1,IENS1,642,"I"))
 S SURG("Surg","anginaTimeframe")=$G(SURGARR(FNBR1,IENS1,643,"E"))
 S SURG("Surg","anginaTimeframeCd")=$G(SURGARR(FNBR1,IENS1,643,"I"))
 S SURG("Surg","symptomaticUti")=$G(SURGARR(FNBR1,IENS1,644,"E"))
 S SURG("Surg","symptomaticUtiCd")=$G(SURGARR(FNBR1,IENS1,644,"I"))
 S SURG("Surg","unosNumber")=$G(SURGARR(FNBR1,IENS1,648,"E"))
 S SURG("Surg","donorSerologyHcv")=$G(SURGARR(FNBR1,IENS1,649,"E"))
 S SURG("Surg","donorSerologyHcvCd")=$G(SURGARR(FNBR1,IENS1,649,"I"))
 S SURG("Surg","donorSerologyHbv")=$G(SURGARR(FNBR1,IENS1,650,"E"))
 S SURG("Surg","donorSerologyHbvCd")=$G(SURGARR(FNBR1,IENS1,650,"I"))
 S SURG("Surg","donorSerologyCmv")=$G(SURGARR(FNBR1,IENS1,651,"E"))
 S SURG("Surg","donorSerologyCmvCd")=$G(SURGARR(FNBR1,IENS1,651,"I"))
 S SURG("Surg","donorSerologyHiv")=$G(SURGARR(FNBR1,IENS1,652,"E"))
 S SURG("Surg","donorSerologyHivCd")=$G(SURGARR(FNBR1,IENS1,652,"I"))
 S SURG("Surg","donorAboType")=$G(SURGARR(FNBR1,IENS1,653,"E"))
 S SURG("Surg","donorAboTypeCd")=$G(SURGARR(FNBR1,IENS1,653,"I"))
 S SURG("Surg","recipientAboType")=$G(SURGARR(FNBR1,IENS1,654,"E"))
 S SURG("Surg","recipientAboTypeCd")=$G(SURGARR(FNBR1,IENS1,654,"I"))
 S SURG("Surg","bloodBankAboVerification")=$G(SURGARR(FNBR1,IENS1,655,"E"))
 S SURG("Surg","bloodBankAboVerificationCd")=$G(SURGARR(FNBR1,IENS1,655,"I"))
 S SURG("Surg","orAboVerificationYN")=$G(SURGARR(FNBR1,IENS1,656,"E"))
 S SURG("Surg","orAboVerificationYNCd")=$G(SURGARR(FNBR1,IENS1,656,"I"))
 S SURG("Surg","surgeonVerifyingUnet")=$G(SURGARR(FNBR1,IENS1,657,"E"))
 S SURG("Surg","surgeonVerifyingUnetId")=$G(SURGARR(FNBR1,IENS1,657,"I"))
 S SURG("Surg","surgeonVerifyingUnetResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","surgeonVerifyingUnetId"))
 S SURG("Surg","organVerPreAnesthesia")=$G(SURGARR(FNBR1,IENS1,658,"E"))
 S SURG("Surg","organVerPreAnesthesiaCd")=$G(SURGARR(FNBR1,IENS1,658,"I"))
 S SURG("Surg","surgeonVerDonorOrgPreAnes")=$G(SURGARR(FNBR1,IENS1,659,"E"))
 S SURG("Surg","surgeonVerDonorOrgPreAnesId")=$G(SURGARR(FNBR1,IENS1,659,"I"))
 S SURG("Surg","surgeonVerDonorOrgPreAnesResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","surgeonVerDonorOrgPreAnesId"))
 S SURG("Surg","organVerPreTransplant")=$G(SURGARR(FNBR1,IENS1,660,"E"))
 S SURG("Surg","organVerPreTransplantCd")=$G(SURGARR(FNBR1,IENS1,660,"I"))
 S SURG("Surg","palliation")=$G(SURGARR(FNBR1,IENS1,661,"E"))
 S SURG("Surg","palliationCd")=$G(SURGARR(FNBR1,IENS1,661,"I"))
 S SURG("Surg","impairedCognitiveFunction")=$G(SURGARR(FNBR1,IENS1,662,"E"))
 S SURG("Surg","impairedCognitiveFunctionCd")=$G(SURGARR(FNBR1,IENS1,662,"I"))
 S SURG("Surg","donorVesselUsage")=$G(SURGARR(FNBR1,IENS1,663,"E"))
 S SURG("Surg","donorVesselUsageCd")=$G(SURGARR(FNBR1,IENS1,663,"I"))
 S SURG("Surg","donorVesselDisposition")=$G(SURGARR(FNBR1,IENS1,665,"E"))
 S SURG("Surg","donorVesselDispositionCd")=$G(SURGARR(FNBR1,IENS1,665,"I"))
 S SURG("Surg","liverDiseaseCirrhosis")=$G(SURGARR(FNBR1,IENS1,666,"E"))
 S SURG("Surg","liverDiseaseCirrhosisCd")=$G(SURGARR(FNBR1,IENS1,666,"I"))
 S SURG("Surg","sleepApneaCompliance")=$G(SURGARR(FNBR1,IENS1,667,"E"))
 S SURG("Surg","sleepApneaComplianceCd")=$G(SURGARR(FNBR1,IENS1,667,"I"))
 S SURG("Surg","immunocompromisedStatePreop")=$G(SURGARR(FNBR1,IENS1,668,"E"))
 S SURG("Surg","immunocompromisedStatePreopCd")=$G(SURGARR(FNBR1,IENS1,668,"I"))
 S SURG("Surg","pulmonaryHtn")=$G(SURGARR(FNBR1,IENS1,669,"E"))
 S SURG("Surg","pulmonaryHtnCd")=$G(SURGARR(FNBR1,IENS1,669,"I"))
 S SURG("Surg","residence30DaysPreop")=$G(SURGARR(FNBR1,IENS1,670,"E"))
 S SURG("Surg","residence30DaysPreopCd")=$G(SURGARR(FNBR1,IENS1,670,"I"))
 S SURG("Surg","ambulationDevicePreop")=$G(SURGARR(FNBR1,IENS1,671,"E"))
 S SURG("Surg","ambulationDevicePreopCd")=$G(SURGARR(FNBR1,IENS1,671,"I"))
 S SURG("Surg","nutritionalSupplementPreop")=$G(SURGARR(FNBR1,IENS1,672,"E"))
 S SURG("Surg","nutritionalSupplementPreopCd")=$G(SURGARR(FNBR1,IENS1,672,"I"))
 S SURG("Surg","historyOfCancerDiagnosis")=$G(SURGARR(FNBR1,IENS1,673,"E"))
 S SURG("Surg","historyOfCancerDiagnosisCd")=$G(SURGARR(FNBR1,IENS1,673,"I"))
 S SURG("Surg","hxRadRxPlannedSurgField")=$G(SURGARR(FNBR1,IENS1,674,"E"))
 S SURG("Surg","hxRadRxPlannedSurgFieldCd")=$G(SURGARR(FNBR1,IENS1,674,"I"))
 S SURG("Surg","priorInfecInflamSurgField")=$G(SURGARR(FNBR1,IENS1,675,"E"))
 S SURG("Surg","priorInfecInflamSurgFieldCd")=$G(SURGARR(FNBR1,IENS1,675,"I"))
 S SURG("Surg","hxDeepVeinThrombosis")=$G(SURGARR(FNBR1,IENS1,676,"E"))
 S SURG("Surg","hxDeepVeinThrombosisCd")=$G(SURGARR(FNBR1,IENS1,676,"I"))
 S SURG("Surg","priorSurgSameOpField")=$G(SURGARR(FNBR1,IENS1,677,"E"))
 S SURG("Surg","priorSurgSameOpFieldCd")=$G(SURGARR(FNBR1,IENS1,677,"I"))
 S SURG("Surg","dcRelDestination")=$G(SURGARR(FNBR1,IENS1,685,"E"))
 S SURG("Surg","dcRelDestinationCd")=$G(SURGARR(FNBR1,IENS1,685,"I"))
 S SURG("Surg","aorticRegurgitation")=$G(SURGARR(FNBR1,IENS1,686,"E"))
 S SURG("Surg","aorticRegurgitationCd")=$G(SURGARR(FNBR1,IENS1,686,"I"))
 S SURG("Surg","injuryToAdjacentOrgan")=$G(SURGARR(FNBR1,IENS1,687,"E"))
 S SURG("Surg","injuryToAdjacentOrganCd")=$G(SURGARR(FNBR1,IENS1,687,"I"))
 S SURG("Surg","stomaComplications")=$G(SURGARR(FNBR1,IENS1,688,"E"))
 S SURG("Surg","stomaComplicationsCd")=$G(SURGARR(FNBR1,IENS1,688,"I"))
 S SURG("Surg","nonUnion")=$G(SURGARR(FNBR1,IENS1,689,"E"))
 S SURG("Surg","nonUnionCd")=$G(SURGARR(FNBR1,IENS1,689,"I"))
 S SURG("Surg","implantInfections")=$G(SURGARR(FNBR1,IENS1,690,"E"))
 S SURG("Surg","implantInfectionsCd")=$G(SURGARR(FNBR1,IENS1,690,"I"))
 S SURG("Surg","chyleLymphLeak")=$G(SURGARR(FNBR1,IENS1,691,"E"))
 S SURG("Surg","chyleLymphLeakCd")=$G(SURGARR(FNBR1,IENS1,691,"I"))
 S SURG("Surg","anastomoticLeak")=$G(SURGARR(FNBR1,IENS1,692,"E"))
 S SURG("Surg","anastomoticLeakCd")=$G(SURGARR(FNBR1,IENS1,692,"I"))
 S SURG("Surg","fistula")=$G(SURGARR(FNBR1,IENS1,693,"E"))
 S SURG("Surg","fistulaCd")=$G(SURGARR(FNBR1,IENS1,693,"I"))
 S SURG("Surg","necrotizingSoftTissInfect")=$G(SURGARR(FNBR1,IENS1,694,"E"))
 S SURG("Surg","necrotizingSoftTissInfectCd")=$G(SURGARR(FNBR1,IENS1,694,"I"))
 S SURG("Surg","otherBloodProductUnits")=$G(SURGARR(FNBR1,IENS1,695,"E"))
 S SURG("Surg","otherBloodProductUnitsCd")=$G(SURGARR(FNBR1,IENS1,695,"I"))
 S SURG("Surg","pressorsUsedIntraop")=$G(SURGARR(FNBR1,IENS1,696,"E"))
 S SURG("Surg","pressorsUsedIntraopCd")=$G(SURGARR(FNBR1,IENS1,696,"I"))
 S SURG("Surg","mitralStenosis")=$G(SURGARR(FNBR1,IENS1,697,"E"))
 S SURG("Surg","mitralStenosisCd")=$G(SURGARR(FNBR1,IENS1,697,"I"))
 S SURG("Surg","pciIntervention")=$G(SURGARR(FNBR1,IENS1,698,"E"))
 S SURG("Surg","pciInterventionCd")=$G(SURGARR(FNBR1,IENS1,698,"I"))
 S SURG("Surg","atrialArrhythmias")=$G(SURGARR(FNBR1,IENS1,699,"E"))
 S SURG("Surg","atrialArrhythmiasCd")=$G(SURGARR(FNBR1,IENS1,699,"I"))
 S SURG("Surg","headOrNeckCancer")=$G(SURGARR(FNBR1,IENS1,700,"E"))
 S SURG("Surg","headOrNeckCancerCd")=$G(SURGARR(FNBR1,IENS1,700,"I"))
 S SURG("Surg","macularDegeneration")=$G(SURGARR(FNBR1,IENS1,701,"E"))
 S SURG("Surg","macularDegenerationCd")=$G(SURGARR(FNBR1,IENS1,701,"I"))
 S SURG("Surg","glaucoma")=$G(SURGARR(FNBR1,IENS1,702,"E"))
 S SURG("Surg","glaucomaCd")=$G(SURGARR(FNBR1,IENS1,702,"I"))
 S SURG("Surg","hxRetinalDetachment")=$G(SURGARR(FNBR1,IENS1,704,"E"))
 S SURG("Surg","hxRetinalDetachmentCd")=$G(SURGARR(FNBR1,IENS1,704,"I"))
 S SURG("Surg","axialLenAnteriorChamDep")=$G(SURGARR(FNBR1,IENS1,705,"E"))
 S SURG("Surg","axialLenAnteriorChamDepCd")=$G(SURGARR(FNBR1,IENS1,705,"I"))
 S SURG("Surg","cornealGuttaeFuchsEndo")=$G(SURGARR(FNBR1,IENS1,706,"E"))
 S SURG("Surg","cornealGuttaeFuchsEndoCd")=$G(SURGARR(FNBR1,IENS1,706,"I"))
 S SURG("Surg","diabeticRetinopathy")=$G(SURGARR(FNBR1,IENS1,707,"E"))
 S SURG("Surg","diabeticRetinopathyCd")=$G(SURGARR(FNBR1,IENS1,707,"I"))
 S SURG("Surg","complexCataract")=$G(SURGARR(FNBR1,IENS1,708,"E"))
 S SURG("Surg","complexCataractCd")=$G(SURGARR(FNBR1,IENS1,708,"I"))
 S SURG("Surg","statin30DaysPreop")=$G(SURGARR(FNBR1,IENS1,709,"E"))
 S SURG("Surg","statin30DaysPreopCd")=$G(SURGARR(FNBR1,IENS1,709,"I"))
 S SURG("Surg","ipsilatCorticalEventPreop")=$G(SURGARR(FNBR1,IENS1,710,"E"))
 S SURG("Surg","ipsilatCorticalEventPreopCd")=$G(SURGARR(FNBR1,IENS1,710,"I"))
 S SURG("Surg","preopModifiedRankinScore")=$G(SURGARR(FNBR1,IENS1,711,"E"))
 S SURG("Surg","carotidSurAnatomicHighRisk")=$G(SURGARR(FNBR1,IENS1,712,"E"))
 S SURG("Surg","carotidSurAnatomicHighRiskCd")=$G(SURGARR(FNBR1,IENS1,712,"I"))
 S SURG("Surg","bypassCriticalLimbIschemia")=$G(SURGARR(FNBR1,IENS1,713,"E"))
 S SURG("Surg","bypassCriticalLimbIschemiaCd")=$G(SURGARR(FNBR1,IENS1,713,"I"))
 S SURG("Surg","endoleakAtCompletion")=$G(SURGARR(FNBR1,IENS1,715,"E"))
 S SURG("Surg","endoleakAtCompletionCd")=$G(SURGARR(FNBR1,IENS1,715,"I"))
 S SURG("Surg","highHeartRate6HrsPreop")=$G(SURGARR(FNBR1,IENS1,716,"E"))
 S SURG("Surg","highHeartRateIntraop")=$G(SURGARR(FNBR1,IENS1,717,"E"))
 S SURG("Surg","lowArterialPress6HrsPreop")=$G(SURGARR(FNBR1,IENS1,718,"E"))
 S SURG("Surg","highLacticAcid6HrsPreop")=$G(SURGARR(FNBR1,IENS1,719,"E"))
 S SURG("Surg","highLacticAcidIntraop")=$G(SURGARR(FNBR1,IENS1,720,"E"))
 S SURG("Surg","lowestPh6HrsPreop")=$G(SURGARR(FNBR1,IENS1,721,"E"))
 S SURG("Surg","lowestPhIntraop")=$G(SURGARR(FNBR1,IENS1,722,"E"))
 S SURG("Surg","lowArterialPressIntraop")=$G(SURGARR(FNBR1,IENS1,723,"E"))
 S SURG("Surg","oliguria60Cc2Hrs6HrsPreop")=$G(SURGARR(FNBR1,IENS1,724,"E"))
 S SURG("Surg","oliguria60Cc2Hrs6HrsPreopCd")=$G(SURGARR(FNBR1,IENS1,724,"I"))
 S SURG("Surg","oliguriaUrineOutputIntraop")=$G(SURGARR(FNBR1,IENS1,725,"E"))
 S SURG("Surg","oliguriaUrineOutputIntraopCd")=$G(SURGARR(FNBR1,IENS1,725,"I"))
 S SURG("Surg","lowestBicarbonate6HrsPreop")=$G(SURGARR(FNBR1,IENS1,726,"E"))
 S SURG("Surg","lowestBicarbonateIntraop")=$G(SURGARR(FNBR1,IENS1,727,"E"))
 S SURG("Surg","unitsTransfused6HrsPreop")=$G(SURGARR(FNBR1,IENS1,728,"E"))
 S SURG("Surg","vasopressorUsageAtOrEntry")=$G(SURGARR(FNBR1,IENS1,729,"E"))
 S SURG("Surg","vasopressorUsageAtOrEntryCd")=$G(SURGARR(FNBR1,IENS1,729,"I"))
 S SURG("Surg","cardiacArrest24HrsPreop")=$G(SURGARR(FNBR1,IENS1,730,"E"))
 S SURG("Surg","cardiacArrest24HrsPreopCd")=$G(SURGARR(FNBR1,IENS1,730,"I"))
 S SURG("Surg","dic6HrsPreop")=$G(SURGARR(FNBR1,IENS1,731,"E"))
 S SURG("Surg","dic6HrsPreopCd")=$G(SURGARR(FNBR1,IENS1,731,"I"))
 S SURG("Surg","hypoxemiaWIn6HrsPreop")=$G(SURGARR(FNBR1,IENS1,732,"E"))
 S SURG("Surg","hypoxemiaWIn6HrsPreopCd")=$G(SURGARR(FNBR1,IENS1,732,"I"))
 S SURG("Surg","endoleakAtFollowUp")=$G(SURGARR(FNBR1,IENS1,733,"E"))
 S SURG("Surg","endoleakAtFollowUpCd")=$G(SURGARR(FNBR1,IENS1,733,"I"))
 S SURG("Surg","cardiacArrestIntraop")=$G(SURGARR(FNBR1,IENS1,734,"E"))
 S SURG("Surg","cardiacArrestIntraopCd")=$G(SURGARR(FNBR1,IENS1,734,"I"))
 S SURG("Surg","floppyIrisIntraop")=$G(SURGARR(FNBR1,IENS1,735,"E"))
 S SURG("Surg","floppyIrisIntraopCd")=$G(SURGARR(FNBR1,IENS1,735,"I"))
 S SURG("Surg","preopVisualAcuity")=$G(SURGARR(FNBR1,IENS1,736,"E"))
 S SURG("Surg","preopVisualAcuityCd")=$G(SURGARR(FNBR1,IENS1,736,"I"))
 S SURG("Surg","postopVisualAcuity")=$G(SURGARR(FNBR1,IENS1,737,"E"))
 S SURG("Surg","postopVisualAcuityCd")=$G(SURGARR(FNBR1,IENS1,737,"I"))
 S SURG("Surg","endophthalmitisType")=$G(SURGARR(FNBR1,IENS1,738,"E"))
 S SURG("Surg","endophthalmitisTypeCd")=$G(SURGARR(FNBR1,IENS1,738,"I"))
 S SURG("Surg","cystoidMacularEdema")=$G(SURGARR(FNBR1,IENS1,739,"E"))
 S SURG("Surg","cystoidMacularEdemaCd")=$G(SURGARR(FNBR1,IENS1,739,"I"))
 S SURG("Surg","dislocationOfOperativeJoint")=$G(SURGARR(FNBR1,IENS1,740,"E"))
 S SURG("Surg","dislocationOfOperativeJointCd")=$G(SURGARR(FNBR1,IENS1,740,"I"))
 S SURG("Surg","periprostheticFractures")=$G(SURGARR(FNBR1,IENS1,741,"E"))
 S SURG("Surg","periprostheticFracturesCd")=$G(SURGARR(FNBR1,IENS1,741,"I"))
 S SURG("Surg","dTPatArrivesHospDaySurg")=$G(SURGARR(FNBR1,IENS1,742,"E"))
 S SURG("Surg","dTPatArrivesHospDaySurgFM")=$G(SURGARR(FNBR1,IENS1,742,"I"))
 S SURG("Surg","dTPatArrivesHospDaySurgHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,742,"I")))
 S SURG("Surg","dTPatArrivesHospDaySurgFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,742,"I")))
 S SURG("Surg","dTPatLeavesHospDaySurg")=$G(SURGARR(FNBR1,IENS1,743,"E"))
 S SURG("Surg","dTPatLeavesHospDaySurgFM")=$G(SURGARR(FNBR1,IENS1,743,"I"))
 S SURG("Surg","dTPatLeavesHospDaySurgHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,743,"I")))
 S SURG("Surg","dTPatLeavesHospDaySurgFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,743,"I")))
 S SURG("Surg","kidneyDonorProfileIndex")=$G(SURGARR(FNBR1,IENS1,744,"E"))
 S SURG("Surg","expectedPostTransplantIndex")=$G(SURGARR(FNBR1,IENS1,745,"E"))
 S SURG("Surg","bloodBankAboVerComments")=$G(SURGARR(FNBR1,IENS1,746,"E"))
 S SURG("Surg","dTBloodBankAboVerif")=$G(SURGARR(FNBR1,IENS1,747,"E"))
 S SURG("Surg","dTBloodBankAboVerifFM")=$G(SURGARR(FNBR1,IENS1,747,"I"))
 S SURG("Surg","dTBloodBankAboVerifHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,747,"I")))
 S SURG("Surg","dTBloodBankAboVerifFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,747,"I")))
 S SURG("Surg","orAboVerComments")=$G(SURGARR(FNBR1,IENS1,748,"E"))
 S SURG("Surg","dTOrAboVerif")=$G(SURGARR(FNBR1,IENS1,749,"E"))
 S SURG("Surg","dTOrAboVerifFM")=$G(SURGARR(FNBR1,IENS1,749,"I"))
 S SURG("Surg","dTOrAboVerifHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR1,IENS1,749,"I")))
 S SURG("Surg","dTOrAboVerifFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR1,IENS1,749,"I")))
 S SURG("Surg","unetVerifBySurgeonYN")=$G(SURGARR(FNBR1,IENS1,750,"E"))
 S SURG("Surg","unetVerifBySurgeonYNCd")=$G(SURGARR(FNBR1,IENS1,750,"I"))
 S SURG("Surg","surgeonVerOrganPreAnes")=$G(SURGARR(FNBR1,IENS1,751,"E"))
 S SURG("Surg","surgeonVerOrganPreAnesId")=$G(SURGARR(FNBR1,IENS1,751,"I"))
 S SURG("Surg","surgeonVerOrganPreAnesResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","surgeonVerOrganPreAnesId"))
 S SURG("Surg","donorOrgVerPreAnes")=$G(SURGARR(FNBR1,IENS1,752,"E"))
 S SURG("Surg","donorOrgVerPreAnesCd")=$G(SURGARR(FNBR1,IENS1,752,"I"))
 S SURG("Surg","surgeonVerOrgPreTransplant")=$G(SURGARR(FNBR1,IENS1,753,"E"))
 S SURG("Surg","surgeonVerOrgPreTransplantId")=$G(SURGARR(FNBR1,IENS1,753,"I"))
 S SURG("Surg","surgeonVerOrgPreTransplantResId")=$$RESID^SYNDHP69("V",SITE,9000010,SURG("Surg","surgeonVerOrgPreTransplantId"))
 S SURG("Surg","airwayIndex")=$G(SURGARR(FNBR1,IENS1,901,"E"))
 S SURG("Surg","airwayIndexCd")=$G(SURGARR(FNBR1,IENS1,901,"I"))
 S SURG("Surg","mallampatiScale")=$G(SURGARR(FNBR1,IENS1,901.1,"E"))
 S SURG("Surg","mallampatiScaleCd")=$G(SURGARR(FNBR1,IENS1,901.1,"I"))
 S SURG("Surg","mandibularSpace")=$G(SURGARR(FNBR1,IENS1,901.2,"E"))
 S SURG("Surg","deathUnrelatedRelated")=$G(SURGARR(FNBR1,IENS1,903,"E"))
 S SURG("Surg","deathUnrelatedRelatedCd")=$G(SURGARR(FNBR1,IENS1,903,"I"))
 S SURG("Surg","reviewOfDeathComments")=""
 N Z S Z=""
 F  S Z=$O(SURGARR(FNBR1,IENS1,904,Z)) QUIT:'+Z  D
 . S SURG("Surg","reviewOfDeathComments")=SURG("Surg","reviewOfDeathComments")_$G(SURGARR(FNBR1,IENS1,904,Z))
 S SURG("Surg","readyToTransmit")=$G(SURGARR(FNBR1,IENS1,905,"E"))
 S SURG("Surg","readyToTransmitCd")=$G(SURGARR(FNBR1,IENS1,905,"I"))
 S SURG("Surg","tiuOperativeSummary")=$G(SURGARR(FNBR1,IENS1,1000,"E"))
 S SURG("Surg","tiuOperativeSummaryId")=$G(SURGARR(FNBR1,IENS1,1000,"I"))
 S SURG("Surg","tiuNurseIntraopReport")=$G(SURGARR(FNBR1,IENS1,1001,"E"))
 S SURG("Surg","tiuNurseIntraopReportId")=$G(SURGARR(FNBR1,IENS1,1001,"I"))
 S SURG("Surg","tiuProcedureReportNonOr")=$G(SURGARR(FNBR1,IENS1,1002,"E"))
 S SURG("Surg","tiuProcedureReportNonOrId")=$G(SURGARR(FNBR1,IENS1,1002,"I"))
 S SURG("Surg","tiuAnesthesiaReport")=$G(SURGARR(FNBR1,IENS1,1003,"E"))
 S SURG("Surg","tiuAnesthesiaReportId")=$G(SURGARR(FNBR1,IENS1,1003,"I"))
 S SURG("Surg","dictatedSummaryExpected")=$G(SURGARR(FNBR1,IENS1,1004,"E"))
 S SURG("Surg","dictatedSummaryExpectedCd")=$G(SURGARR(FNBR1,IENS1,1004,"I"))
 S SURG("Surg","cptOnNurseReport")=$G(SURGARR(FNBR1,IENS1,1005,"E"))
 S SURG("Surg","cptOnNurseReportCd")=$G(SURGARR(FNBR1,IENS1,1005,"I"))
 S SURG("Surg","icdOnNurseReport")=$G(SURGARR(FNBR1,IENS1,1006,"E"))
 S SURG("Surg","icdOnNurseReportCd")=$G(SURGARR(FNBR1,IENS1,1006,"I"))
 ;
 N IENS2 S IENS2=""
 F  S IENS2=$O(SURGARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . N ORCIRC S ORCIRC=$NA(SURG("Surg","orCircSupports","orCircSupport",+IENS2))
 . S @ORCIRC@("orCircSupport")=$G(SURGARR(FNBR2,IENS2,.01,"E"))
 . S @ORCIRC@("orCircSupportId")=$G(SURGARR(FNBR2,IENS2,.01,"I"))
 . S @ORCIRC@("status")=$G(SURGARR(FNBR2,IENS2,3,"E"))
 . S @ORCIRC@("statusCd")=$G(SURGARR(FNBR2,IENS2,3,"I"))
 . S @ORCIRC@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR2_U_+IENS2)
 ;
 N IENS3 S IENS3=""
 F  S IENS3=$O(SURGARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOn")=$G(SURGARR(FNBR3,IENS3,.01,"E"))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOnFM")=$G(SURGARR(FNBR3,IENS3,.01,"I"))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOnHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR3,IENS3,.01,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOnFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR3,IENS3,.01,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOff")=$G(SURGARR(FNBR3,IENS3,1,"E"))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOffFM")=$G(SURGARR(FNBR3,IENS3,1,"I"))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOffHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR3,IENS3,1,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"timeOffFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR3,IENS3,1,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"reasonForRelief")=$G(SURGARR(FNBR3,IENS3,2,"E"))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"reasonForReliefCd")=$G(SURGARR(FNBR3,IENS3,2,"I"))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"comment")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR3,IENS3,3,Z)) QUIT:'+Z  D
 . . S SURG("Surg","timeOns","timeOn",+IENS3,"comment")=SURG("Surg","timeOns","timeOn",+IENS3,"comment")_$G(SURGARR(FNBR3,IENS3,3,Z))
 . S SURG("Surg","timeOns","timeOn",+IENS3,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR3_U_+IENS3)
 ;
 N IENS4 S IENS4=""
 F  S IENS4=$O(SURGARR(FNBR4,IENS4)) QUIT:IENS4=""  D
 . N ORSCRUB S ORSCRUB=$NA(SURG("Surg","orScrubSupports","orScrubSupport",+IENS4))
 . S @ORSCRUB@("orScrubSupport")=$G(SURGARR(FNBR4,IENS4,.01,"E"))
 . S @ORSCRUB@("orScrubSupportId")=$G(SURGARR(FNBR4,IENS4,.01,"I"))
 . S @ORSCRUB@("status")=$G(SURGARR(FNBR4,IENS4,3,"E"))
 . S @ORSCRUB@("statusCd")=$G(SURGARR(FNBR4,IENS4,3,"I"))
 . S @ORSCRUB@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR4_U_+IENS4)
 ;
 N IENS5 S IENS5=""
 F  S IENS5=$O(SURGARR(FNBR5,IENS5)) QUIT:IENS5=""  D
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOn")=$G(SURGARR(FNBR5,IENS5,.01,"E"))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOnFM")=$G(SURGARR(FNBR5,IENS5,.01,"I"))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOnHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR5,IENS5,.01,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOnFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR5,IENS5,.01,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOff")=$G(SURGARR(FNBR5,IENS5,1,"E"))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOffFM")=$G(SURGARR(FNBR5,IENS5,1,"I"))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOffHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR5,IENS5,1,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"timeOffFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR5,IENS5,1,"I")))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"reasonForRelief")=$G(SURGARR(FNBR5,IENS5,2,"E"))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"reasonForReliefCd")=$G(SURGARR(FNBR5,IENS5,2,"I"))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"comment")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR5,IENS5,3,Z)) QUIT:'+Z  D
 . . S SURG("Surg","timeOns","timeOn",+IENS5,"comment")=SURG("Surg","timeOns","timeOn",+IENS5,"comment")_$G(SURGARR(FNBR5,IENS5,3,Z))
 . S SURG("Surg","timeOns","timeOn",+IENS5,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR5_U_+IENS5)
 ;
 N IENS6 S IENS6=""
 F  S IENS6=$O(SURGARR(FNBR6,IENS6)) QUIT:IENS6=""  D
 . N RESTR S RESTR=$NA(SURG("Surg","restrPositionAidss","restrPositionAids",+IENS6))
 . S @RESTR@("restrPositionAids")=$G(SURGARR(FNBR6,IENS6,.01,"E"))
 . S @RESTR@("restrPositionAidsId")=$G(SURGARR(FNBR6,IENS6,.01,"I"))
 . S @RESTR@("appliedBy")=$G(SURGARR(FNBR6,IENS6,1,"E"))
 . S @RESTR@("appliedById")=$G(SURGARR(FNBR6,IENS6,1,"I"))
 . S @RESTR@("restraintComments")=$G(SURGARR(FNBR6,IENS6,2,"E"))
 . S @RESTR@("resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR6_U_+IENS6)
 ;
 N IENS7 S IENS7=""
 F  S IENS7=$O(SURGARR(FNBR7,IENS7)) QUIT:IENS7=""  D
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleStartTime")=$G(SURGARR(FNBR7,IENS7,.01,"E"))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleStartTimeFM")=$G(SURGARR(FNBR7,IENS7,.01,"I"))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleStartTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR7,IENS7,.01,"I")))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleStartTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR7,IENS7,.01,"I")))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleEndTime")=$G(SURGARR(FNBR7,IENS7,1,"E"))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleEndTimeFM")=$G(SURGARR(FNBR7,IENS7,1,"I"))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleEndTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR7,IENS7,1,"I")))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"anesCareMultipleEndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR7,IENS7,1,"I")))
 . S SURG("Surg","anesCareTimeBlocks","anesCareTimeBlock",+IENS7,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR7_U_+IENS7)
 ;
 N IENS8 S IENS8=""
 F  S IENS8=$O(SURGARR(FNBR8,IENS8)) QUIT:IENS8=""  D
 . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"replacementFluidType")=$G(SURGARR(FNBR8,IENS8,.01,"E"))
 . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"replacementFluidTypeId")=$G(SURGARR(FNBR8,IENS8,.01,"I"))
 . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"qtyOfFluidMl")=$G(SURGARR(FNBR8,IENS8,1,"E"))
 . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"sourceId")=$G(SURGARR(FNBR8,IENS8,3,"E"))
 . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"vaIdent")=$G(SURGARR(FNBR8,IENS8,4,"E"))
 . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"replacementFluidComments")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR8,IENS8,.01,Z)) QUIT:'+Z  D
 . . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"replacementFluidComments")=SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"replacementFluidComments")_$G(SURGARR(FNBR8,IENS8,.01,Z))
 . S SURG("Surg","replacementFluidTypes","replacementFluidType",+IENS8,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR8_U_+IENS8)
 ;
 N IENS9 S IENS9=""
 F  S IENS9=$O(SURGARR(FNBR9,IENS9)) QUIT:IENS9=""  D
 . S SURG("Surg","monitorss","monitors",+IENS9,"monitors")=$G(SURGARR(FNBR9,IENS9,.01,"E"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"monitorsId")=$G(SURGARR(FNBR9,IENS9,.01,"I"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeInstalled")=$G(SURGARR(FNBR9,IENS9,1,"E"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeInstalledFM")=$G(SURGARR(FNBR9,IENS9,1,"I"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeInstalledHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR9,IENS9,1,"I")))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeInstalledFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR9,IENS9,1,"I")))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeRemoved")=$G(SURGARR(FNBR9,IENS9,2,"E"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeRemovedFM")=$G(SURGARR(FNBR9,IENS9,2,"I"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeRemovedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR9,IENS9,2,"I")))
 . S SURG("Surg","monitorss","monitors",+IENS9,"timeRemovedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR9,IENS9,2,"I")))
 . S SURG("Surg","monitorss","monitors",+IENS9,"appliedBy")=$G(SURGARR(FNBR9,IENS9,3,"E"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"appliedById")=$G(SURGARR(FNBR9,IENS9,3,"I"))
 . S SURG("Surg","monitorss","monitors",+IENS9,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR9_U_+IENS9)
 ;
 N IENS10 S IENS10=""
 F  S IENS10=$O(SURGARR(FNBR10,IENS10)) QUIT:IENS10=""  D
 . S SURG("Surg","anesConcurrentCasess","anesConcurrentCases",+IENS10,"anesConcurrentCases")=$G(SURGARR(FNBR10,IENS10,.01,"E"))
 . S SURG("Surg","anesConcurrentCasess","anesConcurrentCases",+IENS10,"anesConcurrentCasesId")=$G(SURGARR(FNBR10,IENS10,.01,"I"))
 . S SURG("Surg","anesConcurrentCasess","anesConcurrentCases",+IENS10,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR10_U_+IENS10)
 ;
 N IENS11 S IENS11=""
 F  S IENS11=$O(SURGARR(FNBR11,IENS11)) QUIT:IENS11=""  D
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"anesthesiaTechnique")=$G(SURGARR(FNBR11,IENS11,.01,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"anesthesiaTechniqueCd")=$G(SURGARR(FNBR11,IENS11,.01,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"principalTech")=$G(SURGARR(FNBR11,IENS11,.05,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"principalTechCd")=$G(SURGARR(FNBR11,IENS11,.05,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"patientStatus")=$G(SURGARR(FNBR11,IENS11,2,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"patientStatusCd")=$G(SURGARR(FNBR11,IENS11,2,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"approach")=$G(SURGARR(FNBR11,IENS11,3,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"approachCd")=$G(SURGARR(FNBR11,IENS11,3,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"route")=$G(SURGARR(FNBR11,IENS11,4,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"routeCd")=$G(SURGARR(FNBR11,IENS11,4,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"laryngoscopeType")=$G(SURGARR(FNBR11,IENS11,5,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"laryngoscopeTypeCd")=$G(SURGARR(FNBR11,IENS11,5,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"laryngoscopeSize")=$G(SURGARR(FNBR11,IENS11,6,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"styletUsedYN")=$G(SURGARR(FNBR11,IENS11,7,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"styletUsedYNCd")=$G(SURGARR(FNBR11,IENS11,7,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"lidocaineTopical")=$G(SURGARR(FNBR11,IENS11,8,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"lidocaineTopicalCd")=$G(SURGARR(FNBR11,IENS11,8,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"lidocaineIv")=$G(SURGARR(FNBR11,IENS11,9,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"lidocaineIvCd")=$G(SURGARR(FNBR11,IENS11,9,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"tubeType")=$G(SURGARR(FNBR11,IENS11,10,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"tubeTypeCd")=$G(SURGARR(FNBR11,IENS11,10,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"tubeSize")=$G(SURGARR(FNBR11,IENS11,11,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"trauma")=$G(SURGARR(FNBR11,IENS11,12,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"traumaCd")=$G(SURGARR(FNBR11,IENS11,12,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"biteBlockYN")=$G(SURGARR(FNBR11,IENS11,13,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"biteBlockYNCd")=$G(SURGARR(FNBR11,IENS11,13,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"tubeLubrication")=$G(SURGARR(FNBR11,IENS11,14,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"tubeLubricationCd")=$G(SURGARR(FNBR11,IENS11,14,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"tapedAtLength")=$G(SURGARR(FNBR11,IENS11,15,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"breathSoundsOkBilat")=$G(SURGARR(FNBR11,IENS11,16,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"breathSoundsOkBilatCd")=$G(SURGARR(FNBR11,IENS11,16,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"heatMoistureExchanger")=$G(SURGARR(FNBR11,IENS11,17,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"heatMoistureExchangerCd")=$G(SURGARR(FNBR11,IENS11,17,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"bactFilterInCircuit")=$G(SURGARR(FNBR11,IENS11,18,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"bactFilterInCircuitCd")=$G(SURGARR(FNBR11,IENS11,18,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"endVentTV")=$G(SURGARR(FNBR11,IENS11,19,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"endVentRate")=$G(SURGARR(FNBR11,IENS11,20,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"extubatedIn")=$G(SURGARR(FNBR11,IENS11,21,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"extubatedInCd")=$G(SURGARR(FNBR11,IENS11,21,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"reintubatedWI8Hrs")=$G(SURGARR(FNBR11,IENS11,22,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"reintubatedWI8HrsCd")=$G(SURGARR(FNBR11,IENS11,22,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"preoxygenation")=$G(SURGARR(FNBR11,IENS11,23,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"preoxygenationCd")=$G(SURGARR(FNBR11,IENS11,23,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"anesthesiaAgents")=$G(SURGARR(FNBR11,IENS11,24,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"continuous")=$G(SURGARR(FNBR11,IENS11,25,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"continuousCd")=$G(SURGARR(FNBR11,IENS11,25,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"baricity")=$G(SURGARR(FNBR11,IENS11,26,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"baricityCd")=$G(SURGARR(FNBR11,IENS11,26,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"punctureSite")=$G(SURGARR(FNBR11,IENS11,27,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"punctureSiteCd")=$G(SURGARR(FNBR11,IENS11,27,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"spinalApproach")=$G(SURGARR(FNBR11,IENS11,28,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"spinalApproachCd")=$G(SURGARR(FNBR11,IENS11,28,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"needleSize")=$G(SURGARR(FNBR11,IENS11,29,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"needleSizeCd")=$G(SURGARR(FNBR11,IENS11,29,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"epiduralMethod")=$G(SURGARR(FNBR11,IENS11,30,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"epiduralMethodCd")=$G(SURGARR(FNBR11,IENS11,30,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"multipleAttempts")=$G(SURGARR(FNBR11,IENS11,31,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"multipleAttemptsCd")=$G(SURGARR(FNBR11,IENS11,31,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"testDose")=$G(SURGARR(FNBR11,IENS11,32,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"testDoseVolMl")=$G(SURGARR(FNBR11,IENS11,33,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"duralPuncture")=$G(SURGARR(FNBR11,IENS11,34,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"duralPunctureCd")=$G(SURGARR(FNBR11,IENS11,34,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"catheterRemovedBy")=$G(SURGARR(FNBR11,IENS11,35,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"catheterRemovedById")=$G(SURGARR(FNBR11,IENS11,35,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"administrationMethod")=$G(SURGARR(FNBR11,IENS11,36,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"administrationMethodCd")=$G(SURGARR(FNBR11,IENS11,36,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"purpose")=$G(SURGARR(FNBR11,IENS11,37,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"purposeCd")=$G(SURGARR(FNBR11,IENS11,37,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"blockSite")=$G(SURGARR(FNBR11,IENS11,38,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"extubatedBy")=$G(SURGARR(FNBR11,IENS11,39,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"extubatedById")=$G(SURGARR(FNBR11,IENS11,39,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"anesthesiaComments")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR11,IENS11,.01,Z)) QUIT:'+Z  D
 . . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"anesthesiaComments")=SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"anesthesiaComments")_$G(SURGARR(FNBR11,IENS11,.01,Z))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"monitoredAnesCareYN")=$G(SURGARR(FNBR11,IENS11,41,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"monitoredAnesCareYNCd")=$G(SURGARR(FNBR11,IENS11,41,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"intubatedYN")=$G(SURGARR(FNBR11,IENS11,42,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"intubatedYNCd")=$G(SURGARR(FNBR11,IENS11,42,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"level")=$G(SURGARR(FNBR11,IENS11,43,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"levelCd")=$G(SURGARR(FNBR11,IENS11,43,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"dateTimeCatheterRemoved")=$G(SURGARR(FNBR11,IENS11,44,"E"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"dateTimeCatheterRemovedFM")=$G(SURGARR(FNBR11,IENS11,44,"I"))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"dateTimeCatheterRemovedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR11,IENS11,44,"I")))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"dateTimeCatheterRemovedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR11,IENS11,44,"I")))
 . S SURG("Surg","anesthesiaTechniques","anesthesiaTechnique",+IENS11,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR11_U_+IENS11)
 ;
 N IENS12 S IENS12=""
 F  S IENS12=$O(SURGARR(FNBR12,IENS12)) QUIT:IENS12=""  D
 . S SURG("Surg","anesthesiaAgentss","anesthesiaAgents",+IENS12,"anesthesiaAgents")=$G(SURGARR(FNBR12,IENS12,.01,"E"))
 . S SURG("Surg","anesthesiaAgentss","anesthesiaAgents",+IENS12,"anesthesiaAgentsId")=$G(SURGARR(FNBR12,IENS12,.01,"I"))
 . S SURG("Surg","anesthesiaAgentss","anesthesiaAgents",+IENS12,"doseMg")=$G(SURGARR(FNBR12,IENS12,1,"E"))
 . S SURG("Surg","anesthesiaAgentss","anesthesiaAgents",+IENS12,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR12_U_+IENS12)
 ;
 N IENS13 S IENS13=""
 F  S IENS13=$O(SURGARR(FNBR13,IENS13)) QUIT:IENS13=""  D
 . S SURG("Surg","testDoses","testDose",+IENS13,"testDose")=$G(SURGARR(FNBR13,IENS13,.01,"E"))
 . S SURG("Surg","testDoses","testDose",+IENS13,"testDoseId")=$G(SURGARR(FNBR13,IENS13,.01,"I"))
 . S SURG("Surg","testDoses","testDose",+IENS13,"doseMg")=$G(SURGARR(FNBR13,IENS13,1,"E"))
 . S SURG("Surg","testDoses","testDose",+IENS13,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR13_U_+IENS13)
 ;
 N IENS14 S IENS14=""
 F  S IENS14=$O(SURGARR(FNBR14,IENS14)) QUIT:IENS14=""  D
 . S SURG("Surg","blockSites","blockSite",+IENS14,"blockSite")=$G(SURGARR(FNBR14,IENS14,.01,"E"))
 . S SURG("Surg","blockSites","blockSite",+IENS14,"blockSiteId")=$G(SURGARR(FNBR14,IENS14,.01,"I"))
 . S SURG("Surg","blockSites","blockSite",+IENS14,"needleLengthCm")=$G(SURGARR(FNBR14,IENS14,1,"E"))
 . S SURG("Surg","blockSites","blockSite",+IENS14,"needleGauge")=$G(SURGARR(FNBR14,IENS14,2,"E"))
 . S SURG("Surg","blockSites","blockSite",+IENS14,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR14_U_+IENS14)
 ;
 N IENS15 S IENS15=""
 F  S IENS15=$O(SURGARR(FNBR15,IENS15)) QUIT:IENS15=""  D
 . S SURG("Surg","medicationss","medications",+IENS15,"medications")=$G(SURGARR(FNBR15,IENS15,.01,"E"))
 . S SURG("Surg","medicationss","medications",+IENS15,"medicationsId")=$G(SURGARR(FNBR15,IENS15,.01,"I"))
 . S SURG("Surg","medicationss","medications",+IENS15,"timeAdm")=$G(SURGARR(FNBR15,IENS15,1,"E"))
 . S SURG("Surg","medicationss","medications",+IENS15,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR15_U_+IENS15)
 ;
 N IENS16 S IENS16=""
 F  S IENS16=$O(SURGARR(FNBR16,IENS16)) QUIT:IENS16=""  D
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"timeAdm")=$G(SURGARR(FNBR16,IENS16,.01,"E"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"timeAdmFM")=$G(SURGARR(FNBR16,IENS16,.01,"I"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"timeAdmHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR16,IENS16,.01,"I")))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"timeAdmFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR16,IENS16,.01,"I")))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"dose")=$G(SURGARR(FNBR16,IENS16,1,"E"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"orderedBy")=$G(SURGARR(FNBR16,IENS16,2,"E"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"orderedById")=$G(SURGARR(FNBR16,IENS16,2,"I"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"adminBy")=$G(SURGARR(FNBR16,IENS16,3,"E"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"adminById")=$G(SURGARR(FNBR16,IENS16,3,"I"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"route")=$G(SURGARR(FNBR16,IENS16,4,"E"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"routeCd")=$G(SURGARR(FNBR16,IENS16,4,"I"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"medicationComments")=$G(SURGARR(FNBR16,IENS16,5,"E"))
 . S SURG("Surg","timeAdms","timeAdm",+IENS16,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR16_U_+IENS16)
 ;
 N IENS17 S IENS17=""
 F  S IENS17=$O(SURGARR(FNBR17,IENS17)) QUIT:IENS17=""  D
 . S SURG("Surg","irrigations","irrigation",+IENS17,"irrigation")=$G(SURGARR(FNBR17,IENS17,.01,"E"))
 . S SURG("Surg","irrigations","irrigation",+IENS17,"irrigationId")=$G(SURGARR(FNBR17,IENS17,.01,"I"))
 . S SURG("Surg","irrigations","irrigation",+IENS17,"time")=$G(SURGARR(FNBR17,IENS17,1,"E"))
 . S SURG("Surg","irrigations","irrigation",+IENS17,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR17_U_+IENS17)
 ;
 N IENS18 S IENS18=""
 F  S IENS18=$O(SURGARR(FNBR18,IENS18)) QUIT:IENS18=""  D
 . S SURG("Surg","times","time",+IENS18,"time")=$G(SURGARR(FNBR18,IENS18,.01,"E"))
 . S SURG("Surg","times","time",+IENS18,"timeFM")=$G(SURGARR(FNBR18,IENS18,.01,"I"))
 . S SURG("Surg","times","time",+IENS18,"timeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR18,IENS18,.01,"I")))
 . S SURG("Surg","times","time",+IENS18,"timeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR18,IENS18,.01,"I")))
 . S SURG("Surg","times","time",+IENS18,"amountUsed")=$G(SURGARR(FNBR18,IENS18,1,"E"))
 . S SURG("Surg","times","time",+IENS18,"provider")=$G(SURGARR(FNBR18,IENS18,2,"E"))
 . S SURG("Surg","times","time",+IENS18,"providerId")=$G(SURGARR(FNBR18,IENS18,2,"I"))
 . S SURG("Surg","times","time",+IENS18,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR18_U_+IENS18)
 ;
 N IENS19 S IENS19=""
 F  S IENS19=$O(SURGARR(FNBR19,IENS19)) QUIT:IENS19=""  D
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"otherProcedure")=$G(SURGARR(FNBR19,IENS19,.01,"E"))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"procedureCodeComments")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR19,IENS19,1.5,Z)) QUIT:'+Z  D
 . . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"procedureCodeComments")=SURG("Surg","otherProceduress","otherProcedures",+IENS19,"procedureCodeComments")_$G(SURGARR(FNBR19,IENS19,1.5,Z))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"completed")=$G(SURGARR(FNBR19,IENS19,2,"E"))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"completedCd")=$G(SURGARR(FNBR19,IENS19,2,"I"))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"plannedOtherProcCptCode")=$G(SURGARR(FNBR19,IENS19,3,"E"))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"plannedOtherProcCptCodeId")=$G(SURGARR(FNBR19,IENS19,3,"I"))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"otherProcedureCptModifier")=$G(SURGARR(FNBR19,IENS19,4,"E"))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"otherAssocDiagnosis")=$G(SURGARR(FNBR19,IENS19,5,"E"))
 . S SURG("Surg","otherProceduress","otherProcedures",+IENS19,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR19_U_+IENS19)
 ;
 N IENS20 S IENS20=""
 F  S IENS20=$O(SURGARR(FNBR20,IENS20)) QUIT:IENS20=""  D
 . S SURG("Surg","otherProcedureCptModifiers","otherProcedureCptModifier",+IENS20,"otherProcedureCptModifier")=$G(SURGARR(FNBR20,IENS20,.01,"E"))
 . S SURG("Surg","otherProcedureCptModifiers","otherProcedureCptModifier",+IENS20,"otherProcedureCptModifierId")=$G(SURGARR(FNBR20,IENS20,.01,"I"))
 . S SURG("Surg","otherProcedureCptModifiers","otherProcedureCptModifier",+IENS20,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR20_U_+IENS20)
 ;
 N IENS21 S IENS21=""
 F  S IENS21=$O(SURGARR(FNBR21,IENS21)) QUIT:IENS21=""  D
 . S SURG("Surg","otherAssocDiagnosiss","otherAssocDiagnosis",+IENS21,"otherAssocDiagnosis")=$G(SURGARR(FNBR21,IENS21,.01,"E"))
 . S SURG("Surg","otherAssocDiagnosiss","otherAssocDiagnosis",+IENS21,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR21_U_+IENS21)
 ;
 N IENS22 S IENS22=""
 F  S IENS22=$O(SURGARR(FNBR22,IENS22)) QUIT:IENS22=""  D
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"prosthesisItem")=$G(SURGARR(FNBR22,IENS22,.01,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"prosthesisItemId")=$G(SURGARR(FNBR22,IENS22,.01,"I"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"vendor")=$G(SURGARR(FNBR22,IENS22,1,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"model")=$G(SURGARR(FNBR22,IENS22,2,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"lotSerialNo")=$G(SURGARR(FNBR22,IENS22,2.5,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"SterileCode")=$G(SURGARR(FNBR22,IENS22,3,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"SterileNumber")=$G(SURGARR(FNBR22,IENS22,4,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"sterileResp")=$G(SURGARR(FNBR22,IENS22,5,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"sterileRespCd")=$G(SURGARR(FNBR22,IENS22,5,"I"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"size")=$G(SURGARR(FNBR22,IENS22,6,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"quantity")=$G(SURGARR(FNBR22,IENS22,7,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"implantSterilityChecked")=$G(SURGARR(FNBR22,IENS22,8,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"implantSterilityCheckedCd")=$G(SURGARR(FNBR22,IENS22,8,"I"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"sterilityExpirationDate")=$G(SURGARR(FNBR22,IENS22,9,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"sterilityExpirationDateFM")=$G(SURGARR(FNBR22,IENS22,9,"I"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"sterilityExpirationDateHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR22,IENS22,9,"I")))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"sterilityExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR22,IENS22,9,"I")))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"rnVerifier")=$G(SURGARR(FNBR22,IENS22,10,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"rnVerifierId")=$G(SURGARR(FNBR22,IENS22,10,"I"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"lotNumber")=$G(SURGARR(FNBR22,IENS22,11,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"serialNumber")=$G(SURGARR(FNBR22,IENS22,12,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"providerReadBackPerformed")=$G(SURGARR(FNBR22,IENS22,13,"E"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"providerReadBackPerformedCd")=$G(SURGARR(FNBR22,IENS22,13,"I"))
 . S SURG("Surg","prosthesisInstalleds","prosthesisInstalled",+IENS22,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR22_U_+IENS22)
 ;
 N IENS23 S IENS23=""
 F  S IENS23=$O(SURGARR(FNBR23,IENS23)) QUIT:IENS23=""  D
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetApplied")=$G(SURGARR(FNBR23,IENS23,.01,"E"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetAppliedFM")=$G(SURGARR(FNBR23,IENS23,.01,"I"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetAppliedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR23,IENS23,.01,"I")))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetAppliedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR23,IENS23,.01,"I")))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"siteApplied")=$G(SURGARR(FNBR23,IENS23,1,"E"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"siteAppliedCd")=$G(SURGARR(FNBR23,IENS23,1,"I"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"tourniquetApplBy")=$G(SURGARR(FNBR23,IENS23,2,"E"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"tourniquetApplById")=$G(SURGARR(FNBR23,IENS23,2,"I"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetRel")=$G(SURGARR(FNBR23,IENS23,3,"E"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetRelFM")=$G(SURGARR(FNBR23,IENS23,3,"I"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetRelHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR23,IENS23,3,"I")))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"timeTourniquetRelFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR23,IENS23,3,"I")))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"pressure")=$G(SURGARR(FNBR23,IENS23,4,"E"))
 . S SURG("Surg","timeTourniquetApplieds","timeTourniquetApplied",+IENS23,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR23_U_+IENS23)
 ;
 N IENS24 S IENS24=""
 F  S IENS24=$O(SURGARR(FNBR24,IENS24)) QUIT:IENS24=""  D
 . S SURG("Surg","otherPreopDiagnosiss","otherPreopDiagnosis",+IENS24,"otherPreopDiagnosis")=$G(SURGARR(FNBR24,IENS24,.01,"E"))
 . S SURG("Surg","otherPreopDiagnosiss","otherPreopDiagnosis",+IENS24,"diagnosisComments")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR24,IENS24,2,Z)) QUIT:'+Z  D
 . . S SURG("Surg","otherPreopDiagnosiss","otherPreopDiagnosis",+IENS24,"diagnosisComments")=SURG("Surg","otherPreopDiagnosiss","otherPreopDiagnosis",+IENS24,"diagnosisComments")_$G(SURGARR(FNBR24,IENS24,2,Z))
 . S SURG("Surg","otherPreopDiagnosiss","otherPreopDiagnosis",+IENS24,"icdDiagnosisCode")=$G(SURGARR(FNBR24,IENS24,3,"E"))
 . S SURG("Surg","otherPreopDiagnosiss","otherPreopDiagnosis",+IENS24,"icdDiagnosisCodeId")=$G(SURGARR(FNBR24,IENS24,3,"I"))
 . S SURG("Surg","otherPreopDiagnosiss","otherPreopDiagnosis",+IENS24,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR24_U_+IENS24)
 ;
 N IENS25 S IENS25=""
 F  S IENS25=$O(SURGARR(FNBR25,IENS25)) QUIT:IENS25=""  D
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"otherPostopDiags")=$G(SURGARR(FNBR25,IENS25,.01,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"PairedOrgans")=$G(SURGARR(FNBR25,IENS25,1,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"PairedOrgansCd")=$G(SURGARR(FNBR25,IENS25,1,"I"))
 . ; 2 diagnosisComments
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"diagnosisComments")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR25,IENS25,2,Z)) QUIT:'+Z  D
 . . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"diagnosisComments")=SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"diagnosisComments")_$G(SURGARR(FNBR25,IENS25,2,Z))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"plannedIcdDiagnosisCode")=$G(SURGARR(FNBR25,IENS25,3,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"plannedIcdDiagnosisCodeId")=$G(SURGARR(FNBR25,IENS25,3,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"serviceConnected")=$G(SURGARR(FNBR25,IENS25,4,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"serviceConnectedCd")=$G(SURGARR(FNBR25,IENS25,4,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"agentOrangeExposure")=$G(SURGARR(FNBR25,IENS25,5,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"agentOrangeExposureCd")=$G(SURGARR(FNBR25,IENS25,5,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"ionizingRadiationExposure")=$G(SURGARR(FNBR25,IENS25,6,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"ionizingRadiationExposureCd")=$G(SURGARR(FNBR25,IENS25,6,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"militarySexualTrauma")=$G(SURGARR(FNBR25,IENS25,7,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"militarySexualTraumaCd")=$G(SURGARR(FNBR25,IENS25,7,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"headAndOrNeckCancer")=$G(SURGARR(FNBR25,IENS25,8,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"headAndOrNeckCancerCd")=$G(SURGARR(FNBR25,IENS25,8,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"southwestAsiaConditions")=$G(SURGARR(FNBR25,IENS25,9,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"southwestAsiaConditionsCd")=$G(SURGARR(FNBR25,IENS25,9,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"combatVet")=$G(SURGARR(FNBR25,IENS25,10,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"combatVetCd")=$G(SURGARR(FNBR25,IENS25,10,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"proj112Shad")=$G(SURGARR(FNBR25,IENS25,11,"E"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"proj112ShadCd")=$G(SURGARR(FNBR25,IENS25,11,"I"))
 . S SURG("Surg","otherPostopDiagss","otherPostopDiags",+IENS25,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR25_U_+IENS25)
 ;
 N IENS26 S IENS26=""
 F  S IENS26=$O(SURGARR(FNBR26,IENS26)) QUIT:IENS26=""  D
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"thermalUnit")=$G(SURGARR(FNBR26,IENS26,.01,"E"))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOn")=$G(SURGARR(FNBR26,IENS26,1,"E"))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOnFM")=$G(SURGARR(FNBR26,IENS26,1,"I"))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOnHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR26,IENS26,1,"I")))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOnFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR26,IENS26,1,"I")))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"temperature")=$G(SURGARR(FNBR26,IENS26,2,"E"))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOff")=$G(SURGARR(FNBR26,IENS26,3,"E"))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOffFM")=$G(SURGARR(FNBR26,IENS26,3,"I"))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOffHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR26,IENS26,3,"I")))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"timeOffFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR26,IENS26,3,"I")))
 . S SURG("Surg","thermalUnits","thermalUnit",+IENS26,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR26_U_+IENS26)
 ;
 N IENS27 S IENS27=""
 F  S IENS27=$O(SURGARR(FNBR27,IENS27)) QUIT:IENS27=""  D
 . S SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"reqBloodKind")=$G(SURGARR(FNBR27,IENS27,.01,"E"))
 . S SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"unitsReq")=$G(SURGARR(FNBR27,IENS27,1,"E"))
 . S SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"screenCrossmatchAutologous")=$G(SURGARR(FNBR27,IENS27,2,"E"))
 . S SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"screenCrossmatchAutologousCd")=$G(SURGARR(FNBR27,IENS27,2,"I"))
 . S SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"reasonNotUseStd")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR27,IENS27,3,Z)) QUIT:'+Z  D
 . . S SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"reasonNotUseStd")=SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"reasonNotUseStd")_$G(SURGARR(FNBR27,IENS27,3,Z))
 . S SURG("Surg","reqBloodKinds","reqBloodKind",+IENS27,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR27_U_+IENS27)
 ;
 N IENS28 S IENS28=""
 F  S IENS28=$O(SURGARR(FNBR28,IENS28)) QUIT:IENS28=""  D
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"intraoperativeOccurrences")=$G(SURGARR(FNBR28,IENS28,.01,"E"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"outcomeToDate")=$G(SURGARR(FNBR28,IENS28,.05,"E"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"outcomeToDateCd")=$G(SURGARR(FNBR28,IENS28,.05,"I"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"occurrenceComments")=""
 . N Z S Z=""
 . F  S Z=$O(SURGARR(FNBR28,IENS28,1,Z)) QUIT:'+Z  D
 . . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"occurrenceComments")=SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"occurrenceComments")_$G(SURGARR(FNBR28,IENS28,1,Z))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"treatmentInstituted")=$G(SURGARR(FNBR28,IENS28,2,"E"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"occurrenceCategory")=$G(SURGARR(FNBR28,IENS28,3,"E"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"occurrenceCategoryId")=$G(SURGARR(FNBR28,IENS28,3,"I"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"icdDiagnosisCode")=$G(SURGARR(FNBR28,IENS28,4,"E"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"icdDiagnosisCodeId")=$G(SURGARR(FNBR28,IENS28,4,"I"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"intraopDeviceType")=$G(SURGARR(FNBR28,IENS28,5,"E"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"intraopDeviceTypeCd")=$G(SURGARR(FNBR28,IENS28,5,"I"))
 . S SURG("Surg","intraoperativeOccurrencess","intraoperativeOccurrences",+IENS28,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR28_U_+IENS28)
 ;
 N IENS29 S IENS29=""
 F  S IENS29=$O(SURGARR(FNBR29,IENS29)) QUIT:IENS29=""  D
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"returnedToSurgery")=$G(SURGARR(FNBR29,IENS29,.01,"E"))
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"returnedToSurgeryId")=$G(SURGARR(FNBR29,IENS29,.01,"I"))
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"reason")=$G(SURGARR(FNBR29,IENS29,1,"E"))
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"reasonCd")=$G(SURGARR(FNBR29,IENS29,1,"I"))
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"retToSurgeryComments")=""
 . ; 2 retToSurgeryComments
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"relatedUnrelated")=$G(SURGARR(FNBR29,IENS29,3,"E"))
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"relatedUnrelatedCd")=$G(SURGARR(FNBR29,IENS29,3,"I"))
 . S SURG("Surg","returnedToSurgerys","returnedToSurgery",+IENS29,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR29_U_+IENS29)
 ;
 N IENS30 S IENS30=""
 F  S IENS30=$O(SURGARR(FNBR30,IENS30)) QUIT:IENS30=""  D
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"postopOccurrence")=$G(SURGARR(FNBR30,IENS30,.01,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"outcomeToDate")=$G(SURGARR(FNBR30,IENS30,.05,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"outcomeToDateCd")=$G(SURGARR(FNBR30,IENS30,.05,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"dateCompNoted")=$G(SURGARR(FNBR30,IENS30,2,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"dateCompNotedFM")=$G(SURGARR(FNBR30,IENS30,2,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"dateCompNotedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR30,IENS30,2,"I")))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"dateCompNotedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR30,IENS30,2,"I")))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"treatmentInstituted")=$G(SURGARR(FNBR30,IENS30,3,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"occurrenceComments")=""
 . ; 4 occurrenceComments
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"occurrenceCategory")=$G(SURGARR(FNBR30,IENS30,5,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"occurrenceCategoryId")=$G(SURGARR(FNBR30,IENS30,5,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"icdDiagnosisCode")=$G(SURGARR(FNBR30,IENS30,6,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"icdDiagnosisCodeId")=$G(SURGARR(FNBR30,IENS30,6,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"sepsisCategory")=$G(SURGARR(FNBR30,IENS30,7,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"sepsisCategoryCd")=$G(SURGARR(FNBR30,IENS30,7,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"cpbStatus")=$G(SURGARR(FNBR30,IENS30,8,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"cpbStatusCd")=$G(SURGARR(FNBR30,IENS30,8,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"strokeCvaDuration")=$G(SURGARR(FNBR30,IENS30,9,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"strokeCvaDurationCd")=$G(SURGARR(FNBR30,IENS30,9,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"indwellingUrethralCatheter")=$G(SURGARR(FNBR30,IENS30,10,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"indwellingUrethralCatheterCd")=$G(SURGARR(FNBR30,IENS30,10,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiSignSymptomsUrgFreqDys")=$G(SURGARR(FNBR30,IENS30,11,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiSignSymptomsUrgFreqDysCd")=$G(SURGARR(FNBR30,IENS30,11,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiSignsSymptomsFever")=$G(SURGARR(FNBR30,IENS30,12,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiSignsSymptomsFeverCd")=$G(SURGARR(FNBR30,IENS30,12,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiSignsSymptomsTenderness")=$G(SURGARR(FNBR30,IENS30,13,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiSignsSymptomsTendernessCd")=$G(SURGARR(FNBR30,IENS30,13,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiCulture")=$G(SURGARR(FNBR30,IENS30,14,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"utiCultureCd")=$G(SURGARR(FNBR30,IENS30,14,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"postopDeviceType")=$G(SURGARR(FNBR30,IENS30,15,"E"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"postopDeviceTypeCd")=$G(SURGARR(FNBR30,IENS30,15,"I"))
 . S SURG("Surg","postopOccurrences","postopOccurrence",+IENS30,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR30_U_+IENS30)
 ;
 N IENS31 S IENS31=""
 F  S IENS31=$O(SURGARR(FNBR31,IENS31)) QUIT:IENS31=""  D
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"referringPhysician")=$G(SURGARR(FNBR31,IENS31,.01,"E"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"streetAddress")=$G(SURGARR(FNBR31,IENS31,1,"E"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"city")=$G(SURGARR(FNBR31,IENS31,2,"E"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"state")=$G(SURGARR(FNBR31,IENS31,3,"E"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"stateId")=$G(SURGARR(FNBR31,IENS31,3,"I"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"zipCode")=$G(SURGARR(FNBR31,IENS31,4,"E"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"phoneNumber")=$G(SURGARR(FNBR31,IENS31,5,"E"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"refPhy200Link")=$G(SURGARR(FNBR31,IENS31,6,"E"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"refPhy200LinkId")=$G(SURGARR(FNBR31,IENS31,6,"I"))
 . S SURG("Surg","referringPhysicians","referringPhysician",+IENS31,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR31_U_+IENS31)
 ;
 N IENS32 S IENS32=""
 F  S IENS32=$O(SURGARR(FNBR32,IENS32)) QUIT:IENS32=""  D
 . S SURG("Surg","prinAssocDiagnosiss","prinAssocDiagnosis",+IENS32,"prinAssocDiagnosis")=$G(SURGARR(FNBR32,IENS32,.01,"E"))
 . S SURG("Surg","prinAssocDiagnosiss","prinAssocDiagnosis",+IENS32,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR32_U_+IENS32)
 ;
 N IENS33 S IENS33=""
 F  S IENS33=$O(SURGARR(FNBR33,IENS33)) QUIT:IENS33=""  D
 . S SURG("Surg","prinProcedureCptModifiers","prinProcedureCptModifier",+IENS33,"prinProcedureCptModifier")=$G(SURGARR(FNBR33,IENS33,.01,"E"))
 . S SURG("Surg","prinProcedureCptModifiers","prinProcedureCptModifier",+IENS33,"prinProcedureCptModifierId")=$G(SURGARR(FNBR33,IENS33,.01,"I"))
 . S SURG("Surg","prinProcedureCptModifiers","prinProcedureCptModifier",+IENS33,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR33_U_+IENS33)
 ;
 N IENS34 S IENS34=""
 F  S IENS34=$O(SURGARR(FNBR34,IENS34)) QUIT:IENS34=""  D
 . S SURG("Surg","otherScrubbedAssistantss","otherScrubbedAssistants",+IENS34,"otherScrubbedAssistants")=$G(SURGARR(FNBR34,IENS34,.01,"E"))
 . S SURG("Surg","otherScrubbedAssistantss","otherScrubbedAssistants",+IENS34,"otherScrubbedAssistantsId")=$G(SURGARR(FNBR34,IENS34,.01,"I"))
 . S SURG("Surg","otherScrubbedAssistantss","otherScrubbedAssistants",+IENS34,"comments")=""
 . ; 1 comments
 . S SURG("Surg","otherScrubbedAssistantss","otherScrubbedAssistants",+IENS34,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR34_U_+IENS34)
 ;
 N IENS35 S IENS35=""
 F  S IENS35=$O(SURGARR(FNBR35,IENS35)) QUIT:IENS35=""  D
 . S SURG("Surg","otherPersonsInOrs","otherPersonsInOr",+IENS35,"otherPersonsInOr")=$G(SURGARR(FNBR35,IENS35,.01,"E"))
 . S SURG("Surg","otherPersonsInOrs","otherPersonsInOr",+IENS35,"titleOrganization")=$G(SURGARR(FNBR35,IENS35,1,"E"))
 . S SURG("Surg","otherPersonsInOrs","otherPersonsInOr",+IENS35,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR35_U_+IENS35)
 ;
 N IENS36 S IENS36=""
 F  S IENS36=$O(SURGARR(FNBR36,IENS36)) QUIT:IENS36=""  D
 . S SURG("Surg","delayCauses","delayCause",+IENS36,"delayCause")=$G(SURGARR(FNBR36,IENS36,.01,"E"))
 . S SURG("Surg","delayCauses","delayCause",+IENS36,"delayCauseId")=$G(SURGARR(FNBR36,IENS36,.01,"I"))
 . S SURG("Surg","delayCauses","delayCause",+IENS36,"delayTime")=$G(SURGARR(FNBR36,IENS36,1,"E"))
 . S SURG("Surg","delayCauses","delayCause",+IENS36,"delayComments")=""
 . ; 2 delayComments
 . S SURG("Surg","delayCauses","delayCause",+IENS36,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR36_U_+IENS36)
 ;
 N IENS37 S IENS37=""
 F  S IENS37=$O(SURGARR(FNBR37,IENS37)) QUIT:IENS37=""  D
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"nonOperativeOccurrences")=$G(SURGARR(FNBR37,IENS37,.01,"E"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"outcomeToDate")=$G(SURGARR(FNBR37,IENS37,1,"E"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"outcomeToDateCd")=$G(SURGARR(FNBR37,IENS37,1,"I"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"dateOccurrenceNoted")=$G(SURGARR(FNBR37,IENS37,2,"E"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"dateOccurrenceNotedFM")=$G(SURGARR(FNBR37,IENS37,2,"I"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"dateOccurrenceNotedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR37,IENS37,2,"I")))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"dateOccurrenceNotedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR37,IENS37,2,"I")))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"treatmentInstituted")=$G(SURGARR(FNBR37,IENS37,3,"E"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"occurrenceComments")=""
 . ; 4 occurrenceComments
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"occurrenceCategory")=$G(SURGARR(FNBR37,IENS37,5,"E"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"occurrenceCategoryId")=$G(SURGARR(FNBR37,IENS37,5,"I"))
 . S SURG("Surg","nonOperativeOccurrencess","nonOperativeOccurrences",+IENS37,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR37_U_+IENS37)
 ;
 N IENS38 S IENS38=""
 F  S IENS38=$O(SURGARR(FNBR38,IENS38)) QUIT:IENS38=""  D
 . S SURG("Surg","surgeryPositions","surgeryPosition",+IENS38,"surgeryPosition")=$G(SURGARR(FNBR38,IENS38,.01,"E"))
 . S SURG("Surg","surgeryPositions","surgeryPosition",+IENS38,"surgeryPositionId")=$G(SURGARR(FNBR38,IENS38,.01,"I"))
 . S SURG("Surg","surgeryPositions","surgeryPosition",+IENS38,"timePlaced")=$G(SURGARR(FNBR38,IENS38,1,"E"))
 . S SURG("Surg","surgeryPositions","surgeryPosition",+IENS38,"timePlacedFM")=$G(SURGARR(FNBR38,IENS38,1,"I"))
 . S SURG("Surg","surgeryPositions","surgeryPosition",+IENS38,"timePlacedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR38,IENS38,1,"I")))
 . S SURG("Surg","surgeryPositions","surgeryPosition",+IENS38,"timePlacedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR38,IENS38,1,"I")))
 . S SURG("Surg","surgeryPositions","surgeryPosition",+IENS38,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR38_U_+IENS38)
 ;
 N IENS39 S IENS39=""
 F  S IENS39=$O(SURGARR(FNBR39,IENS39)) QUIT:IENS39=""  D
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"procedureOccurrence")=$G(SURGARR(FNBR39,IENS39,.01,"E"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"outcomeToDate")=$G(SURGARR(FNBR39,IENS39,1,"E"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"outcomeToDateCd")=$G(SURGARR(FNBR39,IENS39,1,"I"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"dateOccurrenceNoted")=$G(SURGARR(FNBR39,IENS39,2,"E"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"dateOccurrenceNotedFM")=$G(SURGARR(FNBR39,IENS39,2,"I"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"dateOccurrenceNotedHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR39,IENS39,2,"I")))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"dateOccurrenceNotedFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR39,IENS39,2,"I")))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"treatmentInstituted")=$G(SURGARR(FNBR39,IENS39,3,"E"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"occurrenceComments")=""
 . ; 4 occurrenceComments
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"occurrenceCategory")=$G(SURGARR(FNBR39,IENS39,5,"E"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"occurrenceCategoryId")=$G(SURGARR(FNBR39,IENS39,5,"I"))
 . S SURG("Surg","procedureOccurrences","procedureOccurrence",+IENS39,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR39_U_+IENS39)
 ;
 N IENS40 S IENS40=""
 F  S IENS40=$O(SURGARR(FNBR40,IENS40)) QUIT:IENS40=""  D
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"laserUnitId")=$G(SURGARR(FNBR40,IENS40,.01,"E"))
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"laserDuration")=$G(SURGARR(FNBR40,IENS40,1,"E"))
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"wattage")=$G(SURGARR(FNBR40,IENS40,2,"E"))
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"laserOperator")=$G(SURGARR(FNBR40,IENS40,3,"E"))
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"laserOperatorId")=$G(SURGARR(FNBR40,IENS40,3,"I"))
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"plumeEvacuator")=$G(SURGARR(FNBR40,IENS40,4,"E"))
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"plumeEvacuatorCd")=$G(SURGARR(FNBR40,IENS40,4,"I"))
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"laserComments")=""
 . ; 5 laserComments
 . S SURG("Surg","laserUnits","laserUnit",+IENS40,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR40_U_+IENS40)
 ;
 N IENS41 S IENS41=""
 F  S IENS41=$O(SURGARR(FNBR41,IENS41)) QUIT:IENS41=""  D
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"cellSaverId")=$G(SURGARR(FNBR41,IENS41,.01,"E"))
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"cellSaverOperator")=$G(SURGARR(FNBR41,IENS41,1,"E"))
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"cellSaverOperatorId")=$G(SURGARR(FNBR41,IENS41,1,"I"))
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"amtSalvagedMl")=$G(SURGARR(FNBR41,IENS41,2,"E"))
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"amtReinfusedMl")=$G(SURGARR(FNBR41,IENS41,3,"E"))
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"disposablesUsed")=$G(SURGARR(FNBR41,IENS41,4,"E"))
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"cellSaverComments")=""
 . ; 5 cellSaverComments
 . S SURG("Surg","cellSavers","cellSaver",+IENS41,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR41_U_+IENS41)
 ;
 N IENS42 S IENS42=""
 F  S IENS42=$O(SURGARR(FNBR42,IENS42)) QUIT:IENS42=""  D
 . S SURG("Surg","disposablesUseds","disposablesUsed",+IENS42,"disposablesName")=$G(SURGARR(FNBR42,IENS42,.01,"E"))
 . S SURG("Surg","disposablesUseds","disposablesUsed",+IENS42,"lotNumber")=$G(SURGARR(FNBR42,IENS42,1,"E"))
 . S SURG("Surg","disposablesUseds","disposablesUsed",+IENS42,"quantity")=$G(SURGARR(FNBR42,IENS42,2,"E"))
 . S SURG("Surg","disposablesUseds","disposablesUsed",+IENS42,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR42_U_+IENS42)
 ;
 N IENS43 S IENS43=""
 F  S IENS43=$O(SURGARR(FNBR43,IENS43)) QUIT:IENS43=""  D
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserName")=$G(SURGARR(FNBR43,IENS43,.01,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserType")=$G(SURGARR(FNBR43,IENS43,1,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserTypeCd")=$G(SURGARR(FNBR43,IENS43,1,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserStartTime")=$G(SURGARR(FNBR43,IENS43,2,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserStartTimeFM")=$G(SURGARR(FNBR43,IENS43,2,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserStartTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR43,IENS43,2,"I")))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserStartTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR43,IENS43,2,"I")))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserEndTime")=$G(SURGARR(FNBR43,IENS43,3,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserEndTimeFM")=$G(SURGARR(FNBR43,IENS43,3,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserEndTimeHL7")=$$FMTHL7^XLFDT($G(SURGARR(FNBR43,IENS43,3,"I")))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserEndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SURGARR(FNBR43,IENS43,3,"I")))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserTestFire")=$G(SURGARR(FNBR43,IENS43,4,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserTestFireCd")=$G(SURGARR(FNBR43,IENS43,4,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserDeliverySystem")=$G(SURGARR(FNBR43,IENS43,5,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserDeliverySystemCd")=$G(SURGARR(FNBR43,IENS43,5,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"pulseMode")=$G(SURGARR(FNBR43,IENS43,6,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"pulseModeCd")=$G(SURGARR(FNBR43,IENS43,6,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"powerAveragePower")=$G(SURGARR(FNBR43,IENS43,7,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"intervalRepetitionRate")=$G(SURGARR(FNBR43,IENS43,8,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"totalJoulesDelivered")=$G(SURGARR(FNBR43,IENS43,9,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"wattsDelivered")=$G(SURGARR(FNBR43,IENS43,10,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"waveForm")=$G(SURGARR(FNBR43,IENS43,11,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"pulseWidth")=$G(SURGARR(FNBR43,IENS43,12,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"energyJoules")=$G(SURGARR(FNBR43,IENS43,13,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserDuration")=$G(SURGARR(FNBR43,IENS43,14,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"patientPrecautions")=$G(SURGARR(FNBR43,IENS43,15,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserOnStandby")=$G(SURGARR(FNBR43,IENS43,16,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserOnStandbyCd")=$G(SURGARR(FNBR43,IENS43,16,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserOffAndKeySecured")=$G(SURGARR(FNBR43,IENS43,17,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserOffAndKeySecuredCd")=$G(SURGARR(FNBR43,IENS43,17,"I"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"personnelPrecautions")=$G(SURGARR(FNBR43,IENS43,18,"E"))
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"laserComments")=""
 . ; 19 laserComments
 . S SURG("Surg","laserPerformeds","laserPerformed",+IENS43,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR43_U_+IENS43)
 ;
 N IENS44 S IENS44=""
 F  S IENS44=$O(SURGARR(FNBR44,IENS44)) QUIT:IENS44=""  D
 . S SURG("Surg","patientPrecautionss","patientPrecautions",+IENS44,"patientPrecautions")=$G(SURGARR(FNBR44,IENS44,.01,"E"))
 . S SURG("Surg","patientPrecautionss","patientPrecautions",+IENS44,"patientPrecautionsCd")=$G(SURGARR(FNBR44,IENS44,.01,"I"))
 . S SURG("Surg","patientPrecautionss","patientPrecautions",+IENS44,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR44_U_+IENS44)
 ;
 N IENS45 S IENS45=""
 F  S IENS45=$O(SURGARR(FNBR45,IENS45)) QUIT:IENS45=""  D
 . S SURG("Surg","personnelPrecautionss","personnelPrecautions",+IENS45,"personnelPrecautions")=$G(SURGARR(FNBR45,IENS45,.01,"E"))
 . S SURG("Surg","personnelPrecautionss","personnelPrecautions",+IENS45,"personnelPrecautionsCd")=$G(SURGARR(FNBR45,IENS45,.01,"I"))
 . S SURG("Surg","personnelPrecautionss","personnelPrecautions",+IENS45,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR45_U_+IENS45)
 ;
 N IENS46 S IENS46=""
 F  S IENS46=$O(SURGARR(FNBR46,IENS46)) QUIT:IENS46=""  D
 . S SURG("Surg","organsToBeTransplanteds","organsToBeTransplanted",+IENS46,"organsToBeTransplanted")=$G(SURGARR(FNBR46,IENS46,.01,"E"))
 . S SURG("Surg","organsToBeTransplanteds","organsToBeTransplanted",+IENS46,"organsToBeTransplantedCd")=$G(SURGARR(FNBR46,IENS46,.01,"I"))
 . S SURG("Surg","organsToBeTransplanteds","organsToBeTransplanted",+IENS46,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR46_U_+IENS46)
 ;
 N IENS47 S IENS47=""
 F  S IENS47=$O(SURGARR(FNBR47,IENS47)) QUIT:IENS47=""  D
 . S SURG("Surg","donorVesselUnosIds","donorVesselUnosId",+IENS47,"donorVesselUnosId")=$G(SURGARR(FNBR47,IENS47,.01,"E"))
 . S SURG("Surg","donorVesselUnosIds","donorVesselUnosId",+IENS47,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR47_U_+IENS47)
 ;
 N IENS48 S IENS48=""
 F  S IENS48=$O(SURGARR(FNBR48,IENS48)) QUIT:IENS48=""  D
 . S SURG("Surg","specialEquipments","specialEquipment",+IENS48,"specialEquipment")=$G(SURGARR(FNBR48,IENS48,.01,"E"))
 . S SURG("Surg","specialEquipments","specialEquipment",+IENS48,"specialEquipmentId")=$G(SURGARR(FNBR48,IENS48,.01,"I"))
 . S SURG("Surg","specialEquipments","specialEquipment",+IENS48,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR48_U_+IENS48)
 ;
 N IENS49 S IENS49=""
 F  S IENS49=$O(SURGARR(FNBR49,IENS49)) QUIT:IENS49=""  D
 . S SURG("Surg","plannedImplantss","plannedImplants",+IENS49,"plannedImplants")=$G(SURGARR(FNBR49,IENS49,.01,"E"))
 . S SURG("Surg","plannedImplantss","plannedImplants",+IENS49,"plannedImplantsId")=$G(SURGARR(FNBR49,IENS49,.01,"I"))
 . S SURG("Surg","plannedImplantss","plannedImplants",+IENS49,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR49_U_+IENS49)
 ;
 N IENS50 S IENS50=""
 F  S IENS50=$O(SURGARR(FNBR50,IENS50)) QUIT:IENS50=""  D
 . S SURG("Surg","specialSuppliess","specialSupplies",+IENS50,"specialSupplies")=$G(SURGARR(FNBR50,IENS50,.01,"E"))
 . S SURG("Surg","specialSuppliess","specialSupplies",+IENS50,"specialSuppliesId")=$G(SURGARR(FNBR50,IENS50,.01,"I"))
 . S SURG("Surg","specialSuppliess","specialSupplies",+IENS50,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR50_U_+IENS50)
 ;
 N IENS51 S IENS51=""
 F  S IENS51=$O(SURGARR(FNBR51,IENS51)) QUIT:IENS51=""  D
 . S SURG("Surg","specialInstrumentss","specialInstruments",+IENS51,"specialInstruments")=$G(SURGARR(FNBR51,IENS51,.01,"E"))
 . S SURG("Surg","specialInstrumentss","specialInstruments",+IENS51,"specialInstrumentsId")=$G(SURGARR(FNBR51,IENS51,.01,"I"))
 . S SURG("Surg","specialInstrumentss","specialInstruments",+IENS51,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR51_U_+IENS51)
 ;
 N IENS52 S IENS52=""
 F  S IENS52=$O(SURGARR(FNBR52,IENS52)) QUIT:IENS52=""  D
 . S SURG("Surg","pharmacyItemss","pharmacyItems",+IENS52,"pharmacyItems")=$G(SURGARR(FNBR52,IENS52,.01,"E"))
 . S SURG("Surg","pharmacyItemss","pharmacyItems",+IENS52,"pharmacyItemsId")=$G(SURGARR(FNBR52,IENS52,.01,"I"))
 . S SURG("Surg","pharmacyItemss","pharmacyItems",+IENS52,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR52_U_+IENS52)
 ;
 N IENS53 S IENS53=""
 F  S IENS53=$O(SURGARR(FNBR53,IENS53)) QUIT:IENS53=""  D
 . S SURG("Surg","images","image",+IENS53,"image")=$G(SURGARR(FNBR53,IENS53,.01,"E"))
 . S SURG("Surg","images","image",+IENS53,"imageId")=$G(SURGARR(FNBR53,IENS53,.01,"I"))
 . S SURG("Surg","images","image",+IENS53,"resourceId")=$$RESID^SYNDHP69("V",SITE,FNBR1,SURGIEN,FNBR53_U_+IENS53)
 ;
 I $G(DEBUG) W !,$$ZW^SYNDHPUTL("SURG")
 ;
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.SURG,.SURGJ)
 ;
 QUIT
 ;

SYNDHP40
SYNDHP40 ; HC/fjf/art - HealthConcourse - retrieve patient encounters ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient encounters ----------------------------
 ;
PATENCI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient primary encounters for ICN
 ;
 ; Return primary encounters/visits for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to .01 VISIT/ADMIT DATE&TIME
 ;   TODAT   - to date (inclusive), optional, compared to .01 VISIT/ADMIT DATE&TIME
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists the following information
 ;      PatientICN ^ RESOURSE ID ^ TYPE ^ ENCOUNTER DATE ^ REASON ^ ICD DIAGNOSIS CODE ; ICD DIAGNOSIS NAME
 ;      ^ SERVICE CATEGORY ^ SOURCE ^
 ;      ^ LOCATION OF ENCOUNTER , LOCATION ADDRESS SEPARATED BY SEMICOLONS ^ HOSPITAL LOCATION
 ;      ^ PROVIDER(S) SEPARATED BY SEMICOLONS
 ;
 ;   Identifier will be "V_"_SITE ID_"_"_FILE #_"_"_FILE IEN   i.e. V_500_9000010_930
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 N C S C=","
 N P S P="|"
 N S S S=";"
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N RETDESC S RETDESC=""
 N VISITS
 N VIEN S VIEN=""
 F  S VIEN=$O(^AUPNVSIT("C",PATIEN,VIEN)) QUIT:VIEN=""  D
 . N ACU,IDENT,ENCDT,ENCDTI,TYPE,SERV,SOURCE,LOC,HLOC,LOCI,LOCD,LOCA,CONIEN,PDO
 . N DIAGC,DIAGN,ENFLG,DATEN,DISD,REASON,PROV,PERIOD,PERIODFM,SITE,PROBLEM,PROVIDERS
 . N VISIT
 . D GET1VISIT^SYNDHP13(.VISIT,VIEN,0) ;get one Visit record . QUIT:$D(VISITE)
 . I $D(VISIT("Visit","ERROR")) M VISITS("Encounters",VIEN)=VISIT QUIT
 . I VISIT("Visit","encounterTypeCd")'="P" QUIT
 . S PERIODFM=VISIT("Visit","visitAdmitDateTimeFM")   ; encounter date/time
 . QUIT:'$$RANGECK^SYNDHPUTL(PERIODFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . S IDENT=VISIT("Visit","resourceId")
 . S PERIOD=VISIT("Visit","visitAdmitDateTimeHL7")   ; date/time, HL7 format
 . S ENCDTI=VISIT("Visit","visitAdmitDateTimeFM")\1
 . ;get first diagnosis for patient
 . S ENFLG=0,CONIEN=""
 . F  S CONIEN=$O(^AUPNPROB("AC",PATIEN,CONIEN)) QUIT:CONIEN=""  D  QUIT:ENFLG=1
 . . D GET1PROB^SYNDHP11(.PROBLEM,CONIEN,0)
 . . I $D(VPROV("Problem","ERROR")) M VISITS("Encounters",VIEN,"providers")=VPROV QUIT
 . . S DATEN=PROBLEM("Problem","dateEnteredFM") QUIT:(DATEN\1)'=$G(ENCDTI)  ;date/time must equal date entered
 . . S REASON=PROBLEM("Problem","problem") ; reason
 . . S DIAGC=PROBLEM("Problem","diagnosisId") ; condition
 . . S DIAGN=$G(^ICD9(DIAGC,68,1,1)) ; diagnosis
 . . S ENFLG=1    ;set flag to know we have data and can move on
 . S TYPE=VISIT("Visit","patientStatusInOut")  ; encounter type
 . S DISD=VISIT("Visit","encounterType") ; discharge disposition
 . S LOC=VISIT("Visit","locOfEncounter")
 . S LOCI=VISIT("Visit","locOfEncounterId") ; location
 . I $G(LOCI)'="" D
 . . D GET1SITE^SYNDHP10(.SITE,LOCI,0) ;get one Institution record
 . . I $D(SITE("Site","ERROR")) M VISITS("Encounters",VIEN,"Site")=SITE QUIT
 . . S LOCD=$G(^DIC(4,LOCI,1))
 . . S LOCA=SITE("Site","streetAddr1")_S_SITE("Site","streetAddr2")_S_SITE("Site","city")_S_SITE("Site","zip") ; location address
 . S SERV=VISIT("Visit","serviceCategory") ; service category
 . S HLOC=VISIT("Visit","hospitalLocation") ; hospital location
 . S SOURCE=VISIT("Visit","dataSource")  ; Source
 . S PDO=""
 . S PROV=""
 . F  S PDO=$O(^AUPNVPRV("AD",VIEN,PDO)) Q:PDO=""  D
 . . N VPROV
 . . D GET1VPROV^SYNDHP23(.VPROV,PDO,0)
 . . I $D(VPROV("Vprov","ERROR")) M VISITS("Encounters",VIEN,"providers")=VPROV QUIT
 . . S PROV=VPROV("Vprov","provider")_S
 . . M PROVIDERS(PDO)=VPROV
 . S RETDESC=RETDESC_$G(IDENT)_U_$G(TYPE)_U_$G(PERIOD)_U_$G(REASON)_U_$G(DIAGC)_S_$G(DIAGN)_U_$G(SERV)_U_$G(SOURCE)_U_$G(LOC)_C_$G(LOCA)_U_$G(HLOC)_U_PROV_P
 . M VISITS("Encounters",VIEN)=VISIT
 . I $D(PROBLEM) M VISITS("Encounters",VIEN,"Visit","diagnosis")=PROBLEM
 . I $D(PROVIDERS) M VISITS("Encounters",VIEN,"Visit","providers")=PROVIDERS
 . I $D(SITE) M VISITS("Encounters",VIEN,"Visit","location")=SITE
 S RETSTA=DHPICN_U_RETDESC
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.VISITS,.RETSTA)
 ;
 QUIT
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="5000000109V646500"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATENCI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="5000000109V646500"
 N FRDAT S FRDAT=20151001
 N TODAT S TODAT=20151031
 N RETSTA
 D PATENCI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="5000000109V646500"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATENCI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP41
SYNDHP41 ; HC/rdb/art - HealthConcourse - retrieve patient appointments ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient appointment information ------------------------------
 ;
PATAPTI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient appointments for ICN
 ;
 ; Return patient appointments for a given patient ICN
 ; Returns a patient's appointments from PATIENT:APPOINTMENT (2:1900)
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to appointment date/time
 ;   TODAT   - to date (inclusive), optional, compared to appointment date/time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists patient appointment information
 ;          ICN ^ Patient IEN _ Appt Date (HL7) | Clinic | Appt Status | purpose of visit | Appt Type | Resource ID ^...
 ;
 ; bypass for CQM
 ;
 ; ***********
 ; *********** Important Note for open source community
 ; ***********
 ; *********** Perspecta - who developed this source code and have released it to the open source
 ; *********** need the following six lines to remain intact
 ;
 ;I DHPICN="1686299845V246594" D  Q
 ;.S RETSTA="1686299845V246594^101916_201704281200-0500|GENERAL MEDICINE||UNSCHED. VISIT|REGULAR"
 ;
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to
 ; *********** be determined by Perspecta
 ; ***********
 ; *********** End of Important Note for open source community
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N PATAPPT
 S RETSTA=$$APPTS(.PATAPPT,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.PATAPPT,.RETSTA)
 ;
 QUIT
 ;
APPTS(PATAPPT,PATIEN,DHPICN,FRDAT,TODAT) ; get appointments for a patient
 ;
 N P S P="|"
 N S S S="_"
 ;
 D GETPATAPPT^SYNDHP25(.PATAPPT,PATIEN,0) ;get patient appointment records
 I $D(PATAPPT("Patappt","ERROR")) QUIT
 ;
 N APPTDTTM,PTAPTID,CLNAM,APDTDISP,APPTSTAT,APPTPURP,APPTTYPE,ZARR
 S APPTDTTM=""
 F  S APPTDTTM=$O(PATAPPT("Patappt","appointments","appointment",APPTDTTM)) Q:APPTDTTM=""  D
 . QUIT:'$$RANGECK^SYNDHPUTL(APPTDTTM,FRDAT,TODAT)  ;quit if outside of requested date range
 . N APPT S APPT=$NA(PATAPPT("Patappt","appointments","appointment",APPTDTTM))
 . S PTAPTID=@APPT@("resourceId")
 . S CLNAM=@APPT@("clinic") ;clinic
 . S APDTDISP=@APPT@("appointmentDateTimeFHIR") ;appt. date/time
 . S APPTSTAT=@APPT@("status") ;status
 . S APPTPURP=@APPT@("purposeOfVisit") ;purpose of visit
 . S APPTTYPE=@APPT@("appointmentType") ;appt. type
 . S ZARR(DHPICN,APPTDTTM)=PATIEN_S_APDTDISP_P_CLNAM_P_APPTSTAT_P_APPTPURP_P_APPTTYPE_P_PTAPTID
 ; serialize data
 S APPTDTTM=""
 N APPTREC
 N APPTS S APPTS=DHPICN
 F  S APPTDTTM=$O(ZARR(DHPICN,APPTDTTM)) Q:APPTDTTM=""  D
 .S APPTREC=ZARR(DHPICN,APPTDTTM)
 .S APPTS=APPTS_U_APPTREC
 Q APPTS
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATAPTI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=20150201
 N TODAT S TODAT=20160101
 N RETSTA
 D PATAPTI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATAPTI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP43
SYNDHP43 ; HC/fjf/art - HealthConcourse - validate a patient's traits ;07/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
PATVAL(RETSTA,NAME,SSN,DOB,GENDER,MMDNM) ; validate patient for DHP
 ;
 ; this API validates a patient
 ; all the input criteria must be satisfied for the patient to be identified as a valid patient
 ;
 ; Input:
 ; NAME is the patient Name                   - REQUIRED
 ; SSN is the patient Social Security Number  - REQUIRED
 ; DOB is the patient Date of Birth           - REQUIRED
 ; GENDER is the patient gender               - REQUIRED
 ; MMDNM is the patient Mother's Maiden Name  - optional
 ;
 ; Output:
 ; RETSTA is the name of the return array
 ;   RETSTA(0)=STATUS^REASON^ICN
 ;             STATUS = 1 - valid match found
 ;             STATUS = 0 - no match found
 ;
 N SSNA,RZN,N,TX,IEN
 I $G(NAME)="" S RETSTA="-1^Patient Name not specified" Q
 I $G(SSN)="" S RETSTA="-1^Patient SSN not specified" Q
 I $G(DOB)="" S RETSTA="-1^Patient DOB not specified" Q
 I $G(GENDER)="" S RETSTA="-1^Patient Gender not specified" Q
 ;I $G(MMDNM)="" S RETSTA="-1^Mother's Maiden Name not specified" Q
 S MMDNM=$G(MMDNM)
 ;
 ; do some validation for above traits and determine if patient is valid
 ;
 ; check to see if SSN is recognised by VistA system
 I '+$$SSNCHK(SSN) S RETSTA="-1^Patient SSN not recognised" Q
 ;
 ; otherwise we have at least one patient for the SSN
 ; check each patient for a match
 S N=""
 S RETSTA="0^Invalid patient"
 F  S N=$O(SSNA(N)) Q:N=""  D
 .S TX=SSNA(N)
 .S IEN=$P(TX,"^",2)
 .I $$NAMCHK(IEN),$$DOBCHK(IEN),$$GENCHK(IEN),$$MDNCHK(IEN) S RETSTA="1^Valid patient^"_$$ICN(IEN)
 I +RETSTA Q
 I $D(RZN) S RETSTA="-1^Invalid "_RZN Q
 Q
 ;
SSNCHK(SSN) ; SSN check
 ; find all patients that match SSN
 K SSNA
 N IEN S IEN=""
 F  S IEN=$O(^DPT("SSN",SSN,IEN)) Q:IEN=""  D
 .S SSNA(IEN)=SSN_U_IEN
 I '$D(SSNA) Q 0
 Q 1
 ;
NAMCHK(IEN) ; name check
 I $P(NAME," ")'=$P($$GET1^DIQ(2,IEN_",",.01,"I")," ") S RZN="patient name" Q 0
 Q 1
 ;
DOBCHK(IEN) ; DOB check
 I $$HL7TFM^XLFDT(DOB)'=$$GET1^DIQ(2,IEN_",",.03,"I") S RZN="DOB" Q 0
 Q 1
 ;
GENCHK(IEN) ; gender check
 I GENDER'=$$GET1^DIQ(2,IEN_",",.02,"I") S RZN="gender" Q 0
 Q 1
 ;
MDNCHK(IEN) ; mother's maiden name check
 Q:MMDNM="" 1
 I MMDNM'=$P($$GET1^DIQ(2,IEN_",",.2403),",") S RZN="mother maiden name" Q 0
 Q 1
 ;
ICN(IEN) ; obtain ICN
 N ICN
 S ICN=$$GET1^DIQ(2,IEN_",",991.1)
 I ICN="" D
 . S ICN=$$GET1^DIQ(2,IEN_",",991.01)_"V"_$$GET1^DIQ(2,IEN_",",991.02)
 Q ICN
 ;
TESTP ;
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19350505,"M","SCHMIDT")
 W $$ZW^SYNDHPUTL("RETSTA")
 Q
 ;
TESTF1 ; SSN fail
 D PATVAL(.RETSTA,"ZERO,PATIENT",566000000,19350505,"M","SCHMIDT")
 W $$ZW^SYNDHPUTL("RETSTA")
 Q
 ;
TESTF2 ; name fail
 D PATVAL(.RETSTA,"FRAUNOFER,PATIENT",666000000,19350505,"M","SCHMIDT")
 W $$ZW^SYNDHPUTL("RETSTA")
 Q
 ;
TESTF3 ; DOB fail
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19270928,"M","SCHMIDT")
 W $$ZW^SYNDHPUTL("RETSTA")
 Q
 ;
TESTF4 ; gender fail
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19350505,"F","SCHMIDT")
 W $$ZW^SYNDHPUTL("RETSTA")
 Q
 ;
TESTF5 ; mother's maiden name fail
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19350505,"M","SCHROEDINGER")
 W $$ZW^SYNDHPUTL("RETSTA")
 Q
 ;
T3 ;
 S NAME="COPD,PATIENT MALE"
 S SSN=666111957
 S DOB=19800530
 S GENDER="M"
 N RETSTA
 D PATVAL(.RETSTA,NAME,SSN,DOB,GENDER)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP47
SYNDHP47 ; HC/fjf/art - HealthConcourse - retrieve patient demographics ;2019-11-15  1:53 PM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ; (c) 2017-2019 Perspecta
 ; (c) 2019 OSEHRA
 ; 
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 QUIT
 ;
 ; ----------------  Get Patient Demographics  ----------------------
 ;
PATDEM(RETSTA,NAME,SSN,DOB,GENDER,RETJSON) ; get demographics for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return patient demographics for name, SSN, DOB, and gender
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return patient demographics string (default)
 ; Output:
 ;   RETSTA  - a delimited string that has the following
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3,^City^State^ZIP^resID
 ;          or patient demographics in JSON format
 ;
 ; validate patient
 N ICNST
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 S DHPICN=$P(ICNST,U,3)
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 ; get patient demographics
 N PATARRAY
 S RETSTA=$$GETPATS(.PATARRAY,PATIEN)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
 ;
 QUIT
 ;
 ; ----------------  Get Patient Demographics  ----------------------
 ;
PATDEMI(RETSTA,DHPICN,RETJSON) ; get demographics for patient by ICN
 ;
 ; Return patient demographics for given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return patient demographics string (default)
 ; Output:
 ;   RETSTA  - a delimited string that has the following
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3^City^State^ZIP^resID
 ;             ^self identified gender^email^language name,lang iso 639-1 code,lang system (hardcoded)
 ;             ^race text,race hl7 code,race hl7 system (hardcoded)
 ;             ^ethnicity text, ethnicity code, ethnicity hl7 system (hardcoded)
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 ; get patient demographics
 N PATARRAY
 S RETSTA=$$GETPATS(.PATARRAY,PATIEN)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
 ;
 QUIT
 ;
GETPATS(PATARRAY,DFN) ; [Private] Get demographics for single patient
 N VA,VADM,VAPA,VAERR
 ; Next two calls: ICR 10061
 D DEM^VADPT
 D ADD^VADPT
 ;
 N RESID,NAME,PHONE,SEX,DOB,ADRS1,ADRS2,ADRS3,CITY,STATE,ZIP,ICN
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 S RESID=$$RESID^SYNDHP69("V",SITE,2,DFN)
 S NAME=VADM(1)
 S SEX=$P(VADM(5),U,2)
 N SID S SID=$$GET1^DIQ(2,DFN,.024) ; Self Identified Gender
 S DOB=$$FMTHL7^XLFDT($P(VADM(3),U)) ; ICR #10103
 S PHONE=VAPA(8)
 S ADRS1=VAPA(1)
 S ADRS2=VAPA(2)
 S ADRS3=VAPA(3)
 S CITY=VAPA(4)
 S STATE=$P(VAPA(5),U,2)
 S ZIP=VAPA(6)
 ;
 N EMAIL S EMAIL=$$GET1^DIQ(2,DFN,.133)
 ;
 ; Language
 N LANG,LANGIEN,LANGCODE,LANGSYS
 S (LANG,LANGCODE,LANGSYS)=""
 S LANG=$P($G(VADM(13,1)),U,2)
 I LANG'="" D
 . S LANGIEN=$$FIND1^DIC(.85,,"X",LANG)
 . S LANGCODE=$$GET1^DIQ(.85,LANGIEN,.02)
 . S LANGSYS="urn:ietf:bcp:47"
 ;
 ; TODO: There can be multiple races, but we won't handle that now
 ; Race
 N RACETEXT,RACECODE,RACESYS
 S (RACETEXT,RACECODE,RACESYS)=""
 I $D(VADM(12,1)) D
 . S RACETEXT=$P(VADM(12,1),U,2)
 . S RACECODE=$$GET1^DIQ(10,$P(VADM(12,1),U),3)
 . S RACESYS="urn:oid:2.16.840.1.113883.6.238"
 ;
 ; TODO: There can be multiple ethnicities, but we won't handle that now
 ; Ethnicity
 N ETHTEXT,ETHCODE,ETHSYS
 S (ETHTEXT,ETHCODE,ETHSYS)=""
 I $D(VADM(11,1)) D
 . S ETHTEXT=$P(VADM(11,1),U,2)
 . S ETHCODE=$$GET1^DIQ(10.2,$P(VADM(11,1),U),3)
 . S ETHSYS="urn:oid:2.16.840.1.113883.6.238"
 ;
 S ICN=$$GETICN^MPIF001(DFN) ; ICR 2701
 I +ICN=-1 S ICN=""
 ;
 N C S C=","
 N PATSTR
 S PATSTR=ICN_U_NAME_U_PHONE_U_SEX_U_DOB_U
 S PATSTR=PATSTR_ADRS1_C_ADRS2_C_ADRS3_U_CITY_U_STATE_U_ZIP_U
 S PATSTR=PATSTR_RESID_U_SID_U_EMAIL_U_LANG_C_LANGCODE_C_LANGSYS_U
 S PATSTR=PATSTR_RACETEXT_C_RACECODE_C_RACESYS_U
 S PATSTR=PATSTR_ETHTEXT_C_ETHCODE_C_ETHSYS
 QUIT PATSTR
 ;
PATDEMAL(RETSTA,DHPICN,RETJSON) ; [PUBLIC URL] /DHPPATDEMALL? get demographics for all patients
 ;
 ; Return patient demographics for all patients
 ;
 ; Input:
 ;   RETJSON - J = Return JSON (JSON is not currently supported for this call)
 ;             F = Return FHIR
 ;             0 or null = Return patient demographics string (default)
 ; Output:
 ;   RETSTA  - a delimited string that has the following
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3^City^State^ZIP^resID
 ;             ^self identified gender^email^language name,lang iso 639-1 code,lang system (hardcoded)
 ;             ^race text,race hl7 code,race hl7 system (hardcoded)
 ;             ^ethnicity text, ethnicity code, ethnicity hl7 system (hardcoded)
 ;
 I ($G(RETJSON)="J"!($G(RETJSON)="F")) S RETSTA="-1^JSON for all patients is currently not supported" QUIT
 ;
 ; ZEXCEPT: HTTPARGS,SYNDEBUG
 ;
 ; New Variables for EN1^DIP
 N L,DIC,FLDS,BY,DR,FR,TO,DHD
 N HDH,DIASKHD,DIPCRIT,PG,DHIT
 N DIOEND,DIOBEG
 N DCOPIES
 N IOP,%ZIS
 N DQTIME
 N DIS,DISUPNO,DISPAR
 N DISTOP
 ;
 ; Output variables
 N SYNCT S SYNCT=0
 K ^TMP("SYNPATALL",$J)
 ;
 ; Setup minimum environment for Fileman
 N DIQUIET S DIQUIET=1
 D DT^DICRW
 ;
 ; Set-up main variables for ^DIP
 S DIC=2                        ; Patient File
 S FLDS="NUMBER"                ; Print IEN only
 S DHD="@@"                     ; No headers
 S DHIT="D COLLECT^"_$T(+0)     ; Call back on each entry
 S %ZIS="0"                     ; DO NOT OPEN HOME DEVICE! SOOO IMPORTANT!
 S IOP="NULL"                   ; Send output to null device
 I $D(SYNDEBUG) S IOP="0;132;9999999",%ZIS="" ; or send output to screen if debugging
 ;
 ; FN as FR,TO subscript
 N FN S FN=1
 ;
 ; If we have an identifier, don't sort on anything else. Figure this out and send it off.
 I $data(HTTPARGS("identifier"))!($data(HTTPARGS("_id"))) do  do PRINT quit
 . n id1
 . i $data(HTTPARGS("identifier")) s id1=HTTPARGS("identifier")
 . i $data(HTTPARGS("_id"))        s id1=HTTPARGS("_id")
 . n hasType,type,id
 . s hasType=id1["|"
 . i 'hasType s type="icn",id=id1
 . i hasType do
 .. n typeNote s typeNote=$p(id1,"|")
 .. s id=$p(id1,"|",2)
 .. i typeNote["icn"    s type="icn"
 .. e  i typeNote["dfn" s type="dfn"
 .. e  i typeNote["ssn" s type="ssn"
 .. e  s type="icn"
 . ;
 . if type="icn" S BY="'@991.1"
 . if type="dfn" S BY="'NUMBER"
 . if type="ssn" S BY="'@.09"
 . S FR(FN)=id
 . S TO(FN)=id
 ;
 ; BY for DIP
 ; Default sort; Sort output by name
 S BY=".01"
 S FR(FN)="",TO(FN)=""
 ;
 n z ; last character
 n Y I $D(^DD("OS",^DD("OS"),"HIGHESTCHAR")) X ^("HIGHESTCHAR")
 s z=$get(Y,"z")
 ;
 ; Name or Last Name
 ; Reuse first level sort
 i $data(HTTPARGS("name"))!($data(HTTPARGS("family"))) do
 . n name
 . i $data(HTTPARGS("name"))   s name=HTTPARGS("name")
 . i $data(HTTPARGS("family")) s name=HTTPARGS("family")
 . s name=$$UP^XLFSTR(name)
 . S FR(1)=name
 . S TO(1)=name_z
 ;
 ; DOB
 I $data(HTTPARGS("birthdate")) do
 . n birthdate s birthdate=HTTPARGS("birthdate")
 . n start,stop
 . i $l(birthdate,"-")=3 s (start,stop)=birthdate
 . i $l(birthdate,"-")=2 d
 .. s birthdate=$p(birthdate,"-",2)_"-"_$p(birthdate,"-",1) ; VA Fileman can't interpret 1905-08 but can 08-1905.
 .. s start=birthdate
 .. s stop=$p(birthdate,"-")+1_"-"_$p(birthdate,"-",2)
 . i $l(birthdate,"-")=1 s start=birthdate,stop=birthdate+1
 . S FN=FN+1
 . S BY=BY_",'@.03"
 . S FR(FN)=start
 . S TO(FN)=stop
 ;
 ; Sex
 I $data(HTTPARGS("gender")) do
 . N SEX S SEX=$$UP^XLFSTR($E(HTTPARGS("gender")))
 . S FN=FN+1
 . S BY=BY_",'@.02"
 . S FR(FN)=SEX
 . S TO(FN)=SEX
 ;
 ; Given Name. Walk over to name components and search that file.
 if $data(HTTPARGS("given")) do
 . S FN=FN+1
 . S BY=BY_",'@1.01:2"
 . n given s given=$$UP^XLFSTR(HTTPARGS("given"))
 . S FR(FN)=given
 . S TO(FN)=given_z
 ;
PRINT ; [Fall through]
 ; Paging support SYNMAX and SYNSKIPTO
 N SYNMAX
 I $d(HTTPARGS("_count")) set SYNMAX=HTTPARGS("_count")
 else  set SYNMAX=100
 ;
 N SYNSKIPTO
 I $d(HTTPARGS("_page")) set SYNSKIPTO=(HTTPARGS("_page")-1)*SYNMAX
 else  set SYNSKIPTO=0
 ;
 ; Central Call. Will call back COLLECT at each entry.
 D EN1^DIP
 ;
 I $G(^TMP("SYNPATALL",$J,SYNCT))'="" S $E(^TMP("SYNPATALL",$J,SYNCT),$L(^TMP("SYNPATALL",$J,SYNCT)))=""  ; remove trailing "|"
 ;
 ; Return variable
 S RETSTA=$NA(^TMP("SYNPATALL",$J))
 ;
 ; Currently not used
 ;I $G(RETJSON)="J"!($G(RETJSON)="F") D
 ;. S RETSTA=""
 ;. D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
 QUIT
 ;
COLLECT ; [Internal; call back from EN1^DIP
 ; Skip previous "pages"
 ; ZEXCEPT:DN,D0 from EN1^DIP
 ; ZEXCEPT:SYNSKIPTO,SYNCT,SYNMAX newed above 
 I SYNSKIPTO>0 S SYNSKIPTO=SYNSKIPTO-1 QUIT
 ;
 ; Count entry
 S SYNCT=SYNCT+1
 N PATARRAY,PATSTR ; PATARRAY not used
 S PATSTR=$$GETPATS(.PATARRAY,D0)
 S ^TMP("SYNPATALL",$J,SYNCT)=PATSTR_"|"
 I SYNCT>(SYNMAX-1) S DN=0,D0=-1 ; Stop Print loop
 QUIT
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 ;
PATDEMRNG(RETSTA,DHPPATS,RETJSON) ; get demographics for range of patients
 ;
 ; Return patient demographics for a range of patients
 ;
 ; Input:
 ;   DHPPATS - mmmmRnnnn where nnnn and mmmm are patient DFNs, mmmm<nnnn (limited 1000 patients for JSON)
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return patient demographics string (default)
 ; Output:
 ;   RETSTA  - a delimited string that has the following
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3,^City^State^ZIP^resID|...
 ;          or patient demographics in JSON format
 ;
 ;
 N C,M,S,SOR,EOR,N,NOPATS,PATIEN,PTNTS,DHPICN,PATSTR,I,RESID
 S C=",",M="R"
 S S="_"
 N SITE S SITE=$P($$SITE^VASITE,U,3)
 ;
 N CT S CT=0
 K ^TMP("DHPPATRNG",$J) S ^TMP("DHPPATRNG",$J)=""
 K ^TMP("DHPCOUNT")
 N PATARRAY
 ;
 I DHPPATS'?1.N1"R"1.N S RETSTA="-1^Invalid range format" QUIT
 S SOR=$P(DHPPATS,M),EOR=$P(DHPPATS,M,2)
 I EOR<SOR S RETSTA="-1^End before beginning" QUIT
 S NOPATS=EOR-SOR+1
 I ($G(RETJSON)="J"!($G(RETJSON)="F")),NOPATS>1000 S RETSTA="-1^please limit JSON request to 1000 patients" QUIT
 ; find first patient IEN
 S PATIEN=SOR-1
 F  S PATIEN=$O(^DPT(PATIEN)) QUIT:(PATIEN>EOR)!(+PATIEN=0)  D
 .;W !,PATIEN
 .;Q
 .S PATSTR=$$GETPATS(.PATARRAY,PATIEN)
 .S ^TMP("DHPPATRNG",$J)=^TMP("DHPPATRNG",$J)_PATSTR_"|"
 .S CT=CT+1
 .S ^TMP("DHPCOUNT",$J,CT)=PATSTR
 S RETSTA=^TMP("DHPPATRNG",$J)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
 ;
 Q
 ;
 ; ----------- Unit Test -----------
TEST D EN^%ut($t(+0),3) quit
SETUP N X S X=0 X ^%ZOSF("RM") quit
T1 ;
 N ICN S ICN="1034989029V875306"
 N JSON S JSON=""
 N RETSTA
 D PATDEMI(.RETSTA,ICN,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T2 ;
 N ICN S ICN="1034989029V875306"
 N JSON S JSON="J"
 N RETSTA
 D PATDEMI(.RETSTA,ICN,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T3 ;
 N RANGE S RANGE="10R15"
 N JSON S JSON=""
 N RETSTA
 D PATDEMRNG(.RETSTA,RANGE,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T4 ;
 N RANGE S RANGE="10R15"
 N JSON S JSON="J"
 N RETSTA
 D PATDEMRNG(.RETSTA,RANGE,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T5 ; @TEST Get all Patients
 N ICN S ICN="ALL"
 N JSON S JSON=""
 N RETSTA
 D PATDEMAL(.RETSTA,ICN,JSON)
 w ! D ZWRITE^SYNDHPUTL(RETSTA)
 D CHKTF^%ut($O(@RETSTA@(0))>0)
 QUIT
 ;
T6 ; @TEST Get some patients by Given Name (AB)
 n RETSTA
 n HTTPARGS
 s HTTPARGS("given")="AB"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T7 ; @TEST Get some patients by Last (B) and Given names (AL)
 n RETSTA
 n HTTPARGS
 s HTTPARGS("given")="AL"
 s HTTPARGS("family")="B"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T8 ; @TEST Get some patients by exact DOB 2010-01-17
 n RETSTA
 n HTTPARGS
 s HTTPARGS("birthdate")="2010-01-17"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T9 ; @TEST Get some patients by inexact DOB 2010-01
 n RETSTA
 n HTTPARGS
 s HTTPARGS("birthdate")="2010-01"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T10 ; @TEST Get some patients by inexact DOB 2010
 n RETSTA
 n HTTPARGS
 s HTTPARGS("birthdate")="2010"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
T11 ; @TEST Get patients with inexact DOB 2010 and given name starting with A
 n RETSTA
 n HTTPARGS
 s HTTPARGS("birthdate")="2010"
 s HTTPARGS("given")="A"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T12 ; @TEST Get patients with identifier by DFN
 n RETSTA
 n HTTPARGS
 s HTTPARGS("identifier")="dfn|1"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T13 ; @TEST Get patients with identifier by SSN
 n RETSTA
 n HTTPARGS
 s HTTPARGS("identifier")="ssn|999998562"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T14 ; @TEST Get patients with identifier by ICN
 n RETSTA
 n HTTPARGS
 s HTTPARGS("identifier")="icn|4068085986V151374"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 d CHKTF^%ut($O(@RETSTA@(0))>0)
 quit
 ;
T15 ; @TEST Get patients with no _count (expect 100)
 n RETSTA
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 n cnt s cnt=0
 n i f i=0:0 s i=$O(@RETSTA@(i)) q:'i  s cnt=cnt+1
 d CHKEQ^%ut(cnt,100)
 quit
 ;
T16 ; @TEST Get patients with _count = 10
 n RETSTA
 n HTTPARGS
 s HTTPARGS("_count")=10
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 n cnt s cnt=0
 n i f i=0:0 s i=$O(@RETSTA@(i)) q:'i  s cnt=cnt+1
 d CHKEQ^%ut(cnt,10)
 quit
 ;
T17 ; @TEST Get patients with _count 10 and page 1
 n RETSTA
 n HTTPARGS
 s HTTPARGS("_count")=10
 s HTTPARGS("_page")=1
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 n cnt s cnt=0
 n i f i=0:0 s i=$O(@RETSTA@(i)) q:'i  s cnt=cnt+1
 d CHKEQ^%ut(cnt,10)
 quit
 ;
T18 ; @TEST Get patients with _count 10 and page 2
 n RETSTA
 n HTTPARGS
 s HTTPARGS("_count")=10
 s HTTPARGS("_page")=2
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 n cnt s cnt=0
 n i f i=0:0 s i=$O(@RETSTA@(i)) q:'i  s cnt=cnt+1
 d CHKEQ^%ut(cnt,10)
 ; Make sure 1st patient is 11th patient in B index
 n cnt s cnt=0
 n i s i="" f  s i=$o(^DPT("B",i)),cnt=cnt+1 q:i=""  q:cnt=11  w i," "
 n name s name=$p(@RETSTA@(1),U,2)
 d CHKEQ^%ut(name,i)
 quit
 ;
T19 ; @TEST Get patients all females with paging
 n RETSTA
 n HTTPARGS
 s HTTPARGS("_count")=100
 s HTTPARGS("_page")=1
 s HTTPARGS("gender")="female"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 s HTTPARGS("_count")=100
 s HTTPARGS("_page")=2
 s HTTPARGS("gender")="female"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 s HTTPARGS("_count")=100
 s HTTPARGS("_page")=3
 s HTTPARGS("gender")="female"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 k HTTPARGS
 s HTTPARGS("_count")=10000
 s HTTPARGS("gender")="female"
 d PATDEMAL(.RETSTA)
 w ! d ZWRITE^SYNDHPUTL(RETSTA)
 quit
 ;

SYNDHP48
SYNDHP48 ; HC/PWC/art - HealthConcourse - retrieve patient medication data ;2019-11-05  10:18 AM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ; (c) 2017-2019 Perspecta
 ; (c) 2019 OSEHRA
 ; 
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 ;
 Q
 ;
 ; ---------------- Get patient medication statement ----------------------------
PATMEDS(RETSTA,DHPICN,FRDAT,TODAT) ; Patient medication statement for ICN
 ;
 ; Return patient medication statement for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional
 ;   TODAT   - to date (inclusive), optional
 ; Output:
 ;   RETSTA  - a delimited string that lists the following information
 ;      PatientICN ^ RESOURSE ID ^ STATUS ^ MEDICATION ^ DATE ASSERTED; DATE STARTED; DATE ENDED
 ;      ^ CONDITION ^ DOSAGE , SITE ; ROUTE ; DOSE ^ QUANTITY ^ DAYS ^ RXN |
 ;
 ;   Identifier will be "V"_SITE ID_"_"_FILEMAN #_"_"_FILE IEN   i.e. V_500_55_930
 ;
STM ;
 ; ZEXCEPT: SYNDEBUG - print to screen
 ; ZEXCEPT: HTTPARGS,HTTPERR - Web Server variables
 N C,ACU,P,S,UL,D1,IDENT,ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITE,SITEA,VUID
 N RETDESC,QTY,DAYS,RXN,IENS,IDATE,IDATEFM,RX,PATIEN,DRUGI
 S C=",",P="|",S=";",UL="_"
 N SITE S SITE=$$SITE^VASITE($$DT^XLFDT)
 ;
 ; Filter validation
 ;
 ; Id (e.g. V-999-52-2150, V-999-55-17-55.06-1)
 N QID,QIDMED,QIDMEDF ; ID, Med IENS, Medfile
 S QIDMEDF=""
 I $D(HTTPARGS("_id")) D  I $G(HTTPERR) QUIT
 . S QID=HTTPARGS("_id")
 . N P2,P3,P4,P5,P6
 . S P2=$P(QID,"-",2) ; 999
 . S P3=$P(QID,"-",3) ; 55
 . S P4=$P(QID,"-",4) ; 17
 . S P5=$P(QID,"-",5) ; 55.06
 . S P6=$P(QID,"-",6) ; 1
 . ;
 . ; Validate site
 . N STATION S STATION=$P(SITE,U,3)
 . I P2'=STATION D ERRMSG^SYNDHPUTL(400,"Condition not located at this site") QUIT
 . ;
 . ; Validate file and set QIDMED for query
 . I (U_52_U_55_U)'[(U_P3_U) D ERRMSG^SYNDHPUTL(400,"Only 52 and 55 are allowed") QUIT
 . S QIDMEDF=P3
 . I QIDMEDF=52,'$D(^PSRX(P4,0)) D ERRMSG^SYNDHPUTL(400,"Entry not found") QUIT
 . I QIDMEDF=55,'$D(^PS(55,P4,5,P6,0)) D ERRMSG^SYNDHPUTL(400,"Entry not found") QUIT
 . I QIDMEDF=52 S QIDMED=P4_C
 . I QIDMEDF=55 S QIDMED=P4_C_P6_C
 . ;
 . ; Get ICN
 . N DFN
 . I P3=52 S DFN=$P(^PSRX(P4,0),U,2)
 . I P3=55 S DFN=P4
 . S DHPICN=$$GETICN^MPIF001(DFN) ; ICR 2701
 ;
 N QSTATUS,QVSTATUS,QUNREL ; Status, VistA Status, Unreleased?
 I $D(HTTPARGS("status")) D  I $G(HTTPERR) QUIT
 . S QSTATUS=HTTPARGS("status")
 . ; Supported FHIR statuses: active | completed | entered-in-error (op only) | stopped | on-hold | not-taken (op only)
 . ; Unsupported statuses:    intended | unknown
 . I "^active^completed^entered-in-error^stopped^on-hold^not-taken^"'[(U_QSTATUS_U) D ERRMSG^SYNDHPUTL(400,"Status Search not supported with "_QSTATUS) QUIT
 . I QSTATUS="active"    S QVSTATUS="ACTIVE"
 . I QSTATUS="completed" S QVSTATUS="EXPIRED"
 . I QSTATUS="entered-in-error" S QVSTATUS="DELETED"
 . I QSTATUS="stopped"   S QVSTATUS="DISCONTINUED"
 . I QSTATUS="on-hold"   S QVSTATUS="HOLD"
 . I QSTATUS="not-taken" S QUNREL=1  ; Unreleased
 ;
 ; Effective [Date]
 N QEFF
 N QEFFREV S QEFFREV=0 ; Reverse condition
 I $D(HTTPARGS("effective")) D  I $G(HTTPERR) QUIT
 . S QEFF=HTTPARGS("effective")
 . D SETFRTO^SYNDHPUTL(QEFF,.FRDAT,.TODAT,.QEFFREV)
 ;
 ; validate ICN
 I $G(DHPICN)="",$D(HTTPARGS("patient")) S DHPICN=HTTPARGS("patient")
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETDESC=""
 S SITE=$P($$SITE^VASITE,U,3)
 N SYNCNT S SYNCNT=0
 S RETSTA=$NA(^TMP($T(+0),$J))
 K @RETSTA
 S SYNCNT=SYNCNT+1
 S @RETSTA@(SYNCNT)=DHPICN_U
 ;
 D STMUD Q:(QIDMEDF=55)  ; Unit Dose
 D STMOP Q:(QIDMEDF=52)  ; Outpatient
 ;
 QUIT
 ;
STMUD ; [Private] /MedicationStatement Unit Dose
 ; ZEXCEPT: RETSTA,PATIEN,C,P,S,SITE,SYNCNT,SYNDEBUG
 ; ZEXCEPT: QIDMED,QIDMEDF,QVSTATUS,QUNREL,QEFF,QEFFREV - Filters
 ; ZEXCEPT: SDTFM,FRDAT,TODAT
 N D1 S D1=0
 I QIDMEDF=55 S D1=$P(QIDMED,C,2)
 D:QIDMEDF=55  Q:QIDMEDF  F  S D1=$O(^PS(55,PATIEN,5,D1)) Q:'D1  D
 .; filter on "not taken". Only applies to Outpatient.
 .I $G(QUNREL) QUIT
 .; end
 .N IENS S IENS=D1_C_PATIEN_C
 .N MEDX,MEDERR
 .D GETS^DIQ(55.06,IENS,".01;3;10;28;27;34","IEN","MEDX","MEDERR")
 .QUIT:$D(MEDERR)
 .N STATUS S STATUS=$G(MEDX(55.06,IENS,28,"E"))    ; status
 .; status filter
 .I $D(QVSTATUS),STATUS'[QVSTATUS QUIT
 .; end filter
 .N ORDNUM S ORDNUM=$G(MEDX(55.06,IENS,.01,"E"))   ; order number
 .; route is most likely not stored in vista as SCT code, but should check this
 .N ROUTE S ROUTE=$G(MEDX(55.06,IENS,3,"E"))      ; route
 .N DOSORD S DOSORD=$P($G(^PS(55,PATIEN,5,D1,.2)),U,2)          ; dosage ordered
 .N SDTFM S SDTFM=$G(MEDX(55.06,IENS,10,"I"))      ; start date
 .I $D(SYNDEBUG),$D(QEFF) W SDTFM," ",FRDAT," ",TODAT," ",QEFFREV," ",$$RANGECK^SYNDHPUTL(SDTFM,FRDAT,TODAT,QEFFREV),!
 .I $D(QEFF) QUIT:'$$RANGECK^SYNDHPUTL(SDTFM,FRDAT,TODAT,QEFFREV)    ;quit if outside of requested date range
 .N ODTFM S ODTFM=$G(MEDX(55.06,IENS,27,"I"))       ; order date
 .N EDTFM S EDTFM=$G(MEDX(55.06,IENS,34,"I"))       ; stop date
 .N ODTHL7 S ODTHL7=$$FMTHL7^XLFDT(ODTFM)      ; order date
 .N SDTHL7 S SDTHL7=$$FMTHL7^XLFDT(SDTFM)      ; start date
 .N EDTHL7 S EDTHL7=$$FMTHL7^XLFDT(EDTFM)      ; end date
 .N DRUG S DRUG=$$GET1^DIQ(55.07,1_C_IENS,.01,"E")  ; medication
 .N DRUGI S DRUGI=$$GET1^DIQ(55.07,1_C_IENS,.01,"I")
 .I DRUGI="" QUIT  ; Bad data
 .N RXN,VUID S RXN=$$GETRXN^SYNDHPUTL(DRUGI)
 .I RXN S RXN="RXN"_RXN
 .E  S VUID=$$GETVUID(DRUGI) I VUID S RXN="VUID"_VUID
 .E  S RXN="DRUG"_DRUGI
 .N IDENT S IDENT=$$RESID^SYNDHP69("V",SITE,55,PATIEN,55.06_U_D1)
 .N DAYS S DAYS=""
 .N QTY S QTY=""
 .N SITEA S SITEA=""
 .S SYNCNT=SYNCNT+1
 .S @RETSTA@(SYNCNT)=IDENT_U_STATUS_U_DRUG_U_ODTHL7_S_SDTHL7_S_EDTHL7_U_"REASON"_U_SITEA_S_ROUTE_S_DOSORD_U_QTY_U_DAYS_U_RXN_P
 QUIT
 ;
STMOP ; [Private] /MedicationStatement Outpatient
 ; ZEXCEPT: RETSTA,PATIEN,C,P,S,SITE,SYNCNT,SYNDEBUG
 ; ZEXCEPT: QIDMED,QIDMEDF,QVSTATUS,QUNREL,QEFF,QEFFREV - Filters
 ; ZEXCEPT: SDTFM,FRDAT,TODAT
 N D1 S D1=0
 N RX
 I QIDMEDF=52 S RX=$P(QIDMED,C)
 D:QIDMEDF=52  Q:QIDMEDF  F  S D1=$O(^PS(55,PATIEN,"P",D1)) Q:'D1  S RX=$G(^PS(55,PATIEN,"P",D1,0)) D
 . N MEDX,MEDERR
 . D GETS^DIQ(52,RX_",",".01;1;2;6;7;8;100;26;22;31","IEN","MEDX","MEDERR")
 . N STATUS S STATUS=$G(MEDX(52,RX_",",100,"E"))  ;status
 . ; status filter
 . I $D(QVSTATUS),STATUS'[QVSTATUS QUIT
 . ; end filter
 . QUIT:$D(MEDERR)
 . N IDATEFM S IDATEFM=$G(MEDX(52,RX_",",1,"I"))     ;issue date
 . N FDATEFM S FDATEFM=$G(MEDX(52,RX_",",22,"I"))    ;fill date
 . I $D(SYNDEBUG),$D(QEFF) W FDATEFM," ",FRDAT," ",TODAT," ",QEFFREV," ",$$RANGECK^SYNDHPUTL(FDATEFM,FRDAT,TODAT,QEFFREV),!
 . I $D(QEFF),'FDATEFM QUIT                                             ;filter but med hasn't beeen filled yet
 . I $D(QEFF) QUIT:'$$RANGECK^SYNDHPUTL(FDATEFM,FRDAT,TODAT,QEFFREV)    ;quit if outside of requested date range
 . N EDATEFM S EDATEFM=$G(MEDX(52,RX_",",26,"I"))    ;expiration date
 . N RDATEFM S RDATEFM=$G(MEDX(52,RX_",",31,"I"))    ;release date
 . ; status filter 2 - not taken (i.e. unreleased medication. If released, quit.)
 . I $G(QUNREL),RDATEFM QUIT
 . ; end status filter 2
 . I 'RDATEFM S STATUS="UNRELEASED"                  ;override status if unreleased
 . N IDATE S IDATE=$$FMTHL7^XLFDT(IDATEFM)           ;issue date HL7
 . N SDATE S SDATE=$$FMTHL7^XLFDT(FDATEFM)           ;start date HL7
 . N EDATE S EDATE=$$FMTHL7^XLFDT(EDATEFM)           ;end date hl7
 . N DRUG S DRUG=$G(MEDX(52,RX_",",6,"E"))           ;medication
 . N DRUGI S DRUGI=$G(MEDX(52,RX_",",6,"I"))
 . I DRUGI="" QUIT  ; Bad data
 . N RXN,VUID S RXN=$$GETRXN^SYNDHPUTL(DRUGI)
 . I RXN S RXN="RXN"_RXN
 . E  S VUID=$$GETVUID(DRUGI) I VUID S RXN="VUID"_VUID
 . E  S RXN="DRUG"_DRUGI
 . N QTY S QTY=$G(MEDX(52,RX_",",7,"E"))       ;quantity
 . N DAYS S DAYS=$G(MEDX(52,RX_",",8,"E"))      ;days supply
 . N ROUTE S ROUTE=$$GET1^DIQ(52.0113,"1,"_RX_",",6,"EN")  ;route
 . N SITEA S SITEA=""
 . N DOSORD S DOSORD=""                        ; TODO: Fill this
 . N IDENT S IDENT=$$RESID^SYNDHP69("V",SITE,52,RX)
 . S SYNCNT=SYNCNT+1
 . S @RETSTA@(SYNCNT)=IDENT_U_STATUS_U_DRUG_U_IDATE_S_SDATE_S_EDATE_U_"REASON"_U_SITEA_S_ROUTE_S_DOSORD_U_QTY_U_DAYS_U_RXN_P
 QUIT
 ;
 ; ---------------- Get patient medication administration ----------------------------
PATMEDA(RETSTA,DHPICN,FRDAT,TODAT) ; Patient medication administration for ICN
 ;
 ; Return patient medication administration for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional
 ;   TODAT   - to date (inclusive), optional
 ; Output:
 ;   RETSTA  - a delimited string that lists the following information
 ;      PatientICN ^ RESOURSE ID ^ STATUS ^ MEDICATION ^ DATE ASSERTED ^ CONDITION
 ;      ^ DOSAGE , SITE ; ROUTE ; DOSE ^ QUANTITY ^ DAYS ^ RXN |
 ;
 ;   Identifier will be "V"_SITE ID_"_"_FILEMAN #_"_"_FILE IEN   i.e. V_500_55_930
 ;
 ; validate ICN
 ; ZEXCEPT: SYNDEBUG - print to screen
STA ;
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(SYNDEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 N C,ACU,P,S,UL,D1,IDENT,ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITE,IENS
 N RETDESC,SITEA,QTY,DAYS,RXN,IDATE,IDATEFM,PATIEN,DRUGI,RX
 S C=",",P="|",S=";",UL="_"
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETDESC=""
 S SITE=$P($$SITE^VASITE,U,3)
 S RETSTA=""
 ; loop through the PHARMACY PATIENT file #55 (^PS(55)) for patient (this will contain both IP and OP orders)
 ;
 ; this is start of Inpatient Orders
 S D1=0
 F  S D1=$O(^PS(55,PATIEN,5,D1)) Q:D1'?1N.N  D
 .S IENS=D1_C_PATIEN_C
 .S (ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITEA,QTY,DAYS,RXN)=""
 .N MEDX,MEDERR
 .D GETS^DIQ(55.06,IENS,".01;3;10;28","IEN","MEDX","MEDERR")
 .QUIT:$D(MEDERR)
 .S ORDNUM=$G(MEDX(55.06,IENS,.01,"E"))   ; order number
 .; route is most likely not stored in vista as SCT code, but should check this
 .S ROUTE=$G(MEDX(55.06,IENS,3,"E"))      ; route
 .S STATUS=$G(MEDX(55.06,IENS,28,"E"))    ; status
 .S DOSORD=$P($G(^PS(55,PATIEN,5,D1,.2)),U,2)          ; dosage ordered
 .S STDTFM=$G(MEDX(55.06,IENS,10,"I"))      ; start date
 .QUIT:((STDTFM\1)<FRDAT)!((STDTFM\1)>TODAT)  ;quit if outside of requested date range
 .S STDT=$$FMTHL7^XLFDT($G(MEDX(55.06,IENS,10,"I")))      ; start date
 .S DRUG=$$GET1^DIQ(55.07,1_C_IENS,.01,"E")  ; medication
 .S DRUGI=$$GET1^DIQ(55.07,1_C_IENS,.01,"I")
 .S RXN=$$GETRXN^SYNDHPUTL(DRUGI)
 .I RXN?1.N S RXN="RXN"_RXN
 .S IDENT=$$RESID^SYNDHP69("V",SITE,55,PATIEN,55.06_U_D1)
 .S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
 ;
 ; start here for outpatient orders
 S D1=0
 F  S D1=$O(^PS(55,PATIEN,"P",D1)) Q:D1'?1N.N  D
 . S RX=$G(^PS(55,PATIEN,"P",D1,0))
 . S (IDENT,IDATE,DRUG,QTY,DAYS,STATUS,ROUTE)=""
 . N MEDX,MEDERR
 . D GETS^DIQ(52,RX_",",".01;1;2;6;7;8;100","IEN","MEDX","MEDERR")
 . QUIT:$D(MEDERR)
 . S IDENT=$$RESID^SYNDHP69("V",SITE,52,RX)
 . S IDATEFM=$G(MEDX(52,RX_",",1,"I"))     ;issue date
 . QUIT:((IDATEFM\1)<FRDAT)!((IDATEFM\1)>TODAT)  ;quit if outside of requested date range
 . S IDATE=$$FMTHL7^XLFDT($G(MEDX(52,RX_",",1,"I")))     ;issue date
 . S DRUG=$G(MEDX(52,RX_",",6,"E"))      ;medication
 . S DRUGI=$G(MEDX(52,RX_",",6,"I"))
 . S RXN=$$GETRXN^SYNDHPUTL(DRUGI)
 . I RXN?1.N S RXN="RXN"_RXN
 . S QTY=$G(MEDX(52,RX_",",7,"E"))       ;quantity
 . S DAYS=$G(MEDX(52,RX_",",8,"E"))      ;days supply
 . S STATUS=$G(MEDX(52,RX_",",100,"E"))  ;status
 . S ROUTE=$$GET1^DIQ(52.0113,"1,"_RX_",",6,"EN")  ;route
 . S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(IDATE)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
 S RETSTA=DHPICN_U_RETDESC
 Q
 ;
 ; ---------------- Get patient medication dispense ----------------------------
 ;
PATMEDD(RETSTA,DHPICN,FRDAT,TODAT) ; Patient medication dispense for ICN
 ;
 ; Return patient medication dispense for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional
 ;   TODAT   - to date (inclusive), optional
 ; Output:
 ;   RETSTA  - a delimited string that lists the following information
 ;      PatientICN ^ RESOURSE ID ^ STATUS ^ MEDICATION ^ DATE ASSERTED ^ CONDITION
 ;      ^ DOSAGE , SITE ; ROUTE ; DOSE ^ QUANTITY ^ DAYS ^ RXN |
 ;
 ;   Identifier will be "V"_SITE ID_"_"_FILEMAN #_"_"_FILE IEN   i.e. V_500_55_930
 ;
 ; ZEXCEPT: SYNDEBUG - print to screen
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(SYNDEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 N C,ACU,P,S,UL,D1,IDENT,ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITEA
 N RETDESC,SITE,QTY,DAYS,RXN,PATIEN,RX
 S C=",",P="|",S=";",UL="_"
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETDESC=""
 S SITE=$P($$SITE^VASITE,U,3)
 S RETSTA=""
 ; loop through the PHARMACY PATIENT file #55 (^PS(55)) for patient (this will contain both IP and OP orders).
 ; OP orders will need to get additional information from the PRESCRIPTION file #52 (^PSRX)
 S D1=0
 F  S D1=$O(^PS(55,PATIEN,5,D1)) Q:D1'?1N.N  D
 .N IENS S IENS=D1_C_PATIEN_C
 .S (ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITEA,QTY,DAYS,RXN)=""
 .N MEDX,MEDERR
 .D GETS^DIQ(55.06,IENS,".01;3;10;28","IEN","MEDX","MEDERR")
 .QUIT:$D(MEDERR)
 .S ORDNUM=$G(MEDX(55.06,IENS,.01,"E"))   ; order number
 .; route is most likely not stored in vista as SCT code, but should check this
 .S ROUTE=$G(MEDX(55.06,IENS,3,"E"))      ; route
 .S STATUS=$G(MEDX(55.06,IENS,28,"E"))    ; status
 .S DOSORD=$P($G(^PS(55,PATIEN,5,D1,.2)),U,2)          ; dosage ordered
 .S STDTFM=$G(MEDX(55.06,IENS,10,"I"))      ; start date
 .QUIT:'$$RANGECK^SYNDHPUTL(STDTFM,FRDAT,TODAT)  ;quit if outside of requested date range
 .S STDT=$$FMTHL7^XLFDT($G(MEDX(55.06,IENS,10,"I")))      ; start date
 .S DRUG=$$GET1^DIQ(55.07,1_C_IENS,.01,"E")  ; medication
 .N DRUGI S DRUGI=$$GET1^DIQ(55.07,1_C_IENS,.01,"I")
 .S RXN=$$GETRXN^SYNDHPUTL(DRUGI)
 .I RXN?1.N S RXN="RXN"_RXN
 .S IDENT=$$RESID^SYNDHP69("V",SITE,55,PATIEN,55.06_U_D1)
 .S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
 ;
 S RETSTA=DHPICN_U_RETDESC
 Q
 ;
GETVUID(X) ; [Public] Get VUID for drug
 Q $$GET1^DIQ(50,X,"22:99.99")
 ;
 ;
 ;
 ;Statement
 ;IP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
 ;OP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(IDATE)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
 ;Administer
 ;IP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
 ;OP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(IDATE)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
 ;Dispense
 ;IP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_$G(RXN)_P

SYNDHP48T
SYNDHP48T ; OSE/SMH - Unit Testing For /MedicationStatement & Others;2019-11-05  10:35 AM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;
 ; (c) 2019 OSEHRA
 ; 
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 ;
 ;
TEST ; [Unit Test Runner]
 D EN^%ut($T(+0),3)
 QUIT
SHUTDOWN ;
 ; ZEXCEPT:ICNOP,ICNIP
 ; ZEXCEPT:EFFY1,EFFY2,EFFY3,EFFYM1,EFFYM2,EFFYMD1,EFFYMD2
 K ICNOP,ICNIP
 K EFFY1,EFFY2,EFFY3,EFFYM1,EFFYM2,EFFYMD1,EFFYMD2
 QUIT
 ; ZEXCEPT:HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS
SETUP    K HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS QUIT
 ; ZEXCEPT:HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS
TEARDOWN K HTTPERR,FRDAT,TODAT,RETSTA,HTTPARGS QUIT
 ;
T1 ;
 N ICN S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .W !!!,ICN,!!!
 .D PATMEDA^SYNDHP48(.RETSTA,ICN)
 .W $$ZW^SYNDHPUTL("RETSTA")
 .W !!!
 Q
 ;
T2 ;
 N RETSTA
 N ICN S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .W !,ICN,!
 .D PATMEDD^SYNDHP48(.RETSTA,ICN)
 .W $$ZW^SYNDHPUTL("RETSTA"),!!
 Q
 ;
T3 ;
 N RETSTA
 N ICN,XPIEN
 S ICN=""
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .S XPIEN=$O(^DPT("AFICN",ICN,""))
 .W !,ICN,!,XPIEN,!,^DPT(XPIEN,0),!
 .D PATMEDS^SYNDHP48(.RETSTA,ICN)
 .W $$ZW^SYNDHPUTL("RETSTA"),!!
 Q
 ;
T4 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATMEDA^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T5 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=20100101
 N TODAT S TODAT=20150101
 N RETSTA
 D PATMEDA^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T6 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATMEDD^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T7 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=20100101
 N TODAT S TODAT=20150101
 N RETSTA
 D PATMEDD^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T8 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T9 ;
 N ICN S ICN="5000000341V359724"
 N FRDAT S FRDAT=20100101
 N TODAT S TODAT=20150101
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T10 ; @TEST Test Outpatient Medications Get by ICN
 ; ZEXCEPT:ICNOP,ICNIP
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICNOP)
 D ZWRITE^SYNDHPUTL(RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)>1)
 QUIT
 ;
T11 ; @TEST Test Inpatient Medications Get by ICN
 ; ZEXCEPT:ICNOP,ICNIP
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA,ICNIP)
 D ZWRITE^SYNDHPUTL(RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)>1)
 QUIT
 ;
T12 ; @TEST Test Medications Get by ?patient
 ; ZEXCEPT:ICNOP,ICNIP
 N HTTPARGS S HTTPARGS("patient")=ICNIP
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)>1)
 QUIT
 ;
T13 ; @TEST Test ?_id outpatient med
 ; ZEXCEPT:ICNOP,ICNIP
 N HTTPARGS S HTTPARGS("_id")="V-999-52-2151"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)=2)
 QUIT
 ;
T14 ; @TEST Test ?_id inpatient med
 ; ZEXCEPT:ICNOP,ICNIP
 N HTTPARGS S HTTPARGS("_id")="V-999-55-17-55.06-3"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 D CHKTF^%ut($O(@RETSTA@(""),-1)=2)
 QUIT
 ;
T15 ; @TEST Test bad ICN
 N HTTPARGS S HTTPARGS("patient")="888V222"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKTF^%ut(RETSTA<0)
 QUIT
 ;
T16 ; @TEST Test bad ID
 N HTTPARGS S HTTPARGS("_id")="V-999-55-17-55.06-322222"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ; ZEXCEPT: HTTPERR
 D CHKTF^%ut(HTTPERR=400)
 QUIT
 ;
T17 ; @TEST Test Status: Active
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="active"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="active"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T18 ; @TEST Test Status: Completed = EXPIRED
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="completed"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="completed"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T19 ; @TEST Test Status: Entered in error (= deleted in outpatient)
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="entered-in-error"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T20 ; @TEST Test Status: Stopped = DISCONTINUED
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="stopped"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="stopped"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T21 ; @TEST Test Status: on-hold = HOLD
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("status")="on-hold"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 W !
 D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="on-hold"
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
T22 ; @TEST Test Status: not-taken (unreleased meds in outpatient)
 ; ZEXCEPT: ICNIP,ICNOP
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("status")="not-taken"
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 W ! D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT
 ;
STARTUP ; [Constants] Modify to suit your system so tests would pass.
 ; ZEXCEPT:ICNOP,ICNIP
 ; ZEXCEPT:EFFY1,EFFY2,EFFY3,EFFYM1,EFFYM2,EFFYMD1,EFFYMD2
 S ICNOP="2421492932V802082"
 S ICNIP="9990000005V380966"
 S EFFY1=2007
 S EFFYM1="2007-11"
 S EFFYMD1="2007-11-20"
 S EFFY2=2019
 S EFFYM2="2019-10"
 S EFFYMD2="2019-10-16"
 S EFFY3=1954
 QUIT
 ;
T23 ; @TEST Test Effective Date - inexact year
 ; ZEXCEPT: ICNIP,ICNOP,EFFY1,EFFY2,EFFY3
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")=EFFY1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNOP_U)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[EFFY1)
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFY2
 D PATMEDS^SYNDHP48(.RETSTA)
 D CHKEQ^%ut(@RETSTA@(1),ICNIP_U)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[EFFY2)
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFY3
 D PATMEDS^SYNDHP48(.RETSTA)
 D tf^%ut('$D(@RETSTA@(2)))
 QUIT
T24 ; @TEST Test Effective Date - inexact year/month
 ; ZEXCEPT: ICNIP,ICNOP,EFFYM1,EFFYM2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")=EFFYM1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYM1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFYM2
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYM2,"-"))
 QUIT
T25 ; @TEST Test Effective Date - exact
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")=EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")=EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD2,"-"))
 QUIT
T26 ; @TEST Test Effective Date - eqdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="eq"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="eq"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE[$tr(EFFYMD2,"-"))
 QUIT
T27 ; @TEST Test Effective Date - nedate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="ne"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE'[$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="ne"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut(SDATE'[$tr(EFFYMD2,"-"))
 QUIT
T28 ; @TEST Test Effective Date - ltdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="lt"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)<$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="lt"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)<$tr(EFFYMD2,"-"))
 QUIT
T29 ; @TEST Test Effective Date - gtdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="gt"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)>$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="gt"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)>$tr(EFFYMD2,"-"))
 QUIT
T30 ; @TEST Test Effective Date - ledate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="le"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'>$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="le"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'>$tr(EFFYMD2,"-"))
 QUIT
T31 ; @TEST Test Effective Date - gedate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="ge"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'<$tr(EFFYMD1,"-"))
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="ge"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 ;W ! D ZWRITE^SYNDHPUTL(RETSTA)
 N I F I=1:1 S I=$O(@RETSTA@(I)) Q:'I  D
 . N DATES S DATES=$P(@RETSTA@(I),U,4)
 . N SDATE S SDATE=$P(DATES,";",2)
 . D tf^%ut($E(SDATE,1,8)'<$tr(EFFYMD2,"-"))
 QUIT
T32 ; @TEST Test Effective Date - apdate
 ; ZEXCEPT: ICNIP,ICNOP,EFFYMD1,EFFYMD2
 N HTTPARGS
 S HTTPARGS("patient")=ICNOP
 S HTTPARGS("effective")="ap"_EFFYMD1
 N RETSTA
 D PATMEDS^SYNDHP48(.RETSTA)
 W ! D ZWRITE^SYNDHPUTL(RETSTA)
 S HTTPARGS("patient")=ICNIP
 S HTTPARGS("effective")="ap"_EFFYMD2
 D PATMEDS^SYNDHP48(.RETSTA)
 W ! D ZWRITE^SYNDHPUTL(RETSTA)
 QUIT

SYNDHP53
SYNDHP53 ; HC/fjf/art - HealthConcourse - get patient labs ;07/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;
 ; ---------------- Get patient labs ----------------------
 ;
PATLAB(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT) ; get labs for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return patient labs for name, SSN, DOB, and gender
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   FRDAT   - from date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
 ;   TODAT   - to date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
 ; Output:
 ;   RETSTA  - a delimited string that lists LOINC codes for the patient labs
 ;           - ICN^LOINC code1|LOINC description|result|date|identifier
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 ;
 N P,ICNST,PATIEN
 ;
 S P="|"
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 ; if we are here we are dealing with a valid patient
 S DHPICN=$P(ICNST,U,3)
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Patient ICN not found" QUIT
 D LABS(.RETSTA,PATIEN,FRDAT,TODAT,DHPICN)
 ;
 QUIT
 ;
PATLABI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient labs for ICN
 ;
 ; Return patient labs for a given patient ICN
 ;
 ; Input:
 ;   DHPICN  - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
 ;   TODAT   - to date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return lab string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists LOINC codes for the patient labs
 ;           - ICN^LOINC code1|LOINC description|result|date|resource ID^...
 ;          or patient chem labs in JSON format
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; get patient IEN from ICN
 N LABARRAY
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 D LABS(.RETSTA,PATIEN,FRDAT,TODAT,DHPICN,.LABARRAY)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.LABARRAY,.RETSTA)
 ;
 QUIT
 ;
LABS(LLIST,PATIEN,FRDAT,TODAT,DHPICN,LABARRAY) ; return chem labs for patient
 ;
 N LABREF S LABREF=$$GET1^DIQ(2,PATIEN_",",63) ;laboratory reference in Patient file
 I LABREF="" S LLIST=DHPICN QUIT
 ;
 N P S P="|"
 N RETSEQ S RETSEQ=0
 N LABS,TESTDT,TESTDTHL,LOINCCD,LOINCNM,RESULT,LABID,TESTIEN,TESTNAME,ARRAY
 D GETLABS^SYNDHP21(.LABS,LABREF,0)
 I $D(LABS("Lab","ERROR")) M LABARRAY("Labs",PATIEN)=LABS QUIT
 N SEQ S SEQ=""
 F  S SEQ=$O(LABS("Lab","chemHemToxRiaSerEtcs","chemHemToxRiaSerEtc",SEQ)) QUIT:SEQ=""  D
 . N TEST S TEST=$NA(LABS("Lab","chemHemToxRiaSerEtcs","chemHemToxRiaSerEtc",SEQ))
 . S TESTDT=@TEST@("dateTimeSpecimenTakenFM")
 . QUIT:'$$RANGECK^SYNDHPUTL(TESTDT,FRDAT,TODAT)  ;quit if outside of requested date range
 . S TESTDTHL=@TEST@("dateTimeSpecimenTakenHL7")
 . S LOINCCD=@TEST@("loincCode")
 . S LOINCNM=@TEST@("loincName")
 . S RESULT=@TEST@("result")
 . S TESTIEN=@TEST@("labTestId")
 . S TESTNAME=@TEST@("labTestName")
 . S LABID=@TEST@("resourceId")
 . I $G(DEBUG) D
 . . ;W "  Workload Code: ",WKLDCODE,?30,WKLDNAME,!
 . . W "  Test Name:     ",TESTIEN,?30,TESTNAME,!
 . . W "  LOINC Code: ",LOINCCD,!
 . . W "  LOINC Name: ",LOINCNM,!
 . . W "  Result:     ",RESULT,!
 . S RETSEQ=RETSEQ+1
 . S ARRAY(RETSEQ)=LOINCCD_P_LOINCNM_P_RESULT_P_TESTDTHL_P_LABID
 . M LABARRAY("Labs",PATIEN)=LABS ;
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("ARRAY") W !
 ;serialize data
 S LLIST=DHPICN
 S RETSEQ=""
 F  S RETSEQ=$O(ARRAY(RETSEQ)) QUIT:RETSEQ=""  D
 . S LLIST=LLIST_U_ARRAY(RETSEQ)
 ;
 QUIT
 ;
 ; --------------------------------------------------------------------
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="5000001536V889384"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATLABI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="5000001536V889384"
 N FRDAT S FRDAT=20140131
 N TODAT S TODAT=20150131
 N JSON S JSON=""
 N RETSTA
 D PATLABI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="5000001536V889384"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATLABI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP54
SYNDHP54 ; HC/rbd/art - HealthConcourse - retrieve patient provider data ;07/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient providers for encounters ------------------------------
 ;
PATPRVI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient encounter providers for ICN
 ;
 ; Return patient enc providers for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compares to Visit Date/Time
 ;   TODAT   - to date (inclusive), optional, compares to Visit Date/Time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return patient providers string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists patient providers for encounters
 ;             ICN^visit date|visit ien|provider name|role|prim/sec|address1|address2|city|state|zip|off. phone|specialization|resourceId^...
 ;          or patient enc providers in JSON format
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"DHPICN: ",DHPICN,"   FRDAT: ",FRDAT,"   TODAT: ",TODAT,"   RETJSON: ",RETJSON,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 ; get encounter providers
 N ENCPROV
 S RETSTA=$$PRVS(.ENCPROV,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.ENCPROV,.RETSTA)
 ;
 Q
 ;
PRVS(ENCPROV,PATIEN,DHPICN,FRDAT,TODAT) ; get providers for encounters for a patient
 ;
 N ENCPROVS,ZARR
 N PRCITY,PRID,PRNAM,PROFFPH,PRPRMSEC,PRREC,PRROLE,PRSTAD1,PRSTAD2,PRSTATE,PRVID,PRVSTDT,PRVVIEN,PRZIP
 N USRCLIEN,USRSPEC,VSTDT
 N P S P="|"
 ; scan visit providers "C" index for IEN
 N PRIEN S PRIEN=""
 F  S PRIEN=$O(^AUPNVPRV("C",PATIEN,PRIEN)) QUIT:PRIEN=""  D
 . N VPROV
 . D GET1VPROV^SYNDHP23(.VPROV,PRIEN,0)
 . I $D(VPROV("Vprov","ERROR")) M ENCPROV("EncProv",PRIEN)=VPROV QUIT
 . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("VPROV")
 . S VSTDT=VPROV("Vprov","visitFM")
 . QUIT:'$$RANGECK^SYNDHPUTL(VSTDT,FRDAT,TODAT)  ;quit if outside of requested date range
 . S PRID=VPROV("Vprov","resourceId")
 . S PRNAM=VPROV("Vprov","provider")
 . S PRVVIEN=VPROV("Vprov","visitId")
 . S PRVSTDT=VPROV("Vprov","visitHL7")
 . S PRVID=VPROV("Vprov","providerId")
 . S PRPRMSEC=VPROV("Vprov","primarySecondary")
 . N PROVARR,PROVERR
 . N IENS S IENS=PRVID_","
 . D GETS^DIQ(200,IENS,"8;.111;.112;.114;.115;.116;.132;41.99","EI","PROVARR","PROVERR")
 . I $G(DEBUG),$D(PROVERR) W !,">>ERROR<<" W $$ZW^SYNDHPUTL("PROVERR")
 . QUIT:$D(PROVERR)
 . S PRROLE=PROVARR(200,IENS,8,"E")
 . S VPROV("Vprov","provRole")=PRROLE
 . S PRSTAD1=PROVARR(200,IENS,.111,"E")
 . S VPROV("Vprov","provAddress1")=PRSTAD1
 . S PRSTAD2=PROVARR(200,IENS,.112,"E")
 . S VPROV("Vprov","provAddress2")=PRSTAD2
 . S PRCITY=PROVARR(200,IENS,.114,"E")
 . S VPROV("Vprov","provCity")=PRCITY
 . S PRSTATE=PROVARR(200,IENS,.115,"E")
 . S VPROV("Vprov","provState")=PRSTATE
 . S PRZIP=PROVARR(200,IENS,.116,"E")
 . S VPROV("Vprov","provZip")=PRZIP
 . S PROFFPH=PROVARR(200,IENS,.132,"E")
 . S VPROV("Vprov","provOffPhone")=PROFFPH
 . S VPROV("Vprov","provNpi")=PROVARR(200,IENS,41.99,"E")
 . S USRCLIEN=VPROV("Vprov","personClassId")
 . S USRSPEC=$$GET1^DIQ(8932.1,USRCLIEN_",",2)
 . S VPROV("Vprov","personClassSpecialty")=USRSPEC
 . I $G(DEBUG) W !,PRNAM_U_PRVSTDT_U_PRROLE_U_PRPRMSEC
 . S ZARR(DHPICN,PRVSTDT,PRVVIEN)=PRNAM_P_PRROLE_P_PRPRMSEC_P_PRSTAD1_P_PRSTAD2_P_PRCITY_P_PRSTATE_P_PRZIP_P_PROFFPH_P_USRSPEC_P_PRID
 . M ENCPROV("EncProv",PRIEN)=VPROV ;
 ;
 ; serialize data
 S (PRVSTDT,PRVVIEN)="",ENCPROVS=DHPICN
 F  S PRVSTDT=$O(ZARR(DHPICN,PRVSTDT)) QUIT:PRVSTDT=""  D
 .F  S PRVVIEN=$O(ZARR(DHPICN,PRVSTDT,PRVVIEN)) Q:PRVVIEN=""  D
 ..S PRREC=ZARR(DHPICN,PRVSTDT,PRVVIEN)
 ..S ENCPROVS=ENCPROVS_U_PRVSTDT_P_PRVVIEN_P_PRREC
 ..; visit date|visit ien|provider name|role|prim/sec|address1|address2|city|state|zip|off. phone|specialization|resourceId
 ;
 QUIT ENCPROVS
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATPRVI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=20150101
 N TODAT S TODAT=20150301
 N JSON S JSON=""
 N RETSTA
 D PATPRVI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATPRVI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP55
SYNDHP55 ; HC/art - HealthConcourse - retrieve patient procedures ;08/10/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ;Surgical Procedures
 ;Visit Procedures
 ;Radiology Procedures
 ;Radiology Reports
 ;
 QUIT
 ;
 ;Surgical Procedures
SRPRCS(PTIEN,FRDAT,TODAT) ; get surgical procedures for a patient
 ; build the array of SNOMED CT codes that correspond to procedures
 ;
 N PROCS,FNUM,FNBR2,PIEN,PIENS,PRCPTCD,PRCPTIEN,PID,SCT,SCTPT,SEQ,DATE,MAPPING
 N VISITID,VISITDT,VISITHL,SURG,PROV,PDATE,PDATEHL,PRDATE,PRDATEHL,SERPROCS,CLINIC,DIVISION
 N ORDER,ORDERIEN,PRINPROC,SCHDPROC
 ;
 N P S P="|"
 N S S S="_"
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 S FNUM=130 ;surgery
 S FNBR2=9000010 ;visit
 N FLIST S FLIST=".015;.021;.09;.14;26;27;50;68;100;120;123"
 S SEQ=0
 ;
 I $G(DEBUG) W !,"Surgical Procedures",!
 ; scan surgery "B" index for IEN
 S PIEN=""
 F  S PIEN=$O(^SRF("B",PTIEN,PIEN)) QUIT:PIEN=""  D
 . N SURGARR,SURGERR
 . S PIENS=PIEN_","
 . D GETS^DIQ(FNUM,PIENS,FLIST,"EI","SURGARR","SURGERR")  ;specific fields
 . I $G(DEBUG),$D(SURGERR) W !,">>ERROR<<",! W $$ZW^SYNDHPUTL("SURGERR")
 . QUIT:$D(SURGERR)
 . S PID=$$RESID^SYNDHP69("V",SITE,FNUM,PIEN)
 . S PDATE=SURGARR(FNUM,PIENS,.09,"I") ;date of operation
 . QUIT:'$$RANGECK^SYNDHPUTL(PDATE,FRDAT,TODAT)  ;quit if outside of requested date range
 . S PDATEHL=$$FMTHL7^XLFDT(PDATE) ;date of operation, hl7 format
 . S CLINIC=SURGARR(FNUM,PIENS,.021,"E") ;associated clinic
 . S DIVISION=SURGARR(FNUM,PIENS,50,"E") ;division
 . S SURG=SURGARR(FNUM,PIENS,.14,"E") ;primary surgeon
 . S PRDATE=SURGARR(FNUM,PIENS,120,"I") ;date of procedure
 . S PRDATEHL=$$FMTHL7^XLFDT(PRDATE) ;date of operation, hl7 format
 . S PROV=SURGARR(FNUM,PIENS,123,"E") ;provider
 . S VISITID=SURGARR(FNUM,PIENS,.015,"I") ;visit, pointer to Visit file
 . S VISITDT=""
 . S:VISITID'="" VISITDT=$$GET1^DIQ(FNBR2,VISITID_",",.01,"I") ;visit/admit date&time
 . S VISITHL=$$FMTHL7^XLFDT(VISITDT) ;hl7 format visit/admit date&time
 . S ORDERIEN=SURGARR(FNUM,PIENS,100,"I") ;order number ien
 . S ORDER=SURGARR(FNUM,PIENS,100,"E") ;order number
 . S PRCPTIEN=SURGARR(FNUM,PIENS,27,"I") ;planned prin procedure code ien
 . S PRCPTCD=SURGARR(FNUM,PIENS,27,"E") ;planned prin procedure code
 . S PRINPROC=SURGARR(FNUM,PIENS,26,"E") ;principal procedure
 . S SCHDPROC=SURGARR(FNUM,PIENS,68,"E") ;scheduled procedure
 . ;LOOKUP SNOMED(sct) - cpt, os5
 . S SCT=""
 . S SCTPT=$S(PRINPROC'="":PRINPROC,1:"")
 . ;map cpt to snomed (currently uses very small map)
 . I PRCPTCD'="" D
 . . S SCT=$$MAP^SYNDHPMP("sct2cpt",PRCPTCD,"I")
 . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 . ;if no cpt hit, map os5 to snomed
 . I SCT="",PRCPTCD'="" D
 . . S SCT=$$MAP^SYNDHPMP("sct2os5",PRCPTCD,"I")
 . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 . I $G(DEBUG) D
 . . W !,"Record IEN: ",PIEN,!
 . . W "Planned Principal Procedure (CPT): ",PRCPTIEN,"     ",PRCPTCD,!
 . . W "Principal Procedure: ",?22,PRINPROC,!
 . . W "Scheduled Procedure: ",?22,SCHDPROC,!
 . . W "SCT: ",?22,SCT,!
 . . W "SCT Description: ",?22,SCTPT,!
 . . W "Date of Operation: ",?22,PDATE,"     ",PDATEHL,!
 . . W "Date of Procedure: ",?22,PRDATE,"     ",PRDATEHL,!
 . . W "Primary Surgeon: ",?22,SURG,!
 . . W "Provider: ",?22,PROV,!
 . . W "Clinic: ",?22,CLINIC,!
 . . W "Division: ",?22,DIVISION,!
 . . W "Order: ",?22,ORDERIEN,"     ",ORDER,!
 . . W "Visit IEN: ",?22,VISITID,!
 . . W "Visit Date: ",?22,VISITDT,"     ",VISITHL,!
 . . W "PID: ",?22,PID,!
 . S DATE=$S(PDATE'="":PDATEHL,PRDATE'="":PRDATEHL,VISITDT'="":VISITHL,1:"")
 . ;SCT code1|descrption|CPT code|date|identifier
 . S SEQ=SEQ+1
 . S PROCS(SEQ)=U_SCT_P_SCTPT_P_PRCPTCD_P_PDATEHL_P_PID
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PROCS")
 ;
 ;serialize data
 S SERPROCS=""
 S SEQ=""
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
 . S SERPROCS=SERPROCS_PROCS(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SERPROCS")
 ;
 QUIT SERPROCS
 ;
 ;Visit Procedures
VSTPRCS(PATIEN,FRDAT,TODAT) ;
 ;
 N PROCS,FNBR1,FNBR2,PIEN,VISITID,VISITDT,PRPROC
 N VISITHL,CPT,CPTNAME,PID,SEQ,SERPROCS,MAPPING,SCT
 ;
 S PROCS=""
 N P S P="|"
 S SEQ=0
 S FNBR1=9000010.18 ;v cpt
 S FNBR2=9000010 ;visit
 I $G(DEBUG) W !,"Visit Procedures",!
 ;
 S PIEN=""
 F  S PIEN=$O(^AUPNVCPT("C",PATIEN,PIEN)) QUIT:PIEN=""  D
 . N VCPT
 . D GET1VCPT^SYNDHP14(.VCPT,PIEN,0)
 . QUIT:$D(VCPT("Vcpt","ERROR"))
 . I $G(DEBUG) W $$ZW^SYNDHPUTL("VCPT")
 . S VISITDT=VCPT("Vcpt","visitFM") ;visit/admit date&time
 . QUIT:'$$RANGECK^SYNDHPUTL(VISITDT,FRDAT,TODAT)  ;quit if outside of requested date range
 . S VISITHL=VCPT("Vcpt","visitHL7") ;hl7 format visit/admit date&time
 . S PID=VCPT("Vcpt","resourceId")
 . S CPT=VCPT("Vcpt","cpt") ;cpt code
 . S CPTNAME=VCPT("Vcpt","cptName") ;cpt name
 . S VISITDT=VCPT("Vcpt","visitFM") ;visit/admit date&time
 . QUIT:(VISITDT<FRDAT)!(VISITDT>TODAT)  ;quit if outside of requested date range
 . S VISITHL=VCPT("Vcpt","visitHL7") ;hl7 format visit/admit date&time
 . S SCT=VCPT("Vcpt","sct")
 . S SEQ=SEQ+1
 . ;SCT code1|descrption|CPT code|date|identifier
 . S PROCS(SEQ)=U_SCT_P_CPTNAME_P_CPT_P_VISITHL_P_PID
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PROCS")
 ;
 ;serialize data
 S SERPROCS=""
 S SEQ=""
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
 . S SERPROCS=SERPROCS_PROCS(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SERPROCS")
 ;
 QUIT SERPROCS
 ;
 ;Radiology Procedures
RADPRCS(PATIEN,FRDAT,TODAT) ;
 ;
 N P S P="|"
 N SEQ S SEQ=0
 I $G(DEBUG) W !,"Radiology Procedures",!
 N RADEX
 D RADEXAM(.RADEX,PATIEN,0,FRDAT,TODAT)
 ;             1      2        3       4            5            6         7        8     9     10     11         12      13        14        15       16
 ; RADEX(SEQ)=PID_U_PatDfn_U_CatEx_U_ExamDate_U_ExamDateHl7_U_CASENBR_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_PDIAGCD_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL
 ;
 N SCT,PROC,PROCS,CPT,EXDATE,EXDATEHL,PID
 N IDX S IDX=""
 F  S IDX=$O(RADEX(IDX)) QUIT:IDX=""  D
 . S EXDATE=$P(RADEX(IDX),U,4)
 . QUIT:'$$RANGECK^SYNDHPUTL(EXDATE,FRDAT,TODAT)  ;quit if outside of requested date range
 . S SCT=$P(RADEX(IDX),U,10)
 . S PROC=$P(RADEX(IDX),U,8)
 . S CPT=$P(RADEX(IDX),U,9)
 . S EXDATEHL=$P(RADEX(IDX),U,5)
 . S PID=$P(RADEX(IDX),U,1)
 . ;SCT code|descrption|CPT code|date|identifier
 . S SEQ=SEQ+1
 . S PROCS(SEQ)=U_SCT_P_PROC_P_CPT_P_EXDATEHL_P_PID
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PROCS")
 ;
 ;serialize data
 N SERPROCS S SERPROCS=""
 N SEQ S SEQ=""
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
 . S SERPROCS=SERPROCS_PROCS(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SERPROCS")
 ;
 QUIT SERPROCS
 ;
 ;
 ;Radiology Procedures
RADEXAM(RADEX,PATIEN,RPT,FRDAT,TODAT) ;Radiology procedures, diagnosis, report for a patient
 ;Inputs: PATIEN - patient IEN
 ;        RPT - return report, 0=no, 1=yes
 ;Output: RADEX - array of radiology exams, by reference
 ;          PID^PatDfn^Category^ExamDate^ExamDateHl7^CASENBR^PROCIEN^PROC^CPT^SCT^PDIAGCD^REQPHYS^
 ;            PIRES^PISTAFF^VISITDT^VISITHL^EnteringUser
 ;
 S RADEX=""
 N S S S="_"
 N SEQ S SEQ=0
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 N FNBR1 S FNBR1=70 ;RAD/NUC MED PATIENT FILE, this file DINUMed
 N FNBR2 S FNBR2=70.02 ;RAD/NUC MED PATIENT FILE:REGISTERED EXAMS
 N FNBR3 S FNBR3=70.03 ;RAD/NUC MED PATIENT FILE:REGISTERED EXAMS:EXAMINATIONS
 N FNBR4 S FNBR4=9000010 ;visit
 ;
 ;get patient record
 N IENS S IENS=PATIEN_","
 N RADRPT,PATARR,PATERR
 D GETS^DIQ(FNBR1,IENS,".01;.04;.06","EI","PATARR","PATERR")  ;specific fields
 I $G(DEBUG),$D(PATERR) W !,"FNBR1:",FNBR1,!,"IENS:",IENS,!,">>ERROR<<",! W $$ZW^SYNDHPUTL("PATERR")
 QUIT:$D(PATERR)
 N PatDfn S PatDfn=$G(PATARR(FNBR1,IENS,.01,"I")) ;patient dfn
 N CategoryCd S CategoryCd=$G(PATARR(FNBR1,IENS,.04,"I")) ;category code
 N Category S Category=$G(PATARR(FNBR1,IENS,.04,"E")) ;category
 N EnteringUserId S EnteringUserId=$G(PATARR(FNBR1,IENS,.06,"I")) ;user who entered patient
 N EnteringUser S EnteringUser=$G(PATARR(FNBR1,IENS,.06,"E")) ;user who entered patient
 ;get registered exams
 N REXIEN S REXIEN=0
 F  S REXIEN=$O(^RADPT(PATIEN,"DT",REXIEN)) QUIT:'+REXIEN  D
 . N IENS1 S IENS1=REXIEN_","_IENS
 . N REXARR,REXERR
 . D GETS^DIQ(FNBR2,IENS1,".01;2;3;4;5","EI","REXARR","REXERR")  ;specific fields
 . I $G(DEBUG),$D(REXERR) W !,">>ERROR<<",! W $$ZW^SYNDHPUTL("REXERR")
 . QUIT:$D(REXERR)
 . N ExamDate S ExamDate=$G(REXARR(FNBR2,IENS1,.01,"I")) ;exam date
 . QUIT:'$$RANGECK^SYNDHPUTL(ExamDate,FRDAT,TODAT)  ;quit if outside of requested date range
 . N ExamDateHl7 S ExamDateHl7=$$FMTHL7^XLFDT(ExamDate) ;hl7 format exam date
 . ;get examinations
 . N EXIEN S EXIEN=0
 . F  S EXIEN=$O(^RADPT(PATIEN,"DT",REXIEN,"P",EXIEN)) QUIT:'+EXIEN  D
 . . N CASENBR,PROCIEN,PROC,CPT,PIRES,PDIAGCD,REQPHYS,PISTAFF,RPTTEXT,VISITID,VISITDT,VISITHL,SCT,PID
 . . N IENS2 S IENS2=EXIEN_","_IENS1
 . . N EXARR,EXERR
 . . D GETS^DIQ(FNBR3,IENS2,".01;2;12;13;14;15;17;27","EI","EXARR","EXERR")  ;specific fields
 . . I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! W $$ZW^SYNDHPUTL("EXERR")
 . . QUIT:$D(EXERR)
 . . S CASENBR=$G(EXARR(FNBR3,IENS2,.01,"I")) ;case number
 . . S PROCIEN=$G(EXARR(FNBR3,IENS2,2,"I")) ;procedure ien
 . . S PROC=$G(EXARR(FNBR3,IENS2,2,"E")) ;procedure name
 . . S CPT=""
 . . S:PROCIEN'="" CPT=$$GET1^DIQ(71,PROCIEN_",",9) ;cpt code
 . . S PIRES=$G(EXARR(FNBR3,IENS2,12,"E")) ;primary interpreting resident
 . . S PDIAGCD=$G(EXARR(FNBR3,IENS2,13,"E")) ;primary diagnostic code
 . . S REQPHYS=$G(EXARR(FNBR3,IENS2,14,"E")) ;requesting physician
 . . S PISTAFF=$G(EXARR(FNBR3,IENS2,15,"E")) ;primary interpreting staff
 . . S RPTTEXT=$G(EXARR(FNBR3,IENS2,17,"I")) ;report text (pointer to file 74)
 . . S VISITID=$G(EXARR(FNBR3,IENS2,27)) ;visit id
 . . S VISITDT=""
 . . S:VISITID'="" VISITDT=$$GET1^DIQ(FNBR4,VISITID_",",.01,"I") ;visit/admit date&time
 . . S VISITHL=$$FMTHL7^XLFDT(VISITDT) ;hl7 format visit/admit date&time
 . . S PID=$$RESID^SYNDHP69("V",SITE,FNBR1,PATIEN,FNBR2_U_REXIEN_U_FNBR3_U_EXIEN)
 . . ;LOOKUP SNOMED(sct) - cpt, os5
 . . S SCT=""
 . . ;map cpt to snomed (currently uses very small map)
 . . I CPT'="" D
 . . . S SCT=$$MAP^SYNDHPMP("sct2cpt",CPT,"I")
 . . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 . . ;if no cpt hit, map os5 to snomed
 . . I SCT="",CPT'="" D
 . . . S SCT=$$MAP^SYNDHPMP("sct2os5",CPT,"I")
 . . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
 . . ;
 . . I $G(DEBUG) D
 . . . W !,"Patient: ",?32,PatDfn,!
 . . . W "Category: ",?32,CategoryCd,"     ",Category,!
 . . . W "Exam Date: ",?32,ExamDate,"     ",ExamDateHl7,!
 . . . W "Case Number: ",?32,CASENBR,!
 . . . W "Procedure: ",?32,PROCIEN,"     ",PROC,!
 . . . W "CPT: ",?32,CPT,!
 . . . W "SCT: ",?32,SCT,!
 . . . W "Requesting physician: ",?32,REQPHYS,!
 . . . W "Primary diagnostic code: ",?32,PDIAGCD,!
 . . . W "Primary interpreting resident: ",?32,PIRES,!
 . . . W "Primary interpreting staff: ",?32,PISTAFF,!
 . . . W "Pointer to report text:",?32,RPTTEXT,!
 . . . W "Visit Date: ",?32,VISITDT,"     ",VISITHL,!
 . . . W "PID: ",?32,PID,!
 . . ;PID^PatDfn^Category^ExamDate^ExamDateHl7^CASENBR^PROCIEN^PROC^CPT^SCT^PDIAGCD^REQPHYS^PIRES^PISTAFF^VISITDT^VISITHL^EnteringUser
 . . S SEQ=SEQ+1
 . . S RADEX(SEQ)=PID_U_PatDfn_U_Category_U_ExamDate_U_ExamDateHl7_U_CASENBR_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_PDIAGCD_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL_U_EnteringUser
 . . ;
 . . I $G(RPT),RPTTEXT'="" D
 . . . D GETRPT(.RADRPT,RPTTEXT,SITE,SEQ,FRDAT,TODAT)
 . . . M RADEX(SEQ)=RADRPT(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("RADEX")
 ;
 QUIT
 ;
GETRPT(RADRPT,RPTTEXT,SITE,SEQ,FRDAT,TODAT) ; get radiology diagnostic report
 ; Inputs: RPTTEXT - radiology diagnostic report IEN from file #70
 ;         SITE - station number
 ;         SEQ - record sequence
 ; Output: RADRPT array
 ;         RADRPT(1) - PID^dayCase^dateTime^dateTimeHL7^status id^status^verifying physician id^verifying physician name
 ;         RADRPT("REPORT")=report
 ;         RADRPT("IMPRESSION")=impression
 ;
 N FNUM S FNUM=74
 I $G(DEBUG) W "<Radiology Report>"
 N DAYCASE,PRSTA,PRSTATUS,PPROV,PPROVNM,PDATE,PDATEHL
 N PID S PID=$$RESID^SYNDHP69("V",SITE,FNUM,RPTTEXT)
 N PIENS S PIENS=RPTTEXT_","
 N EXARR,EXERR
 D GETS^DIQ(FNUM,PIENS,".01;3;5;9;113","EI","EXARR","EXERR")  ;specific fields
 I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! W $$ZW^SYNDHPUTL("EXERR")
 QUIT:$D(EXERR)
 S PDATE=$G(EXARR(FNUM,PIENS,3,"I")) ;exam date/time
 QUIT:'$$RANGECK^SYNDHPUTL(PDATE,FRDAT,TODAT)  ;quit if outside of requested date range
 S PDATEHL=$$FMTHL7^XLFDT(PDATE) ;exam date/time HL7
 S DAYCASE=$G(EXARR(FNUM,PIENS,.01,"I")) ;day case#
 S PRSTA=$G(EXARR(FNUM,PIENS,5,"I")) ;report status
 S PRSTATUS=$G(EXARR(FNUM,PIENS,5,"E")) ;report status
 ;S PRSTA=$S(PRSTA="V":"final",PRSTA="D":"partial",1:"unknown") ; there are other possible values
 S PPROV=$G(EXARR(FNUM,PIENS,9,"I")) ;verifying physician ien
 S PPROVNM=$G(EXARR(FNUM,PIENS,9,"E")) ;verifying physician name
 ;
 N REPORT,IMPRESS,RPTTEXT,IMPTEXT,RPTLINE,IMPLINE
 S RPTTEXT=""
 S IMPTEXT=""
 D GETS^DIQ(FNUM,PIENS,200,,"REPORT","EXERR")
 I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! W $$ZW^SYNDHPUTL("EXERR")
 QUIT:$D(EXERR)
 N N S N=0
 F  S N=$O(REPORT(FNUM,PIENS,200,N)) Q:N=""  D
 . S RPTLINE=REPORT(FNUM,PIENS,200,N)
 . S RPTTEXT=RPTTEXT_RPTLINE
 N EXERR
 D GETS^DIQ(FNUM,PIENS,300,,"IMPRESS","EXERR")
 I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! W $$ZW^SYNDHPUTL("EXERR")
 QUIT:$D(EXERR)
 N N S N=0
 F  S N=$O(IMPRESS(FNUM,PIENS,300,N)) Q:N=""  D
 . S IMPLINE=IMPRESS(FNUM,PIENS,300,N)
 . S IMPTEXT=IMPTEXT_IMPLINE
 ;
 I $G(DEBUG) D
 . W !,"Exam Date/Time:",?25,PDATE,"     ",PDATEHL,!
 . W "Day-Case#:",?25,DAYCASE,!
 . W "Report Status:",?25,PRSTA,"     ",PRSTATUS,!
 . W "Verifying Physician:",?25,PPROV,"     ",PPROVNM,!
 . W "Report:",?25,RPTTEXT,!
 . W "Impression:",?25,IMPTEXT,!
 S RADRPT(SEQ,1)=PID_U_DAYCASE_U_PDATE_U_PDATEHL_U_PRSTA_U_PRSTATUS_U_PPROV_U_PPROVNM
 S RADRPT(SEQ,"REPORT")=RPTTEXT
 S RADRPT(SEQ,"IMPRESSION")=IMPTEXT
 ;
 QUIT
 ;

SYNDHP56
SYNDHP56 ; HC/ART - HealthConcourse - retrieve patient mental health observations ;07/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient Observations ----------------------
 ;  MH Administrations
 ;  GAF
 ;
PATOBS(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT) ; get Observations for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return patient Observations for name, SSN, DOB, and gender
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   FRDAT   - from date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
 ;   TODAT   - to date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
 ; Output:
 ;   RETSTA  - a delimited string that lists LOINC and SNOMED CT codes for the patient Observations
 ;           - ICN^SCT code|descrption|LOINC code|description|instrument name|date given|clinic name|ordered by|scale:score|identifier
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 ;
 N C,P,S,ZARR,ICNST,DHPICN,PATIEN
 ;
 S C=",",P="|",S="_"
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 ; if we are here we are dealing with a valid patient
 S DHPICN=$P(ICNST,U,3)
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 S RETSTA=DHPICN
 D GET(.RETSTA,PATIEN,FRDAT,TODAT)
 ;
 QUIT
 ;
PATOBSI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient Observations for ICN
 ;
 ; Return patient Observations for a given patient ICN
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
 ;   TODAT   - to date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists LOINC and SNOMED CT codes for the patient Observations
 ;           - ICN^LOINC code|description|SCT code|description|Instrument Name|date given|clinic name|ordered by|scale:score|resource ID^...
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 N C,P,S,ZARR,PATIEN
 S C=",",P="|",S="_"
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETSTA=DHPICN
 D GET(.RETSTA,PATIEN,FRDAT,TODAT)
 ;
 QUIT
 ;
GET(RETSTA,PATIEN,FRDAT,TODAT) ;
 ;
 N OBSARRAY
 ;Mental Health Observations (Assessments/Administrations)
 N MHARRAY,RETVAL
 S RETVAL=$$MHOBS(.MHARRAY,PATIEN,FRDAT,TODAT)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . M OBSARRAY=MHARRAY
 E  D
 . S RETSTA=RETSTA_RETVAL
 ;
 ;GAF (Global Assessment of Functioning)
 N GAFARRAY,RETVAL
 S RETVAL=$$GAFOBS(.GAFARRAY,PATIEN,FRDAT,TODAT)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . M OBSARRAY=GAFARRAY
 E  D
 . S RETSTA=RETSTA_RETVAL
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.OBSARRAY,.RETSTA)
 ;
 QUIT
 ;
 ;
MHOBS(MHARRAY,PATIEN,FRDAT,TODAT) ;Mental Health Observations
 ;patient's MH administration results - observation
 ;
 N PROCS,SERPROCS
 N ADMINIEN,ADMINNBR,INSTID,INSTNAME,GIVDATE,GIVDATEHL,PROVO,PROVA,LOCID,LOCATION,SCALE,SCORE,PROVNAMO,PROVNAMA
 N SNOMED,SDESC,LOINC,LDESC,MH2LOINC,LOINC2MH,MH2SNOMED,SCT
 N RESIEN,RIENS
 N YS,YSRET,YSSEQ
 ;
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 ;
 S PROCS=""
 ;D LOADREF(.MH2LOINC,.LOINC2MH,.MH2SNOMED)  ;load temporary code arrays
 ;
 N SEQ S SEQ=0
 N MHADMIEN S MHADMIEN=""
 F  S MHADMIEN=$O(^YTT(601.84,"C",PATIEN,MHADMIEN)) Q:MHADMIEN=""  D
 . N MHADM
 . D GET1MHADM^SYNDHP26(.MHADM,MHADMIEN,0) ;get one MH Administration record
 . I $D(MHADM("Mhadm","ERROR")) M MHARRAY("Observations",MHADMIEN)=MHADM QUIT
 . S ADMINNBR=MHADM("Mhadm","administrationNumber") ;administration number
 . QUIT:ADMINNBR=""
 . S GIVDATE=MHADM("Mhadm","dateGivenFM") ;date given
 . QUIT:'$$RANGECK^SYNDHPUTL(GIVDATE,FRDAT,TODAT)  ;quit if outside of requested date range
 . QUIT:MHADM("Mhadm","isCompleteCd")'="Y"  ;quit if not complete
 . S INSTNAME=MHADM("Mhadm","instrumentName") ;instrument name
 . S INSTID=MHADM("Mhadm","instrumentNameId") ;instrument id
 . S GIVDATEHL=MHADM("Mhadm","dateGivenHL7") ;hl7 format date given
 . S PROVO=MHADM("Mhadm","orderedById") ;ordered by ien
 . S PROVNAMO=MHADM("Mhadm","orderedBy") ;ordered by
 . S PROVA=MHADM("Mhadm","administeredById") ;administered by ien
 . S PROVNAMA=MHADM("Mhadm","administeredBy") ;administered by
 . S LOCID=MHADM("Mhadm","locationId") ;location ien
 . S LOCATION=MHADM("Mhadm","location") ;location
 . S LOINC=MHADM("Mhadm","loincCode")
 . S SCT=MHADM("Mhadm","snomedCode")
 . S LDESC=INSTNAME_" Result"
 . S SDESC=MHADM("Mhadm","sctPreferredTerm")
 . ;get administration results
 . S RESULT=""
 . S RESIEN=""
 . F  S RESIEN=$O(^YTT(601.92,"AC",ADMINNBR,RESIEN)) Q:RESIEN=""  D
 . . N MHRES
 . . D GET1MHRES^SYNDHP26(.MHRES,RESIEN,0) ;get one MH Results record
 . . I $D(MHRES("Mhres","ERROR")) M MHARRAY("Observations",MHADMIEN,"results")=MHRES QUIT
 . . S RIENS=RESIEN_","
 . . S SCALE=MHRES("Mhres","scale") ;scale
 . . S SCORE=MHRES("Mhres","rawScore") ;raw score
 . . S RESULT=SCALE_":"_SCORE
 . . S PID=$$RESID^SYNDHP69("V",SITE,601.84,ADMINNBR,601.92_U_RESIEN)
 . . ;
 . . I $G(DEBUG) D
 . . . W !,"Admin Number:    ",ADMINNBR,!
 . . . W "Instrument:      ",INSTID,"     ",INSTNAME,!
 . . . W "Date Given:      ",GIVDATE,"     ",GIVDATEHL,!
 . . . W "Ordered by:      ",PROVO,"     ",PROVNAMO,!
 . . . W "Administered by: ",PROVA,"     ",PROVNAMA,!
 . . . W "Location:        ",LOCID,"     ",LOCATION,!
 . . . W "Results:     ",RESULT,!
 . . . W "LOINC Code:  ",LOINC,!
 . . . W "SNOMED Code: ",SCT,!
 . . . W "Description: ",SDESC,!
 . . ;
 . . ;record is created for each result for an instrument administration
 . . ;LOINC code|description|SCT code|descrption|Instrument Name|date given|clinic name|ordered by|scale:score|resource id
 . . S SEQ=SEQ+1
 . . S PROCS(SEQ)=U_LOINC_P_LDESC_P_SCT_P_SDESC_P_INSTNAME_P_GIVDATEHL_P_LOCATION_P_PROVNAMO_P_RESULT_P_PID
 . . M MHARRAY("Observations",MHADMIEN,"Mhadm","results")=MHRES
 . M MHARRAY("Observations",MHADMIEN)=MHADM
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PROCS")
 ;serialize data
 S SERPROCS=""
 S SEQ=""
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
 . S SERPROCS=SERPROCS_PROCS(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SERPROCS")
 ;
 QUIT SERPROCS
 ;
GAFOBS(GAFARRAY,PATIEN,FRDAT,TODAT) ;get GAF score
 ;
 N PROCS,SERPROCS,SEQ,MHIEN,IENS
 N FILEDTFM,FILEDT,FILEDTHL,GAFDTFM,GAFDT,GAFDTHL,GAFBYID,GAFBY,TRANSCID,TRANSCR,GAF,RESULT,PID
 N SNOMED,SDESC,LOINC,LDESC,DESC,PATTYPE
 ;
 S (SNOMED,LOINC)=""
 S (SDESC,LDESC)="GAF"
 S DESC="Global Assessment of Functioning"
 ;
 I $G(DEBUG) W !,"GAF - Global Assessment of Functioning",!!
 S PROCS=""
 S FNBR1=627.8 ;Diagnostic Results-Mental Health
 S SEQ=0
 ;
 S MHIEN=""
 F  S MHIEN=$O(^YSD(627.8,"C",PATIEN,MHIEN)) QUIT:MHIEN=""  D
 . N GAFREC
 . D GET1MHDX^SYNDHP17(.GAFREC,MHIEN,0) ;get one GAF record
 . I $D(GAFREC("Mhdiag","ERROR")) M GAFARRAY("Observations",MHIEN)=GAFREC QUIT
 . S GAF=GAFREC("Mhdiag","axis5-GAF") ;axis 5 (GAF)
 . QUIT:GAF=""
 . S GAFDTFM=GAFREC("Mhdiag","dateTimeOfDiagnosisFM") ;date/time of diagnosis fm format
 . QUIT:'$$RANGECK^SYNDHPUTL(GAFDTFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . S FILEDTFM=GAFREC("Mhdiag","fileEntryDateFM") ;file entry date fm format
 . S FILEDT=GAFREC("Mhdiag","fileEntryDate") ;file entry date
 . S FILEDTHL=GAFREC("Mhdiag","fileEntryDateHL7") ;hl7 format file entry date
 . S GAFDT=GAFREC("Mhdiag","dateTimeOfDiagnosis") ;date/time of diagnosis
 . S GAFDTHL=GAFREC("Mhdiag","dateTimeOfDiagnosisHL7") ;hl7 format date/time of diagnosis
 . S GAFBYID=GAFREC("Mhdiag","diagnosisById") ;diagnosed by ien
 . S GAFBY=GAFREC("Mhdiag","diagnosisBy") ;diagnosed by
 . S TRANSCID=GAFREC("Mhdiag","transcriberId") ;transcriber ien
 . S TRANSCR=GAFREC("Mhdiag","transcriber") ;transcriber
 . S RESULT="GAF Scale:"_GAF
 . S PATTYPE=GAFREC("Mhdiag","patientTypeCd") ;patient type
 . S PID=GAFREC("Mhdiag","resourceId")
 . S GAFREC("Mhdiag","instrumentName")="Global Assessment of Functioning"
 . S GAFREC("Mhdiag","instrumentNameId")="GAF"
 . ;
 . I $G(DEBUG) D
 . . W "File Date Time: ",FILEDTFM,"     ",FILEDT,"     ",FILEDTHL,!
 . . W "GAF Date Time:  ",GAFDTFM,"     ",GAFDT,"     ",GAFDTHL,!
 . . W "Diagnosis by:   ",GAFBYID,"     ",GAFBY,!
 . . W "Transcriber:    ",TRANSCID,"     ",TRANSCR,!
 . . W "Patient Type:   ",PATTYPE,!
 . . W "Result:         ",RESULT,!
 . . W "LOINC Code:  ",LOINC,!
 . . W "SNOMED Code: ",SNOMED,!
 . . W "Description: ",SDESC,!
 . ;
 . ;LOINC code|description|SCT code|descrption|Instrument Name|date given|clinic name|ordered by|scale:score|identifier
 . S SEQ=SEQ+1
 . S PROCS(SEQ)=U_LOINC_P_LDESC_P_SNOMED_P_SDESC_P_DESC_P_GAFDTHL_P_""_P_GAFBY_P_RESULT_P_PID
 . M GAFARRAY("Observations",MHIEN)=GAFREC QUIT
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("PROCS")
 ;
 ;serialize data
 S SERPROCS=""
 S SEQ=""
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
 . S SERPROCS=SERPROCS_PROCS(SEQ)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("SERPROCS")
 ;
 QUIT SERPROCS
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="5000000352V586511"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N RETSTA
 D PATOBSI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N ICN S ICN="5000000352V586511"
 N FRDAT S FRDAT=20140831
 N TODAT S TODAT=20141101
 N RETSTA
 D PATOBSI(.RETSTA,ICN,FRDAT,TODAT)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N ICN S ICN="5000000352V586511"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATOBSI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP57
SYNDHP57 ; HC/fjf/art - HealthConcourse - get patient allergies ;07/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; ---------------- Get patient allergies ------------------------------
 ;
PATALLI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient allergies for ICN
 ;
 ; Return patient allergies for a given patient ICN
 ;
 ; Input:
 ;   DHPICN  - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to origination date/time
 ;   TODAT   - to date (inclusive), optional, compared to origination date/time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return allergies string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for the patient allergies
 ;           - ICN^allergen|SCT:code|origination dt/tm|type|verified flag|resource id~reaction:sct code:severity^...
 ;             or if no reaction: ICN^allergen|SCT:code|origination dt/tm|type|verified flag|resource id^...
 ;          or patient allergies in JSON format
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N ALLARRAY
 S RETSTA=$$ALLERGIES(.ALLARRAY,PATIEN,DHPICN,FRDAT,TODAT)
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.ALLARRAY,.RETSTA)
 ;
 QUIT
 ;
ALLERGIES(ALLARRAY,PATIEN,DHPICN,FRDAT,TODAT) ; get allergies for a patient
 ;
 N ZARR
 N V S V="_"
 N P S P="|"
 N S S S=";"
 N USER S USER=$$DUZ^SYNDHP69
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
 I $G(DEBUG) W !,"Allergies",!
 ;
 N x,AID,ADATEFM,ADATE,REACTANT,ALGE,ALLERGENI,ATYPE,ATYPET,AVERT,AEIER
 N RE85IEN,REACTION,ENTBY,ENTDATE,RSEV,IENS,ALLERGIES,FT,TX,O,CS
 N ALLRET S ALLRET=DHPICN
 N FNUM S FNUM=120.8 ;patient allergies
 ; scan Patient Allergies B index
 N ALLIEN S ALLIEN=""
 F x=1:1 S ALLIEN=$O(^GMR(FNUM,"B",PATIEN,ALLIEN)) QUIT:ALLIEN=""  D
 . N ALLERGY
 . D GET1ALLERGY^SYNDHP16(.ALLERGY,ALLIEN,0)
 . I $D(ALLERGY("Allergy","ERROR")) M ALLARRAY("Allergies",ALLIEN)=ALLERGY QUIT
 . S AID=ALLERGY("Allergy","resourceId")
 . S ADATEFM=ALLERGY("Allergy","originationDateTimeFM")
 . QUIT:'$$RANGECK^SYNDHPUTL(ADATEFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . S ADATE=ALLERGY("Allergy","originationDateTimeHL7")
 . S REACTANT=ALLERGY("Allergy","reactant")
 . S FT=" ( FREE TEXT )"
 . I REACTANT[FT S REACTANT=$P(REACTANT,FT)
 . S ALGE=REACTANT
 . S ALLERGENI=ALLERGY("Allergy","gmrAllergyId")
 . I $P(ALLERGENI,S,2)["PS" S REACTANT=$P($$GVREF(ALLERGENI),U,2)
 . S ATYPE=ALLERGY("Allergy","allergyType")
 . S ATYPET=ALLERGY("Allergy","allergyTypeFHIR")
 . S AVERT=ALLERGY("Allergy","verified")
 . S AEIER=ALLERGY("Allergy","enteredInError")
 . S AVERT=$S(AVERT="YES":"confirmed",AEIER="YES":"entered-in-error",1:"unconfirmed")
 . ;get severity from file 120.85
 . S RE85IEN=$O(^GMR(120.85,"C",ALLIEN,""))
 . S RSEV=$$GET1^DIQ(120.85,RE85IEN_",",14.5)
 . S ALLERGY("Allergy","severity")=RSEV
 . S ALLERGY("Allergy","severityCd")=$$GET1^DIQ(120.85,RE85IEN_",",14.5,"I")
 . S ALLERGIES(x)=AID_U_ADATEFM_U_ADATE_U_REACTANT_U_ALLERGENI_U_ATYPE_U_ATYPET_U_AVERT_U_AEIER_U_RSEV
 . ;get reactions
 . N y
 . S IENS=""
 . F y=1:1 S IENS=$O(ALLERGY("Allergy","reactionss","reactions",IENS)) QUIT:IENS=""  D
 . . S REACTION=ALLERGY("Allergy","reactionss","reactions",IENS,"reaction")
 . . S ENTBY=ALLERGY("Allergy","reactionss","reactions",IENS,"enteredBy")
 . . S ENTDATE=ALLERGY("Allergy","reactionss","reactions",IENS,"dateEnteredHL7")
 . . S ALLERGIES(x,y)=AID_U_REACTION_U_ENTBY_U_ENTDATE_U_RSEV_U_ATYPET
 . M ALLARRAY("Allergies",ALLIEN)=ALLERGY ;
 . ;
 . I $G(DEBUG) D
 . . W "ADATE:",ADATE,!
 . . W "REACTANT:",REACTANT,!
 . . W "ALGE:",ALGE,!
 . . W "ALLERGENI:",ALLERGENI,!
 . . W "ATYPE:",ATYPE,!
 . . W "ATYPET:",ATYPET,!
 . . W "AVERT:",AVERT,!
 . . W "AEIER:",AEIER,!
 . . W "RE85IEN:",RE85IEN,!
 . . W "RSEV:",RSEV,!
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("ALLERGIES") W !
 ;
 ; serialize data
 N N,SCT,AIEN,ALGN,ALGE,ADATE,ATYPET,AVERT,RSEV,AID,ATYNODE,ATYPTX,ATYPET,GMRID
 S (SCT,AIEN)=""
 S ALGN=""
 F  S ALGN=$O(ALLERGIES(ALGN)) QUIT:ALGN=""  D
 . S ALGE=$P(ALLERGIES(ALGN),U,4)
 . S ADATE=$P(ALLERGIES(ALGN),U,3)
 . S GMRID=$P(ALLERGIES(ALGN),U,5)
 . S ATYPET=$P(ALLERGIES(ALGN),U,7)
 . S AVERT=$P(ALLERGIES(ALGN),U,8)
 . S RSEV=$P(ALLERGIES(ALGN),U,10)
 . S AID=$P(ALLERGIES(ALGN),U,1)
 . S ATYNODE=$O(ALLERGIES(ALGN,""))
 . S (ATYPTX,ATYPET)=""
 . I ATYNODE'="" D
 . . S ATYPTX=$G(ALLERGIES(ALGN,ATYNODE))
 . . S ATYPET=$P($G(ATYPTX),U,6)
 . N VMAP
 . I $P(GMRID,S,2)["PS" D
 . . S VUID=+$$GVREF(GMRID)
 . . S VMAP=$$MVUID(VUID,"VMAP")
 . I $P(GMRID,S,2)'["PS" D
 . . S CODE=$$MAPR^SYNDHPMP(ALGE,"T","A")
 . . S VMAP("SCT",CODE)=""
 . S (CS,N,O)=""
 . F  S N=$O(VMAP(N)) Q:N=""  F  S O=$O(VMAP(N,O)) Q:O=""  S CS=CS_N_":"_O_"~"
 . S CS=$RE($E($RE(CS),2,$L(CS)))
 . S ALLRET=ALLRET_U_ALGE_P_CS_P_ADATE_P_ATYPET_P_AVERT_P_AID
 . S N=""
 . F  S N=$O(ALLERGIES(ALGN,N)) Q:N=""  D
 . . S TX=ALLERGIES(ALGN,N)
 . . S REACTION=$P(TX,U,2)
 . . S ALLRET=ALLRET_"~"_REACTION_":"_$$MAPR^SYNDHPMP(REACTION,"T","R")_":"_$$LOW^XLFSTR(RSEV)
 . ;
 . I $G(DEBUG) D
 . . W "ALGE:",ALGE,!
 . . W "ADATE:",ADATE,!
 . . W "ATYPET:",ATYPET,!
 . . W "AVERT:",AVERT,!
 . . W "RSEV:",RSEV,!
 . . W "AID:",AID,!
 . . W "ATYNODE:",ATYNODE,!
 . . W "ATYPTX:",ATYPTX,!
 . . W "CS:",CS,!!
 ;
 QUIT ALLRET
 ;
 ;  -------------- Utility functions
 ;
VXMAPR(SURFORM,SFTYPE,MAOR) ; map reactions (SNOMED CT) - - redundant code - remove when sure
 ; map an allergic reaction surface form to an SCT code
 ; Input:
 ;   SURFORM - surface form
 ;   TYPE    - type of surface form
 ;             I - IEN
 ;             T - term
 ;   MAOR    - allergen or reaction
 ;             A - Allergen
 ;             R - Reaction
 ;
 I SFTYPE'="I",SFTYPE'="T" Q "-1^Type unrecognised - should be I or T"
 I MAOR'="A",MAOR'="R" Q "-1^Allergy/Reaction indicator unrecognised - should be A or R"
 N RSUB,INDX
 S RSUB=$S(MAOR="A":"ALLERGENS",1:"REACTIONS")
 S INDX=$S(SFTYPE="I":"ICT",1:"TCI")
 I '$D(^SYN("2002.010",RSUB,INDX,SURFORM)) Q ""  ; <<<<<< this global is missing
 QUIT $O(^SYN("2002.010",RSUB,INDX,SURFORM,""))
 ;
GVREF(ALLERGEN) ; map allergens (SNOMED CT, NDFRT, RxNorm, VANDF, etc)
 ; GMRD - SNOMED CT
 N S S S=";"
 ;I $P(ALLERGEN,S,2)["GMRD" D MAPGMRD QUIT MAPS
 I $P(ALLERGEN,S,2)["PSDRUG" QUIT $$VDRUG()
 I $P(ALLERGEN,S,2)["PSNDF" QUIT $$VPSNDF()
 I $P(ALLERGEN,S,2)["PS(50.416" QUIT $$VP50416()
 I $P(ALLERGEN,S,2)["PS(50.605" QUIT $$VP50605()
 QUIT
 ;
VDRUG() ;
 N PSDIEN,GENNAM,FPFOS,VUID,VMAP
 ;W !,N,"  -  ",INT,"  -  ",EXT
 S PSDIEN=+$P(ALLERGEN,";")
 ;W !,$$GET1^DIQ(50,PSDIEN_",",64,"E")
 S GENNAM=$$GET1^DIQ(50,PSDIEN_",",64,"E")
 ;W !,$O(^PS(50.416,"B",GENNAM,""))
 I '$D(^PS(50.416,"B",GENNAM)) QUIT "not found"
 S FPFOS=$O(^PS(50.416,"B",GENNAM,""))
 S VUID=$$GET1^DIQ(50.416,FPFOS_",","VUID")
 S VMAP=$$MVUID(VUID,"VMAP")
 QUIT VUID_U_GENNAM
 ;
 ;
VPSNDF() ;
 N PSDIEN,GENNAM,VUID
 S PSDIEN=+$P(ALLERGEN,";")
 S GENNAM=$$GET1^DIQ(50.6,PSDIEN_",",.01,"E")
 S VUID=$$GET1^DIQ(50.6,PSDIEN_",","VUID")
 QUIT VUID_U_GENNAM
 ;
VP50416() ;
 N PSDIEN,GENNAM,VUID
 S PSDIEN=+$P(ALLERGEN,";")
 S GENNAM=$$GET1^DIQ(50.416,PSDIEN_",",.01,"E")
 S VUID=$$GET1^DIQ(50.416,PSDIEN_",","VUID")
 QUIT VUID_U_GENNAM
 ;
VP50605() ;
 N PSDIEN,GENNAM,VUID
 S PSDIEN=+$P(ALLERGEN,";")
 S GENNAM=$$GET1^DIQ(50.605,PSDIEN_",",1,"E")
 S VUID=$$GET1^DIQ(50.605,PSDIEN_",","VUID")
 QUIT VUID_U_GENNAM
 ;
LYNX ;
 N EXT,INT
 N N S N=0
 N F S F=120.8
 F  S N=$O(^GMR(F,N)) Q:+N=0  D
 .S INT=$$GET1^DIQ(F,N_",",1,"I")
 .S EXT=$$GET1^DIQ(F,N_",",1,"E")
 .I $P(INT,";",2)["GMRD" Q
 .;I $P(INT,";",2)["PSDRUG" D LPSDRUG Q
 .I $P(INT,";",2)["PSNDF" D LPSNDF Q
 .W !,N,"  -  ",INT,"  -  ",EXT
 Q
 ;
LPSNDF ;
 Q
 W !,N,"  -  ",INT,"  -  ",EXT
 N PSDIEN,VUID
 S PSDIEN=+$P(INT,";")
 S VUID=$$GET1^DIQ(50.6,PSDIEN_",","VUID")
 W !,VUID
 Q
 ;
MVUID(VUID,MAP) ;  ******   needs work  ******
 ; map VUID to RXNORM sources ; Should be RxNorm
 N VMAP,RXCUI,SRC,CODE
 S VMAP("VANDF",VUID)=""
 S RXCUI=""
 F  S RXCUI=$O(^SYN("2002.020","IXVANDF",VUID,RXCUI)) Q:RXCUI=""  D
 .F SRC="RXNORM","NDFRT" D
 ..S CODE=""
 ..F  S CODE=$O(^SYN("2002.020",RXCUI,SRC,CODE)) Q:CODE=""  D
 ...S VMAP(SRC,CODE)=""
 M @MAP=VMAP
 Q MAP
 ;
KILL ;
 ;K AEIER,AID,ALLERGENI,CS,CODE,V,VMAP,SRC,RXCUI,ATYPET,GENNAM,REACT,REACTS,VUID
 ;K ALLERGY,AVERT,ATYPE,S,ALGN,PSDRUG
 Q
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="10111V183702"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T2 ;
 N ICN S ICN="10111V183702"
 N FRDAT S FRDAT=20000101
 N TODAT S TODAT=20050101
 N JSON S JSON=""
 N RETSTA
 D PATALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T3 ;
 N ICN S ICN="10111V183702"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
TESTS ;
ALLTEST0 ; pass
 D PATALLI(.RETSTA,"10111V183702")
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 Q
PROTEST ; in keeping with the spirit of the times
 n icn,pien
 s icn=""
 f  s icn=$o(^DPT("AFICN",icn)) q:icn=""  d
 .s pien=""
 .f  s pien=$o(^DPT("AFICN",icn,pien)) q:pien=""  d
 ..q:'$d(^GMR(120.8,"B",pien))
 ..k output
 ..k (icn,pien)
 ..d PATALLI(.output,icn)
 ..;i output["RXNORM" q
 ..;i output["NDFRT" q
 ..;i output'["VANDF" q
 ..W !!!!!!!! W $$ZW^SYNDHPUTL("output")
 q

SYNDHP58
SYNDHP58 ; HC/art - HealthConcourse - get care team data ;07/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ;The authoratative source for VHA care team data is PCMM Web. (currently no connection is available.)
 ; PCMM Web updates VistA files on a regular basis.
 ;
 QUIT
 ;
GETTEAMS(RETSTA,FRDAT,TODAT,RETJSON) ;get all care teams
 ;input: FRDAT   - from date (inclusive), optional, compared to Current Activation Date
 ;       TODAT   - to date (inclusive), optional, compared to Current Activation Date
 ;       RETJSON - J = Return JSON
 ;                 F = Return FHIR
 ;                 0 or null = Return TEAMS string (default)
 ;returns: RETSTA - delimited string or JSON or FHIR string
 ;                  field delimiter |
 ;                  team delimiter ^
 ;                  resourceId | teamName | teamPurpose | institution | serviceDept | currentStatus | fhirTeamType | currentActivationDate | currentInactivationDate | current#Patients | resourceType ^ ...
 ;                or care team data in JSON format
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 S RETSTA=""
 N P S P="|"
 N TEAMS
 N TEAMIEN S TEAMIEN=0
 F  S TEAMIEN=$O(^SCTM(404.51,TEAMIEN)) QUIT:+TEAMIEN=0  D
 . I $G(DEBUG) W !,"-------------------------------------------------------------",!
 . N TEAM,TEAMJ
 . D GET1TEAM^SYNDHP18(.TEAM,TEAMIEN,0)
 . I $D(TEAM("Team","ERROR")) M TEAMS("Teams",TEAMIEN)=TEAM QUIT
 . QUIT:'$$RANGECK^SYNDHPUTL(TEAM("Team","currentActivationDateCFM"),FRDAT,TODAT)  ;quit if outside of requested date range
 . M TEAMS("Teams",TEAMIEN)=TEAM
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
 . . S RETSTA=RETSTA_TEAM("Team","resourceId")_P_TEAM("Team","teamName")_P_TEAM("Team","teamPurpose")_P_TEAM("Team","institution")_P_TEAM("Team","serviceDept")_P
 . . S RETSTA=RETSTA_TEAM("Team","currentStatusC")_P_"longitudinal"_P_TEAM("Team","currentActivationDateCHL7")_P_TEAM("Team","currentInactivationDateCHL7")_P
 . . S RETSTA=RETSTA_TEAM("Team","current#PatientsC")_P_TEAM("Team","resourceType")_U
 . . I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TEAM")
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TEAMS")
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.TEAMS,.RETSTA)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("RETSTA")
 ;
 QUIT
 ;
GETTEAM(RETSTA,TEAMID,RETJSON) ;get one care team
 ;input: TEAMID - Team Name or IEN
 ;       RETJSON - J = Return JSON
 ;                 F = Return FHIR
 ;                 0 or null = Return TEAMS string (default)
 ;returns: RETSTA - delimited string or JSON or FHIR string
 ;                  resourceId | teamName | teamPurpose | institution | serviceDept | currentStatus | fhirTeamType | currentActivationDate | currentInactivationDate | current#Patients | resourceType
 ;                or care team data in JSON format
 ;         -1^What team?
 ;         -1^Team not found
 ;
 I $G(TEAMID)="" S RETSTA="-1^What team?" QUIT
 N TEAMIEN,ERR
 S TEAMIEN=$$FIND1^DIC(404.51,"","BO",TEAMID,"","","ERR")
 I $G(DEBUG),$D(ERR) W ! W $$ZW^SYNDHPUTL("ERR")
 I TEAMIEN=0,+TEAMID,'$D(^SCTM(404.51,+TEAMID)) S RETSTA="-1^Team not found" QUIT
 I $D(^SCTM(404.51,+TEAMID,0)) S TEAMIEN=TEAMID
 I TEAMIEN=0 S RETSTA="-1^Team not found" QUIT
 ;
 I $G(DEBUG) W !,"---------------------------- care team ---------------------------------",!
 N P S P="|"
 S RETSTA=""
 N TEAM,TEAMJ,TEAMS
 DO
 . D GET1TEAM^SYNDHP18(.TEAM,TEAMIEN,0)
 . M TEAMS("Teams",TEAMIEN)=TEAM
 . QUIT:$D(TEAM("Team","ERROR"))
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
 . . S RETSTA=RETSTA_TEAM("Team","resourceId")_P_TEAM("Team","teamName")_P_TEAM("Team","teamPurpose")_P_TEAM("Team","institution")_P_TEAM("Team","serviceDept")_P
 . . S RETSTA=RETSTA_TEAM("Team","currentStatusC")_P_"longitudinal"_P_TEAM("Team","currentActivationDateCHL7")_P_TEAM("Team","currentInactivationDateCHL7")_P
 . . S RETSTA=RETSTA_TEAM("Team","current#PatientsC")_P_TEAM("Team","resourceType")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TEAM")
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("TEAMS") W !
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.TEAMS,.RETSTA)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("RETSTA") W !
 ;
 QUIT
 ;
 ; ----------- Unit Test -----------
T1 ;
 N TEAMID S TEAMID="RED"
 N JSON S JSON=""
 N RETSTA
 D GETTEAM(.RETSTA,TEAMID,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T2 ;
 N TEAMID S TEAMID=3
 N JSON S JSON="J"
 N RETSTA
 D GETTEAM(.RETSTA,TEAMID,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T3 ;
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D GETTEAMS(.RETSTA,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T4 ;
 N FRDAT S FRDAT=20121231
 N TODAT S TODAT=20141231
 N JSON S JSON=""
 N RETSTA
 D GETTEAMS(.RETSTA,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T5 ;
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D GETTEAMS(.RETSTA,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP59
SYNDHP59 ; HC/art - HealthConcourse - get care plan data for a patient ;07/24/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ; -------------------- Patient Care Plans --------------------
 ;
PATCPALL(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT,RETJSON) ; get Care Plans for a patient by traits
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return patient Care Plans for name, SSN, DOB, and gender
 ; This API will only return data for Synthea care plan patients
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   FRDATE  - from date (inclusive), optional, compared to Visit Date/Time
 ;   TODATE  - to date (inclusive), optional, compared to Visit Date/Time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 = Return Care Plan string (default)
 ; Output:
 ;   RETSTA  - a delimited string ...
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 ;
 N ICNST,DHPICN,PATIEN
 ;
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 S DHPICN=$P(ICNST,U,3)
 ;
 ; get patient IEN from ICN
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 S RETSTA=DHPICN
 ;
 D GETALL(.RETSTA,PATIEN,FRDAT,TODAT)
 ;
 QUIT
 ;
 ; -------------------- Patient Care Plans --------------------
 ;
PATCPALLI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Get Patient Care Plans for ICN
 ;
 ; Return patient Care Plans for a given patient ICN
 ; This API will only return care plan(s) for ingested Synthea patients
 ;
 ; Input:
 ;   DHPICN  - patient ICN (unique patient identifier across all VistA systems)
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 = Return Care Plan string (default)
 ; Output:
 ;   RETSTA  - a delimited string ...
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
 ;         or care plan data in JSON format
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 S RETSTA=DHPICN
 ;
 D GETALL(.RETSTA,PATIEN,FRDAT,TODAT)
 ;
 QUIT
 ;
GETALL(RETSTA,PATIEN,FRDAT,TODAT) ;get all care plans for a patient
 ;
 N P S P="|"
 ;
 N visitId,HLFACTS
 N HFIEN S HFIEN=""
 F  S HFIEN=$O(^AUPNVHF("C",PATIEN,HFIEN)) QUIT:HFIEN=""  D
 . N HLFACT
 . D GET1HLF^SYNDHP15(.HLFACT,HFIEN,1,0)
 . I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",HFIEN)=HLFACT QUIT
 . ;I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT QUIT
 . QUIT:$E(HLFACT("HealthFactor","hlfName"),1,4)'="SYN "
 . I $G(DEBUG) W HLFACT("HealthFactor","visitFM"),!
 . QUIT:'$$RANGECK^SYNDHPUTL(HLFACT("HealthFactor","visitFM"),FRDAT,TODAT)  ;quit if outside of requested date range
 . S visitId=HLFACT("HealthFactor","visitId")
 . M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
 . . S RETSTA=RETSTA_U_HLFACT("HealthFactor","resourceId")_P_HLFACT("HealthFactor","hlfNameSCT")_P_HLFACT("HealthFactor","hlfName")_P
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","levelSeverity")_P_HLFACT("HealthFactor","encounterProvider")_P_HLFACT("HealthFactor","eventDateTimeHL7")_P
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","visitHL7")_P_HLFACT("HealthFactor","comments")
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HLFACTS")
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.HLFACTS,.RETSTA)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("RETSTA")
 ;
 QUIT
 ;
PATCP(RETSTA,NAME,SSN,DOB,GENDER,VRESID,RETJSON) ; get Care Plan for a patient by traits and Visit ID
 S RETSTA="-1^This service has been retired"
 QUIT
 ; Return patient Care Plans for name, SSN, DOB, and gender and Visit ID
 ; This API will only return data for Synthea care plan patients
 ;
 ; Input:
 ;   NAME    - patient name
 ;   SSN     - social security number
 ;   DOB     - date of birth
 ;   GENDER  - gender
 ;   VRESID  - Visit resource ID
 ;   RETJSON - J = Return JSON
 ;             0 = Return Care Plan string (default)
 ; Output:
 ;   RETSTA  - a delimited string ...
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
 ;         or care plan data in JSON format
 ;
 I $G(VRESID)="" S RETSTA="-1^What visit?" QUIT
 ;
 N ICNST
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
 I +ICNST'=1 S RETSTA=ICNST QUIT
 N DHPICN S DHPICN=$P(ICNST,U,3)
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 S RETSTA=DHPICN
 ;
 D GETONE(.RETSTA,PATIEN,VRESID)
 ;
 QUIT
 ;
PATCPI(RETSTA,DHPICN,VRESID,RETJSON) ; Patient Care Plan(s) for ICN and Visit ID
 ;
 ; Return patient Care Plan for a given patient ICN and Visit ID
 ; This API will only return data for Synthea care plan patients
 ;
 ; Input:
 ;   DHPICN  - patient ICN (unique patient identifier across all VistA systems)
 ;   VRESID  - Visit resource ID, "_" piece 4 is the visit ien
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 = Return Care Plan string (default)
 ; Output:
 ;   RETSTA  - a delimited string ...
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
 ;         or care plan data in JSON format
 ;
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I $G(VRESID)="" S RETSTA="-1^What visit?" QUIT
 ;
 ; validate ICN
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
 ;
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 ;
 S RETSTA=DHPICN
 ;
 D GETONE(.RETSTA,PATIEN,VRESID)
 ;
 QUIT
 ;
GETONE(RETSTA,PATIEN,VRESID) ;get care plan(s) for a visit
 ;
 N P S P="|"
 N S S S="_"
 N D S D="-"
 ;
 N HLFACTS
 N VISIT S VISIT=$P(VRESID,D,4)
 N HFIEN S HFIEN=""
 F  S HFIEN=$O(^AUPNVHF("C",PATIEN,HFIEN)) QUIT:HFIEN=""  D
 . N HLFACT
 . D GET1HLF^SYNDHP15(.HLFACT,HFIEN,1,0)
 . I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",HFIEN)=HLFACT QUIT
 . ;I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT QUIT
 . QUIT:$E(HLFACT("HealthFactor","hlfName"),1,4)'="SYN "  ;skip if not synthea ingested
 . QUIT:VISIT'=HLFACT("HealthFactor","visitId")  ;skip if not for requested visit
 . S visitId=HLFACT("HealthFactor","visitId")
 . M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
 . . S RETSTA=RETSTA_U_HLFACT("HealthFactor","resourceId")_P_HLFACT("HealthFactor","hlfNameSCT")_P_HLFACT("HealthFactor","hlfName")_P
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","levelSeverity")_P_HLFACT("HealthFactor","encounterProvider")_P_HLFACT("HealthFactor","eventDateTimeHL7")_P
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","visitHL7")_P_HLFACT("HealthFactor","comments")
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("HLFACTS")
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.HLFACTS,.RETSTA)
 ;
 I $G(DEBUG) W ! W $$ZW^SYNDHPUTL("RETSTA")
 ;
 QUIT
 ;
 ; ----------- Unit Test -----------
T1 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATCPALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T2 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=20000101
 N TODAT S TODAT=20120101
 N JSON S JSON=""
 N RETSTA
 D PATCPALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T3 ;
 N ICN S ICN="1435855215V947437"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATCPALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T4 ;
 N ICN S ICN="2434609669V691690"
 N VRESID S VRESID="V-500-1000010-34494"
 N JSON S JSON=""
 N RETSTA
 D PATCPI(.RETSTA,ICN,VRESID,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T5 ;
 N ICN S ICN="2434609669V691690"
 N VRESID S VRESID="V-500-1000010-34494"
 N JSON S JSON="J"
 N RETSTA
 D PATCPI(.RETSTA,ICN,VRESID,JSON)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;

SYNDHP61
SYNDHP61 ; Write To VistA ;5/4/18  10:43
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of DXC Technology 2017-2018
 ;
 QUIT
 ;
 ; vitals update
VITUPD(RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPROV,DHPLOC) ; vitals update
 ;
 ; Input:
 ;  DHPPAT  - patient ICN           (mandatory)
 ;  DHPSCT  - SNOMED CT code        (mandatory)
 ;  DHPOBS  - Observation Value     (mandatory)
 ;  DHPUNT  - Observation units     (mandatory)
 ;  DHPDTM  - Observation Date/Time (mandatory) HL7 format
 ;  DHPROV  - provider              (mandatory) NPI#
 ;  DHPLOC  - location              (mandatory) name
 ; Output:
 ;  1 - success
 ; -1 - failure
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
 ; set up array of allowed SCT codes
 ;
 D VITSCT
 ;
 I '$D(SCTA(DHPSCT)) S RETSTA="-1^SNOMED CT code not recognised as vitals" Q
 ; build FDA and update vitals file (FN)
 D VITFDA
 D UPDATE^DIE(,"FDA",,"ZZERR")
 S RETSTA=$S($D(ZZERR):-1,1:1)
 Q
 ;
VITSCT ; set up recognised SCT codes for VITALS
 ; map incoming SNOMED CT code to VistA Vital Type (file FN1)
 S SCTA(27113001)="9^Body weight"
 S SCTA(50373000)="8^Body height"
 S SCTA(75367002)="1^Blood pressure"
 S SCTA(78564009)="5^Pulse rate"
 S SCTA(386725007)="2^Body Temperature"
 S SCTA(86290005)="3^Respiration"
 S SCTA(48094003)="10^Abdominal girth measurement"
 S SCTA(21727005)="11^Audiometry"
 S SCTA(252465000)="21^Pulse oximetry"
 S SCTA(22253000)="22^Pain"
 ; map incoming SNOMED CT code to VistA Vital Type (file FN1)
 S SCTX(9)="27113001^Body weight"
 S SCTX(8)="50373000^Body height"
 S SCTX(1)="75367002^Blood pressure"
 S SCTX(5)="78564009^Pulse rate"
 S SCTX(2)="386725007^Body Temperature"
 S SCTX(3)="86290005^Respiration"
 S SCTX(10)="48094003^Abdominal girth measurement"
 S SCTX(11)="21727005^Audiometry"
 S SCTX(21)="252465000^Pulse oximetry"
 S SCTX(22)="22253000^Pain"
 Q
 ;
VITFDA ; build FDA array for Vitals
 K FDA,ZZERR,ORIEN
 N PATIEN,PRVIEN,LOCIEN
 S FN=120.5
 ;S DHPLOC=$G(DHPLOC,10000000286)
 ;S DHPROV=$G(DHPROV,101)
 S DHPOBS=$$SI2IMP(DHPSCT,DHPOBS)
 S ORIEN(1)=$$NEXTIEN()
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""))
 S PRVIEN=0
 I $G(DHPROV)'="" S PRVIEN=$O(^VA(200,"ANPI",DHPROV,""))
 I 'PRVIEN S PRVIEN=$O(^XUSEC("PROVIDER",0))
 I 'PRVIEN S $EC=",U-SET-UP-A-BLOODY-PROVIDER,"
 S LOCIEN=$O(^SC("B",DHPLOC,""))
 ;
 S FDA(FN,"+1,",.01)=$$HL7TFM^XLFDT(DHPDTM) ;date/time vitals taken
 S FDA(FN,"+1,",.02)=PATIEN ;patient
 S FDA(FN,"+1,",.03)=+SCTA(DHPSCT) ;vital type
 S FDA(FN,"+1,",.04)=$$HL7TFM^XLFDT(DHPDTM) ;date/time vitals entered
 S FDA(FN,"+1,",.05)=DHPLOC ;hospital location
 S FDA(FN,"+1,",.06)=PRVIEN ;entered by
 S FDA(FN,"+1,",1.2)=DHPOBS ;rate
 Q
 ;
NEXTIEN() ;
 ; Get new code IEN
 Q $O(^GMR(FN,9E29),-1)+1
 ;
SI2IMP(SCT,OBS) ; convert metric units to imperial
 ;
 N UNITS
 S UNITS=$$UP^XLFSTR(DHPUNT)
 I SCT=27113001,UNITS="KG" Q $J(OBS*2.20462,0,1)  ; weight kg to lbs
 I SCT=50373000,UNITS="CM" Q $J(OBS*0.393701,0,0) ; height cm to inches
 I SCT=386725007,UNITS="CEL" Q $J(OBS/5*9+32,0,1) ; celsius to fahrenheit
 Q OBS
 ;
 ;
 ; -------- problem/condition update
 ;
PROBUPD(RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; problems update
 ;
 ; Alternate entry for creating problem/condition if snomed code does not map to icd code, so can't use DATA2PCE
 ; 
 ; Input:
 ;  DHPPAT -   patient ICN                (mandatory)
 ;  DHPSCT -   SNOMED CT code             (mandatory)
 ;  DHPSDES -  SNOMED CT designation code (optional)      >>>not used in code below, code (DHPSCDES) is looked up in Lexicon <<<
 ;  DHPROV -   Provider     (NPI)              (optional)
 ;  DHPDTM -   Observation Date/Time  (HL7)    (mandatory)
 ;  DHPRID -   DHP unique resource ID     (optional)
 ;               agency_facility
 ;
 ; Output:
 ;  1 - success
 ; -1 - failure
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
 ;
 ;I '$D(SCTA(DHPSCT)) S RETSTA="-1^SNOMED CT code not recognised as vitals" Q
 ; build FDA and update vitals file (FN)
 K LEX
 S LEX=$$CODE^LEXTRAN(DHPSCT,"SCT")
 I +LEX=-2 S RETSTA=LEX Q
 D PROBFDA
 D UPDATE^DIE(,"FDA",,"ZZERR")
 ;W ! ZW ZZERR
 S RETSTA=$S($D(ZZERR):-1,1:1)
 Q
 ;
 ;
PROBFDA ; build FDA array for Problems
 ;
 K FDA,ZZERR,ORIEN
 S P="|"
 S FN=9000011
 ;S DHPOBS=$$UNCNVT(DHPSCT,DHPOBS)
 S ORIEN(1)=$$NEXTIEN()
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""))
 S MAPVUID=5217693 ; VUID for SNOMED CT to ICD-10-CM mapping
 K LEX
 S DHPICD=$$GETASSN^LEXTRAN1(DHPSCT,MAPVUID)
 S DHPICD=$O(LEX(1,""))
 I DHPICD="" S DHPICD="R69."
 S DHPICD=+$$ICDDX^ICDEX(DHPICD,30)
 S FDA(FN,"+1,",.01)=DHPICD ;diagnosis
 S FDA(FN,"+1,",.02)=PATIEN ;patient name
 S FDA(FN,"+1,",.03)=$$NOW^XLFDT() ;date last modified
 S FDA(FN,"+1,",.04)="P" ; or "F" personal history/family history
 ;
 S DHPLOC=+DHPRID
 S FDA(FN,"+1,",.06)=DHPLOC ; location
 S FDA(FN,"+1,",1.07)=$$HL7TFM^XLFDT(DHPDTM) ;date resolved <<<<<<<<<<<<< not if still active
 S FDA(FN,"+1,",.08)=$$NOW^XLFDT() ;date entered
 S FDA(FN,"+1,",.13)=$$HL7TFM^XLFDT(DHPDTM) ;date of onset
 S STATII=P_"A"_P_"I"_P
 S FDA(FN,"+1,",.12)=$S(STATII[(P_$G(DHPSTA)_P):DHPSTA,1:"A") ;status
 S FDA(FN,"+1,",80001)=DHPSCT ; snomed ct concept code
 ;
 N LEX
 S LEX=$$CODE^LEXTRAN(DHPSCT,"SCT",,,,1,1)
 S DHPSCDES=$P($G(LEX("P")),U,3)
 S LEXIEN=$P(LEX("P"),U,2)
 S EXPRSN=$P(LEX("P"),U)
 S PROVNAR=$$PROVNARTL(EXPRSN)
 S FDA(FN,"+1,",.05)=PROVNAR ;provider narrative
 S FDA(FN,"+1,",1.01)=LEXIEN ;problem
 S FDA(FN,"+1,",80002)=DHPSCDES ;snomed ct designation code
 S FDA(FN,"+1,",80201)=$$HL7TFM^XLFDT(DHPDTM) ;date of interest
 S FDA(FN,"+1,",80202)="10D" ;coding system
 S NUM=$O(^AUPNPROB("AA",PATIEN,DHPLOC,""),-1) ;get last NMBR used
 S NUM=+$RE(+$RE(NUM))
 S NUM=NUM+1
 S FDA(FN,"+1,",.07)=NUM ;nmbr
 S PRVIEN="" I DHPROV'="" S PRVIEN=$O(^VA(200,"ANPI",DHPROV,""))
 S FDA(FN,"+1,",1.03)=PRVIEN ;entered by
 S FDA(FN,"+1,",1.04)=PRVIEN ;recording provider
 S FDA(FN,"+1,",1.05)=PRVIEN ;responsible provider
 ;W ! ZW FDA
 Q
PROVNARTL(EXPRSN) ; deal with provider narrative
 ;
 N PROVNAR
 I '$D(^AUTNPOV("B",EXPRSN)) D PROVNADD(EXPRSN)
 S PROVNAR=$O(^AUTNPOV("B",EXPRSN,""))
 Q PROVNAR
 ;
PROVNADD(EXPRSN) ;
 N PNIEN
 S PNIEN=$O(^AUTNPOV(99999999999),-1)+1
 S ^AUTNPOV(PNIEN,0)=EXPRSN
 S ^AUTNPOV("B",EXPRSN,PNIEN)=""
 Q
 ;
 ; -------- Immunization update
 ;
IMMUNUPD(RETSTA,DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV) ;Immunization update
 ;
 ; Input:
 ;  DHPPAT  - patient ICN  (mandatory)
 ;  VISIT   - visit ien    (mandatory)
 ;  IMMUNIZ - cvx code     (mandatory)
 ;  ANATLOC - anatomical location
 ;  ADMINRT - route of administration
 ;  DOSE    - dose
 ;  EVENTDT - event date/time (HL7 format)
 ;  IMMPROV - immunization provider (NPI)
 ;
 ; Output:   RETSTA
 ;  1 - success
 ; -1 - failure -1^message
 ;
 N IMMIEN
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" QUIT
 ;
 I $G(IMMUNIZ)="" S RETSTA="-1^Immunization (CVX code) is required" QUIT
 S IMMIEN=$O(^AUTTIMM("C",IMMUNIZ,""))
 I IMMIEN="" S RETSTA="-1^Immunization (CVX code) not found" QUIT
 I +$$GET1^DIQ(9999999.14,IMMIEN_",",.07,"I") S RETSTA="-1^Immunization is inactive" QUIT
 ;
 I $G(VISIT)="" S RETSTA="-1^Visit IEN is required" QUIT
 I '$D(^AUPNVSIT(VISIT)) S RETSTA="-1^Visit not found" QUIT
 ;
 N PACKAGE,SOURCE,USER,ERRDISP,ZZERR,PPEDIT,ZZERDESC,ACCOUNT
 N IMMDATA,IMMPRVIEN,PPEDIT
 ;
 S RETSTA=1
 D SETUP
 QUIT:RETSTA=-1
 ;
 S RETSTA=$$DATA2PCE^PXAI("IMMDATA",PACKAGE,SOURCE,.VISIT,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
 ;I $D(ZZERR) ZW ZZERR
 I $D(ZZERDESC) M RETSTA("ZZERDESC")=ZZERDESC
 I $D(ZZERR) M RETSTA("ZZERR")=ZZERR
 M RESTSTA("IMMDATA")=IMMDATA
 QUIT
 ;
 ; $$DATA2PCE Output:
 ;+   1  if no errors and processed completely
 ;+  -1  if errors occurred but processed completely as possible
 ;+  -2  if could not get a visit
 ;+  -3  if called incorrectly
 ;
SETUP ; set data for $$DATA2PCE call
 ;
 S PACKAGE=507 ;PCE PATIENT CARE ENCOUNTER
 S SOURCE="DHP DATA INGEST"
 S USER=$$DUZ^SYNDHP69
 N EVDATFM
 S EVDATFM=$$HL7TFM^XLFDT(EVENTDT)
 S ERRDISP=1 ;for testing only, set to null otherwise  <<<<<<<<<<<<<<<<<<<<<<<
 S PPEDIT=""
 S ACCOUNT=""
 ;
 S IMMDATA("IMMUNIZATION",1,"IMMUN")=IMMIEN
 ;don't send null data values to create records
 ; There are extra data elements here for possible future use
 I $G(IMMPROV)'="" D
 . S IMMPRVIEN=$O(^VA(200,"ANPI",IMMPROV,""))
 . QUIT:IMMPRVIEN=""
 . S IMMDATA("IMMUNIZATION",1,"ENC PROVIDER")=IMMPRVIEN
 S:$G(EVENTDT)'="" IMMDATA("IMMUNIZATION",1,"EVENT D/T")=EVDATFM
 S:$G(SERIES)'="" IMMDATA("IMMUNIZATION",1,"SERIES")=SERIES
 S:$G(REACTION)'="" IMMDATA("IMMUNIZATION",1,"REACTION")=REACTION
 S:$G(CONTRA)'="" IMMDATA("IMMUNIZATION",1,"CONTRAINDICATED")=CONTRA
 S:$G(DXCODE)'="" IMMDATA("IMMUNIZATION",1,"DIAGNOSIS")=DXCODE
 S:$G(COMMENT)'="" IMMDATA("IMMUNIZATION",1,"COMMENT")=COMMENT
 S:$G(LOTNUM)'="" IMMDATA("IMMUNIZATION",1,"LOT NUM")=LOTNUM
 S:$G(INFOSRC)'="" IMMDATA("IMMUNIZATION",1,"INFO SOURCE")=INFOSRC
 S:$G(ADMINRT)'="" IMMDATA("IMMUNIZATION",1,"ADMIN ROUTE")=ADMINRT
 S:$G(ANATLOC)'="" IMMDATA("IMMUNIZATION",1,"ANATOMIC LOC")=ANATLOC
 S:$G(DOSE)'="" IMMDATA("IMMUNIZATION",1,"DOSE")=DOSE
 S:$G(DOSEUNIT)'="" IMMDATA("IMMUNIZATION",1,"DOSE UNITS")=DOSEUNIT
 N SERCAT
 S SERCAT=$S(EVDATFM\1<$$DT^XLFDT:"E",1:"A")
 S IMMDATA("IMMUNIZATION",1,"SERVICE CATEGORY")=SERCAT ; A for current E for historical
 QUIT
 ;
 ; -------- Encounter update
 ;
ENCTUPD(RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT) ;Encounter update
 ;return visit id/ien
 ;
 S U="^"
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" QUIT
 ;
 I $G(ENCPROV)'="" D
 .S ENCPRVIEN=$O(^VA(200,"ANPI",ENCPROV,""))
 .I 'ENCPRVIEN S ENCPRVIEN=$O(^XUSEC("PROVIDER",0))
 .I 'ENCPRVIEN S $EC=",U-SET-UP-A-BLOODY-PROVIDER,"
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""),-1)
 S SOURCE="DHP DATA INGEST"
 S PACKAGE=$$FIND1^DIC(9.4,,"","PCE")
 S LOCATION=$O(^SC("B",CLINIC,""))
 S USER=$$DUZ^SYNDHP69
 ;
 ;chop off seconds
 N APPTDATE
 S APPTDATE=$$HL7TFM^XLFDT(STARTDT)
 S APPTTM=$E($P(APPTDATE,".",2),1,4)
 S $P(APPTDATE,".",2)=APPTTM
 ;
 ; map SNOMED CT code in SCTDX to ICD-10
 S MAPVUID=5217693 ; VUID for SNOMED CT to ICD-10-CM mapping
 ;K LEX
 ;S DHPICD=$$GETASSN^LEXTRAN1(SCTDX,MAPVUID)
 ;S DHPICD=$O(LEX(1,""))
 ;I DHPICD="" S DHPICD="R69."
 ;S DHPICD=+$$ICDDX^ICDEX(DHPICD,30)
 I $G(SCTDX)'="" D  ;
 .S MAPPING=$S(APPTDATE>3150930:"sct2icd",1:"sct2icdnine") ; APPTDATE IS IN FM FORMAT
 .S DHPICD=$$MAP^SYNDHPMP(MAPPING,SCTDX)
 .I +DHPICD=-1 S RETSTA="-1^SNOMED CT CODE "_SCTDX_" not mapped" Q
 .;S DHPICD=+$$ICDDX^ICDEX($P(DHPICD,U,2),30)
 .I +DHPICD'=-1 S DHPICD=+$$ICDDX^ICDEX($P(DHPICD,U,2),30)
 ;
 ; map SNOMED CT code in SCTCPT to CPT
 ;S DHPCPT=$S($$MAP^SYNQLDM(SCTCPT)'="":$$MAP^SYNQLDM(SCTCPT),1:92002)
 S DHPCPT=$$MAP^SYNQLDM(SCTCPT)
 I DHPCPT'="" D
 .I '$D(^ICPT("B",DHPCPT)) S DHPCPT=""
 I DHPCPT="" D
 .S DHPCPT=$$MAP^SYNDHPMP("sct2os5",SCTCPT)
 .I +DHPCPT=-1 S DHPCPT="" Q
 .S DHPCPT=$P(DHPCPT,U,2)
 ;
 I DHPCPT="" S RETSTA="-1^SNOMED CT CODE "_SCTCPT_" not mapped" Q
 ; create root array
 K ENCDATA
 S ENCDATA("ENCOUNTER",1,"PATIENT")=PATIEN
 S ENCDATA("ENCOUNTER",1,"ENCOUNTER TYPE")="P"
 S ENCDATA("ENCOUNTER",1,"ENC D/T")=APPTDATE
 S ENCDATA("ENCOUNTER",1,"HOS LOC")=LOCATION
 N SERCAT
 S SERCAT=$S(APPTDATE\1<$$DT^XLFDT:"E",1:"A")
 S SERCAT="A"
 S ENCDATA("ENCOUNTER",1,"SERVICE CATEGORY")=SERCAT ; A for current E for historical
 S ENCDATA("PROVIDER",1,"NAME")=ENCPRVIEN
 S ENCDATA("PROVIDER",1,"PRIMARY")=1
 ; gpl 100%
 I +$G(DHPICD)=-1 D  ; no mapping was found
 . I $G(SCTDX)="" Q  ; no code passed in
 . S ENCDATA("STD CODES",1,"CODE")=SCTDX
 . S ENCDATA("STD CODES",1,"CODING SYSTEM")="SCT"
 . S ENCDATA("STD CODES",1,"EVENT D/T")=APPTDATE
 . S ENCDATA("STD CODES",1,"COMMENT")="Purpose of Visit - POV."
 . S ENCDATA("STD CODES",1,"ENC PROVIDER")=ENCPRVIEN
 . ; health factor for CPRS display (v 30,31)
 . N HFIEN
 . S HFIEN=$O(^AUTTHF("B","SYN SNOMED PURPOSE OF VISIT",""))
 . I HFIEN'="" D  ; Health factor exists
 . . S ENCDATA("HEALTH FACTOR",1,"HEALTH FACTOR")=HFIEN
 . . S ENCDATA("HEALTH FACTOR",1,"EVENT D/T")=APPTDATE
 . . S ENCDATA("HEALTH FACTOR",1,"COMMENT")=SCTDX
 E  D  ; mapping was found
 . I $G(SCTDX)'="" S ENCDATA("DX/PL",1,"DIAGNOSIS")=DHPICD
 . I $G(SCTDX)'="" S ENCDATA("DX/PL",1,"ENC PROVIDER")=ENCPRVIEN
 . I $G(SCTDX)'="" S ENCDATA("DX/PL",1,"PRIMARY")=1
 S ENCDATA("PROCEDURE",1,"PROCEDURE")=DHPCPT
 S ENCDATA("PROCEDURE",1,"QTY")=1
 I $G(SCTDX)'="" I +DHPICD'=-1 S ENCDATA("PROCEDURE",1,"DIAGNOSIS")=DHPICD
 ;
 K ZZERR,ZZERDESC,VISIT
 S RETSTA=$$DATA2PCE^PXAI("ENCDATA",PACKAGE,SOURCE,.VISIT,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
 S RETSTA=RETSTA_"^"_$G(VISIT)
 I $D(ZZERDESC) M RETSTA("ZZERDESC")=ZZERDESC
 I $D(ZZERR) M RETSTA("ZZERR")=ZZERR
 M RETSTA("ENCDATA")=ENCDATA
 ;
 ;change APPTDATE back to HL7 format for these next calls
 S APPTDATE=$$FMTHL7^XLFDT(APPTDATE)
 ;create appointment
 N DHPLEN
 S DHPLEN=""
 D APPTADD^SYNDHP62(.RETSTA,DHPPAT,CLINIC,APPTDATE,DHPLEN)
 QUIT:$G(RETSTA("APPT"))'=1
 ;
 ;check-in appointment
 N DHPCIDT
 S DHPCIDT=""
 D APPTCKIN^SYNDHP62(.RETSTA,DHPPAT,CLINIC,APPTDATE,DHPCIDT)
 QUIT:$G(RETSTA("CKIN"))'=1
 ;
 ;check-out appointment
 N DHPCODT
 S DHPCODT=""
 D APTCKOUT^SYNDHP62(.RETSTA,DHPPAT,CLINIC,APPTDATE,DHPCODT)
 ;
 QUIT
 ;
 ; -------------------------------------------------------------------------
 ;;
TEST ;
T1 D PROBUPD(.ZXC,"5482156687V807096",267036007,158482014,9990006675,20180118,"5OO_EXT")
 Q
T2 D ENCTUPD(.ZXC,"5482156687V807096",20161227154556,20161227161234,"9990000348","GENERAL MEDICINE",73211009,10492003)
 Q
T3 S IDT=20170115154546
 F SDT=IDT:1E8:(IDT+9E8) S EDT=SDT+2E8 D
 .;K VISIT
 .K ZXC
 .D ENCTUPD(.ZXC,"9004935583V839304",SDT,EDT,"9990000348","GENERAL MEDICINE",73211009,10492003)
 .W !!,"___________________________________________________",!!
 .;ZW ZXC
 .W !!
 .;ZW ENCDATA
 .W !!,"___________________________________________________",!!
 .;ZW ZZERDESC
 .W !!,"___________________________________________________",!!
 .;ZW ZZERR
 Q

SYNDHP62
SYNDHP62 ;DHP/ART -  Write Problems, Appointments To VistA ;05/29/2018
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of DXC Technology 2017-2018
 ;
 QUIT
 ;
 ; -------- Problem/Condition update
 ;
PRBUPDT(RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT) ;Problem/Condition update
 ;
 ; Input:
 ;   DHPPAT   - Patient ICN
 ;   DHPVST   - Visit ID
 ;   DHPROV   - Provider ID (NPI)
 ;   DHPONS   - Onset Date (HL7 format)
 ;   DHPABT   - Abatement Date (HL7 format)
 ;   DHPCLNST - Clinical Status ?   (A or I)
 ;   DHPSCT   - SNOMED CT code
 ;
 ; Output:   RETSTA
 ;  1 - success
 ; -1 - failure -1^message
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
 ;
 I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
 I $G(DHPONS)="" S RETSTA="-1^onset date is required" Q
 I '$D(^AUPNVSIT(DHPVST)) S RETSTA="-1^Visit not found" Q
 ;
 N PACKAGE,SOURCE,USER,ERRDISP,ZZERR,PPEDIT,ZZERDESC,ACCOUNT
 N PROBDATA,PRBPRIEN,STATII,MAPVUID,P,DHPICD,DHPCS,MAPPING
 ;
 S PACKAGE=$$FIND1^DIC(9.4,,"","PCE")
 S SOURCE="DHP DATA INGEST"
 S USER=$$DUZ^SYNDHP69
 S ERRDISP=""
 I $G(DEBUG)=1 S ERRDISP=1
 S PPEDIT=""
 S ACCOUNT=""
 S P="|"
 ;
 S RETSTA=1
 ;
 S PROBDATA("DX/PL",1,"PL ADD")=1
 S DHPONS=$P($$HL7TFM^XLFDT(DHPONS),".",1)
 ;20130526110511-0400
 ;date portion only, active problems can not have a date resolved
 S PROBDATA("DX/PL",1,"PL ONSET DATE")=DHPONS
 S:$G(DHPABT)'="" PROBDATA("DX/PL",1,"PL RESOLVED DATE")=$P($$HL7TFM^XLFDT(DHPABT),".",1)
 ;
 ;S MAPVUID=5217693 ; VUID for SNOMED CT to ICD-10-CM mapping
 ;K LEX
 ;S DHPICD=$$GETASSN^LEXTRAN1(DHPSCT,MAPVUID)
 ;S DHPICD=$O(LEX(1,""))
 ;I DHPICD="" S DHPICD="R69."
 ;S DHPICD=+$$ICDDX^ICDEX(DHPICD,30) ;30=ICD-10
 ;S PROBDATA("DX/PL",1,"DIAGNOSIS")=DHPICD
 ;S PROBDATA("DX/PL",1,"DIAGNOSIS")=DHPSCT
 ;
 ; next line determines whether to use ICD10 or ICD9 map
 S MAPPING=$S(DHPONS>3150930:"sct2icd",1:"sct2icdnine")
 ;
 ;W !!,">>>> DHPONS ",DHPONS
 ;W !,">>>> MAPPING ",MAPPING,!!
 ;
 ;
 S DHPICD=$$MAP^SYNDHPMP(MAPPING,DHPSCT)
 I +DHPICD=-1 S RETSTA="-1^SNOMED CT CODE "_DHPSCT_" not mapped" Q
 S DHPCS=$S(DHPONS>3150930:30,1:1)
 S DHPICD=$P(DHPICD,U,2) ; DHPICD now contains ICD code from mapping return
 N ICDTX
 S ICDTX=$$ICDDX^ICDEX(DHPICD,DHPCS)
 ;
 S DHPICD=+ICDTX ; DHPICD now contains ICD code IEN
 I +DHPICD=-1 S RETSTA="-1^ICD Code "_DHPICD_" not on file" Q
 S DHPDXNR=$P(ICDTX,U,4)
 S PROBDATA("DX/PL",1,"DIAGNOSIS")=DHPICD
 S PROBDATA("DX/PL",1,"NARRATIVE")=DHPDXNR
 N SERCAT
 S SERCAT="A" ; $S(DHPONS\1<$$DT^XLFDT:"E",1:"A")
 S PROBDATA("DX/PL",1,"SERVICE CATEGORY")=SERCAT ; A for current E for historical
 S DHPDXF=$$PRMDX(DHPVST,DHPICD)
 I DHPDXF=-1 S RETSTA="-1^Problem with DX code "_DHPICD_" already exists for visit "_DHPVST Q
 S PROBDATA("DX/PL",1,"PRIMARY")=DHPDXF
 ;
 I $G(DHPROV)'="" D
 . S PRBPRIEN=$O(^VA(200,"ANPI",DHPROV,""))
 . QUIT:PRBPRIEN=""
 . S PROBDATA("DX/PL",1,"ENC PROVIDER")=PRBPRIEN
 ;
 S STATII=P_"A"_P_"I"_P
 S:$G(DHPCLNST)'="" PROBDATA("DX/PL",1,"PL ACTIVE")=$S(STATII[(P_$G(DHPCLNST)_P):DHPCLNST,1:"A")
 ;
 S RETSTA=$$DATA2PCE^PXAI("PROBDATA",PACKAGE,SOURCE,.DHPVST,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
 ;I $D(ZZERR) ZWRITE ZZERR
 S RETSTA=RETSTA_"^"_$G(DHPVST)
 I $D(ZZERDESC) M RETSTA("ZZERDESC")=ZZERDESC
 I $D(ZZERR) M RETSTA("ZZERR")=ZZERR
 M RETSTA("PROBDATA")=PROBDATA
 ;
 ; $$DATA2PCE Output:
 ;+   1  if no errors and processed completely
 ;+  -1  if errors occurred but processed completely as possible
 ;+  -2  if could not get a visit
 ;+  -3  if called incorrectly
 QUIT
 ;
PRMDX(X,D) ; Check if primary diagnosis
 ; Input:
 ;   X - visit IEN
 ;   D - DX code IEN
 ; Output
 ;   1 if code D can be filed as primary DX
 ;   0 if code D can be filed as secondary DX
 ;  -1 if there is already a problem with DX code D files for the visit
 ;
 N IND,PRMDX,DIAG
 S IND=0
 F  S IND=$O(^AUPNVPOV("AD",X,IND)) Q:IND=""  D
 .I $P(^AUPNVPOV(IND,0),U,12)="P" D
 ..S DIAG=$P(^AUPNVPOV(IND,0),U,1)
 ..S PRMDX(DIAG)=""
 I '$D(PRMDX) Q 1  ; D is the primary DX
 I '$D(PRMDX(D)) Q 0  ; D is a secondary DX
 Q -1  ; problem with DX D already exists for visit
 ;
 ; -------- Appointment create
 ;
APPTADD(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN) ;Create appointment
 ;
 ;     - past appointments are created as Walk-in, NSC, Regular appointments
 ;     - future appointments are created as NSC, Regular appointments
 ;
 ; Input:
 ;   DHPPAT   - Patient ICN (required)
 ;   DHPCLIN  - Clinic Name (required)
 ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
 ;   DHPLEN   - Appointment length as minutes (optional, defaults to 15 mins.)
 ;
 ; Output:   RETSTA("APPT")
 ;  1 - success
 ; -1 - failure -1^message
 ;
 N PATDFN,APPTDT,APPTLEN,CHKINDT,CHKOUTDT,COFLG,CLINIEN,INACTDT,REACTDT
 N Y,EXDATE,BADDATE,RESULT,MSG
 ;
 I $G(DHPPAT)="" S RETSTA("APPT")="-1^Missing patient identifier (#2)." QUIT
 I $G(DHPCLIN)="" S RETSTA("APPT")="-1^Missing appt. location (#44)." QUIT
 I $G(DHPAPTDT)="" S RETSTA("APPT")="-1^Missing date/time for appt." QUIT
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA("APPT")="-1^Patient not recognised" QUIT
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
 ;
 ; -- Check appointment date/time --
 S APPTDT=$$HL7TFM^XLFDT(DHPAPTDT)
 I $P(APPTDT,".",2)="" S RETSTA("APPT")="-1^Missing time for appt." QUIT
 ;convert to external and check date/time against Fileman date/time field
 S Y=APPTDT
 D DD^%DT
 S EXDATE=Y ;Convert to external
 D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
 I RESULT="^" S RETSTA("APPT")="-1^Invalid appt date/time." QUIT
 ;
 S USER=$$DUZ^SYNDHP69
 ;
 S:$G(DHPLEN)="" APPTLEN=15 ;default appointment length
 ;
 ; -- Check Clinic --
 S CLINIEN=$O(^SC("B",DHPCLIN,""))
 I CLINIEN="" S RETSTA("APPT")="-1^Invalid clinic name (#44)." QUIT
 S INACTDT=$$GET1^DIQ(44,CLINIEN_",",2505,"I") ;inactivate date
 S REACTDT=$$GET1^DIQ(44,CLINIEN_",",2506,"I") ;reactivate date
 I INACTDT'="",REACTDT="",INACTDT<APPTDT S RETSTA("APPT")="-1^Clinic inactive on appt. date (#44)." QUIT
 I REACTDT'="",REACTDT>INACTDT,REACTDT>APPTDT S RETSTA("APPT")="-1^Clinic inactive on appt. date (#44)." QUIT
 I REACTDT'="",REACTDT<INACTDT,INACTDT<APPTDT S RETSTA("APPT")="-1^Clinic inactive on appt. date (#44)." QUIT
 ;
 ; -- Check for Clinic stop code --
 I $$GET1^DIQ(44,CLINIEN_",",8)="" D  QUIT
 . S RETSTA("APPT")="-1^Clinic missing STOP CODE NUMBER (#44,8)."
 ;
 I $G(DEBUG)=1 D
 . W "Create Appointment  APPTADD^SYNDHP62",!
 . W "ICN: ",DHPPAT,"   DFN: ",PATDFN,!
 . W "CLINIC: ",DHPCLIN,"   IEN: ",CLINIEN,!
 . W "APPT D/T: ",DHPAPTDT,"   ",APPTDT,!
 ;
 I $D(^DPT(PATDFN,"S",APPTDT,0)),$P($G(^DPT(PATDFN,"S",APPTDT,0)),U,2)'="C" D  QUIT
 . S RETSTA("APPT")="-1^Duplicate Appointment"
 ;
 ; -- create patient appointment --
 N FDA,ERRMSG,IENS,IENROOT
 S IENS="+1,"_PATDFN_","
 S FDA(2.98,IENS,.001)=APPTDT ;appointment date/time
 S FDA(2.98,IENS,.01)=CLINIEN ;clinic
 S FDA(2.98,IENS,3)="" ;status
 S FDA(2.98,IENS,9.5)=9 ;appointment type (9=regular)
 S FDA(2.98,IENS,19)=DUZ ;data entry clerk
 S FDA(2.98,IENS,20)=DT ;date appointment made
 S FDA(2.98,IENS,21)="" ;pointer to Encounter record (409.68)
 I APPTDT<$$NOW^XLFDT() D
 . S FDA(2.98,IENS,9)=4 ;purpose of visit (4=unscheduled visit)
 . S FDA(2.98,IENS,25)="W" ;sched request type (W=walk-in)
 . S FDA(2.98,IENS,26)=0 ;next available appt indicator
 E  D
 . S FDA(2.98,IENS,9)=3 ;purpose of visit (3=scheduled visit)
 . S FDA(2.98,IENS,25)="N" ;sched request type (N=next available)
 . S FDA(2.98,IENS,26)=1 ;next available appt indicator
 . S FDA(2.98,IENS,27)=$P(APPTDT,".",1) ;desired date of appointment
 . S FDA(2.98,IENS,28)=0 ;follow-up visit (0=no)
 D UPDATE^DIE("","FDA","IENROOT","ERRMSG")
 I $D(ERRMSG) D  QUIT
 . S RETSTA("APPT")="-1^Problem saving patient appointment info (#2.98) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 ;
 ; -- create clinic appointment --
 N FDA,IENS,ERRMSG,ERROR
 S IENS="+2,"_CLINIEN_","
 S IENS(2)=+APPTDT
 S ERROR=0
 I '$D(^SC(CLINIEN,"S",APPTDT,0)) D
 . S FDA(44.001,IENS,.01)=+APPTDT ;appointment date/time
 . D UPDATE^DIE("","FDA","IENS","ERRMSG")
 . I $D(ERRMSG) D  QUIT
 . . S RETSTA("APPT")="-1^Problem saving clinic appointment date (#44.001) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 . . S ERROR=1
 ;ZWRITE IENS
 QUIT:ERROR
 S APPTDT=$G(IENS(2))
 N FDA,IENS,ERRMSG
 S IENS="?+1,"_+APPTDT_","_CLINIEN_","
 S FDA(44.003,IENS,.01)=PATDFN ;patient dfn
 S FDA(44.003,IENS,1)=APPTLEN ;appointment length
 S FDA(44.003,IENS,7)=DUZ ;data entry clerk
 S FDA(44.003,IENS,8)=$P($$NOW^XLFDT,".",1) ;date appointment made
 D UPDATE^DIE("","FDA","IENS","ERRMSG")
 ;ZWRITE IENS
 I $D(ERRMSG) D  QUIT
 . S RETSTA("APPT")="-1^Problem saving clinic appointment (#44.003) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 ;
 S RETSTA("APPT")=1
 ;
 QUIT
 ;
 ; -------- Appointment check-in
 ;
APPTCKIN(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPCIDT) ;Check-in appointment
 ;
 ; Input:
 ;   DHPPAT   - Patient ICN (required)
 ;   DHPCLIN  - Clinic Name (required)
 ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
 ;   DHPCIDT  - Check-in Date & Time (optional, will default to appointment date/time)
 ;
 ; Output:   RETSTA("CKIN")
 ;  1 - success
 ; -1 - failure -1^message
 ;
 N Y,PATDFN,APPTDT,CHKINDT,CLINIEN,EXDATE,BADDATE,RESULT,MSG,HIT,CLAPTIEN,ELIGCODE
 ;
 I $G(DHPPAT)="" S RETSTA("CKIN")="-1^Missing patient identifier (#2)." QUIT
 I $G(DHPCLIN)="" S RETSTA("CKIN")="-1^Missing appt. location (#44)." QUIT
 I $G(DHPAPTDT)="" S RETSTA("CKIN")="-1^Missing date/time for appt." QUIT
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA("CKIN")="-1^Patient not recognised" QUIT
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
 ;
 ; -- Check Clinic --
 S CLINIEN=$O(^SC("B",DHPCLIN,""))
 I CLINIEN="" S RETSTA("CKIN")="-1^Invalid clinic name (#44)." QUIT
 ;
 ; -- Check appointment date/time --
 S APPTDT=$$HL7TFM^XLFDT(DHPAPTDT)
 I $P(APPTDT,".",2)="" S RETSTA("CKIN")="-1^Missing time for appt." QUIT
 ;convert to external and check date/time against Fileman date/time field
 S Y=APPTDT
 D DD^%DT
 S EXDATE=Y ;Convert to external
 D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
 I RESULT="^" S RETSTA("CKIN")="-1^Invalid appt date/time." QUIT
 ;
 ; -- Check check-in date/time --
 N RESULT,MSG
 S BADDATE=0
 I $G(DHPCIDT)="" D
 . S CHKINDT=APPTDT
 E  D
 . S CHKINDT=$$HL7TFM^XLFDT(DHPCIDT)
 . I $P(CHKINDT,".",2)="" S RETSTA("CKIN")="-1^Missing time for check-in.",BADDATE=1 QUIT
 . ;convert to external and check date/time against Fileman date/time field
 . S Y=CHKINDT
 . D DD^%DT
 . S EXDATE=Y
 . D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
 . I RESULT="^" S RETSTA("CKIN")="-1^Invalid check-in date/time.",BADDATE=1 QUIT
 QUIT:BADDATE
 ;
 ;check that there are both patient and clinic appointment records
 I '$D(^DPT(PATDFN,"S",APPTDT,0)) D  QUIT
 . S RETSTA("CKIN")="-1^Patient Appointment record was not found"
 ;
 S HIT=0
 S CLAPTIEN=0
 F  S CLAPTIEN=$O(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN)) QUIT:CLAPTIEN=""  D  QUIT:HIT
 . S:$P(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN,0),U,1)=PATDFN HIT=1
 I 'HIT D  QUIT
 . S RETSTA("CKIN")="-1^Clinic Appointment record was not found"
 ;
 I $G(DEBUG)=1 D
 . W "Appointment Check-in  APPTCKIN^SYNDHP62",!
 . W "ICN:             ",DHPPAT,"   DFN: ",PATDFN,!
 . W "CLINIC:          ",DHPCLIN,"   IEN: ",CLINIEN,!
 . W "CLINIC,APPT,IEN: ",CLAPTIEN,!
 . W "APPT D/T:        ",DHPAPTDT,"   ",APPTDT,!
 . W "CHK-IN D/T:      ",DHPCIDT,"   ",CHKINDT,!
 ;
 ; -- appointment check-in updates --
 ;
 ; clinic appointment record
 ;  30 - eligibility of visit 0;10
 ;      10 = NSC
 ;      11 = NSC, VA PENSION
 ;      15 = SC LESS THAN 50%
 ;      16 = SERVICE CONNECTED 50% to 100%
 ;  309 - checked-in (date) C;1
 ;  302 - check in user C;2 P200
 ;  305 - check in entered (date) C;5
 ;
 S ELIGCODE=$$GET1^DIQ(2,DHPPAT_",",.361,"I")
 S:ELIGCODE="" ELIGCODE=10
 N IENS,FDA,ERRMSG
 S IENS=CLAPTIEN_","_APPTDT_","_CLINIEN_","
 S FDA(44.003,IENS,30)=ELIGCODE ;eligibility of visit
 S FDA(44.003,IENS,309)=CHKINDT ;checked-in (date)
 S FDA(44.003,IENS,302)=DUZ ;check in user
 S FDA(44.003,IENS,305)=CHKINDT ;check in entered (date)
 D FILE^DIE("K","FDA","ERRMSG")
 I $D(ERRMSG) D  QUIT
 . S RETSTA("CKIN")="-1^Problem updating clinic appointment check-in info (#44.003) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 ;
 S RETSTA("CKIN")=1
 ;
 QUIT
 ;
 ; -------- Appointment check-out
 ;
APTCKOUT(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPCODT) ;Check-out appointment
 ;>>>>>> This API currently will ONLY work for synthetic data ingest <<<<<<<
 ;>>>>>>  where Outpatient Encounters and Visits are created first   <<<<<<<
 ; Input:
 ;   DHPPAT   - Patient ICN (required)
 ;   DHPCLIN  - Clinic Name (required)
 ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
 ;   DHPCODT  - Check-out Date & Time (optional, will default to check-in date/time + 30 minutes)
 ;
 ; Output:   RETSTA("CKOUT")
 ;  1 - success
 ; -1 - failure -1^message
 ;
 N Y,PATDFN,APPTDT,CHKINDT,CHKOUTDT,CLINIEN,EXDATE,BADDATE,RESULT,MSG,HIT,CLAPTIEN,IENS
 ;
 I $G(DHPPAT)="" S RETSTA("CKOUT")="-1^Missing patient identifier (#2)." QUIT
 I $G(DHPCLIN)="" S RETSTA("CKOUT")="-1^Missing appt. location (#44)." QUIT
 I $G(DHPAPTDT)="" S RETSTA("CKOUT")="-1^Missing date/time for appt." QUIT
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA("CKOUT")="-1^Patient not recognised" QUIT
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
 ;
 ; -- Check Clinic --
 S CLINIEN=$O(^SC("B",DHPCLIN,""))
 I CLINIEN="" S RETSTA("CKOUT")="-1^Invalid clinic name (#44)." QUIT
 ;
 ; -- Check appointment date/time --
 S APPTDT=$$HL7TFM^XLFDT(DHPAPTDT)
 I $P(APPTDT,".",2)="" S RETSTA("CKOUT")="-1^Missing time for appt." QUIT
 ;convert to external and check date/time against Fileman date/time field
 S Y=APPTDT
 D DD^%DT
 S EXDATE=Y ;Convert to external
 D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
 I RESULT="^" S RETSTA("CKOUT")="-1^Invalid appt date/time." QUIT
 ;
 ;check that there are both patient and clinic appointment records
 I '$D(^DPT(PATDFN,"S",APPTDT,0)) D  QUIT
 . S RETSTA("CKOUT")="-1^Patient Appointment record was not found"
 ;
 S HIT=0
 S CLAPTIEN=0
 F  S CLAPTIEN=$O(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN)) QUIT:CLAPTIEN=""  D  QUIT:HIT
 . S:$P(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN,0),U,1)=PATDFN HIT=1
 I 'HIT D  QUIT
 . S RETSTA("CKOUT")="-1^Clinic Appointment record was not found"
 ;
 ; -- Get check-in date/time --
 S IENS=CLAPTIEN_","_APPTDT_","_CLINIEN_","
 S CHKINDT=$$GET1^DIQ(44.003,IENS,309,"I")
 I CHKINDT="" D  QUIT
 . S RETSTA("CKOUT")="-1^Appointment has not been checked-in"
 ;
 ; -- Check check-out date/time --
 N RESULT,MSG
 S BADDATE=0
 I $G(DHPCODT)="" D
 . S CHKOUTDT=$$FMADD^XLFDT(CHKINDT,0,0,30)
 E  D
 . S CHKOUTDT=$$HL7TFM^XLFDT(DHPCODT)
 . I $P(CHKOUTDT,".",2)="" S RETSTA("CKOUT")="-1^Missing time for check-out.",BADDATE=1 QUIT
 . ;convert to external and check date/time against Fileman date/time field
 . S Y=CHKOUTDT
 . D DD^%DT
 . S EXDATE=Y
 . D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
 . I RESULT="^" S RETSTA("CKOUT")="-1^Invalid check-out date/time.",BADDATE=1 QUIT
 QUIT:BADDATE
 I CHKOUTDT'>CHKINDT S RETSTA("CKOUT")="-1^Check-out date/time must greater than check-in date." QUIT
 ;
 ;check requirements for completing check-out of appointment
 N COERRMSG,IDX
 S COERRMSG=1
 D CHECKCO(.COERRMSG,PATDFN,APPTDT)
 I COERRMSG=-1 D  QUIT
 . S RETSTA("CKOUT")=-1
 . S IDX=""
 . F  S IDX=$O(COERRMSG(IDX)) QUIT:IDX=""  D
 . . S RETSTA("CKOUT")=RETSTA("CKOUT")_"^"_COERRMSG(IDX)
 ;
 I $G(DEBUG)=1 D
 . W "Appointment Check-in  APTCKOUT^SYNDHP62",!
 . W "ICN:             ",DHPPAT,"   DFN: ",PATDFN,!
 . W "CLINIC:          ",DHPCLIN,"   IEN: ",CLINIEN,!
 . W "CLINIC,APPT,IEN: ",CLAPTIEN,!
 . W "APPT D/T:        ",DHPAPTDT,"   ",APPTDT,!
 . W "CHK-IN D/T:      ",CHKINDT,!
 . W "CHK-OUT D/T:     ",DHPCODT,"   ",CHKOUTDT,!
 ;
 ; -- appointment check-out updates --
 ;
 ; patient appointment record
 ;  update appt record with outpatient encounter ien
 ;    21 - outpatient encounter 0;20 P409.68
 ;
 ;get the outpatient encounter IEN for the appt. encounter record, not the stop code record
 N SCEIEN
 S SCEIEN=$O(^SCE("ADFN",PATDFN,APPTDT,""))
 I SCEIEN="" D  QUIT
 . S RETSTA("CKOUT")="-1^Could not find the outpatient encounter record."
 ;
 ; patient appointment record
 ;  update appt record with outpatient encounter ien
 ;    21 - outpatient encounter 0;20 P409.68
 ;
 N IENS,FDA,ERRMSG
 S IENS=APPTDT_","_PATDFN_","
 S FDA(2.98,IENS,21)=SCEIEN ;outpatient encounter
 D FILE^DIE("K","FDA","ERRMSG")
 I $D(ERRMSG) D  QUIT
 . S RETSTA("CKOUT")="-1^Problem updating patient appointment Outpat Enc pointer (#2.98) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 ;
 ; clinic appointment record
 ;  303 - checked out (date) C;3
 ;  304 - check out user C;4 P200
 ;  306 - check out entered (date) C;6
 ;
 N IENS,FDA,ERRMSG
 S IENS=CLAPTIEN_","_APPTDT_","_CLINIEN_","
 S FDA(44.003,IENS,303)=CHKOUTDT ;checked out (date)
 S FDA(44.003,IENS,304)=DUZ ;check out user
 S FDA(44.003,IENS,306)=CHKOUTDT ;check out entered (date)
 D FILE^DIE("K","FDA","ERRMSG")
 I $D(ERRMSG) D  QUIT
 . S RETSTA("CKOUT")="-1^Problem updating clinic appointment check-out info (#44.003) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 ;
 ; outpatient encounter records
 ;
 N IENS,FDA,ERRMSG
 S IENS=SCEIEN_","
 S FDA(409.68,IENS,.07)=CHKOUTDT ;check out process completion
 S FDA(409.68,IENS,.1)=11 ;appointment type
 S FDA(409.68,IENS,.12)=2 ;status
 D FILE^DIE("K","FDA","ERRMSG")
 I $D(ERRMSG) D  QUIT
 . S RETSTA("CKOUT")="-1^Problem updating outpatient encounter (#409.68) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 ;
 N IENS,FDA,ERRMSG
 S IENS=$O(^SCE("APAR",SCEIEN,""))_","
 S FDA(409.68,IENS,.1)=11 ;appointment type
 D FILE^DIE("K","FDA","ERRMSG")
 I $D(ERRMSG) D  QUIT
 . S RETSTA("CKOUT")="-1^Problem updating outpatient encounter (#409.68) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
 ;
 ; visit records - no update required
 ;
 S RETSTA("CKOUT")=1
 ;
 QUIT
 ;
CHECKCO(COERRMSG,PATDFN,APPTDT) ;
 ;
 N ECNT,SCEIENP,SCEIENS,INVDATE,VIENP,VIENS,VPROV,VPOV,VCPT
 S ECNT=0
 ;
 S SCEIENP=$O(^SCE("ADFN",PATDFN,APPTDT,""))
 I SCEIENP="" D
 . S ECNT=ECNT+1
 . S COERRMSG=-1
 . S COERRMSG(ECNT)="No Outpatient Encounter record"
 ;
 I SCEIENP'="" D
 . S SCEIENS=$O(^SCE("APAR",SCEIENP,""))
 . I SCEIENS="" D
 . . S ECNT=ECNT+1
 . . S COERRMSG=-1
 . . S COERRMSG(ECNT)="No Outpatient Encounter stop code record"
 ;
 S INVDATE=9999999-$P(+APPTDT,".",1)_$S($P(+APPTDT,".",2)'="":"."_$P(+APPTDT,".",2),1:"")
 S VIENP=$O(^AUPNVSIT("AA",PATDFN,INVDATE,""))
 I VIENP="" D
 . S ECNT=ECNT+1
 . S COERRMSG=-1
 . S COERRMSG(ECNT)="No Visit record"
 ;
 I VIENP'="" D
 . S VIENS=$O(^AUPNVSIT("AD",VIENP,""))
 . I VIENS="" D
 . . S ECNT=ECNT+1
 . . S COERRMSG=-1
 . . S COERRMSG(ECNT)="No Visit stop code record"
 . ;
 . S VPROV=$O(^AUPNVPRV("AD",VIENP,""))
 . I VPROV="" D
 . . S ECNT=ECNT+1
 . . S COERRMSG=-1
 . . S COERRMSG(ECNT)="No V Provider record for Visit"
 . ;
 . S VPOV=$O(^AUPNVPOV("AD",VIENP,""))
 . I VPOV="" D
 . . S ECNT=ECNT+1
 . . S COERRMSG=-1
 . . S COERRMSG(ECNT)="No V POV record for Visit"
 . ;
 . S VCPT=$O(^AUPNVCPT("AD",VIENP,""))
 . I VCPT="" D
 . . S ECNT=ECNT+1
 . . S COERRMSG=-1
 . . S COERRMSG(ECNT)="No V CPT record for Visit"
 . ;
 QUIT
 ;
TEST ;
T1 S ERRDISP=1
 D PRBUPDT(.ZXC,"5482156687V807096",2,9990006675,,"A","5OO_EXT",267036007)
 Q
 ;"PAT":"5482156687V807096","VST":"17004","ROV":"9990006675","ONS":"20130117","ABT":"20131021","CLNST":"I","SCT":"267036007"
T2 S ERRDISP=1
 D PRBUPDT(.ZXC,"11004V412157",17003,9990006675,20160117,20161021,"I",1657008)
 Q
T3 ;
 S ERRDISP=1
 D PRBUPDT(.ZXC,"11004V412157",,9990006675,20160117,20161021,"I",1657008)
 Q
T4 ; ICD9 code that was valid at 20130117
 S ERRDISP=1
 D PRBUPDT(.ZXC,"11004V412157",17003,9990006675,20130117,20161021,"I",2251002)

SYNDHP63
SYNDHP63 ;DHP/ART -  Write Lab Tests to VistA ;2019-01-31  10:43 AM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of DXC Technology 2017-2018
 ;
 QUIT
 ;
 ; -------- Create lab test for a patient
 ;
LABADD(RETSTA,DHPPAT,DHPLOC,DHPTEST,DHPRSLT,DHPRSDT,DHPLOINC) ;Create lab test
 ; This is a wrapper to setup a call to the ISI Lab Import processing
 ;
 ; Input:
 ;   DHPPAT  - Patient ICN (required)
 ;   DHPLOC  - Location Name (required)
 ;   DHPTEST - Test name (required if no valid LOINC code passed)
 ;   DHPRSLT - Test result value (required)
 ;   DHPRSDT - Test result date (required, HL7 format)
 ;   DHPLOINC - LOINC code
 ;
 ; Output:   RETSTA
 ;  1 - success
 ; -1 - failure -1^message
 ;
 N PATDFN,PATSSN,LABARRAY,RC,DHPRC,LOINCIEN,TESTIEN,LABTEST,SAVEIO
 ;
 S RETSTA("LABINPUT","DHPPAT")=DHPPAT
 S RETSTA("LABINPUT","DHPLOC")=DHPLOC
 S RETSTA("LABINPUT","DHPTEST")=DHPTEST
 S RETSTA("LABINPUT","DHPRSLT")=DHPRSLT
 S RETSTA("LABINPUT","DHPRSDT")=DHPRSDT
 S RETSTA("LABINPUT","DHPLOINC")=DHPLOINC
 ;
 I $G(DHPPAT)="" S RETSTA="-1^Missing patient identifier." QUIT
 I $G(DHPLOC)="" S RETSTA="-1^Missing location." QUIT
 I $G(DHPLOINC)="",$G(DHPTEST)="" S RETSTA="-1^Missing lab test name." QUIT
 I $G(DHPRSLT)="" S RETSTA="-1^Missing lab test result value." QUIT
 I $G(DHPRSDT)="" S RETSTA="-1^Missing lab test result date/time." QUIT
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised." QUIT
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
 S PATSSN=$$GET1^DIQ(2,PATDFN_",",.09,"I") ;patient SSN
 I PATSSN="" S RETSTA="-1^Patient does not have an SSN." QUIT
 ;
 ; -- Check lab test date/time --
 S LABDTTM=$$HL7TFM^XLFDT(DHPRSDT)
 I $P(LABDTTM,".",2)="" S RETSTA="-1^Missing time for result date/time." QUIT
 ;chop off seconds
 S LABTM=$E($P(LABDTTM,".",2),1,4)
 S $P(LABDTTM,".",2)=LABTM
 S LABDTTM=$$HL7TFM^XLFDT($$FMTHL7^XLFDT(LABDTTM)) ;drop any trailing 0's in time
 ;
 ;Get lab test name for LOINC code
 I $G(DHPLOINC)'="" D
 . S LOINCIEN=$O(^LAB(95.3,"B",$P(DHPLOINC,"-",1),""))
 . QUIT:LOINCIEN=""
 . S TESTIEN=$O(^LAB(60,"AF",LOINCIEN,""))
 . QUIT:TESTIEN=""
 . S LABTEST=$$GET1^DIQ(60,TESTIEN_",",.01)
 I $G(LABTEST)="" S LABTEST=$$UP^XLFSTR(DHPTEST)
 ;I $G(LABTEST)="" S LABTEST=DHPTEST
 I $G(LABTEST)="" S RETSTA="-1^Cannot determine lab test name." QUIT
 ;
 S LABARRAY("PAT_SSN")=PATSSN
 S LABARRAY("LAB_TEST")=LABTEST
 S LABARRAY("RESULT_DT")=LABDTTM
 S LABARRAY("RESULT_VAL")=DHPRSLT
 S LABARRAY("LOCATION")=DHPLOC
 S LABARRAY("LOINC")=DHPLOINC
 M RETSTA("LABDATA")=LABARRAY
 ;
 I $G(DEBUG)=1 D
 . W "ICN:      ",DHPPAT,!
 . W "SSN:      ",LABARRAY("PAT_SSN"),!
 . W "LOCATION: ",LABARRAY("LOCATION"),!
 . W "LOINC:    ",DHPLOINC,!
 . W "TEST:     ",LABARRAY("LAB_TEST"),!
 . W "RESULT:   ",LABARRAY("RESULT_VAL"),!
 . W "DATE:     ",LABARRAY("RESULT_DT"),!
 ;
 ;call ISI Labs Ingest
 S DHPRC=$$LAB^ISIIMP12(.RC,.LABARRAY)
 I +DHPRC=-1 S RETSTA=DHPRC QUIT
 ;
 S RETSTA=1
 ;
 QUIT
 ;
T1 ; test one
 ;
 M PARMS=^XTMP("SYNGRAPH",1,1267,"load","labs",13,"parms")
 S N=""
 F  S N=$O(PARMS(N)) Q:N=""  S @N=PARMS(N)
 D LABADD(.ZXC,DHPPAT,DHPLOC,DHPLAB,DHPOBS,DHPDTM,DHPLOINC)
 Q

SYNDHP64
SYNDHP64 ;DHP/AFHIL -fjf/art - HealthConcourse - Write Health Factors to VistA ; 31st July 2018
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ; -------- Create health factor for a patient
 ;
HLFADD(RETSTA,DHPPAT,DHPLOC,DHPHLF,DHPCAT,DHPCODE,DHPCOD,DHPSYS,DHPDAT,DHPPRV,DHPVST,DHPCOM,DHPUCUM,DHPMAG) ;
 ; Create health factor
 ;
 ;
 ; Input:
 ;   DHPPAT  - Patient ICN (required)
 ;   DHPLOC  - Location Name (required)
 ;   DHPHLF  - Health Factor Name (include SNOMED CT or LOINC code)
 ;   DHPCAT  - Health Factor Category
 ;   DHPCOD  - Code
 ;   DHPSYS  - Coding system (SNOMED CT or LOINC)
 ;   DHPDAT  - Date
 ;   DHPPRV  - Provider
 ;   DHPVST  - Visit number
 ;   DHPCOM  - Comment
 ;   DHPUCUM - UCUM code
 ;   DHPMAG  - Magnitude
 ;
 ; Output:   RETSTA
 ;  1 - success
 ; -1 - failure -1^message
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
 ;
 I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
 ;
 ;
 ;S HDATA("LEVEL/SEVERITY")
 ; HDATA("EVENT D/T"))
 ; HDATA("ORD PROVIDER"))
 ; HDATA("ENC PROVIDER"))
 ;
 ;Magnitude and UCUM code
 ; HDATA("MAGNITUDE"))
 ; HDATA("COMMENT"))
 ;

SYNDHP65
SYNDHP65 ;DHP/AFHIL -fjf -  Write Procedures to VistA ; 12th Sept 2018
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ;
PRCADD(RETSTA,DHPPAT,DHPVST,DHPCNT,DHPSCT,DHPDTM)
 ;
 ; Ingest Procedures into VistA
 ;
 ; Input:
 ;   DHPPAT   - patient ICN              (mandatory)
 ;   DHPVST   - Visit Identifier         (mandatory)
 ;   DHPCNT   - No of times performed    (mandatory)
 ;   DHPSCT   - SCT Procedure code       (mandatory)
 ;   DHPDTM   - Procedure Date/Time      (mandatory) HL7 format
 ; Output:
 ;   1 - success
 ;  -1 - failure
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
 ;
 I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
 I '$D(^AUPNVSIT(DHPVST)) S RETSTA="-1^Visit not found" Q
 ;
 D INIT
 ;
 ; use SNOMED CT to OS5 mapping
 S MAPPING="sct2os5"
 ;
 S DHPOS5=$$MAP^SYNDHPMP(MAPPING,DHPSCT)
 I +DHPOS5'=1 S RETSTA="-1^Code "_DHPSCT_" not mapped" Q
 S DHPOS5=$P(DHPOS5,U,2)
 ;
 S PROCDATA("PROCEDURE",1,"PROCEDURE")=DHPOS5
 S PROCDATA("PROCEDURE",1,"QTY")=DHPCNT
 ;
 S DATFM=$$HL7TFM^XLFDT(DHPDTM)
 S PROCDATA("PROCEDURE",1,"EVENT D/T")=DATFM
 ;
 ;
 S RETSTA=1
 S RETSTA=$$DATA2PCE^PXAI("PROCDATA",PACKAGE,SOURCE,.DHPVST,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
 ;I $D(ZZERR) ZWRITE ZZERR
 ;
 Q
 ;
INIT ; Initiate variables
 ;
 S PACKAGE=$$FIND1^DIC(9.4,,"","PCE")
 S SOURCE="DHP DATA INGEST"
 S USER=$$DUZ^SYNDHP69
 S ERRDISP=""
 I $G(DEBUG)=1 S ERRDISP=1
 S PPEDIT=""
 S ACCOUNT=""
 S P="|"
 ;
 S ERRDISP=1 ;for testing only, set to null otherwise  <<<<<<<<<<<<<<<<<<<<<<<
 S PPEDIT=""
 S ACCOUNT=""
 ;
 Q
 ;
T1 ;
 D PRCADD(.ZXC,"5000000352V586511",20559,1,56876005,20151002)
 Q

SYNDHP67
SYNDHP67 ; AFHIL/fjf/art - HealthConcourse - retrieve patient TIU notes ;07/26/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
PATTIUI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient TIU Notes for ICN
 ;
 ; Return patient Text Integration Utility Notes for a given patient ICN
 ;     signed progress notes
 ;     signed discharge summaries
 ;
 ; Input:
 ;   ICN     - unique patient identifier across all VistA systems
 ;   FRDAT   - from date (inclusive), optional, compared to 1201 ENTRY DATE/TIME
 ;   TODAT   - to date (inclusive), optional, compared to 1201 ENTRY DATE/TIME
 ;   RETJSON - J = Return JSON
 ;             F = Return FHIR
 ;             0 or null = Return string (default)
 ; Output:
 ;   RETSTA  - a delimited string that lists the following information
 ;      PatientICN~ResourceID|DateTime|NoteStatus|NoteConfidentiality
 ;        |NoteAuthor|NoteLine(1)^NoteLine(2)^NoteLine(3)...
 ;        ^NoteLine(n)^|LOINC Code_LOINC Name~...
 ;
 ;  Identifier will be "V"_SITE ID_FILE #_FILE IEN   i.e. V_500_8925_930
 ;
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
 ;
 S RETSTA=$NA(^TMP($T(+0),$J))
 K @RETSTA
 N RETCNT S RETCNT=1
 S @RETSTA@(RETCNT)=DHPICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
 ;
 N P S P="|"
 N S S S="_"
 N T S T="~"
 N NTX,NTIEN,VID,NTSTA,NTDTMFM,NTDTM,NTAUTH,NCONF,NTLS,NTL,NOTELIST
 ;
 ; get list of signed progress notes for patient
 N ZXC
 D NOTES^TIUSRVLO(.ZXC,PATIEN)
 N NTS S NTS=$NA(@ZXC)
 N NT S NT=""
 F  S NT=$O(@NTS@(NT)) Q:NT=""  D
 . S NOTELIST($P(@NTS@(NT),U,1))="P"
 ;
 ; get list of signed discharge summaries for patient
 N ZXC
 D SUMMARY^TIUSRVLO(.ZXC,PATIEN)
 N NTS S NTS=$NA(@ZXC)
 N NT S NT=""
 F  S NT=$O(@NTS@(NT)) Q:NT=""  D
 . S NOTELIST($P(@NTS@(NT),U,1))="D"
 ;
 ; set generic LOINC code required by Azure implementation of FHIR
 N NTLOINC S NTLOINC="11506-3_Provider-unspecified Progress note"
 N DSLOINC S DSLOINC="18842-5_Discharge summary"
 ;
 N TIUARRAY
 N TIUIEN S TIUIEN=""
 F  S TIUIEN=$O(NOTELIST(TIUIEN)) QUIT:TIUIEN=""  D
 . N TIU
 . D GET1TIU^SYNDHP24(.TIU,TIUIEN,0) ;get one TIU record
 . I $D(TIU("Tiu","ERROR")) M TIUARRAY("TiuNotes",TIUIEN)=TIU QUIT
 . ;I $E(RETSTA,$L(RETSTA))=U S RETSTA=$E(RETSTA,1,$L(RETSTA)-1) ; //SMH?
 . ;S NTX=@NTS@(TIUIEN)
 . S NTIEN=TIU("Tiu","tiuIen")
 . S NTDTMFM=TIU("Tiu","entryDateTimeFM")
 . QUIT:'$$RANGECK^SYNDHPUTL(NTDTMFM,FRDAT,TODAT)  ;quit if outside of requested date range
 . S RETCNT=RETCNT+1
 . S @RETSTA@(RETCNT)=T
 . S VID=TIU("Tiu","resourceId")
 . S NTSTA=TIU("Tiu","statusFHIR")
 . S NTDTM=TIU("Tiu","entryDateTimeHL7")
 . S NTAUTH=TIU("Tiu","authorDictatorId")
 . S NTAUTH=$$GET1^DIQ(200,NTAUTH_",",41.99) ;NPI
 . ; note confidentiality
 . S NCONF="N"
 . ;W !,NT,"  -  ",NTSTA,!
 . S RETCNT=RETCNT+1
 . S @RETSTA@(RETCNT)=VID_P_NTDTM_P_NTSTA_P_NCONF_P_NTAUTH_P
 . ; now get note text for non-json return
 . N ZXCV,NTLTX
 . D TGET^TIUSRVR1(.ZXCV,NTIEN)
 . I $G(DEBUG) W $$ZW^SYNDHPUTL("ZXCV")
 . S NTLS=$NA(@ZXCV)
 . S NTL=0
 . F  S NTL=$O(@NTLS@(NTL)) QUIT:NTL=""  D
 . . S NTLTX=@NTLS@(NTL)
 . . S NTLTX=$TR(NTLTX,T," ") ; Remove Tildes from text as we use it as delimiter
 . . S NTLTX=$TR(NTLTX,U," ") ; Remove Tildes from text as we use it as delimiter
 . . S RETCNT=RETCNT+1
 . . S @RETSTA@(RETCNT)=NTLTX_U
 . S RETCNT=RETCNT+1
 . S @RETSTA@(RETCNT)=P_$S(NOTELIST(TIUIEN)="D":DSLOINC,1:NTLOINC)_P
 . I NOTELIST(TIUIEN)="D" D
 . . S TIU("Tiu","loincCode")=$P(DSLOINC,S,1)
 . . S TIU("Tiu","loincDesc")=$P(DSLOINC,S,2)
 . E  D
 . . S TIU("Tiu","loincCode")=$P(NTLOINC,S,1)
 . . S TIU("Tiu","loincDesc")=$P(NTLOINC,S,2)
 . ;<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< issue with new VEHU not decrypting e-sig data
 . S TIU("Tiu","signatureBlockName")=""
 . S TIU("Tiu","signatureBlockTitle")=""
 . S TIU("Tiu","cosignatureBlockName")=""
 . S TIU("Tiu","cosignatureBlockTitle")=""
 . ;<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
 . M TIUARRAY("TiuNotes",TIUIEN)=TIU
 ;
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
 ;
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
 . S RETSTA=""
 . D TOJASON^SYNDHPUTL(.TIUARRAY,.RETSTA)
 . S RETSTA=$$UES^XLFJSON(RETSTA) ;change \\n to \n
 ;
 QUIT
 ;
 ; ----------- Unit Test -----------
T1 ;
 D PATTIUI(.ZXC,"5000000001V324625")
 D ZWRITE^SYNDHPUTL(ZXC)
 Q
T2 ;
 N ZXS
 D PATTIUI(.ZXS,"11004V412157")
 Q
 ;
T3 ;
 N ICN S ICN="9009373208V847154"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON=""
 N RETSTA
 D PATTIUI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T4 ;
 N ICN S ICN="9009373208V847154"
 N FRDAT S FRDAT=19960401
 N TODAT S TODAT=19970101
 N JSON S JSON=""
 N RETSTA
 D PATTIUI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;
T5 ;
 N ICN S ICN="9009373208V847154"
 N FRDAT S FRDAT=""
 N TODAT S TODAT=""
 N JSON S JSON="J"
 N RETSTA
 D PATTIUI(.RETSTA,ICN,FRDAT,TODAT,JSON)
 W $$ZW^SYNDHPUTL("RETSTA")
 QUIT
 ;

SYNDHP69
SYNDHP69 ;AFHIL-DHP/fjf/art - HealthConcourse - Common Utility Functions ;2019-06-21  11:21 AM
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 10
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 Q
 ;
DUZ() ; issues/set DUZ
 I '$D(DT) S DT=$$DT^XLFDT
 N VASITE S VASITE=$$SITE^VASITE
 N SITE S SITE=$P(VASITE,"^",3)
 S DUZ=$S(+$G(DUZ)=0:$$PROV^SYNINIT,1:DUZ)
 D DUZ^XUS1A
 Q DUZ
 ;
 ;
RESID(ENT,SITE,FILE,IEN,SUB) ; resource ID
 ; inputs: ENT - "V"
 ;         SITE - site id
 ;         FILE - file number
 ;         IEN - record ien
 ;         SUB - additional subfiles & iens (optional) ex: 44.1^1^...
 ; returns: resource id, ex: V-500-44-23, V-500-44-23-44.1-1
 ;
 N D
 S D="-"
 S SUBS=$TR($G(SUB),U,D)
 Q ENT_D_SITE_$$FACID_D_FILE_D_IEN_$S($L(SUBS)>0:D_SUBS,1:"")
 ;
 ;
FACID() ; Get facility parameter to append to site
 ;
 N XPARSYS
 Q $$GET^XPAR("SYS","SYNDHPFAC",1)
 ;
 ;
GETFACID(RETSTA,X) ; Get facility parameter
 ;
 S RETSTA=$$FACID
 Q
 ;
FACPAR(RETSTA,DHPFAC) ; Setup/delete faciltity identification parameter
 ;
 ; Input:
 ;   DHPFAC - facility identifier
 ;     ER     - Emergency Room
 ;     HOSP   - Hospital
 ;     SCLIN  - Specialist Clinic
 ;     HS     - HealthShare
 ;     @      - delete
 ;
 S RETSTA=0
 I "^ER^SCLIN^HOSP^HS^@"'[DHPFAC S RETSTA=0_"^error" Q
 I $$CKPRDF=0 S RETSTA=0_"^parameter definition error" Q
 ;
 ; add the parameter if it doesn't exist, or delete for FAC="@"
 N ZZERR
 D EN^XPAR("SYS","SYNDHPFAC",,DHPFAC,.ZZERR)
 S RETSTA='ZZERR
 Q
 ;
CKPRDF() ; Check that parameter definition exists for SYNDHPFAC
 ;       and it it doesn't exist, create it
 N FN,FDA,ZZERR
 S FN=8989.51
 I +$$FIND1^DIC(FN,,"MX","SYNDHPFAC")'=0 Q 1
 S FDA(FN,"+1,",.01)="SYNDHPFAC"
 S FDA(FN,"+1,",.02)="SYNDHP Facility Parameter"
 S FDA(FN,"+1,",1.1)="F"
 K ZZERR
 D UPDATE^DIE(,"FDA",,"ZZERR")
 Q '$D(ZZERR)
 ;
LOGRST(RETSTA) ; expunge ^VPRHTTP("log")
 ;
 N QT
 S QT=""""
 K ^%webhttp("log")
 S RETSTA="Mission accomplished - ^%webhttp("_QT_"log"_QT_")"_" annihilated"
 Q
 ;
TEST D EN^%ut($T(+0),1) QUIT
T1 ; @TEST HASHINFO^ORDEA previously crashed due to bad DUZ(2)
 S DUZ=$$DUZ()
 N ORY
 D HASHINFO^ORDEA(.ORY,1,$$PROV^SYNINIT)
 D SUCCEED^%ut
 QUIT
 ;

SYNDHP73
SYNDHP73 ;AFHIL DHP/fjf/art - HealthConcourse - DHP REST handlers ;2019-10-23  3:54 PM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;  -------------------------------
 ;  Patient validate bridge routine
 ;  -------------------------------
 ;
PATVAL ; Verify patient on basis of name, SSN, DoB, Gender and Mother's Maiden name
 ;parse out RPC call parameters from REST request
 ;
 ;   DHPPATVAL
 ;
 ;S $ZT="^ZTER"
 D PARSEVAL
 ;
 D PATVAL^SYNDHP43(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPMMDNM)
 ; RETSTA is string returned by
 ;S RETSTA="NOTHING SUCCEEDS LIKE A BUDGIE"
 ;
 Q
 ;
PARSEVAL ;
 ;
 F I="SSN","DOB","GENDER","MMDNM" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
 Q
 ;
 ;  ---------------------------------------------
 ;  Patient demographics by traits bridge routine
 ;  ---------------------------------------------
 ;
PATDEM ; get patient demographics for one patient
 ;
 ;   DHPPATDEM
 ;
 D PARSEDEM
 D PATDEM^SYNDHP47(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPJSON)
 Q
 ;
PARSEDEM ;
 ;
 F I="SSN","DOB","GENDER","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
 Q
 ;
 ;  ------------------------------------------
 ;  Patient demographics by ICN bridge routine
 ;  ------------------------------------------
 ;
PATDEMI ; get patient demographics for one patient
 ;
 ;   DHPPATDEMICN
 ;
 D PARSEICN
 F I="JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATDEMI^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
 Q
 ;
 ;  ----------------------------------------------------
 ;  All patient demographics by ICN="ALL" bridge routine
 ;  ----------------------------------------------------
 ;
PATDEMAL ; get patient demographics for all patients
 ;
 ;   DHPPATDEMALL
 ;
 D PARSEICN
 F I="JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATDEMAL^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
 Q
 ;
 ;  ----------------------------------------------------
 ;  All patient ICN's bridge routine
 ;  ----------------------------------------------------
 ;
PATICNS ; get patient ICN for some or all patients
 ;
 ;   DHPPATICNALL
 ;
 F I="CNT","JSON","RND" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D ICNS^SYNDHPIC(.RETSTA,DHPCNT,DHPJSON,DHPRND)
 Q
 ;  ----------------------------------------------------
 ;  All patient demographics by ICN=range bridge routine
 ;  ----------------------------------------------------
 ;
PATDEMRG ; get patient demographics for a range of patients
 ;
 ;   DHPPATDEMRNG
 ;
 D PARSEICN
 F I="JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATDEMRNG^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
 Q
 ;
 ;  ----------------------------------------------------
 ;  Patient condition SCT codes by traits bridge routine
 ;  ----------------------------------------------------
 ;
PATCON ; get patient condition SCT codes for one patient by traits
 ;
 ;   DHPPATCON
 ;
 D PARSECON
 D PATCONDS^SYNDHP03(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER)
 Q
 ;
PARSECON ;
 ;
 F I="SSN","DOB","GENDER" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
 Q
 ;
 ;  ----------------------------------------
 ;  Patient conditions by ICN bridge routine
 ;  ----------------------------------------
 ;
PATCONI ; get patient conditions for one patient by ICN
 ;
 ;   DHPPATCONICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATCONI^SYNDHP03(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  --------------------------------------------------------
 ;  Patient encounters for one patient by ICN bridge routine
 ;  --------------------------------------------------------
 ;
PATENCI ; get patient encounters for one patient by ICN
 ;
 ;   DHPPATENCICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATENCI^SYNDHP40(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  ---------------------------------------
 ;  Patients for a condition bridge routine
 ;  ---------------------------------------
 ;
PATCONAL ; get patients for a condition
 ;
 ;   DHPPATS4CON
 ;
 D PARSECONAL
 D PATCONAL^SYNDHP03(.RETSTA,DHPSCT,DHPJSON)
 Q
 ;
PARSECONAL ; generalise
 ;
 F I="SCT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 Q
 ;
 ;  --------------------------------------------------
 ;  Patient medication statement by ICN bridge routine
 ;  --------------------------------------------------
 ;
PATMEDS ; get patient medication statement for one patient by ICN
 ;
 ;   DHPPATMEDSICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATMEDS^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;  -------------------------------------------------------
 ;  Patient medication administration by ICN bridge routine
 ;  -------------------------------------------------------
 ;
PATMEDA ; get patient medication administration for one patient by ICN
 ;
 ;   DHPPATMEDAICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATMEDA^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;  -------------------------------------------------
 ;  Patient medication dispense by ICN bridge routine
 ;  -------------------------------------------------
 ;
PATMEDD ; get patient medication dispense for one patient by ICN
 ;
 ;   DHPPATMEDDICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATMEDD^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;  ---------------------------------------
 ;  Patient vitals by traits bridge routine
 ;  ---------------------------------------
 ;
PATVIT ; get patient vitals for one patient by traits
 ;
 ;   DHPPATVIT
 ;
 D PARSEVIT
 D PATVIT^SYNDHP01(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;
PARSEVIT ;
 ;
 F I="SSN","DOB","GENDER","FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
 Q
 ;
 ;  ------------------------------------
 ;  Patient vitals by ICN bridge routine
 ;  ------------------------------------
 ;
PATVITI ; get patient vitals for one patient by ICN
 ;
 ;   DHPPATVITICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATVITI^SYNDHP01(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  -----------------------------------------------
 ;  Patient health factors by traits bridge routine
 ;  -----------------------------------------------
 ;
PATHLF ; get patient health factors for one patient
 ;
 ;   DHPPATHLF
 ;
 D PARSETRAITS
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATHLF^SYNDHP09(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  --------------------------------------------
 ;  Patient health factors by ICN bridge routine
 ;  --------------------------------------------
 ;
PATHLFI ; get patient health factors for one patient
 ;
 ;   DHPPATHLFICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATHLFI^SYNDHP09(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  -------------------------------------------
 ;  Patient procedures by traits bridge routine
 ;  -------------------------------------------
 ;
PATPRC ; get patient procedures for one patient
 ;
 ;   DHPPATPRC
 ;
 D PARSETRAITS
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATPRC^SYNDHP04(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;  ----------------------------------------
 ;  Patient procedures by ICN bridge routine
 ;  ----------------------------------------
 ;
PATPRCI ; get patient procedures for one patient
 ;
 ;   DHPPATPRCICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATPRCI^SYNDHP04(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;  ---------------------------------------
 ;  Patient allergies by ICN bridge routine
 ;  ---------------------------------------
 ;
PATALLI ; get patient allergies for one patient by ICN
 ;
 ;   DHPPATALLICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATALLI^SYNDHP57(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  -----------------------------------------------
 ;  Patient diagnostic report by ICN bridge routine
 ;  -----------------------------------------------
 ;
PATDXREP ; get patient diagnostic report for one patient by ICN
 ;
 ;   DHPPATDXRICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATDXRI^SYNDHP05(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  -------------------------------------
 ;  Patient labs by traits bridge routine
 ;  -------------------------------------
 ;
PATLAB ; get patient labs for one patient
 ;
 ;   DHPPATLAB
 ;
 D PARSETRAITS
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATLAB^SYNDHP53(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;  ----------------------------------
 ;  Patient labs by ICN bridge routine
 ;  ----------------------------------
 ;
PATLABI ; get patient labs for one patient
 ;
 ;   DHPPATLABICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATLABI^SYNDHP53(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  -------------------------------------------
 ;  Patient Enc Providers by ICN bridge routine
 ;  -------------------------------------------
 ;
PATPRVI ; get patient encounter providers for one patient
 ;
 ;   DHPPATPRVICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATPRVI^SYNDHP54(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;  ------------------------------------------
 ;  Patient Appointments by ICN bridge routine
 ;  ------------------------------------------
 ;
PATAPTI ; get patient appointments for one patient
 ;
 ;   DHPPATAPTICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATAPTI^SYNDHP41(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  -----------------------------------
 ;  Patient Flags by ICN bridge routine
 ;  -----------------------------------
 ;
PATFLGI ; get patient flags for one patient
 ;
 ;   DHPPATFLGICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATFLGI^SYNDHP08(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  ---------------------------------------------
 ;  Patient Immunizations by ICN bridge routine
 ;  ---------------------------------------------
 ;
PATIMMI ; get patient immunizations for one patient
 ;
 ;   DHPPATIMMICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATIMMI^SYNDHP02(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  ---------------------------------------------
 ;  Patient Goals by ICN bridge routine
 ;  ---------------------------------------------
 ;
PATGOLI ; get patient goals for one patient
 ;
 ;   DHPPATGOLICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATGOLI^SYNDHP07(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;
 ;  -----------------------------------------------
 ;  Patient observations by traits bridge routine
 ;  -----------------------------------------------
 ;
PATOBS ; get patient observations for one patient
 ;
 ;   DHPPATOBS
 ;
 D PARSETRAITS
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATOBS^SYNDHP56(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;  ---------------------------------------------
 ;  Patient observations by ICN bridge routine
 ;  ---------------------------------------------
 ;
PATOBSI ; get patient observations for one patient
 ;
 ;   DHPPATOBSICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATOBSI^SYNDHP56(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  ---------------------------------------------
 ;  Get one care team bridge routine
 ;  ---------------------------------------------
 ;
CARETEAM ; get one care team
 ;
 ;   DHPCARETEAM
 ;
 F I="TEAM","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D GETTEAM^SYNDHP58(.RETSTA,DHPTEAM,DHPJSON)
 Q
 ;
 ;  ---------------------------------------------
 ;  Get all care teams bridge routine
 ;  ---------------------------------------------
 ;
CARETEAMS ; get all care teams
 ;
 ;   DHPCARETEAMS
 ;
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D GETTEAMS^SYNDHP58(.RETSTA,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  ---------------------------------------------
 ;  get Care Plans for a patient by traits bridge routine
 ;  ---------------------------------------------
 ;
PATCPALL ; get all care plans
 ;
 ;   DHPPATCPALL
 ;
 D PARSETRAITS
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATCPALL^SYNDHP59(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  ---------------------------------------------
 ;  get Care Plans for a patient by ICN bridge routine
 ;  ---------------------------------------------
 ;
PATCPALLI ; get all care plans for a patient
 ;
 ;   DHPPATCPALLI
 ;
 F I="ICN","FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATCPALLI^SYNDHP59(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  --------------------------------------------------------
 ;  get one Care Plan for a patient by traits bridge routine
 ;  --------------------------------------------------------
 ;
PATCP ; get one care plan for a patient
 ;
 ;   DHPPATCP
 ;
 D PARSETRAITS
 F I="VRESID","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATCP^SYNDHP59(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPVRESID,DHPJSON)
 Q
 ;
 ;  --------------------------------------------------------
 ;  get one Care Plan for a patient by ICN bridge routine
 ;  --------------------------------------------------------
 ;
PATCPI ; get one care plan for a patient
 ;
 ;   DHPPATCPI
 ;
 F I="ICN","VRESID","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATCPI^SYNDHP59(.RETSTA,DHPICN,DHPVRESID,DHPJSON)
 Q
 ;
 ;  ----------------------------------------------
 ;  Institution Information by HLOC bridge routine
 ;  ----------------------------------------------
 ;
HLOCINST ; get institution information for hospital location name
 ;
 ;    DHPHLOCINSTHLOCNAM
 ;
 D PARSEHLC
 D HOSINSTI^SYNDHP06(.RETSTA,DHPHLOC,DHPJSON)
 Q
 ;
PARSEHLC ; Hospital Location Name PARSER
 ;
 F I="HLOC","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 Q
 ;
 ;  ---------------------------------------------
 ;  Text Integration Utility (TIU) bridge routine
 ;  ---------------------------------------------
 ;
PATTIUI ; get patient notes for one patient by ICN
 ;
 ;   DHPPATTIUICN
 ;
 D PARSEICN
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D PATTIUI^SYNDHP67(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;  --------------------------------------------------
 ;  get record specified by resource ID bridge routine
 ;  --------------------------------------------------
 ;
GETRESID ; get record specified by resource ID
 ;
 ;   DHPGETRESID
 ;
 F I="RESID" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 D GETREC^SYNDHP99(.RETSTA,DHPRESID)
 Q
 ;
 ;  ---------------------------------------------
 ;  Mappings bridge routine
 ;  ---------------------------------------------
 ;
MAPSVC ; get mapped code for a given source and code
 ;
 ;   DHPMAPSVC
 ;
 D PARSEMAP
 D MAPSVC^SYNDHP83(.RETSTA,DHPMAP,DHPCODE,DHPDIR,DHPIOE)
 Q
 ;
 ;  ---------------------------------------------
 ;  Facility Suffix Parameter bridge routine
 ;  ---------------------------------------------
 ;
SYSFAC ; get system facility  suffix parameter
 ;
 ;   DHPSYSFACUPD
 ;
 S DHPFAC="DHP"_$$GETPARAM^RGNETWWW(1)
 D GETFACID^SYNDHP69(.RETSTA,DHPFAC)
 Q
 ;
LOGRST ; expunge VPRHTTP("log"
 ;
 ;   DHPVPRLOGRST
 ;
 D LOGRST^SYNDHP69(.RETSTA)
 Q
 ;
 ;  -------------------------------------
 ;
PARSEICN ; ICN PARSER
 ;
 F I="ICN" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 Q
 ;
PARSETRAITS ; Traits parser
 ;
 F I="SSN","DOB","GENDER" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
 Q
 ;
PARSEMAP ; Map parser
 ;
 F I="MAP","CODE","DIR","IOE" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 Q

SYNDHP79
SYNDHP79 ; HC/fjf/art - HealthConcourse - DHP REST handlers ;03/27/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ; 
 ;  -------------------------------------------
 ;  Save patient vitals to VistA bridge routine
 ;  -------------------------------------------
 ;
PATVITSV ; save patient vitals for one patient to VistA
 ;
 ;   DHPPATVITPST
 ;
 ;CRASH
 D PARSEVITU
 D VITUPD^SYNDHP61(.RETSTA,DHPICN,DHPSCT,DHPOBS,DHPUNT,DHPDTM)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
 ;
 ;
PARSEVITU ;
 ;
 S C=",",L=":"
 S PARAMS=RGNETREQ("BODY",1)
 ;CRASH
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 F I="ICN","SCT","OBS","UNT","DTM" S @("DHP"_I)=PARAMS(I)
 ;S ^ZZFJF(99)=DHPICN_"^"_DHPSCT_"^"_DHPOBS_"^"_DHPUNT_"^"_DHPDTM
 Q
 ;
 ;  ---------------------------------------------
 ;
PATPRBSVX ; - old save patient problems for one patient to VistA
 ; >>>>>> THIS IS OLD CODE <<<<<<<
 ; >>>>>> SEE PATPRBSV BELOW <<<<<<<
 ;
 ;   DHPPATPRBUPD
 ;
 ;CRASH
 D PARSEPUPD
 D PROBUPD^SYNDHP61(.RETSTA,DHPICN,DHPSCT,DHPDES,DHPROV,DHPDTM,DHPRID)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
 ;
 ;
PARSEPUPDX ;
 ;
 S C=",",L=":"
 D SYNDHPLOG($H)
 S PARAMS=RGNETREQ("BODY",1)
 I $L(PARAMS,L)=1 S C="&",L="="
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 F I="ICN","SCT","DES","ROV","DTM","RID" S @("DHP"_I)=PARAMS(I)
 ;S ^ZZFJF(99)=DHPICN_"^"_DHPSCT_"^"_DHPOBS_"^"_DHPUNT_"^"_DHPDTM
 Q
 ;
 ;  ---------------------------------------------
 ;
 ;
PATPRBSV ; save patient problems for one patient to VistA
 ;
 ;   DHPPATPRBUPD
 ;
 ;CRASH
 D PARSEPUPD
 D PRBUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
 ;
 ;
PARSEPUPD ;
 ;
 S C=",",L=":"
 D SYNDHPLOG($H)
 S PARAMS=RGNETREQ("BODY",1)
 I $L(PARAMS,L)=1 S C="&",L="="
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 F I="PAT","VST","ROV","ONS","ABT","CLNST","SCT" S @("DHP"_I)=PARAMS(I)
 Q
 ;
 ;
PATDEMSV ; save demographics for one patient
 ;
 ; *** may have been overtaken by events
 ; *** may be removed at some suitable juncture or use ISI?
 ;
 ;   DHPPATDEMUPD
 ;
 ;D PARSEDEM
 ;D DEMUPD^SYNDHP61(.RETSTA,DHPICN,DHPSCT,DHPDES,DHPICD,DHPROV,DHPDTM,DHPRID)
 ;D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
PARSEDEM ;
 ;
 S C=",",L=":"
 S PARAMS=RGNETREQ("BODY",1)
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 ;CRASH
 F I="ICN","SCT","DES","ICD","ROV","DTM","RID" S @("DHP"_I)=PARAMS(I)
 ;S ^ZZFJF(99)=DHPICN_"^"_DHPSCT_"^"_DHPOBS_"^"_DHPUNT_"^"_DHPDTM
 Q
 ;
 ;  ---------------------------------------------
 ;
PATIMUSV ; save Immunizations for one patient
 ;
 ;   DHPPATIMMUPD
 ;
 D PARSEIMU
 ; Immunizations update
 D IMMUNUPD^SYNDHP61(.RETSTA,DHPICN,DHPVIS,DHPCVX,DHPLOC,DHPROU,DHPDOS,DHPDTM,DHPPROV)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
PARSEIMU ;
 ;
 N C,I,L,PARAMS
 ;
 S C=",",L=":"
 S PARAMS=RGNETREQ("BODY",1)
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 ;CRASH
 F I="ICN","VIS","CVX","LOC","ROU","DOS","DTM","PROV" S @("DHP"_I)=PARAMS(I)
 ;S ^ZZART(99)=DHPICN_U_DHPVIS_U_DHPCVX_U_DHPLOC_U_DHPROU_U_DHPDOS_U_DHPDTM_U_DHPPROV
 Q
 ;
 ;  ---------------------------------------------
 ;
PATAPTCR ; create Appointment for one patient
 ;
 ;   DHPPATAPTCRE
 ;
 D PARSEAPT
 ; Appointment create
 D APPTADD^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
PARSEAPT ;
 ;
 N C,I,L,PARAMS
 ;
 S C=",",L=":"
 S PARAMS=RGNETREQ("BODY",1)
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 ;CRASH
 F I="PAT","CLIN","APTDT","LEN" S @("DHP"_I)=PARAMS(I)
 ;S ^ZZART(99)=DHPPAT_U_DHPCLIN_U_DHPAPTDT_U_DHPLEN
 Q
 ;
 ;  ---------------------------------------------
 ;
PATAPTCI ; check-in one Appointment for one patient
 ;
 ;   DHPPATAPTCI
 ;
 D PARSECI
 ; Appointment create
 D APPTCKIN^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPCIDT)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
PARSECI ;
 ;
 N C,I,L,PARAMS
 ;
 S C=",",L=":"
 S PARAMS=RGNETREQ("BODY",1)
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 ;CRASH
 F I="PAT","CLIN","APTDT","CIDT" S @("DHP"_I)=PARAMS(I)
 ;S ^ZZART(99)=DHPPAT_U_DHPCLIN_U_DHPAPTDT_U_DHPCIDT
 Q
 ;
 ;
 ;  ---------------------------------------------
 ;
PATLABSV ; create one lab result for one patient
 ;
 ;   DHPPATLABUPD
 ;
 D PARSELAB
 ; Lab Result create
 D LABADD^SYNDHP63(.RETSTA,DHPPAT,DHPLOC,DHPTEST,DHPRSLT,DHPRSDT,DHPLOINC)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q
PARSELAB ;
 ;
 N C,I,L,PARAMS
 ;
 S C=",",L=":"
 S PARAMS=RGNETREQ("BODY",1)
 F I=1:1:$L(PARAMS,C) D
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
 ;CRASH
 F I="PAT","LOC","TEST","RSLT","RSDT","LOINC" S @("DHP"_I)=PARAMS(I)
 ;S ^ZZART(99)=DHPPAT_U_DHPLOC_U_DHPTEST_U_DHPRSLT_U_DHPRSDT_U_DHPLOINC
 Q
 ;
 ;  ---------------------------------------------
 ;
SYSFAC ; create/delete system facility parameter
 ;
 ;   DHPSYSFACUPD
 ;
 F I="FAC" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 S ^zzfjf("FAC")=DHPFAC
 D FACPAR^SYNDHP69(.RETSTA,DHPFAC)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q 
 ;
 ;  ---------------------------------------------
 ;
PARSEICN ; ICN PARSER
 ; 
 ;CRASH
 F I="ICN" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 Q
PARSETRAITS ; Traits parser
 ;
 F I="SSN","DOB","GENDER" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
 Q
SYNDHPLOG(TS) ; log arrays
 I $D(RGNETREQ) M ^SYNDHPLOG(TS,"RGNETREQ")=RGNETREQ
 I $D(RGCFG) M ^SYNDHPLOG(TS,"RGCFG")=RGCFG
 q

SYNDHP83
SYNDHP83 ; AFHIL/fjf - HealthConcourse - retrieve mapped code ;03/21/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;
 ;
 Q
 ;
 ; ----------------  Get Mapped Code  ----------------------
 ;
MAPSVC(RETSTA,DHPMAP,DHPCODE,DHPDIR,DHPIOE) ; get mapped code
 ;
 ; Return mapped code for given mapping and source code
 ;
 ; Input:
 ;   DHPMAP   - map identifier e.g. sct2icd, or rxn2ndf
 ;   DHPCODE  - source code to be mapped
 ;   DHPDIR  - direction of mapping
 ;             D for direct (default)
 ;             I for inverse
 ;   DHPIOE  - use internal or exernal mappings
 ;             I for internal SYN VistA (default)
 ;             H for external HealthConcourse
 ; Output:
 ;   RETSTA   - a delimited string that has the following
 ;              n^target_code
 ;
 ;             -where n is a flag indicating success/failure of request
 ;                 1 - success
 ;                -1 - exception
 ;                target_code is the code that is the result of the mapping
 ;
 N C
 S C=","
 S RETSTA=$$MAP^SYNDHPMP(DHPMAP,DHPCODE,DHPDIR,DHPIOE)
 Q

SYNDHP89
SYNDHP89 ; HC/art/fjf - HealthConcourse - DHP REST handlers
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 Q
 ;  ------------------------------------------------------------
 ;  Patient Text Integration Utility Notes by ICN bridge routine
 ;  ------------------------------------------------------------
 ;
PATTIUI ; get patient conditions for one patient by ICN
 ; ** to be retired
 ;
 ;   DHPPATTIUICN
 ;
 ;D PARSEICN
 ;D PATTIUI^SYNDHP67(.RETSTA,DHPICN)
 ;D ADD^RGNETWWW(RETSTA_$C(13,10))
 Q

SYNDHP91
SYNDHP91 ;DHP/fjf - HealthConcourse - Write care plans to VistA ;11/07/2018
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 10
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
 ;*//Input:
 ; a. Classification
 ; b. Activities SNOMED CT
 ; c. Goals - text and ptr to PL
 ; Status - fhir CODE
 ; Date
 ;
 ;
 ; 1.   Use data2pce to ingest careplans, activities & goals
 ; a.   Encounter
 ; b.   CarePlan points to encounter and the goals
 ; i.   V standard codes (SNOMED CT) - classification 
 ; c.   Goals - has text goal - points to condition/problems (reason for goal)
 ; i.   Use Healthfactors 
 ; ii.  Create goals HF category - config - add to configuration utility this will be for problem
 ; iii. For each goal create a health factor if doesn't already exist (laygo) (text from c above)
 ; iv.  Code which references the problem list
 ; v.   Entire text of goal goes in comment and say that goal addresses this problem  -> add SCT + desc code in there too
 ;
 ; d.
 ;
 ; Signature:
 ;Visit IEN
 ;Goals (array) text & code <- problem list code (SNOMED CT & or ICD)
 ;Activities (array) SNOMED code^status
 ;Classification SNOMED CT code
 ;CarePlan Status from FHIR set
 ;
 ;
 ;Generate TIU note for careplan and associate with encounter.
 ;//*
 ;
 ; HF for cat for careplan
 ; HF for careplan (use healthfactor manager
 ; HF for activity 
 ; pass to DATA2PCE
 ; 
 ;
 ; -------- Create Care Plan for Patient
 ;
CPLUPDT(RETSTA,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT) ;  update
 ;
 ; Input:
 ;   DHPPAT   - Patient ICN
 ;   DHPVST   - Visit ID
 ;   DHPCAT   - Category ID (SCT code. text, and FHIR status - active, completed, etc)
 ;   DHPACT   - List of Activities (SCT code, text, and FHIR status - in-progress, etc)
 ;   DHPGOL   - List of Goals
 ;   DHPSCT   - Reason for CarePlan (SCT code) - Care Plan Addresses
 ;   DHPSDT   - CarePlan Period start
 ;   DHPEDT   - CarePlan period end
 ;
 ;
 ; Output:   RETSTA
 ;  1 - success
 ; -1 - failure -1^message
 ;
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
 ;
 ;I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
 I '$D(^AUPNVSIT(DHPVST)) S RETSTA="-1^Visit not found" Q
 ;
 ;
 ;
 S U="^",T="~"
 ;
 S DHPGOL=$G(DHPGOL)
 S DHPSCT=$G(DHPSCT)
 S DHPSDT=$P($$HL7TFM^XLFDT(DHPSDT),".",1)
 S DHPEDT=$P($$HL7TFM^XLFDT(DHPEDT),".",1)
 ;
 S VISIT=DHPVST
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""),-1)
 S PACKAGE=$$FIND1^DIC(9.4,,"","?")
 S SOURCE="DHP DATA INGEST"
 S USER=$$DUZ^SYNDHP69
 S ERRDISP=""
 I $G(DEBUG)=1 S ERRDISP=1
 S CATCD=$P(DHPCAT,T)
 S CATTX=$P(DHPCAT,T,2)
 S CATST=$P(DHPCAT,T,3)
 ;S CONC=$$CODE^LEXTRAN(DHPSCT,"SCT",,,,,1)
 S ADDCD=$P(DHPSCT,U)
 S ADDTX=$P(DHPSCT,U,2)
 S ADDST=$P(DHPSCT,U,3)
 ;
 ; Call HF manager and retrieve HF for careplan category data or
 ;   add category HF and return data if it doesn't already exist 
 S CATDAT=$$HFCPCAT^SYNFHF(CATCD,CATTX)
 ;
 ; Call HF manager and retrieve HF for careplan
 ;   add careplan HF if it doesn't already exist
 S HFCAP=$$HFCP^SYNFHF(CATCD,CATTX,CATDAT)
 ;
 ; Call HF manager and retrieve HF for careplan addresses data or
 ;   add addresses HF and return data if it doesn't already exist 
 S ADDDAT=$$HFADDR^SYNFHF(ADDCD,ADDTX,CATDAT)
 ;
 ; create encounter array
 ;
 K ENCDATA
 ; 
 ;
 ; Careplan health factor
 ;
 S ENCDATA("HEALTH FACTOR",1,"HEALTH FACTOR")=+HFCAP
 S ENCDATA("HEALTH FACTOR",1,"EVENT D/T")=DHPSDT
 S ENCDATA("HEALTH FACTOR",1,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT_" Status: "_CATST
 ;
 ; what health factor addresses
 ;
 S ENCDATA("HEALTH FACTOR",2,"HEALTH FACTOR")=+ADDDAT
 S ENCDATA("HEALTH FACTOR",2,"EVENT D/T")=DHPSDT
 S ENCDATA("HEALTH FACTOR",2,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT ; _" Status: "_ADDST
 ;
 ; careplan activities
 ;
 I +CATDAT'=0 D
 .F I=1:1:$L(DHPACT,U) D
 ..S ACTS=$P(DHPACT,U,I)
 ..S ACTSCT=$P(ACTS,T)
 ..S ACTTXT=$P(ACTS,T,2)
 ..S ACTSTA=$P(ACTS,T,3)
 ..S HFACT=$$HFACT^SYNFHF(ACTSCT,ACTTXT,+CATDAT)
 ..S ENCDATA("HEALTH FACTOR",I+2,"HEALTH FACTOR")=+HFACT
 ..S ENCDATA("HEALTH FACTOR",I+2,"EVENT D/T")=DHPSDT
 ..S ENCDATA("HEALTH FACTOR",I+2,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT_" Status: "_ACTSTA
 ; 
GOLS ; careplan goals
 ;
 F J=1:1:$L(DHPGOL,U) D
 .S GOLS=$P(DHPGOL,U,J)
 .S GOLSCT=$P(GOLS,T)
 .S GOLTXT=$P(GOLS,T,2)
 .S GOLSTA=$P(GOLS,T,3)
 .S HFACT=$$HFGOAL^SYNFHF(GOLSCT,+CATDAT,GOLTXT)
 .S ENCDATA("HEALTH FACTOR",J+I+2,"HEALTH FACTOR")=+HFACT
 .S ENCDATA("HEALTH FACTOR",J+I+2,"EVENT D/T")=DHPSDT
 .S ENCDATA("HEALTH FACTOR",J+I+2,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT_" Status: "_GOLSTA
 ;
 ;
 S RETSTA=$$DATA2PCE^PXAI("ENCDATA",PACKAGE,SOURCE,.VISIT,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
 D EVARS
 M RETSTA=ENCDATA
 Q
 ;
 ;
T1 ;
 ;
 D VARS
 D CPLUPDT(.ZXC,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT)
 Q
 ; 
 ;s q=""""
 ;
 ;w q
 ;
 ;F I=1:1:7 s @$p(a(I),q,8)=$p(a(I),"=",2)
 ;
 ;a(1)="^XTMP("SYNGRAPH",1,1227,"load","careplan",12,"parms","DHPACT")=409002~Food allergy diet~in-progress^58332002~Allergy education~in-progress"
 ;a(2)="^XTMP("SYNGRAPH",1,1227,"load","careplan",12,"parms","DHPCAT")=326051000000105~Self care~active"
 ;a(3)="^XTMP("SYNGRAPH",1,1227,"load","careplan",12,"parms","DHPEDT")="
 ;a(4)="^XTMP("SYNGRAPH",1,1227,"load","careplan",12,"parms","DHPPAT")=1435855215V947437"
 ;a(5)="^XTMP("SYNGRAPH",1,1227,"load","careplan",12,"parms","DHPSCT")="
 ;a(6)="^XTMP("SYNGRAPH",1,1227,"load","careplan",12,"parms","DHPSDT")=2760829"
 ;a(7)="^XTMP("SYNGRAPH",1,1227,"load","careplan",12,"parms","DHPVST")=34818"
 ;
VARS ;
 S DHPACT="409002~Food allergy diet~in-progress^58332002~Allergy education~in-progress"
 S DHPCAT="326051000000105~Self care~active"
 S DHPEDT=""
 S DHPPAT="1345112108V472042"
 S DHPSCT="230690007^Cerebrovascular accident^passive"
 S DHPSDT="19760829"
 S DHPVST="34885"
 S DHPGOL="15777000~Address patient knowledge deficit on diabetic self-care~in-progress^15777000"
 S DHPGOL=DHPGOL_"~Improve and maintenance of optimal foot health: aim at early detection of peripheral"
 S DHPGOL=DHPGOL_" vascular problems and neuropathy presumed due to diabetes; and prevention of diabetic"
 S DHPGOL=DHPGOL_" foot ulcer, gangrene~in-progress^15777000~Maintain blood pressure below 140/90 mmHg"
 S DHPGOL=DHPGOL_"~in-progress^15777000~Glucose [Mass/volume] in Blood < 108~in-progress^15777000"
 S DHPGOL=DHPGOL_"~Hemoglobin A1c total in Blood < 7.0~in-progress"
 Q
 ; 
EVARS ;
 S ENCDATA("IVARS","DHPACT")=DHPACT
 S ENCDATA("IVARS","DHPCAT")=DHPCAT
 S ENCDATA("IVARS","DHPEDT")=DHPEDT
 S ENCDATA("IVARS","DHPPAT")=DHPPAT
 S ENCDATA("IVARS","DHPSCT")=DHPSCT
 S ENCDATA("IVARS","DHPSDT")=DHPSDT
 S ENCDATA("IVARS","DHPVST")=DHPVST
 S ENCDATA("IVARS","DHPGOL")=DHPGOL
 Q

SYNDHP92
SYNDHP92 ; HC/ART - HealthConcourse - DHP Save TIU Note ;01/26/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
CREATETIU(RETSTAT,DHPICN,TITLE,VISIT,TEXT,ESIG) ;save a TIU note for a patient
 ;Inputs: RETSTAT - return status, by reference
 ;        DHPICN  - patient ICN, required
 ;        TITLE   - pointer to the TIU DOCUMENT DEFINITION FILE (#8925.1), required
 ;        VISIT   - pointer to the Visit File (#9000010), required
 ;        TEXT    - input array with document identifiers and text, by reference, required
 ;          TEXT("TEXT",1,0)="abcd"
 ;          TEXT("TEXT",n,0)="wxyz"
 ;        ESIG - e-signature to sign note
 ;Output: RETSTAT - return status
 ;          IEN of the resulting entry in the TIU DOCUMENT FILE (#8925)
 ;       or -1^error message
 ;
 ; validate ICN
 I $G(DHPICN)="" S RETSTAT="-1^No patient identifier" QUIT
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTAT="-1^Patient identifier not recognised" QUIT
 ; get patient IEN from ICN
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
 I PATIEN="" S RETSTAT="-1^AFICN x-ref issue" QUIT
 ;
 ; validate TITLE
 I '$G(TITLE) S RETSTAT="-1^No title identifier" QUIT
 I '$D(^TIU(8925.1,TITLE,0)) S RETSTAT="-1^Title not found" QUIT
 ;
 ; validate VISIT
 I '$G(VISIT) S RETSTAT="-1^No visit identifier" QUIT
 I '$D(^AUPNVSIT(VISIT,0)) S RETSTAT="-1^Visit not found" QUIT
 N PAT S PAT=$$GET1^DIQ(9000010,VISIT_",",.05,"I")
 I PATIEN'=PAT S RETSTAT="-1^Visit is not for this patient" QUIT
 ;
 ; validate TEXT
 I '$D(TEXT) S RETSTAT="-1^No note text" QUIT
 ;
 ;optional parameters
 N VDATE S VDATE=""
 N VLOC S VLOC=""
 N VSTR S VSTR=""
 N SUPPRESS S SUPPRESS=0
 N NOASF S NOASF=1
 ;
 N VPROV S VPROV=$O(^AUPNVPRV("AD",VISIT,"")) ;visit provider ien
 I VPROV="" S RETSTAT="-1^no provider associated with visit" QUIT
 w "VPROV: ",VPROV,"    ",$$GET1^DIQ(200,VPROV_",",.01),!
 ;
 N TIUX
 S TIUX(.02)=PATIEN ;Patient IEN
 S TIUX(.01)=TITLE
 S TIUX(.03)=VISIT
 S TIUX(1201)=$$NOW^XLFDT() ;entry date/time
 S TIUX(1205)=$$GET1^DIQ(9000010,VISIT_",",.06,"I") ;hospital location
 S TIUX(1301)=$$GET1^DIQ(9000010,VISIT_",",.01,"I") ;reference date=Visit Date
 M TIUX=TEXT ;note text
 ;
 ;create the note
 D MAKE^TIUSRVP(.RETSTAT,PATIEN,TITLE,VDATE,VLOC,VISIT,.TIUX,VSTR,SUPPRESS,NOASF)
 I '+RETSTAT S RETSTAT="-1^Error creating note^"_RETSTAT QUIT
 ;
 N FDA
 N IENS S IENS=+RETSTAT_","
 S FDA(8925,IENS,1202)=VPROV
 S FDA(8925,IENS,1204)=VPROV
 S FDA(8925,IENS,1302)=VPROV
 D FILE^DIE("K","FDA","MSG")
 ;
 N NOTEIEN S NOTEIEN=+RETSTAT
 ;
 ;sign the note
 QUIT:$G(ESIG)=""
 N duzsave S duzsave=DUZ
 S DUZ=VPROV
 N RETVAL
 D SIGN^TIUSRVP(.RETVAL,NOTEIEN,$$ENCRYP^XUSRB1(ESIG))
 I +RETVAL S RETSTAT="-1^Error signing note^"_RETVAL
 S DUZ=duzsave
 ;
 QUIT
 ;

SYNDHP99
SYNDHP99 ; HC/art - HealthConcourse - retrieve VistA data for a resource id ;08/29/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
GETREC(RETSTR,RESID) ; Get VistA record for Resource ID
 ;Inputs: RETSTR - return string, by reference
 ;        RESID  - resource id - V_site_file#_record#
 ;Output: RETSTR - VistA record as a JSON string
 ;              or error message
 ;
 S ^TMP("ZZZ")=RESID_"^333"
 new D set D="-"
 new P set P="|"
 set DUZ=$$DUZ^SYNDHP69
 set RETSTR=""
 ;
 ;check parameter
 if $g(RESID)="" set RETSTR=$$ERRMSG("resourceId is null",RESID) QUIT
 if $e(RESID)'="V" set RETSTR=$$ERRMSG("this is not a VistA resourceId",RESID) QUIT
 if $p(RESID,D,2)'=DUZ(2) set RETSTR=$$ERRMSG("this is not the site requested",RESID) QUIT
 if +$p(RESID,D,3)=0 set RETSTR=$$ERRMSG("the file number must be numeric",RESID) QUIT
 if +$p(RESID,D,4)=0 set RETSTR=$$ERRMSG("the record number must be numeric",RESID) QUIT
 ;
 ;load file array
 new IDX,FILES,VFILES,FNBR,EP,FNAME
 for IDX=1:1 set FILES=$p($t(FILELIST+IDX),";;",2) QUIT:FILES="zzzzz"  do
 . set FNBR=$p(FILES,P,1)
 . set EP=$p(FILES,P,2)
 . set FNAME=$p(FILES,P,3)
 . set VFILES(FNBR)=EP_P_FNAME
 I $G(DEBUG) W $$ZW^SYNDHPUTL("VFILES")
 ;
 new FILE,RECORD
 set FILE=$p(RESID,D,3)
 set RECORD=$p(RESID,D,4)
 if '$d(VFILES(FILE)) set RETSTR=$$ERRMSG("this file is currently not supported",RESID) QUIT
 set:FILE=2.98 RECORD=+$O(^DPT(RECORD,"S",0))_","_RECORD_","
 if $$GET1^DIQ(FILE,RECORD_",",.01,"I")="" set RETSTR=$$ERRMSG("the record was not found",RESID) QUIT
 set RECORD=$p(RESID,D,4)
 ;
 new GETTER,GETTERR
 set GETTER=$p($g(VFILES(FILE)),P,1)
 if GETTER="" set RETSTR=$$ERRMSG("fatal internal error",RESID) QUIT
 new ARRAY
 set GETTERR=GETTER_"(.ARRAY,RECORD,""J"",.RETSTR)"
 set:GETTER="GET1HLF^SYNDHP15" GETTERR=GETTER_"(.ARRAY,RECORD,0,""J"",.RETSTR)"
 do @GETTERR
 ;d:GETTER="GET1HLF^SYNDHP15" ^ZTER
 ;
 QUIT
 ;
ERRMSG(MESSAGE,RESID) ;
 QUIT "{""error"":{""code"":500,""message"":""REST API Error - "_MESSAGE_""",""request"":""DHPGETRESID?RESID="_RESID_"""}}"
 ;
FILELIST ;file#|GETer routine|file name
 ;;2|GETPATIENT^SYNDHP20|Patient
 ;;2.98|GETPATAPPT^SYNDHP25|Patient Appointments
 ;;4|GET1SITE^SYNDHP10|Institution
 ;;26.13|GET1FLAG^SYNDHP17|PRF Assignment (flags)
 ;;44|GETHLOC^SYNDHP22|Hospital location
 ;;52|GET1PATRX^SYNDHP28|Prescription
 ;;55|GETPHPAT^SYNDHP30|Pharmacy Patient
 ;;63|GETLABS^SYNDHP21|Lab Data
 ;;70|GET1RADPAT^SYNDHP27|Rad/Nuc Med Patient
 ;;74|GET1RADRPT^SYNDHP29|Rad/Nuc Med Reports
 ;;120.5|GET1VITALS^SYNDHP16|GMRV Vital Measurement
 ;;120.8|GET1ALLERGY^SYNDHP16|Patient Allergies
 ;;124.3|GET1GMR^SYNDHP15|GMR Text
 ;;130|GET1SURG^SYNDHP31|Surgery
 ;;216.8|GET1NCP^SYNDHP15|Nurs Care Plan
 ;;404.51|GET1TEAM^SYNDHP18|Team
 ;;404.52|ASGNHIST^SYNDHP19|Position Assignment History
 ;;404.53|PRECHIST^SYNDHP19|Preceptor Assignment History
 ;;404.57|TEAMPOS^SYNDHP18|Team Position
 ;;404.58|GET1TEAM^SYNDHP18|Team History
 ;;404.59|TEAMPOS^SYNDHP18|Team Position History
 ;;601.84|GET1MHADM^SYNDHP26|MH Administrations
 ;;601.85|GET1MHANS^SYNDHP26|MH Answers
 ;;601.92|GET1MHRES^SYNDHP26|MH Results
 ;;627.8|GET1MHDX^SYNDHP17|Diagnostic Report-Mental Health
 ;;8925|GET1TIU^SYNDHP24|TIU Document
 ;;9000010|GET1VISIT^SYNDHP13|Visit
 ;;9000010.06|GET1VPROV^SYNDHP23|V Provider
 ;;9000010.07|GET1VPOV^SYNDHP13|V POV
 ;;9000010.11|GET1IMMUN^SYNDHP12|V Immunization
 ;;9000010.18|GET1VCPT^SYNDHP14|V CPT
 ;;9000010.23|GET1HLF^SYNDHP15|V Health Factors
 ;;9000010.71|GET1VSCODE^SYNDHP14|V Standard Codes
 ;;9000011|GET1PROB^SYNDHP11|Problem
 ;;zzzzz
 ;
T1 ;
 N RESID S RESID="V-500-9000010-34494"
 N RETSTA
 D GETREC(.RETSTA,RESID)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;
T2 ;
 N RESID S RESID="V-500-2.98-24"
 N RETSTA
 D GETREC(.RETSTA,RESID)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
 QUIT
 ;

SYNDHPGEN
SYNDHPGEN ; HC/art - code generator ;08/23/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;
 ;
 quit
 ;
GEN(RTN,ID,FILES) ; generate GETer code for a file
 ;inputs: ID - file name or abbreviation
 ;        FILES  - array of file numbers, by reference
 ;             FILES(1)=file number of file to extract
 ;             FILES(n)=file number^multiple level
 ;output: RTN - returned array of generated code, by reference
 ;        /tmp/genCode.txt - generated code (also written to the terminal screen)
 ;
 i $g(ID)="" w "0^ID is not defined",! quit
 i $g(FILES(1))="" w "0^FILES is not defined",! quit
 ;
 n IDtitle S IDtitle=$$TITLE^XLFSTR(ID)
 n cnt s cnt=0
 n fileCnt s fileCnt=0
 ; header
 s RTN(1)="GET1"_ID_"("_ID_","_ID_"IEN,RETJSON,"_ID_"J) ;get one "_IDtitle_" record"
 s RTN(2)=" ;inputs: "_ID_"IEN - "_IDtitle_" IEN"
 s RTN(3)=" ;        RETJSON - J = Return JSON"
 s RTN(4)=" ;output: "_ID_"  - array of "_IDtitle_" data, by reference"
 s RTN(5)=" ;        "_ID_"J - JSON structure of "_IDtitle_" data, by reference"
 s RTN(6)=" ;"
 ; initialization
 s RTN(7)=" I $G(DEBUG) W !,""--------------------------- "_IDtitle_" -----------------------------"",!"
 s RTN(8)=" N S S S=""_"""
 s RTN(9)=" N SITE S SITE=$P($$SITE^VASITE,""^"",3)"
 s cnt=10
 n i s i=""
 f  s i=$o(FILES(i)) q:i=""  d
 . s RTN(cnt)=" N FNBR"_i_" S FNBR"_i_"="_+FILES(i)_" ;"_$o(^DD(+FILES(i),0,"NM",""))
 . s cnt=cnt+1
 . s fileCnt=i
 s RTN(cnt)=" N IENS1 S IENS1="_ID_"IEN_"","""
 s cnt=cnt+1
 s RTN(cnt)=" ;"
 s cnt=cnt+1
 ; read record
 s RTN(cnt)=" N "_ID_"ARR,"_ID_"ERR"
 s cnt=cnt+1
 s RTN(cnt)=" D GETS^DIQ(FNBR1,IENS1,""**"",""EI"","""_ID_"ARR"","""_ID_"ERR"")"
 s cnt=cnt+1
 s RTN(cnt)=" I $G(DEBUG) W !,$$ZW^SYNDHPUTL("""_ID_"ARR"")"
 s cnt=cnt+1
 s RTN(cnt)=" I $G(DEBUG),$D("_ID_"ERR) W !,"">>ERROR<<"" W !,$$ZW^SYNDHPUTL("""_ID_"ERR"")"
 s cnt=cnt+1
 s RTN(cnt)=" I $D("_ID_"ERR),"_ID_"ERR(""DIERR"",1)=601 D  QUIT"
 s cnt=cnt+1
 s RTN(cnt)=" . S "_ID_"("""_IDtitle_""",""ERROR"")="_ID_"IEN"
 s cnt=cnt+1
 s RTN(cnt)=" . D:$G(RETJSON)=""J"" TOJASON^SYNDHPUTL(."_ID_",."_ID_"J)"
 s cnt=cnt+1
 s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_$$LOW^XLFSTR(ID)_"Ien"")="_ID_"IEN"
 s cnt=cnt+1
 s RTN(cnt)=" S "_ID_"("""_IDtitle_""",""resourceType"")=""xxxx"""
 s cnt=cnt+1
 s RTN(cnt)=" S "_ID_"("""_IDtitle_""",""resourceId"")=$$RESID^SYNDHP69(""V"",SITE,FNBR1,"_ID_"IEN)"
 s cnt=cnt+1
 ; populate array of field values
 n fields
 d meta^SYNDHPUTL(.fields,+FILES(1))
 n fieldNameCC,fieldType
 n field s field=""
 f  s field=$o(fields(field)) quit:field=""  d
 . s fieldNameCC=$p(fields(field),U,2)
 . s fieldType=$p(fields(field),U,3)
 . i fieldType'="M" D
 . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""E""))"
 . . s cnt=cnt+1
 . . i fieldType="P" d  ;pointer
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
 . . . s cnt=cnt+1
 . . i fieldType="V" d  ;variable pointer
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
 . . . s cnt=cnt+1
 . . i fieldType="S" d  ;set of codes
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"Cd"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
 . . . s cnt=cnt+1
 . . i fieldType="D" d  ;date
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"FM"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
 . . . s cnt=cnt+1
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"HL7"_""")=$$FMTHL7^XLFDT($G("_ID_"ARR(FNBR1,IENS1,"_field_",""I"")))"
 . . . s cnt=cnt+1
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"FHIR"_""")=$$FMTFHIR^SYNDHPUTL($G("_ID_"ARR(FNBR1,IENS1,"_field_",""I"")))"
 . . . s cnt=cnt+1
 ; multiples
 n multName1
 n i s i=1
 f  s i=$o(FILES(i)) q:i=""  d
 . s RTN(cnt)=" ;"
 . s cnt=cnt+1
 . s multName1=$$camelCase^SYNDHPUTL($o(^DD(+FILES(i),0,"NM","")))
 . s RTN(cnt)=" N IENS"_i_" S IENS"_i_"="""""
 . s cnt=cnt+1
 . s RTN(cnt)=" F  S IENS"_i_"=$O("_ID_"ARR(FNBR"_i_",IENS"_i_")) QUIT:IENS"_i_"=""""  D"
 . s cnt=cnt+1
 . n fields
 . d meta^SYNDHPUTL(.fields,+FILES(i))
 . n field s field=""
 . f  s field=$o(fields(field)) quit:field=""  d
 . . s fieldNameCC=$p(fields(field),U,2)
 . . s fieldType=$p(fields(field),U,3)
 . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""E""))"
 . . s cnt=cnt+1
 . . i fieldType="P" d  ;pointer
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
 . . . s cnt=cnt+1
 . . i fieldType="V" d  ;variable pointer
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
 . . . s cnt=cnt+1
 . . i fieldType="S" d  ;set of codes
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"Cd"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
 . . . s cnt=cnt+1
 . . i fieldType="D" d  ;date
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"FM"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
 . . . s cnt=cnt+1
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"HL7"_""")=$$FMTHL7^XLFDT($G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I"")))"
 . . . s cnt=cnt+1
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"FHIR"_""")=$$FMTFHIR^SYNDHPUTL($G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I"")))"
 . . . s cnt=cnt+1
 . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_",""resourceId"")=$$RESID^SYNDHP69(""V"",SITE,FNBR1,"_ID_"IEN,FNBR"_i_"_U_+IENS"_i_")"
 . s cnt=cnt+1
 ; tail
 s RTN(cnt)=" ;"
 s cnt=cnt+1
 s RTN(cnt)=" I $G(DEBUG) W !,$$ZW^SYNDHPUTL("""_ID_""")"
 s cnt=cnt+1
 s RTN(cnt)=" ;"
 s cnt=cnt+1
 s RTN(cnt)=" D:$G(RETJSON)=""J"" TOJASON^SYNDHPUTL(."_ID_",."_ID_"J)"
 s cnt=cnt+1
 s RTN(cnt)=" ;"
 s cnt=cnt+1
 s RTN(cnt)=" QUIT"
 s cnt=cnt+1
 s RTN(cnt)=" ;"
 ;
 ; write the code
 n os s os=+$$GETOS^SYNDHPUTL()
 n dir s dir=""
 i os=1 s dir="[temp]"
 i os=2 s dir="c:\tmp"
 i os=3 s dir="/tmp"
 i dir="" w "Could not determine OS.",! quit
 i '$$OPEN^SYNDHPUTL("outFile",dir,"genCode.txt","W") w "Could not open output file.",! quit
 n i s i=""
 f  s i=$o(RTN(i)) quit:i=""  d
 . u 0 w RTN(i),!
 . u IO w RTN(i),!
 d CLOSE^SYNDHPUTL("outFile")
 quit
 ;
 ;>>>>>>>>>>> sample code for multiples, first & second levels coded above <<<<<<<<<<<<<
 ;
 S PROBLEM("Problem","shipboardHazardDefense")=$G(PROBARR(FNBR1,IENS,1.18,"E"))
 N IENS2 S IENS2=""
 F  S IENS2=$O(PROBARR(FNBR2,IENS2)) QUIT:IENS2=""  D
 . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"resourceId")="V_"_SITE_S_FNBR1_S_PROBIEN_S_FNBR2_S_+IENS2
 . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"noteFacilityId")=$G(PROBARR(FNBR2,IENS2,.01,"I"))
 . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"noteFacility")=$G(PROBARR(FNBR2,IENS2,.01,"E"))
 . N IENS3 S IENS3=""
 . F  S IENS3=$O(PROBARR(FNBR3,IENS3)) QUIT:IENS3=""  D
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"resourceId")="V_"_SITE_S_FNBR1_S_PROBIEN_S_FNBR2_S_+IENS2_S_FNBR3_S_+IENS3
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"noteNmbr")=$G(PROBARR(FNBR3,IENS3,.01,"E"))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"noteNarrative")=$G(PROBARR(FNBR3,IENS3,.03,"E"))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"statusCd")=$G(PROBARR(FNBR3,IENS3,.04,"I"))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"status")=$G(PROBARR(FNBR3,IENS3,.04,"E"))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAdded")=$G(PROBARR(FNBR3,IENS3,.05,"E"))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAddedFM")=$G(PROBARR(FNBR3,IENS3,.05,"I"))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAddedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR3,IENS3,.05,"I")))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAddedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR3,IENS3,.05,"I")))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"authorId")=$G(PROBARR(FNBR3,IENS3,.06,"I"))
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"author")=$G(PROBARR(FNBR3,IENS3,.06,"E"))
 ;

SYNDHPIC
SYNDHPIC ;AFHIL DHP/fjf - HealthConcourse - get ICNs list ; 06 Jun 2019  5:27 PM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 Q
 ;
ICNS(RETSTA,DHPCNT,DHPJSON,DHPRND) ; list some or all ICNs in a namespace
 ;
 ; Input:
 ;   DHPCNT  - Number of ICN's to return
 ;               nn - Integer
 ;               A  - all (default)
 ;   DHPJSON - Return format
 ;               J for JSON (default)
 ;               T for plain text
 ;   DHPRND -  Random selection of ICN's from target system
 ;               R for random selection of ICN's
 ;               O for first n (DHPCNT) ICN's in index (default)
 ;
 ; Output:
 ;   ICN's in JSON format, or
 ;   ICN's in semicolon delimited text string
 ;
 ;
 N ICNAR,JSICNS,ICN,N,I,ICNSTR
 S DHPCNT=$G(DHPCNT)
 S DHPCNT=$S(+DHPCNT>0:DHPCNT,1:"A")
 S DHPJSON=$G(DHPJSON,"J")
 S DHPRND=$G(DHPRND,"O")
 ; next line because random not consistent with all
 I DHPCNT="A",DHPRND="R" S DHPRND="O"
 S ICN=""
 I DHPRND'="R" F I=1:1 S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  Q:DHPCNT'="A"&(I>DHPCNT)  D
 .S ICNAR(ICN)=""
 I DHPRND="R" D RNDICN(DHPCNT)
 ;
 I DHPJSON="J" D
 .; put ICN array into json format
 .D ENCODE^XLFJSON("ICNAR","JSICNS")
 .; merge array elements into one string
 .S (ICNSTR,N)="" F  S N=$O(JSICNS(N)) Q:N=""  S ICNSTR=ICNSTR_JSICNS(N)
 I DHPJSON'="J" D
 .S (ICNSTR,N)="" F  S N=$O(ICNAR(N)) Q:N=""  S ICNSTR=ICNSTR_N_";"
 S RETSTA=ICNSTR
 Q
 ;
RNDICN(CNT) ; pick a random assortment of CNT ICN's
 N ICN,I,TOT,SUB,LIST
 S ICN=""
 F I=1:1 S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
 .S ICN(I)=ICN
 S TOT=I-1
 I CNT>TOT S CNT=TOT
 K LIST
 F I=1:1:CNT D
 .S SUB=$R(TOT)+1
 .I $D(LIST(SUB)) S I=I-1 Q
 .S LIST(SUB)=ICN(SUB)
 .K ICN(SUB)
 ;
 S SUB=""
 F  S SUB=$O(LIST(SUB)) Q:SUB=""  D
 .S ICNAR(LIST(SUB))=""
 Q
 ;
 ;
TEST ; tests
T1 ; count
 F FT="T","J","" D
 .S CT=3
 .F RN="O","R","" D
 ..D ICNS(.ZXC,CT,FT,RN)
 ..W !!!,$$ZW^SYNDHPUTL("ZXC")
 Q
T2 ; all
 F FT="T","J","" D
 .S CT="A"
 .D ICNS(.ZXC,"T")
 .W !!!,$$ZW^SYNDHPUTL("ZXC")
 Q

SYNDHPMP
SYNDHPMP ; AFHIL/FJF - HealthConcourse - terminology mapping ;03/26/2019
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 10
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
MAP(MAP,CODE,DIR,IOE) ; Return a mapped code for a given code
 ; 
 ;--------------------------------------------------------------------
 ;
 ; Input:
 ;   MAP - mapping to be used
 ;       currently the maps implemented are "sct2icd" (5/18/2018)
 ;                                          "sct2cpt" (9/07/2018)
 ;                                          "sct2icdnine" (8/28/2018)
 ;                                          "mh2loinc" (9/07/2018)
 ;                                          "mh2sct" (9/07/2018)
 ;                                          "sct2hf" (9/07/2018)
 ;                                          "flag2sct" (02/01/2019)
 ;                                          "sct2vit" (02/01/2019)
 ;                                          "ctpos2sct (02/01/2019)
 ;                                          "rxn2ndf" (02/01/2019)
 ;                                          "sct2os5" (02/02/2019)
 ;
 ;   CODE - map source code
 ;   DIR  - direction of mapping
 ;       D for direct (default)
 ;       I for inverse
 ;   IOE  - use internal or exernal mappings
 ;       I for internal SYN VistA(default)
 ;       H for external Health Concourse
 ; 
 ; Output:
 ;   1^map target code
 ;   or -1^exception
 ;
 ; -------------------------------------------------------------------
 ; 
MSTART ;
 ;
 N MAPA,MAPJ,MAPJ8,NODE,STA,RET,DOI,TAR,URL,C,P,SUB
 S U="^",C=":",P="|"
 S IOE=$S($G(IOE)="":"I",1:IOE)
 I "|I|H|"'[(P_IOE_P) Q -1_U_"invalid IOE parameter"
 S STA=1
 I IOE'="I" D  Q STA_U_TAR
 .; call the terminology server
 .S RET=$$GETURL^XTHC10($$TRMURL(IOE),,"MAPJ")
 .; check status of web call
 .I +RET'=200 S STA=-1,TAR=+RET_C_$P(RET,U,2) Q
 .; check for result returned from exernal server
 .; change numbers in valueString attribute to string
 .D NTS("MAPJ")
 .; decode the JSON into M array 
 .D DECODE^XLFJSON("MAPJ","MAPA")
 .I '$D(MAPA) S STA=-1,TAR="code not mapped" Q
 .; convert the number_" " back to a number
 .D RMS("MAPA")
 .S NODE="MAPA",TAR=""
 .F  S NODE=$Q(@NODE) Q:NODE=""  Q:TAR'=""  D
 ..Q:$QS(NODE,5)'="name"
 ..Q:@NODE'="code"
 ..S TAR=MAPA($QS(NODE,1),$QS(NODE,2),$QS(NODE,3),$QS(NODE,4),"valueString")
 .I TAR="" S STA=-1,TAR="code not mapped" Q
 ;I IOE'="I" Q 1_U_TAR
 ;
 ; if we are here then the caller passed I or null in the IOE parameter
 ;
 N DOI,FN,TAR
 S FN="2002.030"
 S DIR=$G(DIR,"D")
 S DOI=$S(DIR="I":"inverse",1:"direct")
 I '$D(^SYN(FN,MAP)) Q "-1^code not mapped"
 I '$D(^SYN(FN,MAP,DOI,CODE)) Q "-1^code not mapped"
 S TAR=$O(^SYN(FN,MAP,DOI,CODE,""))
 I MAP="sct2icd" S TAR=$TR(TAR,"?","A")
 ;W !,"Internal"
 Q 1_U_TAR
 ;
 ;
TRMURL(EXSRV) ; create url of mapping service
 ;
 ; once we have url - infuse it with mapping identifier and source code
 ; currently Health Concourse is only supported external server
 ; for additional servers add appropriate url builder below
 ; 
 ; Health Concourse
 I EXSRV="H" D
 .S URL="https://terminology-service.dev.openplatform.healthcare/vista2/"_MAP_"?searchString="_CODE
 ;
 ; Wolters Kluwer
 ; I EXSRV="W" D
 ; .S URL="https://Wolters Kluwer terminology-service_url with MAP and CODE"
 ;
 Q URL
 ;
MAPR(SURFORM,SFTYPE,MAOR) ; map reactions (SNOMED CT)
 ; map an allergic reaction surface form to an SCT code
 ; Input:
 ;   SURFORM - surface form
 ;   TYPE    - type of surface form
 ;             I - IEN
 ;             T - term
 ;   MAOR    - allergen or reaction
 ;             A - Allergen
 ;             R - Reaction
 ;
 I SURFORM="" Q "-1^Surface form cannot be null"
 I SFTYPE'="I",SFTYPE'="T" Q "-1^Type unrecognised - should be I or T"
 I MAOR'="A",MAOR'="R" Q "-1^Allergy/Reaction indicator unrecognised - should be A or R"
 N RSUB,INDX
 S RSUB=$S(MAOR="A":"ALLERGENS",1:"REACTIONS")
 S INDX=$S(SFTYPE="I":"ICT",1:"TCI")
 I '$D(^SYN("2002.010",RSUB,INDX,SURFORM)) Q "unmapped"
 QUIT $O(^SYN("2002.010",RSUB,INDX,SURFORM,""))
 ;
 ;
TEST ; tests
 ;
T1(code) ; SNOMED CT to ICD
 ; example SNOMED CT codes 37739004,37657006
 n csys,intext,dirinv
 f csys="sct2icd","sct2icdnine" d
 .f intext="I","H" d
 ..f dirinv="D" d
 ...w !,csys," code ",code," ",$s(intext="I":"Internal",1:"External")
 ...w !,$$MAP(csys,code,dirinv,intext)
 Q
 ;
T2(code) ; mental health to SNOMED CT
 ; example mental health codes PHQ-2,PHQ9,2
 n csys,intext,dirinv
 f csys="mh2sct" d
 .f intext="I","H" d
 ..f dirinv="D" d
 ...w !,csys," code ",code," ",$s(intext="I":"Internal",1:"External")
 ...w !,$$MAP(csys,code,dirinv,intext)
 Q
T3 ; new server (vista2) tests
 ;
T3V ;
 K
 ; sct2icd vista
 S URLSV="https://terminology-service.dev.openplatform.healthcare/vista/sct2icd?searchString=37739004"
 S RET=$$GETURL^XTHC10(URLSV,,"MAPSV")
 D DECODE^XLFJSON("MAPSV","MAPSVO")
 ; mh2sct vista
 S URLMV="https://terminology-service.dev.openplatform.healthcare/vista/mh2sct?searchString=PHQ-2"
 S RET=$$GETURL^XTHC10(URLMV,,"MAPMV") 
 D DECODE^XLFJSON("MAPMV","MAPMVO")
 ;
 W !,URLSV,!!
 ZW MAPSVO
 w !!,URLMV,!!
 ZW MAPMVO
 ;
 Q
 ;
T4V ;
 K
 ; sct2icd vista2
 S URLSV="https://terminology-service.dev.openplatform.healthcare/vista2/sct2icd?searchString=37739004"
 S RET=$$GETURL^XTHC10(URLSV,,"MAPSV")
 ; now scan json in MPASV to find string that look like numbers
 ; and convert them to strings by concateneating space
 D NTS("MAPSV")
 ; 
 D DECODE^XLFJSON("MAPSV","MAPSVO")
 ; now that json decodon complete remove space
 ;D RMS("MAPSVO")
 ; mh2sct vista
 S URLMV="https://terminology-service.dev.openplatform.healthcare/vista2/mh2sct?searchString=PHQ-2"
 S RET=$$GETURL^XTHC10(URLMV,,"MAPMV")
 ; now scan json in MPAMV to find string that look like numbers
 ; and convert them to strings by concatenating space
 D NTS("MAPMV")
 ;
 D DECODE^XLFJSON("MAPMV","MAPMVO")
 ;
 W !,URLSV,!!
 ZW MAPSVO
 w !!,URLMV,!!
 ZW MAPMVO
 ;
 Q
NTS(JSONA) ; change numbers to string to accommodate XTHC10 quirk
 ;
 N N,VALUE
 S N=JSONA
 F  S N=$Q(@N) Q:N=""  D
 .Q:@N'["valueString"
 .S VALUE=$P($P(@N,":",2),"""",2)
 .Q:VALUE'?1N.N
 .S VALUE=VALUE_" "
 .S $P(@N,"""",4)=VALUE
 Q
RMS(JSONA) ; convert numeric string to a number
 ;
 N N,VALUE
 S N=JSONA
 F  S N=$Q(@N) Q:N=""  D
 .Q:N'["valueString"
 .S VALUE=@N
 .Q:VALUE'?1N.N1" "
 .S VALUE=+VALUE
 .S @N=VALUE
 Q
 

SYNDHPPRV
SYNDHPPRV ; Set up provider NPI in file 200
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;
 ;
CTRL ;
 S FN=200,N=0,NPI=999000000
 F  S N=$O(^VA(FN,N)) Q:+N=0  D
 .Q:$$GET1^DIQ(FN,N_",","NPI")'=""
 .S NPI=$I(NPI)
 .S NPIWCD=NPI_$$CKDIGIT^XUSNPI(NPI)
 .N FDA
 .S FDA(FN,N_",","NPI")=NPIWCD
 .D FILE^DIE("","FDA")
 .W !,N,"   -   ",NPIWCD
 Q

SYNDHPTS1
SYNDHPTS1 ;AFHIL DHP/fjf/art - HealthConcourse - DHP REST handlers ;16/25/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;
 ;
CTRL ;
 ;
 D GTCALLS
 S DHPFRDAT=18401231
 S DHPTODAT=20501231
 S DHPJSON=""
 S DHPICN="" F  S DHPICN=$O(^DPT("AFICN",DHPICN)) Q:DHPICN=""  D
 .;W !,DHPICN Q
 .;D PATLABI
 .;I RETSTA["2000-8" W !!!!!! W $$ZW^SYNDHPUTL("RETSTA")
 .;Q
 .S CALL=""
 .F  S CALL=$O(CALLS(CALL)) Q:CALL=""  D
 ..;W !,"Before ",$G(CALL),! ;R *R
 ..;ZW  ;R !,ZZXC
 ..;W !!,"Still before",! ;R *R
 ..K RETSTA
 ..D @CALL
 ..W !!!! W $$ZW^SYNDHPUTL("RETSTA")
 Q
GTCALLS ; set up call list
 F I=1:1 Q:$T(+I)=""  D
 .S LOC=$T(+I)
 .I $P(LOC," ")'="",$E(LOC,1,3)="PAT" S CALLS($P(LOC," "))=""
 Q
 ;
PATDEMI ; get patient demographics for one patient
 ;
 D PATDEMI^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
 Q
 ;
PATCONI ; get patient conditions for one patient by ICN
 ;
 D PATCONI^SYNDHP03(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
 ;
PATENCI ; get patient encounters for one patient by ICN
 ;
 D PATENCI^SYNDHP40(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
 ; --------------------------------------------------
 ;
PATMEDS ; get patient medication statement for one patient by ICN
 ;
 D PATMEDS^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
PATMEDA ; get patient medication administration for one patient by ICN
 ;
 D PATMEDA^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
PATMEDD ; get patient medication dispense for one patient by ICN
 ;
 D PATMEDD^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
PATVITI ; get patient vitals for one patient by ICN
 ;
 D PATVITI^SYNDHP01(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATHLFI ; get patient health factors for one patient
 ;
 D PATHLFI^SYNDHP09(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATPRCI ; get patient procedures for one patient
 ;
 D PATPRCI^SYNDHP04(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
PATALLI ; get patient allergies for one patient by ICN
 ;
 D PATALLI^SYNDHP57(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
 ;
PATDXREP ; get patient diagnostic report for one patient by ICN
 ;
 D PATDXRI^SYNDHP05(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATLABI ; get patient labs for one patient
 ;
 D PATLABI^SYNDHP53(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
PATPRVI ; get patient encounter providers for one patient
 ;
 D PATPRVI^SYNDHP54(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATAPTI ; get patient appointments for one patient
 ;
 D PATAPTI^SYNDHP41(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
PATFLGI ; get patient flags for one patient
 ;
 D PATFLGI^SYNDHP08(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATIMMI ; get patient immunizations for one patient
 ;
 D PATIMMI^SYNDHP02(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATGOLI ; get patient goals for one patient
 ;
 D PATGOLI^SYNDHP07(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATOBSI ; get patient observations for one patient
 ;
 D PATOBSI^SYNDHP56(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;
PATCPALLI ; get all care plans for a patient
 ;
 D PATCPALLI^SYNDHP59(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
 Q
 ;
PATCPI ; get one care plan for a patient
 ;
 ; need DHPVRESID for this call
 ;D PATCPI^SYNDHP59(.RETSTA,DHPICN,DHPVRESID,DHPJSON)
 Q
PATTIUI ; get patient notes for one patient by ICN
 ;
 D PATTIUI^SYNDHP67(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
 Q
 ;

SYNDHPUTL
SYNDHPUTL ; HC/art - HealthConcourse - various utilities ;2019-11-04  5:49 PM
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 ; (c) OSEHRA 2019
 ; (c) Perspecta 2017-2019
 ; ZWRITE implementation (c) Sam Habiel 2019
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 QUIT
 ;
TOJASON(ARRAY,JSONSTR) ;convert input array to JSON string
 ;input:  ARRAY - input array
 ;output: JSONSTR - JSON string
 ;ZEXCEPT: DEBUG
 ;
 N ERR,TMP
 D ENCODE^XLFJSON("ARRAY","TMP","ERR")
 I $G(DEBUG),$D(ERR) W !,">>ERROR<<" W $$ZW("ERR")
 I $G(DEBUG) W ! W $$ZW("TMP")
 ;
 S JSONSTR=""
 N IDX S IDX=""
 F  S IDX=$O(TMP(IDX)) QUIT:IDX=""  D
 . S JSONSTR=JSONSTR_$G(TMP(IDX))
 I $G(DEBUG) W ! W $$ZW("JSONSTR")
 ;
 QUIT
 ;
TOFHIR(ARRAY,FHIRARRAY) ;create FHIR tagged array from input array
 ;input:  ARRAY - input array
 ;output: FHIRARRAY - FHIR array
 ;
 ;
 QUIT
 ;
meta(fields,fileNbr) ;return field metadata
 ;input: fileNbr - file number
 ;output: fields - return array
 ;        fields(fieldNbr)=fieldName^fieldNameCC^fieldType^fieldValueSet^pointsTo
 ;ZEXCEPT: DEBUG
 ;
 n node0,fieldName,fieldNameCC,fieldType,fieldValueSet,pointsTo
 n fieldNbr s fieldNbr=0
 f  s fieldNbr=$o(^DD(fileNbr,fieldNbr)) quit:'+fieldNbr  d
 . s node0=^DD(fileNbr,fieldNbr,0)
 . s fieldName=$p(node0,U,1)
 . s fieldNameCC=$$camelCase(fieldName)
 . s fieldType=$p(node0,U,2)
 . s fieldType=$s(+fieldType:"M",fieldType["P":"P",fieldType["F":"F",fieldType["D":"D",fieldType["N":"N",fieldType["S":"S",fieldType["C":"C",fieldType["V":"V",1:"")
 . s fieldValueSet=$s(fieldType="S":$p(node0,U,3),1:"")
 . s pointsTo=$s(fieldType="P":+$p($p(node0,U,2),"P",2),1:"")
 . s fields(fieldNbr)=fieldName_U_fieldNameCC_U_fieldType_U_fieldValueSet_U_pointsTo_U
 ;
 i $g(DEBUG) w !,"fields",! W $$ZW("fields")
 ;
 QUIT
 ;
camelCase(x) ;return a string in camel case
 ;input: x - string
 ;return: camel case string
 ;
 s x=$tr(x,"`-=[]\;',./~!@#$%^&*()_+{}|:""<>?","                                 ") ;eol is out here
 s x=$$TITLE^XLFSTR(x)
 s $p(x," ",1)=$$LOW^XLFSTR($p(x," ",1))
 s x=$$STRIP^XLFSTR(x," ")
 ;
 QUIT x
 ;
PATLIST ;Get list of patients from %wd graph
 ;
 N IEN,DFN,ICN,NAME
 W !,"Patient Name",?33,"Graph IEN",?45,"DFN",?55,"ICN",!
 S IEN=0
 F  S IEN=$O(^%wd(17.040801,1,IEN)) QUIT:'+IEN  DO
 . S DFN=$$ien2dfn^SYNFUTL(IEN)
 . S ICN=$$ien2icn^SYNFUTL(IEN)
 . S NAME=$$GET1^DIQ(2,DFN_",",.01)
 . W NAME,?35,IEN,?45,DFN,?55,ICN,!
 QUIT
 ;
GETOS() ;
 ;Determine OS
 NEW ZZOS
 SET ZZOS=$$OS^%ZOSV()
 SET ZZOS=$SELECT(ZZOS["VMS":"1-VMS",ZZOS["NT":"2-MSW",ZZOS["UNIX":"3-LINUX",1:"0-")
 ;W !,ZZOS,!
 QUIT ZZOS
 ;
OPEN(ZZFILE,ZZDIR,ZZFILENM,ZZMODE) ;Open a File
 ; Inputs - ZZFILE - File tag to open
 ;          ZZDIR - Host File Directory Name
 ;          ZZFILENM - File Name
 ;          ZZMODE - Open mode - R=Read, W=Write, A=Append
 ; Output - 1 if file was opened
 ;          0 if not opened
 ;          IO - opened device designator
 ;
 NEW POP
 DO OPEN^%ZISH(ZZFILE,ZZDIR,ZZFILENM,ZZMODE)
 IF POP DO  QUIT 0
 . USE 0
 . WRITE !,"ERROR: Could not open the file: ",ZZDIR,"\",ZZFILENM,!
 . WRITE "       Ensure the directory name is valid.",!
 QUIT 1
 ;
CLOSE(ZZFILE) ;Close a File
 ; Input  - ZZFILE - File tag to close
 ; Output - none
 ;
 DO CLOSE^%ZISH(ZZFILE)
 QUIT
 ;
EOF() ;Test for EOF
 ; Input  - none
 ; Output - 1 if end of file has been reached
 ;
 QUIT $$STATUS^%ZISH
 ;
RANGECK(DATE,FROMDATE,TODATE,REV) ;Check date range
 ;Inputs: DATE - date to be compared
 ;        FROMDATE - begining of range
 ;        TODATE - end of range
 ;        REV    - Should we exclude if found?
 ;Returns: 0 - date is outside of requested date range
 ;         1 - date is within requested date range, null dates are not checked
 ;
 S REV=$G(REV,0)
 N RESULT
 IF (DATE'="")&((DATE\1)<FROMDATE)!((DATE\1)>TODATE) S RESULT=0  ;date is outside of requested date range
 E  S RESULT=1
 I REV Q 'RESULT
 Q RESULT
 ;
SETFRTO(FHIRDATE,FRDATE,TODATE,REVDATE) ; [Public] Set FROMDATE/TODATE for call above
 ; Input: FHIRDATE  - Fhir Date Expression (plain or with eq/ne/lt/gt/ge/le/ap)
 ; Output: .FROMDATE - From Date
 ;         .TODATE   - To Date
 ;         .REVDATE  - Should filter be reversed?
 ;          Sets HTTPERR if Date is invalid
 ;
 n prefix s prefix=""
 n date s date=""
 n hasPrefix s hasPrefix=$E(FHIRDATE,1,2)?2A
 i hasPrefix s prefix=$E(FHIRDATE,1,2),date=$E(FHIRDATE,3,99)
 e  s date=FHIRDATE
 i hasPrefix,"^eq^ne^lt^gt^ge^le^ap^"'[(U_prefix_U) D ERRMSG(400,"Invalid Date Prefix") QUIT
 ;
 ; Convert to FM Date
 n fmdate s fmdate=$$HL7TFM^XLFDT($tr(date,"-"))
 i fmdate=-1 D ERRMSG^SYNDHPUTL(400,"Invalid Date") QUIT
 ;
 ; Inexact Date?
 n inexactMonth,inexactDay
 s (inexactMonth,inexactDay)=0
 i $e(fmdate,4,5)="00" s inexactMonth=1
 i $e(fmdate,6,7)="00" s inexactDay=1
 ;
 ; Now set from and to for base case
 i 'inexactMonth,'inexactDay S FRDATE=fmdate,TODATE=fmdate+1-.000001       ; Add day (30/31 no matter as this is only for range checking)
 i inexactDay,'inexactMonth  S FRDATE=fmdate,TODATE=fmdate+100-.000001     ; Add month
 i inexactMonth              S FRDATE=fmdate,TODATE=fmdate+10000-.000001   ; Add year
 ;
 ; Adjust for prefixes
 i prefix="eq"  ; no change
 i prefix="ne" S REVDATE=1 ; reverse condition
 i prefix="lt" S FRDATE=0,TODATE=fmdate-.000001 ; less than, & ends before
 i prefix="gt" S FRDATE=fmdate+1,TODATE=9999999 ; greater than, & starts after
 i prefix="le" S FRDATE=0,TODATE=fmdate                       ; less than or equals
 i prefix="ge" S FRDATE=fmdate,TODATE=9999999                 ; greater than
 i prefix="ap" n diff s diff=fmdate*.001,FRDATE=FRDATE-diff,TODATE=TODATE+diff ; approximately (within 3 months)
 QUIT
 ;
GETDFN(ZZPNAME) ;Get patient's DFN
 ;Inputs - ZZPNAME - Patient name
 ;Returns - Patient DFN
 ;
 QUIT:$GET(ZZPNAME)="" "0^Missing name"
 ;
 NEW ZZDFN,ZZMSG
 SET ZZDFN=$$FIND1^DIC(2,,"BQUX",ZZPNAME,"B",,"ZZMSG")
 ;
 QUIT ZZDFN
 ;
GETIEN(ZZFILE,ZZNAME) ;Get IEN for name
 ;Inputs - ZZFILE - File number
 ;         ZZNAME - name (.01 field)
 ;Returns - IEN
 ;
 QUIT:$GET(ZZFILE)="" "0^Missing file number"
 QUIT:$GET(ZZNAME)="" "0^Missing name"
 ;
 NEW ZZIEN,ZZMSG
 SET ZZIEN=$$FIND1^DIC(ZZFILE,,"BQUX",ZZNAME,"B",,"ZZMSG")
 ;
 QUIT ZZIEN
 ;
UICN(PATIEN) ; ICN for IEN
 ;
 Q $$GET1^DIQ(2,PATIEN_",",991.1)
 ;
ICN(IEN) ; obtain ICN
 N ICN
 S ICN=$$GET1^DIQ(2,IEN_",",991.1)
 I ICN="" D
 . S ICN=$$GET1^DIQ(2,IEN_",",991.01)_"V"_$$GET1^DIQ(2,IEN_",",991.02)
 Q ICN
 ;
UICNVAL(ICN) ; validate ICN
 ; Input: ICN
 ; Returns: 0 - invalid
 ;          1 - valid
 ;
 I $G(ICN)="" Q 0
 I '$D(^DPT("AFICN",ICN)) Q 0
 QUIT 1
 ;
USCTPT(SCT) ; SNOMED CT preferred term
 ;Input: SCT - SNOMED Code
 ;Returns: SCT Preferred Term
 ;
 N LEX,PREF
 S LEX=$$CODE^LEXTRAN(SCT,"SCT")
 S PREF=""
 I $D(LEX("P")) S PREF=LEX("P")
 Q PREF
 ;
DATECNVT(DATE) ;convert DATE to Fileman format
 ;
 I $G(DATE)="" QUIT ""
 N %DT S %DT="T"
 N X S X=DATE
 N Y
 D ^%DT
 QUIT Y
 ;
FMTFHIR(FMDATE) ;Convert Fileman date to FHIR date
 ;Inputs - FMDATE - Fileman date/time
 ;Returns - FHIR Date
 ;
 QUIT:$GET(FMDATE)="" ""
 ;
 NEW FHIRDATE SET FHIRDATE=""
 ;
 I $L(FMDATE)<7 QUIT ""
 I $L(FMDATE)=7 D  QUIT FHIRDATE
 . S FHIRDATE=$E(FMDATE,1,3)+1700_"-"_$E(FMDATE,4,5)_"-"_$E(FMDATE,6,7)
 ;
 N hl7,dtm,tz
 S hl7=$$FMTHL7^XLFDT(FMDATE)
 I hl7="" QUIT ""
 I hl7=-1 QUIT -1
 S dtm=$P(hl7,"-",1)
 S tz="-"_$E($P(hl7,"-",2),1,2)_":"_$E($P(hl7,"-",2),3,4)
 S FHIRDATE=$E(hl7,1,4)_"-"_$E(hl7,5,6)_"-"_$E(hl7,7,8)_"T"_$E(hl7,9,10)_":"_$E(hl7,11,12)_":"_$S(+$E(hl7,13,14)>0:$E(hl7,13,14),1:"00")_tz
 ;
 QUIT FHIRDATE
 ;
CTRLS(X) ; strip control characters
 N I,CTRLS
 S CTRLS=""
 F I=1:1:31,127:1:190 S CTRLS=CTRLS_$C(I)
 Q $TR(X,CTRLS)
 ;
ZW(VAR) ; simulate Cach or GT.M ZW or ZWRITE fuction
 ; VAR - variable to be ZWritten
 ;
 D ZWRITE(VAR)
 QUIT:$Q "" QUIT
 ;
ZWRITE(NAME,QS,QSREP) ; Replacement for ZWRITE ; Public Proc
 ; Pass NAME by name as a closed reference. lvn and gvn are both supported.
 ; QS = Query Subscript to replace. Optional.
 ; QSREP = Query Subscrpt replacement. Optional, but must be passed if QS is.
 ;
 ; : syntax is not supported (yet)
 S QS=$G(QS),QSREP=$G(QSREP)
 I QS,'$L(QSREP) S $EC=",U-INVALID-PARAMETERS,"
 N NL ; new line
 ; E  N CRLF S CRLF=$C(13,10)_",*-3",NL=$NA(CRLF) ; Weirdness b/c we have to @NL.
 N INCEXPN S INCEXPN=""
 I $L(QSREP) S INCEXPN="S $G("_QSREP_")="_QSREP_"+1"
 N L S L=$L(NAME) ; Name length
 I $E(NAME,L-2,L)=",*)" S NAME=$E(NAME,1,L-3)_")" ; If last sub is *, remove it and close the ref
 N ORIGNAME S ORIGNAME=NAME          ;
 N ORIGQL S ORIGQL=$QL(NAME)         ; Number of subscripts in the original name
 I $D(@NAME)#2 W $S(QS:$$SUBNAME(NAME,QS,QSREP),1:NAME),"=",$$FORMAT1(@NAME),! ; Write base if it exists
 ; $QUERY through the name.
 ; Stop when we are out.
 ; Stop when the last subscript of the original name isn't the same as
 ; the last subscript of the Name.
 F  S NAME=$Q(@NAME) Q:NAME=""  Q:$NA(@ORIGNAME,ORIGQL)'=$NA(@NAME,ORIGQL)  D
 . W $S(QS:$$SUBNAME(NAME,QS,QSREP),1:NAME),"=",$$FORMAT1(@NAME),!
 QUIT
 ;
SUBNAME(N,QS,QSREP) ; Substitue subscript QS's value with QSREP in name reference N
 N VARCR S VARCR=$NA(@N,QS-1) ; Closed reference of name up to the sub we want to change
 N VAROR S VAROR=$S($E(VARCR,$L(VARCR))=")":$E(VARCR,1,$L(VARCR)-1)_",",1:VARCR_"(") ; Open ref
 N B4 S B4=$NA(@N,QS),B4=$E(B4,1,$L(B4)-1) ; Before sub piece, only used in next line
 N AF S AF=$P(N,B4,2,99) ; After sub piece
 QUIT VAROR_QSREP_AF
 ;
FORMAT1(V) ; Add quotes, replace control characters if necessary; Public $$
 ;If numeric, nothing to do.
 ;If no encoding required, then return as quoted string.
 ;Otherwise, return as an expression with $C()'s and strings.
 I +V=V Q V       ; If numeric, just return the value.
 N QT S QT=""""   ; Quote
 I $F(V,QT) D     ; chk if V contains any Quotes
 . N P S P=0                  ;position pointer into V
 . F  S P=$F(V,QT,P) Q:'P  D  ;find next "
 . . S $E(V,P-1)=QT_QT        ;double each "
 . . S P=P+1                  ;skip over new "
 I $$CCC(V) D  Q V     ; If control character is present do this and quit
 . S V=$$RCC(QT_V_QT)  ; Replace control characters in "V"
 . S:$E(V,1,3)="""""_" $E(V,1,3)="" ; Replace doubled up quotes at start
 . N L S L=$L(V) S:$E(V,L-2,L)="_""""" $E(V,L-2,L)="" ; Replace doubled up quotes at end
 Q QT_V_QT ; If no control charactrrs, quit with "V"
 ;
CCC(S) ;test if S Contains a Control Character or $C(255); Public $$
 Q:S?.E1C.E 1
 Q:$F(S,$C(255)) 1
 Q 0
 ;
RCC(NA) ;Replace control chars in NA with $C( ). Returns encoded string; Public $$
 Q:'$$CCC(NA) NA                         ;No embedded ctrl chars
 N OUT S OUT=""                          ;holds output name
 N CC S CC=0                             ;count ctrl chars in $C(
 N C255 S C255=$C(255)                   ;$C(255) which Mumps may not classify as a Control
 N C                                     ;temp hold each char
 N I F I=1:1:$L(NA) S C=$E(NA,I) D           ;for each char C in NA
 . I C'?1C,C'=C255 D  S OUT=OUT_C Q      ;not a ctrl char
 . . I CC S OUT=OUT_")_""",CC=0          ;close up $C(... if one is open
 . I CC D
 . . I CC=256 S OUT=OUT_")_$C("_$A(C),CC=0  ;max args in one $C(
 . . E  S OUT=OUT_","_$A(C)              ;add next ctrl char to $C(
 . E  S OUT=OUT_"""_$C("_$A(C)
 . S CC=CC+1
 . Q
 Q OUT
 ;
ICNPAT(ICN) ; patient for ICN
 ; Input: ICN
 ; Returns: 0 - invalid
 ;          ICN^IEN^NAME - valid
 ;
 I $G(ICN)="" Q 0
 I '$D(^DPT("AFICN",ICN)) Q 0
 N PATIEN S PATIEN=$O(^DPT("AFICN",ICN,""))
 N PATNAME S PATNAME=$$GET1^DIQ(2,PATIEN,.01)
 QUIT ICN_U_PATIEN_U_PATNAME
 ;
GETRXN(X) ; [Public] Get RxNorm code for drug IEN
 N ND S ND=$G(^PSDRUG(X,"ND"))
 I ND="" Q ""
 N PROD S PROD=$P(ND,U,3)
 I PROD="" Q
 I '$D(^PSNDF(50.68,PROD,0)) S $EC=",U-CORRUPT-DATA,"
 ;
 ; Try to get using VA asserted map in 50.68 in the Coding multiple (which has a funky format)
 N CODE S CODE=""
 D
 . N CODINGIEN F CODINGIEN=0:0 S CODINGIEN=$O(^PSNDF(50.68,PROD,11,CODINGIEN)) Q:'CODINGIEN  D
 .. N CODING S CODING=$P($G(^PSNDF(50.68,PROD,11,CODINGIEN,0)),U)
 .. I CODING'="RxNorm" QUIT
 .. N CODEIEN S CODEIEN=$O(^PSNDF(50.68,PROD,11,CODINGIEN,1,0))
 .. I 'CODEIEN Q
 .. S CODE=$P($G(^PSNDF(50.68,PROD,11,CODINGIEN,1,CODEIEN,0)),U)
 I CODE Q CODE
 ;
 ; If not, get VUID, and translate from ETS package
 N VUID S VUID=$$GET1^DIQ(50.68,PROD,"99.99")
 N OUT S OUT=$$VUI2RXN^ETSRXN(VUID)
 I OUT<1 QUIT "" ; # of entries or -1 for error.
 S CODE=$P(^TMP("ETSRXN",$J,1,0),U,2)
 Q CODE
 ;
ERRMSG(CODE,MESSAGE) ;
 ; fhir OperationOutcome
 ; ZEXCEPT: HTTPERR
 K ^TMP("HTTPERR",$J)
 S HTTPERR=CODE
 S ^TMP("HTTPERR",$J,1,"resourceType")="OperationOutcome"
 S ^TMP("HTTPERR",$J,1,"issue",1,"severity")="error"
 S ^TMP("HTTPERR",$J,1,"issue",1,"code")="processing"
 S ^TMP("HTTPERR",$J,1,"issue",1,"diagnostics")=MESSAGE
 QUIT:$Q "" QUIT
 ;

SYNDTS89
SYNDTS89 ;AFHIL/HC/fjf - HealthConcourse - REST service tester ;03/28/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ; This routine tests the Health Concourse GETter REST services
 ;
 ; It specifically tests those services that have a request URL in the following format:
 ; http://ip-address-port/endpoint?ICN=icn&JSON=flag
 ; the architecture can be extended to accommodate those REST services
 ; that don't conveniently fit the above pattern
 ;
 ; the routine currently returns the REST call url for json and non-json
 ; plus the relevant data in the appropriate format for the resource
 ;
ctrl(nopats,server) ;
 ; Input:
 ;   nopats - number of patiens per system
 ;     if nopats is not passed or evaluates to 0 then all patiens
 ;     will be tested
 ;   server -
 ;     if server is not defined in url roots then then all servers
 ;     will be tested
 ;
 ;
 ; create array of urls of systems to be tested
 s server=$g(server,"none")
 d urlrts(server)
 ;
 ; create array of patient data endpoints to be tested
 d endpoints
 ;
 ; start of scan by url by patient by endpoint
 s (icn,url,endpoint)=""
 s nopats=$g(nopats)
 s s=";"
 s urlab=""
 f  s urlab=$o(urlrt(urlab)) q:urlab=""  d
 .s url=urlrt(urlab)
 .; find ICN's in namespace denoted by url+port
 .s icns=$$icnstr(url)
 .i +nopats=0 s nopats=$l(icns,s)
 .s icns=$p(icns,s,1,nopats)
 .w !,"icns ",!,icns,!
 .; for namepace (specified by url+port) scan through ICN's
 .s pats=+$g(nopats)
 .i pats=0 s pats=$l(icns,s)
 .f i=1:1:pats s icn=$p(icns,s,i) q:icn=""  d
 ..;for ICN's scan through endpoints
 ..s endpoint=""
 ..f  s endpoint=$o(endpoints(endpoint)) q:endpoint=""  d
 ...f format="","J" d
 ....; build patient getter REST service URL and make call
 ....s RESTurl=$$RESTurl(url,endpoint,icn,,,format)
 ....w !,RESTurl,!
 ....s RET=$$GETURL^XTHC10(RESTurl,,"PDATA")
 ....i RET'="200^OK" w !,RET q
 ....i '$d(PDATA) w !,"no data" q
 ....s datstr=$$xthc2st(.PDATA)
 ....w !,datstr,!
 Q
 ;
icnstr(url) ; create icn string for system at url
 ; invokes DHPPATICNALL service
 ; Input:
 ;   url of system of interest
 ; Ouput:
 ;   semicolon delimited list of ICN's
 ;
 n s,icnurl,RET,icns
 s s=";"
 s icnurl=url_"DHPPATICNALL?JSON=T"
 s RET=$$GETURL^XTHC10(icnurl,,"icnar")
 i RET'="200^OK" q RET
 s icnar=""
 s icns=$$xthc2st(.icnar)
 q icns
 ;
xthc2st(array) ; combines array elements from XTHC10 into a single string
 ; Input
 ;   array passed by reference
 ;
 n string,n,sub
 s sub=$o(array(""))
 s string=array(sub)
 s n=""
 f  s n=$o(array(sub,n)) q:n=""  d
 .s string=string_array(sub,n)
 .k array(sub,n)
 q string
 ;
RESTurl(url,endpoint,icn,fromdt,todt,format) ; create REST service URL
 ;
 s fromdt=$g(fromdt)
 s todt=$g(todt)
 s format=$g(format)
 s url=url_endpoint_"?ICN="_icn
 s:format'="" url=url_"&JSON="_format
 s:fromdt'="" url=url_"&FRDAT="_fromdt
 s:todt'="" url=url_"&TODAT="_todt
 q url
 ;
urlrts(server) ; set up roots urls for healthConcourse dev
 s server=$g(server,"none")
 k urlrt
 n s,t
 s s=";"
 f i=1:1 s t=$t(urlli+i) q:t["urlend"  d
 .s urlrt($p(t,s,4))=$p(t,s,3)
 i $d(urlrt(server)) d
 .s t=urlrt(server)
 .k urlrt
 .s urlrt(server)=t
 q
 ;
urlli ; list of url roots
 ;;http://ec2-18-208-29-125.compute-1.amazonaws.com:8001/;awsdev;                AWS dev
 ;;http://ec2-18-208-29-125.compute-1.amazonaws.com:9080/;awsdevshm;             AWS dev shim
 ;;https://vista.dev.openplatform.healthcare/rgnet-web/;k8dev;                   k8 dev
 ;;https://vista.dev.openplatform.healthcare/vpr-web/;k8devshm;                  k8 dev shim
 ;;https://vista.demo-staging.openplatform.healthcare/rgnet-web/;k8demstag;      k8 demo-staging
 ;;https://vista.demo-staging.openplatform.healthcare/rgnet-web/;k8demstagshm;   k8 demo-staging shim
 ;;https://vista.demo.openplatform.healthcare/rgnet-web/;k8demo;                 k8 demo
 ;;https://vista.demo.openplatform.healthcare/vpr-web/;k8demoshm;                k8 demo shim
 ;;https://vista-general.dev.openplatform.healthcare/rgnet-web/;targen;          tardis general
 ;;https://vista-general.dev.openplatform.healthcare/vpr-web/;targenshm;         tardis general shim
 ;;https://vista-emergency.dev.openplatform.healthcare/rgnet-web/;taremer;       tardis emergency
 ;;https://vista-emergency.dev.openplatform.healthcare/vpr-web/;taremershm;      tardis emergency shim
 ;;https://vista-specialization.dev.openplatform.healthcare/rgnet-web/;tarspec;  tardis specialization
 ;;https://vista-specialization.dev.openplatform.healthcare/vpr-web/;tarspecshm; tardis specialization shim
 ;;http://shadow.vistaplex.org/;shadvplex;                                       GT.M server
 ;;http://syn.vistaplex.org/;synvplex;                                           GT.M server
 ;;http://localhost:8001/;localhost;                                             localhost
 ;;http://localhost:9080/;localhostshm;localhost shim
 ;;https://vista-sync.dev.openplatform.healthcare/rgnet-web/;gold;
 ;;https://vista-sync.dev.openplatform.healthcare/vpr-web/;goldshm;
 ;;urlend
 q
 ;
endpoints ; for patient data by ICN
 ; pattern is DHPPATxxxxxICN
 ;
 n n,s,q,pat
 s n="",s="/",q=""""
 s pat=1_q_"DHPPAT"_q_"2.5e"_1_q_"ICN"_q_".e"
 f  s n=$o(^RGNET(996.52,"B",n)) q:n=""  d
 .i n?@pat s endpoints($p(n,s))=""
 q
 ;;;;
ts ;
 ;
 s url="http://ec2-18-208-29-125.compute-1.amazonaws.com:8001/"
 s endpoint="DHPPATVITICN"
 s icn="9993306312V376330"
 s RESTurl=$$RESTurl(url,endpoint,icn,,,"J")
 s RET=$$GETURL^XTHC10(RESTurl,,"PDATA")
 q

SYNFALG
SYNFALG ;ven/gpl - fhir loader utilities ;Aug 15, 2019@15:24:08
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ; (c) Sam Habiel 2018
 ;
 q
 ;
importAllergy(rtn,ien,args) ; entry point for loading Allergy for a patient
 ; calls the intake Allergy web service directly
 ;
 n grtn
 d wsIntakeAllergy(.args,,.grtn,ien)
 s rtn("allergyStatus","status")=$g(grtn("status","status"))
 s rtn("allergyStatus","loaded")=+$g(grtn("status","loaded"))
 s rtn("allergyStatus","errors")=+$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeAllergy(args,body,result,ien) ; web service entry (post)
 ; for intake of one or more Allergy. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n jtmp,json,jrslt,eval
 ;i $g(ien)'="" if $$loadStatus("allergy","",ien)=1 d  q  ;
 ;. s result("allergytatus","status")="alreadyLoaded"
 i $g(ien)'="" d  ; internal call
 . d getIntakeFhir^SYNFHIR("json",,"AllergyIntolerance",ien,1)
 e  d  ;
 . ;s args("load")=0
 . merge jtmp=BODY
 . do decode^SYNJSONE("jtmp","json")
 ;
 ;i '$d(json) d getRandomAllergy(.json)
 ;
 i '$d(json) q  ;
 m ^gpl("gjson")=json
 ;
 ; determine the patient
 ;
 n dfn,eval
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 . . q:dfn=""
 . . s ien=$$dfn2ien^SYNFUTL(dfn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("allergy",1,"log",1)="Error, patient not found.. terminating"
 ;
 new zi s zi=0
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(eval("allergy",zi))
 . ;
 . ; insure that the resourceType is AllergyIntolerance
 . ;
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
 . if type'="AllergyIntolerance" do  quit  ;
 . . set eval("allergy",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not AllergyIntolerance, skipping entry")
 . set eval("allergy",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("allergy",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Allergy already loaded, skipping")
 . ;
 . ; determine the codesystem of the allergy
 . ;
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set eval("allergy",zi,"vars","codeSystem")=codesystem
 . ;
 . ; if rxnorm, call meds routine
 . ;
 . i codesystem["rxnorm" do  q  ;
 . . d MEDALGY^SYNFALG2(dfn,.root,.json,zi,.eval,.jlog,.args)
 . ;
 . ; determine Allergy snomed code  and display text
 . ;
 . ; determine the id of the resource
 . ;
 . ;new id set id=$get(json("entry",zi,"resource","id"))
 . ;set eval("allergy",zi,"vars","id")=id
 . ;d log(jlog,"ID is: "_id)
 . ;
 . new sctcode set sctcode=$get(json("entry",zi,"resource","code","coding",1,"code"))
 . do log(jlog,"code is: "_sctcode)
 . set eval("allergy",zi,"vars","code")=sctcode
 . ;
 . ;
 . ; determine the onset date and time
 . ;
 . ; json("entry",439,"resource","recordedDate")="1988-06-30T13:15:44-04:00"
 . new onsetdate   set onsetdate=$get(json("entry",zi,"resource","assertedDate"))
 . if onsetdate="" set onsetdate=$get(json("entry",zi,"resource","recordedDate"))
 . do log(jlog,"onsetDateTime is: "_onsetdate)
 . set eval("allergy",zi,"vars","onsetDateTime")=onsetdate
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
 . i $l(fmOnsetDateTime)=14 s fmOnsetDateTime=$e(fmOnsetDateTime,1,12)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
 . set eval("allergy",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(onsetdate)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
 . set eval("allergy",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
 . ;
 . ; determine clinical status (active vs inactive)
 . ;
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","verificationStatus"))
 . ;
 . ;
 . ; set up to call the data loader
 . ;
 . ;ALLERGY^ISIIMP10(ISIRESUL,ISIMISC)
 .;;NAME             |TYPE       |FILE,FIELD |DESC
 .;;-----------------------------------------------------------------------
 .;;ALLERGEN         |FIELD      |120.82,.01 |
 .;;SYMPTOM          |MULTIPLE   |120.83,.01 |Multiple,"|" (bar) delimited, working off #120.83
 .;;PAT_SSN          |FIELD      |120.86,.01 |PATIENT (#2, .09) pointer
 .;;ORIG_DATE        |FIELD      |120.8,4    |
 .;;ORIGINTR         |FIELD      |120.8,5    |PERSON (#200)
 .;;HISTORIC         |BOOLEEN    |           |1=HISTORICAL, 0=OBSERVED
 .;;OBSRV_DT         |FIELD      |           |Observation Date (if HISTORIC=0)
 .;
 . n RESTA,ISIMISC
 . ;
 . s ISIMISC("ALLERGEN")=$get(json("entry",zi,"resource","code","coding",1,"display"))
 . n algy s algy=$$ISGMR(sctcode)
 . i algy'=-1 s ISIMISC("ALLERGEN")=$p(algy,"^",2)
 . s eval("allergy",zi,"parms","ALLERGEN")=ISIMISC("ALLERGEN")
 . ;
 . s ISIMISC("SYMPTOM")=$get(json("entry",zi,"resource","reaction",1,"description"))
 . s eval("allergy",zi,"parms","SYMPTOM")=ISIMISC("SYMPTOM")
 . ;
 . ;s ISIMISC("ORIGINTR")="USER,THREE"
 . s ISIMISC("ORIGINTR")=$$USERNAME^SYNFALG
 . s eval("allergy",zi,"parms","ORIGINTR")=ISIMISC("ORIGINTR")
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s eval("allergy",zi,"parms","DHPPAT")=DHPPAT
 . s ISIMISC("PAT_SSN")=$$GET1^DIQ(2,dfn_",",.09)
 . s eval("allergy",zi,"parms","PAT_SSN")=ISIMISC("PAT_SSN")
 . ;
 . s DHPSCT=sctcode
 . s eval("allergy",zi,"parms","DHPSCT")=DHPSCT
 . ;
 . s DHPCLNST=$S(clinicalstatus="Active":"A",1:"I")
 . s eval("allergy",zi,"parms","DHPCLNST")=DHPCLNST
 . ;
 . s DHPONS=hl7OnsetDateTime
 . s eval("allergy",zi,"parms","DHPONS")=DHPONS
 . s ISIMISC("ORIG_DATE")=fmOnsetDateTime
 . s eval("allergy",zi,"parms","ORIG_DATE")=ISIMISC("ORIG_DATE")
 . s ISIMISC("HISTORIC")=1
 . s eval("allergy",zi,"parms","HISTORIC")=ISIMISC("HISTORIC")
 . ;
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
 . s eval("allergy",zi,"parms","DHPPROV")=DHPPROV
 . d log(jlog,"Provider NPI for outpatient is: "_DHPPROV)
 . ;
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
 . ;s eval("allergy",zi,"parms","DHPLOC")=DHPLOCIEN
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s eval("allergy",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("allergy",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Allergy already loaded, skipping")
 . . d log(jlog,"Calling ALLERGY^ISIIMP10 to add allergy")
 . . n myresult s myresult=$$ALLERGY^ISIIMP10(.RESTA,.ISIMISC)
 . . m eval("allergy",zi,"status")=RESTA
 . . d log(jlog,"Return from data loader was: "_myresult)
 . . if myresult=1 do  ;
 . . . s eval("allergy","status","loaded")=$g(eval("allergy","status","loaded"))+1
 . . . s eval("allergy",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s eval("allergy","status","errors")=$g(eval("allergy","status","errors"))+1
 . . . s eval("allergy",zi,"status","loadstatus")="notLoaded"
 . . . s eval("allergy",zi,"status","loadMessage")=$g(RESTA)
 . . n root s root=$$setroot^SYNWD("fhir-intake")
 . . i $g(ien)'="" d  ;
 . . . k @root@(ien,"load","allergy",zi)
 . . . m @root@(ien,"load","allergy",zi)=eval("allergy",zi)
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=json
 . m jrslt("args")=args
 . m jrslt("eval")=eval
 m jrslt("allergyStatus")=eval("allergyStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(eval("allergy","status","loaded"))
 set jrslt("result","errors")=$g(eval("allergy","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=eval
 . m result("status")=jrslt("result")
 . ;m result("dfn")=dfn
 . ;m result("ien")=ien
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
USERNAME() ; extrinsic returns the name of the user
 n duz
 s duz=$$USERDUZ^SYNFALG2
 q:duz="" -1
 q $p(^VA(200,duz,0),"^",1)
 ;
log(ary,txt) ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall ; run the allergy import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeAllergy(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload) ; run the allergy import on one imported patient
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter
 n done s done=0
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:$d(@root@(ien,"load","allergy"))
 . s filter("dfn")=dfn
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . d wsIntakeAllergy(.filter,,.reslt,ien)
 . s done=1
 q
 ;
getRandomAllergy(ary) ; make a web service call to get random allergies
 n srvr
 s srvr="http://postfhir.vistaplex.org:9080/"
 i srvr["postfhir.vistaplex.org" s srvr="http://138.197.70.229:9080/"
 i $g(^%WURL)["http://postfhir.vistaplex.org:9080" d  q  ;
 . s srvr="localhost:9080/"
 . n url
 . s url=srvr_"randomAllergy"
 . n ok,r1
 . s ok=$$%^%WC(.r1,"GET",url)
 . i '$d(r1) q  ;
 . d decode^SYNJSONE("r1","ary")
 n url
 s url=srvr_"randomAllergy"
 n ret,json,jtmp
 s ret=$$GETURL^XTHC10(url,,"jtmp")
 d assemble^SYNFPUL("jtmp","json")
 i '$d(json) q  ;
 d decode^SYNJSONE("json","ary")
 q
 ;
ISGMR(CDE) ; extrinsic return the ien and allergy name in GMR ALLERGIES if any
 ; CDE is a snomed code. returns -1 if not found
 N VUID
 S VUID=$$MAP^SYNQLDM(CDE,"gmr-allergies")
 ;W !,CDE," VUID:",VUID
 I VUID="" Q -1
 N IEN
 S IEN=$O(^GMRD(120.82,"AVUID",VUID,""))
 I IEN="" Q -1
 N R1 S R1=IEN_"^"_$$GET1^DIQ(120.82,IEN_",",.01)
 Q R1
 ;
QADDALGY(ALGY,ADATE,ien) ; adds an allergy to the queue to be processed
 ; used by Problems processing include allergies in VistA allergies
 ; ALGY is the name of the allergy. ADATE is the date of the allergy
 ; ien is the patient being processed
 i '$d(ien) q  ;
 n root s root=$$setroot^SYNWD("fhir-intake")
 n groot s groot=$na(@root@(ien,"load","ALLERGY2ADD"))
 n aien s aien=$o(@groot@(" "),-1)+1
 s @groot@(aien,"allergy")=$g(ALGY)
 s @groot@(aien,"date")=$g(ADATE)
 q
 ;

SYNFALG2
SYNFALG2 ;ven/gpl - fhir loader utilities ; 2/20/18 4:11am
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ; (c) Sam Habiel 2018
 ;
 QUIT
 ;
MEDALGY(dfn,root,json,zi,eval,jlog,args) ; allergy is rxnorm
 ;
 n SYNDFN,SYNRXN,SYNDF,SYNPA,SYNDUZ,SYNSS,SYNDATE,SYNCOMM
 ;
 S SYNDFN=dfn
 d log(jlog,"Patient DFN: "_SYNDFN)
 s eval("allergy",zi,"vars","dfn")=SYNDFN
 ;
 s SYNRXN=$get(json("entry",zi,"resource","code","coding",1,"code"))
 d log(jlog,"Allergin is RxNorm: "_SYNRXN)
 set eval("allergy",zi,"vars","code")=SYNRXN
 ;
 S SYNDUZ=$$USERDUZ
 d log(jlog,"Provider DUZ: "_SYNDUZ)
 s eval("allergy",zi,"vars","duz")=SYNDUZ
 ;
 new onsetdate set onsetdate=$get(json("entry",zi,"resource","assertedDate"))
 do log(jlog,"onsetDateTime is: "_onsetdate)
 set eval("allergy",zi,"vars","onsetDateTime")=onsetdate
 new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
 i $l(fmOnsetDateTime)=14 s fmOnsetDateTime=$e(fmOnsetDateTime,1,12)
 d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
 set eval("allergy",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
 S SYNDATE=fmOnsetDateTime
 ;
 s eval("allergy",zi,"status","loadstatus")="readyToLoad"
 ;
 if $g(args("load"))=1 d  ; only load if told to
 . n ien s ien=$$dfn2ien^SYNFUTL(dfn) ;
 . if $g(ien)'="" if $$loadStatus^SYNFALG("allergy",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Allergy already loaded, skipping")
 . d log(jlog,"Calling ADDMEDADR^SYNFALG2 to add allergy")
 . n ok
 . s ok=$$ADDMEDADR(SYNDFN,SYNRXN,,,SYNDUZ,,SYNDATE) ;
 . m eval("allergy",zi,"status")=ok
 . d log(jlog,"Return from data loader was: "_ok)
 . if +$g(ok)=1 do  ;
 . . s eval("status","loaded")=$g(eval("status","loaded"))+1
 . . s eval("allergy",zi,"status","loadstatus")="loaded"
 . else  d  ;
 . . s eval("status","errors")=$g(eval("status","errors"))+1
 . . s eval("allergy",zi,"status","loadstatus")="notLoaded"
 . . s eval("allergy",zi,"status","loadMessage")=ok
 . n root s root=$$setroot^SYNWD("fhir-intake")
 . i $g(ien)'="" d  ;
 . . k @root@(ien,"load","allergy",zi)
 . . m @root@(ien,"load","allergy",zi)=eval("allergy",zi)
 ;
 q
 ;
USERDUZ() ; extrinsic returning the DUZ of the user
 n npi,duz
 s npi=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
 s duz=$O(^VA(200,"ANPI",npi,""))
 q duz
 ;
log(ary,txt) ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 q
 ;
ADDMEDADR(SYNDFN,SYNRXN,SYNDF,SYNPA,SYNDUZ,SYNSS,SYNDATE,SYNCOMM) ; [Public] Add an allergy/adrxn using a Medications RxNorm Code
 ; Uses IA#4682 to record an allergy in the patient's chart
 ;
 ; Input:
 ; - SYNDFN   (r) = DFN
 ; - SYNRXN   (r) = RxNorm Ingredient or Clinical Drug code
 ; - SYNDF    (o) = "D"rug or "F"ood
 ; - SYNPA    (o) = Nature of Reaction: "P"harmacologic or "A"llergic
 ; - SYNDUZ   (o) = Recorder of reaction
 ; - SYNSS    (o) = ";" delimited list of signs and symptoms
 ; - SYNDATE  (o) = Date of recording of signs and symptoms
 ; - .SYNCOMM (o) = Comments in 1,2,3 etc passed by reference
 ;
 ; Output:
 ; - Can be called as a routine; but you won't get any error information
 ; - with $$, you will get:
 ; - 0^note to sign (if any) or -1^error message
 ;
 ; Translate RXN to VUID
 ; get VUIDs
 ; Output like this: 50.6~4030995
 ; or -1^message
 n fileVUIDs s fileVUIDs=$$ETSRXN2VUID^SYNFMED(SYNRXN)
 i fileVUIDs<0 quit fileVUIDs
 ;
 ; Get the first one
 n firstFileVUID s firstFileVUID=$P(fileVUIDs,U)
 ;
 ; Error if not found
 if firstFileVUID="" quit:$quit "-2^no-suitable-vuid-term-was-CD-or-IN" quit
 ;
 kill ^TMP("SYN",$J) ; we put all the reactant info here
 ;
 ; find variable pointer
 new synvuid ; For Searching Compound Index
 set synvuid(1)=$p(firstFileVUID,"~",2)
 set synvuid(2)=1
 new file set file=$p(firstFileVUID,"~",1)
 if 'file set $ec=",u-no-supposed-to-happen,"
 new ien set ien=$$FIND1^DIC(file,"","XQ",.synvuid,"AMASTERVUID")
 if 'ien quit:$quit "-3^VUID-not-found. Is your NDF up to date?" quit
 ;
 new drugName set drugName=$$GET1^DIQ(file,ien,.01)
 ;
 ; load the data into the global for the API
 set ^TMP("SYN",$J,"GMRAGNT")=drugName_U_ien_";"_$piece($$ROOT^DILFD(file),U,2) ; variable pointer syntax
 set ^TMP("SYN",$J,"GMRATYPE")=$G(SYNDF,"D") ; Allergen type: Drug OR Food (D or F)
 set ^TMP("SYN",$J,"GMRANATR")=$G(SYNPA,"U") ; nature of reaction: Allergic or Pharmacologic (default unknown)
 set ^TMP("SYN",$J,"GMRAORIG")=$G(SYNDUZ,DUZ) ; Originator
 set ^TMP("SYN",$J,"GMRAORDT")=$G(SYNDATE,DT) ; Date of recording of reaction (not date of reaction)
 new ssErr set ssErr=0
 if $get(SYNSS)]"" do
 . set ^TMP("SYN",$J,"GMRASYMP",0)=$L(SYNSS,";") ; Signs and symptoms need to be entered by IENs
 . new i for i=1:1:$l(SYNSS,";") do  q:ssErr  ; put signs and symptoms in 1,2,3 etc
 .. new ssIEN set ssIEN=$$FIND1^DIC(120.83,,"QX",$piece(SYNSS,";",i),"B")
 .. if 'ssIEN set ssErr=1
 .. set ^TMP("SYN",$J,"GMRASYMP",i)=ssIEN_U_$piece(SYNSS,";",i)
 i ssErr quit:$quit "-4^one or more signs/symptoms cannot be found" quit
 set ^TMP("SYN",$J,"GMRACHT",0)=1 ; marked in chart
 set ^TMP("SYN",$J,"GMRACHT",1)=$$NOW^XLFDT() ; marked now
 set ^TMP("SYN",$J,"GMRAOBHX")="h" ; historical. No sense in doing "observed"
 if $data(SYNCOMM) merge ^TMP("SYN",$J,"GMRACMTS")=SYNCOMM
 ;
 ; call the API
 N ORY
 D UPDATE^GMRAGUI1(0,SYNDFN,$NA(^TMP("SYN",$J)))
 ;
 ; API return -1^message or 0^note to sign
 if $piece(ORY,U)=-1 quit:$quit -5_U_$piece(ORY,U,2) quit
 quit:$quit 0_U_$piece(ORY,U,2)
 quit
 ;
TEST D EN^%ut($T(+0),3) quit
STARTUP ; M-UNIT STARTUP
 ; Delete all traces of patients allergies from DFN 1
 ; ZEXCEPT: DFN
 S DFN=1
 N DIK,DA
 S DIK=$$ROOT^DILFD(120.86),DA=DFN D ^DIK
 S DIK="^GMR(120.8,"
 S DA=0
 F  S DA=$O(^GMR(120.8,"B",1,DA)) Q:'DA  D ^DIK
 QUIT
 ;
TADDMEDADR1 ; @TEST Simple allergen NOS - Contraceptive CD.
 ; ZEXCEPT: DFN
 N % S %=$$ADDMEDADR(DFN,831533)
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDADR2 ; @TEST Allergen as "food" (really penicillin IN)
 ; ZEXCEPT: DFN
 N % S %=$$ADDMEDADR(DFN,70618,"F")
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDADR3 ; @TEST Pharmacological or Allergic (Simvastatin CD)
 ; ZEXCEPT: DFN
 N % S %=$$ADDMEDADR(DFN,198211,"D","P")
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDADR4 ; @TEST Different Originator (Tamoxifen CD)
 ; ZEXCEPT: DFN
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
 N % S %=$$ADDMEDADR(DFN,313195,"D","P",ORIG)
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDADR5 ; @TEST Different Origination date (Aliskiren/Amlodipine IN)
 ; ZEXCEPT: DFN
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
 N % S %=$$ADDMEDADR(DFN,1009219,"D","P",ORIG,,$$FMADD^XLFDT(DT,-120))
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDADR6 ; @TEST Signs and symptoms singular (Cephalexin CD)
 ; ZEXCEPT: DFN
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
 N % S %=$$ADDMEDADR(DFN,309110,"D","A",ORIG,"HIVES",$$FMADD^XLFDT(DT,-120))
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDADR7 ; @TEST Signs and symptoms plural (Cephalexin IN)
 ; ZEXCEPT: DFN
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
 N % S %=$$ADDMEDADR(DFN,2231,"D","A",ORIG,"HIVES;RHINITIS;WHEEZING",$$FMADD^XLFDT(DT,-120))
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDADR8 ; @TEST Comments (Levothyroxine IN)
 ; ZEXCEPT: DFN
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
 N COMM S COMM(1)="This seems to only happen with specific forumlations of Synthroid"
 S COMM(2)="I think it's just the 125mcg (pink one)"
 N % S %=$$ADDMEDADR(DFN,10582,"D","A",ORIG,"HIVES;RHINITIS;WHEEZING",$$FMADD^XLFDT(DT,-120),.COMM)
 D CHKTF^%ut(+%=0)
 quit
 ;
TADDMEDERR1 ; @TEST Test error messages: -1 Bad Rxn
 ; ZEXCEPT: DFN
 N % S %=$$ADDMEDADR(DFN,83153328978194871234)
 D CHKTF^%ut(+%=-1)
 quit
TADDMEDERR2 ; @TEST Test error messages: -2 No VUID for Rxn - too hard
 ; ZEXCEPT: DFN
 quit
 ;
TADDMEDERR3 ; @TEST Test error messages: -3 NDF product cannot be found - too hard
 ; ZEXCEPT: DFN
 quit
 ;
TADDMEDERR4 ; @TEST Test error messages: -4 Bad S/S
 ; ZEXCEPT: DFN
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
 N % S %=$$ADDMEDADR(DFN,309110,"D","A",ORIG,"OIUSLDFKJLSKDJF",$$FMADD^XLFDT(DT,-120))
 D CHKTF^%ut(+%=-4)
 quit
 ;
TADDMEDERR5 ; @TEST Test error message: -5 API error
 ; ZEXCEPT: DFN
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
 N % S %=$$ADDMEDADR(DFN,2231,"D","A",ORIG,"HIVES;RHINITIS;WHEEZING",$$FMADD^XLFDT(DT,-120))
 D CHKTF^%ut(+%=-5)
 quit
 ;
SHUTDOWN ; M-UNIT SHUTDOWN
 ; ZEXCEPT: DFN
 K DFN
 QUIT
 ;

SYNFAPT
SYNFAPT ;ven/gpl - fhir loader utilities ;Aug 15, 2019@15:24:38
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
importAppointment(rtn,ien,args) ; entry point for loading Appointment for a patient
 ; calls the intake Appointment web service directly
 ;
 n grtn
 d wsIntakeAppointment(.args,,.grtn,ien)
 s rtn("apptStatus","status")=$g(grtn("status","status"))
 s rtn("apptStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("apptStatus","errors")=$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeAppointment(args,body,result,ien)       ; web service entry (post)
 ; for intake of one or more Appointment. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n jtmp,json,jrslt,eval
 i $g(ien)'="" d  ; internal call
 . d getIntakeFhir^SYNFHIR("json",,"Appointment",ien,1)
 e  d  ;
 . s args("load")=0
 . merge jtmp=BODY
 . do decode^SYNJSONE("jtmp","json")
 ;if '$d(json) d  ; if no appointment, get a random set of appointments
 ;. d getRandomApt(.json) ; get a random set of appointments
 i '$d(json) q  ;
 m ^gpl("gjson")=json
 ;b
 ;
 ; determine the patient
 ;
 n dfn,eval
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("appointment",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(eval("appointment",zi))
 . ;
 . ; insure that the resourceType is Apppointment
 . ;
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
 . if type'="Appointment" do  quit  ;
 . . set eval("appointment",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Appointment, skipping entry")
 . set eval("appointment",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("appointment",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Appointment already loaded, skipping")
 . ;
 . ; determine the id of the resource
 . ;
 . ;new id set id=$get(json("entry",zi,"resource","id"))
 . ;set eval("appointment",zi,"vars","id")=id
 . ;d log(jlog,"ID is: "_id)
 . ;
 . ; determine the onset date and time
 . ;
 . new startdate set startdate=$get(json("entry",zi,"resource","start"))
 . do log(jlog,"startDateTime is: "_startdate)
 . set eval("appointment",zi,"vars","startDateTime")=startdate
 . new fmStartDateTime s fmStartDateTime=$$fhirTfm^SYNFUTL(startdate)
 . d log(jlog,"fileman startDateTime is: "_fmStartDateTime)
 . set eval("appointment",zi,"vars","fmStarttDateTime")=fmStartDateTime ;
 . new hl7StartDateTime s hl7StartDateTime=$$fhirThl7^SYNFUTL(startdate)
 . d log(jlog,"hl7 startDateTime is: "_hl7StartDateTime)
 . set eval("appointment",zi,"vars","hl7StartDateTime")=hl7StartDateTime ;
 . ;
 . ; determine clinical status (active vs inactive)
 . ;
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","status"))
 . ;
 . ; set up to call the data loader
 . ;
 . ;APPTADD(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN) ;Create appointment
 . ;
 . ; Input:
 . ;   DHPPAT   - Patient ICN (required)
 . ;   DHPCLIN  - Clinic Name (required)
 . ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
 . ;   DHPLEN   - Appointment length as minutes (optional, defaults to 15 mins.)
 . ;
 . ; Output:   RETSTA
 . ;  1 - success
 . ; -1 - failure -1^message
 . ;
 . n RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN,DHPCIDT,DHPCODT
 . s (RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN,DHPCIDT,DHPCODT)=""      ;Appointment update
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s eval("appointment",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s DHPAPTDT=hl7StartDateTime
 . s eval("appointment",zi,"parms","DHPAPTDT")=DHPAPTDT
 . ;
 . ;s DHPPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
 . ;s eval("appointment",zi,"parms","DHPPROV")=DHPPROV
 . ; log(jlog,"Provider NPI for outpatient is: "_DHPPROV)
 . ;
 . s DHPCLIN=$$MAP^SYNQLDM("OP","location")
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPCLIN,""))
 . if DHPLOCIEN="" S DHPLOCIEN=4 S DHPCLIN=$$GET1^DIQ(44,DHPLOCIEN_",",.01)
 . s eval("appointment",zi,"parms","DHPCLIN")=DHPCLIN
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPCLIN)
 . ;
 . s eval("appointment",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("appointment",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Appointment already loaded, skipping")
 . . d log(jlog,"Calling APPTUPDT^SYNDHP62 to add appointment")
 . . D APPTADD^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN) ;Create appointment
 . . ;D APPTUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN,DHPCIDT,DHPCODT)        ;Appointment update
 . . m eval("appointment",zi,"status")=RETSTA
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
 . . . s eval("appointment",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
 . . . s eval("appointment",zi,"status","loadstatus")="notLoaded"
 . . . s eval("appointment",zi,"status","loadMessage")=$g(RETSTA)
 . . n root s root=$$setroot^SYNWD("fhir-intake")
 . . k @root@(ien,"load","appointment",zi)
 . . m @root@(ien,"load","appointment",zi)=eval("appointment",zi)
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=json
 . m jrslt("args")=args
 . m jrslt("eval")=eval
 m jrslt("appointmentStatus")=eval("appointmentStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(eval("status","loaded"))
 i $g(ien)'="" d  ; called internally
 . m result=eval
 . m result("status")=jrslt("result")
 . m result("dfn")=dfn
 . m result("ien")=ien
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)    ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall ; run the appointment import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeAppointment(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload)   ; run the appointment import on imported patient
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter
 n done s done=0
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:$d(@root@(ien,"load","appointment"))
 . s filter("dfn")=dfn
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . ;w !,"loading appointments for ien=",ien,!
 . d wsIntakeAppointment(.filter,,.reslt,ien)
 . ;zwr reslt
 . s done=1
 q
 ;
getRandomApt(ary)       ; make a web service call to get random appointments
 n srvr
 s srvr="http://postfhir.vistaplex.org:9080/"
 i srvr["postfhir.vistaplex.org" s srvr="http://138.197.70.229:9080/"
 i $g(^%WURL)["http://postfhir.vistaplex.org:9080" d  q  ;
 . s srvr="localhost:9080/"
 . n url
 . s url=srvr_"randomappointment"
 . n ok,r1
 . s ok=$$%^%WC(.r1,"GET",url)
 . i '$d(r1) q  ;
 . d decode^SYNJSONE("r1","ary")
 n url
 s url=srvr_"randomAllergy"
 n ret,json,jtmp
 s ret=$$GETURL^XTHC10(url,,"jtmp")
 d assemble^SYNFPUL("jtmp","json")
 i '$d(json) q  ;
 d decode^SYNJSONE("json","ary")
 q
 ;

SYNFCON
SYNFCON ;ven/gpl - fhir loader utilities ;2018-08-17  3:28 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
importConditions(rtn,ien,args)  ; entry point for loading conditions for a patient
 ; calls the intake Conditions web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 d wsIntakeConditions(.args,,.grtn,ien)
 i $d(grtn) d  ; something was returned
 . k @root@(ien,"load","conditions")
 . m @root@(ien,"load","conditions")=grtn("conditions")
 . if $g(args("debug"))=1 m rtn=grtn
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeConditions(args,body,result,ien)        ; web service entry (post)
 ; for intake of one or more Conditions. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n jtmp,json,jrslt,eval
 ;i $g(ien)'="" if $$loadStatus("conditions","",ien)=1 d  q  ;
 ;. s result("conditionsStatus","status")="alreadyLoaded"
 i $g(ien)'="" d  ; internal call
 . d getIntakeFhir^SYNFHIR("json",,"Condition",ien,1)
 e  d  ;
 . s args("load")=0
 . merge jtmp=BODY
 . do decode^SYNJSONE("jtmp","json")
 i '$d(json) q  ;
 m ^gpl("gjson")=json
 ;
 ; determine the patient
 ;
 n dfn,eval
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("conditions",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(eval("conditions",zi))
 . ;
 . ; insure that the resourceType is Condition
 . ;
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
 . if type'="Condition" do  quit  ;
 . . set eval("conditions",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Condition, skipping entry")
 . set eval("conditions",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Vital sign already loaded, skipping")
 . ;
 . ; determine Conditions code, coding system, and display text
 . ;
 . ;
 . ; determine the id of the resource
 . ;
 . new id set id=$get(json("entry",zi,"resource","id"))
 . set eval("conditions",zi,"vars","id")=id
 . d log(jlog,"ID is: "_id)
 . ;
 . new concode set concode=$get(json("entry",zi,"resource","code","coding",1,"code"))
 . do log(jlog,"code is: "_concode)
 . set eval("conditions",zi,"vars","code")=concode
 . ;
 . ;
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set eval("conditions",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the code display text
 . ;
 . new context s context=$get(json("entry",zi,"resource","code","coding",1,"display"))
 . do log(jlog,"display text is: "_context)
 . set eval("conditions",zi,"vars","text")=context
 . ;
 . ; determine the effective date
 . ;
 . new effdate set effdate=$get(json("entry",zi,"resource","onsetDateTime"))
 . do log(jlog,"effectiveDateTime is: "_effdate)
 . set eval("conditions",zi,"vars","effectiveDateTime")=effdate
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
 . d log(jlog,"fileman dateTime is: "_fmtime)
 . set eval("conditions",zi,"vars","fmDateTime")=fmtime ;
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
 . set eval("conditions",zi,"vars","hl7DateTime")=hl7time ;
 . ;
 . ; determine the abatement date
 . ;
 . new abatedate set abatedate=$get(json("entry",zi,"resource","abatementDateTime"))
 . do log(jlog,"abatementDateTime is: "_abatedate)
 . set eval("conditions",zi,"vars","abatementDateTime")=effdate
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(abatedate)
 . d log(jlog,"fileman abatementDateTime is: "_fmtime)
 . set eval("conditions",zi,"vars","fmAbatementDateTime")=fmtime ;
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(abatedate)
 . d log(jlog,"hl7 abatementDateTime is: "_hl7time)
 . set eval("conditions",zi,"vars","hl7AbatementDateTime")=hl7time ;
 . ;
 . ; determine the status
 . ;
 . n constatus s constatus=$get(json("entry",zi,"resource","clinicalStatus"))
 . do log(jlog,"Clinical Status is: "_constatus)
 . set eval("conditions",zi,"vars","clinicalStatus")=constatus
 . ;
 . ; set up to call the data loader
 . ;
 . n RETSTA,DHPPAT,DHPSCT,DHPDTM,DHPPROV,DHPLOC,DHPTXT
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s eval("conditions",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s DHPSCT=concode
 . s eval("conditions",zi,"parms","DHPSCT")=DHPSCT
 . ;
 . s DHPTXT=context
 . s eval("conditions",zi,"parms","DHPTXT")=DHPTXT
 . ;
 . ;
 . s DHPDTM=hl7time
 . s eval("conditions",zi,"parms","DHPDTM")=hl7time
 . d log(jlog,"HL7 DateTime is: "_hl7time)
 . ;
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider")
 . n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
 . if DHPPROVIEN="" S DHPPROVIEN=3
 . s eval("conditions",zi,"parms","DHPPROV")=DHPPROVIEN
 . d log(jlog,"Provider for outpatient is: #"_DHPPROVIEN_" "_DHPPROV)
 . ;
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . if DHPLOCIEN="" S DHPLOCIEN=4
 . s eval("conditions",zi,"parms","DHPLOC")=DHPLOCIEN
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s eval("conditions",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Vital sign already loaded, skipping")
 . . d log(jlog,"Calling data loader to add encounter")
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
 . . . s eval("conditions",zi,"status","loadstatus")="loaded"
 . . else  s eval("status","errors")=$g(eval("status","errors"))+1
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=json
 . m jrslt("args")=args
 . m jrslt("eval")=eval
 m jrslt("conditionsStatus")=eval("conditionsStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(eval("status","loaded"))
 i $g(ien)'="" d  ; called internally
 . m result=eval
 . m result("status")=jrslt("result")
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)    ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall ; run the conditions import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeConditions(.filter,,.reslt,ien)
 q
 ;

SYNFCP
SYNFCP ;ven/gpl - fhir loader utilities ;Aug 15, 2019@14:28:47
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2019
 ;
 q
 ;
importCarePlan(rtn,ien,args)  ; entry point for loading Careplans for a patient
 ; calls the intake Careplan web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 d wsIntakeCareplan(.args,,.grtn,ien)
 ;
 s rtn("careplanStatus","status")=$g(grtn("status","status"))
 s rtn("careplanStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("careplanStatus","errors")=$g(grtn("status","errors"))
 ;
 ;
 q
 ;
wsIntakeCareplan(args,body,result,ien)        ; web service entry (post)
 ; for intake of one or more Careplan. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 ;
 n root,troot
 s root=$$setroot^SYNWD("fhir-intake")
 ;
 n jtmp,json,jrslt,eval
 i $g(ien)'="" d  ; internal call
 . s troot=$na(@root@(ien,"type","CarePlan"))
 . s eval=$na(@root@(ien,"load")) ; move eval to the graph
 e  q 0  ; sending not decoded json in BODY to this routine not supported
 ; todo: locate the patient and add the encounters in BODY to the graph
 s json=$na(@root@(ien,"json"))
 ;
 ; determine the patient
 ;
 n dfn
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("careplan",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(@troot@(zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(@eval@("careplan",zi))
 . ;
 . d log(jlog,"DFN: "_dfn)
 . ;
 . ; insure that the resourceType is CarePlan
 . ;
 . new type set type=$get(@json@("entry",zi,"resource","resourceType"))
 . if type'="CarePlan" do  quit  ;
 . . set @eval@("careplan",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not CarePlan, skipping entry")
 . set @eval@("careplan",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("condition",zi,ien)=1 do  quit  ;
 . . d log(jlog,"CarePlan already loaded, skipping")
 . ;
 . ; determine CarePlan snomed code, coding system, and display text
 . ;
 . ;
 . ; determine the id of the resource
 . ;
 . new id set id=$get(@json@("entry",zi,"resource","id"))
 . set @eval@("careplan",zi,"vars","id")=id
 . d log(jlog,"ID is: "_id)
 . ;
 . ;
 . ; determine the encounter visit ien
 . n encounterId
 . s encounterId=$g(@json@("entry",zi,"resource","context","reference"))
 . i encounterId="" s encounterId=$g(@json@("entry",zi,"resource","encounter","reference"))
 . ;i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
 . s @eval@("careplan",zi,"vars","encounterId")=encounterId
 . d log(jlog,"reference encounter ID is : "_encounterId)
 . ;
 . ; determine visit ien
 . ;
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
 . s @eval@("careplan",zi,"vars","visitIen")=visitIen
 . d log(jlog,"visit ien is: "_visitIen)
 . n visitDate s visitDate=$$GET1^DIQ(9000010,visitIen_",",.01,"I")
 . i visitDate'=-1 d  ;
 . . s @eval@("careplan",zi,"vars","visitDate")=visitDate
 . . d log(jlog,"visit date is: "_visitDate)
 . e  d log(jlog,"visit date unknow")
 . ;
 . ; determine the category code
 . ;
 . new sctcode set sctcode=$get(@json@("entry",zi,"resource","category",1,"coding",1,"code"))
 . n cattext s cattext=$get(@json@("entry",zi,"resource","category",1,"coding",1,"display"))
 . n x s $p(x,"-",80)=""
 . do TONOTE^SYNFTIU(ien,encounterId,x)
 . do TONOTE^SYNFTIU(ien,encounterId,"Care Plan Instituted")
 . do TONOTE^SYNFTIU(ien,encounterId,"")
 . do TONOTE^SYNFTIU(ien,encounterId,"Care Plan Category: ")
 . do TONOTE^SYNFTIU(ien,encounterId,"  "_cattext_" (SCT:"_sctcode_")")
 . do log(jlog,"category code is: "_sctcode)
 . do log(jlog,"category text is: "_cattext)
 . set @eval@("careplan",zi,"vars","code")=sctcode
 . set @eval@("careplan",zi,"vars","categoryText")=cattext
 . d log(jlog,"Care Plan Category Code: "_sctcode)
 . d log(jlog,"Care Plan Category Text: "_cattext)
 . n hfcat,hfcatien
 . s hfcat=$$HFCPCAT^SYNFHF(sctcode,cattext)
 . s hfcatien=+hfcat
 . d log(jlog,"Care Plan Category HF: "_hfcat)
 . n hfcp
 . s hfcp=$$HFCP^SYNFHF(sctcode,cattext,hfcatien)
 . d log(jlog,"Care Plan HF: "_hfcp)
 . ;
 . ; determine the "addresses" code
 . ;
 . n addcode s addcode=""
 . i $g(@json@("entry",zi,"resource","addresses",1,"reference"))'="" d  ;
 . . n condref
 . . s condref=$g(@json@("entry",zi,"resource","addresses",1,"reference"))
 . . q:condref=""
 . . d log(jlog,"Addresses Condition Reference: "_condref)
 . . s addcode=$$DX^SYNFCP(ien,condref)
 . . d log(jlog,"Addresses Code: "_addcode)
 . . d TONOTE^SYNFTIU(ien,encounterId,"Care Plan Addresses:")
 . . d TONOTE^SYNFTIU(ien,encounterId,"  "_$p(addcode,"^",2)_"(SCT:"_$p(addcode,"^",1)_")")
 . e  d log(jlog,"No Addresses Condition")
 . ;
 . ; the following will be needed for addresses diagnosis code
 . ;
 . ;n icdcode,notmapped,icdcodetype
 . ;s notmapped=0
 . ;i visitDate<3151001 s icdcodetype="icd9"
 . ;e  s icdcodetype="icd10"
 . ;d log(jlog,"icd code type is: "_icdcodetype)
 . ;i icdcodetype="icd9" s icdcode=$$MAP^SYNDHPMP("sct2icdnine",sctcode)
 . ;e  s icdcode=$$MAP^SYNDHPMP("sct2icd",sctcode)
 . ;i +icdcode=-1 s notmapped=1
 . ;d:notmapped MAPERR^SYNQLDM(sctcode,icdcodetype)
 . ;do log(jlog,"icd mapping is: "_icdcode)
 . ;do:notmapped log(jlog,"snomed code "_sctcode_" is not mapped")
 . ;set @eval@("careplan",zi,"vars","mappedIcdCode")=icdcode
 . ;
 . ; determine the beginning date and time
 . ;
 . new begindate
 . set begindate=$get(@json@("entry",zi,"resource","period","start"))
 . do log(jlog,"beginDateTime is: "_begindate)
 . set @eval@("careplan",zi,"vars","beginDateTime")=begindate
 . new fmBeginDateTime s fmBeginDateTime=$$fhirTfm^SYNFUTL(begindate)
 . d log(jlog,"fileman beginDateTime is: "_fmBeginDateTime)
 . set @eval@("careplan",zi,"vars","fmBeginDateTime")=fmBeginDateTime ;
 . new hl7BeginDateTime s hl7BeginDateTime=$$fhirThl7^SYNFUTL(begindate)
 . d log(jlog,"hl7 beginDateTime is: "_hl7BeginDateTime)
 . set @eval@("careplan",zi,"vars","hl7BeginDateTime")=hl7BeginDateTime ;
 . ;
 . ; determine the end date and time, if any
 . ;
 . new enddate set enddate=$get(@json@("entry",zi,"resource","period","end"))
 . new hl7EndDateTime s hl7EndDateTime=""
 . if enddate'="" d  ;
 . . do log(jlog,"endDateTime is: "_enddate)
 . . set @eval@("careplan",zi,"vars","endDateTime")=enddate
 . . new fmEndDateTime s fmEndDateTime=$$fhirTfm^SYNFUTL(enddate)
 . . d log(jlog,"fileman endDateTime is: "_fmEndDateTime)
 . . set @eval@("careplan",zi,"vars","fmEndDateTime")=fmEndDateTime ;
 . . s hl7EndDateTime=$$fhirThl7^SYNFUTL(enddate)
 . . d log(jlog,"hl7 endDateTime is: "_hl7EndDateTime)
 . . set @eval@("careplan",zi,"vars","hl7EndDateTime")=hl7EndDateTime ;
 . else  d log(jlog,"no endDateTime")
 . ;
 . ; determine careplan status (active vs inactive)
 . ;
 . n careplanstatus
 . set careplanstatus=$get(@json@("entry",zi,"resource","status"))
 . d log(jlog,"CarePlan Status: "_careplanstatus)
 . n catstr
 . s catstr=sctcode_"~"_cattext_"~"_careplanstatus
 . d log(jlog,"Care Plan Category string: "_catstr)
 . ;
 . ; add begindate, enddate, and careplanstatus to note
 . d TONOTE^SYNFTIU(ien,encounterId,"  Begin Date: "_$$FMTE^XLFDT(begindate))
 . d TONOTE^SYNFTIU(ien,encounterId,"  End Date: "_$$FMTE^XLFDT(enddate))
 . d TONOTE^SYNFTIU(ien,encounterId,"  Status: "_careplanstatus)
 . ; determine the encounter visit ien
 . n encounterId
 . s encounterId=$g(@json@("entry",zi,"resource","context","reference"))
 . i encounterId="" s encounterId=$g(@json@("entry",zi,"resource","encounter","reference"))
 . ;i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
 . s @eval@("careplan",zi,"vars","encounterId")=encounterId
 . d log(jlog,"reference encounter ID is : "_encounterId)
 . ;
 . ; determine visit ien
 . ;
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
 . s @eval@("careplan",zi,"vars","visitIen")=visitIen
 . d log(jlog,"visit ien is: "_visitIen)
 . ;
 . ; activities
 . ;
 . n actary,actstr,actien,an
 . s actien=0
 . s actary=""
 . s actstr=""
 . s an=$na(@json@("entry",zi,"resource","activity"))
 . i $d(@an) d TONOTE^SYNFTIU(ien,encounterId,"Care Plan Activities")
 . f  s actien=$o(@an@(actien)) q:+actien=0  d  ;
 . . i actstr'="" s actstr=actstr_"^"
 . . s actary(actien,"code")=$g(@an@(actien,"detail","code","coding",1,"code"))
 . . s actstr=actstr_$g(@an@(actien,"detail","code","coding",1,"code"))
 . . s actary(actien,"text")=$g(@an@(actien,"detail","code","coding",1,"display"))
 . . s actstr=actstr_"~"_$g(@an@(actien,"detail","code","coding",1,"display"))
 . . s actary(actien,"system")=$g(@an@(actien,"detail","code","coding",1,"system"))
 . . s actary(actien,"status")=$g(@an@(actien,"detail","status"))
 . . d TONOTE^SYNFTIU(ien,encounterId,"  "_$g(actary(actien,"text"))_" (SCT:"_$g(actary(actien,"code"))_")")
 . . d TONOTE^SYNFTIU(ien,encounterId,"    status: "_$g(actary(actien,"status")))
 . . s actary(actien,"hf")=$$HFACT^SYNFHF($g(actary(actien,"code")),$g(actary(actien,"text")),hfcatien)
 . . d log(jlog,"CP Activity HF: "_$g(actary(actien,"hf")))
 . . s actstr=actstr_"~"_$g(@an@(actien,"detail","status"))
 . m @eval@("careplan",zi,"vars","activities")=actary
 . s @eval@("careplan",zi,"vars","actString")=actstr
 . d log(jlog,"Activity string: "_actstr)
 . ;
 . ; goals
 . ;
 . n goalary,goalstr,goalien,gn,goalcnt,goalroot,goaladdr
 . s goalcnt=0
 . s goalien=0
 . s goalary=""
 . s goalstr=""
 . s gn=$na(@json@("entry",zi,"resource","goal"))
 . n root s root=$$setroot^SYNWD("fhir-intake")
 . n groot s groot=$na(@root@(ien,"json","entry"))
 . f  s goalien=$o(@gn@(goalien)) q:+goalien=0  d  ;
 . . s goalcnt=goalcnt+1
 . . i goalcnt=1 d TONOTE^SYNFTIU(ien,encounterId,"Care Plan Goals")
 . . i goalstr'="" s goalstr=goalstr_"^"
 . . s goalroot=$na(@groot@(zi-goalcnt))
 . . ;b
 . . i $g(@goalroot@("resource","resourceType"))'="Goal" q  ;
 . . ;
 . . ; determine the "addresses" code for the goal
 . . ;
 . . n addcode s addcode=""
 . . n addrref
 . . s addrref=$g(@goalroot@("resource","addresses",1,"reference"))
 . . i addrref'="" d  ;
 . . . d log(jlog,"Goal Addresses Reference: "_addrref)
 . . . s addcode=$$DX^SYNFCP(ien,addrref)
 . . . d log(jlog,"Goal Addresses Code: "_addcode)
 . . e  d log(jlog,"No Goal Addresses Condition")
 . . s goalary(goalien,"code")=+addcode
 . . s goalstr=goalstr_+addcode
 . . s goalary(goalien,"text")=$g(@goalroot@("resource","description","text"))
 . . s goalstr=goalstr_"~"_$g(@goalroot@("resource","description","text"))
 . . s goalary(goalien,"system")="SCT"
 . . s goalary(goalien,"status")=$g(@goalroot@("resource","status"))
 . . d TONOTE^SYNFTIU(ien,encounterId,"  "_$g(goalary(goalien,"text")))
 . . d TONOTE^SYNFTIU(ien,encounterId,"    Addresses Condition: "_$p(addcode,"^",2)_" (SCT:"_+addcode_")")
 . . d TONOTE^SYNFTIU(ien,encounterId,"    status: "_$g(goalary(goalien,"status")))
 . . s goalary(goalien,"hf")=$$HFGOAL^SYNFHF($g(goalary(goalien,"code")),hfcatien,$g(goalary(goalien,"text")),$tr(addcode,"^","-"))
 . . d log(jlog,"CP Goal HF: "_$g(goalary(goalien,"hf")))
 . . s goalstr=goalstr_"~"_$g(@goalroot@("resource","status"))
 . m @eval@("careplan",zi,"vars","goals")=goalary
 . s @eval@("careplan",zi,"vars","goalString")=goalstr
 . d:goalstr'="" log(jlog,"Goal string: "_goalstr)
 . ;
 . ;b
 . ;
 . ; set up to call the data loader
 . ;
 . ;CPLUPDT(RETSTA,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT) ;
 . ;
 . ; Input:
 . ; DHPPAT - Patient ICN
 . ; DHPVST - Visit ID
 . ; DHPCAT - Category ID (SCT code. text,and FHIR status )
 . ; DHPACT - List of Activities (SCT code, text, and FHIR status )
 . ; DHPGOL - List of Goals
 . ; DHPSCT - Reason for CarePlan (SCT code)
 . ; DHPSDT - CarePlan Period start
 . ; DHPEDT - CarePlan period end (optional)
 . ;
 . ;
 . ; Output: RETSTA
 . ; 1 - success
 . ; -1 - failure -1^message . ;
 . ;
 . n RETSTA,DHPPAT,DHPVST,DHPCAT,DHPGOL,DHPSCT,DHPSDT,DHPEDT ;CarePlan update
 . s (DHPPAT,DHPVST,DHPCAT,DHPGOL,DHPSCT,DHPSDT,DHPEDT)="" ;CarePlan update
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s @eval@("careplan",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s DHPVST=visitIen
 . s @eval@("careplan",zi,"parms","DHPVST")=visitIen
 . ;
 . s DHPSCT=$s(addcode'="":+addcode,1:"")
 . s @eval@("careplan",zi,"parms","DHPSCT")=DHPSCT
 . ;
 . s DHPCAT=$g(catstr)
 . s @eval@("careplan",zi,"parms","DHPCAT")=DHPCAT
 . ;
 . s DHPSDT=$g(hl7BeginDateTime)
 . s @eval@("careplan",zi,"parms","DHPSDT")=DHPSDT
 . ;
 . s DHPEDT=$g(hl7EndDateTime)
 . s @eval@("careplan",zi,"parms","DHPEDT")=DHPEDT
 . ;
 . s DHPACT=actstr
 . s @eval@("careplan",zi,"parms","DHPACT")=DHPACT
 . ;
 . s DHPGOL=goalstr
 . s @eval@("careplan",zi,"parms","DHPGOL")=DHPGOL
 . ;
 . ;s DHPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
 . ;s @eval@("careplan",zi,"parms","DHPROV")=DHPROV
 . ;d log(jlog,"Provider NPI for outpatient is: "_DHPROV)
 . ;
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
 . ;s @eval@("careplan",zi,"parms","DHPLOC")=DHPLOCIEN
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s @eval@("careplan",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("careplan",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"CarePlan already loaded, skipping")
 . . d  ;  use DATA2PCE
 . . . d log(jlog,"Calling CPLUPDT^SYNDHP91 to add care plans")
 . . . D CPLUPDT^SYNDHP91(.RETSTA,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT) ;
 . . m @eval@("careplan",zi,"status")=RETSTA
 . . i $g(DEBUG)=1 ZWR RETSTA
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s @eval@("careplan","status","loaded")=$g(@eval@("careplan","status","loaded"))+1
 . . . s @eval@("careplan",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s @eval@("careplan","status","errors")=$g(@eval@("careplan","status","errors"))+1
 . . . s @eval@("careplan",zi,"status","loadstatus")="notLoaded"
 . . . s @eval@("careplan",zi,"status","loadMessage")=$g(RETSTA)
 . . n root s root=$$setroot^SYNWD("fhir-intake")
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=@json
 . m jrslt("args")=args
 . m jrslt("eval")=@eval
 m jrslt("careplanStatus")=@eval@("careplanStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(@eval@("careplan","status","loaded"))
 set jrslt("result","errors")=$g(@eval@("careplan","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=@eval
 . m result("status")=jrslt("result")
 . ;m result("dfn")=dfn
 . ;m result("ien")=ien
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)    ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 w:$G(DEBUG) !,"      ",$G(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i '$d(@root@(zien,"load",typ,zx,"status")) q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
DX(ien,ptr,sep) ; extrinsic returns code^text for diagnosis in
 ; a condition pointed to by ptr in patient ien
 ; sep is optional separator - default is "^"
 i $g(sep)="" s sep="^"
 n root s root=$$setroot^SYNWD("fhir-intake")
 i '$d(@root@(ien,"SPO",ptr)) q ""
 n sct,txt,rien
 i $o(@root@(ien,"SPO",ptr,"type",""))'="Condition" q ""
 s rien=$o(@root@(ien,"SPO",ptr,"rien",""))
 q:rien="" ""
 s sct=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"code"))
 q:sct="" ""
 s txt=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"display"))
 q sct_sep_txt
 ;
testall ; run the careplan import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeCareplan(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload)   ; run the careplan import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter
 n done s done=0
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:$d(@root@(ien,"load","careplan"))
 . s filter("dfn")=dfn
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . d wsIntakeCareplan(.filter,,.reslt,ien)
 . s done=1
 q
 ;

SYNFENC
SYNFENC ;ven/gpl - fhir loader utilities ;Aug 15, 2019@13:57:48
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2019
 ;
 q
 ;
importEncounters(rtn,ien,args)  ; entry point for loading encounters for a patient
 ; calls the intake Encounters web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 d wsIntakeEncounters(.args,,.grtn,ien)
 ;
 s rtn("encountersStatus","status")=$g(grtn("status","status"))
 s rtn("encountersStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("encountersStatus","errors")=$g(grtn("status","errors"))
 ;
 ;
 q
 ;
wsIntakeEncounters(args,body,result,ien)        ; web service entry (post)
 ; for intake of one or more Encounters. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 ;
 n root,troot
 s root=$$setroot^SYNWD("fhir-intake")
 ;
 n jtmp,json,jrslt,eval
 i $g(ien)'="" d  ; internal call
 . s troot=$na(@root@(ien,"type","Encounter"))
 . s eval=$na(@root@(ien,"load")) ; move eval to the graph
 e  q 0  ; sending not decoded json in BODY to this routine not supported
 ; todo: locate the patient and add the encounters in BODY to the graph
 s json=$na(@root@(ien,"json"))
 ;
 ; determine the patient
 ;
 n dfn
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("encounters",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(@troot@(zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(@eval@("encounters",zi))
 . ;
 . ; insure that the resourceType is Encounter
 . ;
 . new type set type=$get(@json@("entry",zi,"resource","resourceType"))
 . if type'="Encounter" do  quit  ;
 . . set @eval@("encounters",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Encounter, skipping entry")
 . set @eval@("encounters",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("encounters",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Encounter already loaded, skipping")
 . ;
 . ; determine Encounters code, coding system, and display text
 . ;
 . ;
 . ; determine the id of the resource
 . ;
 . new id set id=$get(@json@("entry",zi,"resource","id"))
 . set @eval@("encounters",zi,"vars","id")=id
 . d log(jlog,"ID is: "_id)
 . ;
 . new enccode set enccode=$get(@json@("entry",zi,"resource","type",1,"coding",1,"code"))
 . ;n visitcpt s visitcpt=$$MAP^SYNQLDM(enccode)
 . ;i visitcpt="" d  ;
 . ;. d MAPERR^SYNQLDM(enccode,"sct2cpt")
 . ;. d log(jlog,"-1^Encounter code does not map: "_enccode)
 . i enccode="" s enccode=185349003 ; generic visit
 . do log(jlog,"code is: "_enccode)
 . set @eval@("encounters",zi,"vars","code")=enccode
 . ;
 . ;
 . new codesystem set codesystem=$get(@json@("entry",zi,"resource","type",1,"coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set @eval@("encounters",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the reason code and system (Encounter Diagnosis)
 . ;
 . n reasoncode s reasoncode=$get(@json@("entry",zi,"resource","reason","coding",1,"code"))
 . i reasoncode="" s reasoncode=$get(@json@("entry",zi,"resource","reasonCode",1,"coding",1,"code"))
 . d log(jlog,"reasonCode is: "_reasoncode)
 . set @eval@("encounters",zi,"vars","reasonCode")=reasoncode
 . ;
 . ; determine reason code system
 . ;
 . new reasoncdsys set reasoncdsys=$get(@json@("entry",zi,"resource","reason","coding",1,"system"))
 . i reasoncdsys="" set reasoncdsys=$get(@json@("entry",zi,"resource","reasonCode",1,"coding",1,"system"))
 . d log(jlog,"reasonCode system is: "_reasoncdsys)
 . set @eval@("encounters",zi,"vars","reasonCodeSys")=reasoncdsys
 . ;
 . ; determine the effective date
 . ;
 . new effdate set effdate=$get(@json@("entry",zi,"resource","period","start"))
 . do log(jlog,"effectiveDateTime is: "_effdate)
 . set @eval@("encounters",zi,"vars","effectiveDateTime")=effdate
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
 . d log(jlog,"fileman dateTime is: "_fmtime)
 . set @eval@("encounters",zi,"vars","fmDateTime")=fmtime ;
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
 . set @eval@("encounters",zi,"vars","hl7DateTime")=hl7time ;
 . ;
 . new effdateEnd set effdateEnd=$get(@json@("entry",zi,"resource","period","end"))
 . do log(jlog,"endDateTime is: "_effdateEnd)
 . set @eval@("encounters",zi,"vars","endDateTime")=effdateEnd
 . new fmtimeEnd s fmtimeEnd=$$fhirTfm^SYNFUTL(effdateEnd)
 . d log(jlog,"fileman endDateTime is: "_fmtimeEnd)
 . set @eval@("encounters",zi,"vars","fmEndDateTime")=fmtimeEnd ;
 . new hl7endTime s hl7endTime=$$fhirThl7^SYNFUTL(effdateEnd)
 . d log(jlog,"hl7 endDateTime is: "_hl7endTime)
 . set @eval@("encounters",zi,"vars","hl7endDateTime")=hl7endTime ;
 . ;
 . ; set up to call the data loader
 . ;
 . ;ENCTUPD(RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT)     ;Encounter update
 . ;
 . n RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s @eval@("encounters",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s SCTCPT=enccode
 . s @eval@("encounters",zi,"parms","SCTCPT")=SCTCPT
 . ;
 . ; reason code
 . s SCTDX=reasoncode
 . s @eval@("encounters",zi,"parms","SCTDX")=SCTDX
 . ;
 . s STARTDT=hl7time
 . s @eval@("encounters",zi,"parms","STARTDT")=hl7time
 . d log(jlog,"HL7 StartDateTime is: "_hl7time)
 . ;
 . s ENDDT=hl7endTime
 . s @eval@("encounters",zi,"parms","ENDDT")=ENDDT
 . d log(jlog,"HL7 End DateTime is: "_ENDDT)
 . ;
 . ; reason code
 . s SCTDX=reasoncode
 . n icdcode,icdcodetype,notmapped,sctcode
 . s icdcode=""
 . s sctcode=reasoncode
 . s notmapped=0
 . ;i sctcode'="" q:'$d(^BSTS)  d
 . i sctcode'=""  d  ;
 . . i fmtime<3151001 s icdcodetype="icd9"
 . . e  s icdcodetype="icd10"
 . . d log(jlog,"icd code type is: "_icdcodetype)
 . . i icdcodetype="icd9" s icdcode=$$MAP^SYNDHPMP("sct2icdnine",sctcode)
 . . e  s icdcode=$$MAP^SYNDHPMP("sct2icd",sctcode)
 . . i +icdcode=-1 s notmapped=1
 . . d:notmapped MAPERR^SYNQLDM(sctcode,icdcodetype)
 . . do log(jlog,"icd mapping is: "_icdcode)
 . . do:notmapped log(jlog,"snomed code "_sctcode_" is not mapped")
 . . set @eval@("conditions",zi,"vars","mappedIcdCode")=icdcode
 . s @eval@("encounters",zi,"parms","SCTDX")=SCTDX
 . ;
 . s ENCPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",ENCPROV,"")) ; this has to be the NPI number
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
 . s @eval@("encounters",zi,"parms","ENCPROV")=ENCPROV
 . d log(jlog,"Provider for outpatient is: "_ENCPROV)
 . ;
 . s CLINIC=$$MAP^SYNQLDM("OP","location") ; map containes the name of the clinic file #44
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",CLINIC,""))
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
 . s @eval@("encounters",zi,"parms","CLINIC")=CLINIC
 . d log(jlog,"Location for outpatient is: "_CLINIC)
 . ;
 . s @eval@("encounters",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)="" n ien s ien=$$dfn2ien^SYNFUTL(dfn)
 . . i ien="" q  ;
 . . if $$loadStatus("encounters",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Encounter already loaded, skipping")
 . . d log(jlog,"Calling ENCTUPD^SYNDHP61 data loader to add encounter")
 . . d ENCTUPD^SYNDHP61(.RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT)        ;Encounter update
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . ;
 . . m @eval@("encounters",zi,"status","return")=RETSTA
 . . n visitIen s visitIen=$p(RETSTA,"^",2) ; returned visit ien
 . . i +visitIen>0 d
 . . . ;
 . . . n groot s groot=$na(@root@(ien))
 . . . d setIndex^SYNFHIR(groot,id,"visitIen",visitIen) ; save the visit ien in the indexes
 . . . s @eval@("encounters",zi,"visitIen")=visitIen
 . . e  s visitIen=""
 . . if +$g(RETSTA)=1 do  ;
 . . . s @eval@("encounters","status","loaded")=$g(@eval@("encounters","status","loaded"))+1
 . . . s @eval@("encounters",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s @eval@("encounters","status","errors")=$g(@eval@("encounters","status","errors"))+1
 . . . s @eval@("encounters",zi,"status","loadstatus")="notLoaded"
 . . . s @eval@("encounters",zi,"status","loadMessage")=$g(RETSTA)
 . . ;k @root@(ien,"load","encounters",zi)
 . . ;m @root@(ien,"load","encounters",zi)=@eval@("encounters",zi)
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=json
 . m jrslt("args")=args
 . m jrslt("eval")=@eval
 m jrslt("encountersStatus")=@eval@("encountersStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(@eval@("encounters","status","loaded"))
 set jrslt("result","errors")=$g(@eval@("encounters","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=@eval
 . m result("status")=jrslt("result")
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)    ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 w:$G(DEBUG) !,"      ",$G(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
visitIen(ien,encId)     ; extrinsic returns the visit ien for the Encounter ID
 ; returns -1 if none found
 i $g(encId)="" q -1
 n root s root=$$setroot^SYNWD("fhir-intake")
 n useenc s useenc=encId
 i useenc["urn:uuid:" s useenc=$p(useenc,"urn:uuid:",2)
 n vrtn
 s vrtn=$o(@root@(ien,"SPO",useenc,"visitIen",""))
 i vrtn="" s vrtn=-1
 q vrtn
 ;
testall ; run the encounters import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeEncounters(.filter,,.reslt,ien)
 q
 ;
IMPORT(rtn,ien) ; encounters, immunizations, problems for patient ien
 n filter
 k rtn
 s filter("load")=1
 s filter("debug")=1
 d importEncounters^SYNFENC(.rtn,ien,.filter)
 d importImmu^SYNFIMM(.rtn,ien,.filter)
 d importConditions^SYNFPR2(.rtn,ien,.filter)
 q
 ;
 ;
LOADALL(count) ; count is how many to do. default is 1000
 D INITMAPS^SYNQLDM ; make sure map table is loaded
 i '$d(count) s count=1000
 n root s groot=$$setroot^SYNWD("fhir-intake")
 n cnt s cnt=0
 n %1 s %1=0
 f  s %1=$o(@groot@(%1)) q:+%1=0  q:cnt=count  d  ;
 . n eroot s eroot=$na(@groot@(%1,"load","encounters"))
 . q:$d(@eroot)
 . q:%1=33
 . q:%1=82
 . q:$g(@eroot@("loadstatus"))="started"
 . s cnt=cnt+1
 . s @eroot@("loadstatus")="started"
 . n filter
 . s filter("load")=1
 . n g s $p(g,"+",80)="" w !,g
 . w !,"loading "_%1_" "_$$FMTE^XLFDT($$NOW^XLFDT)
 . w !,g
 . n rtn
 . ;d taskLabs^SYNFHIR(.rtn,%1,.filter)
 . d importEncounters^SYNFENC(.rtn,%1,.filter)
 . d importImmu^SYNFIMM(.rtn,%1,.filter)
 . d importConditions^SYNFPRB(.rtn,%1,.filter)
 . do importAppointment^SYNFAPT(.return,%1,.filter)
 . ;do importMeds^SYNFMED2(.return,%1,.filter)
 . do importProcedures^SYNFPROC(.return,%1,.filter)
 q
 ;
NEXT(start) ; extrinsic which returns the next patient for encounter loading
 ; start is the dfn to start looking, default is zerro
 i '$d(start) s start=0
 n root s groot=$$setroot^SYNWD("fhir-intake")
 n %1 s %1=start
 n returnien s returnien=0
 f  s %1=$o(@groot@(%1)) q:+%1=0  q:+returnien>0  d  ;
 . n eroot s eroot=$na(@groot@(%1,"load","encounters"))
 . q:$d(@eroot)
 . q:%1=33
 . q:%1=82
 . q:$g(@eroot@("loadstatus"))="started"
 . s returnien=%1
 q returnien
 ;

SYNFGR
SYNFGR  ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
resources(ary,lvl)      ; finds all the fhir resources and counts them up
 ; returns ary, passed by name
 ;
 n root s root=$$setroot^SYNWD("fhir-intake")
 n ien,rien
 s (ien,rien)=0
 f  s ien=$o(@root@(ien)) q:+ien=0  d  ;
 . s rien=0
 . f  s rien=$o(@root@(ien,"json","entry",rien)) q:+rien=0  d  ;
 . . n rtype,rtext,rcode
 . . s rtype=$g(@root@(ien,"json","entry",rien,"resource","resourceType"))
 . . q:rtype=""
 . . s @ary@(rtype)=$g(@ary@(rtype))+1
 . . q:$g(lvl)<2
 . . i rtype="Goal" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","description","text"))
 . . . q:rtext=""
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
 . . i rtype="Observation" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","category",1,"coding",1,"code"))
 . . . q:rtext=""
 . . . ;i rtext="procedure" b
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
 . . i rtype="Procedure" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","code","text"))
 . . . q:rtext=""
 . . . s rcode=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"code"))
 . . . q:rcode=""
 . . . s @ary@(rtype,rtext,rcode)=$g(@ary@(rtype,rtext,rcode))+1
 . . i rtype="DiagnosticReport" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"display"))
 . . . q:rtext=""
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
 . . i rtype="CarePlan" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","category",1,"coding",1,"display"))
 . . . q:rtext=""
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
 q
 ;
careplans(ary,lvl)      ; finds all the careplans and counts them up
 ; returns ary, passed by name
 ;
 n root s root=$$setroot^SYNWD("fhir-intake")
 n ien,rien
 s (ien,rien)=0
 f  s ien=$o(@root@(ien)) q:+ien=0  d  ;
 . s rien=0
 . f  s rien=$o(@root@(ien,"json","entry",rien)) q:+rien=0  d  ;
 . . n rtype,rtext,rcode
 . . s rtype=$g(@root@(ien,"json","entry",rien,"resource","resourceType"))
 . . q:rtype=""
 . . ;s @ary@(rtype)=$g(@ary@(rtype))+1
 . . i rtype="Goal" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","description","text"))
 . . . q:rtext=""
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
 . . i rtype="CarePlan" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","category",1,"coding",1,"display"))
 . . . s rcode=$g(@root@(ien,"json","entry",rien,"resource","category",1,"coding",1,"code"))
 . . . q:rtext=""
 . . . s rtext=$g(rcode)_" "_rtext
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
 . . . n cp s cp=$na(@root@(ien,"json","entry",rien,"resource"))
 . . . i $d(@cp@("activity")) d  ;
 . . . . n act s act=0
 . . . . f  s act=$o(@cp@("activity",act)) q:+act=0  d  ;
 . . . . . n acode,atext,atext2
 . . . . . s acode=$g(@cp@("activity",act,"detail","code","coding",1,"code"))
 . . . . . s atext=$g(@cp@("activity",act,"detail","code","coding",1,"display"))
 . . . . . s atext2=acode_" "_$e(atext,1,60)
 . . . . . s @ary@(rtype,rtext,"activity",atext2)=$g(@ary@(rtype,rtext,"activity",atext2))+1
 q
 ;
makecpmap ; make a careplan map in a graph
 ;
 n root,map
 s root=$$setroot^SYNWD("careplanmap")
 d careplans("map")
 k @root
 m @root=map
 q
 ;
careplanshf(ary,lvl)      ; finds all the careplans and counts them up
 ; returns ary, passed by name
 ;
 n root s root=$$setroot^SYNWD("fhir-intake")
 n ien,rien
 s (ien,rien)=0
 n done s done=0
 f  s ien=$o(@root@(ien)) q:+ien=0  q:done  d  ;
 . s rien=0
 . f  s rien=$o(@root@(ien,"json","entry",rien)) q:+rien=0  d  ;
 . . n rtype,rtext,rtext2,rtext3,rcode,catext
 . . s rtype=$g(@root@(ien,"json","entry",rien,"resource","resourceType"))
 . . q:rtype=""
 . . ;s @ary@(rtype)=$g(@ary@(rtype))+1
 . . i rtype="Goal" d  ;
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","description","text"))
 . . . s rtext=$$HFGOAL^SYNFHF(rtext)
 . . . q:rtext=""
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
 . . i rtype="CarePlan" d  ;
 . . . n catien s catien=""
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","category",1,"coding",1,"display"))
 . . . s rcode=$g(@root@(ien,"json","entry",rien,"resource","category",1,"coding",1,"code"))
 . . . q:rtext=""
 . . . s catext=$$HFCPCAT^SYNFHF(rcode,rtext)
 . . . s catien=$p(catext,"^",1)
 . . . s catext=$p(catext,"^",2)
 . . . ;s rtext=$g(rcode)_" "_rtext
 . . . s @ary@(rtype,catext)=$g(@ary@(rtype,catext))+1
 . . . s rtext3=$$HFCP^SYNFHF(rcode,rtext,catien)
 . . . s rtext3=$p(rtext3,"^",2)
 . . . s @ary@(rtype,catext,"carePlanHF",rtext3)=$g(@ary@(rtype,catext,"carePlanHF",rtext3))+1
 . . . n cp s cp=$na(@root@(ien,"json","entry",rien,"resource"))
 . . . i $d(@cp@("activity")) d  ;
 . . . . n act s act=0
 . . . . f  s act=$o(@cp@("activity",act)) q:+act=0  d  ;
 . . . . . n acode,atext,atext2
 . . . . . s acode=$g(@cp@("activity",act,"detail","code","coding",1,"code"))
 . . . . . s atext=$g(@cp@("activity",act,"detail","code","coding",1,"display"))
 . . . . . ;s atext2=acode_" "_$e(atext,1,60)
 . . . . . s atext2=$e(atext,1,60)
 . . . . . s atext2=$$HFACT^SYNFHF(acode,atext2,catien)
 . . . . . s atext2=$p(atext2,"^",2)
 . . . . . s @ary@(rtype,catext,"activity",atext2)=$g(@ary@(rtype,catext,"activity",atext2))+1
 . . . ;s done=1
 q
 ;
makecpmaphf ; make a careplan map in a graph
 ;
 n root,map
 d purgegraph^SYNWD("cpmaphf3")
 s root=$$setroot^SYNWD("cpmaphf3")
 ;k @root
 d careplanshf("map")
 m @root=map
 q
 ;

SYNFHF
SYNFHF  ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 ; Health Factors
 q
 ;
HFCPCAT(CODE,TEXT) ; returns ien^name for the Health Factor Category
 ; for the Care Plan category. This ien will be needed for all
 ; calls to get Care Plan, Activity, and Goal Health Factors
 ;
 n COMMENT
 s COMMENT="SYN Care Plan Health Factor Category for: "_CODE_" "_TEXT
 q $$GETHF("CPCAT","",CODE,TEXT,1,COMMENT,1)
 ;
HFCP(CODE,TEXT,CAT) ; returns ien^name for the Care Plan Health Factor
 ; CAT is the ien^name (name optional) of the Health Factor Category
 ; for this Care Plan Health Factor
 ; CODE is the Snomed code for the Care Plan Category
 ; TEXT is the Snomed text for the Care Plan Category
 ;
 n COMMENT
 s COMMENT="SYN Care Plan Health Factor for: "_CODE_" "_TEXT
 q $$GETHF("CP",CAT,CODE,TEXT,0,COMMENT,1)
 ;
HFACT(CODE,TEXT,CAT) ; returns ien^name for a Care Plan Activity
 ; in the Care Plan Category CAT (ien)
 ;
 n COMMENT
 s COMMENT="SYN Care Plan Activity Health Factor for: "_CODE_" "_TEXT
 q $$GETHF("ACT",CAT,CODE,TEXT,0,COMMENT,1)
 ;
HFADDR(CODE,TEXT,CAT) ; returns ien^name for a Care Plan Address HF
 ; in the Care Plan Category CAT (ien)
 ;
 n COMMENT
 s COMMENT="SYN Care Plan Adresses Health Factor for: "_CODE_" "_TEXT
 q $$GETHF("ADDR",CAT,CODE,TEXT,0,COMMENT,1)
 ;
HFGOAL(CODE,CAT,TEXT,DIAG) ; returns ien^name for a Care Plan Goal
 ; in the Care Plan Category CAT (ien)
 ; DIAG is the diagnosis code^text for the problem the goal addresses (opt)
 ;
 n COMMENT
 s COMMENT=TEXT_" which addresses: "_$g(DIAG)
 q $$GETHF("GOAL",$g(CAT),CODE,TEXT,0,COMMENT,1)
 ;
 ;
HFPOV(CODE,TEXT) ; returns ien^name for the Purpose of Visit Health Factor
 ; in the SYN POV  health factor category
 ;
 ;
 N CMT0
 s CMT0="SYN Purpose of Visit SNOMED Codes"
 n ien
 s ien=$$GETHF("POV",,"","Purpose of visit codes",1,CMT0,0)
 n COMMENT
 s COMMENT="SYN Purpose of Visit Health Factor for: "_CODE_" "_TEXT
 q $$GETHF("POV",ien,CODE,TEXT,0,COMMENT,1)
 ;
HFPROC(CODE,TEXT) ; returns the ien^name of the Procedures Health Factor
 ; in category SYN SNOMED PROCEDURES
 ;
 N CMT0
 s CMT0="SYN Procedure Health Codes"
 n ien
 s ien=$$GETHF("POV",,"","Procedure codes",1,CMT0,0)
 n COMMENT
 s COMMENT="SYN Procedure Health Factor for: "_CODE_" "_TEXT
 q $$GETHF("PROC",,CODE,TEXT,0,COMMENT,1)
 ;
 ; the following are private routines used by the above public APIs
 ;
GETHF(SYNCAT,HFCAT,CODE,TEXT,ISHFCAT,CMT,LAYGO) ;
 ; returns ien^name of the health factor
 ; SYNCAT is the text abbrieviation of the kind of health factor one of:
 ;   CPCAT = care plan category
 ;   CP = care plan
 ;   ACT = care plan activity
 ;   GOAL = care plan goal
 ;   POV = purpose of visit
 ;   PROC = SNOMED procedure
 ; if ISHFCAT=1 the HEALTH FACTOR is a HEALTH FACTOR category
 ; if LAYGO=1 the HEALTH FACTOR will be created if it does not exist
 ;
 n name,ien,cpart,nlen,cde,cdesys
 s (cpart,cde,cdesys)=""
 i CODE[":" d  ;
 . s cpart=" ("_CODE_")"
 . s cde=$p(CODE,":",2)
 . s cdesys=$p(CODE,":",1)
 e  d  ;
 . q:$G(CODE)=""
 . s cpart=" (SCT:"_CODE_")"
 . s cde=CODE
 . s cdesys="SCT"
 s nlen=64-$l(cpart)
 s name="SYN "_SYNCAT_" "_TEXT
 i $l(name)>nlen s name=$e(name,1,nlen)
 s name=name_cpart
 s pname=TEXT ; print name
 s name=$$UP^XLFSTR(name) ; hf name
 i ISHFCAT=1 d  ; name for a health factor category
 . i $l(name)>60 s name=$e(name,1,60) ; leave room for [C]
 . s name=name_" [C]"
 s ien=$o(^AUTTHF("B",name,""))
 i ien'=""  q ien_"^"_name
 ; hf not found
 i $g(LAYGO)'=1 Q "-1^Health Factor not found: "_name
 n FDA,fn,fncode
 s fn=9999999.64
 s fncode=9999999.66
 s FDA(fn,"?+1,",.01)=name
 s FDA(fn,"?+1,",.03)=+HFCAT
 s FDA(fn,"?+1,",.08)="Y"
 s FDA(fn,"?+1,",.1)=$s($G(ISHFCAT)=1:"C",1:"F")
 s FDA(fn,"?+1,",100)="L"
 s FDA(fn,"?+1,",200)=$G(CMT)
 ;s FDA(fn,"?+1,",201)=$G(CMT) ; WORD PROCESSING FIELD
 I $D(^DD(9999999.64,200)) D  ; this system has the codes subfile
 . q:cdesys=""
 . s FDA(fncode,"?+2,?+1,",.01)=cdesys ; always code system
 . s FDA(fncode,"?+2,?+1,",1)=cde ;
 . s FDA(fncode,"?+2,?+1,",2)=$p($$NOW^XLFDT,".",1) ;
 n err
 D UPDIE(.FDA,.ien)
 i ien="" s ien=$o(^AUTTHF("B",name,""))
 q ien_"^"_name
 ;
UPDIE(ZFDA,ZIEN) ; INTERNAL ROUTINE TO CALL UPDATE^DIE AND CHECK FOR ERRORS
 ; ZFDA IS PASSED BY REFERENCE
 ; ZIEN IS PASSED BY REFERENCE
 ;D:$G(DEBUG)
 ;. ZWRITE ZFDA
 ;. B
 K ZERR
 D CLEAN^DILF
 D UPDATE^DIE("K","ZFDA","ZIEN","ZERR")
 I $D(ZERR) ZWR ZERR
 I '$G(TRUST) I $D(ZERR) S ZZERR=ZZERR ; ZZERR DOESN'T EXIST,
 ; INVOKE THE ERROR TRAP IF TASKED
 ;. W "ERROR",!
 ;. ZWR ZERR
 ;. B
 K ZFDA
 Q
 ;

SYNFHIR
SYNFHIR ;ven/gpl - fhir loader utilities ; 6/28/19 2:00pm
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
wsPostFHIR(ARGS,BODY,RESULT,ien)    ; recieve from addpatient
 ; ien is for internal calls to this routine, and is the ien
 ; in the graphstore for the decoded json
 ;
 s U="^"
 ;S DUZ=1
 ;S DUZ("AG")="V"
 ;S DUZ(2)=500
 S USER=$$DUZ^SYNDHP69
 ;
 ;new json,ien,root,gr,id,return
 new json,root,gr,id,return
 set root=$$setroot^SYNWD("fhir-intake")
 set id=$get(ARGS("id"))
 ;
 i $g(ien)="" d  ; not called internally
 . set ien=$order(@root@(" "),-1)+1
 . set gr=$name(@root@(ien,"json"))
 . merge json=BODY
 . do decode^SYNJSON("json",gr)
 ;
 do indexFhir(ien)
 ;
 if id'="" do  ;
 . set @root@("B",id,ien)=""
 else  do  ;
 . ;
 ;
 if $get(ARGS("returngraph"))=1 do  ;
 . merge return("graph")=@root@(ien,"graph")
 set return("status")="ok"
 set return("id")=id
 set return("ien")=ien
 ;
 do importPatient^SYNFPAT(.return,ien)
 ;
 new rdfn set rdfn=$get(return("dfn"))
 if rdfn'="" set @root@("DFN",rdfn,ien)=""
 ;
 if rdfn'="" do  ; patient creation was successful
 . if $g(ARGS("load"))="" s ARGS("load")=1
 . ;do taskLabs(.return,ien,.ARGS)
 . DO importLabs^SYNFLAB(.return,ien,.ARGS)
 . do importVitals^SYNFVIT(.return,ien,.ARGS)
 . do importEncounters^SYNFENC(.return,ien,.ARGS)
 . do importImmu^SYNFIMM(.return,ien,.ARGS)
 . do importConditions^SYNFPRB(.return,ien,.ARGS)
 . do importAllergy^SYNFALG(.return,ien,.ARGS)
 . do importAppointment^SYNFAPT(.return,ien,.ARGS)
 . do importMeds^SYNFMED2(.return,ien,.ARGS)
 . do importProcedures^SYNFPROC(.return,ien,.ARGS)
 . do importCarePlan^SYNFCP(.return,ien,.ARGS)
 ;
 do encode^SYNJSON("return","RESULT")
 set HTTPRSP("mime")="application/json"
 ;
 quit 1
 ;
indexFhir(ien)  ; generate indexes for parsed fhir json
 ;
 new root set root=$$setroot^SYNWD("fhir-intake")
 if $get(ien)="" quit  ;
 ;
 new jroot set jroot=$name(@root@(ien,"json","entry")) ; root of the json
 if '$data(@jroot) quit  ; can't find the json to index
 ;
 new jindex set jindex=$name(@root@(ien)) ; root of the index
 d clearIndexes(jindex)
 ;
 new %wi s %wi=0
 for  set %wi=$order(@jroot@(%wi)) quit:+%wi=0  do  ;
 . new type
 . set type=$get(@jroot@(%wi,"resource","resourceType"))
 . if type="" do  quit  ;
 . . w !,"error resource type not found ien= ",ien," entry= ",%wi
 . set @jindex@("type",type,%wi)=""
 . d triples(jindex,$na(@jroot@(%wi)),%wi)
 quit
 ;
triples(index,ary,%wi)  ; index and array are passed by name
 ;
 i type="Patient" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 i type="Encounter" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n sdate s sdate=$g(@ary@("resource","period","start")) q:sdate=""
 . n hl7date s hl7date=$$fhirThl7^SYNFUTL(sdate)
 . d setIndex(index,purl,"dateTime",sdate)
 . d setIndex(index,purl,"hl7dateTime",hl7date)
 . n class s class=$g(@ary@("resource","class","code")) q:class=""
 . d setIndex(index,purl,"class",class)
 i type="Condition" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","context","reference"))
 . i enc="" s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 i type="Observation" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","context","reference"))
 . i enc="" s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 i type="Medication" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 i type="medicationReference" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","context","reference"))
 . i enc="" s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 i type="Immunizationi" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","patient","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 n purl s purl=$g(@ary@("fullUrl"))
 i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 i $e(purl,$l(purl))="/" s purl=purl_%wi
 d setIndex(index,purl,"type",type)
 d setIndex(index,purl,"rien",%wi)
 n enc s enc=$g(@ary@("resource","context","reference"))
 i enc="" s enc=$g(@ary@("resource","encounter","reference"))
 d setIndex(index,purl,"encounterReference",enc)
 n pat s pat=$g(@ary@("resource","subject","reference"))
 i pat="" s pat=$g(@ary@("resource","patient","reference"))
 d setIndex(index,purl,"patientReference",pat)
 q
 ;
setIndex(gn,sub,pred,obj)       ; set the graph indexices
 ;n gn s gn=$$setroot^SYNWD("fhir-intake")
 q:sub=""
 q:pred=""
 q:obj=""
 s @gn@("SPO",sub,pred,obj)=""
 s @gn@("POS",pred,obj,sub)=""
 s @gn@("PSO",pred,sub,obj)=""
 s @gn@("OPS",obj,pred,sub)=""
 q
 ;
clearIndexes(gn)        ; kill the indexes
 k @gn@("SPO")
 k @gn@("POS")
 k @gn@("PSO")
 k @gn@("OPS")
 q
 ;
wsShow(rtn,filter)      ; web service to show the fhir
 new type set type=$get(filter("type"))
 new root set root=$$setroot^SYNWD("fhir-intake")
 ;
 new ien set ien=$g(filter("ien"))
 if ien="" d  ;
 . n icn
 . s icn=$g(filter("icn"))
 . q:icn=""
 . s ien=$o(@root@("ICN",icn,""))
 if ien="" d  ;
 . n dfn
 . s dfn=$g(filter("dfn"))
 . q:dfn=""
 . s ien=$o(@root@("DFN",dfn,""))
 if ien="" quit  ;
 ;
 new jroot set jroot=$name(@root@(ien,"json"))
 ;
 new jtmp,juse
 set juse=jroot
 if type'="" do  ;
 . do getIntakeFhir("jtmp",$g(filter("bundle")),type,ien,1)
 . ;do getIntakeFhir("jtmp",,type,ien,1)
 . set juse="jtmp"
 do encode^SYNJSON(juse,"rtn")
 s HTTPRSP("mime")="application/json"
 quit
 ;
getIntakeFhir(rtn,id,type,ien,plain)    ; returns fhir vars for patient bundle=id resourceType type
 ; id is the bundle date range to be returned, optional
 ; if id is not passed, all resources of the type are returned
 ; ien is required and is the graph ien of the patient
 ; rtn passed by name. it will overlay results in @rtn, so is additive
 ; if plain is 1 then the array is returned without the type as the first
 ;    element of each node
 ;
 new root set root=$$setroot^SYNWD("fhir-intake")
 if $g(ien)="" set ien=$order(@root@("B",id,""))
 if ien="" quit  ;
 ;
 if $get(type)="" set type="all"
 kill @rtn
 ;
 i $g(id)="" s id=""
 i $g(SYNBUNDLE)'="" S id=SYNBUNDLE
 ;
 if type'="all" do  quit  ;
 . do get1FhirType(rtn,root,ien,type,$get(plain),id)
 ;
 new jindex set jindex=$name(@root@(ien))
 new %wj set %wj=""
 for  set %wj=$order(@jindex@("type",%wj)) quit:%wj=""  do  ;
 . ;w !,"type ",%wj
 . do get1FhirType(rtn,root,ien,%wj,$get(plain),id)
 ;
 quit
 ;
get1FhirType(rtn,root,ien,type,plain,bundle)   ; get one resourceType from the json
 new %wi set %wi=0
 new jindex set jindex=$name(@root@(ien))
 if '$data(@jindex@("type",type)) quit  ;
 for  s %wi=$order(@jindex@("type",type,%wi)) quit:+%wi=0  do  ;
 . i $g(@jindex@(%wi,"bundle"))'=bundle q  ;
 . if $get(plain)=1 merge @rtn@("entry",%wi)=@root@(ien,"json","entry",%wi)
 . else  merge @rtn@(type,"entry",%wi)=@root@(ien,"json","entry",%wi)
 quit
 ;
fhir2graph(in,out)      ; transforms fhir to a graph
 ; in and out are passed by name
 ; detects if json parser has been run and will run it if not
 ;
 new json
 if $ql($q(@in@("")))<2 do decode^SYNJSON(in,"json") set in="json"
 ;
 new rootj
 set rootj=$na(@in@("entry"))
 new i,cnt
 for i=1:1:$order(@rootj@(" "),-1) do  ;
 . new rname
 . set rname=$get(@rootj@(i,"resource","resourceType"))
 . if rname="" do  quit  ;
 . . w !,"error no resourceType in entry: ",i
 . . ;zwrite @rootj@(i,*)
 . . b
 . if '$data(@out@(rname)) set cnt=1
 . else  set cnt=$order(@out@(rname,""),-1)+1
 . merge @out@(rname,cnt)=@rootj@(i,"resource")
 quit
 ;
taskLabs(return,ien,ARGS) ;load Labs with TASKMAN
 ;
 NEW YSDUZ,ZTRTN,ZTDESC,ZTDTH,ZTSAVE,ZTIO,PATIEN  ;,JOBNBR
 SET YSDUZ=DUZ
 SET ZTRTN="runLabs^SYNFHIR"
 SET ZTDESC="Load Patient Labs"
 SET ZTDTH=$H
 SET ZTIO=""
 SET JOBNBR=$J
 SET PATIEN=ien
 SET ZTSAVE("PATIEN")=""
 ;Submit the job to Taskman
 ;ZWRITE ARGS
 DO ^%ZTLOAD
 ;
 QUIT
 ;
runLabs ; This is what is submitted to Taskman
 NEW args,ien,return
 ;
 SET ien=PATIEN
 SET args("load")=1
 DO importLabs^SYNFLAB(.return,ien,.args)
 ;
 QUIT
 ;
getEntry(ary,ien,rien) ; returns one entry in ary, passed by name
 n root s root=$$setroot^SYNWD("fhir-intake")
 i '$d(@root@(ien,"json","entry",rien)) q  ;
 m @ary@("entry",rien)=@root@(ien,"json","entry",rien)
 q
 ;
loadStatus(ary,ien,rien) ; returns the "load" section of the patient graph
 ; if rien is not specified, all entries are included
 n root s root=$$setroot^SYNWD("fhir-intake")
 i '$d(@root@(ien)) q
 i $g(rien)="" d  q  ;
 . k @ary
 . m @ary@(ien)=@root@(ien,"load")
 n zi s zi=""
 f  s zi=$o(@root@(ien,"load",zi)) q:$d(@root@(ien,"load",zi,rien))
 k @ary
 m @ary@(ien,rien)=@root@(ien,"load",zi,rien)
 q
 ;
wsLoadStatus(rtn,filter) ; displays the load status
 ; filter must have ien or dfn to specify the patient
 ; optionally, entry number (rien) for a single entry
 ; if ien and dfn are both specified, dfn is used
 ; now supports latest=1 to show the load status of the lastest added patient
 n root s root=$$setroot^SYNWD("fhir-intake")
 n ien s ien=$g(filter("ien"))
 i $g(filter("latest"))=1 d  ;
 . set ien=$o(@root@(" "),-1)
 n dfn s dfn=$g(filter("dfn"))
 i dfn'="" s ien=$$dfn2ien^SYNFUTL(dfn)
 n rien s rien=$g(filter("rien"))
 q:ien=""
 n load
 d loadStatus("load",ien,rien)
 s filter("root")="load"
 s filter("local")=1
 d wsGLOBAL^SYNVPR(.rtn,.filter)
 q
 ;
FILE(directory) ; [Public] Load files from the file system; OPT: SYN LOAD FILES
 ;
 if '$data(directory) do
 . N DIR,X,Y,DA,DIRUT,DTOUT,DUOUT,DIROUT
 . S DIR(0)="F^0:1024"
 . S DIR("A")="Enter directory from which to load Synthea Patients (FHIR DSTU3 or R4)"
 . D ^DIR
 . W !
 . if '$data(DIRUT) set directory=Y
 quit:'$data(directory)
 ;
 ; Load files from directory
 new synfiles
 new synmask set synmask("*.json")=""
 new % set %=$$LIST^%ZISH(directory,$na(synmask),$na(synfiles))
 if '% write "Failed to read any files. Check directory.",! quit
 ;
 new file set file=""
 for  set file=$order(synfiles(file)) q:file=""  do
 . if file["Information" quit  ; We don't process information files yet...
 . ;
 . write "Loading ",file,"...",!
 . kill ^TMP("SYNFILE",$J)
 . new % set %=$$FTG^%ZISH(directory,file,$name(^TMP("SYNFILE",$J,1)),3)
 . i '% write "Failed to read the file. Please debug me.",! quit
 . ;
 . ; Normalize overflow nodes (and hope for the best that we don't go over 32k)
 . new i,j set (i,j)=""
 . for  set i=$order(^TMP("SYNFILE",$J,i)) quit:'i  for  set j=$order(^TMP("SYNFILE",$J,i,"OVF",j)) quit:'j  do
 .. set ^TMP("SYNFILE",$J,i)=^TMP("SYNFILE",$J,i)_^TMP("SYNFILE",$J,i,"OVF",j)  ; ** NOT TESTED **
 . ;
 . ; Now load the file into VistA
 . write "Ingesting ",file,"...",!
 . do
 .. new file,directory,synfiles
 .. do KILL^XUSCLEAN ; VistA leaks like hell
 . new args,body,synjsonreturn,ien,root,gr
 . set root=$$setroot^SYNWD("fhir-intake")
 . set ien=$order(@root@(" "),-1)+1
 . set gr=$name(@root@(ien,"json"))
 . s body=$na(^TMP("SYNFILE",$J))
 . do decode^SYNJSON(body,gr)
 . ;merge body=^TMP("SYNFILE",$J) ;don't need to merge because we decoded
 . ;new % set %=$$wsPostFHIR(.args,.body,.synjsonreturn) ; % always comes out as 1. We will ignore it.
 . new % set %=$$wsPostFHIR(.args,.body,.synjsonreturn,ien) ; % always comes out as 1. We will ignore it.
 . ;
 . ; Get the status back from JSON
 . new synreturn,synjsonerror
 . do decode^SYNJSON($na(synjsonreturn),$na(synreturn),$na(synjsonerror))
 . if $data(synjsonerror) write "There is an error decoding the return. Debug me." quit
 . ;
 . if $get(synreturn("loadMessage"))["Duplicate" write "Patient Already Loaded",! quit
 . ;
 . write "Loaded with following data: ",!
 . write "DFN: ",synreturn("dfn"),?20,"ICN: ",synreturn("icn"),?50,"Graph Store IEN: ",synreturn("ien"),!
 . write "--------------------------------------------------------------------------",!
 . write "Type",?30,"Loaded?",?60,"Error",!
 . ;
 . write "ADR/Allergy"
 . write ?30,synreturn("allergyStatus","loaded")
 . write ?60,synreturn("allergyStatus","errors")
 . write !
 . ;
 . write "Appointments"
 . write ?30,synreturn("apptStatus","loaded")
 . write ?60,synreturn("apptStatus","errors")
 . write !
 . ;
 . write "Care Plans"
 . write ?30,synreturn("careplanStatus","loaded")
 . write ?60,synreturn("careplanStatus","errors")
 . write !
 . ;
 . write "Problems"
 . write ?30,synreturn("conditionsStatus","loaded")
 . write ?60,synreturn("conditionsStatus","errors")
 . write !
 . ;
 . write "Encounters"
 . write ?30,synreturn("encountersStatus","loaded")
 . write ?60,synreturn("encountersStatus","errors")
 . write !
 . ;
 . write "Immunization"
 . write ?30,synreturn("immunizationsStatus","loaded")
 . write ?60,synreturn("immunizationsStatus","errors")
 . write !
 . ;
 . write "Labs"
 . write ?30,synreturn("labsStatus","loaded")
 . write ?60,synreturn("labsStatus","errors")
 . write !
 . ;
 . write "Meds"
 . write ?30,synreturn("medsStatus","loaded")
 . write ?60,synreturn("medsStatus","errors")
 . write !
 . ;
 . write "Procedures"
 . write ?30,synreturn("proceduresStatus","loaded")
 . write ?60,synreturn("proceduresStatus","errors")
 . write !
 . ;
 . write "Vitals"
 . write ?30,synreturn("vitalsStatus","loaded")
 . write ?60,synreturn("vitalsStatus","errors")
 . write !
 . ;
 . write !
 quit
 ;

SYNFHIRU
SYNFHIRU ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
wsUpdatePatient(ARGS,BODY,RESULT)    ; recieve from updatepatient
 ;
 s U="^"
 ;S DUZ=1
 ;S DUZ("AG")="V"
 ;S DUZ(2)=500
 S USER=$$DUZ^SYNDHP69
 ;
 new json,ien,root,gr,id,return
 set root=$$setroot^SYNWD("fhir-intake")
 set id=$get(ARGS("id"))
 ;
 ; first locate the patient to be updated
 ;
 n icn s icn=$g(ARGS("icn"))
 i (icn="")&(id="") d  q 0 ; set http error to bad request
 . s HTTPERR=400 ; bad request
 s ien=$o(@root@("POS","ICN",icn,""))
 i ien="" d  ; try id
 . s ien=$o(@root@("POS","ICN",id,"")) ; ok to use id instead of icn
 . i ien'="" s icn=id
 i ien="" d  q 0 ; icn not found
 . s HTTPERR=404
 ;
 merge json=BODY
 i '$d(json) d  q 0 ;
 . s HTTPERR=400
 ;
 n gr1,zi,cnt,rien ; initial entries
 do decode^SYNJSONE("json","gr1")
 ;
 ; shift resource numbers to fit in graph
 ;
 n lastrien s lastrien=$o(@root@(ien,"json","entry"," "),-1)
 s zi=0 s cnt=0
 f  s zi=$o(gr1("entry",zi)) q:+zi=0  d  ;
 . s cnt=cnt+1
 . s rien=lastrien+cnt
 . m gr(ien,"json","entry",rien)=gr1("entry",zi)
 ;
 ;
 do indexFhir(ien,"gr")
 ;k ^gpl("gr")
 ;m ^gpl("gr")=gr ; for debugging
 ;
 ;
 if $get(ARGS("returngraph"))=1 do  ;
 . merge return("graph")=gr
 set return("status")="ok"
 set return("icn")=icn
 set return("ien")=ien
 n bundle s bundle=$$bundleId($na(gr(ien)))
 set return("bundle")=bundle
 set ARGS("bundle")=bundle ; ingest only resources in this bundle
 s SYNBUNDLE=bundle
 ;
 ; commit the bundle to the graph
 m @root=gr
 ;
 new rdfn set rdfn=$o(@root@("SPO",ien,"DFN",""))
 if rdfn'="" set @root@("DFN",rdfn,ien)=""
 ;
 if rdfn'="" do  ; patient creation was successful
 . if $g(ARGS("load"))="" s ARGS("load")=1
 . ;do taskLabs(.return,ien,.ARGS)
 . DO importLabs^SYNFLAB(.return,ien,.ARGS)
 . do importVitals^SYNFVIT(.return,ien,.ARGS)
 . do importEncounters^SYNFENC(.return,ien,.ARGS)
 . do importImmu^SYNFIMM(.return,ien,.ARGS)
 . do importConditions^SYNFPR2(.return,ien,.ARGS)
 . do importAllergy^SYNFALG(.return,ien,.ARGS)
 . do importAppointment^SYNFAPT(.return,ien,.ARGS)
 . do importMeds^SYNFMED2(.return,ien,.ARGS)
 . do importProcedures^SYNFPROC(.return,ien,.ARGS)
 . do importCarePlan^SYNFCP(.return,ien,.ARGS)
 ;
 k SYNBUNDLE
 do encode^SYNJSONE("return","RESULT")
 set HTTPRSP("mime")="application/json"
 ;
 quit 1
 ;
indexFhir(ien,root)  ; generate indexes for parsed fhir json
 ;
 i $g(root)="" set root=$$setroot^SYNWD("fhir-intake")
 if $get(ien)="" quit  ;
 ;
 new jroot set jroot=$name(@root@(ien,"json","entry")) ; root of the json
 if '$data(@jroot) quit  ; can't find the json to index
 ;
 new jindex set jindex=$name(@root@(ien)) ; root of the index
 d clearIndexes(jindex)
 ;
 new %wi s %wi=0
 for  set %wi=$order(@jroot@(%wi)) quit:+%wi=0  do  ;
 . new type
 . set type=$get(@jroot@(%wi,"resource","resourceType"))
 . if type="" do  quit  ;
 . . w !,"error resource type not found ien= ",ien," entry= ",%wi
 . set @jindex@("type",type,%wi)=""
 . d triples(jindex,$na(@jroot@(%wi)),%wi)
 ;
 n bund
 s bund=$$bundleId(jindex)
 s %wi=0
 f  s %wi=$o(@jroot@(%wi)) q:+%wi=0  d  ;
 . s @jindex@(%wi,"bundle")=bund
 . d setIndex(jindex,%wi,"bundle",bund)
 ;
 quit
 ;
triples(index,ary,%wi)  ; index and array are passed by name
 ;
 i type="Patient" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 i type="Encounter" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n sdate s sdate=$g(@ary@("resource","period","start")) q:sdate=""
 . n hl7date s hl7date=$$fhirThl7^SYNFUTL(sdate)
 . d setIndex(index,purl,"dateTime",sdate)
 . d setIndex(index,purl,"hl7dateTime",hl7date)
 . n class s class=$g(@ary@("resource","class","code")) q:class=""
 . d setIndex(index,purl,"class",class)
 i type="Condition" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","context","reference"))
 . i enc="" s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 i type="Observation" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","context","reference"))
 . i enc="" s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 i type="Medication" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 i type="medicationReference" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","context","reference"))
 . i enc="" s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 i type="Immunization" d  q  ;
 . n purl s purl=$g(@ary@("fullUrl"))
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
 . d setIndex(index,purl,"type",type)
 . d setIndex(index,purl,"rien",%wi)
 . n enc s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 . d setIndex(index,purl,"encounterReference",enc)
 . n pat s pat=$g(@ary@("resource","patient","reference")) q:pat=""
 . d setIndex(index,purl,"patientReference",pat)
 n purl s purl=$g(@ary@("fullUrl"))
 i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
 i $e(purl,$l(purl))="/" s purl=purl_%wi
 d setIndex(index,purl,"type",type)
 d setIndex(index,purl,"rien",%wi)
 n enc s enc=$g(@ary@("resource","context","reference"))
 i enc="" s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
 d setIndex(index,purl,"encounterReference",enc)
 n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
 d setIndex(index,purl,"patientReference",pat)
 q
 ;
setIndex(gn,sub,pred,obj)       ; set the graph indexices
 ;n gn s gn=$$setroot^SYNWD("fhir-intake")
 q:sub=""
 q:pred=""
 q:obj=""
 s @gn@("SPO",sub,pred,obj)=""
 s @gn@("POS",pred,obj,sub)=""
 s @gn@("PSO",pred,sub,obj)=""
 s @gn@("OPS",obj,pred,sub)=""
 q
 ;
bundleId(ary) ; extrinsic returns the bundle date range
 n low,high
 s low=$o(@ary@("POS","dateTime",""))
 q:low="" ""
 s high=$o(@ary@("POS","dateTime",""),-1)
 s low=$p(low,"T",1)
 s high=$p(high,"T",1)
 q low_":"_high
 ;
clearIndexes(gn)        ; kill the indexes
 k @gn@("SPO")
 k @gn@("POS")
 k @gn@("PSO")
 k @gn@("OPS")
 q
 ;
getEntry(ary,ien,rien) ; returns one entry in ary, passed by name
 n root s root=$$setroot^SYNWD("fhir-intake")
 i '$d(@root@(ien,"json","entry",rien)) q  ;
 m @ary@("entry",rien)=@root@(ien,"json","entry",rien)
 q
 ;
loadStatus(ary,ien,rien) ; returns the "load" section of the patient graph
 ; if rien is not specified, all entries are included
 n root s root=$$setroot^SYNWD("fhir-intake")
 i '$d(@root@(ien)) q
 i $g(rien)="" d  q  ;
 . k @ary
 . m @ary@(ien)=@root@(ien,"load")
 n zi s zi=""
 f  s zi=$o(@root@(ien,"load",zi)) q:$d(@root@(ien,"load",zi,rien))
 k @ary
 m @ary@(ien,rien)=@root@(ien,"load",zi,rien)
 q
 ;
wsLoadStatus(rtn,filter) ; displays the load status
 ; filter must have ien or dfn to specify the patient
 ; optionally, entry number (rien) for a single entry
 ; if ien and dfn are both specified, dfn is used
 ; now supports latest=1 to show the load status of the lastest added patient
 n root s root=$$setroot^SYNWD("fhir-intake")
 n ien s ien=$g(filter("ien"))
 i $g(filter("latest"))=1 d  ;
 . set ien=$o(@root@(" "),-1)
 n dfn s dfn=$g(filter("dfn"))
 i dfn'="" s ien=$$dfn2ien^SYNFUTL(dfn)
 n rien s rien=$g(filter("rien"))
 q:ien=""
 n load
 d loadStatus("load",ien,rien)
 s filter("root")="load"
 s filter("local")=1
 d wsGLOBAL^SYNVPR(.rtn,.filter)
 q
 ;

SYNFIMM
SYNFIMM ;ven/gpl - fhir loader utilities ;Aug 15, 2019@15:21:45
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
importImmu(rtn,ien,args) ; entry point for loading Immunizations for a patient
 ; calls the intake Immunizations web service directly
 ;
 n grtn
 d wsIntakeImmu(.args,,.grtn,ien)
 s rtn("immunizationsStatus","status")=$g(grtn("status","status"))
 s rtn("immunizationsStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("immunizationsStatus","errors")=$g(grtn("status","errors"))
 quit
 ;
wsIntakeImmu(args,body,result,ien) ; web service entry (post)
 ; for intake of one or more Immunizations. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n jtmp,json,jrslt,eval
 ;i $g(ien)'="" if $$loadStatus("immunizations","",ien)=1 d  q  ;
 ;. s result("immunizationsStatus","status")="alreadyLoaded"
 i $g(ien)'="" d  ; internal call
 . d getIntakeFhir^SYNFHIR("json",,"Immunization",ien,1)
 e  d  ;
 . s args("load")=0
 . merge jtmp=BODY
 . do decode^SYNJSONE("jtmp","json")
 i '$d(json) q  ;
 ;
 ; determine the patient
 ;
 n dfn,eval
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("immunizations",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(eval("immunizations",zi))
 . ;
 . ; insure that the resourceType is Observation
 . ;
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
 . if type'="Immunization" do  quit  ;
 . . set eval("immunizations",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Immunization, skipping entry")
 . set eval("immunizations",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("immunization",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Immunization already loaded, skipping")
 . ;
 . ; determine Immunization cvx code, coding system, and display text
 . ;
 . ;
 . ; determine the id of the resource
 . ;
 . ;new id set id=$get(json("entry",zi,"resource","id"))
 . ;set eval("immunizations",zi,"vars","id")=id
 . ;d log(jlog,"ID is: "_id)
 . ;
 . new cvxcode set cvxcode=$get(json("entry",zi,"resource","vaccineCode","coding",1,"code"))
 . do log(jlog,"code is: "_cvxcode)
 . set eval("immunizations",zi,"vars","code")=cvxcode
 . ;
 . ;
 . new codesystem set codesystem=$get(json("entry",zi,"resource","vaccineCode","coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set eval("immunizations",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the effective date
 . ;
 . new effdate set effdate=$get(json("entry",zi,"resource","date"))
 . do log(jlog,"effectiveDateTime is: "_effdate)
 . set eval("immunizations",zi,"vars","effectiveDateTime")=effdate
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
 . d log(jlog,"fileman dateTime is: "_fmtime)
 . set eval("immunizations",zi,"vars","fmDateTime")=fmtime ;
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
 . set eval("immunizations",zi,"vars","hl7DateTime")=hl7time ;
 . ;
 . ; determine the encounter visit ien
 . n encounterId
 . s encounterId=$g(json("entry",zi,"resource","encounter","reference"))
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
 . s eval("immunizations",zi,"vars","encounterId")=encounterId
 . d log(jlog,"reference encounter ID is : "_encounterId)
 . ;
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
 . s eval("immunizations",zi,"vars","visitIen")=visitIen
 . d log(jlog,"visit ien is: "_visitIen)
 . ;
 . ; set up to call the data loader
 . ;
 . ;IMMUNUPD(RETSTA,DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV)  ;Immunization update
 . n RETSTA,DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV      ;Immunization update
 . s (DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV)=""      ;Immunization update
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s eval("immunizations",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s VISIT=visitIen
 . s eval("immunizations",zi,"parms","VISIT")=visitIen
 . ;
 . s IMMUNIZ=cvxcode
 . s eval("immunizations",zi,"parms","IMMUNIZ")=IMMUNIZ
 . ;
 . ;
 . s EVENTDT=hl7time
 . s eval("immunizations",zi,"parms","EVENTDT")=hl7time
 . d log(jlog,"HL7 DateTime is: "_hl7time)
 . ;
 . s IMMPROV=$$MAP^SYNQLDM("OP","provider") ; should map to an NPI
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",IMMPROV,""))
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
 . s eval("immunizations",zi,"parms","IMMPROV")=IMMPROV
 . d log(jlog,"Provider NPI for outpatient is: "_IMMPROV)
 . ;
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . if DHPLOCIEN="" S DHPLOCIEN=4
 . s eval("immunizations",zi,"parms","DHPLOC")=DHPLOCIEN
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s eval("immunizations",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("immunizations",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Immunization already loaded, skipping")
 . . d log(jlog,"Calling IMMUNUPD^ZZDHP61 to add immunization")
 . . D IMMUNUPD^SYNDHP61(.RETSTA,DHPPAT,.VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV) ;Immunization update
 . . m eval("immunizations",zi,"status")=RETSTA
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s eval("immunizations","status","loaded")=$g(eval("immunizations","status","loaded"))+1
 . . . s eval("immunizations",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s eval("immunizations","status","errors")=$g(eval("immunizations","status","errors"))+1
 . . . s eval("immunizations",zi,"status","loadstatus")="notLoaded"
 . . . s eval("immunizations",zi,"status","loadMessage")=$g(RETSTA)
 ;
 n root s root=$$setroot^SYNWD("fhir-intake")
 k @root@(ien,"load","immunizations")
 m @root@(ien,"load","immunizations")=eval("immunizations")
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=json
 . m jrslt("args")=args
 . m jrslt("eval")=eval
 m jrslt("immunizationsStatus")=eval("immunizationsStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(eval("immunizations","status","loaded"))
 set jrslt("result","errors")=$g(eval("immunizations","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=eval
 . m result("status")=jrslt("result")
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt) ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall ; run the immunizations import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeImmu(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload) ; run the immunizations import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter
 n done s done=0
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:$d(@root@(ien,"load","immunizations"))
 . s filter("dfn")=dfn
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . d wsIntakeImmu(.filter,,.reslt,ien)
 . s done=1
 q
 ;

SYNFLAB
SYNFLAB ;ven/gpl - fhir loader utilities ;Aug 15, 2019@14:20:15
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
importLabs(rtn,ien,args) ; entry point for loading labs for a patient
 ; calls the intake Labs web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 n % s %=$$wsIntakeLabs(.args,,.grtn,ien)
 ;i $d(grtn) d  ; something was returned
 ;. k @root@(ien,"load","labs")
 ;. m @root@(ien,"load","labs")=grtn("labs")
 ;. if $g(args("debug"))=1 m rtn=grtn
 if $g(args("debug"))=1 m rtn=grtn
 s rtn("labsStatus","status")=$g(grtn("status","status"))
 s rtn("labsStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("labsStatus","errors")=$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeLabs(args,body,result,ien) ; web service entry (post)
 ; for intake of one or more Lab results. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n root,troot
 s root=$$setroot^SYNWD("fhir-intake")
 ;
 n jtmp,json,jrslt,eval
 ;i $g(ien)'="" if $$loadStatus("labs","",ien)=1 d  q  ;
 ;. s result("labsStatus","status")="alreadyLoaded"
 i $g(ien)'="" d  ; internal call
 . s troot=$na(@root@(ien,"type","Observation"))
 . s eval=$na(@root@(ien,"load")) ; move eval to the graph
 . ;d getIntakeFhir^SYNFHIR("json",,"Observation",ien,1)
 e  q 0  ; sending not decoded json in BODY to this routine is not done
 ; todo: locate the patient and add the labs in BODY to the graph
 ;. ;s args("load")=0
 ;. merge jtmp=BODY
 ;. do decode^SYNJSONE("jtmp","json")
 ;. s troot=$na(@root@(ien,"type","Observation"))
 i '$d(@troot) q 0  ;
 s json=$na(@root@(ien,"json"))
 ;m ^gpl("gjson")=@troot
 ;
 ; determine the patient
 ;
 n dfn
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit 0  ; need the patient
 . s result("labs",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(@troot@(zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(@eval@("labs",zi))
 . ;
 . ; insure that the resourceType is Observation
 . ;
 . new type set type=$get(@json@("entry",zi,"resource","resourceType"))
 . if type'="Observation" do  quit  ;
 . . set @eval@("labs",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Observation, skipping entry")
 . set @eval@("labs",zi,"vars","resourceType")=type
 . ;
 . ; determine the Observation category and quit if not labs
 . ;
 . new obstype set obstype=$get(@json@("entry",zi,"resource","category",1,"coding",1,"code"))
 . if obstype="" do  ; category is missing, try mapping the code
 . . new trycode,trydisp,tryy
 . . set trycode=$g(@json@("entry",zi,"resource","code","coding",1,"code"))
 . . set trydisp=$g(@json@("entry",zi,"resource","code","coding",1,"display"))
 . . s tryy=$$loinc2sct(trycode)
 . . if tryy="" d  quit  ;
 . . . d log(jlog,"Observation Category missing, not vital signs; code is: "_trycode_" "_trydisp)
 . . if tryy'="" set obstype="laboratory"
 . . d log(jlog,"Derived category is "_obstype)
 . ;
 . if obstype'="laboratory" do  quit  ;
 . . set @eval@("labs",zi,"vars","observationCategory")=obstype
 . . do log(jlog,"Observation Category is not laboratory, skipping")
 . set @eval@("labs",zi,"vars","observationCategory")=obstype
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("labs",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Lab already loaded, skipping")
 . ;
 . ; determine Labs type, code, coding system, and display text
 . ;
 . new labtype set labtype=$get(@json@("entry",zi,"resource","code","text"))
 . if labtype="" set labtype=$get(@json@("entry",zi,"resource","code","coding",1,"display"))
 . do log(jlog,"Labs type is: "_labtype)
 . set @eval@("labs",zi,"vars","type")=labtype
 . ;
 . ; determine the id of the resource
 . ;
 . new id set id=$get(@json@("entry",zi,"resource","id"))
 . set @eval@("labs",zi,"vars","id")=id
 . d log(jlog,"ID is: "_id)
 . ;
 . new obscode set obscode=$get(@json@("entry",zi,"resource","code","coding",1,"code"))
 . do log(jlog,"code is: "_obscode)
 . set @eval@("labs",zi,"vars","code")=obscode
 . ;
 . s ^gpl("labs",obscode,labtype)=""
 . ;
 . new codesystem set codesystem=$get(@json@("entry",zi,"resource","code","coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set @eval@("labs",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the value and units
 . ;
 . new value set value=$get(@json@("entry",zi,"resource","valueQuantity","value"))
 . do log(jlog,"value is: "_value)
 . set @eval@("labs",zi,"vars","value")=value
 . ;
 . new unit set unit=$get(@json@("entry",zi,"resource","valueQuantity","unit"))
 . do log(jlog,"units are: "_unit)
 . set @eval@("labs",zi,"vars","units")=unit
 . ;
 . ; determine the effective date
 . ;
 . new effdate set effdate=$get(@json@("entry",zi,"resource","effectiveDateTime"))
 . do log(jlog,"effectiveDateTime is: "_effdate)
 . set @eval@("labs",zi,"vars","effectiveDateTime")=effdate
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
 . d log(jlog,"fileman dateTime is: "_fmtime)
 . set @eval@("labs",zi,"vars","fmDateTime")=fmtime ;
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
 . set @eval@("labs",zi,"vars","hl7DateTime")=hl7time ;
 . ;
 . ; set up to call the data loader
 . ;
 . n RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC,DHPLOINC
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s @eval@("labs",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . ;n vistalab s vistalab=$$MAP^SYNQLDM(obscode)
 . s DHPLOINC=obscode
 . d log(jlog,"LOINC code is: "_DHPLOINC)
 . s @eval@("labs",zi,"parms","DHPLOINC")=DHPLOINC
 . ;
 . n vistalab s vistalab=$$graphmap^SYNGRAPH("loinc-lab-map",obscode)
 . i +vistalab=-1 s vistalab=$$graphmap^SYNGRAPH("loinc-lab-map"," "_obscode)
 . i +vistalab=-1 s vistalab=$$covid^SYNGRAPH(obscode)
 . i +vistalab'=-1 d
 .. d log(jlog,"Lab found in graph: "_vistalab)
 .. s @eval@("labs",zi,"parms","vistalab")=vistalab
 . if +vistalab=-1 s vistalab=labtype
 . s vistalab=$$TRIM^XLFSTR(vistalab) ; get rid of trailing blanks
 . ;n sct s sct=$$loinc2sct(obscode) ; find the snomed code
 . ;i vistalab="" d  quit
 . ;. d log(jlog,"VistA lab not found for loinc code: "_obscode_" "_labtype_" -- skipping")
 . ;. s @eval@("labs",zi,"status","loadstatus")="cannotLoad"
 . ;. s @eval@("labs",zi,"status","issue")="VistA lab not found for loinc code: "_obscode_" "_labtype_" -- skipping"
 . ;. s @eval@("status","errors")=$g(@eval@("status","errors"))+1
 . s @eval@("labs",zi,"parms","DHPLAB")=vistalab
 . d log(jlog,"VistA Lab is: "_vistalab)
 . s DHPLAB=vistalab
 . ;
 . s DHPOBS=value
 . s recien=$o(^LAB(60,"B",DHPLAB,""))
 . n xform s xform=$$GET1^DIQ(60,recien_",",410)
 . n dec s dec=0
 . i xform["S Q9=" d
 . . s dec=+$p($p(xform,"""",2),",",3)
 . i $l($p(DHPOBS,".",2))>1 d
 . . s DHPOBS=$s(dec<4:$j(DHPOBS,1,dec),dec>3:$j(DHPOBS,1,3),1:$j(DHPOBS,1,0)) ; fix results with too many decimal places
 . ; added for Covid tests
 . i DHPOBS="" d  ; no quant value
 . . n vtxt ; value text
 . . s vtxt=$get(@json@("entry",zi,"resource","valueCodeableConcept","text"))
 . . i vtxt["Negative" s DHPOBS="Negative" ; 260385009
 . . i vtxt["Positive" s DHPOBS="Positive" ; 10828004
 . . i vtxt["Detected" s DHPOBS="Detected" ; 260373001
 . . i vtxt["Not detected" s DHPOBS="Not detected" ; 260415000
 . . i vtxt["Confirmed" s DHPOBS="Confirmed" ; 
 . s @eval@("labs",zi,"parms","DHPOBS")=DHPOBS
 . d log(jlog,"Value is: "_DHPOBS)
 . ;
 . ;i DHPLOINC="2093-3" s DHPOBS=$J(DHPOBS,1,0) ;Total Cholesterol
 . ;i DHPLOINC="33914-3" s DHPOBS=$J(DHPOBS,1,0) ;Estimated Glomerular Filtration Rate
 . ;i DHPLOINC="18262-6" s DHPOBS=$J(DHPOBS,1,0) ;Low Density Cholesterol
 . ;i DHPLOINC="2085-9" s DHPOBS=$J(DHPOBS,1,0) ;High Density Cholesterol
 . ;i DHPLOINC="2571-8" s DHPOBS=$J(DHPOBS,1,0) ;Tryglycerides
 . ;i DHPLOINC="2339-0" s DHPOBS=$J(DHPOBS,1,0) ;Glucose
 . ;
 . s DHPUNT=unit
 . s @eval@("labs",zi,"parms","DHPUNT")=unit
 . d log(jlog,"Units are: "_unit)
 . ;
 . s DHPDTM=hl7time
 . s @eval@("labs",zi,"parms","DHPDTM")=hl7time
 . d log(jlog,"HL7 DateTime is: "_hl7time)
 . ;
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider")
 . n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
 . if DHPPROVIEN="" S DHPPROVIEN=3
 . s @eval@("labs",zi,"parms","DHPPROV")=DHPPROVIEN
 . d log(jlog,"Provider for outpatient is: #"_DHPPROVIEN_" "_DHPPROV)
 . ;
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . if DHPLOCIEN="" S DHPLOCIEN=4
 . s @eval@("labs",zi,"parms","DHPLOC")=DHPLOC
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s @eval@("labs",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . ;new (DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC,DHPLOINC,DHPLAB)
 . . if $g(ien)'="" if $$loadStatus("labs",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Lab already loaded, skipping")
 . . d log(jlog,"Calling LABADD^SYNDHP63 to add lab")
 . . ;new (DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC,DHPLOINC,DHPLAB,DUZ,DT,U,jlog,ien,zi,eval)
 . . ;LABADD(RETSTA,DHPPAT,DHPLOC,DHPTEST,DHPRSLT,DHPRSDT) ;Create lab test
 . . D LABADD^SYNDHP63(.RETSTA,DHPPAT,DHPLOC,DHPLAB,DHPOBS,DHPDTM,DHPLOINC)     ; labs update
 . . d log(jlog,"Return from LABADD^ZZDHP63 was: "_$g(RETSTA))
 . . i $g(DEBUG)=1 ZWRITE RETSTA
 . . if +$g(RETSTA)=1 do  ;
 . . . s @eval@("labs","status","loaded")=$g(@eval@("labs","status","loaded"))+1
 . . . s @eval@("labs",zi,"status","loadstatus")="loaded"
 . . else  s @eval@("labs","status","errors")=$g(@eval@("labs","status","errors"))+1
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=@json
 . m jrslt("args")=args
 . m jrslt("eval")=@eval
 m jrslt("labsStatus")=@eval@("labsStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(@eval@("labs","status","loaded"))
 set jrslt("result","errors")=$g(@eval@("labs","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=eval
 . m result("status")=jrslt("result")
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q 1
 ;
log(ary,txt) ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 w:$G(DEBUG) !,"      ",$G(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
loinc2sct(loinc) ; extrinsic returns a Snomed code for a Loinc code
 ; for labs
 ; thanks to Ferdi for the Snomed mapping
 ;
 ; here's what we got so far:
 ;^gpl("labs","29463-7","Body Weight")=""
 ;^gpl("labs","39156-5","Body Mass Index")="" ; oops
 ;^gpl("labs","55284-4","Blood Pressure")=""
 ;^gpl("labs","8302-2","Body Height")=""
 ;^gpl("labs","8331-1","Oral temperature")="" ;
 ;
 S SCTA("29463-7",27113001)="9^Body weight"
 S SCTA("8302-2",50373000)="8^Body height"
 S SCTA("55284-4",75367002)="1^Blood pressure"
 S SCTA(78564009)="5^Pulse rate"
 S SCTA("8331-1",386725007)="2^Body Temperature"
 S SCTA(86290005)="3^Respiration"
 S SCTA(48094003)="10^Abdominal girth measurement"
 S SCTA(21727005)="11^Audiometry"
 S SCTA(252465000)="21^Pulse oximetry"
 S SCTA(22253000)="22^Pain"
 ;
 q $o(SCTA(loinc,""))
 ;
testall ; run the labs import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeLabs(.filter,,.reslt,ien)
 q
 ;
labsum ; summary of lab tests for patient ien pien
 n root s root=$$setroot^SYNWD("fhir-intake")
 n table
 n zzi s zzi=0
 f  s zzi=$o(@root@(zzi)) q:+zzi=0  d  ;
 . n labs
 . d getIntakeFhir^SYNFHIR("labs",,"Observation",zzi,1)
 . n zi s zi=0
 . f  s zi=$o(labs("entry",zi)) q:+zi=0  d  ;
 . . n groot s groot=$na(labs("entry",zi,"resource"))
 . . i $g(@groot@("category",1,"coding",1,"code"))'="laboratory" q  ;
 . . n loinc
 . . s loinc=$g(@groot@("code","coding",1,"code"))
 . . q:loinc=""
 . . ;i loinc="6082-2" b  ;
 . . n text s text=$g(@groot@("code","coding",1,"display"))
 . . i $d(table(loinc_" "_text)) d  ;
 . . . s table(loinc_" "_text)=table(loinc_" "_text)+1
 . . e  d  ;
 . . . s table(loinc_" "_text)=1
 . . . w !,"patient= "_zzi_" entry= "_zi,!
 . . . n rptary m rptary=@root@(zzi,"json","entry",zi,"resource")
 . . . zwrite rptary
 zwrite table
 q
 ;

SYNFMED
SYNFMED ;OSE/SMH - Add Medications to Patient Record;Dec 24, 2018@21:29
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ; (C) 2018 Sam Habiel
 ; See accompanying license for terms of use.
 ;
 ; TODO list
 ; - Implement Web Services lookup
 ; - See if you can add old meds (not on market) to VistA as patient drugs
 ;
RXN2MEDS(RXN) ; [Public] Get Drugs that are associated with an RxNorm
 Q $$MATCHVM($$RXN2VUI(RXN))
 ;
RXN2VUI(RXN) ; [Public] Get ^ delimited VUIDs for an RxNorm
 N VUIDS S VUIDS=""
 n file
 I $T(^ETSRXN)]"" d  quit VUIDS
 . n fileVUIDs s fileVUIDs=$$ETSRXN2VUID(RXN)
 . n i f i=1:1:$l(fileVUIDs,U) do
 .. n fileVUID s fileVUID=$p(fileVUIDs,U,i)
 .. s file=$p(fileVUID,"~")
 .. i file'=50.68 quit
 .. n vuid s vuid=$p(fileVUID,"~",2)
 .. s VUIDS=VUIDS_vuid_U
 . i $e(VUIDS,$l(VUIDS))=U S $E(VUIDS,$L(VUIDS))=""
 ;
 ; TODO: Rest is not implemented yet.
 N URL S URL="https://rxnav.nlm.nih.gov/REST/rxcui/{RXN}/property.json?propName=VUID"
 N % S %("{RXN}")=RXN
 S URL=$$REPLACE^XLFSTR(URL,.%)
 N C0CRETURN
 D GET(.C0CRETURN,URL)
 N C0COUT
 D DECODE^XLFJSON($NA(C0CRETURN),$NA(C0COUT))
 N J F J=0:0 S J=$O(C0COUT("propConceptGroup","propConcept",J)) Q:'J  D
 . S VUIDS=VUIDS_C0COUT("propConceptGroup","propConcept",J,"propValue")_U
 S $E(VUIDS,$L(VUIDS))="" ; rm trailing ^
 QUIT VUIDS
 ;
RXN2NDC(RXN) ; [Public] Get ^ delimited NDCs for an RxNorm SCD
 I $T(^ETSRXN)]"" Q $$ETSRXN2NDC(RXN)
 ; TODO: Implement web service
 QUIT
 ;
ETSRXN2VUID(RXN) ; [Private] Return delimited list of file~VUID^file~VUID based on ETS
 ; Input: RxNorm Number for IN or CD TTY
 ; Output: file~VUID~name^file~VUID~name..., where file is 50.6 or 50.68.
 ;         or -1^vuid-not-found
 ;
 ; Translate RXN to VUID
 new numVUID set numVUID=+$$RXN2OUT^ETSRXN(RXN)
 if 'numVUID quit:$quit "-1^vuid-not-found" quit
 ;
 ; loop through VUIDs, and grab a good one (CD or IN)
 ; ^TMP("ETSOUT",69531,831533,"VUID",1,0)="296833^831533^VANDF^AB^4031994^N"
 ; ^TMP("ETSOUT",69531,831533,"VUID",1,1)="ERRIN 0.35MG TAB,28"
 new done s done=0
 new out set out=""
 new vuid,name
 new type,file
 new i for i=0:0 set i=$o(^TMP("ETSOUT",$J,RXN,"VUID",i)) quit:'i  do  quit:done
 . new node0 set node0=^TMP("ETSOUT",$J,RXN,"VUID",i,0)
 . new node1 set node1=^TMP("ETSOUT",$J,RXN,"VUID",i,1)
 . set type=$p(node0,U,4)
 . if type'["CD"&(type'["IN") quit
 . ;
 . set vuid=$p(node0,U,5)
 . set file=$s(type["CD":50.68,type["IN":50.6,1:1/0) ; any other type is invalid!
 . set name=node1
 . set out=out_file_"~"_vuid_"~"_name_U
 if $extract(out,$length(out))=U set $extract(out,$length(out))=""
 K ^TMP("ETSOUT",$J)
 quit out
 ;
ETSRXN2NDC(RXN) ; [Private] Return delimited list of NDCs from RxNorm (only active ones)
 ; Translate RXN to VUID
 new numNDC set numNDC=$P($$RXN2OUT^ETSRXN(RXN),U,2)
 if 'numNDC quit:$quit "" quit
 ;
 ; loop through NDCs, and grab good ones
 ; ^TMP("ETSOUT",2199,831533,"NDC")=6
 ; ^TMP("ETSOUT",2199,831533,"NDC",1,0)="600680^831533^831533^RXNORM^N"
 ; ^TMP("ETSOUT",2199,831533,"NDC",1,1)="NDC"
 ; ^TMP("ETSOUT",2199,831533,"NDC",1,2)="00555034458"
 ; ^TMP("ETSOUT",2199,831533,"NDC",2,0)="600681^831533^831533^RXNORM^N"
 ; ^TMP("ETSOUT",2199,831533,"NDC",2,1)="NDC"
 ; ^TMP("ETSOUT",2199,831533,"NDC",2,2)="00555034479"
 new out set out=""
 new type,supp
 new i for i=0:0 set i=$o(^TMP("ETSOUT",$J,RXN,"NDC",i)) quit:'i  do
 . new node0 set node0=^TMP("ETSOUT",$J,RXN,"NDC",i,0)
 . new ndc set ndc=^TMP("ETSOUT",$J,RXN,"NDC",i,2)
 . set type=$p(node0,U,4)
 . set supp=$p(node0,U,5)
 . ;
 . ; We want RxNorm NDCs that are not suppressed.
 . i type'="RXNORM" quit
 . i supp'="N" quit
 . ;
 . set out=out_ndc_U
 if $extract(out,$length(out))=U set $extract(out,$length(out))=""
 K ^TMP("ETSOUT",$J)
 quit out
 ;
RXNCONV(RXN) ; [Private] Convert RxNorm CUI for non SCD to SCD drug
 N FIXED S FIXED=$$RXNBAD(RXN)
 I FIXED Q FIXED
 ;
 I $T(^ETSRXN)]"" Q $$ETSCONV(RXN)
 S $EC=",U-UNIMPLEMENTED,"
 ;
RXNBAD(RXN) ; [Private] Synthea Bad RxNorm Codes Translation
 N RXNBADDATA
 N I,T F I=1:1 S T=$P($T(RXNBADDATA+I),";;",2) Q:T=""  S RXNBADDATA($P(T,";",1))=$P(T,";",2)
 I $D(RXNBADDATA(RXN)) Q RXNBADDATA(RXN)
 Q ""
 ;
RXNBADDATA ;;
 ;;239981;477045
 ;;389128;1363309
 ;;--;--
 ;;308056;1804799
 ;;727374;1660014
 ;;--;--
 ;;564666;705129
 ;;568530;311989
 ;;573839;197319
 ;;575020;105586
 ;;575971;1736776
 ;;596927;596926
 ;;602735;310436
 ;;607015;483438
 ;;608680;313782
 ;;617944;608139
 ;;824184;562251
 ;;849437;198014
 ;;849727;849574
 ;;896188;896209
 ;;904420;904419
 ;;996741;996740
 ;;997221;997223
 ;;1049544;1860154
 ;;1049639;1049221
 ;;1091166;1091392
 ;;1094108;1094107
 ;;1602593;1599803
 ;;1648767;311995
 ;;--;--
 ;;392151;308182
 ;;646250;389221
 ;;727316;1870230
 ;;834060;834061
 ;;834101;834102
 ;;1000128;1000126
 ;;1000158;1000156
 ;;1020137;1043400
 ;;1111011;389221
 ;;1366342;1366343
 ;;1536586;1534809
 ;;1803932;311282
 ;;
ETSCONV(RXN) ; [Private] Convert RxNorm CUI for non SCD to SCD drug using ETS
 N SUC S SUC=$$GETDATA^ETSRXN(RXN)
 I 'SUC Q "0^drug does not exist in RxNorm"
 ;
 ; Is this a semantic clinical drug? If so, just quit, returning this drug.
 N SCD S SCD=$$ETSISSCD(RXN)
 I SCD Q RXN
 ;
 ; Okay it isn't an SCD. Now we need to find out what type it is.
 N TYPE S TYPE=$$ETSTYPE(RXN)
 ;
 ; Now convert the type (SBDC, SBD, SCDC to SCD)
 ; zwrite ^TMP("ETSDATA",$J,RXN,*)
 I TYPE="SBDC" S SCD=$$ETSCONVSBDC(RXN)
 I TYPE="SCDC" S SCD=$$ETSCONVSCDC(RXN)
 I TYPE="SBD"!(TYPE="BPCK") D
 . N VUID S VUID=$$RXN2VUI(RXN)
 . I VUID S SCD=RXN
 . E  S SCD=$$ETSCONVSBD(RXN)
 ;
 ; Must have an SCD at this point
 I 'SCD Q "0^Please send a message for Sam to investigate"
 ;
 QUIT SCD
 ;
ETSISSCD(RXN) ; [Private] Is RXN an SCD?
 N RESULT S RESULT=0
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXCONSO",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
 . I $P(Z,U,4)="SCD" S RESULT=1
 Q RESULT
 ;
ETSISBPCK(RXN) ; [Private] Is RXN a BPCK?
 N RESULT S RESULT=0
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXCONSO",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
 . I $P(Z,U,4)="BPCK" S RESULT=1
 Q RESULT
 ;
ETSTYPE(RXN) ; [Private] What's the type of this RXN? (called only when not SCD)
 N RESULT S RESULT=""
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXCONSO",I)) Q:'I  S Z=^(I,0) D  Q:RESULT]""
 . I $P(Z,U,3)="RXNORM" D
 .. N TYPE S TYPE=$P(Z,U,4)
 .. I TYPE="BPCK" S RESULT=TYPE
 .. I TYPE="SBDC" S RESULT=TYPE
 .. I TYPE="SBD"  S RESULT=TYPE
 .. I TYPE="SCDC" S RESULT=TYPE
 .. I TYPE="SCD"  S RESULT=TYPE
 I "^SBDC^SBD^SCDC^"'[U_RESULT_U S $EC=",U-UNANTICIPATED-RXN-TYPE,"
 Q RESULT
 ;
 ; For the below, everything looks sorta like this.
 ; ^TMP("ETSDATA",1356,1111011,"RXNREL",1,0)="958970^1111011^RB^389221^has_tradename^RXNORM^^4096"
 ; The 4096 we check for means the drug is currently prescribable. This prevents us from reaching
 ; dead ends where the realtionship leads us to a drug not the market and thus may not be a drug
 ; we can write for in VistA.
 ;
ETSCONVSBDC(RXN) ; [Private] Convert RxnCUI SBDC -> SCD
 ; Convert to SCDC first and then to SCD
 N RESULT S RESULT=0
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXNREL",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
 . I $P(Z,U,5)="consists_of",$P(Z,U,8)=4096 S RESULT=$P(Z,U,4)
 N % S %=$$GETDATA^ETSRXN(RESULT) ; **WARNING: CONTEXT CHANGE**
 Q $$ETSCONVSBD(RESULT)
 ;
ETSCONVSBD(RXN)  ; [Private] Convert RxnCUI SBD -> SCD
 N RESULT S RESULT=0
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXNREL",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
 . I $P(Z,U,5)="has_tradename",$P(Z,U,8)=4096 S RESULT=$P(Z,U,4)
 Q RESULT
 ;
ETSCONVSCDC(RXN) ; [Private] Convert RxnCUI SCDC -> SCD
 K ^TMP("SYNDATA",$J,RXN)
 M ^TMP("SYNDATA",$J,RXN)=^TMP("ETSDATA",$J,RXN)
 N RESULT S RESULT=0
 N SYNI,Z F SYNI=0:0 S SYNI=$O(^TMP("ETSDATA",$J,RXN,"RXNREL",SYNI)) Q:'SYNI  S Z=^(SYNI,0) D  Q:RESULT
 . I $P(Z,U,5)="consists_of",$P(Z,U,8)=4096 S RESULT=$P(Z,U,4)
 . I 'RESULT QUIT  ; previous line didn't return anything, try again
 . N % S %=$$GETDATA^ETSRXN(RESULT) ; delete previous data
 . N TYPE S TYPE=$$ETSTYPE(RESULT)  ; uses new context
 . I TYPE'="SCD" S RESULT=0
 . K ^TMP("ETSDATA",$J,RXN) M ^TMP("ETSDATA",$J,RXN)=^TMP("SYNDATA",$J,RXN) ; restore context
 Q RESULT
 ;
MATCHVM(VUIDS) ; [Public] Match delimited list of VUIDs to delimited set of drugs (not one to one)
 N MATCHES S MATCHES=""
 N I,VUID
 F I=1:1 S VUID=$P(VUIDS,U,I) Q:VUID=""  D
 . N MATCH S MATCH=$$MATCHV1(VUID)
 . I MATCH S MATCHES=MATCHES_MATCH_U
 S $E(MATCHES,$L(MATCHES))="" ; rm trailing ^
 QUIT MATCHES
 ;
 ;
MATCHV1(VUID) ; [Public] Match a single VUID to a set of drugs.
 N VAP S VAP=$$VUI2VAP(VUID) ; says it's supposed to be plural, but that's not possible??
 I 'VAP S $EC=",U-VUID-SHOULD-NOT-BE-MISSING,"
 N MEDS S MEDS=$$VAP2MED(VAP)
 QUIT MEDS
 ;
VUI2VAP(VUID) ; $$ Public - Get VA Product IEN(s) from VUID
 ; Input VUID by Value
 ; Output: Extrinsic
 D FIND^DIC(50.68,,"@","QP",VUID,,"AVUID") ; Find all in VUID index
 N O S O="" ; Output
 N I F I=0:0 S I=$O(^TMP("DILIST",$J,I)) Q:'I  S O=O_^(I,0)_U ; Concat results together
 S O=$E(O,1,$L(O)-1) ; remove trailing ^
 Q O
 ;
VAP2MED(VAPROD) ; $$ Public - Get Drug(s) using VA Product IEN
 ; Un-Unit-testable: Drug files differ between sites.
 ; Input: VA Product IEN By Value
 ; OUtput: Caret delimited extrinsic
 ; This code inspired from PSNAPIs
 ; WHY THE HELL WOULD I USE A TEXT INDEX?
 ; It's my only option. Creating new xrefs on the drug file doesn't help
 ; as they are not filled out when adding a drug (IX[ALL]^DIK isn't called).
 N MEDS S MEDS="" ; result
 N PN,PN1 ; Product Name, abbreviated product name.
 S PN=$P(^PSNDF(50.68,VAPROD,0),"^"),PN1=$E(PN,1,30)
 N P50 S P50=0 ; looper through VAPN index which is DRUG file entry
 F  S P50=$O(^PSDRUG("VAPN",PN1,P50)) Q:'P50  D  ; for each text match
 . I $P(^PSDRUG(P50,"ND"),"^",3)=VAPROD S MEDS=$G(MEDS)_P50_U  ; check that the VA PRODUCT pointer is the same as ours.
 S:MEDS MEDS=$E(MEDS,1,$L(MEDS)-1) ; remove trailing ^
 Q MEDS
 ;
ADDDRUG(RXN,BARCODE) ; [Public] Add Drug to Drug File
 ; Input: RXN - RxNorm Semantic Clinical Drug CUI by Value. Required.
 ; Input: BARCODE - Wand Barcode. Optional. Pass exactly as wand reads minus control characters.
 ; Output: Internal Entry Number
 ;
 ; Get first VUID for this RxNorm drug
 N VUID S VUID=+$$RXN2VUI(RXN)
 Q:'VUID ""
 G NEXT
ADDDRUG2(RXN,VUID) ;
 ; ZEXCEPT: NDC,BARCODE
NEXT ;
 N PSSZ S PSSZ=1    ; Needed for the drug file to let me in!
 ;
 ; W "(debug) VUID for RxNorm CUI "_RXN_" is "_VUID,!
 ;
 ; IEN in 50.68
 N C0XVUID ; For Searching Compound Index
 S C0XVUID(1)=VUID
 S C0XVUID(2)=1
 N F5068IEN S F5068IEN=$$FIND1^DIC(50.68,"","XQ",.C0XVUID,"AMASTERVUID")
 Q:'F5068IEN ""
 ;
 ; W "F 50.68 IEN (debug): "_F5068IEN,!
 ;
 ; Guard against adding the drug back in again.
 N EXISTING S EXISTING=$$VAP2MED(F5068IEN)
 I EXISTING Q EXISTING
 ;
 ; FDA Array
 N C0XFDA
 ;
 ; Name, shortened
 S C0XFDA(50,"+1,",.01)=$E($$GET1^DIQ(50.68,F5068IEN,.01),1,40)
 ;
 ; File BarCode as a Synonym for BCMA
 I $L($G(BARCODE)) D
 . S C0XFDA(50.1,"+2,+1,",.01)=BARCODE
 . S C0XFDA(50.1,"+2,+1,",1)="Q"
 ;
 N NDCS S NDCS=$$RXN2NDC^SYNFMED(RXN)
 N NDC S NDC=$P(NDCS,U,1)
 ;
 ; NDC field
 I NDC S C0XFDA(50,"+1,",31)=$E(NDC,1,5)_"-"_$E(NDC,6,9)_"-"_$E(NDC,10,11)
 ;
 ; NDCs to synonyms
 I NDCS]"" N C0XI F C0XI=1:1:$L(NDCS,U) D
 . S NDC=$P(NDCS,U,C0XI)
 . S C0XFDA(50.1,"+"_(C0XI+10)_",+1,",.01)=NDC
 . S C0XFDA(50.1,"+"_(C0XI+10)_",+1,",1)="Q"
 . S C0XFDA(50.1,"+"_(C0XI+10)_",+1,",2)=NDC
 ;
 ; Brand Names & NDCs
 ; N NDCS
 ; N URL S URL="https://rxnav.nlm.nih.gov/REST/rxcui/{RXN}/ndcs.json"
 ; N % S %("{RXN}")=RXN
 ; S URL=$$REPLACE^XLFSTR(URL,.%)
 ; N C0CRETURN
 ; D GET(.C0CRETURN,URL)
 ; N C0COUT
 ; D DECODE^XLFJSON($NA(C0CRETURN),$NA(C0COUT))
 ; ZWRITE C0COUT
 ; QUIT
 ; ;
 ; N BNS S BNS="" ; S BNS=$$RXN2BNS^C0CRXNLK(RXN) ; Brands
 ; I $L(BNS) N I F I=1:1:$L(BNS,U) D
 ; . N IENS S IENS=I+2
 ; . S C0XFDA(50.1,"+"_IENS_",+1,",.01)=$$UP^XLFSTR($E($P(BNS,U,I),1,40))
 ; . S C0XFDA(50.1,"+"_IENS_",+1,",1)="T"
 ;
 ;
 ; Dispense Unit (string)
 S C0XFDA(50,"+1,",14.5)=$$GET1^DIQ(50.68,F5068IEN,"VA DISPENSE UNIT")
 ;
 ; National Drug File Entry (pointer to 50.6)
 S C0XFDA(50,"+1,",20)="`"_$$GET1^DIQ(50.68,F5068IEN,"VA GENERIC NAME","I")
 ;
 ; VA Product Name (string)
 S C0XFDA(50,"+1,",21)=$E($$GET1^DIQ(50.68,F5068IEN,.01),1,70)
 ;
 ; PSNDF VA PRODUCT NAME ENTRY (pointer to 50.68)
 S C0XFDA(50,"+1,",22)="`"_F5068IEN
 ;
 ; DEA, SPECIAL HDLG (string)
 D  ; From ^PSNMRG ; ZEXCEPT: n
 . N CS S CS=$$GET1^DIQ(50.68,F5068IEN,"CS FEDERAL SCHEDULE","I")
 . S CS=$S(CS?1(1"2n",1"3n"):+CS_"C",+CS=2!(+CS=3)&(CS'["C"):+CS_"A",1:CS)
 . S C0XFDA(50,"+1,",3)=CS
 ;
 ; NATIONAL DRUG CLASS (pointer to 50.605) (triggers VA Classification field)
 S C0XFDA(50,"+1,",25)="`"_$$GET1^DIQ(50.68,F5068IEN,"PRIMARY VA DRUG CLASS","I")
 ;
 ; Right Now, I don't file the following which ^PSNMRG does (cuz I don't need them)
 ; - Package Size (derived from NDC/UPN file)
 ; - Package Type (ditto)
 ; - CMOP ID (from $$PROD2^PSNAPIS)
 ; - National Formulary Indicator (from 50.68)
 ;
 ; Next Step is to kill Old OI if Dosage Form doesn't match
 ; Won't do that here as it's assumed any drugs that's added is new.
 ; This happens at ^PSNPSS
 ;
 ; Now add drug to drug file, as we need the IEN for the dosages call.
 N C0XERR,C0XIEN
 D UPDATE^DIE("E","C0XFDA","C0XIEN","C0XERR")
 S:$D(C0XERR) $EC=",U1,"
 ;
 ; Next Step: Kill off old doses and add new ones.
 D EN2^PSSUTIL(C0XIEN(1))
 ;
 ; Mark uses for the Drug; use the undocumented Silent call in PSSGIU
 N PSIUDA,PSIUX ; Expected Input variables
 S PSIUDA=C0XIEN(1),PSIUX="O^Outpatient Pharmacy" D ENS^PSSGIU
 S PSIUDA=C0XIEN(1),PSIUX="U^Unit Dose" D ENS^PSSGIU
 S PSIUDA=C0XIEN(1),PSIUX="X^Non-VA Med" D ENS^PSSGIU
 ;
 ; Get VA Generic text and VA Product pointer for Orderable Item creation plus dosage form information
 N VAGENP S VAGENP=$P(^PSDRUG(C0XIEN(1),"ND"),U) ; VA Generic Pointer
 N VAGEN S VAGEN=$$VAGN^PSNAPIS(VAGENP) ; VA Generic Full name
 N VAPRODP S VAPRODP=$P(^PSDRUG(C0XIEN(1),"ND"),U,3) ; VA Product Pointer
 N DOSAGE S DOSAGE=$$PSJDF^PSNAPIS(0,VAPRODP) ; IEN of dose form in 50.606 ^ Text
 N DOSEPTR S DOSEPTR=$P(DOSAGE,U) ; ditto
 N DOSEFORM S DOSEFORM=$P(DOSAGE,U,2) ;ditto
 ;
 ; Get the (possibly new) Orderable Item Text
 N VAG40 S VAG40=$E(VAGEN,1,40) ; Max length of .01 field
 ;
 ; See if there is an existing orderable item already. If so, populate the Pharmacy Orderable item on drug file.
 N OI S OI=$O(^PS(50.7,"ADF",VAG40,DOSEPTR,""))
 ;
 ; Otherwise, add a new one. (See MCHAN+12^PSSPOIMN)
 N FLAGNEWOI S FLAGNEWOI=0
 I 'OI D
 . N C0XFDA,C0XERR
 . S C0XFDA(50.7,"+1,",.01)=VAG40
 . S C0XFDA(50.7,"+1,",.02)=DOSEPTR
 . D UPDATE^DIE("",$NA(C0XFDA),$NA(OI),$NA(C0XERR))
 . I $D(C0XERR) S $EC=",U1,"
 . S OI=OI(1) ; For ease of use...
 . S FLAGNEWOI=1
 ;
 ; Add the orderable Item to the drug file.
 N C0XFDA,C0XERR S C0XFDA(50,C0XIEN(1)_",",2.1)=OI ; Orderable Item
 D FILE^DIE("",$NA(C0XFDA),$NA(C0XERR))
 ;
 ; Mailman throws an error into DIERR, which ANNOYS me! So we won't check for errors here.
 ; S:$D(C0XERR) $EC=",U1,"
 ; Special $ZSTEP to find the problem: zp @$zpos b:($g(olddierr)'=$g(DIERR))  s olddierr=$g(DIERR) zstep into
 ;
 ; Previously, we did the CPRS HL7 message here; but we don't need to anymore. The OI xref does it for us.
 ;
EX QUIT C0XIEN(1)
 ;
GET(RETURN,URL) ; [Public] Get a URL
 ; ZEXCEPT: %XOBWERR
 ;
 ; Timeout
 N TO S TO=5
 N HEADERS
 ; Action
 N STATUS S STATUS=$$GETURL^XTHC10(URL,TO,$NA(RETURN)),HEADERS("STATUS")=STATUS
 ;
 ; ZWRITE HEADERS
 ; ZWRITE RETURN
 ;
 ; Check status code to be 200.
 I "^200^302^"'[HEADERS("STATUS") S %XOBWERR=HEADERS("STATUS"),$EC=",UXOBWHTTP,"
 QUIT
 ;
WRITERXRXN(PSODFN,RXNCUI,RXDATE) ; [$$/D Public] Create a new prescription for a patient using RxNorm SCD CUI
 ; Input: PSODFN = DFN
 ; Input: RXNCUI = RxNorm CUI. ONLY SCD, SCDC, SBDC, or SBD types only
 ; Input: RXDATE = Prescription Date
 ;
 ; $$ Output: Prescription Number (not IEN) or -1^error message or -2^error message
 ;
 ; Convert RXNCUI to SCD
 N RXNCDCUI S RXNCDCUI=$$RXNCONV(RXNCUI)
 I 'RXNCDCUI Q -2_U_"RxNorm CUI "_RXNCUI_" is not a valid RxNorm. Please check using RxNav or similar"
 ;
 N DRUG S DRUG=$$ADDDRUG(RXNCDCUI)
 I 'DRUG Q -1_U_"RxNorm CUI "_RXNCUI_" could not be resolved into a drug."
 S DRUG=$P(DRUG,U) ; in case we get multiple drugs back; reported by George.
 I $QUIT QUIT $$WRITERXPS(PSODFN,DRUG,RXDATE)
 D WRITERXPS(PSODFN,DRUG,RXDATE)
 QUIT
 ;
WRITERXPS(PSODFN,DRUG,RXDATE) ; [$$/D Public] Create a new prescription for a patient using drug IEN
 ; Input: PSODFN = DFN
 ; Input: DRUG = Drug (file 50) IEN
 ; Input: RXDATE = Prescription Date
 ; $$ Output: Prescription Number (not IEN) or -1^error message
 ;
 ; Site Parameters (see PSOLSET)
 N PSOSITE S PSOSITE=$$PSOSITE^SYNINIT()
 N PSOPAR,PSOPAR7,PSOSYS,PSODTCUT,PSOPRPAS
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOPAR7=$G(^PS(59,PSOSITE,"IB")),PSOSYS=$G(^PS(59.7,1,40.1)) D CUTDATE^PSOFUNC
 ;
 ; Add Patient to File 55 DINUMMED to 2
 N FDA,IEN,DIERR
 S FDA(55,"?+1,",.01)="`"_PSODFN
 S IEN(1)=PSODFN
 S FDA(55,"?+1,",3)="OPC" ; A convenient Patient Status
 D UPDATE^DIE("E","FDA","IEN")
 I $D(DIERR) S $EC=",U-UPDATE-FAILED,"
 ;
 ; Pharmacist (we use the value multiple times)
 N SYNPHARM S SYNPHARM=$$PHARM^SYNINIT()
 ; Drug Array we will pass by reference
 N PSONEW
 ;
 ; Call to get drug demographics
 N PSOY
 S PSOY=DRUG
 S PSOY(0)=^PSDRUG(DRUG,0)
 N PSODRUG
 D SET^PSODRG
 M PSONEW=PSODRUG
 ;
 ; Days and refills
 S PSONEW("ISSUE DATE")=RXDATE
 S PSONEW("FILL DATE")=RXDATE
 S PSONEW("DAYS SUPPLY")=30
 S PSONEW("# OF REFILLS")=1
 ;
 ; Pharmacist here!
 S PSONEW("VERIFY")=1
 S PSONEW("PHARMACIST")=SYNPHARM
 S PSONEW("CLERK CODE")=SYNPHARM ; Needed for CPRS for "Entered By" field.
 ;
 ; Provider
 S PSONEW("PROVIDER")=$$PROV^SYNINIT()
 ;
 ; Clinic
 S PSONEW("CLINIC")=$$HL^SYNINIT()
 ;
 ; Get Prescription Number
 D AUTO^PSONRXN
 ;
 N SYNRXN S SYNRXN=PSONEW("RX #")
 ;
 ; Dosage
 S PSONEW("ENT")=1
 S PSONEW("DOSE",PSONEW("ENT"))="ONE TABLET DAILY"
 ;
 ; Copay
 N PSOSCP S PSOSCP=""
 ;
 ; Quantity
 S PSONEW("QTY")=30 ; Non-sense number
 ;
 ; Counseling
 N PSOCOU,PSOCOUU
 S PSOCOU=1,PSOCOUU=1
 ;
 ; Nature of order
 N PSONOOR S PSONOOR="W"
 ;
 ; Mail/Window - defaults to mail; override to Window
 S PSONEW("MAIL/WINDOW")="W"
 ;
 ; Patient Status
 S PSONEW("PATIENT STATUS")=$$FIND1^DIC(53,,"QX","OPC")
 ;
 ; File in 52
 D EN^PSON52(.PSONEW)
 ;
 ; Needed for release later (see PSODISP)
 N PSIN S PSIN=+$P($G(^PS(59.7,1,49.99)),"^",2)
 N SYNRXIEN S SYNRXIEN=PSONEW("IRXN")
 ;
 ; HL7 to OE/RR to update the Order File
 D EOJ^PSONEW
 ;
 ; Print Prescription (required for releasing)
 ; NB: We are not checking for POP
 N IOP S IOP="NULL"
 N %ZIS S %ZIS=0
 D ^%ZIS U IO
 ; Ignore POP as we don't care if we can't write to device. We want IOST specs.
 ; ZEXCEPT: %WNULL from the webserver
 I $D(%WNULL) S IO=%WNULL U %WNULL
 N PPL S PPL=SYNRXIEN_","
 N PDUZ S PDUZ=SYNPHARM
 D DQ^PSOLBL
 ;
 ; Release Prescription
 N POERR S POERR=1
 N RXP S RXP=SYNRXIEN
 N PSRH S PSRH=SYNPHARM
 D BATCH^PSODISP
 I '$D(%WNULL) D ^%ZISC
 ;
 QUIT:$QUIT SYNRXN QUIT
 ;
TEST D EN^%ut("SYNFMEDT",3) QUIT

SYNFMED2
SYNFMED2        ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2019
 ;
 q
 ;
importMeds(rtn,ien,args)        ; entry point for loading Medications for a patient
 ; calls the intake Medications web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 d wsIntakeMeds(.args,,.grtn,ien)
 ;
 s rtn("medsStatus","status")=$g(grtn("status","status"))
 s rtn("medsStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("medsStatus","errors")=$g(grtn("status","errors"))
 ;
 ;
 q
 ;
wsIntakeMeds(args,body,result,ien)      ; web service entry (post)
 ; for intake of one or more Meds. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 ;
 n root,troot
 s root=$$setroot^SYNWD("fhir-intake")
 ;
 n jtmp,json,jrslt,eval
 i $g(ien)'="" d  ; internal call
 . s troot=$na(@root@(ien,"type","MedicationRequest"))
 . s eval=$na(@root@(ien,"load")) ; move eval to the graph
 e  q 0  ; sending not decoded json in BODY to this routine not supported
 ; todo: locate the patient and add the encounters in BODY to the graph
 s json=$na(@root@(ien,"json"))
 ;
 ; determine the patient
 ;
 n dfn
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("meds",1,"log",1)="Error, patient not found.. terminating"
 ;
 new zi s zi=0
 for  set zi=$order(@troot@(zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(@eval@("meds",zi))
 . ;
 . ; insure that the resourceType is MedicationRequest
 . ;
 . new type set type=$get(@json@("entry",zi,"resource","resourceType"))
 . if type'="MedicationRequest" do  quit  ;
 . . set @eval@("meds",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not MedicationRequest, skipping entry")
 . set @eval@("meds",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("meds",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Meds already loaded, skipping")
 . ;
 . ; determine Meds rxnorm code, coding system, and display text
 . ;
 . n med,rxnorm,codesystem,drugname
 . i $d(@json@("entry",zi,"resource","medicationCodeableConcept")) d  ;
 . . n gmed s gmed=$na(@json@("entry",zi,"resource","medicationCodeableConcept"))
 . . s rxnorm=$g(@gmed@("coding",1,"code"))
 . . q:rxnorm=""
 . . s drugname=$g(@gmed@("coding",1,"display"))
 . . s codesystem=$g(@gmed@("coding",1,"system"))
 . . s codesystem=$re($p($re(codesystem),"/"))
 . e  d  ;
 . . d getEntry^SYNFHIR("med",ien,zi-1) ; meds are in the previous entry
 . . n gmed s gmed=$na(med("entry",zi-1,"resource"))
 . . q:$g(@gmed@("resourceType"))'="Medication"
 . . s rxnorm=$g(@gmed@("code","coding",1,"code"))
 . . q:rxnorm=""
 . . s drugname=$g(@gmed@("code","coding",1,"display"))
 . . s codesystem=$g(@gmed@("code","coding",1,"system"))
 . . s codesystem=$re($p($re(codesystem),"/"))
 . ;
 . q:$g(rxnorm)=""
 . ;i rxnorm=897122 d  q  ;
 . ;. do log(jlog,"skipping unloadable drug, 3 ML liraglutide 6 MG/ML Pen Injector rxnorm= "_rxnorm)
 . ;i rxnorm=313782 d  q  ;
 . ;. do log(jlog,"skipping unloadable drug rxnorm= "_313782)
 . do log(jlog,"rxnorm code is: "_rxnorm)
 . set @eval@("meds",zi,"vars","rxnorm")=rxnorm
 . do log(jlog,"drug name is: "_drugname)
 . set @eval@("meds",zi,"vars","drugname")=drugname
 . ;
 . ;
 . do log(jlog,"code system is: "_codesystem)
 . set @eval@("meds",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the order date and time
 . ;
 . new orderdate set orderdate=$get(@json@("entry",zi,"resource","authoredOn"))
 . do log(jlog,"orderdateTime is: "_orderdate)
 . set @eval@("meds",zi,"vars","orderdateTime")=orderdate
 . new fmOrderDateTime s fmOrderDateTime=$$fhirTfm^SYNFUTL(orderdate)
 . d log(jlog,"fileman orderdateTime is: "_fmOrderDateTime)
 . set @eval@("meds",zi,"vars","fmOrderdateTime")=fmOrderDateTime ;
 . new hl7OrderdateTime s hl7OrderdateTime=$$fhirThl7^SYNFUTL(orderdate)
 . d log(jlog,"hl7 orderdateTime is: "_hl7OrderdateTime)
 . set @eval@("meds",zi,"vars","hl7OrderdateTime")=hl7OrderdateTime ;
 . ;
 . ; determine clinical status (active vs inactive)
 . ;
 . n clinicalstatus set clinicalstatus=$get(@json@("entry",zi,"resource","verificationStatus"))
 . ;
 . ;
 . ; set up to call the data loader
 . ;
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("meds",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Meds already loaded, skipping")
 . . d log(jlog,"Calling WRITERXRXN^SYNFMED to add meds")
 . . n RESTA
 . . S RESTA=$$WRITERXRXN^SYNFMED(dfn,rxnorm,fmOrderDateTime)
 . . m @eval@("meds",zi,"status")=RESTA
 . . d log(jlog,"Response from WRITERXRXN^SYNFMED is: "_RESTA)
 . . d log(jlog,"Medication: "_rxnorm_" "_drugname)
 . . if RESTA>1 d  ; success
 . . . s @eval@("meds","status","loaded")=$g(@eval@("meds","status","loaded"))+1
 . . . s @eval@("meds",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s @eval@("meds","status","errors")=$g(@eval@("meds","status","errors"))+1
 . . . s @eval@("meds",zi,"status","loadstatus")="notLoaded"
 . . . s @eval@("meds",zi,"status","loadMessage")=$g(RETSTA)
 . . . d log(jlog,"Medication failed to load: "_$g(RETSTA))
 . . n root s root=$$setroot^SYNWD("fhir-intake")
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=@json
 . m jrslt("args")=args
 . m jrslt("eval")=@eval
 m jrslt("medsStatus")=@eval@("medsStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(@eval@("meds","status","loaded"))
 set jrslt("result","errors")=$g(@eval@("meds","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=@eval
 . m result("status")=jrslt("result")
 . ;m result("dfn")=dfn
 . ;m result("ien")=ien
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)    ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 w:$G(DEBUG) !,"      ",$G(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall(limit,start)    ; run the meds import on all imported patients
 ;; next line added for DUZ setup because of <UNDEFINED>ENTDFLT+12^XPAR1 *DUZ(2)
 S USER=$$DUZ^SYNDHP69()
 ;;
 i $g(limit)="" s limit=1
 n cnt s cnt=0
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 i $g(start)'="" s dfn=start
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:cnt=limit  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:ien=19
 . s cnt=cnt+1
 . s filter("dfn")=dfn
 . s filter("load")=1
 . k reslt
 . w !,"meds for ien: ",ien," dfn= ",dfn
 . d wsIntakeMeds(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload)   ; run the meds import on one imported patient
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter
 n done s done=0
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . ;q:$d(@root@(ien,"load","meds"))
 . s filter("dfn")=dfn
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . w !,"calling wsIntakeMeds for ien: ",ien
 . d wsIntakeMeds(.filter,,.reslt,ien)
 . s done=1
 q
 ;
getRandomMeds(ary) ; make a web service call to get random allergies
 n srvr
 s srvr="http://postfhir.vistaplex.org:9080/"
 i srvr["postfhir.vistaplex.org" s srvr="http://138.197.70.229:9080/"
 i $g(^%WURL)["http://postfhir.vistaplex.org:9080" d  q  ;
 . s srvr="localhost:9080/"
 . n url
 . s url=srvr_"randommeds"
 . n ok,r1
 . s ok=$$%^%WC(.r1,"GET",url)
 . i '$d(r1) q  ;
 . d decode^SYNJSONE("r1","ary")
 n url
 s url=srvr_"randommeds"
 n ret,json,jtmp
 s ret=$$GETURL^XTHC10(url,,"jtmp")
 d assemble^SYNFPUL("jtmp","json")
 i '$d(json) q  ;
 d decode^SYNJSONE("json","ary")
 q
 ;
medsum ; search all loaded patients and catelog the procedure codes
 n root,json,ien,table
 s root=$$setroot^SYNWD("fhir-intake")
 s ien=0
 f  s ien=$o(@root@(ien)) q:+ien=0  d  ;
 . k json
 . d getIntakeFhir^SYNFHIR("json",,"MedicationRequest",ien,1)
 . n cde,txt,rien
 . s rien=0
 . f  s rien=$o(json("entry",rien)) q:+rien=0  d  ;
 . . n med
 . . d getEntry^SYNFHIR("med",ien,rien-1) ; meds are in the previous entry
 . . n gmed s gmed=$na(med("entry",rien-1,"resource"))
 . . q:$g(@gmed@("resourceType"))'="Medication"
 . . s cde=$g(@gmed@("code","coding",1,"code"))
 . . q:cde=""
 . . s txt=$g(@gmed@("code","coding",1,"display"))
 . . n sys s sys=$g(@gmed@("code","coding",1,"system"))
 . . s sys=$re($p($re(sys),"/"))
 . . s txt=txt_" - "_sys
 . . n stat
 . . s stat=$g(^XTMP("SYNGRAPH",3,ien,"load","meds",rien,"status"))
 . . i stat["CUI" d  ;
 . . . n cui
 . . . s cui=$p($p(stat,"CUI ",2)," ",1)
 . . . s notloaded(cui)=""
 . . i '$d(table(cde_" "_txt)) s table(cde_" "_txt)=1 q  ;
 . . s table(cde_" "_txt)=$g(table(cde_" "_txt))+1
 zwrite table
 zwrite notloaded
 q
 ;

SYNFMEDT
SYNFMEDT ;OSE/SMH - Unit Tests for Synthetic Medications;Jun 11 2018
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 D EN^%ut($T(+0),2,1)
 QUIT
 ;
STARTUP ; M-Unit Startup
 ; ZEXCEPT: DFN,DRGRXN
 N DA,DIK
 S DRGRXN=313195
 S DFN=1
 N DRG S DRG=$$ADDDRUG^SYNFMED(DRGRXN) ; This finds it and also creates it; but normally it will be there from previous test runs
 D KILLONEDRUG(DRG)
 ;
 ; Delete patient rx data
 N DIU S DIU(0)="" ; Tell the pharmacy package that we are Fileman doing dirty cleanup work.
 N PSOI F PSOI=0:0 S PSOI=$O(^PS(55,DFN,"P",PSOI)) Q:'PSOI  D
 . N RXIEN S RXIEN=^PS(55,DFN,"P",PSOI,0)
 . I $D(^PSRX(RXIEN,"OR1")) N ORNUM S ORNUM=$P(^("OR1"),U,2) S DA=ORNUM,DIK="^OR(100," D ^DIK
 . S DIK="^PSRX(",DA=RXIEN D ^DIK
 S DA=DFN,DIK="^PS(55," D ^DIK
 ;
 QUIT
 ;
SHUTDOWN ; M-Unit Shutdown
 ; ZEXCEPT: DFN,DRGRXN
 K DFN
 K DRGRXN
 QUIT
 ;
T0 ; @TEST Test $$ETSRXN2VUID^SYNFMED API
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(831533)["50.68~4031994~ERRIN 0.35MG TAB,28")
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(70618)["50.6~4019880~PENICILLIN")
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(198211)["50.68~4016607~SIMVASTATIN 40MG TAB,UD")
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(313195)["50.68~4004891~TAMOXIFEN CITRATE 20MG TAB")
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(1009219)["50.6~4030995~ALISKIREN/AMLODIPINE")
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(309110)["50.68~4007024~CEPHALEXIN 125MG/5ML SUSP")
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(2231)["50.6~4018891~CEPHALEXIN")
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(10582)["50.6~4022126~LEVOTHYROXINE")
 QUIT
 ;
T1 ; @TEST Test get VUIDs
 D CHKTF^%ut($$RXN2VUI^SYNFMED(1014675)[4033356)
 D CHKTF^%ut($$RXN2VUI^SYNFMED(197379)[4014051)
 QUIT
 ;
T2 ; @TEST Get Local Matches for VUID (no actual tests as drug file is local)
 W " "
 W $$MATCHV1^SYNFMED(4004876)," "
 W $$MATCHV1^SYNFMED(4033365)," "
 W $$MATCHV1^SYNFMED(4014051)," "
 D SUCCEED^%ut
 QUIT
 ;
T3 ; @TEST Get Local Matches for RxNorm (no actual tests as drug file is local)
 W $$RXN2MEDS^SYNFMED(1014675)," " ; Ceterizine capsule
 W $$RXN2MEDS^SYNFMED(197379)," "  ; Atenolol 100
 W $$RXN2MEDS^SYNFMED(1085640)," " ;  Triamcinolone Acetonide 0.005 MG/MG Topical Ointment
 D SUCCEED^%ut
 QUIT
 ;
T4 ; @TEST Write Rx Using Drug IEN
 ; ZEXCEPT: DFN,DRGRXN
 N DA,DIK
 N DRUG S DRUG=$$ADDDRUG^SYNFMED(DRGRXN)
 N RXN S RXN=$$WRITERXPS^SYNFMED(DFN,DRUG,DT)
 N RXIEN S RXIEN=$$FIND1^DIC(52,,"QX",RXN,"B")
 N RX0 S RX0=^PSRX(RXIEN,0)
 N PAT S PAT=$P(RX0,U,2)
 N DRG S DRG=$P(RX0,U,6)
 D CHKEQ^%ut(PAT,1,"Patient is not correct")
 D CHKEQ^%ut(DRG,DRUG,"Drug is not correct")
 D CHKTF^%ut($O(^PSRX(RXIEN,"L",0)),"Label does not exist")
 D CHKTF^%ut($$GET1^DIQ(52,RXIEN,"RELEASED DATE/TIME","I"),"Release date/time doesn't exist")
 QUIT
 ;
T5 ; @TEST Write Rx Using Drug RxNorm SCD
 ; ZEXCEPT: DFN,DRGRXN
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,DRGRXN,DT) ; Tamoxifen Citrate 20mg tab
 N RXIEN S RXIEN=$$FIND1^DIC(52,,"QX",RXN,"B")
 N RX0 S RX0=^PSRX(RXIEN,0)
 N PAT S PAT=$P(RX0,U,2)
 N DRG S DRG=$P(RX0,U,6)
 N DRGNM S DRGNM=$P(^PSDRUG(DRG,0),U)
 D CHKEQ^%ut(PAT,1,"Patient is not correct")
 D CHKTF^%ut(DRGNM["TAMOXIFEN","Drug is not correct")
 D CHKTF^%ut($O(^PSRX(RXIEN,"L",0)),"Label does not exist")
 D CHKTF^%ut($$GET1^DIQ(52,RXIEN,"RELEASED DATE/TIME","I"),"Release date/time doesn't exist")
 QUIT
 ;
T55 ; @TEST Write an Rx with a bad Rxnorm number
 ; ZEXCEPT: DFN,DRGRXN
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,989892842342,DT) ; Tamoxifen Citrate 20mg tab
 D CHKTF^%ut(RXN<0)
 QUIT
 ;
T56 ; @TEST Write an Rx with no NDCs on the market
 ; ZEXCEPT: DFN,DRGRXN
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,282464,DT) ; Acetaminophen 160 MG Oral Tablet
 D CHKTF^%ut(RXN>0)
 QUIT
 ;
T57 ; @TEST Write an Rx with mulitple matches for drug
 ; doesn't cause a crash on my system, but here for George and company to test
 ; ZEXCEPT: DFN,DRGRXN
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,313782,DT) ; Acetaminophen 325 MG Oral Tablet
 D CHKTF^%ut(RXN>0)
 QUIT
 ;
T58 ; @TEST Write an Rx with Lirugatide (RXN # 897122)
 ; ZEXCEPT: DFN,DRGRXN
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,897122,DT) ; Acetaminophen 325 MG Oral Tablet
 D CHKTF^%ut(RXN>0)
 QUIT
VUI2VAPT ; @TEST Get VA Product IEN from VUID
 N L F L=1:1 N LN S LN=$T(VUI2VAPD+L) Q:LN["<<END>>"  Q:LN=""  D
 . N VUID S VUID=$P(LN,";",3)
 . N VAP S VAP=$P(LN,";",4)
 . D CHKEQ^%ut($$VUI2VAP^SYNFMED(VUID),VAP,"Translation from VUID to VA PRODUCT failed")
 QUIT
 ;
VUI2VAPD ; @DATA - Data for above test
 ;;4006455;5932
 ;;4002369;1784
 ;;4000874;252
 ;;4003335;2756
 ;;4002469;1884
 ;;4009488;9046^10090
 ;;<<END>>
 ;
T6 ; @TEST Get NDCs for a drug
 D CHKTF^%ut($$RXN2NDC^SYNFMED(198211)["16252050890")
 QUIT
 ;
T7 ; @TEST Analysis of meds that don't load
 N I,T F I=1:1 S T=$T(T7L+I),T=$P(T,";;",2) Q:T=""  D
 . N SCD S SCD=$$ETSCONV^SYNFMED(T)
 . I 'SCD QUIT
 . N % S %=$$GETDATA^ETSRXN(SCD)
 . D CHKTF^%ut(%)
 . D CHKTF^%ut($$ETSISSCD^SYNFMED(SCD)!$$ETSISBPCK^SYNFMED(SCD))
 QUIT
 ;
T7L ; @DATA
 ;;239981
 ;;308056
 ;;316049
 ;;316672
 ;;389128
 ;;392151
 ;;477045
 ;;564666
 ;;568530
 ;;573839
 ;;575020
 ;;575971
 ;;596927
 ;;602735
 ;;607015
 ;;608680
 ;;617944
 ;;646250
 ;;727316
 ;;727374
 ;;824184
 ;;831533
 ;;834060
 ;;834101
 ;;849437
 ;;849727
 ;;896188
 ;;904420
 ;;996741
 ;;997221
 ;;1000128
 ;;1000158
 ;;1020137
 ;;1049544
 ;;1049639
 ;;1091166
 ;;1094108
 ;;1111011
 ;;1359133
 ;;1366342
 ;;1536586
 ;;1602593
 ;;1648767
 ;;1803932
 ;;
T8 ; @TEST Add drugs for patients from T7L
 ; ZEXCEPT: DFN,DRGRXN
 N SYNI,SYNT F SYNI=1:1 S SYNT=$T(T7L+SYNI),SYNT=$P(SYNT,";;",2) Q:SYNT=""  D
 . ; W SYNT," "
 . N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,SYNT,DT)
 . ; W RXN,!
 . D CHKTF^%ut(RXN>0,RXN)
 QUIT
 ;
KILLDRUG ; [Public] Remove all Drug Data
 ; WARNING: DO NOT CALL THIS UNLESS YOU ARE ON A BRAND NEW SYSTEM AND ARE TESTING.
 D DT^DICRW ; Min FM Vars
 D MES^XPDUTL("Killing Drug (50)") D DRUG
 D MES^XPDUTL("Killing Pharmacy Orderable Item (OI) (50.7)") D PO
 D MES^XPDUTL("Killing Drug Text (51.7)") D DRUGTEXT
 D MES^XPDUTL("Killing IV Additives (52.6)") D IVADD
 D MES^XPDUTL("Killing IV Solutions (52.7)") D IVSOL
 D MES^XPDUTL("Killing Drug Electrolytes (50.4)") D DRUGELEC
 D MES^XPDUTL("Removing Pharmacy OIs from the Orderable Item (101.43)") D O
 D MES^XPDUTL("Syncing the Order Quick View (101.44)") D CPRS
 QUIT
 ;
KILLONEDRUG(DRG) ; [Public] Kill just one drug
 ; Called by the Unit Test
 ;
 ; Get OI
 N DIK,DA
 N OI S OI=+^PSDRUG(DRG,2)
 ;
 ; Delete drug
 S DA=DRG,DIK="^PSDRUG(" D ^DIK
 I 'OI QUIT
 ;
 ; Delete OI
 S DA=OI,DIK="^PS(50.7," D ^DIK
 ;
 ; Delete CPRS synced version of OI
 N OERROI S OERROI=$O(^ORD(101.43,"ID",OI_";99PSP",""))
 I OERROI S DIK="^ORD(101.43,",DA=OERROI D ^DIK
 ;
 ; Update CPRS view of pharmacy OIs
 D CPRS
 QUIT
 ;
RESTOCK ; [Public] Restock CPRS Orderable Items from new Drug & Pharmacy Orderable Item
 ; File. Public Entry Point.
 ; Call this after repopulating the drug file (50) and the pharmacy orderable
 ; item file (50.7)
 N PSOIEN ; Looper variable
 D DT^DICRW ; Establish FM Basic Variables
 ;
 ; Loop through Orderable Item file and call
 ; 1. The Active/Inactive Updater for the Orderable Item
 ; 2. the protocol file updater to CPRS Files
 S PSOIEN=0 F  S PSOIEN=$O(^PS(50.7,PSOIEN)) Q:'PSOIEN  D
 . D MES^XPDUTL("Syncing Pharamcy Orderable Item "_PSOIEN)
 . D EN^PSSPOIDT(PSOIEN),EN2^PSSHL1(PSOIEN,"MUP")
 D CPRS ; Update Orderable Item View files
 QUIT
 ;
 ; -- END Public Entry Points --
 ;
 ; -- The rest is private --
DRUG ; Kill Drug File; Private
 N DA,DIK
 S DIK="^PSDRUG("
 F DA=0:0 S DA=$O(^PSDRUG(DA)) Q:'DA  D ^DIK
 S $P(^PSDRUG(0),U,3,4)=""
 K ^DIA(50)
 QUIT
 ;
PO ; Kill Pharmacy Orderable Items; Private
 N %1 S %1=^PS(50.7,0)
 K ^PS(50.7)
 S ^PS(50.7,0)=%1
 S $P(^PS(50.7,0),"^",3,4)=""
 QUIT
 ;
DRUGTEXT ; Kill Drug Text Entries ; Private
 N %1 S %1=^PS(51.7,0)
 K ^PS(51.7)
 S ^PS(51.7,0)=%1
 S $P(^PS(51.7,0),"^",3,4)=""
 QUIT
 ;
IVADD ; Kill IV Additives ; Private
 N %1 S %1=^PS(52.6,0)
 K ^PS(52.6)
 S ^PS(52.6,0)=%1
 S $P(^PS(52.6,0),"^",3,4)=""
 QUIT
 ;
IVSOL ; Kill IV Solutions ; Private
 N %1 S %1=^PS(52.7,0)
 K ^PS(52.7)
 S ^PS(52.7,0)=%1
 S $P(^PS(52.7,0),"^",3,4)=""
 QUIT
 ;
DRUGELEC ; Kill Drug Electrolytes ; Private
 N %1 S %1=^PS(50.4,0)
 K ^PS(50.4)
 S ^PS(50.4,0)=%1
 S $P(^PS(50.4,0),"^",3,4)=""
 QUIT
 ;
O ; Kill off Pharamcy Order Items (Only!) in the Orderable Item file; Private
 N DA ; Used in For loop below
 N DIK S DIK="^ORD(101.43,"
 N I S I=0
 FOR  S I=$O(^ORD(101.43,"ID",I)) QUIT:I=""  DO
 . I I["PSP" S DA=$O(^ORD(101.43,"ID",I,"")) D ^DIK
 QUIT
 ;
CPRS ; Now, update the CPRS lists (sync with Orderable Item file) -
 ; Uses a CPRS API to do this; Private
 ; Next 3 variables are required as inputs
 N ATTEMPT S ATTEMPT=0 ; Attempt to Update
 N UPDTIME S UPDTIME=$HOROLOG ; Update Time
 N DGNM ; Dialog Name
 ; IVA RX -> Additives; IVB RX -> Solutions
 ; IVM RX -> Inpatient Meds for Outpatients
 ; NV RX -> Non-VA Meds ; O RX -> Outpatient
 ; UD RX -> Unit Dose
 FOR DGNM="IVA RX","IVB RX","IVM RX","NV RX","O RX","UD RX" DO
 . D MES^XPDUTL(" --> Rebuilding "_DGNM)
 . D FVBLD^ORWUL
 QUIT
 ;

SYNFPAT
SYNFPAT ;ven/gpl - fhir loader utilities ;2018-05-08  4:18 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
importPatient(rtn,ien) ; register and import a fhir patient (demographics only)
 ;
 if $get(ien)="" quit
 new fhir
 do getIntakeFhir^SYNFHIR("fhir",,"Patient",ien)
 ;
 ; set up logging and parameter area
 ;
 new PLD merge PLD=@$$setPLD^SYNFUTL(ien,"Patient")
 new parms set parms=PLD("parms") ; global name of where to put the parms
 ;
 if $g(@PLD("status")@("loadStatus"))="loaded" do  quit  ;
 . new zdfn s zdfn=$g(@PLD("status")@("DFN"))
 . do log^SYNFUTL("Patient "_ien_" already loaded DFN= "_zdfn)
 . set rtn("loadStatus")="already loaded"
 . set rtn("dfn")=zdfn
 ;
 kill @PLD("parms")
 kill @PLD("log")
 ;
 do log^SYNFUTL("Patient load begins for fhirien= "_ien)
 ;
 ; name
 ;
 new patname
 set patname=$$patname("fhir")
 if patname'="" do  ;
 . set @parms@("NAME")=patname
 . do log^SYNFUTL("Patient name is: "_patname)
 else  do log^SYNFUTL("Patient Name Error")
 ; need to find the entry for the Patient resource
 ;
 n zntry s zntry=$o(fhir("Patient","entry",""))
 ;
 ;
 ; gender
 ;
 new psex
 set psex=$get(fhir("Patient","entry",zntry,"resource","gender"))
 if psex'="" do  ;
 . do log^SYNFUTL("Patient gender is: "_psex)
 . set @parms@("SEX")=$select(psex="male":"M",psex="female":"F",1:"F")
 else  do log^SYNFUTL("Patient gender not found")
 ;
 ; date of birth
 ;
 new dob
 set dob=$get(fhir("Patient","entry",zntry,"resource","birthDate"))
 if dob'="" do  ;
 . new X,Y
 . set X=dob
 . do ^%DT
 . if Y=-1 do log^SYNFUTL("Patient date of birth error "_dob) quit  ;
 . set @parms@("DOB")=Y
 else  do log^SYNFUTL("Patient date of birth error "_dob)
 ;
 ; id - fhir id, not ICN
 ;
 new pid
 set pid=$get(fhir("Patient","entry",zntry,"resource","id"))
 if pid="" s pid=$get(fhir("Patient","entry",zntry,"resource","identifier",1,"value"))
 if pid="" do log^SYNFUTL("Patient ID is missing")
 else  do  ;
 . set @parms@("ID")=pid
 . do log^SYNFUTL("Patient ID is "_pid)
 ;
 ; ethnicity code
 ;
 do INITMAPS^SYNQLDM
 new eary,ecd
 ;do adb^SYNFUTL("eary","fhir","text","ethnicity") ; array defined by
 ;set ecd=$get(eary("coding",1,"code")) ; the ethnic code
 set ecd=$$deriveCode("fhir","us-core-ethnicity",zntry)
 if ecd'="" d  ;
 . do log^SYNFUTL("Ethnicity code is "_ecd)
 . new ecdn
 . set ecdn=$$MAP^SYNQLDM(ecd)
 . if ecdn="" do  quit  ;
 . . do log^SYNFUTL("Ethnicity code "_ecd_" does not map")
 . set @parms@("ETHNICITY")=ecdn
 else  do log^SYNFUTL("Ethnicity code missing")
 ;
 ; race code
 ;
 new rary,rcd
 ;do adb^SYNFUTL("rary","fhir","text","race") ; array defined by
 ;set rcd=$get(rary("coding",1,"code")) ; the ethnic code
 set rcd=$$deriveCode("fhir","us-core-race",zntry)
 if rcd'="" d  ;
 . do log^SYNFUTL("Race code is "_rcd)
 . new rcdn
 . set rcdn=$$MAP^SYNQLDM(rcd)
 . if rcdn="" do  quit  ;
 . . do log^SYNFUTL("Race code "_rcd_" does not map")
 . set @parms@("RACE")=rcdn
 else  do log^SYNFUTL("Race code missing")
 ;
 ; address
 ;
 s @parms@("CITY")=$g(fhir("Patient","entry",zntry,"resource","address",1,"city"))
 s @parms@("STATE")=$g(fhir("Patient","entry",zntry,"resource","address",1,"state"))
 s @parms@("ZIP")=$g(fhir("Patient","entry",zntry,"resource","address",1,"postalCode"))
 s @parms@("STREET_ADD1")=$g(fhir("Patient","entry",zntry,"resource","address",1,"line",1))
 s @parms@("PH_NUM")=$g(fhir("Patient","entry",zntry,"resource","telecom",1,"value"))
 s @parms@("IMP_TYPE")="I" ; individual not batch load
 s @parms@("SSN")=$$patssn("fhir")
 s @parms@("MARITAL_STATUS")=$get(fhir("Patient","entry",zntry,"resource","maritalStatus","coding",1,"code"))
 ;
 ; call import routine
 ;
 n MISC
 m MISC=@parms
 n ISIRC s ISIRC=$$IMPORTPT^ISIIMP03(.MISC)
 d log^SYNFUTL("Called IMPORTPT^ISIIMP03 to import patient")
 d log^SYNFUTL("Return code from Import: "_ISIRC)
 d log^SYNFUTL("Return values from Import: "_$G(ISIRESUL(1)))
 i ISIRC="" do  quit  ;
 . d log^SYNFUTL("No return from patient load")
 . s rtn("status")="Patient load error"
 n zdfn s zdfn=0
 i $g(ISIRESUL(1))'="" s zdfn=$P(ISIRESUL(1),"^",1)
 ;
 ; load failed
 ;
 i +zdfn<1 d  q  ;
 . s rtn("loadStatus")="notLoaded"
 . s rtn("loadMessage")=ISIRC
 . s @PLD("status")@("loadStatus")="notLoaded"
 . s @PLD("status")@("loadMessage")=ISIRC
 ;
 ; load successful
 ;
 new icn set icn=$$newIcn2(zdfn,pid)
 if icn'=-1 s @PLD("status")@("ICN")=icn
 s @PLD("status")@("DFN")=zdfn
 s @PLD("status")@("loadStatus")="loaded"
 set @PLD("index")@("DFN",zdfn,ien)=""
 set @PLD("index")@("ICN",icn,ien)=""
 set @PLD("index")@(ien,"DFN",zdfn)=""
 set @PLD("index")@(ien,"ICN",icn)=""
 d setIndex^SYNFUTL(ien,"DFN",zdfn)
 d setIndex^SYNFUTL(ien,"ICN",icn)
 ;
 s rtn("dfn")=zdfn
 s rtn("loadStatus")="loaded"
 if icn'=-1 s rtn("icn")=icn
 ;
 quit
 ;
deriveCode(zary,zname,zntry) ; finds the code for ethnicity and race
 ;
 n zary2,zdex,zz1,zurl,done,zcode
 s zcode=""
 s done=0
 s zzi=0
 f  s zzi=$o(@zary@("Patient","entry",zntry,"resource","extension",zzi)) q:+zzi=0  q:done  d  ;
 . s zurl=$g(@zary@("Patient","entry",zntry,"resource","extension",zzi,"url"))
 . i $$urlEnd^SYNFUTL(zurl)=zname d  ;
 . . m zary2=@zary@("Patient","entry",zntry,"resource","extension",zzi)
 . . d valueDex2^SYNFUTL("zary2","zdex")
 . . q:'$d(zdex)
 . . s zcode=$o(zdex("code",""))
 . . q:zcode=""
 . . s done=1
 q zcode
 ;
patname(ary) ; ary is passed by name
 new given,family
 n zntry s zntry=$o(@ary@("Patient","entry","")) ; which resource is the Patient
 ;
 ; Synthea patient resources are 1; new fhir Patient resources are 2
 ;
 set family=$get(@ary@("Patient","entry",zntry,"resource","name",1,"family"))
 set given=$get(@ary@("Patient","entry",zntry,"resource","name",1,"given",1))
 if family="" quit ""
 if given="" quit ""
 new X,Y
 set X=family
 x ^%ZOSF("UPPERCASE")
 set family=Y
 set X=given
 x ^%ZOSF("UPPERCASE")
 set given=Y
 ;
 quit family_","_given
 ;
patssn(fary) ; extrinsic returns the ssn of the patient extracted from
 ; the fhir array, passed by name
 new ssnref,tary,ssn
 ; set ssnref="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-SocialSecurityNumber-extension"
 set ssnref="http://hl7.org/fhir/sid/us-ssn"
 do adb^SYNFUTL("tary",fary,"system",ssnref) ; array defined by
 ;
 set ssn=$get(tary("value"))
 if ssn["-" set ssn=$tr(ssn,"-","")
 quit ssn
 ;
 ; sample patient fhir
 ;g("Patient","entry",1,"fullUrl")="urn:uuid:a13f2440-a3ec-419a-8259-82710d695fdf"
 ;g("Patient","entry",1,"resource","address",1,"city")="Fitchburg"
 ;g("Patient","entry",1,"resource","address",1,"country")="US"
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",1,"url")="latitude"
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",1,"valueDecimal")=42.562168065623744
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",2,"url")="longitude"
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",2,"valueDecimal")=-71.81748413047194
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"url")="http://hl7.org/fhir/StructureDefinition/geolocation"
 ;g("Patient","entry",1,"resource","address",1,"line",1)="9802 Bosco Field"
 ;g("Patient","entry",1,"resource","address",1,"line",2)="Suite 454"
 ;g("Patient","entry",1,"resource","address",1,"postalCode")="01420"
 ;g("Patient","entry",1,"resource","address",1,"state")="MA"
 ;g("Patient","entry",1,"resource","birthDate")="1925-06-02"
 ;g("Patient","entry",1,"resource","communication",1,"language","coding",1,"code")="en-US"
 ;g("Patient","entry",1,"resource","communication",1,"language","coding",1,"display")="English (United States)"
 ;g("Patient","entry",1,"resource","communication",1,"language","coding",1,"system")="http://hl7.org/fhir/ValueSet/languages"
 ;g("Patient","entry",1,"resource","deceasedDateTime")="2002-10-08T06:31:48-04:00"
 ;g("Patient","entry",1,"resource","extension",1,"url")="http://hl7.org/fhir/us/core/StructureDefinition/us-core-race"
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","coding",1,"code")="2106-3"
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","coding",1,"display")="White"
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","coding",1,"system")="http://hl7.org/fhir/v3/Race"
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","text")="race"
 ;g("Patient","entry",1,"resource","extension",2,"url")="http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity"
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","coding",1,"code")="2186-5"
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","coding",1,"display")="Nonhispanic"
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","coding",1,"system")="http://hl7.org/fhir/v3/Ethnicity"
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","text")="ethnicity"
 ;g("Patient","entry",1,"resource","extension",3,"url")="http://hl7.org/fhir/StructureDefinition/birthPlace"
 ;g("Patient","entry",1,"resource","extension",3,"valueAddress","city")="Easton"
 ;g("Patient","entry",1,"resource","extension",3,"valueAddress","country")="US"
 ;g("Patient","entry",1,"resource","extension",3,"valueAddress","state")="MA"
 ;g("Patient","entry",1,"resource","extension",4,"url")="http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName"
 ;g("Patient","entry",1,"resource","extension",4,"valueString")="Jeramie91 Waelchi310"
 ;g("Patient","entry",1,"resource","extension",5,"url")="http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex"
 ;g("Patient","entry",1,"resource","extension",5,"valueCode")="M"
 ;g("Patient","entry",1,"resource","extension",6,"url")="http://hl7.org/fhir/StructureDefinition/patient-interpreterRequired"
 ;g("Patient","entry",1,"resource","extension",6,"valueBoolean")="false"
 ;g("Patient","entry",1,"resource","extension",7,"url")="http://standardhealthrecord.org/fhir/StructureDefinition/shr-actor-FictionalPerson-extension"
 ;g("Patient","entry",1,"resource","extension",7,"valueBoolean")="true"
 ;g("Patient","entry",1,"resource","extension",8,"url")="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-FathersName-extension"
 ;g("Patient","entry",1,"resource","extension",8,"valueHumanName","text")="Veronica383 Abbott509"
 ;g("Patient","entry",1,"resource","extension",9,"url")="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-SocialSecurityNumber-extension"
 ;g("Patient","entry",1,"resource","extension",9,"valueString")="999-67-7452"
 ;g("Patient","entry",1,"resource","gender")="male"
 ;g("Patient","entry",1,"resource","id")="a13f2440-a3ec-419a-8259-82710d695fdf"
 ;g("Patient","entry",1,"resource","identifier",1,"system")="https://github.com/synthetichealth/synthea"
 ;g("Patient","entry",1,"resource","identifier",1,"value")="72bcbb80-2cbd-4523-82c1-30a34e08a72a"
 ;g("Patient","entry",1,"resource","identifier",2,"system")="http://hl7.org/fhir/sid/us-ssn"
 ;g("Patient","entry",1,"resource","identifier",2,"type","coding",1,"code")="SB"
 ;g("Patient","entry",1,"resource","identifier",2,"type","coding",1,"system")="http://hl7.org/fhir/identifier-type"
 ;g("Patient","entry",1,"resource","identifier",2,"value")=999677452
 ;g("Patient","entry",1,"resource","identifier",2,"value","\s")=""
 ;g("Patient","entry",1,"resource","identifier",3,"system")="urn:oid:2.16.840.1.113883.4.3.25"
 ;g("Patient","entry",1,"resource","identifier",3,"type","coding",1,"code")="DL"
 ;g("Patient","entry",1,"resource","identifier",3,"type","coding",1,"system")="http://hl7.org/fhir/v2/0203"
 ;g("Patient","entry",1,"resource","identifier",3,"value")="S99925046"
 ;g("Patient","entry",1,"resource","maritalStatus","coding",1,"code")="M"
 ;g("Patient","entry",1,"resource","maritalStatus","coding",1,"system")="http://hl7.org/fhir/v3/MaritalStatus"
 ;g("Patient","entry",1,"resource","maritalStatus","text")="M"
 ;g("Patient","entry",1,"resource","meta","profile",1)="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-PersonOfRecord"
 ;g("Patient","entry",1,"resource","multipleBirthBoolean")="false"
 ;g("Patient","entry",1,"resource","name",1,"family")="Abbott509"
 ;g("Patient","entry",1,"resource","name",1,"given",1)="Arlie395"
 ;g("Patient","entry",1,"resource","name",1,"prefix",1)="Mr."
 ;g("Patient","entry",1,"resource","name",1,"use")="official"
 ;g("Patient","entry",1,"resource","resourceType")="Patient"
 ;g("Patient","entry",1,"resource","telecom",1,"system")="phone"
 ;g("Patient","entry",1,"resource","telecom",1,"use")="home"
 ;g("Patient","entry",1,"resource","telecom",1,"value")="(454) 841-5126"
 ;g("Patient","entry",1,"resource","text","div")="<div>Generated by <a href=""https://github.com/synthetichealth/synthea"""
 ;g("Patient","entry",1,"resource","text","div","\",1)=">Synthea</a>. Version identifier: 4d02400401b9fab839e47bf5b2f1f6a8c683ab55</div>"
 ;g("Patient","entry",1,"resource","text","status")="generated"
 ;
 ; patient load template (D LOADMISC^ISIIMPU1(.G))
 ;G("CITY")="FIELD|.114"
 ;G("DFN_NAME")="PARAM|"
 ;G("DOB")="FIELD|.03"
 ;G("EMPLOY_STAT")="FIELD|.31115"
 ;G("ETHNICITY")="FIELD|2.06,.01"
 ;G("IMP_BATCH_NUM")="PARAM|"
 ;G("IMP_TYPE")="PARAM|"
 ;G("INSUR_TYPE")="FIELD|2.312,.01"
 ;G("LOW_DOB")="PARAM|.03"
 ;G("MARITAL_STATUS")="FIELD|.05"
 ;G("MRG_SOURCE")="FIELD|.01"
 ;G("NAME")="FIELD|.01"
 ;G("NAME_MASK")="MASK|.01"
 ;G("OCCUPATION")="FIELD|.07"
 ;G("PH_NUM")="FIELD|.131"
 ;G("PH_NUM_MASK")="MASK|.131"
 ;G("RACE")="FIELD|2.02,.01"
 ;G("SEX")="FIELD|.02"
 ;G("SSN")="FIELD|.09"
 ;G("SSN_MASK")="MASK|.09"
 ;G("STATE")="FIELD|.115"
 ;G("STREET_ADD1")="FIELD|.111"
 ;G("STREET_ADD2")="FIELD|.112"
 ;G("TEMPLATE")="PARAM|"
 ;G("TYPE")="FIELD|391"
 ;G("UP_DOB")="PARAM|.03"
 ;G("VETERAN")="FIELD|1901"
 ;G("ZIP_4")="FIELD|.1112"
 ;G("ZIP_4_MASK")="MASK|.1112
 ;"
newIcn(dfn) ; extrinsic which creates a new ICN for the patient
 ; if none exists. returns the ICN
 ;
 new tmpicn
 set tmpicn=$$icn(dfn)
 if tmpicn'=-1 do  quit tmpicn
 . n ien s ien=$$dfn2ien^SYNFUTL(dfn)
 . if ien'="" do setIndex^SYNFUTL(ien,"ICN",tmpicn)
 ;
 ; lock here
 ;
 set tmpicn=$o(^DPT("AICN",99999999999),-1)+1
 if tmpicn=1 s tmpicn=50000001 ; first ICN in the system
 ;
 ;991.01    INTEGRATION CONTROL NUMBER (NJ12,0Xa), [MPI;1]
 ;991.02    ICN CHECKSUM (Fa), [MPI;2]
 ;991.1     FULL ICN (FXa), [MPI;10]
 ;
 new fda,tchk
 set tchk=$$CHECKDG^MPIFSPC(tmpicn)
 set fda(2,dfn_",",991.01)=tmpicn
 set fda(2,dfn_",",991.02)=tchk
 set fda(2,dfn_",",991.1)=tmpicn_"V"_tchk
 do UPDATE^DIE("","fda",,"err")
 if $data(err) do  quit -1
 . D ^ZTER
 ;
 new ficn s ficn=tmpicn_"V"_tchk
 S ^DPT("AFICN",ficn,dfn)=""
 S ^DPT("ARFICN",dfn,ficn)=""
 ;
 n ien s ien=$$dfn2ien^SYNFUTL(dfn)
 if ien'="" do setIndex^SYNFUTL(ien,"ICN",ficn)
 ;
 quit ficn
 ;
icn(dfn) ; extrinsic returns the ICN of the patient
 ; returns -1 if none exists
 new zicn
 set zicn=$$GET1^DIQ(2,dfn_",",991.01)
 ;set zicn=$o(^DPT("AICN",dfn,""))
 if zicn="" q -1
 ;
 quit zicn_"V"_$$CHECKDG^MPIFSPC(zicn)
 ;
newIcn2(dfn,pid) ; extrinsic which creates a new ICN for the patient based on the Synthea patient id (pid)
 ; returns the ICN
 ;
 i $g(pid)="" d  ; pid not provided.. go find it
 . n fien s fien=$$dfn2ien^SYNFUTL(dfn)
 . s pid=$$ien2pid^SYNFUTL(fien)
 i $g(pid)="" q -1
 new tmpicn
 ;
 s tmpicn=$$pid2icn^SYNFUTL(pid) ; generate the icn from the pid
 ;
 ;991.01    INTEGRATION CONTROL NUMBER (NJ12,0Xa), [MPI;1]
 ;991.02    ICN CHECKSUM (Fa), [MPI;2]
 ;991.1     FULL ICN (FXa), [MPI;10]
 ;
 new fda,tchk,err
 set tchk=$$CHECKDG^MPIFSPC(tmpicn)
 i +dfn=0 b
 set fda(2,dfn_",",991.01)=tmpicn
 set fda(2,dfn_",",991.02)=tchk
 set fda(2,dfn_",",991.1)=tmpicn_"V"_tchk
 do UPDATE^DIE("","fda",,"err")
 if $data(err) do  quit -1
 . D ^ZTER
 . zwrite err
 ;
 new ficn s ficn=tmpicn_"V"_tchk
 S ^DPT("AFICN",ficn,dfn)=""
 S ^DPT("ARFICN",dfn,ficn)=""
 ;
 n ien s ien=$$dfn2ien^SYNFUTL(dfn)
 if ien'="" do setIndex^SYNFUTL(ien,"ICN",ficn)
 ;
 quit ficn
 ;
fixindex1 ; create the ICN and DFN indexes
 d clearIndexes^SYNFUTL ; blow away the indexes
 n gn,zi
 s gn=$$setroot^SYNWD("fhir-intake")
 s zi=0
 f  s zi=$o(@gn@(zi)) q:+zi=0  d  ;
 . n gn2,dfn,icn
 . s gn2=$na(@gn@(zi,"load","Patient","status"))
 . ;w !,gn2," ",$g(@gn2@("DFN"))
 . s dfn=$g(@gn2@("DFN"))
 . q:dfn=""
 . ;s icn=$g(@gn2@("ICN"))
 . s icn=$o(^DPT("ARFICN",dfn,""))
 . q:icn=""
 . s @gn@(zi,"DFN",dfn)=""
 . d setIndex^SYNFUTL(zi,"DFN",dfn)
 . i icn'="" d
 . . s @gn@(zi,"ICN",icn)=""
 . . d setIndex^SYNFUTL(zi,"ICN",icn)
 q
 ;
fixicn1 ; fix all DPT ICN indexes
 k ^DPT("AICN")
 K ^DPT("AFICN")
 K ^DPT("ARFICN")
 n zi s zi=0
 f  s zi=$o(^DPT(zi)) q:+zi=0  d  ;
 . n icn,icnck
 . s icn=$$GET1^DIQ(2,zi_",",991.01)
 . s icnck=$$GET1^DIQ(2,zi_",",991.02)
 . q:icn=""
 . q:icnck=""
 . n ficn s ficn=icn_"V"_icnck
 . s ^DPT("AICN",icn,zi)=""
 . s ^DPT("AFICN",ficn,zi)=""
 . s ^DPT("ARFICN",zi,ficn)=""
 q
 ;
genAllIcns ; regenerates all ICNs; insterts in PATIENT file and regenerates indexes
 n root s root=$$setroot^SYNWD("fhir-intake")
 n zi s zi=0
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
 . n pid,dfn,icn
 . s pid=$$ien2pid^SYNFUTL(zi)
 . s dfn=$$ien2dfn^SYNFUTL(zi)
 . i dfn<1 q
 . i pid="" q
 . s icn=$$newIcn2^SYNFPAT(dfn,pid)
 . w !,"fien: "_zi_" dfn: "_dfn_" pid: "_pid_" icn: "_icn
 d fixicn1 ; fix ^DPT indexes
 d fixindex1 ; fix graph indexes
 q
 ;

SYNFPR2
SYNFPR2 ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 ; use SYNDHP61 instead of SYNDHP62 for problem update
 q
 ;
importConditions(rtn,ien,args)   ; entry point for loading Problems for a patient
 ; calls the intake Conditions web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 d wsIntakeConditions(.args,,.grtn,ien)
 i $d(grtn) d  ; something was returned
 . k @root@(ien,"load","conditions")
 . m @root@(ien,"load","conditions")=grtn("conditions")
 . if $g(args("debug"))=1 m rtn=grtn
 s rtn("problemStatus","status")=$g(grtn("status","status"))
 s rtn("problemStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("problemStatus","errors")=$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeConditions(args,body,result,ien)               ; web service entry (post)
 ; for intake of one or more Conditions. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n jtmp,json,jrslt,eval
 ;i $g(ien)'="" if $$loadStatus("conditions","",ien)=1 d  q  ;
 ;. s result("problemStatus","status")="alreadyLoaded"
 i $g(ien)'="" d  ; internal call
 . d getIntakeFhir^SYNFHIR("json",,"Condition",ien,1)
 e  d  ;
 . s args("load")=0
 . merge jtmp=BODY
 . do decode^SYNJSONE("jtmp","json")
 i '$d(json) q  ;
 m ^gpl("gjson")=json
 ;
 ; determine the patient
 ;
 n dfn,eval
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("conditions",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(eval("conditions",zi))
 . ;
 . ; insure that the resourceType is Observation
 . ;
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
 . if type'="Condition" do  quit  ;
 . . set eval("conditions",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Condition, skipping entry")
 . set eval("conditions",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("condition",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Condition already loaded, skipping")
 . ;
 . ; determine Condition snomed code, coding system, and display text
 . ;
 . ;
 . ; determine the id of the resource
 . ;
 . ;new id set id=$get(json("entry",zi,"resource","id"))
 . ;set eval("conditions",zi,"vars","id")=id
 . ;d log(jlog,"ID is: "_id)
 . ;
 . new sctcode set sctcode=$get(json("entry",zi,"resource","code","coding",1,"code"))
 . do log(jlog,"code is: "_sctcode)
 . set eval("conditions",zi,"vars","code")=sctcode
 . ;
 . ;
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set eval("conditions",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the onset date and time
 . ;
 . new onsetdate set onsetdate=$get(json("entry",zi,"resource","onsetDateTime"))
 . do log(jlog,"onsetDateTime is: "_onsetdate)
 . set eval("conditions",zi,"vars","onsetDateTime")=onsetdate
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
 . set eval("conditions",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(onsetdate)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
 . set eval("conditions",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
 . ;
 . ; determine the abatement date and time, if any
 . ;
 . new abatementdate set abatementdate=$get(json("entry",zi,"resource","abatementDateTime"))
 . if abatementdate'="" d  ;
 . . do log(jlog,"abatementDateTime is: "_abatementdate)
 . . set eval("conditions",zi,"vars","abatementDateTime")=abatementdate
 . . new fmAbatementDateTime s fmAbatementDateTime=$$fhirTfm^SYNFUTL(abatementdate)
 . . d log(jlog,"fileman abatementDateTime is: "_fmAbatementDateTime)
 . . set eval("conditions",zi,"vars","fmAbatementDateTime")=fmAbatementDateTime ;
 . . new hl7AbatementDateTime s hl7AbatementDateTime=$$fhirThl7^SYNFUTL(abatementdate)
 . . d log(jlog,"hl7 abatementDateTime is: "_hl7AbatementDateTime)
 . . set eval("conditions",zi,"vars","hl7AbatementDateTime")=hl7AbatementDateTime ;
 . else  d log(jlog,"no abatementDateTime")
 . ;
 . ; determine clinical status (active vs inactive)
 . ;
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","clinicalStatus"))
 . i $get(abatementdate)'="" set clinicalstatus="inactive" ; VistA doesn't allow active problems with a resolution date
 . ;
 . ; determine the encounter visit ien
 . n encounterId
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
 . i encounterId="" s encounterId=$g(json("entry",zi,"resource","encounter","reference"))
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
 . s eval("conditions",zi,"vars","encounterId")=encounterId
 . d log(jlog,"reference encounter ID is : "_encounterId)
 . ;
 . ; determine visit ien
 . ;
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
 . s eval("conditions",zi,"vars","visitIen")=visitIen
 . d log(jlog,"visit ien is: "_visitIen)
 . ;
 . ; ckeck to see if the problem is an allergy in VistA
 . ;
 . n algy s algy=$$ISGMR^SYNFALG(sctcode)
 . i algy'=-1 d  ; this condition is an allergy in VistA
 . . n aname s aname=$p(algy,"^",2)
 . . d QADDALGY^SYNFALG(aname,fmOnsetDateTime,ien)
 . ;
 . ; set up to call the data loader
 . ;
 . ;PRBUPDT(RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)   ;Problem/Condition update - deprecated
 . ;PROBUPD(RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; problems update - use this one
 . n RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID ;
 . ;n RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT ;Problem/Condition update
 . ;s (DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)=""      ;Condition update
 . s (DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID)=""
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s eval("conditions",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s DHPVST=visitIen
 . s eval("conditions",zi,"parms","DHPVST")=visitIen
 . ;
 . s DHPSCT=sctcode
 . s eval("conditions",zi,"parms","DHPSCT")=DHPSCT
 . ;
 . ;s DHPCLNST=$S(clinicalstatus="Active":"A",1:"I")
 . ;s eval("conditions",zi,"parms","DHPCLNST")=DHPCLNST
 . ;
 . s DHPDTM=hl7OnsetDateTime
 . s eval("conditions",zi,"parms","DHPDTM")=DHPDTM
 . ;
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",IMMPROV,""))
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
 . s eval("conditions",zi,"parms","DHPPROV")=DHPPROV
 . d log(jlog,"Provider NPI for outpatient is: "_DHPPROV)
 . ;
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
 . ;s eval("conditions",zi,"parms","DHPLOC")=DHPLOCIEN
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s eval("conditions",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Condition already loaded, skipping")
 . . d log(jlog,"Calling PROBUPD^SYNDHP61 to add condition")
 . . D PROBUPD^SYNDHP61(.RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; problems update - use this one
 . . ;D PRBUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)      ;Problem/Condition update
 . . m eval("conditions",zi,"status")=RETSTA
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
 . . . s eval("conditions",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
 . . . s eval("conditions",zi,"status","loadstatus")="notLoaded"
 . . . s eval("conditions",zi,"status","loadMessage")=$g(RETSTA)
 . . n root s root=$$setroot^SYNWD("fhir-intake")
 . . k @root@(ien,"load","conditions",zi)
 . . m @root@(ien,"load","conditions",zi)=eval("conditions",zi)
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=json
 . m jrslt("args")=args
 . m jrslt("eval")=eval
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(eval("status","loaded"))
 i $g(ien)'="" d  ; called internally
 . m result=eval
 . m result("status")=jrslt("result")
 . m result("dfn")=dfn
 . m result("ien")=ien
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)       ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall ; run the conditions import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeConditions(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload)     ; run the conditions import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter
 n done s done=0
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:$d(@root@(ien,"load","conditions"))
 . s filter("dfn")=dfn
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . d wsIntakeConditions(.filter,,.reslt,ien)
 . s done=1
 q
 ;

SYNFPRB
SYNFPRB ;ven/gpl - fhir loader utilities ;Aug 15, 2019@15:23:24
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
importConditions(rtn,ien,args)  ; entry point for loading Problems for a patient
 ; calls the intake Conditions web service directly
 ;
 n grtn
 d wsIntakeConditions(.args,,.grtn,ien)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeConditions(args,body,result,ien)        ; web service entry (post)
 ; for intake of one or more Conditions. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n jtmp,json,jrslt,eval
 ;i $g(ien)'="" if $$loadStatus("conditions","",ien)=1 d  q  ;
 ;. s result("conditionsStatus","status")="alreadyLoaded"
 i $g(ien)'="" d  ; internal call
 . d getIntakeFhir^SYNFHIR("json",,"Condition",ien,1)
 e  d  ;
 . s args("load")=0
 . merge jtmp=BODY
 . do decode^SYNJSONE("jtmp","json")
 i '$d(json) q  ;
 m ^gpl("gjson")=json
 ;
 ; determine the patient
 ;
 n dfn,eval
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("conditions",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(eval("conditions",zi))
 . ;
 . ; insure that the resourceType is Observation
 . ;
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
 . if type'="Condition" do  quit  ;
 . . set eval("conditions",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Condition, skipping entry")
 . set eval("conditions",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("condition",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Condition already loaded, skipping")
 . ;
 . ; determine Condition snomed code, coding system, and display text
 . ;
 . ;
 . ; determine the id of the resource
 . ;
 . ;new id set id=$get(json("entry",zi,"resource","id"))
 . ;set eval("conditions",zi,"vars","id")=id
 . ;d log(jlog,"ID is: "_id)
 . ;
 . ;
 . ; determine the encounter visit ien
 . n encounterId
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
 . i encounterId="" s encounterId=$g(json("entry",zi,"resource","encounter","reference"))
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
 . s eval("conditions",zi,"vars","encounterId")=encounterId
 . d log(jlog,"reference encounter ID is : "_encounterId)
 . ;
 . ; determine visit ien
 . ;
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
 . s eval("conditions",zi,"vars","visitIen")=visitIen
 . d log(jlog,"visit ien is: "_visitIen)
 . n visitDate s visitDate=$$GET1^DIQ(9000010,visitIen_",",.01,"I")
 . i visitDate'=-1 d  ;
 . . s eval("conditions",zi,"vars","visitDate")=visitDate
 . . d log(jlog,"visit date is: "_visitDate)
 . e  d log(jlog,"visit date unknow")
 . ;
 . ; determine the code
 . ;
 . new sctcode set sctcode=$get(json("entry",zi,"resource","code","coding",1,"code"))
 . do log(jlog,"code is: "_sctcode)
 . set eval("conditions",zi,"vars","code")=sctcode
 . n icdcode,notmapped,icdcodetype
 . s notmapped=0
 . i visitDate<3151001 s icdcodetype="icd9"
 . e  s icdcodetype="icd10"
 . d log(jlog,"icd code type is: "_icdcodetype)
 . i icdcodetype="icd9" s icdcode=$$MAP^SYNDHPMP("sct2icdnine",sctcode)
 . e  s icdcode=$$MAP^SYNDHPMP("sct2icd",sctcode)
 . i +icdcode=-1 s notmapped=1
 . d:notmapped MAPERR^SYNQLDM(sctcode,icdcodetype)
 . do log(jlog,"icd mapping is: "_icdcode)
 . do:notmapped log(jlog,"snomed code "_sctcode_" is not mapped")
 . set eval("conditions",zi,"vars","mappedIcdCode")=icdcode
 . ;
 . ; determine the onset date and time
 . ;
 . new onsetdate set onsetdate=$get(json("entry",zi,"resource","onsetDateTime"))
 . do log(jlog,"onsetDateTime is: "_onsetdate)
 . set eval("conditions",zi,"vars","onsetDateTime")=onsetdate
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
 . set eval("conditions",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(onsetdate)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
 . set eval("conditions",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
 . ;
 . ; determine the abatement date and time, if any
 . ;
 . new abatementdate set abatementdate=$get(json("entry",zi,"resource","abatementDateTime"))
 . if abatementdate'="" d  ;
 . . do log(jlog,"abatementDateTime is: "_abatementdate)
 . . set eval("conditions",zi,"vars","abatementDateTime")=abatementdate
 . . new fmAbatementDateTime s fmAbatementDateTime=$$fhirTfm^SYNFUTL(abatementdate)
 . . d log(jlog,"fileman abatementDateTime is: "_fmAbatementDateTime)
 . . set eval("conditions",zi,"vars","fmAbatementDateTime")=fmAbatementDateTime ;
 . . new hl7AbatementDateTime s hl7AbatementDateTime=$$fhirThl7^SYNFUTL(abatementdate)
 . . d log(jlog,"hl7 abatementDateTime is: "_hl7AbatementDateTime)
 . . set eval("conditions",zi,"vars","hl7AbatementDateTime")=hl7AbatementDateTime ;
 . else  d log(jlog,"no abatementDateTime")
 . ;
 . ; determine clinical status (active vs inactive)
 . ;
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","clinicalStatus"))
 . i $get(abatementdate)'="" set clinicalstatus="inactive" ; VistA doesn't allow active problems with a resolution date
 . ;
 . ; determine the encounter visit ien
 . n encounterId
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
 . i encounterId="" s encounterId=$g(json("entry",zi,"resource","encounter","reference"))
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
 . s eval("conditions",zi,"vars","encounterId")=encounterId
 . d log(jlog,"reference encounter ID is : "_encounterId)
 . ;
 . ; determine visit ien
 . ;
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
 . s eval("conditions",zi,"vars","visitIen")=visitIen
 . d log(jlog,"visit ien is: "_visitIen)
 . ;
 . ; set up to call the data loader
 . ;
 . ;PRBUPDT(RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)   ;Problem/Condition update
 . n RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT ;Problem/Condition update
 . s (DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)=""      ;Condition update
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s eval("conditions",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s DHPVST=visitIen
 . s eval("conditions",zi,"parms","DHPVST")=visitIen
 . ;
 . s DHPSCT=sctcode
 . s eval("conditions",zi,"parms","DHPSCT")=DHPSCT
 . ;
 . s DHPCLNST=$S(clinicalstatus="Active":"A",1:"I")
 . s eval("conditions",zi,"parms","DHPCLNST")=DHPCLNST
 . ;
 . s DHPONS=hl7OnsetDateTime
 . s eval("conditions",zi,"parms","DHPONS")=DHPONS
 . ;
 . s DHPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",IMMPROV,""))
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
 . s eval("conditions",zi,"parms","DHPROV")=DHPROV
 . d log(jlog,"Provider NPI for outpatient is: "_DHPROV)
 . ;
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
 . ;s eval("conditions",zi,"parms","DHPLOC")=DHPLOCIEN
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s eval("conditions",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Condition already loaded, skipping")
 . . i notmapped d  ; snomed code does not map to icd code, can't use DATA2PCE
 . . . d log(jlog,"Calling PROBUPD^SYNDHP61 to add condition")
 . . . n DHPSDES,DHPRID,DHPDTM S (DHPSDES,DHPRID)=""
 . . . s DHPDTM=DHPONS
 . . . D PROBUPD^SYNDHP61(.RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; update problem list with Snomed code
 . . i 'notmapped d  ; snomed code does map, use DATA2PCE to add problem to problem list
 . . . d log(jlog,"Calling PRBUPDT^SYNDHP62 to add snomed condition")
 . . . D PRBUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)    ;Problem/Condition update
 . . m eval("conditions",zi,"status")=RETSTA
 . . ;i $g(DEBUG)=1 ZWR RETSTA
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s eval("conditions","status","loaded")=$g(eval("conditions","status","loaded"))+1
 . . . s eval("conditions",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s eval("conditions","status","errors")=$g(eval("conditions","status","errors"))+1
 . . . s eval("conditions",zi,"status","loadstatus")="notLoaded"
 . . . s eval("conditions",zi,"status","loadMessage")=$g(RETSTA)
 . . n root s root=$$setroot^SYNWD("fhir-intake")
 . . k @root@(ien,"load","conditions",zi)
 . . m @root@(ien,"load","conditions",zi)=eval("conditions",zi)
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=json
 . m jrslt("args")=args
 . m jrslt("eval")=eval
 m jrslt("conditionsStatus")=eval("conditionsStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(eval("conditions","status","loaded"))
 set jrslt("result","errors")=$g(eval("conditions","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=eval
 . m result("status")=jrslt("result")
 . ;m result("dfn")=dfn
 . ;m result("ien")=ien
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)    ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 w:$G(DEBUG) !,"      ",$G(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall ; run the conditions import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeConditions(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload)   ; run the conditions import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter
 n done s done=0
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:$d(@root@(ien,"load","conditions"))
 . s filter("dfn")=dfn
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . d wsIntakeConditions(.filter,,.reslt,ien)
 . s done=1
 q
 ;

SYNFPROC
SYNFPROC ;ven/gpl - fhir loader utilities ;Aug 15, 2019@14:27:49
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 ;
 q
 ;
importProcedures(rtn,ien,args)  ; entry point for loading Procedures for a patient
 ; calls the intake Procedures web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 d wsIntakeProcedures(.args,,.grtn,ien)
 ;
 s rtn("proceduresStatus","status")=$g(grtn("status","status"))
 s rtn("proceduresStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("proceduresStatus","errors")=$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeProcedures(args,body,result,ien) ; web service entry (post)
 ; for intake of one or more Procedures. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 ;
 n root,troot
 s root=$$setroot^SYNWD("fhir-intake")
 ;
 n jtmp,json,jrslt,eval
 i $g(ien)'="" d  ; internal call
 . s troot=$na(@root@(ien,"type","Procedure"))
 . s eval=$na(@root@(ien,"load")) ; move eval to the graph
 e  q 0  ; sending not decoded json in BODY to this routine not supported
 ; todo: locate the patient and add the procedure in BODY to the graph
 s json=$na(@root@(ien,"json"))
 ;
 ; determine the patient
 ;
 n dfn
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit  ; need the patient
 . s result("procedures",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(@troot@(zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(@eval@("procedures",zi))
 . ;
 . ; insure that the resourceType is Procedure
 . ;
 . new type set type=$get(@json@("entry",zi,"resource","resourceType"))
 . if type'="Procedure" do  quit  ;
 . . set @eval@("procedures",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Procedure, skipping entry")
 . set @eval@("procedures",zi,"vars","resourceType")=type
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("procedure",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Procedure already loaded, skipping")
 . ;
 . ; determine Procedure snomed code, coding system, and display text
 . ;
 . new sctcode set sctcode=$get(@json@("entry",zi,"resource","code","coding",1,"code"))
 . do log(jlog,"code is: "_sctcode)
 . set @eval@("procedures",zi,"vars","code")=sctcode
 . ;
 . ;
 . new codesystem set codesystem=$get(@json@("entry",zi,"resource","code","coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set @eval@("procedures",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the date and time
 . ;
 . new performeddate set performeddate=$get(@json@("entry",zi,"resource","performedDateTime"))
 . i performeddate="" set performeddate=$get(@json@("entry",zi,"resource","performedPeriod","start"))
 . do log(jlog,"onsetDateTime is: "_performeddate)
 . set @eval@("procedures",zi,"vars","performedDateTime")=performeddate
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(performeddate)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
 . set @eval@("procedures",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(performeddate)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
 . set @eval@("procedures",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
 . ;
 . ;
 . ; determine the encounter visit ien
 . n encounterId
 . s encounterId=$g(@json@("entry",zi,"resource","context","reference"))
 . i encounterId="" s encounterId=$g(@json@("entry",zi,"resource","encounter","reference"))
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
 . s @eval@("procedures",zi,"vars","encounterId")=encounterId
 . d log(jlog,"reference encounter ID is : "_encounterId)
 . ;
 . ; determine visit ien
 . ;
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
 . s @eval@("procedures",zi,"vars","visitIen")=visitIen
 . d log(jlog,"visit ien is: "_visitIen)
 . ;
 . ; set up to call the data loader
 . ;
 . ;PRCADD(RETSTA,DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM)
 . n RETSTA,DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM ;
 . s (DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM)=""
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s @eval@("procedures",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . s DHPCNT=1 ; always one procedure per resource
 . ;
 . s DHPVST=visitIen
 . s @eval@("procedures",zi,"parms","DHPVST")=visitIen
 . ;
 . s DHPDSCT=sctcode
 . s @eval@("procedures",zi,"parms","DHPDSCT")=DHPDSCT
 . ;
 . s DHPDTM=hl7OnsetDateTime
 . s @eval@("procedures",zi,"parms","DHPDTM")=DHPDTM
 . ;
 . ;
 . s @eval@("procedures",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("procedures",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Procedure already loaded, skipping")
 . . d log(jlog,"Calling PRCADD^SYNDHP65 to add procedure")
 . . D PRCADD^SYNDHP65(.RETSTA,DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM) ; procedures update
 . . m @eval@("procedures",zi,"status")=RETSTA
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s @eval@("procedures","status","loaded")=$g(@eval@("procedures","status","loaded"))+1
 . . . s @eval@("procedures",zi,"status","loadstatus")="loaded"
 . . else  d  ;
 . . . s @eval@("procedures","status","errors")=$g(@eval@("procedures","status","errors"))+1
 . . . s @eval@("procedures",zi,"status","loadstatus")="notLoaded"
 . . . s @eval@("procedures",zi,"status","loadMessage")=$g(RETSTA)
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=@json
 . m jrslt("args")=args
 . m jrslt("eval")=@eval
 m jrslt("proceduresStatus")=@eval@("proceduresStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(@eval@("procedures","status","loaded"))
 set jrslt("result","errors")=$g(@eval@("procedures","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=@eval
 . m result("status")=jrslt("result")
 . ;m result("dfn")=dfn
 . ;m result("ien")=ien
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q
 ;
log(ary,txt)  ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 w:$G(DEBUG) !,"      ",$G(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
 ;
testall ; run the procedures import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=" "
 f  s dfn=$o(@indx@(dfn),-1) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . s filter("load")=1
 . k reslt
 . d wsIntakeProcedures(.filter,,.reslt,ien)
 q
 ;
testone(reslt,doload,ien) ; run the procedures import on one patients
 ; ien is optional but will be used if specified
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,filter
 n done s done=0
 s dfn=0
 i $g(ien)="" f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . q:$d(@root@(ien,"load","procedures"))
 . s done=1
 i $g(ien)'="" d  ;
 . s filter("dfn")=$g(dfn)
 . s filter("debug")=1
 . i $g(doload)=1 s filter("load")=1
 . k reslt
 . d wsIntakeProcedures(.filter,,.reslt,ien)
 . s done=1
 q
 ;
procsum ; search all loaded patients and catelog the procedure codes
 n root,json,ien,table
 s root=$$setroot^SYNWD("fhir-intake")
 s ien=0
 f  s ien=$o(@root@(ien)) q:+ien=0  d  ;
 . k json
 . d getIntakeFhir^SYNFHIR("json",,"Procedure",ien,1)
 . n cde,txt,rien
 . s rien=0
 . f  s rien=$o(json("entry",rien)) q:+rien=0  d  ;
 . . n gn s gn=$na(json("entry",rien,"resource"))
 . . s cde=$g(@gn@("code","coding",1,"code"))
 . . q:cde=""
 . . s txt=$g(@gn@("code","coding",1,"display"))
 . . i '$d(table(cde)) s table(cde_" "_txt)=1 q  ;
 . . s table(cde,txt)=$g(table(cde,txt))+1
 n zi s zi=""
 f  s zi=$o(table(zi)) q:zi=""  d  ;
 . w !,zi
 . ;w "|"
 . ;w $o(table(zi,""))
 ;zwr table
 q
 ;

SYNFPUL
SYNFPUL ;ven/gpl - fhir loader utilities ;2018-08-17  3:26 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 ;
 ; patient list pull routines
 q
 ;
wsPull(rtn,filter)      ; pull web service. assumes url to list is passed as filter("listurl")=url
 ;
 n groot s groot=$$setroot^SYNWD("patient-lists")
 ;
 n listurl s listurl=$g(filter("listurl"))
 q:listurl=""
 i listurl["synthea1m.vistaplex.org" d  ;
 . s listurl="http://138.197.147.128"_$p(listurl,"synthea1m.vistaplex.org",2)
 ;
 n listname
 s listname=$re($p($re(listurl),"/",1))
 i listname[":" s listname=$p(listname,":",2)
 i listname["?" s listname=$p(listname,"?",1)
 ;
 n ret,json,jtmp
 s ret=$$GETURL^XTHC10(listurl,,"jtmp")
 d assemble("jtmp","json")
 ;s ret=$$%^%WC(.json,"GET",listurl)
 w !,"return is: ",ret,!
 ;zwrite json
 ;
 n lien,jary
 s lien=$o(@groot@("B",listname,""))
 i lien'="" k @groot@(lien)
 e  set lien=$order(@groot@(" "),-1)+1
 s @groot@("B",listname,lien)=""
 ;
 set gr=$name(@groot@(lien,"list"))
 do decode^SYNJSONE("json",gr)
 s @gr@("listname")=listname
 do indexList(lien)
 s rtn("listien")=lien
 ;
 ;w !
 ;zwrite @gr@(*)
 ;
 q
 ;
testpull        ;
 s lurl="http://synthea1m.vistaplex.org:9080/see/tag:random-over50-notDead-M-10-2?format=json"
 s filter("listurl")=lurl
 d wsPull(.g,.filter)
 q
 ;
indexList(ien)  ; produce the index for a patient list
 ;
 n lroot s lroot=$$setroot^SYNWD("patient-lists")
 n zi s zi=""
 f  s zi=$o(@lroot@(ien,"list","items",zi)) q:zi=""  d  ;
 . n title s title=$g(@lroot@(ien,"list","items",zi,"title"))
 . s @lroot@(ien,"B",title,zi)=""
 q
 ;
wsLol(rtn,filter)       ; list of list web service
 ;
 n groot s groot=$$setroot^SYNWD("list-of-lists")
 ;
 n listurl s listurl="http://synthea1m.vistaplex.org:9080/see/rand*?format=json"
 ;n listurl s listurl="http://138.197.147.128:9080/see/rand*?format=json"
 ;
 n listname
 s listname=listurl
 ;s listname=$re($p($re(listurl),"/",1))
 ;i listname[":" s listname=$p(listname,":",2)
 i listname["?" s listname=$p(listname,"?",1)
 ;
 n zret,json,jtmp
 ;s zret=$$GETURL^XTHC10(listurl,,"jtmp")
 ;d assemble("jtmp","json")
 s zret=$$%^%WC(.json,"GET",listurl)
 ;w !,"return is: ",zret,!
 ;zwrite json
 ;
 n lien,jary
 s lien=$o(@groot@("B",listname,""))
 i lien'="" k @groot@(lien)
 e  set lien=$order(@groot@(" "),-1)+1
 s @groot@("B",listname,lien)=""
 ;
 set gr=$name(@groot@(lien,"list"))
 do decode^SYNJSONE("json",gr)
 s @gr@("listname")=listname
 do indexLol(lien)
 k @gr@("listname")
 ;
 s rtn=$na(^TMP("SYNFHIR",$J))
 k @rtn
 n jout m jout=@gr
 k jout("listname")
 ;m @rtn=json
 d encode^SYNJSONE("jout",rtn)
 set HTTPRSP("mime")="application/json"
 q
 ;
wsLol2(rtn,filter)      ; list of list web service
 ;
 n groot s groot=$$setroot^SYNWD("list-of-lists")
 ;
 ;n listurl s listurl="http://synthea1m.vistaplex.org:9080/see/rand*?format=json"
 n listurl s listurl="http://138.197.147.128:9080/see/rand*?format=json"
 ;
 n listname
 s listname=listurl
 ;s listname=$re($p($re(listurl),"/",1))
 ;i listname[":" s listname=$p(listname,":",2)
 i listname["?" s listname=$p(listname,"?",1)
 ;
 n zret,json,jtmp
 ;s zret=$$GETURL^XTHC10(listurl,,"jtmp")
 ;d assemble("jtmp","json")
 s zret=$$%^%WC(.json,"GET",listurl)
 ;w !,"return is: ",zret,!
 ;zwrite json
 ;
 ;n lien,jary
 ;s lien=$o(@groot@("B",listname,""))
 ;i lien'="" k @groot@(lien)
 ;e  set lien=$order(@groot@(" "),-1)+1
 ;s @groot@("B",listname,lien)=""
 ;
 ;set gr=$name(@groot@(lien,"list"))
 ;do decode^SYNJSONE("json",gr)
 ;s @gr@("listname")=listname
 ;do indexLol(lien)
 ;k @gr@("listname")
 ;
 s rtn=$na(^TMP("SYNFHIR",$J))
 k @rtn
 ;n jout m jout=@gr
 ;k jout("listname")
 m @rtn=json
 ;d encode^SYNJSONE("jout",rtn)
 set HTTPRSP("mime")="application/json"
 q
 ;
indexLol(ien)   ;
 ;
 n lroot s lroot=$$setroot^SYNWD("list-of-lists")
 n zi s zi=""
 f  s zi=$o(@lroot@(ien,"list","items",zi)) q:zi=""  d  ;
 . n title s title=$g(@lroot@(ien,"list","items",zi,"title"))
 . s @lroot@(ien,"B",title,zi)=""
 q
 ;
getlol  ; get list of lists
 ;
 n groot s groot=$$setroot^SYNWD("list-of-lists")
 ;
 n listurl
 ;s listurl="http://synthea1m.vistaplex.org:9080/see/dhp-vista*?format=json"
 s listurl="http://138.197.147.128:9080/see/dhp-vista*?format=json"
 ;
 n listname
 s listname=listurl
 i listname["?" s listname=$p(listname,"?",1)
 ;
 q:$d(@groot@("B",listname))  ; list already loaded
 ;
 n zret,json,jtmp
 ;s zret=$$%^%WC(.json,"GET",listurl)
 s zret=$$GETURL^XTHC10(listurl,,"jtmp")
 d assemble("jtmp","json")
 w !,"return is: ",zret,!
 ;zwrite json
 ;
 n lien,jary
 s lien=$o(@groot@("B",listname,""))
 i lien'="" k @groot@(lien)
 e  set lien=$order(@groot@(" "),-1)+1
 s @groot@("B",listname,lien)=""
 ;
 set gr=$name(@groot@(lien,"list"))
 do decode^SYNJSONE("json",gr)
 s @gr@("listname")=listname
 do indexLol(lien)
 ;
 q
 ;
assemble(in,out)        ; reassemble json from the pieces
 n zi,zj
 s @out=""
 s zi=0
 f  s zi=$o(@in@(zi)) q:+zi=0  d  ;
 . s @out=@out_@in@(zi)
 . s zj=0
 . f  s zj=$o(@in@(zi,zj)) q:+zj=0  d  ;
 . . s @out=@out_$g(@in@(zi,zj))
 q
 ;
load1list(zlist)        ;
 n lroot s lroot=$$setroot^SYNWD("patient-lists")
 n lolroot s lolroot=$$setroot^SYNWD("list-of-lists")
 n uselist
 ;s uselist="http://synthea1m.vistaplex.org:9080/see/dhp-vista*"
 s uselist="http://138.197.147.128:9080/see/dhp-vista*"
 n lolien s lolien=$o(@lolroot@("B",uselist,"")) ; ien of the list of lists
 ;
 n uselist2 s uselist2=zlist
 n zl
 s zl=$o(@lolroot@(lolien,"B",uselist2,""))
 i zl="" d  q  ;
 . w !,"Error, list not found: "_uselist2
 ;
 n ltitle s ltitle=$g(@lolroot@(lolien,"list","items",zl,"title"))
 n lurl s lurl=$g(@lolroot@(lolien,"list","items",zl,"url"))
 ;
 i lurl="" d  q  ;
 . w !,"error list url not found"
 ;
 n lien
 s lien=$o(@lroot@("B",ltitle,""))
 i lien'="" d  q lien  ;
 . w !,"list already loaded: "_ltitle_" ien: "_lien
 ;
 w !,"title: ",ltitle
 w !,"url: ",lurl
 ;
 n filter s filter("listurl")=lurl
 n lret
 d wsPull(.lret,.filter)
 ;
 s lien=$g(lret("listien"))
 i lien="" d  q  ;
 . w !,"error, list ien not returned"
 ;
 q lien
 ;
test1pat(rtn,start,end) ;
 k rtn
 n lroot s lroot=$$setroot^SYNWD("patient-lists")
 n uselist s uselist="dhp-vista-1000-1"
 n listien s listien=$o(@lroot@("B",uselist,""))
 q:listien=""
 n listroot s listroot=$na(@lroot@(listien,"list","items"))
 n pid,purl
 i $g(start)="" s start=1
 i $g(end)="" s end=start
 n num
 f num=start:1:end d
 . s pid=$g(@listroot@(num,"title"))
 . s purl=$g(@listroot@(num,"url"))
 . n filter
 . s filter("id")=pid
 . s filter("url")=purl
 . q:purl=""
 . d wsLoadPat(.rtn,.filter)
 q
 ;
loadpats(rtn,listien)   ;
 k rtn
 n lroot s lroot=$$setroot^SYNWD("patient-lists")
 n froot s froot=$$setroot^SYNWD("fhir-intake")
 q:listien=""
 n listroot s listroot=$na(@lroot@(listien,"list","items"))
 n pid,purl
 n num s num=0
 f  s num=$o(@listroot@(num)) q:+num=0  d  ;
 . s pid=$g(@listroot@(num,"title"))
 . s purl=$g(@listroot@(num,"url"))
 . n filter
 . s filter("id")=pid
 . s filter("url")=purl
 . q:purl=""
 . i $d(@froot@("B",pid)) d  q  ; already loaded
 . . w !,"patient already loaded: "_pid
 . w !,"loading patient "_pid
 . d wsLoadPat(.rtn,.filter)
 q
 ;
wsLoadPat(zrtn,zfilter) ; load one patient from a URL
 ; zfilter("url")=patienturl
 ; zfilter("id")=patientID
 ; returns same as wsPostFHIR^SYNFHIR
 ;
 s U="^"
 ;
 n ret,json,purl
 s purl=$g(zfilter("url"))
 i purl="" d  q  ;
 . s zrtn="-1^URL not found"
 i purl["synthea1m.vistaplex.org" d  ;
 . s purl="http://138.197.147.128"_$p(purl,"synthea1m.vistaplex.org",2)
 ;
 ;s ret=$$%^%WC(.json,"GET",purl)
 n jtmp
 s ret=$$GETURL^XTHC10(purl,,"jtmp")
 d assemble("jtmp","json")
 i +ret=-1 d  s $ec=",u-error,"
 . w !,ret," ",purl
 ;
 i json["error" s zrtn="-1^Bundle returned error" q  ;
 i json="" s zrtn="-1^Bundle returned null" q  ;
 ;
 new ien,root,gr,id,return
 set root=$$setroot^SYNWD("fhir-intake")
 set id=$get(zfilter("id"))
 ;
 set ien=$order(@root@(" "),-1)+1
 set gr=$name(@root@(ien,"json"))
 do decode^SYNJSONE("json",gr)
 do indexFhir^SYNFHIR(ien)
 W:ien#500=0 !,"Patient # "_ien_" "_$$FMTE^XLFDT($$NOW^XLFDT)
 ;
 if id'="" do  ;
 . set @root@("B",id,ien)=""
 else  do  ;
 . ;
 ;
 if $get(ARGS("returngraph"))=1 do  ;
 . merge return("graph")=@root@(ien,"graph")
 set return("status")="ok"
 set return("id")=id
 set return("ien")=ien
 ;
 do importPatient^SYNFPAT(.return,ien)
 ;
 new rdfn set rdfn=$get(return("dfn"))
 if rdfn'="" set @root@("DFN",rdfn,ien)=""
 ;
 if rdfn'="" do  ; patient creation was successful
 . if $g(ARGS("load"))="" s ARGS("load")=1
 . do importLabs^SYNFLAB(.return,ien,.ARGS)
 . do importVitals^SYNFVIT(.return,ien,.ARGS)
 . do importEncounters^SYNFENC(.return,ien,.ARGS)
 . do importImmu^SYNFIMM(.return,ien,.ARGS)
 . do importConditions^SYNFPRB(.return,ien,.ARGS)
 . do importAllergy^SYNFALG(.return,ien,.ARGS)
 . do importAppointment^SYNFAPT(.return,ien,.ARGS)
 . do importMeds^SYNFMED2(.return,ien,.ARGS)
 . do importProcedures^SYNFPROC(.return,ien,.ARGS)
 . do importCarePlan^SYNFCP(.return,ien,.ARGS)
 ;
 ;do encode^SYNJSONE("return","RESULT")
 ;do encode^SYNJSONE("return","zrtn")
 set HTTPRSP("mime")="application/json"
 ;
 quit
 ;
TEST1K  ; test loading first 1000 patients in the lists
 d getlol ; get the list of lists
 n lstien ; ien in patient-lists that we will process
 n lname s lname="dhp-vista-1000-1" ; name of the first list
 s lstien=$$load1list(lname) ; load the first list and return the ien
 d loadpats(.return,lstien) ; load the patients from the first list
 q
 ;
LOADALL ; load all 50000 patients
 d getlol ; get the list of lists
 n lstien ; ien in patient-lists that we will process
 n tlname s tlname="dhp-vista-1000-" ; template for the list names
 n ii
 f ii=1:1:50 d  ; for all 50 lists
 . s lname=tlname_ii ; name of the list
 . s lstien=$$load1list(lname) ; load the list and return the ien
 . d loadpats(.return,lstien) ; load the patients from the list
 q
 ;
CLEANGRAPH      ;
 ;
 n groot s groot=$$setroot^SYNWD("fhir-intake")
 n zi,zj,zk
 s (zi,zj,zk)=""
 f  s zi=$o(@groot@("B",zi)) q:zi=""  d  ;
 . s zj=$o(@groot@("B",zi,""))
 . s zk=$o(@groot@("B",zi,zj))
 . i zk'="" d  ; a duplicate
 . . i $$ien2dfn^SYNFUTL(zk)'="" q  ; has a VistA record
 . . w !,"removing ien: "_zk_" name: "_zi
 . . k @groot@(zk) ; clear the graph
 . . k @groot@("B",zi,zk) ; remove from the index
 q
 ;

SYNFTIU
SYNFTIU  ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 ; Encounter TIU note utilities
 q
 ;
TONOTE(ien,enc,line) ; insert a line to the note associated with encounter enc
 ; enc is a pointer to the encounter
 ; ien identifies the patient graph
 ;
 n nroot s nroot=$$NOTEPTR^SYNFTIU(ien,enc)
 q:nroot=""
 ;w !,"add to note: ",line
 i $l(line)>80 d  ;
 . n tline s tline(0)=line
 .
 . d WRAP^DIKCU2(.tline,80)
 . ; ZWR tline
 . n zi
 . f zi=0:1:$o(tline(" "),-1) d  ;
 . . s @nroot@($o(@nroot@(" "),-1)+zi)=tline(zi)
 e  s @nroot@($o(@nroot@(" "),-1)+1)=line
 q
 ;
NOTEPTR(ien,enc) ; returns a global pointer to the note for this encounter
 ; ien is the patient graph
 n root s root=$$setroot^SYNWD("fhir-intake")
 n groot s groot=$na(@root@(ien))
 n encien s encien=$o(@groot@("PSO","rien",enc,""))
 q:encien="" ""
 n nroot s nroot=$na(@groot@("load","encounters",encien,"note"))
 q nroot
 ;
KILLNOTE(ien,enc) ; kill the note for this encounter
 ; used for testing
 n knote s knote=$$NOTEPTR^SYNFTIU(ien,enc)
 q:'$d(@knote)
 k @knote
 q
 ;
CLRNOTES(ien,rien) ; kill all notes for patient ien
 n root s root=$$setroot^SYNWD("fhir-intake")
 n groot s groot=$na(@root@(ien,"load","encounters"))
 n zi s zi=0
 f  s zi=$o(@groot@(zi)) q:+zi=0  d  ;
 . k @groot@(zi,"note")
 . w !,"kill ",groot," ",zi," note"
 q
 ;
T1 ;
 s ien=1640
 s enc="urn:uuid:02eb455c-787c-4abb-8f39-a9675a2db35c"
 w !,"note pointer: ",$$NOTEPTR^SYNFTIU(ien,enc)
 q
 ;
T2 ;
 s ien=1640
 s enc="urn:uuid:02eb455c-787c-4abb-8f39-a9675a2db35c"
 d KILLNOTE^SYNFTIU(ien,enc)
 d TONOTE^SYNFTIU(ien,enc,"Test Note Creation")
 d TONOTE^SYNFTIU(ien,enc,"Patient ien: "_ien)
 d TONOTE^SYNFTIU(ien,enc,"Encounter Id: "_enc)
 q
 ;

SYNFUTL
SYNFUTL ;ven/gpl - fhir loader utilities ;2019-02-07  3:35 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
initPLD(ien,element)    ; initializes the PLD pointers in the fhir graph
 new root set root=$$setroot^SYNWD("fhir-intake")
 set @root@(ien,"load",element,"PLD","parms")=$name(@root@(ien,"load",element,"parms"))
 set @root@(ien,"load",element,"PLD","log")=$name(@root@(ien,"load",element,"log"))
 set @root@(ien,"load",element,"PLD","verify")=$name(@root@(ien,"load",element,"verify"))
 set @root@(ien,"load",element,"PLD","status")=$name(@root@(ien,"load",element,"status"))
 set @root@(ien,"load",element,"PLD","index")=root
 quit
 ;
setPLD(ien,element)     ; extrinsic which returns the global name containing the PLD for this element
 new root set root=$$setroot^SYNWD("fhir-intake")
 if '$data(@root@(ien,"load",element,"PLD")) do initPLD(ien,element)
 quit $name(@root@(ien,"load","Patient","PLD"))
 ;
log(txt)        ; logs a line to the log array defined by PLD("log")
 if '$data(PLD("log")) do  quit  ;
 . w !,"Error log array not defined ",txt
 do addto(PLD("log"),txt)
 quit
 ;
addto(dest,string)      ; add string to list dest
 ; dest is passed by name
 new %ii
 set %ii=$order(@dest@("AAAAA"),-1)+1
 set @dest@(%ii)=string
 set @dest@(0)=%ii ; count
 quit
 ;
addArray(dest,array)    ; add array to list dest
 ; dest and array are passed by name
 new %ii
 set %ii=$order(@dest@("AAAAA"),-1)+1
 new %ij set %ij=0
 for  set %ij=$order(@array@(%ij)) quit:'%ij  do  ;
 . set @dest@(%ii)=$get(@array@(%ij))
 . set @dest@(0)=%ii ; count
 . set %ii=%ii+1
 quit
 ;
setIndex(sub,pred,obj)  ; set the graph indexices
 n gn s gn=$$setroot^SYNWD("fhir-intake")
 q:sub=""
 q:pred=""
 q:obj=""
 s @gn@("SPO",sub,pred,obj)=""
 s @gn@("POS",pred,obj,sub)=""
 s @gn@("PSO",pred,sub,obj)=""
 s @gn@("OPS",obj,pred,sub)=""
 q
 ;
clearIndexes    ; do this carefully
 n gn s gn=$$setroot^SYNWD("fhir-intake")
 k @gn@("SPO")
 k @gn@("POS")
 k @gn@("PSO")
 k @gn@("OPS")
 q
 ;
fhirTfm(dtin)   ; extrinsic which returns the fileman dateTime
 ; for the FHIR format input ie 2017-04-28T01:28:28-04:00
 n tdt
 s tdt=$tr(dtin,":")
 s tdt=$tr(tdt,"T")
 s tdt=$e(tdt,1,4)_$e(tdt,6,7)_$e(tdt,9,21)
 q $$HL7TFM^XLFDT(tdt)
 ;
fhirThl7(dtin)  ; extrinsic which returns the HL7 dateTime
 ; for the FHIR format input ie 2017-04-28T01:28:28-04:00
 ; example hl7 returned: 20170428012828-0400
 n tdt
 s tdt=$tr(dtin,":")
 s tdt=$tr(tdt,"T")
 s tdt=$e(tdt,1,4)_$e(tdt,6,7)_$e(tdt,9,21)
 q tdt
 ;
ien2dfn(ien)    ; extrinsic returns the patient DFN given the graph ien
 n root s root=$$setroot^SYNWD("fhir-intake")
 q $o(@root@("PSO","DFN",ien,""))
 ;
dfn2ien(dfn)    ; extrinsic returns the graph ien given the DFN
 n root s root=$$setroot^SYNWD("fhir-intake")
 q $o(@root@("POS","DFN",dfn,""))
 ;
ien2icn(ien)    ; extrinsic returns the patient ICN given the graph ien
 n root s root=$$setroot^SYNWD("fhir-intake")
 q $o(@root@("PSO","ICN",ien,""))
 ;
icn2ien(icn)    ; extrinsic returns the graph ien given the DFN
 n root s root=$$setroot^SYNWD("fhir-intake")
 q $o(@root@("POS","ICN",icn,""))
 ;
dfn2icn(dfn)    ; extrinsic returns the ICN given the patient DFN
 n ien s ien=$$dfn2ien(dfn)
 q $$ien2icn(ien)
 ;
icn2dfn(icn)    ; extrinsic returns the DFN given the patient ICN
 n ien s ien=$$icn2ien(icn)
 q $$ien2dfn(ien)
 ;
urlEnd(zurl)    ; extrinsic which return the last part of a url
 ; (the part after the final /
 q $re($p($re(zurl),"/",1))
 ;
testValueDex()  ;
 ;new fhir
 do getIntakeFhir^SYNFHIR("testfhir",,"Patient",1)
 do valueDex("testfhir","value")
 ;zwrite fhir
 quit
 ;
valueDex(ary,indx)      ; creates index indx of values of the array
 ;
 new ind
 new fi s fi=$query(@ary@(""))
 ;new fi s fi=""
 set ind(indx,@fi)=fi
 for  set fi=$query(@fi) quit:fi=""  do  ;
 . ;w !,@fi," ",fi
 . if @fi="" quit
 . set ind(indx,@fi)=fi
 . ;write !,fi," ",@fi
 ;zwrite ind
 merge @ary=ind
 quit
 ;
valueDex2(ary,indx)     ; creates index indx of values of the array
 ; this one simplifies indx
 new ind
 new fi s fi=$query(@ary@(""))
 set ind(indx,@fi)=fi
 for  set fi=$query(@fi) quit:fi=""  do  ;
 . ;w !,@fi," ",fi
 . if @fi="" quit
 . set ind($qs(fi,$ql(fi)),@fi)=fi
 . ;write !,fi," ",@fi
 ;zwrite ind
 merge @indx=ind
 quit
 ;
testAdb()       ; test Array Defined By
 new fhir
 do getIntakeFhir^SYNFHIR("fhir",,"Patient",1)
 do adb("fhirrace","fhir","text","race")
 zwrite fhirrace
 ;
 ; expected results:
 ;d testAdb^SYNFUTL
 ;fhirrace("coding",1,"code")="2106-3"
 ;fhirrace("coding",1,"display")="White"
 ;fhirrace("coding",1,"system")="http://hl7.org/fhir/v3/Race"
 ;fhirrace("text")="race"
 ;
 quit
 ;
adb(rtn,ary,pred,obj)   ; returns the array defined by the predicate and object
 if '$d(@ary@("value")) do valueDex(ary,"value")
 new ref
 set ref=@ary@("value",obj)
 if ref'[pred quit  ;
 do replace(.ref,","""_pred_"""","")
 ;w !,ref b
 merge @rtn=@ref
 quit
 ;
replace(ln,cur,repl)    ; replace current with replacment in line ln
 new where set where=$find(ln,cur)
 quit:where=0 ; this might not work for cur at the end of ln, please test
 set ln=$extract(ln,1,where-$length(cur)-1)_repl_$extract(ln,where,$length(ln))
 quit
 ;
hex2dec(hex) ; extrinsic returns the decimal conversion of hex number hex
 n ii,dec,dig
 s dec=0
 s hex=$tr(hex,"ABCDEF","abcdef")
 f ii=1:1:$l(hex) s dig=$f("0123456789abcdef",$e(hex,ii)) q:'dig  s dec=(dec*16)+(dig-2)
 q dec
 ;
ien2pid(fien) ; extrinsic returns the patient id from the fhir-intake graph ien=fien
 n root s root=$$setroot^SYNWD("fhir-intake")
 n pid
 set pid=$o(@root@(fien,"POS","type","Patient",""))
 q pid
 ;
pid2icn(pid) ; generate an ICN from a pid
 ; example of a pid: urn:uuid:0a01efae-0662-41ae-a20d-4646ce42b687
 n hpid s hpid=$p(pid,"-",5)
 q:hpid="" -1
 n dpid
 s dpid=$$hex2dec(hpid)
 s dpid=$e(dpid,1,10) ; icn is the first 10 decimal digits
 q dpid
 ;
testIcnGen(fien) ; extrinsic generates an ICN for fhir patient fien
 n pid s pid=$$ien2pid(fien)
 n icn s icn=$$pid2icn(pid)
 n chk s chk=$$CHECKDG^MPIFSPC(icn)
 q icn_"V"_chk
 ;
genos5(sct) ; extrinsic which returns a 5 digit identifier based on sct
 n %shan,%hex,%dec,%rtn
 s %shan=$$SHAN^XLFSHAN(160,sct)
 s %hex=$e(%shan,$l(%shan)-5,$l(%shan))
 s %dec=$$hex2dec^SYNFUTL(%hex)
 s %rtn=$e(%dec,$l(%dec)-4,$l(%dec))
 s $e(%rtn,5)=$e("HIJKLMNOPQ",$e(%rtn,5)+1)
 q %rtn
 ;

SYNFVF
SYNFVF  ;ven/gpl - fhir loader utilities ;2018-08-17  3:28 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2018
 ;
 q
 ;
 ; utilities to pull FHIR resources for VistA patients
 ;
vurl()  ; extrinsic returns the url for VistA get fhir
 q "https://vista-fhir-dev.openplatform.healthcare/api/Patient/"
 ;
wsIcnList(rtn,filter)   ; web service to return a list of ICNs for vista patients
 n dnfmin,dfnmax
 s dfnmin=$g(filter("dfnmin"))
 i dfnmin="" s dfnmin=$o(^DPT(0))
 s dfnmax=$g(filter("dfnmax"))
 i dfnmax="" s dfnmax=$o(^DPT("  "),-1)
 ;
 n tbl ; table of full ICNs sorted by dfn
 d sortAFICN(.tbl)
 ;
 n rtn1 ; json return before decode
 n zi s zi=+$o(tbl(dfnmin),-1)
 f  s zi=$o(tbl(zi)) q:+zi=0  q:zi>dfnmax  d  ;
 . n zj s zj=""
 . f  s zj=$o(tbl(zi,zj)) q:zj=""  d  ;
 . . s rtn1("return",zi,zj,"icn")=zj
 . . s rtn1("return",zi,zj,"dfn")=zi
 ;m rtn=rtn1
 d encode^SYNJSONE("rtn1","rtn")
 q
 ;
sortAFICN(ary)  ; sort the AFICN index by dfn
 n zii s zii=""
 f  s zii=$o(^DPT("AFICN",zii)) q:+zii=0  d  ;
 . n zdfn
 . s zdfn=$o(^DPT("AFICN",zii,""))
 . s ary(zdfn,zii)=""
 q
 ;
getVehuIcns     ; get the Dev VEHU ICNs and stores them in a graph
 n gn,root
 d purgegraph^SYNWD("vehu-icns")
 s root=$$setroot^SYNWD("vehu-icns")
 s gn="http://wip.vistaplex.org:9080/icnlist?dfnmax=100000"
 s ok=$$%^%WC(.g,"GET",gn)
 d decode^SYNJSONE("g","g2")
 ;
 n zi,zj s (zi,zj)=""
 f  s zi=$o(g2("return",zi)) q:zi=""  d  ;
 . f  s zj=$o(g2("return",zi,zj)) q:zj=""  d  ;
 . . s @root@(zi,zj)=""
 . . s @root@("ICN",zj,zi)=""
 ;
 q
 ;
getAllergies    ; get VEHU allergies fhir resources
 ;
 n icnroot s icnroot=$$setroot^SYNWD("vehu-icns")
 ;
 d purgegraph^SYNWD("fhir-vista-AllergyIntolerance")
 n zicn s zicn=""
 f  s zicn=$o(@icnroot@("ICN",zicn)) q:zicn=""  d  ;
 . n domain,entries
 . s domain="AllergyIntolerance"
 . d getDomain("entries",domain,zicn)
 . i '$d(entries) q  ;
 . s entries("ICN")=zicn
 . s entries("DFN")=$o(@icnroot@("ICN",zicn,""))
 . s zien=$$storeGraph("entries","fhir-vista-"_domain,zicn)
 q
 ;
getAppointments ; get VEHU appointment fhir resources
 ;
 n icnroot s icnroot=$$setroot^SYNWD("vehu-icns")
 ;
 d purgegraph^SYNWD("fhir-vista-Appointment")
 n zicn s zicn=""
 f  s zicn=$o(@icnroot@("ICN",zicn)) q:zicn=""  d  ;
 . n domain,entries
 . s domain="Appointment"
 . d getDomain("entries",domain,zicn)
 . i '$d(entries) q  ;
 . s entries("ICN")=zicn
 . s entries("DFN")=$o(@icnroot@("ICN",zicn,""))
 . s zien=$$storeGraph("entries","fhir-vista-"_domain,zicn)
 q
 ;
getProcedures   ; get VEHU procedure fhir resources
 ;
 n icnroot s icnroot=$$setroot^SYNWD("vehu-icns")
 ;
 d purgegraph^SYNWD("fhir-vista-Procedure")
 n zicn s zicn=""
 f  s zicn=$o(@icnroot@("ICN",zicn)) q:zicn=""  d  ;
 . n domain,entries
 . s domain="Procedure"
 . d getDomain("entries",domain,zicn)
 . i '$d(entries) q  ;
 . s entries("ICN")=zicn
 . s entries("DFN")=$o(@icnroot@("ICN",zicn,""))
 . s zien=$$storeGraph("entries","fhir-vista-"_domain,zicn)
 q
 ;
getDomain(rtn,domain,icn)       ; pull domain entries for VistA patient ICN
 n gn2
 s gn2="https://vista-fhir-dev.openplatform.healthcare/api/Patient/"
 ;
 n url,fhir,r1
 s url=gn2_icn_"/"_domain
 s ok=$$%^%WC(.fhir,"GET",url)
 d decode^SYNJSONE("fhir","r1")
 m @rtn@("entry")=r1("entry")
 ;
 q
 ;
storeGraph(ary,graph,id)        ; stores an array ary, passed by name
 ; into graphname graph with B index id
 ; extrinsic, returns the ien
 ;
 i graph="" s graph="misc"
 n root set root=$$setroot^SYNWD(graph)
 ;
 n ien,rien
 s ien=$o(@root@(" "),-1)+1
 ;
 m @root@(ien)=@ary
 ;
 s @root@("B",id,ien)=""
 ;
 q ien
 ;
wsGetAllergy(rtn,filter)        ; web service to pull a random allergy from
 ; graph fhir-vista-Allergy
 ;
 n root s root=$$setroot^SYNWD("fhir-vista-AllergyIntolerance")
 n max
 s max=$o(@root@(" "),-1)
 i +max=0 q  ; nothing to pull
 n ien s ien=$r(max)
 i '$d(@root@(ien)) s ien=$r(max)
 n r1
 s r1=$na(@root@(ien))
 i $g(filter("format"))="mumps" d  q  ;
 . m rtn=@r1
 d encode^SYNJSONE(r1,"rtn")
 q
 ;
wsGetAppointment(rtn,filter)    ; web service to pull a random appointments from
 ; graph fhir-vista-Appointment
 ;
 n root s root=$$setroot^SYNWD("fhir-vista-Appointment")
 n max
 s max=$o(@root@(" "),-1)
 i +max=0 q  ; nothing to pull
 n ien s ien=$r(max)
 i '$d(@root@(ien)) s ien=$r(max)
 n r1
 s r1=$na(@root@(ien))
 i $g(filter("format"))="mumps" d  q  ;
 . m rtn=@r1
 d encode^SYNJSONE(r1,"rtn")
 q
 ;
wsGetProcedure(rtn,filter)      ; web service to pull a random procedure from
 ; graph fhir-vista-Procedure
 ;
 n root s root=$$setroot^SYNWD("fhir-vista-Procedure")
 n max
 s max=$o(@root@(" "),-1)
 i +max=0 q  ; nothing to pull
 n ien s ien=$r(max)
 i '$d(@root@(ien)) s ien=$r(max)
 n r1
 s r1=$na(@root@(ien))
 i $g(filter("format"))="mumps" d  q  ;
 . m rtn=@r1
 d encode^SYNJSONE(r1,"rtn")
 q
 ;

SYNFVIT
SYNFVIT ;ven/gpl - fhir loader utilities ;Aug 15, 2019@14:44:21
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
importVitals(rtn,ien,args) ; entry point for loading vitals for a patient
 ; calls the intake Vitals web service directly
 ;
 n grtn
 n root s root=$$setroot^SYNWD("fhir-intake")
 n % s %=$$wsIntakeVitals(.args,,.grtn,ien)
 ;i $d(grtn) d  ; something was returned
 ;. k @root@(ien,"load","vitals")
 ;. m @root@(ien,"load","vitals")=grtn("vitals")
 ;. if $g(args("debug"))=1 m rtn=grtn
 s rtn("vitalsStatus","status")=$g(grtn("status","status"))
 s rtn("vitalsStatus","loaded")=$g(grtn("status","loaded"))
 s rtn("vitalsStatus","errors")=$g(grtn("status","errors"))
 ;b
 ;
 ;
 q
 ;
wsIntakeVitals(args,body,result,ien) ; web service entry (post)
 ; for intake of one or more Vital signs. input are fhir resources
 ; result is json and summarizes what was done
 ; args include patientId
 ; ien is specified for internal calls, where the json is already in a graph
 n root,troot
 s root=$$setroot^SYNWD("fhir-intake")
 ;
 n jtmp,json,jrslt,eval
 ;i $g(ien)'="" if $$loadStatus("vitals","",ien)=1 d  q  ;
 ;. s result("vitalsStatus","status")="alreadyLoaded"
 i $g(ien)'="" d  ; internal call
 . ;d getIntakeFhir^SYNFHIR("json",,"Observation",ien,1)
 . s troot=$na(@root@(ien,"type","Observation"))
 . s eval=$na(@root@(ien,"load"))
 e  q 0  ; sending json to this routine in BODY is not supported
 ;. ;s args("load")=0
 ;. merge jtmp=BODY
 ;. do decode^SYNJSONE("jtmp","json")
 s json=$na(@root@(ien,"json"))
 i '$d(json) q 0  ;
 ;m ^gpl("gjson")=json
 ;
 ; determine the patient
 ;
 n dfn
 if $g(ien)'="" d  ;
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
 else  d  ;
 . s dfn=$g(args("dfn"))
 . i dfn="" d  ;
 . . n icn s icn=$g(args("icn"))
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
 i $g(dfn)="" do  quit 0  ; need the patient
 . s result("vitals",1,"log",1)="Error, patient not found.. terminating"
 ;
 ;
 new zi s zi=0
 for  set zi=$order(@troot@(zi)) quit:+zi=0  do  ;
 . ;
 . ; define a place to log the processing of this entry
 . ;
 . new jlog set jlog=$name(@eval@("vitals",zi))
 . ;
 . ; insure that the resourceType is Observation
 . ;
 . new type set type=$get(@json@("entry",zi,"resource","resourceType"))
 . if type'="Observation" do  quit  ;
 . . set @eval@("vitals",zi,"vars","resourceType")=type
 . . do log(jlog,"Resource type not Observation, skipping entry")
 . set @eval@("vitals",zi,"vars","resourceType")=type
 . ;
 . ; determine the Observation category and quit if not vital-signs
 . ;
 . new obstype set obstype=$get(@json@("entry",zi,"resource","category",1,"coding",1,"code"))
 . if obstype="" do  ; category is missing, try mapping the code
 . . new trycode,trydisp,tryy
 . . set trycode=$g(@json@("entry",zi,"resource","code","coding",1,"code"))
 . . set trydisp=$g(@json@("entry",zi,"resource","code","coding",1,"display"))
 . . s tryy=$$loinc2sct(trycode)
 . . if tryy="" d  quit  ;
 . . . d log(jlog,"Observation Category missing, not vital signs; code is: "_trycode_" "_trydisp)
 . . if tryy'="" set obstype="vital-signs"
 . . d log(jlog,"Derived category is "_obstype)
 . ;
 . if obstype'="vital-signs" do  quit  ;
 . . set @eval@("vitals",zi,"vars","observationCategory")=obstype
 . . do log(jlog,"Observation Category is not vital-signs, skipping")
 . set @eval@("vitals",zi,"vars","observationCategory")=obstype
 . ;
 . ; see if this resource has already been loaded. if so, skip it
 . ;
 . if $g(ien)'="" if $$loadStatus("vitals",zi,ien)=1 do  quit  ;
 . . d log(jlog,"Vital sign already loaded, skipping")
 . ;
 . ; determine Vitals type, code, coding system, and display text
 . ;
 . new vittype set vittype=$get(@json@("entry",zi,"resource","code","text"))
 . if vittype="" set vittype=$get(@json@("entry",zi,"resource","code","coding",1,"display"))
 . do log(jlog,"Vitals type is: "_vittype)
 . set @eval@("vitals",zi,"vars","type")=vittype
 . ;
 . ; determine the id of the resource
 . ;
 . new id set id=$get(@json@("entry",zi,"resource","id"))
 . set @eval@("vitals",zi,"vars","id")=id
 . d log(jlog,"ID is: "_id)
 . ;
 . new obscode set obscode=$get(@json@("entry",zi,"resource","code","coding",1,"code"))
 . do log(jlog,"code is: "_obscode)
 . set @eval@("vitals",zi,"vars","code")=obscode
 . ;
 . s ^gpl("vitals",obscode,vittype)=""
 . ; here's what we got so far:
 . ;^gpl("vitals","29463-7","Body Weight")=""
 . ;^gpl("vitals","39156-5","Body Mass Index")=""
 . ;^gpl("vitals","55284-4","Blood Pressure")=""
 . ;^gpl("vitals","8302-2","Body Height")=""
 . ;^gpl("vitals","8331-1","Oral temperature")=""
 . ;
 . new codesystem set codesystem=$get(@json@("entry",zi,"resource","code","coding",1,"system"))
 . do log(jlog,"code system is: "_codesystem)
 . set @eval@("vitals",zi,"vars","codeSystem")=codesystem
 . ;
 . ; determine the value and units
 . ;
 . new value set value=$get(@json@("entry",zi,"resource","valueQuantity","value"))
 . do log(jlog,"value is: "_value)
 . set @eval@("vitals",zi,"vars","value")=value
 . ;
 . new unit set unit=$get(@json@("entry",zi,"resource","valueQuantity","unit"))
 . do log(jlog,"units are: "_unit)
 . set @eval@("vitals",zi,"vars","units")=unit
 . ;
 . ; fix blood preasure readings (combine two readings to one)
 . ;
 . if obscode="55284-4" do  ; Blood Pressure
 . . new tmpjson,systolic,diastolic,combined
 . . merge tmpjson=@json@("entry",zi)
 . . d log(jlog,"Combining Blood Pressure values")
 . . n tn s tn=$na(tmpjson("resource","component"))
 . . n tx
 . . f tx=1,2  d  ;
 . . . if $g(@tn@(tx,"code","coding",1,"code"))="8480-6" d  ; Systolic Blood Pressure
 . . . . s systolic("units")=$g(@tn@(tx,"valueQuantity","unit"))
 . . . . s unit=systolic("units")
 . . . . s systolic("value")=$g(@tn@(tx,"valueQuantity","value"))
 . . . . s value=systolic("value")
 . . . . d log(jlog,("Systolic value is: "_systolic("value")))
 . . . if $g(@tn@(tx,"code","coding",1,"code"))="8462-4" d  ; Diastolic Blood Pressure
 . . . . s diastolic("units")=$g(@tn@(tx,"valueQuantity","unit"))
 . . . . s unit=diastolic("units")
 . . . . s diastolic("value")=$g(@tn@(tx,"valueQuantity","value"))
 . . . . s value=diastolic("value")
 . . . . d log(jlog,("Diastolic value is: "_diastolic("value")))
 . . s combined=$g(systolic("value"))_"/"_$g(diastolic("value"))
 . . s value=combined
 . . d log(jlog,"Combined Blood Pressure value is: "_combined)
 . . set @eval@("vitals",zi,"vars","value")=combined
 . . set @eval@("vitals",zi,"vars","units")=$g(diastolic("units"))
 . . d log(jlog,"Blood Pressure units are: "_$g(diastolic("units")))
 . . ;b
 . ;
 . ; determine the effective date
 . ;
 . new effdate set effdate=$get(@json@("entry",zi,"resource","effectiveDateTime"))
 . do log(jlog,"effectiveDateTime is: "_effdate)
 . set @eval@("vitals",zi,"vars","effectiveDateTime")=effdate
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
 . d log(jlog,"fileman dateTime is: "_fmtime)
 . set @eval@("vitals",zi,"vars","fmDateTime")=fmtime ;
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
 . set @eval@("vitals",zi,"vars","hl7DateTime")=hl7time ;
 . ;
 . ; set up to call the data loader
 . ;
 . n RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC
 . ;
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
 . s @eval@("vitals",zi,"parms","DHPPAT")=DHPPAT
 . ;
 . n sct s sct=$$loinc2sct(obscode) ; find the snomed code
 . i sct="" d  quit
 . . d log(jlog,"Snomed Code not found for vitals code: "_obscode_" -- skipping")
 . . s @eval@("vitals",zi,"status","loadstatus")="cannotLoad"
 . . s @eval@("vitals",zi,"status","issue")="Snomed Code not found for vitals code: "_obscode_" -- skipping"
 . . s @eval@("vitals","status","errors")=$g(@eval@("vitals","status","errors"))+1
 . s @eval@("vitals",zi,"parms","DHPSCT")=sct
 . d log(jlog,"Snomed Code is: "_sct)
 . s DHPSCT=sct
 . ;
 . s DHPOBS=value
 . s @eval@("vitals",zi,"parms","DHPOBS")=value
 . d log(jlog,"Value is: "_value)
 . ;
 . s DHPUNT=unit
 . s @eval@("vitals",zi,"parms","DHPUNT")=unit
 . d log(jlog,"Units are: "_unit)
 . ;
 . s DHPDTM=hl7time
 . s @eval@("vitals",zi,"parms","DHPDTM")=hl7time
 . d log(jlog,"HL7 DateTime is: "_hl7time)
 . ;
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider")
 . n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
 . if DHPPROVIEN="" S DHPPROVIEN=3
 . s @eval@("vitals",zi,"parms","DHPPROV")=DHPPROVIEN
 . d log(jlog,"Provider for outpatient is: #"_DHPPROVIEN_" "_DHPPROV)
 . ;
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
 . if DHPLOCIEN="" S DHPLOCIEN=4
 . s @eval@("vitals",zi,"parms","DHPLOC")=DHPLOCIEN
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
 . ;
 . s @eval@("vitals",zi,"status","loadstatus")="readyToLoad"
 . ;
 . if $g(args("load"))=1 d  ; only load if told to
 . . if $g(ien)'="" if $$loadStatus("vitals",zi,ien)=1 do  quit  ;
 . . . d log(jlog,"Vital sign already loaded, skipping")
 . . d log(jlog,"Calling VITUPD^SYNDHP61 to add vital")
 . . D VITUPD^SYNDHP61(.RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC)       ; vitals update
 . . d log(jlog,"Return from VITUPD^ZZDHP61 was: "_$g(RETSTA))
 . . if +$g(RETSTA)=1 do  ;
 . . . s @eval@("vitals","status","loaded")=$g(@eval@("vitals","status","loaded"))+1
 . . . s @eval@("vitals",zi,"status","loadstatus")="loaded"
 . . else  s @eval@("vitals","status","errors")=$g(@eval@("vitals","status","errors"))+1
 ;
 if $get(args("debug"))=1 do  ;
 . m jrslt("source")=@json
 . m jrslt("args")=args
 . m jrslt("eval")=@eval
 m jrslt("vitalsStatus")=@eval@("vitalsStatus")
 set jrslt("result","status")="ok"
 set jrslt("result","loaded")=$g(@eval@("vitals","status","loaded"))
 set jrslt("result","errors")=$g(@eval@("vitals","status","errors"))
 i $g(ien)'="" d  ; called internally
 . ;m result=eval
 . m result("status")=jrslt("result")
 . ;b
 e  d  ;
 . d encode^SYNJSONE("jrslt","result")
 . set HTTPRSP("mime")="application/json"
 q 1
 ;
log(ary,txt) ; adds a text line to @ary@("log")
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
 q
 ;
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
 n root s root=$$setroot^SYNWD("fhir-intake")
 n rt s rt=0
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
 q rt
loinc2sct(loinc) ; extrinsic returns a Snomed code for a Loinc code
 ; for vitals
 ; thanks to Ferdi for the Snomed mapping
 ;
 ; here's what we got so far:
 ;^gpl("vitals","29463-7","Body Weight")=""
 ;^gpl("vitals","39156-5","Body Mass Index")="" ; oops
 ;^gpl("vitals","55284-4","Blood Pressure")=""
 ;^gpl("vitals","8302-2","Body Height")=""
 ;^gpl("vitals","8331-1","Oral temperature")="" ;
 ;
 S SCTA("29463-7",27113001)="9^Body weight"
 S SCTA("8302-2",50373000)="8^Body height"
 S SCTA("55284-4",75367002)="1^Blood pressure"
 S SCTA(78564009)="5^Pulse rate"
 S SCTA("8331-1",386725007)="2^Body Temperature"
 S SCTA(86290005)="3^Respiration"
 S SCTA(48094003)="10^Abdominal girth measurement"
 S SCTA(21727005)="11^Audiometry"
 S SCTA(252465000)="21^Pulse oximetry"
 S SCTA(22253000)="22^Pain"
 ;
 q $o(SCTA(loinc,""))
 ;
testall ; run the vitals import on all imported patients
 new root s root=$$setroot^SYNWD("fhir-intake")
 new indx s indx=$na(@root@("POS","DFN"))
 n dfn,ien,filter,reslt
 s dfn=0
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
 . s ien=$o(@indx@(dfn,""))
 . q:ien=""
 . s filter("dfn")=dfn
 . k reslt
 . d wsIntakeVitals(.filter,,.reslt,ien)
 q
 ;

SYNGBLLD
SYNGBLLD ; HC/ART - HealthConcourse - DHP load data in ^SYN("2002.030" global ;02/04/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
EN ;load all
 ;
 D LOADMH
 D LOADCPT
 D LOADHF
 D LOADVIT
 D LOADPOS
 D LOADFLAG
 ;
 QUIT
 ;
LOADMH ;load ^SYN mapping table for mental health instruments
 N IDX,INSTRUMT,TESTID,TESTNAME,LOINC,SNOMED
 K ^SYN("2002.030","mh2loinc")
 K ^SYN("2002.030","mh2sct")
 ;LOINC
 S IDX=0
 F  S IDX=IDX+1,INSTRUMT=$P($T(MHLOINC+IDX),";;",2) QUIT:INSTRUMT="zzzzz"  D
 . S TESTID=$P(INSTRUMT,U,1)
 . S TESTNAME=$P(INSTRUMT,U,2)
 . S LOINC=$P(INSTRUMT,U,3)
 . S:(TESTID'="")&(LOINC'="") ^SYN("2002.030","mh2loinc","direct",TESTID,LOINC)=""
 . S:(TESTNAME'="")&(LOINC'="") ^SYN("2002.030","mh2loinc","direct",TESTNAME,LOINC)=""
 . S:(TESTID'="")&(LOINC'="") ^SYN("2002.030","mh2loinc","inverse",LOINC,TESTID)=""
 ;SNOMED
 S IDX=0
 F  S IDX=IDX+1,INSTRUMT=$P($T(MHSNOMED+IDX),";;",2) QUIT:INSTRUMT="zzzzz"  D
 . S TESTID=$P(INSTRUMT,U,1)
 . S TESTNAME=$P(INSTRUMT,U,2)
 . S SNOMED=$P(INSTRUMT,U,3)
 . S:(TESTID'="")&(SNOMED'="") ^SYN("2002.030","mh2sct","direct",TESTID,SNOMED)=""
 . S:(TESTNAME'="")&(SNOMED'="") ^SYN("2002.030","mh2sct","direct",TESTNAME,SNOMED)=""
 . S:(TESTID'="")&(SNOMED'="") ^SYN("2002.030","mh2sct","inverse",SNOMED,TESTID)=""
 ;
 QUIT
 ;
LOADCPT ;load ^SYN mapping table for SCT to CPT
 N IDX,LINE,LOINC,SCT,CPT,DESC
 K ^SYN("2002.030","sct2cpt")
 S IDX=0
 F  S IDX=IDX+1,LINE=$P($T(CPT2SCT+IDX),";;",2) QUIT:LINE="zzzzz"  D
 . S CPT=$P(LINE,U,1)
 . S SCT=$P(LINE,U,2)
 . S DESC=$P(LINE,U,3)
 . I CPT'="",SCT'="" D
 . . S ^SYN("2002.030","sct2cpt","direct",SCT,CPT)=DESC
 . . S ^SYN("2002.030","sct2cpt","inverse",CPT,SCT)=DESC
 ;
 QUIT
 ;
LOADHF ;load ^SYN mapping table for SCT to health factors
 N IDX,LINE,SCT,HFIEN,DESC
 K ^SYN("2002.030","sct2hf")
 S IDX=0
 F  S IDX=IDX+1,LINE=$P($T(SCT2HF+IDX),";;",2) QUIT:LINE="zzzzz"  D
 . S SCT=$P(LINE,U,1)
 . S HFIEN=$P(LINE,U,2)
 . S DESC=$P(LINE,U,3)
 . I SCT'="",HFIEN'="" D
 . . S ^SYN("2002.030","sct2hf","direct",SCT,HFIEN)=DESC
 . . S ^SYN("2002.030","sct2hf","inverse",HFIEN,SCT)=DESC
 ;
 QUIT
 ;
LOADVIT ;load ^SYN mapping table for SCT to health factors
 ; VistA Vital Type (file 120.51)
 N IDX,LINE,SCT,VITIEN,DESC
 K ^SYN("2002.030","sct2vit")
 S IDX=0
 F  S IDX=IDX+1,LINE=$P($T(SCT2VIT+IDX),";;",2) QUIT:LINE="zzzzz"  D
 . S SCT=$P(LINE,U,1)
 . S VITIEN=$P(LINE,U,2)
 . S DESC=$P(LINE,U,3)
 . I SCT'="",VITIEN'="" D
 . . S ^SYN("2002.030","sct2vit","direct",SCT,VITIEN)=DESC
 . . S ^SYN("2002.030","sct2vit","inverse",VITIEN,SCT)=DESC
 ;
 QUIT
 ;
LOADPOS ;load ^SYN mapping table for care team positions
 N IDX,POSITION,POSID,POSNAME,SNOMED
 K ^SYN("2002.030","ctpos2sct")
 S IDX=0
 F  S IDX=IDX+1,POSITION=$P($T(POSSCT+IDX),";;",2) QUIT:POSITION="zzzzz"  D
 . S POSID=$P(POSITION,U,1)
 . S POSNAME=$P(POSITION,U,2)
 . S SNOMED=$P(POSITION,U,3)
 . S:(POSID'="")&(SNOMED'="") ^SYN("2002.030","ctpos2sct","direct",POSID,SNOMED)=""
 . S:(POSNAME'="")&(SNOMED'="") ^SYN("2002.030","ctpos2sct","direct",POSNAME,SNOMED)=""
 . S:(POSID'="")&(SNOMED'="") ^SYN("2002.030","ctpos2sct","inverse",SNOMED,POSID)=""
 ;
 QUIT
 ;
LOADFLAG ;load ^SYN mapping table for patient flags
 N IDX,FLAGS,FLAGID,FLAGNAME,SNOMED
 K ^SYN("2002.030","flag2sct")
 S IDX=0
 F  S IDX=IDX+1,FLAGS=$P($T(FLAGSCT+IDX),";;",2) QUIT:FLAGS="zzzzz"  D
 . S FLAGID=$P(FLAGS,U,1)
 . S FLAGNAME=$P(FLAGS,U,3)
 . S SNOMED=$P(FLAGS,U,2)
 . S:(FLAGID'="")&(SNOMED'="") ^SYN("2002.030","flag2sct","direct",FLAGID,SNOMED)=FLAGNAME
 . S:(FLAGID'="")&(SNOMED'="") ^SYN("2002.030","flag2sct","inverse",SNOMED,FLAGID)=FLAGNAME
 ;
 QUIT
 ;
MHLOINC ; id^name^loinc
 ;;5^AUDC^
 ;;11^BDI2^89209-1
 ;;^CESD-R^89205-9
 ;;159^GAD-7^70274-6
 ;;89^GDS^48544-1
 ;;65^MORSE FALL SCALE^59460-6
 ;;56^PC PTSD^71754-6
 ;;71^PHQ-2^55758-7
 ;;42^PHQ9^44249-1
 ;;177^VR-12^72009-4
 ;;^VR-12 T score^72017-7
 ;;^Suicide Risk^89560-7
 ;;^PROMIS-10 score^71970-8
 ;;^PROMIS-10 T score^71969-0
 ;;^PCLC^70221-7
 ;;zzzzz
 ;
MHSNOMED ; id^name^sct^desc
 ;;71^PHQ-2^454711000124102^Depression screening using Patient Health Questionnaire Two-Item score (procedure)
 ;;42^PHQ9^715252007^Depression screening using Patient Health Questionnaire Nine Item score (procedure)
 ;;zzzzz
 ;
CPT2SCT ; cpt^sct^cpt desc
 ;;10060^428297005^Excision of Cyst
 ;;11000^19780006^Debridement of Infection of Skin
 ;;20225^56241004^Bone Marrow Biopsy
 ;;27299^28181007^Operation on hip joint
 ;;44391^73761001^Colonoscopy
 ;;47562^45595009^Laparoscopic cholecystectomy
 ;;49315^80146002^Appendectomy
 ;;55250^22523008^Vasectomy
 ;;64721^10431008^Neuroplasty of median nerve at carpal tunnel
 ;;77056^71388002^Mammogram Both Breasts
 ;;99201^185347001^Office/outpatient visit new
 ;;99202^185349003^Office/outpatient visit new
 ;;99205^308335008^Office/outpatient visit new
 ;;99213^185345009^Office/outpatient visit est
 ;;99238^308646001^Hospital discharge day
 ;;99241^394701000^Office consultation
 ;;99281^50849002^Emergency dept visit
 ;;99285^4525004^Emergency dept visit
 ;;99381^183478001^INIT PM E/M NEW PAT INF
 ;;99383^170258001^PREV VISIT NEW AGE 5-11
 ;;99408^105355005^
 ;;59426^424441002^
 ;;99218^183460006^
 ;;59425^424619006^
 ;;55810^10492003^
 ;;77427^84755001^
 ;;59400^10745001^
 ;;66840^10178000^
 ;;44388^12350003^
 ;;27130^15163009^
 ;;59409^177184002^
 ;;27447^179344006^
 ;;65235^13767004^
 ;;90937^108241001^
 ;;90653^442333005^
 ;;45378^444783004^
 ;;D1206^234723000^
 ;;zzzzz
 ;;10120^^Remove foreign body
 ;;99211^^Office/outpatient visit established
 ;
SCT2HF ; sct^hf ien^desc
 ;;266919005^5^Never smoked tobacco
 ;;405746006^2^Current non-smoker
 ;;8517006^4^Ex-smoker
 ;;266890009^15^Family History of Alcoholism
 ;;219006^12^Current drinker of alcohol
 ;;371434005^13^History of alcohol abuse
 ;;zzzzz
 ;
SCT2VIT ; sct^vital ien^desc  (VistA Vital Type (file 120.51))
 ;;27113001^9^Body weight
 ;;50373000^8^Body height
 ;;75367002^1^Blood pressure
 ;;78564009^5^Pulse rate
 ;;386725007^2^Body Temperature
 ;;86290005^3^Respiration
 ;;48094003^10^Abdominal girth measurement
 ;;21727005^11^Audiometry
 ;;252465000^21^Pulse oximetry
 ;;22253000^22^Pain
 ;;zzzzz
 ;
POSSCT ; id^name^sct
 ;;45^ADDICTION THERAPIST^
 ;;46^ADDICTION THERAPIST (MHTC)^
 ;;13^ADMIN COORDINATOR^106331006
 ;;56^ADMINISTRATIVE ASSOCIATE^224608005
 ;;58^ADVANCE PRACTICE ASSOCIATE PROVIDER^
 ;;71^ADVANCE PRACTICE NURSE^
 ;;72^ADVANCE PRACTICE NURSE (MHTC)^
 ;;57^ANTICOAG CLINICAL PHARMACIST^
 ;;59^ASSOCIATE PROVIDER^
 ;;26^CARE MANAGER^184154008
 ;;28^CASE MANAGER^768832004^nurse case manager 445451001
 ;;43^CHAPLAIN^225725005
 ;;44^CHAPLAIN (MHTC)^225725005
 ;;60^CLINICAL ASSOCIATE^
 ;;22^CLINICAL NURSE SPECIALIST^
 ;;37^CLINICAL NURSE SPECIALIST (MHTC)^
 ;;8^CLINICAL PHARMACIST^734293001
 ;;38^CLINICAL PHARMACIST (MHTC)^734293001
 ;;30^DESIGNATED WOMEN'S HEALTH PROVIDER
 ;;61^FELLOW^
 ;;27^HEALTH TECHNICIAN^
 ;;17^INTERN (PHYSICIAN)^
 ;;73^LEAD COORDINATOR^76882100
 ;;39^LPC^
 ;;40^LPC (MHTC)^
 ;;19^MAS CLERK^
 ;;18^MEDICAL STUDENT^398130009
 ;;41^MFT^
 ;;42^MFT (MHTC)^
 ;;7^NURSE (LPN)^442251000124100
 ;;62^NURSE (LVN)^
 ;;6^NURSE (RN)^224535009
 ;;47^NURSE (RN) (MHTC)^224563006
 ;;4^NURSE PRACTITIONER^224571005
 ;;35^NURSE PRACTITIONER (MHTC)^224571005
 ;;63^NURSE PRACTITIONER ASSOCIATE PROVIDER^
 ;;48^OCCUPATIONAL THERAPIST^80546007
 ;;49^OCCUPATIONAL THERAPIST (MHTC)^80546007
 ;;15^OTHER^
 ;;21^PACT CLINICAL PHARMACIST^734293001
 ;;14^PATIENT SERVICES ASSISTANT^
 ;;64^PEER SUPPORT APPRENTICE^
 ;;65^PEER SUPPORT SPECIALIST^
 ;;74^PEER SUPPORT SPECIALIST (MHTC)^
 ;;55^PEER SUPPORT STAFF^
 ;;5^PHYSICIAN ASSISTANT^449161006
 ;;36^PHYSICIAN ASSISTANT (MHTC)^449161006
 ;;66^PHYSICIAN ASSISTANT ASSOCIATE PROVIDER^
 ;;1^PHYSICIAN-ATTENDING^405279007
 ;;2^PHYSICIAN-PRIMARY CARE^446050000
 ;;10^PHYSICIAN-PSYCHIATRIST^80584001
 ;;34^PHYSICIAN-PSYCHIATRIST (MHTC)^80584001
 ;;3^PHYSICIAN-SUBSPECIALTY^
 ;;67^PRIMARY CARE PROVIDER^453231000124104
 ;;11^PSYCHOLOGIST^59944000
 ;;31^PSYCHOLOGIST (MHTC)^59944000
 ;;53^RECREATION THERAPIST^
 ;;54^RECREATION THERAPIST (MHTC)^
 ;;20^REGISTERED DIETITIAN^309399009
 ;;12^REHAB/PSYCH TECHNICIAN^
 ;;33^REHAB/PSYCH TECHNICIAN (MHTC)^
 ;;16^RESIDENT (PHYSICIAN)^309360001
 ;;9^SOCIAL WORKER^158950001
 ;;32^SOCIAL WORKER (MHTC)^80292009
 ;;68^SURROGATE CARE MANAGER^184154008
 ;;70^SURROGATE CLINICAL ASSOCIATE^
 ;;69^SURROGATE PRIMARY CARE PROVIDER^453231000124104
 ;;25^TCM CLINICAL CASE MANAGER^
 ;;24^TCM PROGRAM MANAGER^
 ;;23^TCM TRANSITION PATIENT ADVOCATE^
 ;;29^TRAINEE^
 ;;50^VOC REHAB SPEC/COUNSELOR^
 ;;51^VOC REHAB SPEC/COUNSELOR (MHTC)^
 ;;zzzzz
 ;
FLAGSCT ;
 ;;FALL RISK^129839007^Fall Risk
 ;;WANDERER^704448006^Wanderer
 ;;BEHAVIORAL^277843001^Behavioral
 ;;HIGH RISK FOR SUICIDE^394685004^High risk for suicide
 ;;zzzzz
 ;
LOADREF(MH2LOINC,LOINC2MH,MH2SNOMED) ;load temp code arrays
 N IDX,INSTRU,LOINCODE,TESTID,TESTNAME,LOINC
 ;LOINC
 S IDX=0
 F  S IDX=IDX+1,INSTRUMT=$P($T(LOINC+IDX),";;",2) Q:INSTRUMT="zzzzz"  D
 . S TESTID=$P(INSTRUMT,U,1)
 . S TESTNAME=$P(INSTRUMT,U,2)
 . S LOINC=$P(INSTRUMT,U,3)
 . S:TESTID'="" MH2LOINC(TESTID)=LOINC
 . S:TESTNAME'="" MH2LOINC(TESTNAME)=LOINC
 . S:LOINC'="" LOINC2MH(LOINC)=TESTID_U_TESTNAME
 ;SNOMED
 S IDX=0
 F  S IDX=IDX+1,INSTRUMT=$P($T(SNOMED+IDX),";;",2) Q:INSTRUMT="zzzzz"  D
 . S TESTID=$P(INSTRUMT,U,1)
 . S TESTNAME=$P(INSTRUMT,U,2)
 . S SNOMED=$P(INSTRUMT,U,3)
 . S:TESTID'="" MH2SNOMED(TESTID)=SNOMED
 . S:TESTNAME'="" MH2SNOMED(TESTNAME)=SNOMED
 ;
 QUIT
 ;
PRCSCT ; CPT to SNOMED CT map for procedures
 K SCTA,SCTX
 S SCTA(308335008)="99205^OFFICE VISIT"
 S SCTA(428297005)="10060^Excision of Cyst"
 S SCTA(22523008)="55250^Vasectomy"
 S SCTA(73761001)="44391^Colonoscopy"
 S SCTA(56241004)="20225^Bone Marrow Biopsy"
 S SCTA(10431008)="64721^Neuroplasty of median nerve at carpal tunnel"
 S SCTA(28181007)="27299^Operation on hip joint"
 S SCTA(80146002)="49315^Appendectomy"
 S SCTA(19780006)="11000^Debridement of Infection of Skin"
 S SCTA(45595009)="47562^Laparoscopic cholecystectomy"
 ; map incoming SNOMED CT code to VistA Vital Type (file 120.51)
 S SCTX("10060")="428297005^Excision of Cyst"
 S SCTX("20225")="56241004^Bone Marrow Biopsy"
 S SCTX("27299")="28181007^Operation on hip joint"
 S SCTX("44391")="73761001^Colonoscopy"
 S SCTX("49315")="80146002^Appendectomy"
 S SCTX("55250")="22523008^Vasectomy"
 S SCTX("64721")="10431008^Neuroplasty of median nerve at carpal tunnel"
 S SCTX("11000")="19780006^Debridement of Infection of Skin"
 S SCTX("47562")="45595009^Laparoscopic cholecystectomy"
 Q
 ;
HLFSCT ; SNOMED CT MAP for health factors
 K SCTA,SCTX
 S SCTA(266919005)="5^Never smoked tobacco"
 S SCTA(405746006)="2^Current non-smoker"
 S SCTA(8517006)="4^Ex-smoker"
 S SCTA(266890009)="15^Family History of Alcoholism"
 S SCTA(219006)="12^Current drinker of alcohol"
 S SCTA(371434005)="13^History of alcohol abuse"
 ; map incoming SNOMED CT code to VistA Vital Type (file 120.51)
 S SCTX("5")="266919005^Never smoked tobacco"
 S SCTX("2")="405746006^Current non-smoker"
 S SCTX("4")="8517006^Ex-smoker"
 S SCTX("15")="266890009^Family History of Alcoholism"
 S SCTX("13")="371434005^History of Alcoholism"
 S SCTX("12")="219009^Current drinker of alcohol"
 Q
 ;

SYNGRAF
SYNGRAF        ;ven/gpl - mash graph utilities ; 9/24/17 4:33pm
 ;;1.0;norelease;;feb 27, 2017;Build 10
 ;
 ;
 q
 ;
 ; All the public entry points for these routines are found in SYNWD
 ;
setroot(graph) ; root of working storage
 new %y set %y=$order(^SYNGRAPH(2002.801,"B",graph,""))
 if %y="" set %y=$$addgraph(graph) ; if graph is not present, add it
 quit $name(^SYNGRAPH(2002.801,%y)) ; root for graph
 ;
rootOf(graph) ; return the root of graph named graph
 new %x1 set %x1=$order(^SYNGRAPH(2002.801,"B",graph,""))
 if %x1="" quit -1
 quit $name(^SYNGRAPH(2002.801,%x1,"graph"))
 ;
addgraph(graph) ; makes a place in the graph file for a new graph
 n fien s fien=$o(^SYNGRAPH(2002.801,"B",graph,""))
 i fien'="" q fien
 ;s fien=$o(^XTMP("SYNGRAPH"," "),-1)+1
 ;s ^XTMP("SYNGRAPH",fien,0)=graph
 ;s ^XTMP("SYNGRAPH","B",graph,fien)=""
 ;q fien
 ;
 ;new fda set fda(17.040801,"?+1,",.01)=graph
 new fda set fda(2002.801,"?+1,",.01)=graph
 new %yerr
 do UPDATE^DIE("","fda","","%yerr")
 new %y set %y=$order(^SYNGRAPH(2002.801,"B",graph,""))
 quit %y
 ;
purgegraph(graph) ; delete a graph
 new %y set %y=$order(^SYNGRAPH(2002.801,"B",graph,""))
 if %y="" quit 0
 ;k ^XTMP("SYNGRAPH",%y)
 ;k ^XTMP("SYNGRAPH","B",graph,%y)
 ;q
 ;
 new fda set fda(2002.801,%y_",",.01)="@"
 new %yerr
 do UPDATE^DIE("","fda","","%yerr")
 if '$data(%yerr) quit 1
 zwr %yerr
 quit 0 
 ;
insert2graph(ary,graph,replace) ; insert a new entry to a graph
 ; ary is passed by name, graph is the name of the graph
 ; if replace=1 the graph will be killed first before merge
 new root set root=$$setroot(graph)
 new groot set groot=$name(@root@("graph"))
 new id set id=$order(@ary@(""))
 if replace=1 kill @groot@(id) 
 merge @groot=@ary
 quit
 ;
nameThis(altname) ; returns the id to be used for altname
 ; this will eventually use the context graph and the 
 ; local variable context to query the altname and obtain an id
 new result
 if $data(context) set result=$$queryContext(context,"id",altname) q result
 if altname="background-dd-map" set result="sbform" quit result
 quit altname
 ;
getThis(rary,fn,nocache) ; find a file and read it into rary array  
 new ary
 if '$g(nocache) do fromCache("ary",fn)
 if $d(ary) do  quit  ;
 . merge @rary=ary
 do queryTag("ary",fn)
 if '$d(ary) do  quit  ;
 . write !,"error retrieving array ",fn
 new file set file=$order(ary(1,"file",""))
 new dir set dir=$order(ary(1,"localdir",""))_"/"
 new tmp set tmp=$name(^TMP("yottawrk",$J))
 kill @tmp
 new tmp1 set tmp1=$name(@tmp@(1))
 new ok set ok=$$FTG^%ZISH(dir,file,tmp1,3)
 if 'ok do  quit  ;
 . write !,"error loading file ",dir_file
 if '$g(nocache) do toCache(tmp,fn,"html-cache")
 merge @rary=@tmp
 kill @tmp
 quit
 ;
queryContext(context,pred,obj) ; look up project specific 
 ; names and values from the context graph
 ; tbd
 quit obj
 ;
queryTag(rtn,tag) ; returns a json/mumps array of tagged items
 new graph set graph="seeGraph"
 kill @rtn
 new root set root=$$setroot(graph)
 new groot set groot=$na(@root@("graph"))
 if '$d(@groot@("pos","tag",tag)) quit
 new x1,y1 set (x1,y1)=""
 new cnt set cnt=0
 for  set x1=$order(@groot@("pos","tag",tag,x1)) quit:x1=""  do  ;
 . for  set y1=$order(@groot@("pos","tag",tag,x1,y1)) quit:y1=""  do  ;
 . . set cnt=cnt+1
 . . merge @rtn@(cnt)=@groot@(x1,y1)
 quit
 ;
fromCache(rary,name,graph) ; return a file from the cache
 if '$d(graph) set graph="html-cache"
 new zgn set zgn=$$setroot(graph)
 quit:'$data(@zgn@("graph","B",name))
 new zien set zien=$order(@zgn@("graph","B",name,""))
 quit:zien=""
 merge @rary=@zgn@("graph",zien)
 quit
 ;
toCache(arry,name,graph) ; put a file in the cache
 if '$d(graph) set graph="html-cache"
 new zgn set zgn=$$setroot(graph)
 new zien
 if $data(@zgn@("graph","B",name)) do  ;
 . set zien=$order(@zgn@("graph","B",name,""))
 . kill @zgn@("graph",zien)
 . kill @zgn@("graph","B",name,zien)
 if $get(zien)="" do  ;
 . set zien=$order(@zgn@("graph"," "),-1)+1
 merge @zgn@("graph",zien)=@arry
 set @zgn@("graph","B",name,zien)=""
 quit
 ;
beautify(inary,outary) ; pretty print a line of json
 new zg,zi set (zg,zi)=""
 for  set zi=$order(@inary@(zi)) quit:zi=""  set zg=zg_@inary@(zi)
 do ary2file("zg",^%WHOME,"json.json")
 zsy "python -m json.tool "_^%WHOME_"json.json > "_^%WHOME_"pretty-json.json"
 do file2ary(outary,^%WHOME,"pretty-json.json")
 q
 ;
ary2file(ary,dir,file) ;
 new tmp set tmp=$name(^TMP("yottawrk",$J))
 kill @tmp
 if '$data(@ary@(1)) do  ; not really an array
 . if $get(@ary)="" quit ; not a string either
 . merge @tmp@(1)=@ary ; input was a string
 else   merge @tmp=@ary
 new tmp1 set tmp1=$name(@tmp@(1))
 new ok set ok=$$GTF^%ZISH(tmp1,3,dir,file)
 if 'ok do  quit  ;
 . write !,"error saving file ",dir_file
 quit
 ;
file2ary(ary,dir,file)
 new tmp set tmp=$name(^TMP("yottawrk",$J))
 kill @tmp
 new tmp1 set tmp1=$name(@tmp@(1))
 new ok set ok=$$FTG^%ZISH(dir,file,tmp1,3)
 if 'ok do  quit  ;
 . write !,"error loading file ",dir_file
 merge @ary=@tmp
 kill @tmp
 quit
 ;

SYNGRAPH
SYNFGRAPH       ;ven/gpl - fhir loader utilities ;2018-08-17  3:26 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
index(graph) ; will create a pos and ops index at the place pointed to by graph
 ; graph is passed by name
 ;
 i $d(@graph@("pos")) k @graph@("pos")
 i $d(@graph@("ops")) k @graph@("ops")
 n zi s zi=0
 f  s zi=$o(@graph@(zi)) q:+zi=0  d  ;
 . n zj,zv
 . s zj=""
 . f  s zj=$o(@graph@(zi,zj)) q:zj=""  d  ;
 . . s zv=$g(@graph@(zi,zj))
 . . q:zv=""
 . . s @graph@("pos",zj,zv,zi)=""
 . . s @graph@("ops",zv,zj,zi)=""
 q
 ;
graphmap(graph,code,otype,itype) ; extrinsic mapping function using a graph
 ; graph is a pointer to the graph passed by name
 ; code is the subject to map
 ; otype is the predicate for the result
 ; itype is the predicate for the subject (optional)
 ;
 ;i '$d(@graph@("pos")) d  ;
 i $e(graph,1,1)'="^" d  ;
 . n root s root=$$setroot^SYNWD(graph)
 . s graph=$g(@root@("index","root"))
 i $g(graph)="" q "-1^Error, can't find graph"
 i '$d(@graph@("pos")) q "-1^Error, can't find index"
 i $g(code)="" q "-1^Error, code not provided"
 n gien,ipred,opred
 s ipred=$g(itype)
 i ipred="" s ipred=$o(@graph@("ops",code,""))
 ;w !,"ipred= "_ipred
 i ipred="" q "-1^Code not found"
 s gien=$o(@graph@("ops",code,ipred,""))
 ;w !,"gien= "_gien,!
 ;zwrite @graph@(gien,*)
 ;w !,graph
 s opred=$g(otype)
 i opred="" s opred=$o(@graph@(gien,ipred))
 i opred="" s opred=$o(@graph@(gien,ipred),-1)
 ;w !,"opred= "_opred
 q $g(@graph@(gien,opred))
 ;
 s gien=$o(@graph@("ops"))
 n ugraph s ugraph=""
 i '$d(@graph@("pos")) d  ; fix the pointer
 . i $d(@graph@("graph","pos")) s ugraph=$na(@graph@("graph"))
 . n graphname s graphname=$o(@graph@("graph",""))
 . i graphname="" s ugraph="" q  ; don't understand this graph
 . i $d(@graph@("graph",graphname,"pos")) s ugraph=$na(@graph@("graph",graphname))
 q
 ;
getGraphMap(rtn,graph,ipred,iobj,opred,oobj) ; retrieve a section of the graph
 ; extrinsic return 1 on success and -1 on failure
 ; identified by predicate ipred with object iobj
 ; if opred (output predicate) and/or oobj (output object) are specified,
 ;  they are treated and a "and" condition on the retrieval
 ;
 n root s root=$$setroot^SYNWD(graph)
 n groot s groot=$g(@root@("index","root"))
 i groot="" q "-1^can't find graph root"
 i '$d(@groot@("pos")) q "-1^can't find graph index"
 k @rtn
 ;
 n gien
 i $g(iobj)'="" i $o(@groot@("ops",iobj,""))'="" d  ;
 . i $g(ipred)'="" d  q  ;
 . . s gien=$o(@groot@("pos",ipred,iobj,""))
 . . m @rtn=@groot@(gien)
 . n tpred
 . s tpred=$o(@groot@("ops",iobj,""))
 . s gien=$o(@groot@("pos",tpred,iobj,""))
 . m @rtn=@groot@(gien)
 i $d(@rtn) q 1
 q "-1^No Match"
 ;
getGraph(url,gname) ; get a graph from a web service
 ;
 q:'$d(gname)
 i $$rootOf^SYNWD(gname)'=-1 d  q  ;
 . w !,"error, graph exists: "_gname
 n root s root=$$setroot^SYNWD(gname)
 n %,json,grf
 s %=$$%^%WC(.json,"GET",url)
 w !,"result= ",%
 i '$d(json) d  q  ;
 . w !,"error, nothing returned"
 d decode^SYNJSONE("json","grf")
 m @root=grf
 n indx,rindx
 s indx=$o(@root@(0))
 s rindx=$na(@root@(indx))
 s @root@("index","root")=rindx
 d index(rindx)
 q
 ;
wsGetGraph(RTN,FILTER) ; web service returns the requested graph FILTER("graph")="graph"
 ; this is the server side of getGraph above
 n graph s graph=$g(FILTER("graph"))
 i graph="" d  q  ;
 . s RTN="-1^please specify a graph"
 ;n root s root=$$rootOf^SYNWD(graph)
 n root s root=$$setroot^SYNWD(graph)
 i +root=-1 d  q  ;
 . s RTN="-1^graph not found"
 ;
 ;n json
 ;s json=$$setroot^SYNWD(graph_"-json")
 ;i +json'=-1 s RTN=json q  ;
 ;s json=$$setroot^SYNWD(graph_"-json")
 S RTN=$na(^TMP("SYNOUT",$J))
 K @RTN
 d encode^SYNJSONE(root,RTN)
 q
 ;
loincMap() ; create the lonic-lab-map
 n root s root=$$setroot^SYNWD("loinc-lab-map")
 k @root
 n src s src=$$rootOf^SYNWD("loinc-code-map")
 s src=$na(@src@("loinc-codes-map-1.csv"))
 n zi s zi=0
 f  s zi=$o(@src@(zi)) q:+zi=0  d  ;
 . n zj s zj=""
 . f  s zj=$o(@src@(zi,zj)) q:zj=""  d  ;
 . . n zt s zt=$$TRIM^XLFSTR(@src@(zi,zj))
 . . q:zt=""
 . . s @root@("graph","map",zi,zj)=zt
 s rindx=$na(@root@("graph","map"))
 s @root@("index","root")=rindx
 d index(rindx)
 q
 ;
covid(loinc) ; extrinsic returns the name of the lab test  in ^LAB(60, 
 ; for the loinc code
 n rt,rien,LAB
 s LAB(5091)="COVID-19 (PHRL)"
 s LAB(5092)="COVID-19 CONFIRMATORY"
 s LAB("94531-1",5093)="COVID-19 PANEL"
 s LAB("92130-4",5096)="RHINOVIRUS RNA RESP"
 s LAB("92131-2",5097)="RESPSYNVIRUS RNA"
 s LAB("92134-6",5098)="METAPNEUMOVIRUS RNA"
 s LAB("92138-7",5099)="PARAINFLUENZA VIRUS 3 RNA"
 s LAB("92139-5",5100)="PARAINFLUENZA VIRUS 2 RNA"
 s LAB("92140-3",5101)="PARAINFLUENZA VIRUS 1 RNA"
 s LAB("92141-1",5103)="INFLUENZA B RNA"
 s LAB("80383-3",5103)="INFLUENZA B RNA"
 s LAB("92142-9",5104)="INFLUENZA A RNA"
 s LAB("80382-5",5104)="INFLUENZA A RNA"
 s LAB("94040-3",5105)="ADENOVIRUS A+B+C+D+E DNA"
 s rien=$o(LAB(loinc,""))
 s rt=$g(LAB(loinc,rien))
 i rt="" s rt=-1
 q rt
 ;

SYNINIT
SYNINIT ;OSEHRA/SMH - Initilization Code for Synthetic Data Loader;May 23 2018 ;Aug 15, 2019@16:15:31
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; (c) Sam Habiel 2018-2019
 ; Licensed under Apache 2.0.
 ;
EN ; [Public; called by KIDS; do everything in this file]
 ;D LOADHAND
 D MES^XPDUTL("")
 D MES^XPDUTL("Syn Patients Importer Init")
 D MES^XPDUTL("Provider "_$$PROV(1))
 D MES^XPDUTL("Pharmacist "_$$PHARM(1))
 D MES^XPDUTL("Hospital Location "_$$HL())
 D MES^XPDUTL("Fixing AMIE thingy") D AMIE
 D MES^XPDUTL("Fixing IB ACTION TYPE file") D IBACTION
 D MES^XPDUTL("Setting up Outpatient Pharmacy "_$$PHRSS())
 D MES^XPDUTL("Disabling Allergy Bulletins") D ALBUL
 QUIT
 ;
 ;
PROV(rePopulate) ;[Public $$] Create Generic Provider for Synthetic Patients
 ; ASSUMPTION: DUZ MUST HAVE XUMGR OTHERWISE FILEMAN WILL BLOCK YOU!
 N NAME S NAME="PROVIDER,UNKNOWN SYNTHEA" ; Constant
 n C0XIEN s C0XIEN=$O(^VA(200,"B",NAME,0))
 if C0XIEN,'$get(rePopulate) quit C0XIEN
 if C0XIEN,$get(rePopulate) do
 . new DA,DIK
 . set DA=C0XIEN
 . set DIK="^VA(200,"
 . do ^DIK
 . kill C0XIEN
 . set C0XIEN(1)=DA
 ;
 N C0XFDA,C0XERR,DIERR
 S C0XFDA(200,"?+1,",.01)=NAME
 S C0XFDA(200,"?+1,",1)="USP" ; Initials
 S C0XFDA(200,"?+1,",28)=100 ; Mail Code
 S C0XFDA(200,"?+1,",53.1)=1 ; Authorized to write meds
 S C0XFDA(200.05,"?+2,?+1,",.01)="`144" ; Person Class - Allopathic docs.
 S C0XFDA(200.05,"?+2,?+1,",2)=2000101 ; Date active
 ;
 ; Security keys
 S C0XFDA(200.051,"?+3,?+1,",.01)="PROVIDER"
 S C0XFDA(200.051,"?+4,?+1,",.01)="ORES"
 S C0XFDA(200.051,"?+10,?+1,",.01)="LRLAB"
 S C0XFDA(200.051,"?+11,?+1,",.01)="LRVERIFY"
 ;
 ; Access and Verify Codes so we can log in as the provider if we want to
 ; We must pre-hash them as that's not in the IT
 S C0XFDA(200,"?+1,",2)=$$EN^XUSHSH("SYNPROV123") ; ac
 S C0XFDA(200,"?+1,",11)=$$EN^XUSHSH("SYNPROV123!!") ; vc
 S C0XFDA(200,"?+1,",7.2)=1 ; verify code never expires
 ;
 ; Electronic Signature
 ; Input transform hashes this guy
 S C0XFDA(200,"?+1,",20.4)="123456"
 ;
 ; Primary Menu
 S C0XFDA(200,"?+1,",201)="`"_$$FIND1^DIC(19,,"QX","XUCORE","B")
 ;
 ; Secondary Menu (CPRS, etc)
 S C0XFDA(200.03,"?+5,?+1,",.01)="`"_$$FIND1^DIC(19,,"QX","OR CPRS GUI CHART","B")
 ;
 ; Restrict Patient Selection
 S C0XFDA(200,"?+1,",101.01)="NO"
 ;
 ; CPRS Tabs
 S C0XFDA(200.010113,"?+6,?+1,",.01)="COR"
 S C0XFDA(200.010113,"?+6,?+1,",.02)="T-1"
 ;
 ; Service/Section
 S C0XFDA(200,"?+1,",29)="`"_$$MEDSS()
 ;
 ; NPI - Ferdi made this one up.
 S C0XFDA(200,"?+1,",41.99)="9990000348"
 ;
 N DIC S DIC(0)="" ; An XREF in File 200 requires this.
 D UPDATE^DIE("E",$NA(C0XFDA),$NA(C0XIEN),$NA(C0XERR)) ; Typical UPDATE
 I $D(DIERR) S $EC=",U1,"
 ;
 ; Fix verify code change date to the far future
 N FDA
 S FDA(200,C0XIEN(1)_",",11.2)=$$FMTH^XLFDT($$FMADD^XLFDT(DT,3000))
 ;
 ; Signature block. Do this as internal values to prevent name check in 20.2.
 S FDA(200,C0XIEN(1)_",",20.2)="SYNTHETIC PROVIDER, MD"
 S FDA(200,C0XIEN(1)_",",20.3)="Staff Physician"
 ;
 D FILE^DIE(,$NA(FDA))
 I $D(DIERR) S $EC=",U1,"
 ;
 Q C0XIEN(1) ;Provider IEN
 ;
PHARM(rePopulate) ;[Public $$] Create Generic Provider for Synthetic Patients
 ; ASSUMPTION: DUZ MUST HAVE XUMGR OTHERWISE FILEMAN WILL BLOCK YOU!
 N NAME S NAME="PHARMACIST,UNKNOWN SYNTHEA" ; Constant
 n C0XIEN s C0XIEN=$O(^VA(200,"B",NAME,0))
 if C0XIEN,'$get(rePopulate) quit C0XIEN
 if C0XIEN,$get(rePopulate) do
 . new DA,DIK
 . set DA=C0XIEN
 . set DIK="^VA(200,"
 . do ^DIK
 . kill C0XIEN
 . set C0XIEN(1)=DA
 ;
 N C0XFDA,C0XERR,DIERR
 S C0XFDA(200,"?+1,",.01)=NAME
 S C0XFDA(200,"?+1,",1)="UST" ; Initials
 S C0XFDA(200,"?+1,",28)=111 ; Mail Code
 S C0XFDA(200.05,"?+2,?+1,",.01)="`246" ; Person Class - Pharmacist
 S C0XFDA(200.05,"?+2,?+1,",2)=2000101 ; Date active
 ;
 ; Security keys
 S C0XFDA(200.051,"?+3,?+1,",.01)="PSORPH"
 S C0XFDA(200.051,"?+4,?+1,",.01)="ORELSE"
 ;
 ; Access and Verify Codes so we can log in as the provider if we want to
 ; We must pre-hash them as that's not in the IT
 S C0XFDA(200,"?+1,",2)=$$EN^XUSHSH("SYNPHARM123") ; ac
 S C0XFDA(200,"?+1,",11)=$$EN^XUSHSH("SYNPHARM123!!") ; vc
 S C0XFDA(200,"?+1,",7.2)=1 ; verify code never expires
 ;
 ; Electronic Signature
 ; Input transform hashes this guy
 S C0XFDA(200,"?+1,",20.4)="123456"
 ;
 ; Primary Menu
 S C0XFDA(200,"?+1,",201)="`"_$$FIND1^DIC(19,,"QX","XUCORE","B")
 ;
 ; Secondary Menu (CPRS, etc)
 S C0XFDA(200.03,"?+5,?+1,",.01)="`"_$$FIND1^DIC(19,,"QX","OR CPRS GUI CHART","B")
 ;
 ; Restrict Patient Selection
 S C0XFDA(200,"?+1,",101.01)="NO"
 ;
 ; CPRS Tabs
 S C0XFDA(200.010113,"?+6,?+1,",.01)="COR"
 S C0XFDA(200.010113,"?+6,?+1,",.02)="T-1"
 ;
 ; Service/Section
 S C0XFDA(200,"?+1,",29)="`"_$$PHRSS()
 ;
 N DIC S DIC(0)="" ; An XREF in File 200 requires this.
 D UPDATE^DIE("E",$NA(C0XFDA),$NA(C0XIEN),$NA(C0XERR)) ; Typical UPDATE
 I $D(DIERR) S $EC=",U1,"
 ;
 ; Fix verify code change date to the far future
 N FDA
 S FDA(200,C0XIEN(1)_",",11.2)=$$FMTH^XLFDT($$FMADD^XLFDT(DT,3000))
 ;
 ; Signature block. Do this as internal values to prevent name check in 20.2.
 S FDA(200,C0XIEN(1)_",",20.2)="SYNTHETIC PHARMACIST, RPH"
 S FDA(200,C0XIEN(1)_",",20.3)="Staff Pharmacist"
 ;
 D FILE^DIE(,$NA(FDA))
 I $D(DIERR) S $EC=",U1,"
 ;
 Q C0XIEN(1) ;Provider IEN
 ;
MEDSS() ; [Public $$] Create Medical Service/Section
 N NAME S NAME="MEDICINE"
 Q:$O(^DIC(49,"B",NAME,0)) $O(^(0))
 ;
 N FDA,IEN,DIERR
 S FDA(49,"?+1,",.01)=NAME
 S FDA(49,"?+1,",1)="MED"
 S FDA(49,"?+1,",1.5)="MED"
 S FDA(49,"?+1,",1.7)="PATIENT CARE"
 D UPDATE^DIE("E",$NA(FDA),$NA(IEN))
 I $D(DIERR) S $EC=",U1,"
 QUIT IEN(1)
 ;
PHRSS() ; [Public $$] Create Pharmacy Service/Section
 N NAME S NAME="PHARMACY"
 Q:$O(^DIC(49,"B",NAME,0)) $O(^(0))
 ;
 N FDA,IEN,DIERR
 S FDA(49,"?+1,",.01)=NAME
 S FDA(49,"?+1,",1)="PHR"
 S FDA(49,"?+1,",1.5)="PHR"
 S FDA(49,"?+1,",1.6)="`"_$$MEDSS()
 S FDA(49,"?+1,",1.7)="PATIENT CARE"
 D UPDATE^DIE("E",$NA(FDA),$NA(IEN))
 I $D(DIERR) S $EC=",U1,"
 QUIT IEN(1)
 ;
IBACTION ; [Public] Fix IB ACTION TYPE file (350.1) PSO entries to point to PHARMACY service/section
 ; Required in order to be able to set-up pharmacy site parameters
 ;
 N FDA,IEN
 ;
 ; Get Pharmacy SS entry
 N PHRSS S PHRSS=$$PHRSS()
 ;
 ; Get PSO entries
 D FIND^DIC(350.1,,"@","PQE","PSO","*","B")
 ;
 ; Create FDA and file
 N SYNI F SYNI=0:0 S SYNI=$O(^TMP("DILIST",$J,SYNI)) Q:'SYNI  S IEN=^(SYNI,0) S FDA(350.1,IEN_",",.04)=PHRSS
 D FILE^DIE("",$NA(FDA))
 ;
 QUIT
 ;
HL() ; [Public $$] Generic Hospital Location Entry
 N NAME S NAME="GENERAL MEDICINE" ; Constant
 Q:$O(^SC("B",NAME,0)) $O(^(0)) ; Quit if the entry exists with the entry
 ;
 N C0XFDA,C0XIEN,C0XERR,DIERR
 S C0XFDA(44,"?+1,",.01)=NAME
 S C0XFDA(44,"?+1,",2)="C" ; Type - Clinic
 S C0XFDA(44,"?+1,",2.1)=1 ; Type Extension - Clinic
 S C0XFDA(44,"?+1,",3)=+$$SITE^VASITE() ; Institution - Default institution
 S C0XFDA(44,"?+1,",8)=295 ; STOP CODE NUMBER - Primary Care
 S C0XFDA(44,"?+1,",9)="M" ; SERVICE
 S C0XFDA(44,"?+1,",2502)="N" ; NON-COUNT CLINIC
 D UPDATE^DIE("",$NA(C0XFDA),$NA(C0XIEN),$NA(C0XERR))
 I $D(DIERR) S $EC=",U1,"
 Q C0XIEN(1) ; HL IEN
 ;
AMIE ; [Public] Fix "AMIE LINK OUT OF ORDER" message
 N IEN S IEN=$$FIND1^DIC(101,,"QX","DVBA C&P SCHD EVENT","B")
 Q:'IEN
 N FDA,DIERR
 S FDA(101,IEN_",",2)="@" ; DISABLE field
 D FILE^DIE("",$NA(FDA))
 I $D(DIERR) S $EC=",U1,"
 QUIT
 ;
PSOSITE() ; [Public $$] Add a default pharmacy site
 N NAME S NAME="SYNTHETIC PATIENTS"
 I $O(^PS(59,"B",NAME,0)) Q $O(^(0))
 ;
 N SITENUMBER
 N SITEIEN
 N % S %=$$SITE^VASITE()
 S SITEIEN=$P(%,U)
 S SITENUMBER=$P(%,U,3)
 ;
 N FDA,DIERR,IEN
 S FDA(59,"?+1,",.01)=NAME
 S FDA(59,"?+1,",.02)="1934 OLD GALLOWS ROAD" ; MAILING FRANK STREET ADDRESS
 S FDA(59,"?+1,",.03)=571 ; AREA CODE
 S FDA(59,"?+1,",.04)="999-9999" ; PHONE NUMBER
 S FDA(59,"?+1,",.05)=22182 ; Zip code
 S FDA(59,"?+1,",.06)=SITENUMBER ; Site Number
 S FDA(59,"?+1,",.07)="VIENNA" ; CITY
 S FDA(59,"?+1,",.17)=1 ; SHALL COMPUTER ASSIGN RX #S
 S FDA(59,"?+1,",4)=1   ; NEW LABEL STOCK
 S FDA(59,"?+1,",100)="`"_SITEIEN ; RELATED INSTITUTION
 S FDA(59,"?+1,",101)="`"_SITEIEN ; NPI INSTITUTION
 S FDA(59,"?+1,",1000)=0 ; NARCOTICS NUMBERED DIFFERENTLY
 S FDA(59,"?+1,",1001)=1 ; NARCOTIC LOWER BOUND
 S FDA(59,"?+1,",1002)=1 ; NARCOTIC UPPER BOUND
 S FDA(59,"?+1,",1003)="`"_$$PHRSS() ; IB SERVICE/SECTION
 S FDA(59,"?+1,",2001)=100000000 ; PRESCRIPTION # LOWER BOUND
 S FDA(59,"?+1,",2002)=999999999 ; PRESCRIPTION # UPPER BOUND
 S FDA(59.08,"?+2,?+1,",.01)="`"_SITEIEN ; CPRS ORDERING INSTITUTION
 D UPDATE^DIE("E",$NA(FDA),$NA(IEN))
 I $D(DIERR) S $EC=",U1,"
 Q IEN(1)
 ;
ALBUL ; [Public] Disable Allergy Bulletin
 N FDA,DIERR
 S FDA(120.84,"1,",7.1)=2
 D FILE^DIE("","FDA")
 I $D(DIERR) S $EC=",U1,"
 QUIT
 ;
TEST D EN^%ut($T(+0),3) QUIT
 ;
TESTPROV ; @TEST Test adding a provider
 N NAME S NAME="PROVIDER,UNKNOWN SYNTHEA" ; Constant
 N PROV S PROV=$$FIND1^DIC(200,,"QX",NAME,"B")
 I PROV N DA,DIK S DA=PROV,DIK="^VA(200," D ^DIK
 S PROV=$$PROV()
 D CHKTF^%ut(PROV>0)
 N OLDPROV S OLDPROV=PROV
 S PROV=$$PROV(1)
 D CHKTF^%ut(OLDPROV=PROV)
 QUIT
 ;
TESTPHARM ; @TEST Test adding a pharmacist
 N NAME S NAME="PHARMACIST,UNKNOWN SYNTHEA" ; Constant
 N PHARM S PHARM=$$FIND1^DIC(200,,"QX",NAME,"B")
 I PHARM N DA,DIK S DA=PHARM,DIK="^VA(200," D ^DIK
 S PHARM=$$PHARM()
 N OLDPHARM S OLDPHARM=PHARM
 S PHARM=$$PHARM(1)
 D CHKTF^%ut(OLDPHARM=PHARM)
 QUIT
 ;
TESTHL ; @TEST Test adding a clinic
 N NAME S NAME="GENERAL MEDICINE" ; Constant
 N HL S HL=$$FIND1^DIC(44,,"QX",NAME,"B")
 I HL N DA,DIK S DA=HL,DIK="^SC(" D ^DIK
 S HL=$$HL()
 D CHKTF^%ut(HL>0)
 QUIT
 ;
TESTLH ; @Test Load Handlers
 D DELHAND
 D LOADHAND
 ;
 N IEN
 S IEN=$O(^%web(17.6001,"B","POST","addpatient","wsPostFHIR^SYNFHIR",""))
 D CHKTF^%ut(IEN)
 K IEN
 S IEN=$O(^%web(17.6001,"B","GET","showfhir","wsShow^SYNFHIR",""))
 D CHKTF^%ut(IEN)
 K IEN
 S IEN=$O(^%web(17.6001,"B","GET","vpr/{dfn}","wsVPR^SYNVPR",""))
 D CHKTF^%ut(IEN)
 K IEN
 S IEN=$O(^%web(17.6001,"B","GET","global/{root}","wsGLOBAL^SYNVPR",""))
 D CHKTF^%ut(IEN)
 QUIT
 ;
TESTAMIE ; @TEST AMIE
 N IEN S IEN=$$FIND1^DIC(101,,"QX","DVBA C&P SCHD EVENT","B")
 N FDA
 S FDA(101,IEN_",",2)="AMIE LINK OUT OF ORDER" ; DISABLE field
 D FILE^DIE("",$NA(FDA))
 D AMIE
 D CHKTF^%ut($P(^ORD(101,IEN,0),U,3)="")
 QUIT
 ;
TESTIBACT ; @TEST IB Action Fix
 D IBACTION
 N PHRSS S PHRSS=$$PHRSS()
 ;
 ; We confirm through the index that we have six entries pointing to pharmacy
 N CNT S CNT=0
 N I F I=0:0 S I=$O(^IBE(350.1,"C",PHRSS,I)) Q:'I  S CNT=CNT+1
 D CHKTF^%ut(CNT=6)
 QUIT
 ;
TESTPSOSITE ; @TEST Adding Outpatient Site
 N DA,DIK S DA=1,DIK="^PS(59," D ^DIK
 N % S %=$$PSOSITE()
 D CHKTF^%ut(%=1)
 QUIT
 ;

SYNJSON
SYNJSON ;SLC/KCM -- Decode/Encode JSON;Feb 07, 2019@10:51 ; 6/28/19 3:26pm
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Note:  Since the routines use closed array references, VVROOT and VVERR
 ;        are used to reduce risk of naming conflicts on the closed array.
 ;
decode(VVJSON,VVROOT,VVERR) G DIRECT^SYNJSOND
DECODE(VVJSON,VVROOT,VVERR)  ; Set JSON object into closed array ref VVROOT
 ; Examples: D DECODE^VPRJSON("MYJSON","LOCALVAR","LOCALERR")
 ;           D DECODE^VPRJSON("^MYJSON(1)","^GLO(99)","^TMP($J)")
 ;
 ; VVJSON: string/array containing serialized JSON object
 ; VVROOT: closed array reference for M representation of object
 ;  VVERR: contains error messages, defaults to ^TMP("VPRJERR",$J)
 ;
 ;   VVIDX: points to next character in JSON string to process
 ; VVSTACK: manages stack of subscripts
 ;  VVPROP: true if next string is property name, otherwise treat as value
 ;
 G DIRECT^SYNJSOND
 ;
encode(VVROOT,VVJSON,VVERR) G DIRECT^SYNJSONE
ENCODE(VVROOT,VVJSON,VVERR) ; VVROOT (M structure) --> VVJSON (array of strings)
 ; Examples:  D ENCODE^VPRJSON("^GLO(99,2)","^TMP($J)")
 ;            D ENCODE^VPRJSON("LOCALVAR","MYJSON","LOCALERR")
 ;
 ; VVROOT: closed array reference for M representation of object
 ; VVJSON: destination variable for the string array formatted as JSON
 ;  VVERR: contains error messages, defaults to ^TMP("VPRJERR",$J)
 ;
 G DIRECT^SYNJSONE
 ;
 ;
esc(x) Q $$ESC^SYNJSONE(X)
ESC(X) ; Escape string for JSON
 Q $$ESC^SYNJSONE(X)
 ;
ues(x) Q $$UES^SYNJSOND(X)
UES(X) ; Unescape JSON string
 Q $$UES^SYNJSOND(X)
 ;
ERRX(ID,VAL) ; Set the appropriate error message
 ; switch (ID) -- XERRX ends statement
 N ERRMSG
 ;
 ; Decode Error Messages
 ;
 I ID="STL{" S ERRMSG="Stack too large for new object." G XERRX
 I ID="SUF}" S ERRMSG="Stack Underflow - extra } found" G XERRX
 I ID="STL[" S ERRMSG="Stack too large for new array." G XERRX
 I ID="SUF]" S ERRMSG="Stack Underflow - extra ] found." G XERRX
 I ID="OBM" S ERRMSG="Array mismatch - expected ] got }." G XERRX
 I ID="ARM" S ERRMSG="Object mismatch - expected } got ]." G XERRX
 I ID="MPN" S ERRMSG="Missing property name." G XERRX
 I ID="EXT" S ERRMSG="Expected true, got "_VAL G XERRX
 I ID="EXF" S ERRMSG="Expected false, got "_VAL G XERRX
 I ID="EXN" S ERRMSG="Expected null, got "_VAL G XERRX
 I ID="TKN" S ERRMSG="Unable to identify type of token, value was "_VAL G XERRX
 I ID="SCT" S ERRMSG="Stack mismatch - exit stack level was  "_VAL G XERRX
 I ID="EIQ" S ERRMSG="Close quote not found before end of input." G XERRX
 I ID="EIU" S ERRMSG="Unexpected end of input while unescaping." G XERRX
 I ID="RSB" S ERRMSG="Reverse search for \ past beginning of input." G XERRX
 I ID="ORN" S ERRMSG="Overrun while scanning name." G XERRX
 I ID="OR#" S ERRMSG="Overrun while scanning number." G XERRX
 I ID="ORB" S ERRMSG="Overrun while scanning boolean." G XERRX
 I ID="ESC" S ERRMSG="Escaped character not recognized"_VAL G XERRX
 ;
 ; Encode Error Messages
 ;
 I ID="SOB" S ERRMSG="Unable to serialize node as object, value was "_VAL G XERRX
 I ID="SAR" S ERRMSG="Unable to serialize node as array, value was "_VAL G XERRX
 S ERRMSG="Unspecified error "_ID_" "_$G(VAL)
XERRX ; end switch
 S @VVERR@(0)=$G(@VVERR@(0))+1
 S @VVERR@(@VVERR@(0))=ERRMSG
 S VVERRORS=VVERRORS+1
 Q
 ;
 ; Most of this code is public domain. New lower case entry points
 ; Copyright 2013-2019 Sam Habiel
 ;
 ;Licensed under the Apache License, Version 2.0 (the "License");
 ;you may not use this file except in compliance with the License.
 ;You may obtain a copy of the License at
 ;
 ;    http://www.apache.org/licenses/LICENSE-2.0
 ;
 ;Unless required by applicable law or agreed to in writing, software
 ;distributed under the License is distributed on an "AS IS" BASIS,
 ;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ;See the License for the specific language governing permissions and
 ;limitations under the License.

SYNJSOND
SYNJSOND ;SLC/KCM -- Decode JSON;2019-03-01  10:44 AM ; 6/28/19 3:27pm
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
DECODE(VVJSON,VVROOT,VVERR) ; Set JSON object into closed array ref VVROOT
 ;
DIRECT ; TAG for use by decode^SYNJSOND
 ;
 ; Examples: D decode^SYNJSOND("MYJSON","LOCALVAR","LOCALERR")
 ;           D decode^SYNJSOND("^MYJSON(1)","^GLO(99)","^TMP($J)")
 ;
 ; VVJSON: string/array containing serialized JSON object
 ; VVROOT: closed array reference for M representation of object
 ;  VVERR: contains error messages, defaults to ^TMP("SYNJSONERR",$J)
 ;
 ;   VVIDX: points to next character in JSON string to process
 ; VVSTACK: manages stack of subscripts
 ;  VVPROP: true if next string is property name, otherwise treat as value
 ;
 ; V4W/DLW - Changed VVMAX from 4000 to 100, same as in the encoder
 ; With the change to VVMAX, the following Unit Tests required changes:
 ; SPLITA^SYNJSODT, SPLITB^SYNJSODT, LONG^SYNJSODT, MAXNUM^SYNJSODT
 N VVMAX S VVMAX=100 ; limit document lines to 100 characters
 S VVERR=$G(VVERR,"^TMP(""SYNJSONERR"",$J)")
 ; If a simple string is passed in, move it to an temp array (VVINPUT)
 ; so that the processing is consistently on an array.
 I $D(@VVJSON)=1 N VVINPUT S VVINPUT(1)=@VVJSON,VVJSON="VVINPUT"
 S VVROOT=$NA(@VVROOT@("Z")),VVROOT=$E(VVROOT,1,$L(VVROOT)-4) ; make open array ref
 N VVLINE,VVIDX,VVSTACK,VVPROP,VVTYPE,VVERRORS
 S VVLINE=$O(@VVJSON@("")),VVIDX=1,VVSTACK=0,VVPROP=0,VVERRORS=0
 F  S VVTYPE=$$NXTKN() Q:VVTYPE=""  D  I VVERRORS Q
 . I VVTYPE="{" S VVSTACK=VVSTACK+1,VVSTACK(VVSTACK)="",VVPROP=1 D:VVSTACK>64 ERRX("STL{") Q
 . I VVTYPE="}" D  QUIT
 . . I VVSTACK(VVSTACK)?1n.n,VVSTACK(VVSTACK) D ERRX("OBM") ; Numeric and true only
 . . S VVSTACK=VVSTACK-1 D:VVSTACK<0 ERRX("SUF}")
 . I VVTYPE="[" S VVSTACK=VVSTACK+1,VVSTACK(VVSTACK)=1 D:VVSTACK>64 ERRX("STL[") Q
 . I VVTYPE="]" D:'VVSTACK(VVSTACK) ERRX("ARM") S VVSTACK=VVSTACK-1 D:VVSTACK<0 ERRX("SUF]") Q
 . I VVTYPE="," D  Q
 . . I +VVSTACK(VVSTACK)=VVSTACK(VVSTACK),VVSTACK(VVSTACK) S VVSTACK(VVSTACK)=VVSTACK(VVSTACK)+1  ; VEN/SMH - next in array
 . . E  S VVPROP=1                                   ; or next property name
 . I VVTYPE=":" S VVPROP=0 D:'$L($G(VVSTACK(VVSTACK))) ERRX("MPN") Q
 . I VVTYPE="""" D  Q
 . . I VVPROP S VVSTACK(VVSTACK)=$$UES($$NAMPARS(),1) I 1
 . . E  D ADDSTR
 . S VVTYPE=$TR(VVTYPE,"TFN","tfn")
 . I VVTYPE="t" D SETBOOL("t") Q
 . I VVTYPE="f" D SETBOOL("f") Q
 . I VVTYPE="n" D SETBOOL("n") Q
 . I "0123456789+-.eE"[VVTYPE D SETNUM(VVTYPE) Q  ;S @$$CURNODE()=$$NUMPARS(VVTYPE) Q
 . D ERRX("TKN",VVTYPE)
 I VVSTACK'=0 D ERRX("SCT",VVSTACK)
 Q
NXTKN() ; Move the pointers to the beginning of the next token
 N VVDONE,VVEOF,VVTOKEN
 S VVDONE=0,VVEOF=0 F  D  Q:VVDONE!VVEOF  ; eat spaces & new lines until next visible char
 . I VVIDX>$L(@VVJSON@(VVLINE)) S VVLINE=$O(@VVJSON@(VVLINE)),VVIDX=1 I 'VVLINE S VVEOF=1 Q
 . I $A(@VVJSON@(VVLINE),VVIDX)>32 S VVDONE=1 Q
 . S VVIDX=VVIDX+1
 Q:VVEOF ""  ; we're at the end of input
 S VVTOKEN=$E(@VVJSON@(VVLINE),VVIDX),VVIDX=VVIDX+1
 Q VVTOKEN
 ;
ADDSTR ; Add string value to current node, escaping text along the way
 ; Expects VVLINE,VVIDX to reference that starting point of the index
 ; TODO: add a mechanism to specify names that should not be escaped
 ;       just store as ":")= and ":",n)=
 ;
 ; Happy path -- we find the end quote in the same line
 N VVEND,VVX
 S VVEND=$F(@VVJSON@(VVLINE),"""",VVIDX)
 I VVEND,($E(@VVJSON@(VVLINE),VVEND-2)'="\") D SETSTR  QUIT  ;normal
 I VVEND,$$ISCLOSEQ(VVLINE) D SETSTR QUIT  ;close quote preceded by escaped \
 ;
 ; Less happy path -- first quote wasn't close quote
 N VVDONE,VVTLINE
 S VVDONE=0,VVTLINE=VVLINE ; VVTLINE for temporary increment of VVLINE
 F  D  Q:VVDONE  Q:VVERRORS
 . ;if no quote on current line advance line, scan again
 . I 'VVEND S VVTLINE=VVTLINE+1,VVEND=1 I '$D(@VVJSON@(VVTLINE)) D ERRX("EIQ") Q
 . S VVEND=$F(@VVJSON@(VVTLINE),"""",VVEND)
 . Q:'VVEND  ; continue on to next line if no quote found on this one
 . I (VVEND>2),($E(@VVJSON@(VVTLINE),VVEND-2)'="\") S VVDONE=1 Q  ; found quote position
 . S VVDONE=$$ISCLOSEQ(VVTLINE) ; see if this is an escaped quote or closing quote
 Q:VVERRORS
 ; unescape from VVIDX to VVEND, using \-extension nodes as necessary
 D UESEXT
 ; now we need to move VVLINE and VVIDX to next parsing point
 S VVLINE=VVTLINE,VVIDX=VVEND
 Q
SETSTR ; Set simple string value from within same line
 ; expects VVJSON, VVLINE, VVINX, VVEND
 N VVX
 S VVX=$E(@VVJSON@(VVLINE),VVIDX,VVEND-2),VVIDX=VVEND
 S @$$CURNODE()=$$UES(VVX)
 ; "\s" node indicates value is really a string in case value
 ;      collates as numeric or equals boolean keywords
 I VVX']]$C(1) S @$$CURNODE()@("\s")=""
 I VVX="true"!(VVX="false")!(VVX="null") S @$$CURNODE()@("\s")=""
 I VVIDX>$L(@VVJSON@(VVLINE)) S VVLINE=VVLINE+1,VVIDX=1
 Q
UESEXT ; unescape from VVLINE,VVIDX to VVTLINE,VVEND & extend (\) if necessary
 ; expects VVLINE,VVIDX,VVTLINE,VVEND
 N VVI,VVY,VVSTART,VVSTOP,VVDONE,VVBUF,VVNODE,VVMORE,VVTO
 S VVNODE=$$CURNODE(),VVBUF="",VVMORE=0,VVSTOP=VVEND-2
 S VVI=VVIDX,VVY=VVLINE,VVDONE=0
 F  D  Q:VVDONE  Q:VVERRORS
 . S VVSTART=VVI,VVI=$F(@VVJSON@(VVY),"\",VVI)
 . ; if we are on the last line, don't extract past VVSTOP
 . I (VVY=VVTLINE) S VVTO=$S('VVI:VVSTOP,VVI>VVSTOP:VVSTOP,1:VVI-2) I 1
 . E  S VVTO=$S('VVI:99999,1:VVI-2)
 . D ADDBUF($E(@VVJSON@(VVY),VVSTART,VVTO))
 . I (VVY'<VVTLINE),(('VVI)!(VVI>VVSTOP)) S VVDONE=1 QUIT  ; now past close quote
 . I 'VVI S VVY=VVY+1,VVI=1 QUIT  ; nothing escaped, go to next line
 . I VVI>$L(@VVJSON@(VVY)) S VVY=VVY+1,VVI=1 I '$D(@VVJSON@(VVY)) D ERRX("EIU")
 . N VVTGT S VVTGT=$E(@VVJSON@(VVY),VVI)
 . I VVTGT="u" D  I 1
 . . N VVTGTC S VVTGTC=$E(@VVJSON@(VVY),VVI+1,VVI+4),VVI=VVI+4
 . . I $L(VVTGTC)<4 S VVY=VVY+1,VVI=4-$L(VVTGTC),VVTGTC=VVTGTC_$E(@VVJSON@(VVY),1,VVI)
 . . D ADDBUF($C($$DEC^SYNWEBUT(VVTGTC,16)))
 . E  D ADDBUF($$REALCHAR(VVTGT))
 . S VVI=VVI+1
 . I (VVY'<VVTLINE),(VVI>VVSTOP) S VVDONE=1 ; VVI incremented past stop
 Q:VVERRORS
 D SAVEBUF
 Q
ADDBUF(VVX) ; add buffer of characters to destination
 ; expects VVBUF,VVMAX,VVNODE,VVMORE to be defined
 ; used directly by ADDSTR
 I $L(VVX)+$L(VVBUF)>VVMAX D SAVEBUF
 S VVBUF=VVBUF_VVX
 Q
SAVEBUF ; write out buffer to destination
 ; expects VVBUF,VVMAX,VVNODE,VVMORE to be defined
 ; used directly by ADDSTR,ADDBUF
 I VVMORE S @VVNODE@("\",VVMORE)=VVBUF
 I 'VVMORE S @VVNODE=VVBUF I $L(VVBUF)<19,+$E(VVBUF,1,18) S @VVNODE@("\s")=""
 S VVMORE=VVMORE+1,VVBUF=""
 Q
ISCLOSEQ(VVBLINE) ; return true if this is a closing, rather than escaped, quote
 ; expects
 ;   VVJSON: lines of the JSON encoded string
 ;    VVIDX: points to 1st character of the segment
 ;   VVLINE: points to the line in which the segment starts
 ;    VVEND: points to 1st character after the " (may be past the end of the line)
 ; used directly by ADDSTR
 N VVBS,VVBIDX,VVBDONE
 S VVBS=0,VVBIDX=VVEND-2,VVBDONE=0 ; VVBIDX starts at 1st character before quote
 ; count the backslashes preceding the quote (odd number means the quote was escaped)
 F  D  Q:VVBDONE!VVERRORS
 . I VVBIDX<1 D  Q  ; when VVBIDX<1 go back a line
 . . S VVBLINE=VVBLINE-1 I VVBLINE<VVLINE D ERRX("RSB") Q
 . . S VVBIDX=$L(@VVJSON@(VVBLINE))
 . I $E(@VVJSON@(VVBLINE),VVBIDX)'="\" S VVBDONE=1 Q
 . S VVBS=VVBS+1,VVBIDX=VVBIDX-1
 Q VVBS#2=0  ; VVBS is even if this is a close quote
 ;
NAMPARS() ; Return parsed name, advancing index past the close quote
 N VVEND,VVDONE,VVNAME,VVSTART
 S VVDONE=0,VVNAME="",VVSTART=VVIDX
 F  D  Q:VVDONE  Q:VVERRORS
 . S VVEND=$F(@VVJSON@(VVLINE),"""",VVIDX)
 . I $E(@VVJSON@(VVLINE),VVEND-2)="\" S VVIDX=VVEND Q
 . I VVEND S VVNAME=VVNAME_$E(@VVJSON@(VVLINE),VVSTART,VVEND-2),VVIDX=VVEND,VVDONE=1
 . I 'VVEND S VVNAME=VVNAME_$E(@VVJSON@(VVLINE),VVSTART,$L(@VVJSON@(VVLINE)))
 . I 'VVEND!(VVEND>$L(@VVJSON@(VVLINE))) S VVLINE=VVLINE+1,(VVIDX,VVSTART)=1 I '$D(@VVJSON@(VVLINE)) D ERRX("ORN")
 ; prepend quote if label collates as numeric -- assumes no quotes in label
 I VVNAME']]$C(1) S VVNAME=""""""_VVNAME
 Q VVNAME
 ;
SETNUM(VVDIGIT) ; Set numeric along with any necessary modifier
 N VVX
 S VVX=$$NUMPARS(VVDIGIT)
 S @$$CURNODE()=$S(VVX["e":+$TR(VVX,"e","E"),1:+VVX)
 ; if numeric is exponent, "0.nnn" or "-0.nnn" store original string
 I +VVX'=VVX S @$$CURNODE()@("\n")=VVX
 Q
NUMPARS(VVDIGIT) ; Return parsed number, advancing index past end of number
 ; VVIDX intially references the second digit
 N VVDONE,VVNUM
 S VVDONE=0,VVNUM=VVDIGIT
 F  D  Q:VVDONE  Q:VVERRORS
 . I '("0123456789+-.eE"[$E(@VVJSON@(VVLINE),VVIDX)) S VVDONE=1 Q
 . S VVNUM=VVNUM_$E(@VVJSON@(VVLINE),VVIDX)
 . S VVIDX=VVIDX+1 I VVIDX>$L(@VVJSON@(VVLINE)) S VVLINE=VVLINE+1,VVIDX=1 I '$D(@VVJSON@(VVLINE)) D ERRX("OR#")
 Q VVNUM
 ;
SETBOOL(VVLTR) ; Parse and set boolean value, advancing index past end of value
 N VVDONE,VVBOOL,VVX
 S VVDONE=0,VVBOOL=VVLTR
 F  D  Q:VVDONE  Q:VVERRORS
 . S VVX=$TR($E(@VVJSON@(VVLINE),VVIDX),"TRUEFALSN","truefalsn")
 . I '("truefalsn"[VVX) S VVDONE=1 Q
 . S VVBOOL=VVBOOL_VVX
 . S VVIDX=VVIDX+1 I VVIDX>$L(@VVJSON@(VVLINE)) S VVLINE=VVLINE+1,VVIDX=1 I '$D(@VVJSON@(VVLINE)) D ERRX("ORB")
 I VVLTR="t",(VVBOOL'="true") D ERRX("EXT",VVTYPE)
 I VVLTR="f",(VVBOOL'="false") D ERRX("EXF",VVTYPE)
 I VVLTR="n",(VVBOOL'="null") D ERRX("EXN",VVTYPE)
 S @$$CURNODE()=VVBOOL
 Q
 ;
OSETBOOL(VVX) ; set a value and increment VVIDX
 S @$$CURNODE()=VVX
 S VVIDX=VVIDX+$L(VVX)-1
 N VVDIFF S VVDIFF=VVIDX-$L(@VVJSON@(VVLINE))  ; in case VVIDX moves to next line
 I VVDIFF>0 S VVLINE=VVLINE+1,VVIDX=VVDIFF I '$D(@VVJSON@(VVLINE)) D ERRX("ORB")
 Q
CURNODE() ; Return a global/local variable name based on VVSTACK
 ; Expects VVSTACK to be defined already
 N VVI,VVSUBS
 S VVSUBS=""
 F VVI=1:1:VVSTACK S:VVI>1 VVSUBS=VVSUBS_"," D
 . ; check numeric with pattern match instead of =+var due to GT.M interperting
 . ; scientific notation as a number instead of a string
 . I VVSTACK(VVI)?1N.N S VVSUBS=VVSUBS_VVSTACK(VVI) ; VEN/SMH Fix psudo array bug.
 . E  S VVSUBS=VVSUBS_""""_VVSTACK(VVI)_""""
 Q VVROOT_VVSUBS_")"
 ;
UES(X,KEY) ; Unescape JSON string
 ; copy segments from START to POS-2 (right before \)
 ; translate target character (which is at $F position)
 N POS,Y,START
 S POS=0,Y=""
 F  S START=POS+1 D  Q:START>$L(X)
 . S POS=$F(X,"\",START) ; find next position
 . I 'POS S Y=Y_$E(X,START,$L(X)),POS=$L(X) Q
 . ; otherwise handle escaped char
 . N TGT
 . S TGT=$E(X,POS),Y=Y_$E(X,START,POS-2)
 . I TGT="u" S Y=Y_$C($$DEC^SYNWEBUT($E(X,POS+1,POS+4),16)),POS=POS+4 Q
 . S Y=Y_$$REALCHAR(TGT,$G(KEY))
 Q Y
 ;
REALCHAR(C,KEY) ; Return actual character from escaped
 I C=""""&'$G(KEY) Q """" ; Used in the value part and doesn't need double quotes
 I C=""""&$G(KEY) Q """""" ; Used as part of a set statement and needs double quotes
 I C="/" Q "/"
 I C="\" Q "\"
 I C="b" Q $C(8)
 I C="f" Q $C(12)
 I C="n" Q $C(10)
 I C="r" Q $C(13)
 I C="t" Q $C(9)
 I C="u" ;case covered above in $$DEC^SYNWEBUT calls
 ;otherwise
 I $L($G(VVERR)) D ERRX("ESC",C)
 Q C
 ;
ERRX(ID,VAL) ; Set the appropriate error message
 D ERRXSYNJSON(ID,$G(VAL))
 Q
 ;
 ; Portions of this code are public domain, but it was extensively modified
 ; Copyright 2016 Accenture Federal Services
 ; Copyright 2013-2019 Sam Habiel
 ;
 ;Licensed under the Apache License, Version 2.0 (the "License");
 ;you may not use this file except in compliance with the License.
 ;You may obtain a copy of the License at
 ;
 ;    http://www.apache.org/licenses/LICENSE-2.0
 ;
 ;Unless required by applicable law or agreed to in writing, software
 ;distributed under the License is distributed on an "AS IS" BASIS,
 ;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ;See the License for the specific language governing permissions and
 ;limitations under the License.

SYNJSONE
SYNJSONE ;SLC/KCM -- Encode JSON;Feb 07, 2019@11:01 ; 6/28/19 3:26pm
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
ENCODE(VVROOT,VVJSON,VVERR) ; VVROOT (M structure) --> VVJSON (array of strings)
 ;
DIRECT ; TAG for use by encode^SYNJSONE
 ;
 ; Examples:  D encode^SYNJSONE("^GLO(99,2)","^TMP($J)")
 ;            D encode^SYNJSONE("LOCALVAR","MYJSON","LOCALERR")
 ;
 ; VVROOT: closed array reference for M representation of object
 ; VVJSON: destination variable for the string array formatted as JSON
 ;  VVERR: contains error messages, defaults to ^TMP("SYNJSONERR",$J)
 ;
 S VVERR=$G(VVERR,"^TMP(""SYNJSONERR"",$J)")
 I '$L($G(VVROOT)) ; set error info
 I '$L($G(VVJSON)) ; set error info
 N VVLINE,VVMAX,VVERRORS
 ;
 ; V4W/DLW - Changed VVMAX from 4000 (just under the 4096 string size limit)
 ; to 100. With large data arrays, the JSON encoder could exhaust system
 ; memory, which required a switch to globals to fix. However, 4000 as a
 ; limit slowed the encoder down quite a bit, when using globals.
 ; With the change to VVMAX, the following Unit Tests required changes:
 ; PURENUM^SYNJSODT,
 ; ESTRING^SYNJSODT, BASIC^SYNJSOET, VALS^SYNJSOET, LONG^SYNJSOET,
 ; PRE^SYNJSOET, WP^SYNJSOET, EXAMPLE^SYNJSOET
 S VVLINE=1,VVMAX=100,VVERRORS=0 ; limit document lines to 100 characters
 S @VVJSON@(VVLINE)=""
 D SEROBJ(VVROOT)
 Q
 ;
SEROBJ(VVROOT) ; Serialize into a JSON object
 N VVFIRST,VVSUB,VVNXT
 S @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_"{"
 S VVFIRST=1
 S VVSUB="" F  S VVSUB=$O(@VVROOT@(VVSUB)) Q:VVSUB=""  D
 . S:'VVFIRST @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_"," S VVFIRST=0
 . ; get the name part
 . D SERNAME(VVSUB)
 . ; if this is a value, serialize it
 . I $$ISVALUE(VVROOT,VVSUB) D SERVAL(VVROOT,VVSUB) Q
 . ; otherwise navigate to the next child object or array
 . I $D(@VVROOT@(VVSUB))=10 S VVNXT=$O(@VVROOT@(VVSUB,"")) D  Q
 . . ; Need to check if numeric representation matches string representation to decide if it is an array
 . . I +VVNXT=VVNXT D SERARY($NA(@VVROOT@(VVSUB))) I 1
 . . E  D SEROBJ($NA(@VVROOT@(VVSUB)))
 . D ERRX("SOB",VVSUB)  ; should quit loop before here
 S @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_"}"
 Q
SERARY(VVROOT) ; Serialize into a JSON array
 N VVFIRST,VVI,VVNXT
 S @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_"["
 S VVFIRST=1
 S VVI=0 F  S VVI=$O(@VVROOT@(VVI)) Q:'VVI  D
 . S:'VVFIRST @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_"," S VVFIRST=0
 . I $$ISVALUE(VVROOT,VVI) D SERVAL(VVROOT,VVI) Q  ; write value
 . I $D(@VVROOT@(VVI))=10 S VVNXT=$O(@VVROOT@(VVI,"")) D  Q
 . . ; Need to check if numeric representation matches string representation to decide if it is an array
 . . I +VVNXT=VVNXT D SERARY($NA(@VVROOT@(VVI))) I 1
 . . E  D SEROBJ($NA(@VVROOT@(VVI)))
 . D ERRX("SAR",VVI)  ; should quit loop before here
 S @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_"]"
 Q
SERNAME(VVSUB) ; Serialize the object name into JSON string
 I $E(VVSUB)="""" S VVSUB=$E(VVSUB,2,$L(VVSUB)) ; quote indicates numeric label
 I ($L(VVSUB)+$L(@VVJSON@(VVLINE)))>VVMAX S VVLINE=VVLINE+1,@VVJSON@(VVLINE)=""
 S @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_""""_$$ESC(VVSUB)_""""_":"
 Q
SERVAL(VVROOT,VVSUB) ; Serialize X into appropriate JSON representation
 N VVX,VVI,VVDONE
 ; if the node is already in JSON format, just add it
 I $D(@VVROOT@(VVSUB,":")) D  QUIT  ; <-- jump out here if preformatted
 . S VVX=$G(@VVROOT@(VVSUB,":")) D:$L(VVX) CONCAT
 . S VVI=0 F  S VVI=$O(@VVROOT@(VVSUB,":",VVI)) Q:'VVI  S VVX=@VVROOT@(VVSUB,":",VVI) D CONCAT
 ;
 S VVX=$G(@VVROOT@(VVSUB)),VVDONE=0
 ; handle the numeric, boolean, and null types
 I $D(@VVROOT@(VVSUB,"\n")) S:$L(@VVROOT@(VVSUB,"\n")) VVX=@VVROOT@(VVSUB,"\n") D CONCAT QUIT  ; when +X'=X
 I '$D(@VVROOT@(VVSUB,"\s")),$L(VVX) D  QUIT:VVDONE
 . I VVX']]$C(1) S VVX=$$JNUM(VVX) D CONCAT S VVDONE=1 QUIT
 . I VVX="true"!(VVX="false")!(VVX="null") D CONCAT S VVDONE=1 QUIT
 ; otherwise treat it as a string type
 S VVX=""""_$$ESC(VVX) ; open quote
 D CONCAT
 I $D(@VVROOT@(VVSUB,"\")) D  ; handle continuation nodes
 . S VVI=0 F  S VVI=$O(@VVROOT@(VVSUB,"\",VVI)) Q:'VVI   D
 . . S VVX=$$ESC(@VVROOT@(VVSUB,"\",VVI))
 . . D CONCAT
 S VVX="""" D CONCAT    ; close quote
 Q
CONCAT ; come here to concatenate to JSON string
 I ($L(VVX)+$L(@VVJSON@(VVLINE)))>VVMAX S VVLINE=VVLINE+1,@VVJSON@(VVLINE)=""
 S @VVJSON@(VVLINE)=@VVJSON@(VVLINE)_VVX
 Q
ISVALUE(VVROOT,VVSUB) ; Return true if this is a value node
 I $D(@VVROOT@(VVSUB))#2 Q 1
 N VVX S VVX=$O(@VVROOT@(VVSUB,""))
 Q:VVX="\" 1  ; word processing continuation node
 Q:VVX=":" 1  ; pre-formatted JSON node
 Q 0
 ;
NUMERIC(X) ; Return true if the numeric
 I $L(X)>18 Q 0        ; string (too long for numeric)
 I X=0 Q 1             ; numeric (value is zero)
 I +X=0 Q 0            ; string
 I $E(X,1)="." Q 0     ; not a JSON number (although numeric in M)
 I $E(X,1,2)="-." Q 0  ; not a JSON number
 I +X=X Q 1            ; numeric
 I X?1"0."1.n Q 1      ; positive fraction
 I X?1"-0."1.N Q 1     ; negative fraction
 S X=$TR(X,"e","E")
 I X?.1"-"1.N.1".".N1"E".1"+"1.N Q 1  ; {-}99{.99}E{+}99
 I X?.1"-"1.N.1".".N1"E-"1.N Q 1      ; {-}99{.99}E-99
 Q 0
 ;
ESC(X) ; Escape string for JSON
 N Y,I,PAIR,FROM,TO
 S Y=X
 F PAIR="\\","""""","//",$C(8,98),$C(12,102),$C(10,110),$C(13,114),$C(9,116) D
 . S FROM=$E(PAIR),TO=$E(PAIR,2)
 . S X=Y,Y=$P(X,FROM) F I=2:1:$L(X,FROM) S Y=Y_"\"_TO_$P(X,FROM,I)
 I Y?.E1.C.E S X=Y,Y="" F I=1:1:$L(X) S FROM=$A(X,I) D
 . ; skip NUL character, otherwise encode ctrl-char
 . I FROM<32 Q:FROM=0  S Y=Y_$$UCODE(FROM) Q
 . I FROM>126,(FROM<160) S Y=Y_$$UCODE(FROM) Q
 . S Y=Y_$E(X,I)
 Q Y
 ;
JNUM(N) ; Return JSON representation of a number
 I N'<1 Q N
 I N'>-1 Q N
 I N>0 Q "0"_N
 I N<0 Q "-0"_$P(N,"-",2,9)
 Q N
 ;
UCODE(C) ; Return \u00nn representation of decimal character value
 N H S H="0000"_$$CNV^SYNWEBUT(C,16)
 Q "\u"_$E(H,$L(H)-3,$L(H))
 ;
ERRX(ID,VAL) ; Set the appropriate error message
 D ERRXSYNJSON(ID,$G(VAL))
 Q
 ;
 ; Portions of this code are public domain, but it was extensively modified
 ; Copyright 2016 Accenture Federal Services
 ; Copyright 2013-2019 Sam Habiel
 ; Copyright 2019 Christopher Edwards
 ;
 ;Licensed under the Apache License, Version 2.0 (the "License");
 ;you may not use this file except in compliance with the License.
 ;You may obtain a copy of the License at
 ;
 ;    http://www.apache.org/licenses/LICENSE-2.0
 ;
 ;Unless required by applicable law or agreed to in writing, software
 ;distributed under the License is distributed on an "AS IS" BASIS,
 ;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ;See the License for the specific language governing permissions and
 ;limitations under the License.

SYNKIDS
SYNKIDS ; OSE/SMH - Synthea Installer ; 6/28/19 2:57pm
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
ENV ; [Fallthrough]
 QUIT
 ;
CACHE() Q $L($SY,",")'=2
GTM() Q $P($SY,",")=47
 ;
TRAN ; [KIDS] - Transport from source system (BAD! SHOULD BE A FILEMAN FILE)
 M @XPDGREF@("SYN")=^SYN
 N I F I=200000000-1:0  S I=$O(^ICPT(I)) Q:'I  M @XPDGREF@("OS5",81,I)=^ICPT(I)
 N LEXF F LEXF=757,757.001,757.01,757.02,757.1,757.21 DO
 . N I F I=3000000000-1:0 S I=$O(^LEX(LEXF,I)) Q:'I  M @XPDGREF@("OS5",LEXF,I)=^LEX(LEXF,I)
 n mapRoot s mapRoot=$$setroot^SYNWD("loinc-lab-map")
 M @XPDGREF@("loinc-lab-map")=@mapRoot
 QUIT
 ;
PRE ; [KIDS] - Pre Install -- all for Cache
 QUIT
 ;
POST ; [KIDS] - Post Install
 DO POSTSYN
 DO POSTINTR
 DO POSTMAP
 QUIT
 ;
POSTMAP ; [Private] Add loinc-lab-map to the graph store
 new root set root=$$setroot^SYNWD("loinc-lab-map")
 kill @root
 merge @root=@XPDGREF@("loinc-lab-map")
 new rindx set rindx=$name(@root@("graph","map"))
 set @root@("index","root")=rindx
 do index^SYNGRAPH(rindx)
 quit
 ;
POSTSYN ; [Private] Restore SYN global
 ; Resore data from saved global
 ; Next line makes this safe to run in dev mode
 D MES^XPDUTL("Merging ^SYN global in. This takes time...")
 I $D(XPDGREF)#2,$D(@XPDGREF@("SYN")) D
 . K ^SYN("2002.030","sct2icd"),^("sct2icdnine"),^("sct2os5") ; **NAKED**
 . M ^SYN=@XPDGREF@("SYN")
 ;
 ; Install OS5 codes
 I $D(XPDGREF)#2,$D(@XPDGREF@("OS5")) D
 . N SYNF F SYNF=81,757,757.001,757.01,757.02,757.1,757.21 DO  ; for each file
 .. N SYNCR S SYNCR=$$ROOT^DILFD(SYNF,,1) ; closed reference
 .. N SYNOR S SYNOR=$$ROOT^DILFD(SYNF)    ; open reference
 .. N SYNI F SYNI=0:0 S SYNI=$O(@XPDGREF@("OS5",SYNF,SYNI)) Q:'SYNI  D  ; for each entry
 ... ;
 ... ; Delete old data
 ... N DA,DIK S DA=SYNI,DIK=SYNOR D ^DIK
 ... ;
 ... ; Add new data
 ... M @SYNCR@(SYNI)=@XPDGREF@("OS5",SYNF,SYNI)
 ... N DA,DIK S DA=SYNI,DIK=SYNOR D IX1^DIK
 ;
 ; Initialize Synthea
 D ^SYNINIT
 QUIT
 ;
POSTINTR ; [Private] Append Users to Intro Text
 N L S L=$O(^XTV(8989.3,1,"INTRO"," "),-1)+1
 I $G(^XTV(8989.3,1,"INTRO",L-1,0))["SYNPHARM123!!" QUIT  ; don't add again
 S ^XTV(8989.3,1,"INTRO",L,0)=" "
 S L=L+1
 S ^XTV(8989.3,1,"INTRO",L,0)=" SYN USER      ACCESS CODE       VERIFY CODE         ELECTRONIC SIGNATURE"
 S L=L+1
 S ^XTV(8989.3,1,"INTRO",L,0)=" --------      -----------       -----------         --------------------"
 S L=L+1
 S ^XTV(8989.3,1,"INTRO",L,0)=" PROVIDER,UNK  SYNPROV123        SYNPROV123!!        123456"
 S L=L+1
 S ^XTV(8989.3,1,"INTRO",L,0)=" PHARMACIST,U  SYNPHARM123       SYNPHARM123!!       123456"
 ;
 S $P(^XTV(8989.3,1,"INTRO",0),U,3,4)=L_U_L
 ;
 QUIT
 ;

SYNLDUT
SYNLDUT ; HC/art - HealthConcourse - load unit tests into a file ;08/29/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;
 QUIT
 ;
LOAD ;unit test for get VistA data REST services
 ;
 N STR,URL,PF,IENS,IDX
 ;
 F IDX=1:1 S STR=$P($T(LIST+IDX),";;",2) QUIT:STR="zzzzz"  D
 . N FDA,MSG,ERR
 . S URL=$P(STR,U,1)
 . S PF=$P(STR,U,2)
 . S FDA(2002.1,"+1,",.01)=URL
 . S FDA(2002.1,"+1,",1)=PF
 . D UPDATE^DIE("","FDA","MSG","ERR")
 . I $D(ERR) ZWRITE ERR
 ;
 QUIT
 ;
RELOAD ;unit test for get VistA data REST services
 ;
 K ^SYN(2002.1)
 S ^SYN(2002.1,0)="SYN REST UNIT TESTS^2002.1^0^0"
 D LOAD
 ;
 QUIT
 ;
LIST ;  url ^ pass/fail
 ;;http://localhost:9080/DHPPATALLICN^F
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V153702^F
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V183702^P
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V183702&FRDAT=20060101&TODAT=20050101^F
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V183702&FRDAT=20000101&TODAT=20050101^P
 ;;http://localhost:9080/DHPPATALLICN?ICN=1435855215V947437^P
 ;;http://localhost:9080/DHPPATALLICN?JSON=J^F
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V153702&JSON=J^F
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V183702&JSON=J^P
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V183702&FRDAT=20060101&TODAT=20050101&JSON=J^F
 ;;http://localhost:9080/DHPPATALLICN?ICN=10111V183702&FRDAT=20000101&TODAT=20050101&JSON=J^P
 ;;http://localhost:9080/DHPPATALLICN?ICN=1435855215V947437&JSON=J^P
 ;;http://localhost:9080/DHPPATAPTICN^F
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198453374V588739^F
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198013374V588739^P
 ;;http://localhost:9080/DHPPATAPTICN?ICN=10111V183702^P
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198013374V588739&FRDAT=20070101&TODAT=20050101^F
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198013374V588739&FRDAT=20110101&TODAT=20150101^P
 ;;http://localhost:9080/DHPPATAPTICN?ICN=10111V183702&FRDAT=20050101^P
 ;;http://localhost:9080/DHPPATAPTICN?JSON=J^F
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198453374V588739&JSON=J^F
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198013374V588739&JSON=J^P
 ;;http://localhost:9080/DHPPATAPTICN?ICN=10111V183702&JSON=J^P
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198013374V588739&FRDAT=20070101&TODAT=20050101&JSON=J^F
 ;;http://localhost:9080/DHPPATAPTICN?ICN=1198013374V588739&FRDAT=20110101&TODAT=20150101&JSON=J^P
 ;;http://localhost:9080/DHPPATAPTICN?ICN=10111V183702&FRDAT=20050101&JSON=J^P
 ;;http://localhost:9080/DHPPATCONICN^F
 ;;http://localhost:9080/DHPPATCONICN?ICN=2677504935V204585^F
 ;;http://localhost:9080/DHPPATCONICN?ICN=1180280581V669943^P
 ;;http://localhost:9080/DHPPATCONICN?ICN=5000001533V676621^P
 ;;http://localhost:9080/DHPPATCONICN?ICN=10112V399621^P
 ;;http://localhost:9080/DHPPATCONICN?ICN=10112V399621&FRDAT=20070101&TODAT=20051231^F
 ;;http://localhost:9080/DHPPATCONICN?ICN=10112V399621&FRDAT=20000101&TODAT=20051231^P
 ;;http://localhost:9080/DHPPATCONICN?JSON=J^F
 ;;http://localhost:9080/DHPPATCONICN?ICN=2677504935V204585&JSON=J^F
 ;;http://localhost:9080/DHPPATCONICN?ICN=1180280581V669943&JSON=J^P
 ;;http://localhost:9080/DHPPATCONICN?ICN=5000001533V676621&JSON=J^P
 ;;http://localhost:9080/DHPPATCONICN?ICN=10112V399621&JSON=J^P
 ;;http://localhost:9080/DHPPATCONICN?ICN=10112V399621&FRDAT=20070101&TODAT=20051231&JSON=J^F
 ;;http://localhost:9080/DHPPATCONICN?ICN=10112V399621&FRDAT=20000101&TODAT=20051231&JSON=J^P
 ;;http://localhost:9080/DHPPATS4CON^F
 ;;http://localhost:9080/DHPPATS4CON?SCT=99^F
 ;;http://localhost:9080/DHPPATS4CON?SCT=10509002^P
 ;;http://localhost:9080/DHPPATS4CON?SCT=47505003^P
 ;;http://localhost:9080/DHPPATS4CON?JSON=J^F
 ;;http://localhost:9080/DHPPATS4CON?SCT=99&JSON=J^F
 ;;http://localhost:9080/DHPPATS4CON?SCT=10509002&JSON=J^P
 ;;http://localhost:9080/DHPPATS4CON?SCT=47505003&JSON=J^P
 ;;http://localhost:9080/DHPPATCPALLI^F
 ;;http://localhost:9080/DHPPATCPALLI?ICN=2434634569V691690^F
 ;;http://localhost:9080/DHPPATCPALLI?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATCPALLI?ICN=5000001533V676621^P
 ;;http://localhost:9080/DHPPATCPALLI?ICN=1435855215V947437^P
 ;;http://localhost:9080/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20130101&TODAT=20120101^F
 ;;http://localhost:9080/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20000101&TODAT=20120101^P
 ;;http://localhost:9080/DHPPATCPALLI?JSON=J^F
 ;;http://localhost:9080/DHPPATCPALLI?ICN=2434634569V691690&JSON=J^F
 ;;http://localhost:9080/DHPPATCPALLI?ICN=2434609669V691690&JSON=J^P
 ;;http://localhost:9080/DHPPATCPALLI?ICN=5000001533V676621&JSON=J^P
 ;;http://localhost:9080/DHPPATCPALLI?ICN=1435855215V947437&JSON=J^P
 ;;http://localhost:9080/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20130101&TODAT=20120101&JSON=J^F
 ;;http://localhost:9080/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20000101&TODAT=20120101&JSON=J^P
 ;;http://localhost:9080/DHPPATCPI?VRESID=V-500-1000010-34486^F
 ;;http://localhost:9080/DHPPATCPI?ICN=2434609669V691690^F
 ;;http://localhost:9080/DHPPATCPI?ICN=2434609669V622290&VRESID=V-500-1000010-34486^F
 ;;http://localhost:9080/DHPPATCPI?ICN=2434609669V691690&VRESID=V-500-1000010-34486^P
 ;;http://localhost:9080/DHPPATCPI?ICN=5000001533V676621&VRESID=V-500-1000010-34486^P
 ;;http://localhost:9080/DHPPATCPI?VRESID=V-500-1000010-34486&JSON=J^F
 ;;http://localhost:9080/DHPPATCPI?ICN=2434609669V691690&JSON=J^F
 ;;http://localhost:9080/DHPPATCPI?ICN=2434609669V333690&VRESID=V-500-1000010-34486&JSON=J^F
 ;;http://localhost:9080/DHPPATCPI?ICN=2434609669V691690&VRESID=V-500-1000010-34486&JSON=J^P
 ;;http://localhost:9080/DHPPATCPI?ICN=5000001533V676621&VRESID=V-500-1000010-34486&JSON=J^P
 ;;http://localhost:9080/DHPPATDEMICN^F
 ;;http://localhost:9080/DHPPATDEMICN?ICN=1705550833V176438^F
 ;;http://localhost:9080/DHPPATDEMICN?ICN=1703280833V176438^P
 ;;http://localhost:9080/DHPPATDEMICN?ICN=5000001533V676621^P
 ;;http://localhost:9080/DHPPATDEMICN?JSON=J^F
 ;;http://localhost:9080/DHPPATDEMICN?ICN=2803777648V106941&JSON=J^F
 ;;http://localhost:9080/DHPPATDEMICN?ICN=2803239648V106941&JSON=J^P
 ;;http://localhost:9080/DHPPATDEMICN?ICN=5000001533V676621&JSON=J^P
 ;;http://localhost:9080/DHPPATDXRICN^F
 ;;http://localhost:9080/DHPPATDXRICN?ICN=11111V964144^F
 ;;http://localhost:9080/DHPPATDXRICN?ICN=10101V964144^P
 ;;http://localhost:9080/DHPPATDXRICN?ICN=10101V964144&FRDAT=20120101&TODAT=20100101^F
 ;;http://localhost:9080/DHPPATDXRICN?ICN=10101V964144&FRDAT=20000101&TODAT=20100101^P
 ;;http://localhost:9080/DHPPATDXRICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATDXRICN?JSON=J^F
 ;;http://localhost:9080/DHPPATDXRICN?ICN=11111V964144&JSON=J^F
 ;;http://localhost:9080/DHPPATDXRICN?ICN=10101V964144&JSON=J^P
 ;;http://localhost:9080/DHPPATDXRICN?ICN=10101V964144&FRDAT=20120101&TODAT=20100101&JSON=J^F
 ;;http://localhost:9080/DHPPATDXRICN?ICN=10101V964144&FRDAT=20000101&TODAT=20100101&JSON=J^P
 ;;http://localhost:9080/DHPPATDXRICN?ICN=2434609669V691690&JSON=J^P
 ;;http://localhost:9080/DHPPATENCICN^F
 ;;http://localhost:9080/DHPPATENCICN?ICN=2676604935V204555^F
 ;;http://localhost:9080/DHPPATENCICN?ICN=1180280581V669943^P
 ;;http://localhost:9080/DHPPATENCICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATENCICN?ICN=5000000109V646500^P
 ;;http://localhost:9080/DHPPATENCICN?ICN=5000000109V646500&FRDAT=20151001&TODAT=20141031^F
 ;;http://localhost:9080/DHPPATENCICN?ICN=5000000109V646500&FRDAT=20151001&TODAT=20151031^P
 ;;http://localhost:9080/DHPPATENCICN?JSON=J^F
 ;;http://localhost:9080/DHPPATENCICN?ICN=2676604935V204555&JSON=J^F
 ;;http://localhost:9080/DHPPATENCICN?ICN=1180280581V669943&JSON=J^P
 ;;http://localhost:9080/DHPPATENCICN?ICN=2434609669V691690&JSON=J^P
 ;;http://localhost:9080/DHPPATENCICN?ICN=5000000109V646500&JSON=J^P
 ;;http://localhost:9080/DHPPATENCICN?ICN=5000000109V646500&FRDAT=20151001&TODAT=20141031&JSON=J^F
 ;;http://localhost:9080/DHPPATENCICN?ICN=5000000109V646500&FRDAT=20151001&TODAT=20151031&JSON=J^P
 ;;http://localhost:9080/DHPPATFLGICN^F
 ;;http://localhost:9080/DHPPATFLGICN?ICN=10118V588553^F
 ;;http://localhost:9080/DHPPATFLGICN?ICN=10118V572553^P
 ;;http://localhost:9080/DHPPATFLGICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATFLGICN?JSON=J^F
 ;;http://localhost:9080/DHPPATFLGICN?ICN=10118V588553&JSON=J^F
 ;;http://localhost:9080/DHPPATFLGICN?ICN=10118V572553&JSON=J^P
 ;;http://localhost:9080/DHPPATFLGICN?ICN=2434609669V691690&JSON=J^P
 ;;http://localhost:9080/DHPPATGOLICN^F
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1964446818V742124^F
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124^P
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=20151001&TODAT=20141031^F
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=19930220^P
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124&TODAT=19930220^P
 ;;http://localhost:9080/DHPPATGOLICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATGOLICN?JSON=J^F
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1964446818V742124&JSON=J^F
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124&JSON=J^P
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=20151001&TODAT=20141031&JSON=J^F
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=19930220&JSON=J^P
 ;;http://localhost:9080/DHPPATGOLICN?ICN=1967316818V742124&TODAT=19930220&JSON=J^P
 ;;http://localhost:9080/DHPPATGOLICN?ICN=2434609669V691690&JSON=J^P
 ;;http://localhost:9080/DHPPATHLFICN^F
 ;;http://localhost:9080/DHPPATHLFICN?ICN=5006601536V889384^F
 ;;http://localhost:9080/DHPPATHLFICN?ICN=5000001536V889384^P
 ;;http://localhost:9080/DHPPATHLFICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATHLFICN?ICN=10101V964144^P
 ;;http://localhost:9080/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131101&TODAT=20131028^F
 ;;http://localhost:9080/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131001&TODAT=20131028^P
 ;;http://localhost:9080/DHPPATHLFICN?JSON=J^F
 ;;http://localhost:9080/DHPPATHLFICN?ICN=5006601536V889384&JSON=J^F
 ;;http://localhost:9080/DHPPATHLFICN?ICN=5000001536V889384&JSON=J^P
 ;;http://localhost:9080/DHPPATHLFICN?ICN=2434609669V691690&JSON=J^P
 ;;http://localhost:9080/DHPPATHLFICN?ICN=10101V964144&JSON=J^P
 ;;http://localhost:9080/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131101&TODAT=20131028&JSON=J^F
 ;;http://localhost:9080/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131001&TODAT=20131028&JSON=J^P
 ;;http://localhost:9080/DHPPATIMMICN^F
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1345112108V473342^F
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1345112108V472042^P
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20140101&TODAT=20131231^F
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20120101&TODAT=20131231^P
 ;;http://localhost:9080/DHPPATIMMICN?ICN=10110V004877^P
 ;;http://localhost:9080/DHPPATIMMICN?JSON=J^F
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1345112108V473342&JSON=J^F
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1980844362V905707&JSON=J^P
 ;;http://localhost:9080/DHPPATIMMICN?ICN=10110V004877&JSON=J^P
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20140101&TODAT=20131231&JSON=J^F
 ;;http://localhost:9080/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20120101&TODAT=20131231&JSON=J^P
 ;;http://localhost:9080/DHPPATLABICN^F
 ;;http://localhost:9080/DHPPATLABICN?ICN=1224989029V875306^F
 ;;http://localhost:9080/DHPPATLABICN?ICN=1980844362V905707^P
 ;;http://localhost:9080/DHPPATLABICN?ICN=5000001533V676621^P
 ;;http://localhost:9080/DHPPATLABICN?ICN=1841089454V309194&FRDAT=20150101^P
 ;;http://localhost:9080/DHPPATLABICN?ICN=1841089454V309194&TODAT=20150101^P
 ;;http://localhost:9080/DHPPATLABICN?ICN=1224989029V875306&JSON=J^F
 ;;http://localhost:9080/DHPPATLABICN?ICN=5000001533V676621&JSON=J^P
 ;;http://localhost:9080/DHPPATLABICN?ICN=1841089454V309194&JSON=J^P
 ;;http://localhost:9080/DHPPATLABICN?ICN=1841089454V309194&FRDAT=20150101&TODAT=20131231&JSON=J^F
 ;;http://localhost:9080/DHPPATLABICN?ICN=1841089454V309194&FRDAT=20150101&JSON=J^P
 ;;http://localhost:9080/DHPPATLABICN?ICN=1841089454V309194&TODAT=20150101&JSON=J^P
 ;;http://localhost:9080/DHPPATMEDAICN^F
 ;;http://localhost:9080/DHPPATMEDAICN?ICN=5004300341V359724^F
 ;;http://localhost:9080/DHPPATMEDAICN?ICN=5000000341V359724^P
 ;;http://localhost:9080/DHPPATMEDAICN?ICN=5000000341V359724&FRDAT=20150101&TODAT=20131231^F
 ;;http://localhost:9080/DHPPATMEDAICN?ICN=5000000341V359724&FRDAT=20100101&TODAT=20150101^P
 ;;http://localhost:9080/DHPPATMEDAICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATMEDDICN^F
 ;;http://localhost:9080/DHPPATMEDDICN?ICN=5034000341V359724^F
 ;;http://localhost:9080/DHPPATMEDDICN?ICN=5000000341V359724^P
 ;;http://localhost:9080/DHPPATMEDDICN?ICN=5000000341V359724&FRDAT=20150121&TODAT=20131231^F
 ;;http://localhost:9080/DHPPATMEDDICN?ICN=5000000341V359724&FRDAT=20100101&TODAT=20150101^P
 ;;http://localhost:9080/DHPPATMEDDICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATMEDSICN^F
 ;;http://localhost:9080/DHPPATMEDSICN?ICN=5000430341V359724^F
 ;;http://localhost:9080/DHPPATMEDSICN?ICN=5000000341V359724^P
 ;;http://localhost:9080/DHPPATMEDSICN?ICN=5000000341V359724&FRDAT=20150201&TODAT=20131231^F
 ;;http://localhost:9080/DHPPATMEDSICN?ICN=5000000341V359724&FRDAT=20100101&TODAT=20150101^P
 ;;http://localhost:9080/DHPPATMEDSICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATMEDSICN?ICN=2664798402V619785^P
 ;;http://localhost:9080/DHPPATMEDSICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATOBSICN^F
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5008800352V586511^F
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511^P
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511&FRDAT=19990101&TODAT=19981231^F
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511&FRDAT=20140901^P
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511&TODAT=20140901^P
 ;;http://localhost:9080/DHPPATOBSICN?ICN=2434609669V691690^P
 ;;http://localhost:9080/DHPPATOBSICN?JSON^F
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5008800352V586511&JSON=J^F
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511&JSON=J^P
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511&FRDAT=19990101&TODAT=19981231&JSON=J^F
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511&FRDAT=20140901&JSON=J^P
 ;;http://localhost:9080/DHPPATOBSICN?ICN=5000000352V586511&TODAT=20140901&JSON=J^P
 ;;http://localhost:9080/DHPPATOBSICN?ICN=2434609669V691690&JSON=J^P
 ;;http://localhost:9080/DHPPATPRCICN^F
 ;;http://localhost:9080/DHPPATPRCICN?ICN=1401399732V262134^F
 ;;http://localhost:9080/DHPPATPRCICN?ICN=1980844362V905707^P
 ;;http://localhost:9080/DHPPATPRCICN?ICN=5000000107V310212^P
 ;;http://localhost:9080/DHPPATPRCICN?ICN=5000000107V310212&FRDAT=19990101&TODAT=19981231^F
 ;;http://localhost:9080/DHPPATPRCICN?ICN=5000000107V310212&FRDAT=19980101&TODAT=19981231^P
 ;;http://localhost:9080/DHPPATPRVICN^F
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1095759922V866498^F
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1095759922V858498^P
 ;;http://localhost:9080/DHPPATPRVICN?ICN=5000000107V310212^P
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1435855215V947437^P
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150401&TODAT=20150301^F
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150101&TODAT=20150301^P
 ;;http://localhost:9080/DHPPATPRVICN?JSON=J^F
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1095759922V888498&JSON=J^F
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1095759922V858498&JSON=J^P
 ;;http://localhost:9080/DHPPATPRVICN?ICN=5000000107V310212&JSON=J^P
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1435855215V947437&JSON=J^P
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150401&TODAT=20150301&JSON=J^F
 ;;http://localhost:9080/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150101&TODAT=20150301&JSON=J^P
 ;;http://localhost:9080/DHPPATTIUICN^F
 ;;http://localhost:9080/DHPPATTIUICN?ICN=9009373208V844454^F
 ;;http://localhost:9080/DHPPATTIUICN?ICN=1709164527V969584^P
 ;;http://localhost:9080/DHPPATTIUICN?ICN=1709164527V969584&FRDAT=19980101&TODAT=19970101^F
 ;;http://localhost:9080/DHPPATTIUICN?ICN=1709164527V969584&FRDAT=19960401&TODAT=20000101^P
 ;;http://localhost:9080/DHPPATTIUICN?ICN=8101138763V341567^P
 ;;http://localhost:9080/DHPPATTIUICN?JSON=J^F
 ;;http://localhost:9080/DHPPATTIUICN?ICN=9009373208V844454&JSON=J^F
 ;;http://localhost:9080/DHPPATTIUICN?ICN=1709164527V969584&JSON=J^P
 ;;http://localhost:9080/DHPPATTIUICN?ICN=1709164527V969584&FRDAT=19980101&TODAT=19970101&JSON=J^F
 ;;http://localhost:9080/DHPPATTIUICN?ICN=1709164527V969584&FRDAT=19960101&TODAT=20000101&JSON=J^P
 ;;http://localhost:9080/DHPPATTIUICN?ICN=8101138763V341567&JSON=J^P
 ;;http://localhost:9080/DHPPATVITICN^F
 ;;http://localhost:9080/DHPPATVITICN?ICN=2176288883V515136^F
 ;;http://localhost:9080/DHPPATVITICN?ICN=2176287883V515136^P
 ;;http://localhost:9080/DHPPATVITICN?ICN=1095759922V858498^P
 ;;http://localhost:9080/DHPPATVITICN?ICN=5000000211V385910^P
 ;;http://localhost:9080/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20160220&TODAT=20150223^F
 ;;http://localhost:9080/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20150220&TODAT=20150223^P
 ;;http://localhost:9080/DHPPATVITICN?JSON=J^F
 ;;http://localhost:9080/DHPPATVITICN?ICN=2176288883V515136&JSON=J^F
 ;;http://localhost:9080/DHPPATVITICN?ICN=2176287883V515136&JSON=J^P
 ;;http://localhost:9080/DHPPATVITICN?ICN=1095759922V858498&JSON=J^P
 ;;http://localhost:9080/DHPPATVITICN?ICN=5000000211V385910&JSON=J^P
 ;;http://localhost:9080/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20150220&TODAT=20150101&JSON=J^F
 ;;http://localhost:9080/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20150220&TODAT=20150223&JSON=J^P
 ;;http://localhost:9080/DHPPATVAL^F
 ;;http://localhost:9080/DHPPATVAL?SSN=666000010^F
 ;;http://localhost:9080/DHPPATVAL?SSN=666000010&NAME=TEN,PATIENT^F
 ;;http://localhost:9080/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19290514^F
 ;;http://localhost:9080/DHPPATVAL?NAME=TEN,PATIENT&SSN=666XXX010&DOB=19290514&GENDER=M^F
 ;;http://localhost:9080/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19340514&GENDER=M^F
 ;;http://localhost:9080/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19290514&GENDER=F^F
 ;;http://localhost:9080/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19290514&GENDER=U^F
 ;;http://localhost:9080/DHPPATVAL?NAME=TENXXX,PATIENT&SSN=666000010&DOB=19290514&GENDER=M^F
 ;;http://localhost:9080/DHPPATVAL?NAME=WELCH294,EMORY908&SSN=999331085&DOB=19951028&GENDER=M^P
 ;;http://localhost:9080/DHPCARETEAM^F
 ;;http://localhost:9080/DHPCARETEAM?TEAM=BLUEXX^F
 ;;http://localhost:9080/DHPCARETEAM?TEAM=BLUE^P
 ;;http://localhost:9080/DHPCARETEAM?TEAM=999^F
 ;;http://localhost:9080/DHPCARETEAM?TEAM=5^P
 ;;http://localhost:9080/DHPCARETEAM?JSON=J^F
 ;;http://localhost:9080/DHPCARETEAM?TEAM=BLUEXX&JSON=J^F
 ;;http://localhost:9080/DHPCARETEAM?TEAM=BLUE&JSON=J^P
 ;;http://localhost:9080/DHPCARETEAM?TEAM=999&JSON=J^F
 ;;http://localhost:9080/DHPCARETEAM?TEAM=5&JSON=J^P
 ;;http://localhost:9080/DHPCARETEAMS^P
 ;;http://localhost:9080/DHPCARETEAMS?FRDAT=20151231&TODAT=20141231^F
 ;;http://localhost:9080/DHPCARETEAMS?FRDAT=20121231&TODAT=20141231^P
 ;;http://localhost:9080/DHPCARETEAMS?JSON=J^P
 ;;http://localhost:9080/DHPCARETEAMS?FRDAT=20151231&TODAT=20141231&JSON=J^F
 ;;http://localhost:9080/DHPCARETEAMS?FRDAT=20121231&TODAT=20141231&JSON=J^P
 ;;http://localhost:9080/DHPCARETEAMS?JSON=X^P
 ;;http://localhost:9080/DHPHLOCINSTHLOCNAM^F
 ;;http://localhost:9080/DHPHLOCINSTHLOCNAM?HLOC=ZYXW^F
 ;;http://localhost:9080/DHPHLOCINSTHLOCNAM?HLOC=GENERAL%20MEDICINE^P
 ;;http://localhost:9080/DHPHLOCINSTHLOCNAM?JSON=J^F
 ;;http://localhost:9080/DHPHLOCINSTHLOCNAM?HLOC=ZYXW&JSON=J^F
 ;;http://localhost:9080/DHPHLOCINSTHLOCNAM?HLOC=GENERAL%20MEDICINE&JSON=J^P
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9^P
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9&DIR=D^P
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9&DIR=D&IOE=A^F
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=ZYXW&DIR=D&IOE=I^F
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9&DIR=D&IOE=I^P
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=42&DIR=D^P
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=42&DIR=D&IOE=A^F
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=9999&DIR=D&IOE=I^F
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=42&DIR=D&IOE=I^P
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=715252007&DIR=I^P
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=715252007&DIR=I&IOE=A^F
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=999999999&DIR=I&IOE=I^F
 ;;http://localhost:9080/DHPMAPSVC?MAP=mh2sct&CODE=715252007&DIR=I&IOE=I^P
 ;;http://localhost:9080/DHPGETRESID^F
 ;;http://localhost:9080/DHPGETRESID?RESID=S-500-2-110^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-555^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-V^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-2^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-2-V^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-2-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-2-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-2.98-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-2.98-24^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-4-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-4-500^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-26.13-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-26.13-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-44-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-44-23^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-52-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-52-401022^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-55-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-55-100022^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-63-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-63-1236^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-70-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-70-210^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-74-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-74-501^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-120.5-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-120.5-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-120.8-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-120.8-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-130-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-130-12^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-74-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-74-501^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-216.8-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-216.8-6^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.51-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.51-5^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.52-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.52-3^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.53-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.53-1^F^no data in this file
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.57-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.57-5^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.58-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.58-4^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.59-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-404.59-5^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-601.84-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-601.84-100019^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-601.85-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-601.85-100019^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-601.92-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-601.92-100019^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-627.8-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-627.8-169^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-8925-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-8925-278^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.06-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.06-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.07-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.07-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.11-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.11-110^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.18-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.18-4^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.23-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.23-616^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.23-919^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.71-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000010.71-5^P
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000011-999999999999^F
 ;;http://localhost:9080/DHPGETRESID?RESID=V-500-9000011-110^P
 ;;http://localhost:9080/DHPPATICNALL^P
 ;;http://localhost:9080/DHPPATICNALL?CNT=x&JSON=A^P
 ;;http://localhost:9080/DHPPATICNALL?CNT=5&JSON=T^P
 ;;http://localhost:9080/DHPPATICNALL?CNT=5&JSON=J^P
 ;;http://localhost:9080/DHPPATICNALL?CNT=x^P
 ;;http://localhost:9080/DHPPATICNALL?CNT=5^P
 ;;http://localhost:9080/DHPPATCP^F
 ;;http://localhost:9080/DHPPATCPALL^F
 ;;http://localhost:9080/DHPPATHLF^F
 ;;http://localhost:9080/DHPPATLAB^F
 ;;http://localhost:9080/DHPPATOBS^F
 ;;http://localhost:9080/WXYZ^F
 ;;http://localhost:9080/DHPPATDEMRNG^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=10S20^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=R20^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=10R^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=100R20^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=10R2000^P
 ;;http://localhost:9080/DHPPATDEMRNG?JSON=J^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=10S20&JSON=J^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=R20&JSON=J^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=10R&JSON=J^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=100R20&JSON=J^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=10R2000&JSON=J^F
 ;;http://localhost:9080/DHPPATDEMRNG?ICN=10R20&JSON=J^P
 ;;http://localhost:9080/DHPPATDEMALL^F
 ;;http://localhost:9080/DHPPATDEMALL?ICN=SOM^F
 ;;http://localhost:9080/DHPPATDEMALL?ICN=ALL^P
 ;;http://localhost:9080/DHPPATDEMALL?JSON=J^F
 ;;http://localhost:9080/DHPPATDEMALL?ICN=SOM&JSON=J^F
 ;;http://localhost:9080/DHPPATDEMALL?ICN=ALL&JSON=J^F
 ;;zzzzz
 Q
 ;

SYNLINIT
SYNLINIT ; ven/lgc - Initialize Lab in a new VistA instance ; 10/16/18 10:50am
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ;
 Q  ; Not from top
 ;
 ;@routine-credits
 ;@primary development organization: Vista Expertise Network
 ;@primary-dev: Larry G. Carlson (lgc)
 ;@copyright:
 ;@license: Apache 2.0
 ; https://www.apache.org/licenses/LICENSE-2.0.html
 ;
 ;@last-updated: 2018-09-26
 ;@application: VA-PALS
 ;@version: 1.0
 ;
 ;@sac-exemption
 ; sac 2.2.8 Vendor specific subroutines may not be called directly
 ;  except by Kernel, Mailman, & VA Fileman.
 ; sac 2.3.3.2 No VistA package may use the following intrinsic
 ;  (system) variables unless they are accessed using Kernel or VA
 ;  FileMan supported references: $D[EVICE], $I[O], $K[EY],
 ;  $P[RINCIPAL], $ROLES, $ST[ACK], $SY[STEM], $Z*.
 ;  (Exemptions: Kernel & VA Fileman)
 ; sac 2.9.1: Application software must use documented Kernel
 ;  supported references to perform all platform specific functions.
 ;  (Exemptions: Kernel & VA Fileman)
 ;
EN N IEN4
 S IEN4=$$GETINST
 I '$G(IEN4) D  Q
 . W !,!,"*** You must select an institution to continue.",!,!
 W !,"Continue using institution "_$G(^DIC(4,IEN4,0))
 S %=2 D YN^DICN
 Q:'(%=1)
 ;
 ; Make sure each accession area has an Identity
 D SetAccessionIDs
 ;
 ; Build ^KBAP("LABARR" global
 D BLDKBAP
 ;
 ; Build TMPARR for each test in file 60
 ; Run through TMPARR and update test
 ;   for accession area, institution
 ;   for site/specimen, LOINC, UNITS
 ;D UPDTLAB
 ;
 ; Make sure rollover running
 D SchedRollover
 ;
 ; Run rollover manually now
 W !,!," *** Running Lab Rollover manually now.",!
 D ^LROLOVER
 Q
 ;
 ;
 ; Enter
 ;   nothing required
 ; Return
 ;   0  = failure to select an institution
 ;   >0 = ien of selected entry in INSTITUTION [#4] file
GETINST() ;
 N DIC,CNT,IEN60,NAME,INST,LRAC
 S DIC("A")="Select an institution to assign to the lab tests : "
 S DIC="^DIC(4,",DIC(0)="QEAL" D ^DIC
 I (Y=-1) D  Q 0
 . W !,"*** Sorry.  Cannot continue ***"
 . W !,"*** An institution must be selected. ***"
 Q:'($L($G(Y),"^")=2) 0
 W !,!,"All tests will be accessioned into the "
 W !,Y
 W !,"Institution",!,!
 Q +$G(Y)
 ;
 ;
 ;
 ; Build a global ^KBAP("LABARR") by running through all
 ;  names and synonyms in file 60 and finding entries
 ;  in the LAB LOINC [#95.3] that relate each test.
 ;  The ^KBAP("LABARR") global should
 ;  be helpful in automating the updating of the
 ;  test entries in file 60 with accession area,
 ;  site/specimen, loinc, and, perhaps, unit information
 ; Structure
 ;   Subscript    Comment
 ;   1            "LABARR"
 ;   2            IEN into LABORATORY TEST [#60] file
 ;   3            "95.3" LAB LOINC file indicating source of info
 ;   4            Accession Area for test
 ;   5            Site/Specimen for test
 ;   6            LOINC integer
 ;   7            Full LOINC with checksum digit
 ;   8            Test name
 ;   9            UNITS for test result
 ;
 ;  e.g.
 ;^KBAP("LABARR",1,95.3,"HEM/BC","Body fluid, unsp",6743,"6743-9","WBC","10*6/L")=""
 ; Enter
 ;   nothing required
 ; Return
 ;   ^KBAP("LABARR" global built
BLDKBAP K ^KBAP("LABARR");
 S F60IEN=0
BNAME F  S F60IEN=$O(^LAB(60,F60IEN)) Q:'F60IEN  D
 . S F60NAME=$$UP^XLFSTR($P($G(^LAB(60,F60IEN,0)),"^"))
 . I $L(F60NAME)<3 W !,"NAME :",F60IEN," ",F60NAME
 . D GET953(F60IEN,F60NAME)
 S F60IEN=0
BSYN F  S F60IEN=$O(^LAB(60,F60IEN)) Q:'F60IEN  D
 . S F60SYN=""
 . F  S F60SYN=$O(^LAB(60,F60IEN,5,"B",F60SYN)) Q:($TR(F60SYN," ")="")  D
 .. I $L(F60SYN)<3 W !,"SYNONYM: ",F60IEN," ",F60SYN," ",$$GET1^DIQ(60,F60IEN,.01)
 .. D GET953(F60IEN,F60SYN)
 Q
 ;
 ;
 ; Find entries in 95.3 that match for this test in file 60
 ;Entry
 ;   F60IEN   = IEN of lab test in file 60
 ;   F60NAME  = name of lab test in file 60
 ;Return
 ;   Update ^KBAP("LABARR" global with info on this test
GET953(F60IEN,F60NAME) ; Data from LAB LOINC [95.3]
 ; Find potential matches in 95.3
 N SearchName,SearchNameLength
 ; Back off 1 character in the name of the entry in
 ;   file 60 so the next $Q node won't pass by the full name
 ;   Save the shortened search name and the length of the
 ;   shortened name
 S SearchName=F60NAME,SearchNameLength=$L(SearchName)
 ;
 ; Use the LAB LOINC file "E" cross reference to pair with
 ;  test entries in file 60
 S NODE=$NA(^LAB(95.3,"E",SearchName))
 ; We are done with further searching in the E cross reference
 ;   when we have passed our search string
 F  S NODE=$Q(@NODE) Q:'($E($QS(NODE,3),1,SearchNameLength)[SearchName)  D
 . W !,NODE
 . N LabLoincIEN,LabLoinc0node,LabAccArea64061ien,LabAccessionArea
 . N LabLoincFull,LabLoincShortName,LabLoincCmptIEN
 . N LabLoincComponentName,LabElectronicCodesIEN,SYSTEM
 . N Units,LabSiteSpecimen
 . S LabLoincIEN=$QS(NODE,4)
 . Q:'$G(LabLoincIEN)
 .; Quit if CLASSTYPE is not LABORATORY
 . Q:($G(^LAB(95.3,LabLoincIEN,3))>2)
 .; Quit if STATUS is DEL, TRIAL, or DISCOURAGED
 . Q:'($P($G(^LAB(95.3,LabLoincIEN,4)),"^")="")
 . S LoincFullySpecifiedName=$G(^LAB(95.3,LabLoincIEN,80))
 . S LabLoinc0node=$G(^LAB(95.3,LabLoincIEN,0))
 . S LabAccArea64061ien=$P(LabLoinc0node,"^",11)
 . S LabAccessionArea=$P($G(^LAB(64.061,LabAccArea64061ien,0)),"^")
 . S LabLoincFull=LabLoincIEN_"-"_$P(^LAB(95.3,LabLoincIEN,0),"^",15)
 . S LabLoincShortName=$G(^LAB(95.3,LabLoincIEN,81))
 .; Get Lab LOINC Component [95.31] entry
 . S LabLoincCmptIEN=$P(LabLoinc0node,"^",2)
 . S LabLoincComponentName=$G(^LAB(95.31,LabLoincCmptIEN,0))
 . S LabElectronicCodesIEN=$P(LabLoinc0node,"^",8)
 . Q:'$G(LabElectronicCodesIEN)
 . S LabSiteSpecimen=$G(^LAB(64.061,LabElectronicCodesIEN,0))
 . S LabElectronicCodesIEN=$P(LabLoinc0node,"^",14)
 . S Units="unk"
 . S:($G(LabElectronicCodesIEN)>0) Units=$P($G(^LAB(64.061,LabElectronicCodesIEN,0)),"^")
 .;
 . I ((LabLoincComponentName=SearchName)!($E(LabLoincShortName,1,SearchNameLength)=SearchName)) D
 .. S ^KBAP("LABARR",F60IEN,"95.3",LabAccessionArea,LabSiteSpecimen,LabLoincIEN,LabLoincFull,F60NAME,LabLoincIEN,Units)=LoincFullySpecifiedName
 Q
 ;
UPDTLAB ;
 ; Run down ^KBAP("LABARR") and get
 ;   lab60ien
 N TMPARR,IEN60,IEN61,IEN68,ACCAREA,SPECIMEN,SPECIEN,TSTNAME
 N PRPRTY
 S IEN60=0
 F  S IEN60=$O(^LAB(60,IEN60)) Q:'IEN60  D
 . K TMPARR
 . M TMPARR(IEN60)=^KBAP("LABARR",IEN60)
 .; Now update this test with
 . D UPDTTST(.TMPARR)
 Q
 ;
 ; Use passed array to
 ;   Add a new ACCESSION area if one
 ;     doesn't exist
 ;   Update LOINC if site/specimen already exists
 ;   Add new site/specimen and LOINC
UPDTTST(TMPARR) ;
 ; Run down each entry in the array
 N NODE,SNODES,LOINC,TSTNAME,ACCAREA,PRPRTY,UNITS
 N SiteSpecimens
 N IEN60,IEN68,SPECIMEN,IEN61,AAEXIST,SPEXIST,LNCXIST
 S NODE=$NA(TMPARR),SNODE=$P(NODE,")")
 F  S NODE=$Q(@NODE) Q:NODE'[SNODE  D
 .;  Get the VistA accession area [IEN68] that
 .;     corresponds to that in this array entry
 . W !,!,NODE
 . S IEN60=$QS(NODE,1) Q:'IEN60
 . S LOINC=$QS(NODE,5)
 . S TSTNAME=$QS(NODE,7)
 . S ACCAREA=$QS(NODE,3)
 . S UNITS=$QS(NODE,9)
 . S IEN68=$$FDNAANMB(ACCAREA)
 . S SPECIMEN=$QS(NODE,4) ; e.g. Synv fld; Ser/Plas
 .; Translate SPECIMEN string to entries in TOPOGRAPHY [#61]
 .;  file.  Specimen strings with multiple entries (SERUM/PLASMA)
 .;  will translate into a comma delimited
 . S SiteSpecimens=$$FNDSSNBR(SPECIMEN)
 .;
 .; If we have an accession area and one or more site/specimens
 .;   update the test if necessary
 .;
 . I IEN68>0,SiteSpecimens>0 D
 ..;
 ..; Does the test alrady have this accession
 ..;   area under the selected institution?
 ..; If so just bail
 .. S AAEXIST=$$HAVEAA(IEN60,IEN4,IEN68)
 .. I '$G(AAEXIST) D
 ...; Assign the institution and accession area
 ...;  to this test
 ... S SUCCESS=$$ADDAA(IEN60,IEN4,IEN68)
 ..;
 ..; Does the test already have this specimen
 ..;  and the associated LOINC?
 .. N NumberSpecimens S NumberSpecimens=$L(SiteSpecimens,";")
 .. N I F I=1:1:NumberSpecimens S IEN61=$P(SiteSpecimens,";",I) D
 ... S SPEXIST=$D(^LAB(60,IEN60,1,IEN61))
 ... I SPEXIST S LNCXIST=$D(^LAB(60,IEN60,1,IEN61,95.3))
 ... I SPEXIST,LNCXIST Q
 ... S SUCCESS=$$ADDSLNC(IEN60,IEN61,LOINC,UNITS)
 Q
 ;
 ; Check if this test in file 60 already has assigned
 ;   the indicate institution and accession area
HAVEAA(IEN60,IEN4,IEN68) ;
 N I S (RSLT,I)=0
 F  S I=$O(^LAB(60,IEN60,8,I)) Q:'I  D
 . Q:'($P($G(^LAB(60,IEN60,8,I,0)),"^")=IEN4)
 . Q:'($P($G(^LAB(60,IEN60,8,I,0)),"^",2)=IEN68)
 . S RSLT=1
 Q RSLT
 ;
 ; Look up VistA accession area IEN into file 68
 ;   by accession area string found in Loinc.cst
FDNAANMB(ACCAREA) ;
 N ACC,IEN68
 S (IEN68,CNT)=0
 F  S CNT=CNT+1,ACC=$T(ACCAREA+CNT) Q:(ACC="")  D
 . I ACC[ACCAREA S IEN68=$P($T(ACCAREA+CNT),"^",2)
 Q IEN68
 ;
 ;
 ;
ACCAREA ;;
 ;;CHEM^11
 ;;COAG^3
 ;;DRUG/TOX^20
 ;;HEM/BC^10
 ;;FERT^10
 ;;MICRO^12
 ;;SERO^17
 ;;RIA^6
 ;;UA^7
 ;;GAS^9
 ;;PULM^6
 ;;PANEL.CHEM^11
 ;;PANEL.COAG^3
 ;;PANEL.HEM/BC^10
 ;;PANEL.MICRO^12
 ;;PANEL.DRUG/TOX^20
 ;;SPEC^11
 ;;ABXBACT^12
 ;;ALLERGY^11
 ;;CHAL^11
 ;;DRUGDOSE^20
 ;;IO_IN_SALTS+CALS^11
 ;;
 ;
 ; Look up VistA site specimen (topography) IEN into
 ;   file 61 by specimen string
FNDSSNBR(SPECIMEN) ;
 N SPEC,IEN61
 S (IEN61,CNT)=0
 F  S CNT=CNT+1,SPEC=$T(SITESPEC+CNT) Q:(SPEC="")  D
 . S SPEC=$P($P(SPEC,";;",2),"^")
 . I $$UP^XLFSTR(SPEC)=$$UP^XLFSTR(SPECIMEN) D
 .. S IEN61=$P($T(SITESPEC+CNT),"^",2)
 Q IEN61
 ;
SITESPEC ;;
 ;;Anal^8353
 ;;Amnio fld^6266
 ;;Bil fld^1006
 ;;Bld^70
 ;;Bld.dot^70
 ;;Bld/Urine^70;71
 ;;BldCo^70
 ;;Body fld^72
 ;;Bone mar^319
 ;;Bone marrow^319
 ;;Bone^322
 ;;Brain^151
 ;;Bronchial^3534
 ;;CSF^74
 ;;Cvx^83
 ;;Dentin^4835
 ;;Dial fld^76
 ;;Gast fld^5482
 ;;Genital^5528
 ;;Hair^201
 ;;Liver^56
 ;;Lymph node^213
 ;;Lymph node.FNA^213
 ;;Meconium^6271
 ;;Milk^1054
 ;;Nail^203
 ;;Ocular fld^7740
 ;;Pericard fld^91
 ;;Periton fld^76
 ;;Plas^73
 ;;Plr fld^77
 ;;Saliva^134
 ;;Semen^5864
 ;;Ser^72
 ;;Ser/Plas^72;73
 ;;Ser/Plas/Bld^72;73;70
 ;;Ser/Plas/Urine^72;73;71
 ;;Skin^315
 ;;Stool^138
 ;;Sweat^1047
 ;;Synv fld^78
 ;;Tear^7972
 ;;Tiss^8729
 ;;Tiss.FNA^8729
 ;;Unk sub^999
 ;;Urethra^75
 ;;Urine^71
 ;;Urine sed^71
 ;;Urine+Ser/Plas^72;73;71
 ;;Vag^237
 ;;Vitr fld^7740
 ;;
 ;
 ;   get accession area
 ;   site/specimen
 ;      find 61 IEN for that site specimen
 ;   get loinc code (first piece of "-"
 ;   if this lab does not have this accession area
 ;      update lab with new accession area
 ;   update lab test with
 ;      new? site specimen
 ;      loinc
 ;
 ; Information available in  Loinc.cvs
 ;1 LOINC_NUM
 ;2 COMPONENT
 ;3 PROPERTY
 ;4 TIME_ASPCT
 ;5 SYSTEM
 ;6 SCALE_TYP
 ;7 METHOD_TYP
 ;8 CLASS
 ;9 VersionLastChanged
 ;10 CHNG_TYPE
 ;11 DefinitionDescription
 ;12 STATUS
 ;13 CONSUMER_NAME
 ;14 CLASSTYPE
 ;15 FORMULA
 ;16 SPECIES
 ;17 EXMPL_ANSWERS
 ;18 SURVEY_QUEST_TEXT
 ;19 SURVEY_QUEST_SRC
 ;20 UNITSREQUIRED
 ;21 SUBMITTED_UNITS
 ;22 RELATEDNAMES2
 ;23 SHORTNAME
 ;24 ORDER_OBS
 ;25 CDISC_COMMON_TESTS
 ;26 HL7_FIELD_SUBFIELD_ID
 ;27 EXTERNAL_COPYRIGHT_NOTICE
 ;28 EXAMPLE_UNITS
 ;29 LONG_COMMON_NAME
 ;30 UnitsAndRange
 ;31 DOCUMENT_SECTION
 ;32 EXAMPLE_UCUM_UNITS
 ;33 EXAMPLE_SI_UCUM_UNITS
 ;34 STATUS_REASON
 ;35 STATUS_TEXT
 ;36 CHANGE_REASON_PUBLIC
 ;37 COMMON_TEST_RANK
 ;38 COMMON_ORDER_RANK
 ;39 COMMON_SI_TEST_RANK
 ;40 HL7_ATTACHMENT_STRUCTURE
 ;41 EXTERNAL_COPYRIGHT_LINK
 ;42 PanelType
 ;43 AskAtOrderEntry
 ;44 AssociatedObservations
 ;45 VersionFirstReleased
 ;46 ValidHL7AttachmentRequest
 ;
 ;
 ;
 ; Add institution and accession area to lab test
 ; e.g. IEN60=174,IEN4=2957,IEN68=11
 ; If the insititution entry doesn't exist
 ;   enter it.  If the institution does exist
 ;   but not under the correct accession area
 ;   update this piece.
ADDAA(IEN60,IEN4,IEN68) ;
 N DIERR,FDA,FDAIEN
 S IENS="?+1,"_IEN60_","
 S FDAIEN(1)=IEN4
 S FDA(3,60.11,IENS,.01)=IEN4
 S FDA(3,60.11,IENS,1)=IEN68
 D UPDATE^DIE("","FDA(3)","FDAIEN")
 Q '$D(DIERR)
 ;
 ; Add site/specimen and LOINC to a test
 ; e.g. IEN60=174,IEN61=73,LOINC=3094
 ; If the site/specimen entry doesn't exist
 ;   enter it.  If the site/specimen does exist
 ;   but does not have LOINC, update LOINC
ADDSLNC(IEN60,IEN61,LOINC,UNITS) ;
 N DIERR,FDA,FDAIEN
 S IENS="?+1,"_IEN60_","
 S FDAIEN(1)=IEN61
 S FDA(3,60.01,IENS,.01)=IEN61
 I $G(LOINC) D
 . S FDA(3,60.01,IENS,95.3)=+$G(LOINC)
 I $L($G(UNITS)) D
 . S FDA(3,60.01,IENS,6)=UNITS
 D UPDATE^DIE("","FDA(3)","FDAIEN")
 Q '$D(DIERR)
 ;
 ;
 ; Make sure each accession area has a NUMERICAL IDENTIFIER
 ;  NOTE: Despite the name of the field suggesting a numerical
 ;        entry, the identifier may contain alpha characters.
 ;        However, if an identifier has not been previously
 ;        defined, we will set it to the IEN of the accession
 ;        area in file 68.
SetAccessionIDs ;
 N IEN68 S IEN68=0
 F  S IEN68=$O(^LRO(68,IEN68)) Q:'$G(IEN68)  D
 . Q:$L($G(^LRO(68,IEN68,.4)))
 . N DIERR,FDA,FDAIEN,IENS
 . S IENS=IEN68_","
 . S FDA(3,68,IENS,.4)=IEN68
 . D UPDATE^DIE("","FDA(3)")
 Q
 ;
 ; Schedule lab rollover task
SchedRollover ;
 N IEN19,IEN192,NODE1920,FDA,DIERR,FDAIEN,LROVDT
 ; See if already in 19.2 and scheduled correctly
 N IEN19 S IEN19=$O(^DIC(19,"B","LRTASK ROLLOVER",0))
 I '+$G(IEN19) D  Q
 . W !,!,"*** ERROR.  LRTASK ROLLOVER not in OPTION file.",!
 S LROVDT=$P($$FMADD^XLFDT($$HTFM^XLFDT($H),1),".")_"."_"0005"
 ;
 S FDA(3,19.2,"?+1,",.01)=IEN19
 S FDA(3,19.2,"?+1,",2)=LROVDT
 S FDA(3,19.2,"?+1,",6)="1D"
 D UPDATE^DIE("","FDA(3)")
 ;
 I '$D(DIERR) D  Q
 . W !,!," *** LRTASK ROLLOVER scheduled for ",LROVDT," Daily.",!
 W !,!," *** Tasking LRTASK ROLLOVER failed.  Schedule manually.",!
 Q
 ; ==================== Developer tools ================
 ;
 ; Build arrays of all accession areas and all
 ;  site/specimens saved in ^KBAP("LABARR" global
FindAccAreaAndSiteSpec ;
 N NODE,SNODE
 S NODE=$NA(^KBAP("LABARR")),SNODE=$P(NODE,")")
 F  S NODE=$Q(@NODE) Q:NODE'[SNODE  D
 . S POOACC($QS(NODE,4))=$G(POOACC($QS(NODE,4)))+1
 . S POOSS($QS(NODE,5))=$G(POOSS($QS(NODE,5)))+1
 Q
 ;
ShowAccAreaSiteSpec(AccArea,SiteSpecimen) ;
 N NODE,SNODE,T60IEN,T60NAME
 S NODE=$NA(^KBAP("LABARR")),SNODE=$P(NODE,")")
 F  S NODE=$Q(@NODE) Q:NODE'[SNODE  D
 . I $L($G(AccArea))>0,$QS(NODE,4)=AccArea D
 .. W !,NODE,"=",@NODE
 .. S T60IEN=$QS(NODE,2),T60NAME=$P($G(^LAB(60,T60IEN,0)),"^")
 .. W !,T60IEN," ",T60NAME
 . I $L($G(SiteSpecimen))>0,$QS(NODE,5)=SiteSpecimen D
 .. W !,NODE,"=",@NODE
 .. S T60IEN=$QS(NODE,2),T60NAME=$P($G(^LAB(60,T60IEN,0)),"^")
 .. W !,T60IEN," ",T60NAME
 Q
DispTestWithLOINC ;
 N NODE,SNODE,DONE,TOT953
 S NODE=$NA(^LAB(60)),SNODE=$P(NODE,")")
 S DONE=0
 F  S NODE=$Q(@NODE) Q:NODE'[SNODE  D  Q:DONE
 . I $QS(NODE,2)?.A S DONE=1 Q
 . I $QS(NODE,3)=0 W !,NODE,"=",@NODE
 . I $QS(NODE,5)["95.3" D
 .. W !," ----- ",NODE,"=",@NODE
 .. S TOT953=$G(TOT953)+1
 W !,"Total site/specimen entries with LOINC :",TOT953
 Q
 ;
GetProperty ;
 N NODE,SNODE,PRPTY
 K POO
 S NODE=$NA(^KBAP("LABARR")),SNODE=$P(NODE,")")
 F  S NODE=$Q(@NODE) Q:NODE'[SNODE  D
 . S PRPTY=$P(@NODE,":",4)
 . S:'(PRPTY="") POO(PRPTY)=$G(POO(PRPTY))+1
 Q
 ;
EOR ;End of routine SYNLINIT

SYNQLDM
SYNQLDM ; GPL/GPL - QRDA loader entry routines ;2018-08-17  3:25 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2016-2018
 ;
 Q
 ;
INITMAPS        ; initialize maps
 N G
 S G=$NA(^XTMP("SYNQLD","MAPS"))
 K @G
 N MAP
 ; SOP (payment?)
 S MAP="SOP"
 S @G@(MAP,"CODE","394","OTHER")=""
 ; race
 S MAP="race"
 S @G@(MAP,"CODE","1002-5","AMERICAN INDIAN OR ALASKA NATI")=""
 S @G@(MAP,"CODE","2028-9","ASIAN")=""
 S @G@(MAP,"CODE","2054-5","BLACK OR AFRICAN AMERICAN")=""
 S @G@(MAP,"CODE","2076-8","NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER")=""
 S @G@(MAP,"CODE","2106-3","WHITE")=""
 S @G@(MAP,"CODE","213101","DECLINED TO SPECIFY")=""
 S @G@(MAP,"CODE","9999-4","UNKNOWN BY PATIENT")=""
 ; ethnicity
 S MAP="ethnicity"
 S @G@(MAP,"CODE","21350-2","HISPANIC OR LATINO")=""
 S @G@(MAP,"CODE","2186-5","NOT HISPANIC OR LATINO")=""
 S @G@(MAP,"CODE","213101","DECLINED TO ANSWER")=""
 ; Health Factors - SNOMED
 S MAP="HF"
 S @G@(MAP,"CODE","4525004","ED [ARRIVAL-DEPARTURE] TIME")=""
 S @G@(MAP,"CODE","1748006","VTE COMFIRMED")=""
 S @G@(MAP,"CODE","10378005","TIME DECISION TO ADMIT MADE")=""
 S @G@(MAP,"CODE","225337009","SUICIDE RISK ASSESSMENT")=""
 S @G@(MAP,"CODE","428191000124101","DOCUMENTATION OF CURRENT MEDS")=""
 S @G@(MAP,"CODE","371530004","CLINICAL CONSULTATION REPORT")=""
 S @G@(MAP,"CODE","428171000124102","ADOLESCENT DEPRESSION SCREEN NEGATIVE")=""
 S @G@(MAP,"CODE","428231000124106","MATERNAL POSTPARTUM DEPRESSION CARE")=""
 S @G@(MAP,"CODE","428341000124108","MACULAR EDEMA ABSENT")=""
 S @G@(MAP,"CODE","193350004","MACULAR EDEMA PRESENT")=""
 S @G@(MAP,"CODE","417886001","TREATMENT ADJUSTED PER PROTOCOL")=""
 S @G@(MAP,"CODE","105480006","WRITTEN INFORMATION NOT GIVEN")=""
 S @G@(MAP,"CODE","413318004","WRITTEN INFORMATION GIVEN")=""
 S @G@(MAP,"CODE","226789007","BREAST MILK ADMINISTERED")=""
 S @G@(MAP,"CODE","105480006","PATIENT REFUSED TREATMENT")=""
 S @G@(MAP,"CODE","428171000124102","ADULT DEPRESSION SCREEN")=""
 S @G@(MAP,"CODE","183932001","PROCEDURE CONTRAINDICATED")=""
 ; Health Factors - LOINC
 S @G@(MAP,"CODE","38208-5","STANDARD PAIN ASSMNT TOOL")=""
 S @G@(MAP,"CODE","44249-1","PHQ-9 RESULT")=""
 S @G@(MAP,"CODE","71955-9","PROMIS-29: ")=""
 S @G@(MAP,"CODE","71938-5","MLHFQ")=""
 S @G@(MAP,"CODE","71955-9","PROMIS-29")=""
 S @G@(MAP,"CODE","58151-2","BIMS SCORE")=""
 S @G@(MAP,"CODE","73830-2","FALL RISK ASSESSMENT")=""
 S @G@(MAP,"CODE","73831-0","ADOLESCENT DEPRESSION SCREEN")=""
 S @G@(MAP,"CODE","73832-8","ADULT DEPRESSION SCREEN")=""
 S @G@(MAP,"CODE","69981-9","ASTHMA ACTION PLAN")=""
 ; Encounters - SNOMED
 S MAP="encounters"
 ;S @G@(MAP,"CODE","183452005","IP")=""
 S @G@(MAP,"CODE","185349003","OP")=""
 ;S @G@(MAP,"CODE","4525004","ER")=""
 ;S @G@(MAP,"CODE","10197000","PS")=""
 ;S @G@(MAP,"CODE","10378005","IP")=""
 S @G@(MAP,"CODE","108313002","OP")=""
 ;S @G@(MAP,"CODE","171047005","IO")=""
 ;S @G@(MAP,"CODE","32485007","IP")=""
 ;S @G@(MAP,"CODE","305351004","ICU")=""
 ;S @G@(MAP,"CODE","112689000","IP")=""
 ;S @G@(MAP,"CODE","8715000","IP")=""
 ; Encounters - CPT
 S @G@(MAP,"CODE","92002","OP")=""
 ;S @G@(MAP,"CODE","96150","PS")=""
 S @G@(MAP,"CODE","99201","OP")=""
 ;S @G@(MAP,"CODE","99285","ER")=""
 ;S @G@(MAP,"CODE","90791","PS")=""
 S @G@(MAP,"CODE","99202","OP")=""
 ;S @G@(MAP,"CODE","99285","ER")=""
 S @G@(MAP,"CODE","99381","OP")=""
 ; location
 S MAP="location"
 ;S @G@(MAP,"CODE","OP","CLINIC A")=""
 ;S @G@(MAP,"CODE","OP","VISTA HEALTH CARE")=""
 S @G@(MAP,"CODE","OP","GENERAL MEDICINE")=""
 S @G@(MAP,"CODE","ER","EMERGENCY DEPT")=""
 S @G@(MAP,"CODE","IP","CERT MED SURG")=""
 S @G@(MAP,"CODE","ICU","CERT ICU")=""
 S @G@(MAP,"CODE","PS","CLINIC A")=""
 ; roombed
 S MAP="roombed"
 S @G@(MAP,"CODE","IP","M1-A")=""
 S @G@(MAP,"CODE","ICU","1-A")=""
 S @G@(MAP,"CODE","PS","CLINIC PSYCHIATRY")=""
 ; provider
 S MAP="provider"
 ;S @G@(MAP,"CODE","OP","CQM,HISTORICAL MD")=""
 ;S @G@(MAP,"CODE","OP","USER,THREE")=""
 S @G@(MAP,"CODE","OP","9990000348")=""
 S @G@(MAP,"CODE","ER","CQM,HISTORICAL MD")=""
 S @G@(MAP,"CODE","IP","CQM,HISTORICAL MD")=""
 S @G@(MAP,"CODE","ICU","CQM,HISTORICAL MD")=""
 S @G@(MAP,"CODE","PS","CQM,HISTORICAL MD")=""
 ; admitting regulation
 S MAP="regs"
 S @G@(MAP,"CODE","IP","OBSERVATION (AND) EXAMINATION")=""
 S @G@(MAP,"CODE","ICU","OBSERVATION (AND) EXAMINATION")=""
 ; facility treating speciality
 S MAP="facilityTreatingSpeciality"
 S @G@(MAP,"CODE","IP","MEDICAL OBSERVATION")=""
 S @G@(MAP,"CODE","ICU","MEDICAL OBSERVATION")=""
 ; discharge type
 S MAP="dischargeType"
 S @G@(MAP,"CODE","10161009","DISCHARGE TO HOME OR POLICE CU")=""
 ; vitals
 S MAP="vitals"
 S @G@(MAP,"CODE","8462-4","BLOOD PRESSURE")=""
 S @G@(MAP,"CODE","8480-6","BLOOD PRESSURE")=""
 S @G@(MAP,"CODE","39156-5","BMI")=""
 ; VPatientEd
 S MAP="vPatientEd"
 S @G@(MAP,"CODE","11816003","DIET EDUCATION")=""
 S @G@(MAP,"CODE","171047005","DRUGS OF ADDICTION EDUCATION")=""
 ; consults
 S MAP="consults"
 S @G@(MAP,"CODE","103697008","DENTAL")=""
 S @G@(MAP,"CODE","171047005","PHYSICAL REHAB")=""
 ; rad orders - LOINC
 S MAP="rad"
 S @G@(MAP,"CODE","24533-2","ABDOMINAL VESSELS MRI ANGIOGRAM W/CON  IV")=""
 S @G@(MAP,"CODE","24604-1","BREAST MAMMOGRAM DIAGNOSTIC LIMITED")=""
 S @G@(MAP,"CODE","25031-6","BONE SCAN")=""
 S @G@(MAP,"CODE","24665-2","SACRUM AND COCCYX X-RAY")=""
 ; rad orders - SNOMED
 S @G@(MAP,"CODE","113094008","DIAGNOSTIC RADIOGRAPHY OF CHEST, LATERAL")=""
 S @G@(MAP,"CODE","168731009","CHEST XRAY")=""
 S @G@(MAP,"CODE","1748006","VTE Confirmed.")=""
 ; immunizations - CVX
 S MAP="immunizations"
 S @G@(MAP,"CODE","3","MEASLES,MUMPS,RUBELLA (MMR)")=""
 S @G@(MAP,"CODE","8","HEPATITIS B")=""
 S @G@(MAP,"CODE","10","POLIOMYELITIS")=""
 S @G@(MAP,"CODE","20","DIP-TET-a/PERT")=""
 S @G@(MAP,"CODE","21","VARICELLA")=""
 S @G@(MAP,"CODE","33","PNEUMOCOCCAL CONJUGATE PCV23")=""
 S @G@(MAP,"CODE","48","HIB,PRP-T")=""
 S @G@(MAP,"CODE","83","HEPA,PED/ADOL-2")=""
 S @G@(MAP,"CODE","104","HEPA/HEPB ADULT")=""
 S @G@(MAP,"CODE","111","FLU,NASAL")=""
 S @G@(MAP,"CODE","116","ROTOVIRUS,ORAL")=""
 S @G@(MAP,"CODE","140","INFLUENZA")=""
 ; immunizations - SNOMED
 S @G@(MAP,"CODE","442333005","INFLUENZA")=""
 ; VExam LOINC
 S MAP="vExam"
 S @G@(MAP,"CODE","24604-1","MAMMOGRAM")=""
 S @G@(MAP,"CODE","32451-7","MACULAR EXAM")=""
 S @G@(MAP,"CODE","44249-1","PHQ-9 RESULT")=""
 S @G@(MAP,"CODE","54108-6","NEONATAL HEARING EXAM")=""
 S @G@(MAP,"CODE","54109-4","NEONATAL HEARING EXAM")=""
 S @G@(MAP,"CODE","57254-5","FALL RISK ASSESSMENT")=""
 S @G@(MAP,"CODE","58151-2","BIMS SCORE")=""
 S @G@(MAP,"CODE","65853-4","CARDIOVASCULAR RISK")=""
 S @G@(MAP,"CODE","71484-0","CUP TO DISK RATIO EXAM")=""
 S @G@(MAP,"CODE","71486-5","OPTIC DISK EXAM")=""
 S @G@(MAP,"CODE","71938-5","MLHFQ")=""
 S @G@(MAP,"CODE","71955-9","PROMIS-29:")=""
 S @G@(MAP,"CODE","73831-0","ADOLESCENT DEPRESSION SCREEN NEGATIVE")=""
 ; VExam - SNOMED
 S @G@(MAP,"CODE","225337009","SUICIDE RISK ASSESSMENT")=""
 S @G@(MAP,"CODE","91161007","PULSE FOOT EXAM")=""
 S @G@(MAP,"CODE","134388005","DIABETIC FOOT EXAM")=""
 S @G@(MAP,"CODE","252779009","DILATED EYE EXAM")=""
 S @G@(MAP,"CODE","401191002","DIABETIC FOOT CHECK")=""
 S @G@(MAP,"CODE","419775003","VISION EXAM")=""
 S @G@(MAP,"CODE","412726003","LENGTH OF GESTATION AT BIRTH")=""
 S @G@(MAP,"CODE","44413500","ESTIMATED FETAL GESTATIONAL AGE")=""
 S @G@(MAP,"CODE","417491009","NEONATAL HEARING EXAM")=""
 ; VCPT - CPT
 S MAP="vCPT"
 S @G@(MAP,"CODE","99201","OP")=""
 S @G@(MAP,"CODE","90791","PS")=""
 S @G@(MAP,"CODE","99202","OP")=""
 S @G@(MAP,"CODE","99381","OP")=""
 ; VCPT - SNOMED
 ; Commented out by OSE/SMH
 ; Use OS5 instead
 ;S MAP="sct2cpt"
 ;S @G@(MAP,"CODE","394701000","99241")=""
 ;S @G@(MAP,"CODE","170258001","99382")=""
 ;S @G@(MAP,"CODE","371883000","99201")=""
 ;S @G@(MAP,"CODE","185347001","99201")=""
 ;S @G@(MAP,"COD,E""183478001","99381")=""
 ;S @G@(MAP,"CODE","308646001","99238")=""
 ;S @G@(MAP,"CODE","424441002","59426")=""
 ;S @G@(MAP,"CODE","183460006","99218")=""
 ;S @G@(MAP,"CODE","698314001","99241")=""
 ;S @G@(MAP,"CODE","424619006","59425")=""
 ;S @G@(MAP,"CODE","50849002","99281")=""
 ;S @G@(MAP,"CODE","185345009","99213")=""
 ;S @G@(MAP,"CODE","170258001","99383")=""
 ;S @G@(MAP,"CODE","10492003","55810")=""
 ;S @G@(MAP,"CODE","84755001","77427")=""
 ;S @G@(MAP,"CODE","234723000","D1206")=""
 ;S @G@(MAP,"CODE","10745001","59400")=""
 ;S @G@(MAP,"CODE","10178000","66840")=""
 ;S @G@(MAP,"CODE","105355005","99408")=""
 ;S @G@(MAP,"CODE","12350003","44388")=""
 ;S @G@(MAP,"CODE","15163009","27130")=""
 ;S @G@(MAP,"CODE","177184002","59409")=""
 ;S @G@(MAP,"CODE","179344006","27447")=""
 ;S @G@(MAP,"CODE","13767004","65235")=""
 ;S @G@(MAP,"CODE","108241001","90937")=""
 ;S @G@(MAP,"CODE","185349003","99202")=""
 ;S @G@(MAP,"CODE","442333005","90653")=""
 ;S @G@(MAP,"CODE","444783004","45378")=""
 ;S @G@(MAP,"CODE","4525004","99285")=""
 ;S @G@(MAP,"CODE","185349003","99381")=""
 ; labs
 S MAP="labs"
 S @G@(MAP,"CODE","2085-9","HDL CHOLESTEROL")=""
 S @G@(MAP,"CODE","34714-6","PT/INR")=""
 S @G@(MAP,"CODE","2093-3","CHOLESTEROL, TOTAL")=""
 S @G@(MAP,"CODE","12773-8","LDL CHOLESTEROL")=""
 S @G@(MAP,"CODE","13457-7","LDL CHOLESTEROL")=""
 S @G@(MAP,"CODE","13056-7","PLATELET COUNT")=""
 S @G@(MAP,"CODE","10524-7","PAP TEST")=""
 S @G@(MAP,"CODE","17856-6","HEMOGLOBIN A1C")=""
 S @G@(MAP,"CODE","17855-8","HEMOGLOBIN A1C")=""
 S @G@(MAP,"CODE","10508-0","PSA")=""
 S @G@(MAP,"CODE","10351-5","HIV 1 RNA")=""
 S @G@(MAP,"CODE","35266-6","GLEASON SCORE")=""
 S @G@(MAP,"CODE","24467-3","CD4 COUNT")=""
 S @G@(MAP,"CODE","20447-9","HIV 1 RNA")=""
 S @G@(MAP,"CODE","19080-1","PREGNANCY TEST")=""
 S @G@(MAP,"CODE","10674-0","HEPATITIS B SURFACE ANTIGEN")=""
 S @G@(MAP,"CODE","2093-3","CHOLESTEROL, TOTAL")=""
 S @G@(MAP,"CODE","12951-0","TRIGLYCERIDES")=""
 S @G@(MAP,"CODE","11268-0","STREPTOZYME")=""
 S @G@(MAP,"CODE","13217-5","CHLAMYDIA CULTURE")=""
 S @G@(MAP,"CODE","14463-4","CHLAMYDIA CULTURE")=""
 ; gmr allergies snomed to vuid
 S MAP="gmr-allergies"
 S @G@(MAP,"CODE",419474003,4636980)=""
 S @G@(MAP,"CODE",232347008,4637420)=""
 S @G@(MAP,"CODE",419263009,4636804)=""
 S @G@(MAP,"CODE",418689008,4637448)=""
 ;S @G@(MAP,"CODE",232350006) ; MITE POLEN
 S @G@(MAP,"CODE",300913006,4636953)=""
 S @G@(MAP,"CODE",424213003,4637407)=""
 S @G@(MAP,"CODE",91935009,4636971)=""
 S @G@(MAP,"CODE",91934008,4636976)=""
 S @G@(MAP,"CODE",417532002,4637301)=""
 S @G@(MAP,"CODE",300916003,4538971)=""
 S @G@(MAP,"CODE",91930004,4637287)=""
 S @G@(MAP,"CODE",420174000,4637435)=""
 S @G@(MAP,"CODE",425525006,4636665)=""
 S @G@(MAP,"CODE",714035009,4636951)=""
 ; rxnorm to vuid
 S MAP="rxnorm"
 S @G@(MAP,"CODE",1000097,4002480)=""
 S @G@(MAP,"CODE",313585,4012182)=""
 S @G@(MAP,"CODE",314153,4013783)=""
 S @G@(MAP,"CODE",692876,4025906)=""
 S @G@(MAP,"CODE",577154,4025018)=""
 S @G@(MAP,"CODE",860215,4003764)=""
 S @G@(MAP,"CODE",860221,4003765)=""
 S @G@(MAP,"CODE",151226,4024528)=""
 S @G@(MAP,"CODE",198029,4010104)=""
 S @G@(MAP,"CODE",198030,4010106)=""
 S @G@(MAP,"CODE",198031,4010105)=""
 S @G@(MAP,"CODE",198045,4001216)=""
 S @G@(MAP,"CODE",198046,4001218)=""
 S @G@(MAP,"CODE",198047,4001215)=""
 S @G@(MAP,"CODE",199888,4013030)=""
 S @G@(MAP,"CODE",199889,4013031)=""
 S @G@(MAP,"CODE",199890,4013032)=""
 S @G@(MAP,"CODE",205315,4013343)=""
 S @G@(MAP,"CODE",205316,4013342)=""
 S @G@(MAP,"CODE",250983,4013568)=""
 S @G@(MAP,"CODE",311975,4005637)=""
 S @G@(MAP,"CODE",312036,4001214)=""
 S @G@(MAP,"CODE",314119,4005636)=""
 S @G@(MAP,"CODE",317136,4001217)=""
 S @G@(MAP,"CODE",359817,4016739)=""
 S @G@(MAP,"CODE",359818,4016738)=""
 S @G@(MAP,"CODE",636671,4025534)=""
 S @G@(MAP,"CODE",636676,4025535)=""
 S @G@(MAP,"CODE",749289,4025532)=""
 S @G@(MAP,"CODE",749788,4025533)=""
 S @G@(MAP,"CODE",896100,4010112)=""
 S @G@(MAP,"CODE",966531,4017048)=""
 S @G@(MAP,"CODE",993503,4016940)=""
 S @G@(MAP,"CODE",993518,4017073)=""
 S @G@(MAP,"CODE",993536,4024749)=""
 S @G@(MAP,"CODE",993541,4026567)=""
 S @G@(MAP,"CODE",993550,4029871)=""
 S @G@(MAP,"CODE",993557,4026568)=""
 S @G@(MAP,"CODE",993567,4029870)=""
 S @G@(MAP,"CODE",993681,4029872)=""
 S @G@(MAP,"CODE",998671,4002473)=""
 S @G@(MAP,"CODE",998675,4002474)=""
 S @G@(MAP,"CODE",998679,4002475)=""
 N ZI
 S ZI=""
 F  S ZI=$O(@G@(ZI)) Q:ZI=""  D  ;
 . N ZJ S ZJ=""
 . F  S ZJ=$O(@G@(ZI,"CODE",ZJ)) Q:ZJ=""  D  ;
 . . N VAL
 . . S VAL=$O(@G@(ZI,"CODE",ZJ,""))
 . . S @G@(ZI,"VALUE",VAL,ZJ)=""
 . . S @G@("CODE",ZJ,VAL,ZI)=""
 . . S @G@("VALUE",VAL,ZJ,ZI)=""
 Q
 ;
MAP(CDE,MAP)    ; extrinsic returns the Value for the Code in map MAP, which is optional
 N RTN
 N GN S GN=$NA(^XTMP("SYNQLD","MAPS"))
 I '$D(@GN) D INITMAPS
 I $G(CDE)="" Q ""
 I $G(MAP)="" D  Q RTN
 . S RTN=$O(@GN@("CODE",CDE,""))
 I '$D(@GN@(MAP)) S RTN="" Q RTN  ;
 S RTN=$O(@GN@(MAP,"CODE",CDE,""))
 I $O(@GN@(MAP,"CODE",CDE,RTN))'="" S RTN=-1 ; more than one match
 Q RTN
 ;
UNMAP(VAL,MAP)  ; extrinsic returns the Value for the Code in map MAP, which is optional
 N RTN
 N GN S GN=$NA(^XTMP("SYNQLD","MAPS"))
 I '$D(MAP) D  Q RTN
 . S RTN=$O(@GN@("VALUE",VAL,""))
 I '$D(@GN@(MAP)) S RTN="" Q  ;
 S RTN=$O(@GN@(MAP,"VALUE",VAL,""))
 I $O(@GN@(MAP,"VALUE",VAL,RTN))'="" S RTN=-1 ; more than one match
 Q RTN
 ;
GETMAP(RTN,MAP) ; returns an array of the MAP. if MAP is not specified, it returns an
 ; array of the names of all the maps
 N GN S GN=$NA(^XTMP("SYNQLD","MAPS"))
 I '$D(MAP) D  Q  ;
 . N ZI S ZI=""
 . F  S ZI=$O(@GN@(ZI)) Q:ZI=""  D  ;
 . . Q:ZI="CODE"
 . . Q:ZI="VALUE"
 . . S @RTN@(ZI)=""
 I $D(@GN@(MAP)) M @RTN=@GN@(MAP)
 Q
 ;
MAPERR(CDE,MAP,CMT) ; add the map error to the mapping-errors graph
 n meroot s meroot=$$setroot^SYNWD("mapping-errors")
 q:meroot=""
 n meien
 s meien=$o(@meroot@("errors","B",CDE,""))
 i meien="" d  ;
 . s meien=$o(@meroot@("errors"," "),-1)+1
 . s @meroot@("errors",meien,"code")=CDE
 . s @meroot@("errors","B",CDE,meien)=""
 s @meroot@("errors",meien,"map")=$g(MAP)
 i $g(CMT)'="" s @meroot@("errors",meien,"comment")=CMT
 s @meroot@("errors",meien,"count")=$g(@meroot@("errors",meien,"count"))+1
 q
 ;

SYNRGSHM
SYNRGSHM ;ven/gpl - RGNET SHIM ;2019-10-24  3:02 PM
 ;;0.1;VISTA FHIR SERVER;;Aug 17, 2018;Build 46
 ;
 ; (c) George P. Lilly 2019
 ;
 ; Licensed under the Apache License, Version 2.0 (the "License");
 ; you may not use this file except in compliance with the License.
 ; You may obtain a copy of the License at
 ; 
 ; http://www.apache.org/licenses/LICENSE-2.0
 ; 
 ; Unless required by applicable law or agreed to in writing, software
 ; distributed under the License is distributed on an "AS IS" BASIS,
 ; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ; See the License for the specific language governing permissions and
 ; limitations under the License.
 ;
 q
 ;
 ;DETECT(ROUTINE,ARGS,AUTHMODE) ; _rewrite_dhp exit for DHP RGNET SERVICES
DETECT ; _rewrite_dhp exit for DHP RGNET SERVICES
 ; called from VPRJRSP or from %webrsp to detect RGNET URLs for DHP
 ; If RGNET is on the system for mapping...
 IF ROUTINE="" IF $D(^RGNET(996.52)) DO MATCHRG(.ROUTINE,.ARGS,.AUTHNODE)
 ;
 Q
 ;
MATCHRG(ROUTINE,ARGS,AUTHNODE) ; match agains RGNET
 N PATH
 S PATH=$G(HTTPREQ("path"))
 S PATH=$E(PATH,2,$L(PATH))
 Q:PATH=""
 N SYNENTRY
 S SYNENTRY=$O(^RGNET(996.52,"B",PATH,""))
 ;D ^ZTER
 Q:SYNENTRY=""
 Q:$E(PATH,1,3)'="DHP"
 ; D ^ZTER
 S ARGS("command")=PATH
 S ROUTINE="WSRGNET^SYNRGSHM"
 Q
 ;
WSRGNET(RTN,FILTER) ; web service shim for RGNET web services
 N CMD
 S CMD=$G(FILTER("command"))
 Q:CMD=""
 N RGPROC ; RGNET processing routine
 S RGPROC=$$GETRGR(CMD)
 N RGPARM ; RGNET processor parms
 D DHPPARMS("RGPARM",RGPROC)
 ;
 ; initialize parms to null
 ;
 N ZI S ZI=""
 F  S ZI=$O(RGPARM(ZI)) Q:ZI=""  D  ;
 . S @ZI=""
 ;
 ; overwrite with provided parms
 ;
 F  S ZI=$O(FILTER(ZI)) Q:ZI=""  D  ;
 . N X,Y
 . S X=ZI
 . X ^%ZOSF("UPPERCASE")
 . Q:Y=""
 . S Y=$TR(Y,"-_")
 . S @Y=$G(FILTER(ZI))
 ;D ^ZTER
 ;
 ; run the processor
 ;
 ;W !,"running ",RGPROC
 Q:+RGPROC=-1
 X RGPROC
 ;ZWR RETSTA
 ;
 ;M RTN=RETSTA
 S RTN=$G(RETSTA)
 ;
 Q
 ;
GETRGR(SVC) ; extrinsic returns the routine associated with the
 ; the RGNET web service SVC
 ; returns -1 if not found
 N SYNRTN S SYNRTN=-1
 N SYNENTRY,SVCMINUS
 Q:$L(SVC)=0 "-1^COMMAND NOT SPECIFIED"
 S SYNENTRY=$E(SVC,1,$L(SVC)-1)
 F  S SYNENTRY=$O(^RGNET(996.52,"B",SYNENTRY)) Q:SYNENTRY=""  Q:$E(SYNENTRY,1,$L(SVC))=SVC
 Q:SYNENTRY="" "-1^ENTRY NOT FOUND"
 N SYNIEN
 S SYNIEN=$O(^RGNET(996.52,"B",SYNENTRY,""))
 ;
 N HANDLR
 S HANDLR=$$GET1^DIQ(996.52,SYNIEN_",",10)
 I HANDLR="" Q "-1^HANDLER NOT FOUND"
 ;
 ;W !,"DHPR ",$$DHPR(HANDLR),!
 S SYNRTN=$$DHPR(HANDLR)
 ;
 Q SYNRTN
 ;
DHPR(HAND) ; extrinsic returns
 ;the DHP processing routine for the handler HAND
 N ZI,DHPRTN
 S DHPRTN=""
 N HAND1,HAND2
 S HAND1=$P(HAND,"^",1)
 S HAND2=$P(HAND,"^",2)
 F ZI=0:1:10 D  ;
 . N ZL
 . S ZL=$T(@HAND1+ZI^@HAND2)
 . I ZL["SYNDHP" S DHPRTN=ZL
 Q:DHPRTN=""
 N ZE1,ZE2
 S ZE1=$P(DHPRTN,"(",1)
 S ZE2=$P(DHPRTN,"(",2)
 N ZP,ZE3
 S ZE3=".RETSTA"
 F ZP=2:1:$L(ZE2,",") D  ;
 . N ZP1
 . S ZP1=$P(ZE2,",",ZP)
 . S ZP1=$TR(ZP1,")")
 . I $E(ZP1,1,3)="DHP" S ZP1=$E(ZP1,4,$L(ZP1))
 . S ZE3=ZE3_","_ZP1
 ;S ZE2=$TR(ZE2,"DHP","")
 S DHPRTN=ZE1_"("_ZE3_")"
 S DHPRTN=$E(DHPRTN,2,$L(DHPRTN))
 ;
 Q DHPRTN
 ;
DHPPARMS(ARY,CMD) ; pulls the DHP and other parameters out of the line
 N ZP
 F ZP=2:1:$L(CMD,",") D  ;
 . N ZP1
 . S ZP1=$P(CMD,",",ZP)
 . S ZP1=$TR(ZP1,")")
 . I $E(ZP1,1,3)="DHP" S ZP1=$E(ZP1,4,$L(ZP1))
 . S @ARY@(ZP1)=""
 Q
 ;

SYNSYNCH
SYNSYNCH ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
 ;;0.3;VISTA SYNTHETIC DATA LOADER;;Jul 01, 2019;Build 46
 ;
 ; Authored by George P. Lilly 2017-2018
 ;
 q
 ;
URL(WHICH) ; 
 ;q:WHICH="SYN" "http://syn.vistaplex.org/"
 q:WHICH="SYN" "206.189.178.171"
 ;q:WHICH="k8dev" "23.195.69.112"
 q:WHICH="k8dev" "https://vista.dev.openplatform.healthcare/rgnet-web"
 q ""
 ;
SYNCH(VSYS) ; synchronize with another VistA system
 ;
 N FILTER,SRC,ZURL
 S ZURL=""
 S SRC=VSYS
 I $G(VSYS)'="" D  ; a system name is supplied
 . I $L($T(^SYNDTS89))>0 D  ; DHP urls are available
 . . n urlrt ; return for DHP list
 . . d urlrts^SYNDTS89(VSYS)
 . . S ZURL=$G(urlrt(VSYS))
 . . I ZURL="none" S ZURL=""
 I ZURL="" D  ; try hardcoded table
 . S ZURL=$$URL(VSYS)
 ; confirm with user
 S DIR("A")="SOURCE VISTA URL"
 S DIR("B")=ZURL
 S DIR(0)="F^"
 D ^DIR
 Q:X="^"
 S ZURL=X
 S FILTER("source")=SRC
 S FILTER("url")=ZURL
 N RTN
 D WSIDSYNC(.RTN,.FILTER)
 ;
 n root s root=$$setroot^%wd("vista-synch")
 n sroot s sroot=$na(@root@(1,"list","synch"))
 i '$d(@sroot) d  q  ;
 . s RTN=$G(RTN)_"^"_" Synchronize step failed"
 . w RTN(1)
 n return
 d decode^%webjson("RTN","return")
 w !,"System: "_$g(return("result","source"))
 w !,"URL: "_$g(return("result","url"))
 w !,"Matches: "_$g(return("result","match","matchcount"))
 w !,"Patients to Synchronize: "_$g(return("result","match","synchcount"))
 q
 ;
INGEST ; complete the synchronization
 ;
 n root s root=$$setroot^%wd("vista-synch")
 n sroot s sroot=$na(@root@(1,"list","synch"))
 i '$d(@sroot) d  q  ;
 . W !,"No patients to synchronize"
 n url
 s url=$g(@root@(1,"list","url"))
 i url="" d  q  ;
 . w !,"No URL found for Ingestion"
 ; confirm with user
 S DIR("A")="SOURCE VISTA URL"
 i url["rgnet-web" s url=$p(url,"rgnet",1)_"vpr"_$p(url,"rgnet",2)
 S DIR("B")=url
 S DIR(0)="F^"
 D ^DIR
 Q:X="^"
 S url=X
 ;
 n zicn,cnt
 s cnt=0
 s zicn=""
 ;s zicn=$o(@sroot@("")) d  ;
 f  s zicn=$o(@sroot@(zicn)) q:zicn=""  d  ;
 . i $g(@sroot@(zicn,"status"))="loaded" q  ;
 . n filter
 . s filter("id")=zicn
 . s filter("url")=url_"/showfhir?icn="_zicn
 . w !,"Loading patient: "_zicn
 . s @sroot@(zicn,"status")="loaded"
 . n rtn
 . d wsLoadPat^SYNFPUL(.rtn,.filter)
 . i +$g(rtn)=-1 w !,"patient "_zicn_" returned error: "_$g(rtn) q  ; error retrieving patient
 . s @sroot@(zicn,"status")="loaded"
 . i $d(rtn) m @sroot@("zicn","result")=rtn
 q
 ;
BYDFN(VSYS) ; retrieve and ingest one patient identified by DFN on the
 ; remote VistA system
 N FILTER,SRC,ZURL
 S ZURL=""
 S SRC=VSYS
 I $G(VSYS)'="" D  ; a system name is supplied
 . I $L($T(^SYNDTS89))>0 D  ; DHP urls are available
 . . n urlrt ; return for DHP list
 . . d urlrts^SYNDTS89(VSYS)
 . . S ZURL=$G(urlrt(VSYS))
 . . I ZURL="none" S ZURL=""
 I ZURL="" D  ; try hardcoded table
 . S ZURL=$$URL(VSYS)
 ; confirm with user the url for the remote VistA system
 S DIR("A")="SOURCE VISTA URL"
 S DIR("B")=ZURL
 S DIR(0)="F^"
 D ^DIR
 Q:X="^"
 S ZURL=X
 ; prompt for the DFN
 N ZDFN S ZDFN=""
 S DIR("A")="SOURCE PATIENT DFN"
 S DIR("B")=ZDFN
 S DIR(0)="F^"
 D ^DIR
 Q:X="^"
 S ZDFN=X
 ; load the patient
 s FILTER("id")=ZDFN
 s FILTER("url")=ZURL_"/showfhir?dfn="_ZDFN
 w !,"Loading patient DFN: "_ZDFN
 n rtn
 d wsLoadPat^SYNFPUL(.rtn,.FILTER)
 i +$g(rtn)=-1 w !,"patient "_ZDFN_" returned error: "_$g(rtn) q  ; error retrieving patient
 w !,"Patient DFN "_ZDFN_" loaded"
 q
 ;
WSIDSYNC(RTN,FILTER) ; identify patients to synch
 ; FILTER("source")=name of the source
 ; FILTER("url")=url to the source system RGNET services
 ;
 n rslt
 ;
 q:'$$getlist(.RTN,.FILTER,.rslt)
 ;
 d clean("vista-synch")
 ;
 d match("vista-synch",.rslt)
 ;
 d encode^%webjson("rslt","RTN")
 q
 ;
getlist(RTN,FILTER,rslt) ; extrinsic puts list in a graph returns 0 on fail
 ;
 n name,url
 s name=$g(FILTER("source"))
 s url=$g(FILTER("url"))
 i name="" s name="not found"
 s rslt("result","source")=name
 i url="" s url=$$URL(name)
 i url="" s url="not found"
 s rslt("result","url")=url
 i url="not found" d  q 0
 . s rslt("result","status")="url not provided, aborting"
 . d encode^%webjson("rslt","RTN")
 s url=url_"/DHPPATICNALL?JSON=J"
 n gname s gname="vista-synch"
 n root s root=$$setroot^%wd(gname)
 ;
 d  ;
 . n gtmp s gtmp=$g(@root@(0))
 . k @root
 . s @root@(0)=gtmp
 . s rslt("result","graph")=gtmp
 ;
 n zret,json,jtmp
 ;s zret=$$%^%WC(.json,"GET",url)
 s zret=$$GETURL^XTHC10(url,,"jtmp")
 s rslt("result","status")=zret
 d assemble^SYNFPUL("jtmp","json")
 ;w !,"return is: ",zret,!
 ;zwrite json
 ;
 n lien,jary
 s lien=$o(@root@("B",name,""))
 i lien'="" k @root@(lien)
 e  set lien=$order(@root@(" "),-1)+1
 s @root@("B",name,lien)=""
 ;
 set gr=$name(@root@(lien,"list"))
 do decode^%webjson("json",gr)
 s @gr@("name")=name
 s @gr@("url")=$p(url,"/DHPPATICNALL",1)
 ;
 q 1
 ;
clean(zgr) ; clean graph zgr - remove "/s" nodes
 n root s root=$$setroot^%wd(zgr)
 q:root=""
 n groot s groot=$na(@root@(1,"list"))
 n zi s zi=""
 f  s zi=$o(@groot@(zi)) q:zi=""  d  ;
 . i $d(@groot@(zi,"\s")) k @groot@(zi,"\s")
 q
 ; 
match(graph,rslt) ; matches ICNs to local system
 ;
 n root s root=$$setroot^%wd(graph)
 n groot s groot=$na(@root@(1,"list"))
 n intake s intake=$$setroot^%wd("fhir-intake")
 n icndex s icndex=$na(@intake@("POS","ICN"))
 ;
 n matcnt,syncnt,cnt
 s (matcnt,syncnt,cnt)=0
 n zi s zi=""
 f  s zi=$o(@groot@(zi)) q:+zi=0  d  ;
 . s cnt=cnt+1
 . n fien
 . s fien=$o(@icndex@(zi,""))
 . i fien'="" d  ;
 . . s matcnt=matcnt+1
 . . s @groot@(zi,"match")=""
 . . s @groot@(zi,"fien")=fien
 . . n dfn
 . . s dfn=$$ien2dfn^SYNFUTL(fien)
 . . s @groot@(zi,"dfn")=dfn
 . . n newicn
 . . s newicn=$$newIcn2^SYNFPAT(dfn)
 . . i zi'=newicn d  ;
 . . . s @groot@("zi","newIcn")=newicn
 . . . s @groot@("newIcn",newicn)=""
 . . . s @groot@("newIcn",newicn,"oldIcn")=zi
 . . . s @groot@("newIcn",newicn,"dfn",dfn)=""
 . i fien=""  d  ;
 . . i $d(^DPT("AFICN",zi)) d  q  ;
 . . . s matcnt=matcnt+1
 . . . s @groot@(zi,"match")=""
 . . . s @groot@(zi,"fien")=fien
 . . . n dfn
 . . . s @groot@(zi,"dfn")=$o(^DPT("AFICN",zi,""))
 . . s syncnt=syncnt+1
 . . s @groot@(zi,"synch")=""
 . . s @groot@("synch",zi)=""
 s rslt("result","match","icntotal")=cnt
 s rslt("result","match","matchcount")=matcnt
 s rslt("result","match","synchcount")=syncnt
 q
 ;

SYNTSTAPI
SYNTSTAPI ; HC/art - HealthConcourse - run in code unit tests ;07/30/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
EN ;Run unit tests
 ;
 W !!!,"----- Patient Vitals",!
 I $$DOIT D
 .D T1^SYNDHP01
 .W !!
 .D T2^SYNDHP01
 .W !!
 .D T3^SYNDHP01
 W !!!,"----- Patient Immunizations",!
 I $$DOIT D
 .D T1^SYNDHP02
 .W !!
 .D T2^SYNDHP02
 .W !!
 .D T3^SYNDHP02
 W !!!,"----- Patient Conditions",!
 I $$DOIT D
 .D T1^SYNDHP03
 .W !!
 .D T2^SYNDHP03
 .W !!
 .D T6^SYNDHP03
 .W !!
 .D T7^SYNDHP03
 .W !!!,"----- Patients with a Condition",!
 .D T3^SYNDHP03
 .W !!
 .D T4^SYNDHP03
 .W !!
 .D T5^SYNDHP03
 W !!!,"----- Patient Procedures",!
 I $$DOIT D
 .D T1^SYNDHP04
 .W !!
 .D T2^SYNDHP04
 W !!!,"----- Patient Diagnostic Reports",!
 I $$DOIT D
 .D T1^SYNDHP05
 .W !!
 .D T2^SYNDHP05
 .W !!
 .D T3^SYNDHP05
 W !!!,"----- Institution Details for Hospital Location",!
 I $$DOIT D
 .D T1^SYNDHP06
 .W !!
 .D T2^SYNDHP06
 W !!!,"----- Patient Nursing Care Plan Goals",!
 I $$DOIT D
 .D T1^SYNDHP07
 .W !!
 .D T2^SYNDHP07
 .W !!
 .D T3^SYNDHP07
 W !!!,"----- Patient Flags",!
 I $$DOIT D
 .D T1^SYNDHP08
 .W !!
 .D T2^SYNDHP08
 W !!!,"----- Patient Health Factors",!
 I $$DOIT D
 .D T1^SYNDHP09
 .W !!
 .D T2^SYNDHP09
 .W !!
 .D T3^SYNDHP09
 .;D HLFTEST0^SYNDHP09
 .;D HLFTEST1^SYNDHP09
 W !!!,"----- Patient Encounters",!
 I $$DOIT D
 .D T1^SYNDHP40
 .W !!
 .D T2^SYNDHP40
 .W !!
 .D T3^SYNDHP40
 W !!!,"----- Patient Appointments",!
 I $$DOIT D
 .D T1^SYNDHP41
 .W !!
 .D T2^SYNDHP41
 .W !!
 .D T3^SYNDHP41
 W !!!,"----- validate patient",!
 I $$DOIT D
 .D TESTP^SYNDHP43
 .W !!
 .D TESTF1^SYNDHP43
 .W !!
 .D TESTF2^SYNDHP43
 .W !!
 .D TESTF3^SYNDHP43
 .W !!
 .D TESTF4^SYNDHP43
 .W !!
 .D TESTF5^SYNDHP43
 .W !!
 .D T3^SYNDHP43
 W !!!,"----- Patient Demographics",!
 I $$DOIT D
 .D T1^SYNDHP47
 .W !!
 .D T2^SYNDHP47
 .W !!
 .D T3^SYNDHP47
 .W !!
 .D T4^SYNDHP47
 .;D T5^SYNDHP47  ;all patients
 W !!!,"----- Patient Medication Administration",!
 I $$DOIT D
 .;D T1^SYNDHP48  ;all ICNs
 .D T4^SYNDHP48
 .W !!
 .D T5^SYNDHP48
 W !!!,"----- Patient Medication Dispense",!
 I $$DOIT D
 .;D T2^SYNDHP48  ;all ICNs
 .D T6^SYNDHP48
 .W !!
 .D T7^SYNDHP48
 W !!!,"----- Patient Medication Statement",!
 I $$DOIT D
 .;D T3^SYNDHP48  ;all ICNs
 .D T8^SYNDHP48
 .W !!
 .D T9^SYNDHP48
 W !!!,"----- Patient Chem Labs",!
 I $$DOIT D
 .D T1^SYNDHP53
 .W !!
 .D T2^SYNDHP53
 .W !!
 .D T3^SYNDHP53
 W !!!,"----- Patient Providers for Encounters",!
 I $$DOIT D
 .D T1^SYNDHP54
 .W !!
 .D T2^SYNDHP54
 .W !!
 .D T3^SYNDHP54
 W !!!,"----- Patient Observations",!
 I $$DOIT D
 .D T1^SYNDHP56
 .W !!
 .D T2^SYNDHP56
 .W !!
 .D T3^SYNDHP56
 W !!!,"----- Patient Allergies",!
 I $$DOIT D
 .D T1^SYNDHP57
 .W !!
 .D T2^SYNDHP57
 .W !!
 .D T3^SYNDHP57
 .W !!
 .D ALLTEST0^SYNDHP57
 .;D PROTEST^SYNDHP57
 W !!!,"----- Care Team",!
 I $$DOIT D
 .D T1^SYNDHP58
 .W !!
 .D T2^SYNDHP58
 W !!!,"----- Care Teams",!
 I $$DOIT D
 .D T3^SYNDHP58
 .W !!
 .D T4^SYNDHP58
 .W !!
 .D T5^SYNDHP58
 W !!!,"----- Patient Care Plans",!
 I $$DOIT D
 .D T1^SYNDHP59
 .W !!
 .D T2^SYNDHP59
 .W !!
 .D T3^SYNDHP59
 W !!!,"----- Patient Care Plan for a Visit",!
 I $$DOIT D
 .D T4^SYNDHP59
 .W !!
 .D T5^SYNDHP59
 W !!!,"----- Patient TIU Notes",!
 I $$DOIT D
 .D T1^SYNDHP67
 .W !!
 .D T2^SYNDHP67
 .W !!
 .D T3^SYNDHP67
 .W !!
 .D T4^SYNDHP67
 .W !!
 .D T5^SYNDHP67
 W !!!,"----- M Unit Test",!
 .;D T1^SYNDHP69
 W !!!,"----- VistA Record by Resource ID",!
 I $$DOIT D
 .D T1^SYNDHP99
 .W !!
 .D T2^SYNDHP99
 ;
 ;
 QUIT
 ;
DOIT() ;
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 S DIR(0)="YAO"
 S DIR("A")="Do you want to run these? (Y/N): "
 S DIR("B")="N"
 S DIR("?")="Enter Y to run, N to skip."
 ;S DIR("??")="Enter Y to run, N to skip."
 D ^DIR
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) QUIT 0
 QUIT Y
 ;

SYNTSTRS
SYNTSTRS ; HC/art - HealthConcourse - test rest services ;08/12/2019
 ;;1.0;DHP;;Jan 17, 2017;Build 46
 ;;
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
 ;
 QUIT
 ;
EN ;Run service tests
 ;
 W #,!,?10,"HealthConcourse Get VistA Data REST Services Unit Tests",!
 ;
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 S DIR(0)="SO^A:API Unit Tests;G:General Service Testing;I:ICN Batch Tests;U:Service Unit Tests:API Unit Tests"
 S DIR("A")="Type"
 ;S DIR("B")=""
 D ^DIR
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) QUIT
 N TYPE S TYPE=Y
 ;
 I TYPE="U" D UT
 I TYPE="G" D UI
 I TYPE="A" D EN^SYNTSTAPI
 I TYPE="I" D
 . N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 . S DIR(0)="NAO^0:99999999"
 . S DIR("A")="Number of ICNs, 0 for All: "
 . ;S DIR("B")=""
 . S DIR("?")="Enter the number of ICNs to use for each service call test, or 0 for all ICNs."
 . D ^DIR
 . QUIT:$D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT)
 . QUIT:Y=""
 . N NBR S NBR=Y
 . N STARTTM S STARTTM=$$NOW^XLFDT()
 . D ctrl^SYNDTS89(NBR)
 . N ENDTM S ENDTM=$$NOW^XLFDT()
 . N ELAPSED S ELAPSED=$$FMDIFF^XLFDT(ENDTM,STARTTM,3)
 . W !,"Start time:   ",$$FMTE^XLFDT(STARTTM,7),!
 . W "End time:     ",$$FMTE^XLFDT(ENDTM,7),!
 . W "Elapsed time: ",ELAPSED,!
 ;
 QUIT
 ;
 ;--------------------------------------------------------------------------
 ;
UT ;unit test for get VistA data REST services
 ; The SYN REST UNIT TESTS FILE (#2002.1) contains a record for each unit test URL
 ;  .01   URL (RFJ245), [0;1]
 ;  1     PASS/FAIL (RS), [0;2]
 ;
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 S DIR(0)="SABO^A:All services;O:One service"
 S DIR("A")="Mode (A)ll or (O)ne: "
 ;S DIR("B")=""
 D ^DIR
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) QUIT
 N MODE S MODE=Y
 ;
 N SERVER S SERVER=$$GETSERVER()
 I MODE="O" N ONAME S ONAME=$$GETSERVICE()
 ;
 K ^synUnitTestLog
 N LASTRS S LASTRS=""
 N CNTKER S CNTKER=0
 N CNTERR S CNTERR=0
 N TOTTEST S TOTTEST=0
 N CNTPASS S CNTPASS=0
 N TOTPASS S TOTPASS=0
 N TOTFAIL S TOTFAIL=0
 N STARTTM S STARTTM=$$NOW^XLFDT()
 ;
 N RET,RETDATA,RETHDR,STR,URL,URLNAME,URLIEN,URLDESC,URLSTR,URLSRVC,PF,IENS,IDX,TIMEOUT,POS,ANOMALY
 N IEN S IEN=0
 ;F  S IEN=$O(^SYN(2002.1,IEN)) QUIT:IEN>274  D
 F  S IEN=$O(^SYN(2002.1,IEN)) QUIT:'+IEN  D
 . S URL=$$GET1^DIQ(2002.1,IEN,.01)
 . S URLNAME=$P($P(URL,"/",4),"?",1)
 . S URLSRVC=($P(URL,"/",4))
 . S URLSTR=SERVER_URLSRVC
 . I MODE="O",URLNAME'=ONAME QUIT
 . S TOTTEST=TOTTEST+1
 . S PF=$$GET1^DIQ(2002.1,IEN,1,"I")
 . S:PF="P" TOTPASS=TOTPASS+1
 . S:PF="F" TOTFAIL=TOTFAIL+1
 . S URLDESC=""
 . I URLNAME'="" D
 . . S URLIEN=$O(^RGNET(996.52,"B",URLNAME,""))
 . . S IENS=1_","_URLIEN_","
 . . S URLDESC=$$GET1^DIQ(996.52099,IENS,.01)
 . W:URLNAME'=LASTRS !,"-------------------------------------------------------------------",!
 . S LASTRS=URLNAME
 . W !,"***** ",IEN," * ",URLNAME," * ",URLDESC,$S(URL["JSON=J":" (JSON)",1:""),$S(PF="F":" * (Fail)",1:" * (Pass)"),!!
 . W "URL: ",URLSTR,!
 . ; call the service
 . S TIMEOUT=30
 . I (URL["DEMRNG")!(URL["DEMALL") S TIMEOUT=600
 . ;                    (URL,XT8FLG,XT8RDAT,XT8RHDR,XT8SDAT,XT8SHDR,REDIR)
 . S RET=$$GETURL^XTHC10(URLSTR,TIMEOUT,"RETDATA","RETHDR")
 . ; check status of web call
 . I +RET'=200 D  QUIT
 . . W ">>Error from Kernel call: ",+RET_":"_$P(RET,U,2),!!
 . . S CNTKER=CNTKER+1
 . . S:PF="P" ANOMALY(IEN)="Test should pass"
 . . S ^synUnitTestLog(IEN)=">>Error from Kernel call: "_+RET_":"_$P(RET,U,2)_$S(PF="P":"  Test should pass",1:"")
 . S POS=$O(RETDATA(""))
 . I POS="" D  QUIT
 . . W ">>Error: no data returned: ",RET,!!
 . . S CNTERR=CNTERR+1
 . . S:PF="P" ANOMALY(IEN)="Test should pass"
 . . S ^synUnitTestLog(IEN)=$S(PF="F":"Expected ",1:"")_">>Error: no data returned: "_RET_$S(PF="P":"  Test should pass",1:"")
 . I ($P(RETDATA(POS),U,1)=-1)!(RETDATA(POS)["error")!(RETDATA(POS)["ERROR") D  QUIT
 . . W ">>Error from service: ",RETDATA(POS),!!
 . . S CNTERR=CNTERR+1
 . . S:PF="P" ANOMALY(IEN)="Test should pass"
 . . S ^synUnitTestLog(IEN)=$S(PF="F":"Expected ",1:"")_">>Error from service: "_RETDATA(POS)_$S(PF="P":"  Test should pass",1:"")
 . S:PF="F" ANOMALY(IEN)="Test should fail"
 . I MODE="O" D
 . . W "Returned data:",!
 . . N x S x=""
 . . F  S x=$O(RETDATA(x)) QUIT:x=""  D
 . . . W RETDATA(x)
 . . . N y S y=""
 . . . F  S y=$O(RETDATA(x,y)) QUIT:y=""  D
 . . . . W RETDATA(x,y)
 . . W !!
 . E  D
 . . W $S($D(RETDATA(POS,1)):"Partial return data: ",1:"Returned data: "),RETDATA(POS),!!
 . S ^synUnitTestLog(IEN)="Passed"
 . S CNTPASS=CNTPASS+1
 ;
 N ENDTM S ENDTM=$$NOW^XLFDT()
 N ELAPSED S ELAPSED=$$FMDIFF^XLFDT(ENDTM,STARTTM,3)
 W !,"-------------------------------------------------------------------",!!
 W "Total tests:   ",$J(TOTTEST,6),!
 W "Total to pass: ",$J(TOTPASS,6),?33,"Passed: ",$J(CNTPASS,6),!
 W "Total to fail: ",$J(TOTFAIL,6),?33,"Failed: ",$J(CNTKER+CNTERR,6),!
 W ?35,"Kernel call:  ",$J(CNTKER,6),!
 W ?35,"Service call: ",$J(CNTERR,6),!
 ;
 W !,"Start time:   ",$$FMTE^XLFDT(STARTTM,7),!
 W "End time:     ",$$FMTE^XLFDT(ENDTM,7),!
 W "Elapsed time: ",ELAPSED,!
 ;
 S ^synUnitTestLog(0)="HealthConcourse Get VistA Data REST Services Unit Tests"
 S ^synUnitTestLog(.01)="System: "_SERVER
 S ^synUnitTestLog(.1)="Total tests:   "_$J(TOTTEST,6)
 S ^synUnitTestLog(.2)="Total to pass: "_$J(TOTPASS,6)_"    Passed: "_$J(CNTPASS,6)
 S ^synUnitTestLog(.3)="Total to fail: "_$J(TOTFAIL,6)_"    Failed: "_$J(CNTKER+CNTERR,6)
 S ^synUnitTestLog(.4)="Kernel call errors:  "_$J(CNTKER,6)
 S ^synUnitTestLog(.5)="Service call errors: "_$J(CNTERR,6)
 S ^synUnitTestLog(.6)="Start time:   "_$$FMTE^XLFDT(STARTTM,7)
 S ^synUnitTestLog(.7)="End time:     "_$$FMTE^XLFDT(ENDTM,7)
 S ^synUnitTestLog(.8)="Elapsed time: "_ELAPSED
 ;
 I $D(ANOMALY) D
 . W !,"Anomalies:",!
 . W "Test",?9,"Comment",!
 . S x=""
 . F  S x=$O(ANOMALY(x)) QUIT:x=""  D
 . . W "  ",x,?9,ANOMALY(x),!
 . . S ^synUnitTestLog(.9,x)=ANOMALY(x)_" - "_x
 ;
 QUIT
 ;
 ;--------------------------------------------------------------------------
 ;
UI ;User Interface to run service tests
 ;
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 S DIR(0)="SB^P:Pick from lists;U:Enter URL"
 S DIR("A")="Mode: (P)ick from lists, or enter (U)RL"
 ;S DIR("B")=""
 S DIR("?")="Enter P or U"
 S DIR("??")="Enter P or U"
 D ^DIR
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) QUIT
 N MODE S MODE=Y
 ;
 N URL S URL=""
 I MODE="P" D
 . N SERVER S SERVER=$$GETSERVER()
 . QUIT:SERVER=""
 . N SERVICE S SERVICE=$$GETSERVICE()
 . QUIT:SERVICE=""
 . N PARAMS S PARAMS=$$GETPARAMS()
 . S URL=SERVER_SERVICE_PARAMS
 E  D
 . S URL=$$GETURL()
 ;
 QUIT:URL=""
 ;
 W !!,"URL: ",URL,!
 ;
 N TIMEOUT S TIMEOUT=30
 I (URL["DEMRNG")!(URL["DEMALL") S TIMEOUT=300
 N RETDATA,RETHDR
 N RET S RET=$$GETURL^XTHC10(URL,TIMEOUT,"RETDATA","RETHDR")
 ; check status of web call
 I +RET'=200 D  QUIT
 . W ">>Error from Kernel call: ",+RET_":"_$P(RET,U,2),!!
 N POS S POS=$O(RETDATA(""))
 I POS="" D  QUIT
 . W ">>Error: no data returned: ",RET,!!
 I ($P(RETDATA(POS),U,1)=-1)!(RETDATA(POS)["error")!(RETDATA(POS)["ERROR") D  QUIT
 . W ">>Error from service: ",RETDATA(POS),!!
 W "Returned data:",!
 N x S x=""
 F  S x=$O(RETDATA(x)) QUIT:x=""  D
 . W RETDATA(x)
 . N y S y=""
 . F  S y=$O(RETDATA(x,y)) QUIT:y=""  D
 . . W RETDATA(x,y)
 W !!
 ;
 QUIT
 ;
 ;----------------- functions -----------------
 ;
GETSERVER() ;Choose a server name
 ;Returns a server name
 ;
 N STR,n,SERVERS,SERVER,DESC
 S SERVERS(1)="http://localhost:9080/"_U_"localhost"
 W !,"Servers:",!
 W 1,?3,$P(SERVERS(1),"/",3),!
 ;F n=1:1 S STR=$P($T(urlli+n),";;",2) QUIT:STR["urlend"  D
 F n=1:1 S STR=$P($T(urlli+n^SYNDTS89),";;",2) QUIT:STR["urlend"  D
 . S SERVER=$$TRIM^XLFSTR($P(STR,";",1))
 . S DESC=$$TRIM^XLFSTR($P(STR,";",2))
 . S SERVERS(n+1)=SERVER_U_DESC
 . W n+1,?3,$P(STR,"/",3),"   (",$P(SERVERS(n+1),U,2),")",!
 ;
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 S DIR(0)="LA^1:"_n
 S DIR("A")="Choose a Server: "
 ;S DIR("B")=""
 S DIR("?")="Enter Server Number (1-"_n_")"
 S DIR("??")="Enter Server Number (1-"_n_")"
 D ^DIR
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) QUIT ""
 N SERVNBR S SERVNBR=+Y
 W !
 ;
 QUIT $P($G(SERVERS(SERVNBR)),U,1)
 ;
GETSERVICE() ;Choose a service name
 ;Returns a service name
 ;
 N RSNBR S RSNBR=0
 N RSCNT,RSNAMES
 N RSNAME S RSNAME=""
 F  S RSNAME=$O(^RGNET(996.52,"B",RSNAME)) QUIT:RSNAME=""  D
 . QUIT:$E(RSNAME,1,3)'="DHP"
 . QUIT:RSNAME["/"
 . S RSNBR=RSNBR+1
 . S RSNAMES(RSNBR)=RSNAME
 . ;W !,RSNBR,"  ",RSNAMES(RSNBR)
 ;
 N RSLAST S RSLAST=0
 N ITEMCNT S ITEMCNT=0
 S RSNBR=""
 W !!,"Service Names:"
 F  S RSNBR=$O(RSNAMES(RSNBR)) QUIT:RSNBR=""  D
 . S ITEMCNT=ITEMCNT+1
 . S RSLAST=RSNBR
 . I ITEMCNT=3 D
 . . W !,RSNBR-2,"  ",RSNAMES(RSNBR-2),?26,RSNBR-1,"  ",RSNAMES(RSNBR-1),?52,RSNBR,"  ",RSNAMES(RSNBR)
 . . S ITEMCNT=0
 W:ITEMCNT=1 !,RSLAST,"  ",RSNAMES(RSLAST)
 W:ITEMCNT=2 !,RSLAST-1,"  ",RSNAMES(RSLAST-1),?26,RSLAST,"  ",RSNAMES(RSLAST)
 W !
 ;
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 S DIR(0)="LA^1:"_RSLAST
 S DIR("A")="Choose a Service: "
 ;S DIR("B")=""
 S DIR("?")="Enter Service Number (1-"_RSLAST_")"
 S DIR("??")="Enter Service Number (1-"_RSLAST_")"
 D ^DIR
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) QUIT ""
 N RSNBR S RSNBR=+Y
 ;
 QUIT RSNAMES(RSNBR)
 ;
GETPARAMS() ;Define the Parameter(s)
 ;Returns a parameter list
 ;
 W !!,"Define Parameter(s)",!
 N PARAMS S PARAMS=""
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 N PNBR
 F PNBR=1:1 D  QUIT:Y=""
 . S DIR(0)="FAO^3:50"
 . S DIR("A")="P"_PNBR_": "
 . ;S DIR("B")=""
 . S DIR("?")="Enter NAME=VALUE"
 . S DIR("??")="Enter NAME=VALUE"
 . D ^DIR
 . I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) S Y="" QUIT
 . N PARAM S PARAM=Y
 . I PARAM'="",PARAMS'="" S PARAMS=PARAMS_"&"_PARAM
 . I PARAM'="",PARAMS="" S PARAMS="?"_PARAM
 ;
 QUIT PARAMS
 ;
GETURL() ;Enter a URL
 ;Returns a string that should be a URL
 ;
 W !!,"Enter a URL",!
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
 S DIR(0)="FAO^0:245"
 S DIR("A")="URL: "
 ;S DIR("B")=""
 S DIR("?")="Enter a URL"
 S DIR("??")="Enter a URL - server/service?parameters"
 D ^DIR
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) S Y="" QUIT ""
 N URL S URL=Y
 ;
 QUIT URL
 ;
 ;------------------- data -------------------
 ;
urlli ; list of url roots
 ;;http://localhost:9080/;   AWS dev %webreq
 ;;http://ec2-18-208-29-125.compute-1.amazonaws.com:8001/;awsdev;                AWS dev
 ;;http://ec2-18-208-29-125.compute-1.amazonaws.com:9080/;awsdevshm;             AWS dev shim
 ;;https://vista.dev.openplatform.healthcare/rgnet-web/;k8dev;                   k8 dev
 ;;https://vista.dev.openplatform.healthcare/vpr-web/;k8devshm;                  k8 dev shim
 ;;https://vista.demo-staging.openplatform.healthcare/rgnet-web/;k8demstag;      k8 demo-staging
 ;;https://vista.demo-staging.openplatform.healthcare/rgnet-web/;k8demstagshm;   k8 demo-staging shim
 ;;https://vista.demo.openplatform.healthcare/rgnet-web/;k8demo;                 k8 demo
 ;;https://vista.demo.openplatform.healthcare/vpr-web/;k8demoshm;                k8 demo shim
 ;;https://vista-general.dev.openplatform.healthcare/rgnet-web/;targen;          tardis general
 ;;https://vista-general.dev.openplatform.healthcare/vpr-web/;targenshm;         tardis general shim
 ;;https://vista-emergency.dev.openplatform.healthcare/rgnet-web/;taremer;       tardis emergency
 ;;https://vista-emergency.dev.openplatform.healthcare/vpr-web/;taremershm;      tardis emergency shim
 ;;https://vista-specialization.dev.openplatform.healthcare/rgnet-web/;tarspec;  tardis specialization
 ;;https://vista-specialization.dev.openplatform.healthcare/vpr-web/;tarspecshm; tardis specialization shim
 ;;http://shadow.vistaplex.org/;shadvplex;                                       GT.M server
 ;;http://syn.vistaplex.org/;synvplex;                                           GT.M server
 ;;http://localhost:8001/;localhost;                                             localhost
 ;;http://localhost:9080/;localhostshm;localhost shim
 ;;https://vista-sync.dev.openplatform.healthcare/rgnet-web/;gold;
 ;;https://vista-sync.dev.openplatform.healthcare/vpr-web/;goldshm;
 ;;urlend
 Q
 ;

SYNVPR
SYNVPR  ; GPL/GPL - VPR viewing routines ;2019-08-07  3:57 PM
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 10
 ;
 ; Authored by George P. Lilly 2013-2018
 ;
 QUIT
 ;
SELPART()       ; extrinsic which returns the part of the VPR selected
 N ZT
 S ZT(1)="all"
 S ZT(2)="demographics"
 S ZT(3)="reactions"
 S ZT(4)="problems"
 S ZT(5)="vitals"
 S ZT(6)="labs"
 S ZT(7)="meds"
 S ZT(8)="immunizations"
 S ZT(9)="observation"
 S ZT(10)="visits"
 S ZT(11)="appointments"
 S ZT(12)="documents"
 S ZT(13)="procedures"
 S ZT(14)="consults"
 S ZT(15)="flags"
 S ZT(16)="factors"
 S ZT(17)="skinTests"
 S ZT(18)="exams"
 S ZT(19)="education"
 S ZT(20)="insurance"
 K DIR
 S DIR(0)="SO^"
 F ZI=1:1:20 S DIR(0)=DIR(0)_ZI_":"_ZT(ZI)_";"
 S DIR("B")=1
 S DIR("L")="Please select clinical category to view: "
 S DIR("L",1)="1 all          6 labs          11 appointments 16 factors"
 S DIR("L",2)="2 demographics 7 meds          12 documents    17 skinTests"
 S DIR("L",3)="3 reactions    8 immunizations 13 procedures   18 exams"
 S DIR("L",4)="4 problems     9 observation   14 consults     19 education"
 S DIR("L",5)="5 vitals       10 visits       15 flags        20 insurance"
 D ^DIR
 Q ZT(X)
 ;
SELPART2()      ; extrinsic which returns the part of the NHIN extract selected
 N ZT
 S ZT(1)="all"
 S ZT(2)="patient"
 S ZT(3)="allergy"
 S ZT(4)="problem"
 S ZT(5)="vital"
 S ZT(6)="lab"
 S ZT(7)="med"
 S ZT(8)="immunization"
 S ZT(9)="visit"
 S ZT(10)="appointment"
 S ZT(11)="procedure"
 K DIR
 S DIR(0)="SO^"
 F ZI=1:1:11 S DIR(0)=DIR(0)_ZI_":"_ZT(ZI)_";"
 S DIR("B")=1
 S DIR("L")="Please select clinical category to view: "
 S DIR("L",1)="1 all      6 lab          11 procedure"
 S DIR("L",2)="2 patient  7 med          "
 S DIR("L",3)="3 allergy  8 immunization"
 S DIR("L",4)="4 problems 9 visit"
 S DIR("L",5)="5 vitals   10 appointment"
 D ^DIR
 Q ZT(X)
 ;
SELLOAD()      ; extrinsic which returns the part of the FHIR LOAD selected
 N ZT
 S ZT(1)="all"
 S ZT(2)="Patient"
 S ZT(3)="allergy"
 S ZT(4)="conditions"
 S ZT(5)="vitals"
 S ZT(6)="labs"
 S ZT(7)="meds"
 S ZT(8)="immunizations"
 S ZT(9)="encounters"
 S ZT(10)="careplan"
 S ZT(11)="procedures"
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y,DA
 S DIR(0)="SO^"
 F ZI=1:1:11 S DIR(0)=DIR(0)_ZI_":"_ZT(ZI)_";"
 S DIR("B")=1
 S DIR("L")="Please select clinical category to view: "
 S DIR("L",1)="1 all        6 labs          11 procedure"
 S DIR("L",2)="2 patient    7 meds          "
 S DIR("L",3)="3 allergy    8 immunizations"
 S DIR("L",4)="4 conditions 9 encounters"
 S DIR("L",5)="5 vitals     10 careplan"
 D ^DIR
 I $D(DIRUT) Q ""
 Q ZT(X)
 ;
SELFHIR()      ; extrinsic which returns the part of the FHIR LOAD selected
 N ZT
 S ZT(1)="all"
 S ZT(2)="Patient"
 S ZT(3)="Allergy"
 S ZT(4)="Condition"
 S ZT(5)="Observation"
 S ZT(6)="Claim"
 S ZT(7)="MedicationRequest"
 S ZT(8)="Immunization"
 S ZT(9)="Encounter"
 S ZT(10)="CarePlan"
 S ZT(11)="Procedure"
 S ZT(12)="DiagnosticReport"
 S ZT(13)="ExplanationOfBenefit"
 S ZT(14)="ImagingStudy"
 S ZT(15)="Practitioner"
 S ZT(16)="Organization"
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y,DA
 S DIR(0)="SO^"
 F ZI=1:1:16 S DIR(0)=DIR(0)_ZI_":"_ZT(ZI)_";"
 S DIR("B")=1
 S DIR("L")="Please select clinical category to view: "
 S DIR("L",1)="1 all         7 MedicationRequest 13 ExplanationOfBenefit"
 S DIR("L",2)="2 Patient     8 Immunization      14 ImagingStudy"
 S DIR("L",3)="3 Allergy     9 Encounter         15 Practitioner"
 S DIR("L",4)="4 Condition   10 CarePlan         16 Organization"
 S DIR("L",5)="5 Observation 11 Procedure"
 S DIR("L",6)="6 Claim       12 DiagnosticReport"
 D ^DIR
 I $D(DIRUT) Q ""
 Q ZT(X)
 ;
gen ;
 S G="all;demographics;reactions;problems;vitals;labs;meds;immunizations;observation;visits;appointments;documents;procedures;consults;flags;factors;skinTests;exams;education;insurance"
 S ZI=""
 F ZI=1:1 Q:$P(G,";",ZI)=""  D  ;
 . W !," S ZT("_ZI_")="""_$P(G,";",ZI)_""""
 q
 ;
gen2 ;
 S G="all;patient;allergy;problem;vital;lab;med;immunization;visit;appointment;procedure"
 S ZI=""
 F ZI=1:1 Q:$P(G,";",ZI)=""  D  ;
 . W !," S ZT("_ZI_")="""_$P(G,";",ZI)_""""
 q
 ;
PAT()   ; extrinsic which returns a dfn from the patient selected
 S DIC=2,DIC(0)="AEMQ" D ^DIC
 I Y<1 Q 0 ; EXIT
 S DFN=$P(Y,U,1) ; SET THE PATIENT
 Q +Y
 ;
tree(where,prefix,docid,zout)     ; show a tree starting at a node in MXML.
 ; node is passed by name
 ;
 i $g(prefix)="" s prefix="|--" ; starting prefix
 i '$d(SYNJOB) s SYNJOB=$J
 n node s node=$na(^TMP("MXMLDOM",SYNJOB,docid,where))
 n txt s txt=$$CLEAN($$ALLTXT(node))
 w:'$G(DIQUIET) !,prefix_@node_" "_txt
 d oneout(zout,prefix_@node_" "_txt)
 n zi s zi=""
 f  s zi=$o(@node@("A",zi)) q:zi=""  d  ;
 . w:'$G(DIQUIET) !,prefix_"  : "_zi_"^"_$g(@node@("A",zi))
 . d oneout(zout,prefix_"  : "_zi_"^"_$g(@node@("A",zi)))
 f  s zi=$o(@node@("C",zi)) q:zi=""  d  ;
 . d tree(zi,"|  "_prefix,docid,zout)
 q
 ;
oneout(zbuf,ztxt)       ; adds a line to zbuf
 n zi s zi=$o(@zbuf@(""),-1)+1
 s @zbuf@(zi)=ztxt
 q
 ;
ALLTXT(where)     ; extrinsic which returns all text lines from the node .. concatinated
 ; together
 n zti s zti=""
 n ztr s ztr=""
 f  s zti=$o(@where@("T",zti)) q:zti=""  d  ;
 . s ztr=ztr_$g(@where@("T",zti))
 q ztr
 ;
CLEAN(STR)           ; extrinsic function; returns string - gpl borrowed from the CCR package
 ;; Removes all non printable characters from a string.
 ;; STR by Value
 N TR,I
 F I=0:1:31 S TR=$G(TR)_$C(I)
 S TR=TR_$C(127)
 N ZR S ZR=$TR(STR,TR)
 S ZR=$$LDBLNKS(ZR) ; get rid of leading blanks
 QUIT ZR
 ;
LDBLNKS(st)         ; extrinsic which removes leading blanks from a string
 n pos f pos=1:1:$l(st)  q:$e(st,pos)'=" "
 q $e(st,pos,$l(st))
 ;
show(what,docid,zout)     ;
 I '$D(C0XJOB) S C0XJOB=$J
 d tree(what,,docid,zout)
 q
 ;
GET(ZRTN,ZDFN,ZTYP) ;
 I ZTYP="all" S ZTYP=""
 S FILTER("category")="CP;RA;SR"
 D GET^VPRD(.ZRTN,ZDFN,ZTYP,2250101,$$NOW^XLFDT,,,.FILTER)
 Q
 ;
GET2(ZRTN,ZDFN,ZTYP) ;
 I ZTYP="all" S ZTYP=""
 ;D GET^VPRD(.ZRTN,ZDFN,ZTYP)
 D GET^KBAINHIN(.ZRTN,ZDFN,ZTYP) ; CALL NHINV ROUTINES TO PULL XML
 Q
 ;
PARSE(INXML)    ;
 K ^TMP("MXMLERR",$J)
 Q $$EN^MXMLDOM(INXML,"W")
 ;
VPR     ;
 N ZDFN,ZTYPE
 ;N ZTMP
 S ZDFN=$$PAT()
 S ZTYPE=$$SELPART()
 D GET(.ZTMP,ZDFN,ZTYPE)
 N DOCID
 S DOCID=$$PARSE(.ZTMP)
 S GN=$NA(^TMP("VPROUT",$J))
 D show(1,DOCID,GN)
 D BROWSE^DDBR(GN,"N","PATIENT "_ZDFN_" "_ZTYPE)
 K @GN,^TMP("MXMLDOM",$J),^TMP("VPR",$J),GN
 q
 ;
wsVPR(VPR,FILTER)       ; get from web service call
 I '$D(DT) N DIQUIET S DIQUIET=1 D DT^DICRW
 N ZDFN,ZTYPE
 ;
 S DUZ=$$DUZ^SYNDHP69
 ;N ZTMP
 S ZDFN=$G(FILTER("patientId"))
 I ZDFN="" S ZDFN=$G(FILTER("patientID"))
 I ZDFN="" S ZDFN=$G(FILTER("patientid"))
 I ZDFN="" S ZDFN=$G(FILTER("dfn"))
 I ZDFN="" D  ;
 . N ICN S ICN=$G(FILTER("icn"))
 . I ICN="" Q  ;
 . S ZDFN=$O(^DPT("AFICN",ICN,""))
 I ZDFN="" D  ; try ien
 . N IEN S IEN=$G(FILTER("ien"))
 . I IEN="" Q  ;
 . S ZDFN=$$ien2dfn^SYNFUTL(IEN)
 I ZDFN="" S ZDFN=2
 S ZTYPE=$G(FILTER("domain"),"all")
 ; gpl FHIR project 9/15/2018
 s FILTER("category")="SR;RA;CP"
 D GET(.ZTMP,ZDFN,ZTYPE)
 I $G(FILTER("format"))="xml" D  Q  ;
 . S HTTPRSP("mime")="text/xml"
 . M VPR=ZTMP
 N DOCID
 S DOCID=$$PARSE(.ZTMP)
 S HTTPRSP("mime")="text/html"
 S VPR=$NA(^TMP("VPROUT",$J))
 K @VPR
 S @VPR="<!DOCTYPE HTML><html><head></head><body><pre>"
 D show(1,DOCID,VPR)
 S @VPR@($O(@VPR@(""),-1)+1)="</pre></body></html>"
 D ADDCRLF^SYNWEBUT(.VPR)
 ;D BROWSE^DDBR(GN,"N","PATIENT "_ZDFN_" "_ZTYPE)
 ;K @GN,^TMP("MXMLDOM",$J),^TMP("VPR",$J),GN
 q
 ;
NHIN    ;
 N ZDFN,ZTYPE
 ;N ZTMP
 S ZDFN=$$PAT()
 S ZTYPE=$$SELPART2()
 D GET2(.ZTMP,ZDFN,ZTYPE)
 N DOCID
 S DOCID=$$PARSE(.ZTMP)
 S GN=$NA(^TMP("VPROUT",$J))
 D show(1,DOCID,GN)
 D BROWSE^DDBR(GN,"N","PATIENT "_ZDFN_" "_ZTYPE)
 K @GN,^TMP("MXMLDOM",$J),^TMP("VPR",$J),GN
 q
 ;
LABS    ;
 S DFN=$$PAT()
 K OUT
 D LIST^C0CLABS
 S GN=$NA(^TMP("VPROUT",$J))
 K @GN
 M @GN=OUT
 D BROWSE^DDBR(GN,"N","PATIENT "_DFN_" LABS FROM CCR PACKAGE")
 K @GN
 Q
 ;
CCRXML  ;
 S DFN=$$PAT()
 K OUT
 D CCRRPC^C0CCCR(.OUT,DFN)
 S GN=$NA(^TMP("VPROUT",$J))
 K @GN
 M @GN=OUT
 D BROWSE^DDBR(GN,"N","PATIENT "_DFN_" CCR XML")
 K @GN
 Q
 ;
CCR     ;
 S DFN=$$PAT()
 N ZTMP
 D CCRRPC^C0CCCR(.ZTMP,DFN)
 K ZTMP(0)
 N ZCCR S ZCCR=$NA(^TMP("SYNVPR","CCR"))
 K @ZCCR
 M @ZCCR=ZTMP
 N DOCID
 S DOCID=$$PARSE(ZCCR)
 I $D(^TMP("MXMLERR",$J)) S $EC=",U-ERROR,"
 I DOCID=0
 S GN=$NA(^TMP("VPROUT",$J))
 K @GN
 D show(1,DOCID,GN)
 D BROWSE^DDBR(GN,"N","PATIENT "_DFN_" CCR XML")
 K @GN,@ZCCR
 Q
 ;
CCDA    ;
 S DFN=$$PAT()
 N ZTMP
 D CCDARPC^KBAICDA(.ZTMP,DFN)
 K ZTMP(0)
 N ZCCDA S ZCCDA=$NA(^TMP("SYNVPR",$J,"CCDA"))
 K @ZCCDA
 M @ZCCDA=@ZTMP
 N DOCID
 S DOCID=$$PARSE(ZCCDA)
 I $D(^TMP("MXMLERR",$J)) S $EC=",U-ERROR,"
 I DOCID=0
 S GN=$NA(^TMP("VPROUT",$J))
 K @GN
 D show(1,DOCID,GN)
 D BROWSE^DDBR(GN,"N","PATIENT "_DFN_" CCDA XML")
 K @GN,@ZCCDA
 Q
 ;
LOADSTAT ; [Public] Load Log via FM Browser; OPT: SYN LOAD LOG
 N ZDFN,ZTYPE
 S ZDFN=$$PAT()
 Q:'ZDFN
 S ZTYPE=$$SELLOAD()
 Q:ZTYPE=""
 N ROOT S ROOT=$$setroot^SYNWD("fhir-intake")
 Q:ROOT=""
 N IEN S IEN=$O(@ROOT@("DFN",ZDFN,""))
 Q:IEN=""
 N GROOT
 I ZTYPE="all" S GROOT=$NA(@ROOT@(IEN,"load"))
 E  S GROOT=$NA(@ROOT@(IEN,"load",ZTYPE))
 N GN S GN=$NA(^TMP("SYNOUT",$J))
 K @GN
 D GTREE(GROOT,9,,,GN)
 D BROWSE^DDBR(GN,"N","PATIENT "_ZDFN_" "_ZTYPE)
 K @GN
 q
 ;
FHIRJSON ; [Public] Loaded FHIR via FM Broswer; OPT: SYN FHIR JSON
 N ZDFN,ZTYPE
 S ZDFN=$$PAT()
 Q:'ZDFN
 S ZTYPE=$$SELFHIR()
 Q:ZTYPE=""
 N ROOT S ROOT=$$setroot^SYNWD("fhir-intake")
 Q:ROOT=""
 N IEN S IEN=$O(@ROOT@("DFN",ZDFN,""))
 Q:IEN=""
 N GROOT
 I ZTYPE="all" S GROOT=$NA(@ROOT@(IEN,"json"))
 E  D  ;
 . S GROOT=$NA(^TMP("SYNFHIR",$J))
 . K @GROOT
 . D getIntakeFhir^SYNFHIR(GROOT,,ZTYPE,IEN)
 N GN S GN=$NA(^TMP("SYNOUT",$J))
 K @GN
 D GTREE(GROOT,9,,,GN)
 D BROWSE^DDBR(GN,"N","PATIENT "_ZDFN_" "_ZTYPE)
 K @GN
 q
 ;
listm(out,in)   ; out is passed by name in is passed by reference
 n i s i=$q(@in@(""))
 f  s i=$q(@i) q:i=""  d oneout^SYNVPR(out,i_"="_@i)
 q
 ;
SMART   ;
 S DFN=$$PAT()
 S ZTYPE=$$SELPART2()
 K G,OUT
 D EN^C0SMART(.G,DFN,ZTYPE,"raw")
 S GN=$NA(^TMP("SYNOUT",$J))
 K @GN
 D listm(GN,"G")
 D BROWSE^DDBR(GN,"N","PATIENT "_DFN_" SMART MUMPS ARRAY")
 K @GN,G,OUT
 Q
 ;
SMARTRDF        ;
 S DFN=$$PAT()
 S ZTYPE=$$SELPART2()
 K G,OUT
 D EN^C0SMART(.G,DFN,ZTYPE,"rdf")
 N ZRDF S ZRDF=$NA(^TMP("SYNVPR","RDF"))
 K @ZRDF
 M @ZRDF=G
 N DOCID
 S DOCID=$$PARSE(ZRDF)
 I $D(^TMP("MXMLERR",$J)) S $EC=",U-ERROR,"
 I DOCID=0 S $EC=",U-ERROR,"
 S GN=$NA(^TMP("VPROUT",$J))
 K @GN
 D show(1,DOCID,GN)
 D BROWSE^DDBR(GN,"N","PATIENT "_DFN_" RDF XML")
 K @GN,@ZRDF
 Q
 ;
VPRM    ;
 N ZDFN,ZTYPE
 N ZTMP
 S ZDFN=$$PAT()
 S ZTYPE=$$SELPART()
 D GETPAT^SYNVPRE(.ZTMP,ZDFN,ZTYPE)
 S GN=$NA(^TMP("VPROUT",$J))
 K @GN
 D listm(GN,"ZTMP")
 D BROWSE^DDBR(GN,"N","PATIENT "_ZDFN_" "_ZTYPE)
 K @GN,^TMP("VPR",$J),GN
 q
 ;
wsGLOBAL(OUT,FILTER)    ; dump a global to the browser as text
 S HTTPRSP("mime")="text/plain"
 N Q S Q=""""
 S OUT=$NA(^TMP("SYNOUT",$J))
 K @OUT
 N ROOT S ROOT=$G(FILTER("root"))
 Q:ROOT=""
 I $G(FILTER("local"))'=1 S ROOT="^"_ROOT
 N ORIG,OL S ORIG=ROOT,OL=$QL(ROOT) ; Orig, Orig Length
 F  S ROOT=$Q(@ROOT) Q:$G(ROOT)=""  Q:$NA(@ROOT,OL)'=$NA(@ORIG,OL)  D
 . N %,V S V=$$CLEAN(@ROOT)
 . I V'["e",+$P(V,"E")=V ; numeric
 . E  S V=$NAME(%(V)),V=$E(V,3,$L(V)-1) ; This double quotes internal quotes and also adds quotes on the outside
 . S @OUT@($O(@OUT@(""),-1)+1)=ROOT_"="_V
 S @OUT@(.1)="OSEHRA ZGO Export: M Web Server ZWRITE Export"
 S @OUT@(.2)=$TR($TR($$FMTE^XLFDT($$NOW^XLFDT,"9")," ","-"),"@"," ")_" ZWR"
 D ADDCRLF^SYNWEBUT(.OUT)
 Q
 ;
GTREE(ROOT,DEPTH,PREFIX,LVL,RSLT)    ; show a global in a tree
 ; if RSLT, a named reference, is present, the output will be put there
 ; otherwise, write to the screen
 ;
 I $G(PREFIX)="" S PREFIX="|--" ; STARTING PREFIX
 I '$D(DEPTH) S DEPTH=1 ; USUALLY THIS IS WHAT WE WANT
 I +$G(LVL)>DEPTH Q  ; ONLY GO THAT DEEP
 N ZGI S ZGI=""
 N ZVAL S ZVAL=$G(@ROOT)
 I $G(LVL)="" D  ;
 . I $G(RSLT)="" W !,ROOT_" "_$G(@ROOT@(0))
 . E  S @RSLT@($O(@RSLT@(" "),-1)+1)=ROOT_" "_$G(@ROOT@(0))
 F  S ZGI=$O(@ROOT@(ZGI)) Q:ZGI=""  D  ;
 . I $O(@ROOT@(ZGI,""))'="" D  ;
 . . I $G(@ROOT@(ZGI))'="" D  ;
 . . . I $G(RSLT)="" W !,PREFIX_ZGI_" ",@ROOT@(ZGI)
 . . . E  S @RSLT@($O(@RSLT@(" "),-1)+1)=PREFIX_ZGI_" "_@ROOT@(ZGI)
 . . E  D  ;
 . . . I $G(RSLT)="" W !,PREFIX_ZGI_" ",$G(@ROOT@(ZGI,0))
 . . . E  S @RSLT@($O(@RSLT@(" "),-1)+1)=PREFIX_ZGI_" "_$G(@ROOT@(ZGI,0))
 . E  D  ;
 . . I $G(RSLT)="" W !,PREFIX_ZGI_" "_$G(@ROOT@(ZGI))
 . . E  S @RSLT@($O(@RSLT@(" "),-1)+1)=PREFIX_ZGI_" "_$G(@ROOT@(ZGI))
 . D GTREE($NA(@ROOT@(ZGI)),DEPTH,"|  "_PREFIX,+$G(LVL)+1,$G(RSLT))
 Q
 ;
wsGtree(OUT,FILTER) ; show an outline form of a global
 I '$D(DT) N DIQUIET S DIQUIET=1 D DT^DICRW
 S HTTPRSP("mime")="text/html"
 S OUT=$NA(^TMP("SYNOUT",$J))
 K @OUT
 N ROOT S ROOT=$G(FILTER("root"))
 Q:ROOT=""
 N LEVEL S LEVEL=$G(FILTER("level"))
 I LEVEL'="" S LEVEL=LEVEL-1
 I $G(FILTER("local"))'=1 S ROOT="^"_ROOT
 I LEVEL="" D GTREE(ROOT,9,,,OUT)
 I LEVEL'="" D GTREE(ROOT,LEVEL,,,OUT)
 I $G(FILTER("mfilter"))'="" D  ;
 . N ZF S ZF=$G(FILTER("mfilter"))
 . N ZR S ZR="^"_$P(ZF,"^",2)
 . Q:ZR="^"
 . I $L($T(@ZR))>0 D  ;
 . . ;S ZF=ZF_"(.OUT)"
 . . ;n % s %=$$@ZF@(.OUT)
 . . I ZF="BAK^VWXPAT" D BAK^VWXPAT(.OUT) Q  ;
 . . I ZF="BAK2^VWXPAT" D BAK2^VWXPAT(.OUT) Q  ;
 S @OUT="<!DOCTYPE HTML><html><head></head><body><pre>"
 S @OUT@($O(@OUT@(""),-1)+1)="</pre></body></html>"
 D ADDCRLF^SYNWEBUT(.OUT)
 Q
 ;

SYNWD
SYNWD     ;ven/gpl - mash graph utilities ; 9/24/17 4:33pm
 ;;1.0;norelease;;feb 27, 2017;Build 10
 ;
 ;
 q
 ;
 ; All the public entry points for handling in mash data are in this routine
 ;
 ; 
 ; graph handling routines
 ;
setroot(graph) ; root of working storage
 quit $$setroot^SYNGRAF(graph)
 ;
rootOf(graph) ; return the root of graph named graph
 quit $$rootOf^SYNGRAF(graph)
 ;
addgraph(graph) ; makes a place in the graph file for a new graph
 do addgraph^SYNGRAF(graph)
 quit
 ;
purgegraph(graph) ; delete a graph
 do purgegraph^SYNGRAF(graph)
 quit
 ;
insert2graph(ary,graph,replace) ; insert a new entry to a graph
 do insert2graph^SYNGRAF(.ary,graph,replace)
 quit
 ;
nameThis(altname) ; returns the id to be used for altname
 ; this will eventually use the context graph and the 
 ; local variable context to query the altname and obtain an id
 quit $$nameThis^SYNGRAF(altname)
 ;
getThis(rary,fn,nocache) ; find a file and read it into rary array  
 do getThis^SYNGRAF(rary,fn,$get(nocache))
 quit
 ;
queryContext(context,locator,property) ; look up project specific 
 ; names and values from the context graph
 ; tbd
 quit $$queryContext^SYNGRAF(context,locator,property)
 ;
queryTag(rtn,tag) ; returns a json/mumps array of tagged items
 do queryTag^SYNGRAF(rtn,tag)
 quit
 ;
fromCache(rary,name,graph) ; return a file from the cache
 do fromCache(rary,name,graph)
 quit
 ;
toCache(arry,name,graph) ; put a file in the cache
 do toCache^SYNGRAF(arry,name,graph)
 quit
 ;
beautify(inary,outary) ; pretty print a line of json
 do beautify^SYNGRAF(inary,outary)
 quit
 ;
ary2file(ary,dir,file) ;
 do ary2file^SYNGRAF(.ary,dir,file)
 quit
 ;
file2ary(ary,dir,file)
 do file2ary^SYNGRAF(.ary,dir,file)
 quit
 ;
 ;
 ;
 ; csv handling routines
 ;
csv2graph(source,graph) ; import a csv file to a graph
 ; graph is optional, will default to csvGraph
 ; source is either a filename which will be found in seeGraph
 ; or a global passed by name usually loaded with FTG^%ZISH
 ;
 d csv2graph^SYNCSV(source,$get(graph))
 quit
 ;
prune(txt) ; extrinsic removes extra quotes
 quit $$prune^SYNCSV(txt)
 ;
delim(ary) ; figures out the cvs delimiter
 ; return -1 if there not found
 ; ary is passed by reference
 ; returns the delimiter
 quit $$delim^SYNCSV(.ary)
 ;
wellformed(ary,delim) ; extrinsic returns 1 if ary is well formed
 ; checks to see that the count of the delimiter is the same
 ; on every line
 ; ary is passed by reference
 ;
 quit $$wellformed^SYNCSV(.ary,delim)
 ;

SYNWEBUT
%webutils ;SLC/KCM -- Utilities for HTTP communications ;2019-11-14  11:50 AM
 ;
UP(X) Q $TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
LOW(X) Q $TR(X,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
 ;
LTRIM(%X) ; Trim whitespace from left side of string
 ; derived from XLFSTR, but also removes tabs
 N %L,%R
 S %L=1,%R=$L(%X)
 F %L=1:1:$L(%X) Q:$A($E(%X,%L))>32
 Q $E(%X,%L,%R)
 ;
URLENC(X) ; Encode a string for use in a URL
 ; Q $ZCONVERT(X,"O","URL")  ; uncomment for fastest performance on Cache
 ; =, &, %, +, non-printable 
 ; {, } added JC 7-24-2012
 N I,Y,Z,LAST
     S Y=$P(X,"%") F I=2:1:$L(X,"%") S Y=Y_"%25"_$P(X,"%",I)
 S X=Y,Y=$P(X,"&") F I=2:1:$L(X,"&") S Y=Y_"%26"_$P(X,"&",I)
 S X=Y,Y=$P(X,"=") F I=2:1:$L(X,"=") S Y=Y_"%3D"_$P(X,"=",I)
 S X=Y,Y=$P(X,"+") F I=2:1:$L(X,"+") S Y=Y_"%2B"_$P(X,"+",I)
 S X=Y,Y=$P(X,"{") F I=2:1:$L(X,"{") S Y=Y_"%7B"_$P(X,"{",I)
 S X=Y,Y=$P(X,"}") F I=2:1:$L(X,"}") S Y=Y_"%7D"_$P(X,"}",I)
 S Y=$TR(Y," ","+")
 S Z="",LAST=1
 F I=1:1:$L(Y) I $A(Y,I)<32 D
 . S CODE=$$DEC2HEX($A(Y,I)),CODE=$TR($J(CODE,2)," ","0")
 . S Z=Z_$E(Y,LAST,I-1)_"%"_CODE,LAST=I+1
 S Z=Z_$E(Y,LAST,$L(Y))
 Q Z
 ;
URLDEC(X,PATH) ; Decode a URL-encoded string
 ; Q $ZCONVERT(X,"I","URL")  ; uncomment for fastest performance on Cache
 ;
 N I,OUT,FRAG,ASC
 S:'$G(PATH) X=$TR(X,"+"," ") ; don't convert '+' in path fragment
 F I=1:1:$L(X,"%") D
 . I I=1 S OUT=$P(X,"%") Q
 . S FRAG=$P(X,"%",I),ASC=$E(FRAG,1,2),FRAG=$E(FRAG,3,$L(FRAG))
 . I $L(ASC) S OUT=OUT_$C($$HEX2DEC(ASC))
 . S OUT=OUT_FRAG
 Q OUT
 ;
REFSIZE(ROOT) ; return the size of glvn passed in ROOT
 Q:'$D(ROOT) 0 Q:'$L(ROOT) 0
 Q:$G(ROOT)="" 0
 N SIZE,I
 S SIZE=0
 S ROOT=$NA(@ROOT)
 I $P($SY,",")=47 G REFSIZEGTM
 I $D(@ROOT)#2 S SIZE=$L(@ROOT)
 ; I $D(@ROOT)>1 S I=0 F  S I=$O(@ROOT@(I)) Q:'I  S SIZE=SIZE+$L(@ROOT@(I))
 N ORIG,OL S ORIG=ROOT,OL=$QL(ROOT) ; Orig, Orig Length
 F  S ROOT=$Q(@ROOT) Q:ROOT=""  Q:($NA(@ROOT,OL)'=$NA(@ORIG,OL))  S SIZE=SIZE+$L(@ROOT)
 S ROOT=ORIG
 Q SIZE
 ;
REFSIZEGTM ; Refsize for GT.M/UTF-8
 I $D(@ROOT)#2 S SIZE=$ZL(@ROOT)
 ; I $D(@ROOT)>1 S I=0 F  S I=$O(@ROOT@(I)) Q:'I  S SIZE=SIZE+$L(@ROOT@(I))
 N ORIG,OL S ORIG=ROOT,OL=$QL(ROOT) ; Orig, Orig Length
 F  S ROOT=$Q(@ROOT) Q:ROOT=""  Q:($NA(@ROOT,OL)'=$NA(@ORIG,OL))  S SIZE=SIZE+$ZL(@ROOT)
 S ROOT=ORIG
 Q SIZE
 ;
VARSIZE(V) ; return the size of a variable
 Q:'$D(V) 0
 N SIZE,I
 S SIZE=0
 I $P($SY,",")=47 G VARSIZEGTM
 I $D(V)#2 S SIZE=$L(V)
 I $D(V)>1 S I="" F  S I=$O(V(I)) Q:'I  S SIZE=SIZE+$L(V(I))
 Q SIZE
 ;
VARSIZEGTM ; Varsize for GT.M/UTF-8
 I $D(V)#2 S SIZE=$ZL(V)
 I $D(V)>1 S I="" F  S I=$O(V(I)) Q:'I  S SIZE=SIZE+$ZL(V(I))
 Q SIZE
 ;
setError(ERRCODE,MESSAGE,ERRARRAY) G setError1
SETERROR(ERRCODE,MESSAGE,ERRARRAY) ; set error info into ^TMP("HTTPERR",$J)
setError1 ;
 ; causes HTTPERR system variable to be set
 ; ERRCODE:  query errors are 100-199, update errors are 200-299, M errors are 500
 ; MESSAGE:  additional explanatory material
 ; ERRARRAY: An Array to use instead of the Message for information to the user.
 ;
 N NEXTERR,ERRNAME,TOPMSG
 S HTTPERR=400,TOPMSG="Bad Request"
 ; query errors (100-199)
 I ERRCODE=101 S ERRNAME="Missing name of index"
 I ERRCODE=102 S ERRNAME="Invalid index name"
 I ERRCODE=103 S ERRNAME="Parameter error"
 I ERRCODE=104 S HTTPERR=404,TOPMSG="Not Found",ERRNAME="Bad key"
 I ERRCODE=105 S ERRNAME="Template required"
 I ERRCODE=106 S ERRNAME="Bad Filter Parameter"
 I ERRCODE=107 S ERRNAME="Unsupported Field Name"
 I ERRCODE=108 S ERRNAME="Bad Order Parameter"
 I ERRCODE=109 S ERRNAME="Operation not supported with this index"
 I ERRCODE=110 S ERRNAME="Order field unknown"
 I ERRCODE=111 S ERRNAME="Unrecognized parameter"
 I ERRCODE=112 S ERRNAME="Filter required"
 ; update errors (200-299)
 I ERRCODE=201 S ERRNAME="Unable to encode JSON"
 I ERRCODE=202 S ERRNAME="Unable to decode JSON"
 I ERRCODE=203 S HTTPERR=404,TOPMSG="Not Found",ERRNAME="Unable to determine patient"
 I ERRCODE=204 S HTTPERR=404,TOPMSG="Not Found",ERRNAME="Unable to determine collection" ; unused?
 I ERRCODE=205 S ERRNAME="Patient mismatch with object"
 I ERRCODE=207 S ERRNAME="Missing UID"
 I ERRCODE=209 S ERRNAME="Missing range or index" ; unused?
 I ERRCODE=210 S ERRNAME="Unknown UID format"
 I ERRCODE=211 S HTTPERR=404,TOPMSG="Not Found",ERRNAME="Missing patient identifiers"
 I ERRCODE=212 S ERRNAME="Mismatch of patient identifiers"
 I ERRCODE=213 S ERRNAME="Delete demographics only not allowed"
 I ERRCODE=214 S HTTPERR=404,ERRNAME="Patient ID not found in database"
 I ERRCODE=215 S ERRNAME="Missing collection name"
 I ERRCODE=216 S ERRNAME="Incomplete deletion of collection"
 ; Generic Errors
 I ERRCODE=301 S ERRNAME="Required variable undefined"
 ; HTTP errors
 I ERRCODE=400 S ERRNAME="Bad Request"
 I ERRCODE=401 S ERRNAME="Unauthorized" ; VEN/SMH
 I ERRCODE=404 S ERRNAME="Not Found"
 I ERRCODE=405 S ERRNAME="Method Not Allowed"
 ; system errors (500-599)
 I ERRCODE=501 S ERRNAME="M execution error"
 I ERRCODE=502 S ERRNAME="Unable to lock record"
 I '$L($G(ERRNAME)) S ERRNAME="Unknown error"
 ;
 I ERRCODE>500 S HTTPERR=500,TOPMSG="Internal Server Error"  ; M Server Error
 I ERRCODE<500,ERRCODE>400 S HTTPERR=ERRCODE,TOPMSG=ERRNAME  ; Other HTTP Errors
 Q:$G(NOGBL)
 S NEXTERR=$G(^TMP("HTTPERR",$J,0),0)+1,^TMP("HTTPERR",$J,0)=NEXTERR
 S ^TMP("HTTPERR",$J,1,"apiVersion")="1.0"
 S ^TMP("HTTPERR",$J,1,"error","code")=HTTPERR
 S ^TMP("HTTPERR",$J,1,"error","message")=TOPMSG
 S ^TMP("HTTPERR",$J,1,"error","request")=$G(HTTPREQ("method"))_" "_$G(HTTPREQ("path"))_" "_$G(HTTPREQ("query"))
 I $D(ERRARRAY) M ^TMP("HTTPERR",$J,1,"error","errors",NEXTERR)=ERRARRAY  ; VEN/SMH
 E  S ^TMP("HTTPERR",$J,1,"error","errors",NEXTERR,"reason")=ERRCODE
 E  S ^TMP("HTTPERR",$J,1,"error","errors",NEXTERR,"message")=ERRNAME
 I $L($G(MESSAGE)) S ^TMP("HTTPERR",$J,1,"error","errors",NEXTERR,"domain")=MESSAGE
 Q
customError(ERRCODE,ERRARRAY) ; set custom error into ^TMP("HTTPERR",$J)
 K ^TMP("HTTPERR",$J)
 S HTTPERR=ERRCODE
 M ^TMP("HTTPERR",$J,1)=ERRARRAY
 QUIT
 ;
 ; Cache specific functions (selected one support GT.M too!)
 ;
GMT() ; return HTTP date string (this is really using UTC instead of GMT)
 N TM,DAY
 I $$UP($ZV)["CACHE" D  Q $P(DAY," ")_", "_$ZDATETIME(TM,2)_" GMT"
 . S TM=$ZTIMESTAMP,DAY=$ZDATETIME(TM,11)
 ;
 N OUT
 I $$UP($ZV)["GT.M" D  Q OUT
 . N D S D="datetimepipe"
 . N OLDIO S OLDIO=$I
 . O D:(shell="/bin/sh":comm="date -u +'%a, %d %b %Y %H:%M:%S %Z'|sed 's/UTC/GMT/g'")::"pipe"
 . U D R OUT:1 
 . U OLDIO C D
 ;
 QUIT "UNIMPLEMENTED"
 ;
 ;
DEC2HEX(NUM) ; return a decimal number as hex
 Q $$BASE(NUM,10,16)
 ;Q $ZHEX(NUM)
 ;
HEX2DEC(HEX) ; return a hex number as decimal
 Q $$BASE(HEX,16,10)
 ;Q $ZHEX(HEX_"H")
 ;
BASE(%X1,%X2,%X3) ;Convert %X1 from %X2 base to %X3 base
 I (%X2<2)!(%X2>16)!(%X3<2)!(%X3>16) Q -1
 Q $$CNV($$DEC(%X1,%X2),%X3)
DEC(N,B) ;Cnv N from B to 10
 Q:B=10 N N I,Y S Y=0
 F I=1:1:$L(N) S Y=Y*B+($F("0123456789ABCDEF",$E(N,I))-2)
 Q Y
CNV(N,B) ;Cnv N from 10 to B
 Q:B=10 N N I,Y S Y=""
 F I=1:1 S Y=$E("0123456789ABCDEF",N#B+1)_Y,N=N\B Q:N<1
 Q Y
 ;
HTFM(%H,%F) ;$H to FM, %F=1 for date only
 N X,%,%T,%Y,%M,%D S:'$D(%F) %F=0
 I $$HR(%H) Q -1 ;Check Range
 I '%F,%H[",0" S %H=(%H-1)_",86400"
 D YMD S:%T&('%F) X=X_%T
 Q X
YMD ;21608 = 28 feb 1900, 94657 = 28 feb 2100, 141 $H base year
 S %=(%H>21608)+(%H>94657)+%H-.1,%Y=%\365.25+141,%=%#365.25\1
 S %D=%+306#(%Y#4=0+365)#153#61#31+1,%M=%-%D\29+1
 S X=%Y_"00"+%M_"00"+%D,%=$P(%H,",",2)
 S %T=%#60/100+(%#3600\60)/100+(%\3600)/100 S:'%T %T=".0"
 Q
HR(%V) ;Check $H in valid range
 Q (%V<2)!(%V>99999)
 ;
HTE(%H,%F) ;$H to external
 Q:$$HR(%H) %H ;Range Check
 N Y,%T,%R
 S %F=$G(%F,1) S Y=$$HTFM(%H,0)
T2 S %T="."_$E($P(Y,".",2)_"000000",1,7)
 D FMT Q %R
FMT ;
 N %G S %G=+%F
 G F1:%G=1,F2:%G=2,F3:%G=3,F4:%G=4,F5:%G=5,F6:%G=6,F7:%G=7,F8:%G=8,F9:%G=9,F1
 Q
 ;
F1 ;Apr 10, 2002
 S %R=$P($$M()," ",$S($E(Y,4,5):$E(Y,4,5)+2,1:0))_$S($E(Y,4,5):" ",1:"")_$S($E(Y,6,7):$E(Y,6,7)_", ",1:"")_($E(Y,1,3)+1700)
 ;
TM ;All formats come here to format Time.
 N %,%S Q:%T'>0!(%F["D")
 I %F'["P" S %R=%R_"@"_$E(%T,2,3)_":"_$E(%T,4,5)_$S(%F["M":"",$E(%T,6,7)!(%F["S"):":"_$E(%T,6,7),1:"")
 I %F["P" D
 . S %R=%R_" "_$S($E(%T,2,3)>12:$E(%T,2,3)-12,+$E(%T,2,3)=0:"12",1:+$E(%T,2,3))_":"_$E(%T,4,5)_$S(%F["M":"",$E(%T,6,7)!(%F["S"):":"_$E(%T,6,7),1:"")
 . S %R=%R_$S($E(%T,2,7)<120000:" am",$E(%T,2,3)=24:" am",1:" pm")
 . Q
 Q
 ;Return Month names
M() Q "  Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"
 ;
F2 ;4/10/02
 S %R=$J(+$E(Y,4,5),2)_"/"_$J(+$E(Y,6,7),2)_"/"_$E(Y,2,3)
 S:%F["Z" %R=$TR(%R," ","0") S:%F'["F" %R=$TR(%R," ")
 G TM
F3 ;10/4/02
 S %R=$J(+$E(Y,6,7),2)_"/"_$J(+$E(Y,4,5),2)_"/"_$E(Y,2,3)
 S:%F["Z" %R=$TR(%R," ","0") S:%F'["F" %R=$TR(%R," ")
 G TM
F4 ;02/4/10
 S %R=$E(Y,2,3)_"/"_$J(+$E(Y,4,5),2)_"/"_$J(+$E(Y,6,7),2)
 S:%F["Z" %R=$TR(%R," ","0") S:%F'["F" %R=$TR(%R," ")
 G TM
F5 ;4/10/2002
 S %R=$J(+$E(Y,4,5),2)_"/"_$J(+$E(Y,6,7),2)_"/"_($E(Y,1,3)+1700)
 S:%F["Z" %R=$TR(%R," ","0") S:%F'["F" %R=$TR(%R," ")
 G TM
F6 ;10/4/2002
 S %R=$J(+$E(Y,6,7),2)_"/"_$J(+$E(Y,4,5),2)_"/"_($E(Y,1,3)+1700)
 S:%F["Z" %R=$TR(%R," ","0") S:%F'["F" %R=$TR(%R," ")
 G TM
F7 ;2002/4/10
 S %R=($E(Y,1,3)+1700)_"/"_$J(+$E(Y,4,5),2)_"/"_$J(+$E(Y,6,7),2)
 S:%F["Z" %R=$TR(%R," ","0") S:%F'["F" %R=$TR(%R," ")
 G TM
F8 ;10 Apr 02
 S %R=$S($E(Y,6,7):$E(Y,6,7)_" ",1:"")_$P($$M()," ",$S($E(Y,4,5):$E(Y,4,5)+2,1:0))_$S($E(Y,4,5):" ",1:"")_$E(Y,2,3)
 G TM
F9 ;10 Apr 2002
 S %R=$S($E(Y,6,7):$E(Y,6,7)_" ",1:"")_$P($$M()," ",$S($E(Y,4,5):$E(Y,4,5)+2,1:0))_$S($E(Y,4,5):" ",1:"")_($E(Y,1,3)+1700)
 G TM
 ;
PARSE10(BODY,PARSED) ; Parse BODY by CRLF and return the array in PARSED
 ; Input: BODY: By Ref - BODY to be parsed
 ; Output: PARSED: By Ref - PARSED Output
 ; E.g. if BODY is ABC_CRLF_DEF_CRLF, PARSED is PARSED(1)="ABC",PARSED(2)="DEF",PARSED(3)=""
 N LL S LL="" ; Last line
 N L S L=1 ; Line counter.
 K PARSED ; Kill return array
 N I S I="" F  S I=$O(BODY(I)) Q:'I  D  ; For each 4000 character block
 . N J F J=1:1:$L(BODY(I),$C(10)) D  ; For each line
 . . S:(J=1&(L>1)) L=L-1 ; Replace old line (see 2 lines below)
 . . S PARSED(L)=$TR($P(BODY(I),$C(10),J),$C(13)) ; Get line; Take CR out if there.
 . . S:(J=1&(L>1)) PARSED(L)=LL_PARSED(L) ; If first line, append the last line before it and replace it.
 . . S LL=PARSED(L) ; Set last line
 . . S L=L+1 ; LineNumber++
 QUIT
 ;
ADDCRLF(RESULT) ; Add CRLF to each line
 I $E($G(RESULT))="^" D  QUIT  ; Global
 . N V,QL S V=RESULT,QL=$QL(V) F  S V=$Q(@V) Q:V=""  Q:$NA(@V,QL)'=RESULT  S @V=@V_$C(13,10)
 E  D  ; Local variable passed by reference
 . I $D(RESULT)#2 S RESULT=RESULT_$C(13,10)
 . N V S V=$NA(RESULT) F  S V=$Q(@V) Q:V=""  S @V=@V_$C(13,10)
 QUIT
 ;
UNKARGS(ARGS,LIST) ; returns true if any argument is unknown
 N X,UNKNOWN
 S UNKNOWN=0,LIST=","_LIST_","
 S X="" F  S X=$O(ARGS(X)) Q:X=""  I LIST'[(","_X_",") D
 . S UNKNOWN=1
 . D SETERROR^VPRJRUT(111,X)
 Q UNKNOWN
 ;
ENCODE64(X) ;
 N RGZ,RGZ1,RGZ2,RGZ3,RGZ4,RGZ5,RGZ6
 S RGZ=$$INIT64,RGZ1=""
 F RGZ2=1:3:$L(X) D
 .S RGZ3=0,RGZ6=""
 .F RGZ4=0:1:2 D
 ..S RGZ5=$A(X,RGZ2+RGZ4),RGZ3=RGZ3*256+$S(RGZ5<0:0,1:RGZ5)
 .F RGZ4=1:1:4 S RGZ6=$E(RGZ,RGZ3#64+2)_RGZ6,RGZ3=RGZ3\64
 .S RGZ1=RGZ1_RGZ6
 S RGZ2=$L(X)#3
 S:RGZ2 RGZ3=$L(RGZ1),$E(RGZ1,RGZ3-2+RGZ2,RGZ3)=$E("==",RGZ2,2)
 Q RGZ1
DECODE64(X) ;
 N RGZ,RGZ1,RGZ2,RGZ3,RGZ4,RGZ5,RGZ6
 S RGZ=$$INIT64,RGZ1=""
 F RGZ2=1:4:$L(X) D
 .S RGZ3=0,RGZ6=""
 .F RGZ4=0:1:3 D
 ..S RGZ5=$F(RGZ,$E(X,RGZ2+RGZ4))-3
 ..S RGZ3=RGZ3*64+$S(RGZ5<0:0,1:RGZ5)
 .F RGZ4=0:1:2 S RGZ6=$C(RGZ3#256)_RGZ6,RGZ3=RGZ3\256
 .S RGZ1=RGZ1_RGZ6
 Q $E(RGZ1,1,$L(RGZ1)-$L(X,"=")+1)
INIT64() Q "=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
 ;
addService(method,urlPattern,routine,auth,authKey,authOption,params) ; [Public: Add Service Entry Point]
 ; pass all by value except params by ref
 ; do or $$; return if $$ is 0 for failure and ien for success
 ; param format:
 ; - param(1)="U^rpc" URL Component named RPC
 ; - param(2)="F^start" Form Body variable called start
 ; - param(3)="Q^dir" HTTP Query variable called dir
 ; - param(4)="B"     Pass the body
 set method=$get(method)
 set urlPattern=$get(urlPattern)
 set routine=$get(routine)
 ;
 ; validate method
 if "^GET^POST^PUT^OPTIONS^DELETE^TRACE^HEAD^CONNECT^"'["^"_method_"^" quit:$q 0 q
 ;
 ; if urlPattern or routine are empty, bad call
 if urlPattern=""!(routine="") quit:$q 0 q
 ;
 ; Remove leading slashes
 if $e(urlPattern)="/" s $e(urlPattern)=""
 ;
 ; Lock for edits
 if $P($SY,",")=47 tstart ():serial
 else  lock +^%webutils:1 else  quit:$q 0 q
 ;
 ; does it already exist; or add new entry
 new ien
 if $data(^%web(17.6001,"B",method,urlPattern)) do
 . new routine set routine=$order(^%web(17.6001,"B",method,urlPattern,""))
 . set ien=$order(^%web(17.6001,"B",method,urlPattern,routine,0))
 . kill ^%web(17.6001,"B",method,urlPattern)
 . set $piece(^%web(17.6001,0),"^",3)=ien
 else  do 
 . set ien=$o(^%web(17.6001," "),-1)+1
 . set $piece(^%web(17.6001,0),"^",3,4)=ien_"^"_ien
 ;
 ; now add the entry at this ien
 ; kill old one first
 kill ^%web(17.6001,ien)
 ;
 ; Add new one
 set ^%web(17.6001,ien,0)=method
 set ^%web(17.6001,ien,1)=urlPattern
 set ^%web(17.6001,ien,2)=routine
 set ^%web(17.6001,"B",method,urlPattern,routine,ien)=""
 ;
 ; Add Auth nodes
 if $text(^XUS)'="" do
 . if $g(auth)           set $piece(^%web(17.6001,ien,"AUTH"),"^",1)=1
 . if $g(authKey)'=""    set $piece(^%web(17.6001,ien,"AUTH"),"^",2)=$$FIND1^DIC(19.1,,"QX",authKey,"B")
 . if $g(authOption)'="" set $piece(^%web(17.6001,ien,"AUTH"),"^",3)=$$FIND1^DIC(19,,"QX",authOption,"B")
 ;
 ; Add Params
 if $order(params("")) do
 . new n for n=0:0 set n=$order(params(n)) quit:'n  set ^%web(17.6001,ien,"PARAMS",n,0)=params(n)
 . new lastn s lastn=+$order(params(""),-1)
 . set ^%web(17.6001,ien,"PARAMS",0)="^17.60012S^"_lastn_"^"_lastn
 ;
 ; Commit our changes and unlock
 if $P($SY,",")=47 tcommit
 else  lock -^%webutils
 ;
 ; Return IEN
 quit:$quit ien quit
 ;
deleteService(method,urlPattern) ; [Public: Delete Service]
 set method=$get(method)
 set urlPattern=$get(urlPattern)
 if method="" quit
 if urlPattern="" quit
 ;
 ; Remove leading slashes
 if $e(urlPattern)="/" s $e(urlPattern)=""
 ;
 new ien
 if $P($SY,",")=47 tstart ():serial
 if $data(^%web(17.6001,"B",method,urlPattern)) do
 . new routine set routine=$order(^%web(17.6001,"B",method,urlPattern,""))
 . set ien=$order(^%web(17.6001,"B",method,urlPattern,routine,0))
 . kill ^%web(17.6001,"B",method,urlPattern)
 . kill ^%web(17.6001,ien)
 . set $piece(^%web(17.6001,0),"^",3)=ien
 . set $piece(^%web(17.6001,0),"^",4)=$piece(^%web(17.6001,0),"^",4)-1
 if $P($SY,",")=47 tcommit
 ;
 quit
 ;
 ; Portions of this code are public domain, but it was extensively modified
 ; Copyright 2013-2019 Sam Habiel
 ;
 ;Licensed under the Apache License, Version 2.0 (the "License");
 ;you may not use this file except in compliance with the License.
 ;You may obtain a copy of the License at
 ;
 ;    http://www.apache.org/licenses/LICENSE-2.0
 ;
 ;Unless required by applicable law or agreed to in writing, software
 ;distributed under the License is distributed on an "AS IS" BASIS,
 ;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ;See the License for the specific language governing permissions and
 ;limitations under the License.



